var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(d,f,e){d!=Array.prototype&&d!=Object.prototype&&(d[f]=e.value)};$jscomp.getGlobal=function(d){return"undefined"!=typeof window&&window===d?d:"undefined"!=typeof global&&null!=global?global:d};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var d=0;return function(f){return $jscomp.SYMBOL_PREFIX+(f||"")+d++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var d=$jscomp.global.Symbol.iterator;d||(d=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[d]&&$jscomp.defineProperty(Array.prototype,d,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(d){var f=0;return $jscomp.iteratorPrototype(function(){return f<d.length?{done:!1,value:d[f++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(d){$jscomp.initSymbolIterator();d={next:d};d[$jscomp.global.Symbol.iterator]=function(){return this};return d};$jscomp.iteratorFromArray=function(d,f){$jscomp.initSymbolIterator();d instanceof String&&(d+="");var e=0,g={next:function(){if(e<d.length){var h=e++;return{value:f(h,d[h]),done:!1}}g.next=function(){return{done:!0,value:void 0}};return g.next()}};g[Symbol.iterator]=function(){return g};return g};
$jscomp.polyfill=function(d,f,e,g){if(f){e=$jscomp.global;d=d.split(".");for(g=0;g<d.length-1;g++){var h=d[g];h in e||(e[h]={});e=e[h]}d=d[d.length-1];g=e[d];f=f(g);f!=g&&null!=f&&$jscomp.defineProperty(e,d,{configurable:!0,writable:!0,value:f})}};$jscomp.polyfill("Array.prototype.keys",function(d){return d?d:function(){return $jscomp.iteratorFromArray(this,function(d){return d})}},"es6","es3");var hasLocalStorage=!0;
if("undefined"==typeof localStorage||null==localStorage)hasLocalStorage=!1,localStorage={};console.log((new Date).toString()+" ===========> started");var os=require("os"),fs=require("fs"),path=require("path"),async=require("async"),ls=require("node-localstorage").LocalStorage,core=require("x.core.js"),xhub=require("x.hub.js"),v5=require("x.hub.v5.js"),miot=require("xnm.aio.m10T.js"),xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.xhub=xnm.aio.xhub||{};global.HARDWARE_VERSION="A1";
global.FIRMWARE_VERSION="2.3.4";global.TASKMANAGER_VERSION="2.3.4";global.PLATFORM="CCU3";global.NAME=null;global.VID=null;global.CLOUD_URL="https://webservice.mediola.com";global.CONTROL_SERVER="v5ws.mediola.com";global.LOAD_MODULES=["knx"];global.DATA_FOLDER=null;global.APP_FOLDER=null;global.LOG_ROOT=null;global.WEB_SERVER_PORT=80;global.STM="/dev/ttyS2";global.HM_CHIP="";global.HM_LOCAL_PORT=9099;global.ENOCEAN_PORT="/dev/ttyUSB0";global.ZWAVE2_URL="127.0.0.1";
global.ZWAVE2_PORT=9E3;global.SAFE_MODE=!1;
function _loadCompilerConfig(){"undefined"!=typeof HARDWARE_VERSION&&HARDWARE_VERSION&&(global.HARDWARE_VERSION=HARDWARE_VERSION);"undefined"!=typeof FIRMWARE_VERSION&&FIRMWARE_VERSION&&(global.FIRMWARE_VERSION=FIRMWARE_VERSION);"undefined"!=typeof TASKMANAGER_VERSION&&TASKMANAGER_VERSION&&(global.TASKMANAGER_VERSION=TASKMANAGER_VERSION);"undefined"!=typeof PLATFORM&&PLATFORM&&(global.PLATFORM=PLATFORM);"undefined"!=typeof NAME&&NAME&&(global.NAME=NAME);"undefined"!=typeof VID&&VID&&(global.VID=VID);
"undefined"!=typeof CLOUD_URL&&CLOUD_URL&&(global.CLOUD_URL=CLOUD_URL);"undefined"!=typeof CONTROL_SERVER&&CONTROL_SERVER&&(global.CONTROL_SERVER=CONTROL_SERVER);"undefined"!=typeof LOAD_MODULES&&LOAD_MODULES&&(global.LOAD_MODULES=LOAD_MODULES)}
function _loadProgrammEnv(){process&&process.env&&(process.env.HARDWARE_VERSION&&(global.HARDWARE_VERSION=process.env.HARDWARE_VERSION),process.env.FIRMWARE_VERSION&&(global.FIRMWARE_VERSION=process.env.FIRMWARE_VERSION),process.env.TASKMANAGER_VERSION&&(global.TASKMANAGER_VERSION=process.env.TASKMANAGER_VERSION),process.env.PLATFORM&&(global.PLATFORM=process.env.PLATFORM),process.env.NAME&&(global.NAME=process.env.NAME),process.env.VID&&(global.VID=process.env.VID))}
function _loadConfigFile(){function d(d){if(d)for(var e in d)d.hasOwnProperty(e)&&(global[e]="DATA_FOLDER"==e||"APP_FOLDER"==e||"LOG_ROOT"==e?path.isAbsolute(d[e])?d[e]:path.resolve(__dirname,d[e]):d[e])}function f(){try{var e=require("./package.json");e&&d(e.config)}catch(h){}}function e(){try{var e=require("./config.json");d(e)}catch(h){}}switch(global.HARDWARE_VERSION){case "A1":f();break;case "EA":e()}}
function _loadRuntimeConfig(){switch(global.HARDWARE_VERSION){case "A1":if(null==global.PLATFORM)switch(os.platform()){case "darwin":global.PLATFORM="MAC";break;case "win32":global.PLATFORM="WIN";break;default:global.PLATFORM="LINUX"}null==global.NAME&&(global.NAME="NEO Server");null==global.VID&&(global.VID=null);null==global.CLOUD_URL&&(global.CLOUD_URL="https://webservice.mediola.com");null==global.CONTROL_SERVER&&(global.CONTROL_SERVER="v5ws.mediola.com");null==global.LOAD_MODULES&&(global.LOAD_MODULES=
["knx"]);null==global.DATA_FOLDER&&(global.DATA_FOLDER=null);null==global.APP_FOLDER&&(global.APP_FOLDER=null);null==global.LOG_ROOT&&(global.LOG_ROOT=null);null==global.WEB_SERVER_PORT&&(global.WEB_SERVER_PORT=8088);null==global.HM_CHIP&&(global.HM_CHIP=null);null==global.HM_LOCAL_PORT&&(global.HM_LOCAL_PORT=9099);null==global.ENOCEAN_PORT&&(global.ENOCEAN_PORT=null);null==global.ZWAVE2_URL&&(global.ZWAVE2_URL=null);null==global.ZWAVE2_PORT&&(global.ZWAVE2_PORT=null);null==global.STM&&(global.STM=
null);break;case "EA":switch(null==global.PLATFORM&&(global.PLATFORM="A20"),null==global.NAME&&(global.NAME="AIO GATEWAY V5+"),null==global.VID&&(global.VID=null),null==global.CLOUD_URL&&(global.CLOUD_URL="https://webservice.mediola.com"),null==global.CONTROL_SERVER&&(global.CONTROL_SERVER="v5ws.mediola.com"),null==global.LOAD_MODULES&&(global.LOAD_MODULES=["enocean","zway","knx","zigbee"]),null==global.DATA_FOLDER&&(global.DATA_FOLDER=path.resolve(__dirname,"./data")),null==global.APP_FOLDER&&(global.APP_FOLDER=
path.resolve(__dirname,"./data")),null==global.LOG_ROOT&&(global.LOG_ROOT="/var/log"),null==global.WEB_SERVER_PORT&&(global.WEB_SERVER_PORT=80),null==global.HM_CHIP&&(global.HM_CHIP="127.0.0.1"),null==global.HM_LOCAL_PORT&&(global.HM_LOCAL_PORT=9099),null==global.ENOCEAN_PORT&&(global.ENOCEAN_PORT=null),null==global.ZWAVE2_URL&&(global.ZWAVE2_URL="127.0.01"),null==global.ZWAVE2_PORT&&(global.ZWAVE2_PORT=9E3),global.PLATFORM){case "MAC":global.STM|=NaN;break;case "WIN":global.STM|=0;break;case "A20":global.STM|=
NaN;break;case "PI2":global.STM|=NaN;break;default:global.STM|=NaN}}"undefined"!=typeof global.CONTROL_SERVER&&global.CONTROL_SERVER&&(require("x.hub.v5.js").CloudConnect.prototype.CLOUD_SERVER=global.CONTROL_SERVER);"undefined"!=typeof global.CLOUD_URL&&global.CLOUD_URL&&(require("x.hub.taskman.js").Cloud.prototype.URL=global.CLOUD_URL);"undefined"!=typeof global.TASKMANAGER_VERSION&&global.TASKMANAGER_VERSION&&(require("x.hub.taskman.js").TaskManager.NS_VERSION=global.TASKMANAGER_VERSION)}
function _setupServer(){var d=null;switch(global.PLATFORM){case "MAC":d=new xhub.Server(global.STM,global.WEB_SERVER_PORT);break;case "WIN":d=new xhub.Server(global.STM,global.WEB_SERVER_PORT);break;case "A20":d=new xhub.Server(global.STM,global.WEB_SERVER_PORT);break;case "PI2":d=new xhub.Server(global.STM,global.WEB_SERVER_PORT,"gpio26");break;default:d=new xhub.Server(global.STM,global.WEB_SERVER_PORT)}d.hostType=global.PLATFORM;xhub.server=d;v5.server=d;d.HWV=global.HARDWARE_VERSION;d.VERSION=
global.FIRMWARE_VERSION;d.DEFAULT_NAME=global.NAME;var f=null,e=Date.now();d.on("serialevent",function(a,c){require("x.logger.js").getLogger("x.hub.m.gateway.Serial").log("trace","SERIAL EVENT: "+a);var b=f,m=Date.now()-e;e=Date.now();f=a;if(!(b==a&&1E3>m)){b=null;try{b=JSON.parse(a)}catch(k){}b&&(require("x.hub.eventbus.js").emit("gatewayevent",b,{address:"ST"},c),"EVT"!=c&&"STA"!=c||d.sendUDPMessage(c+":"+JSON.stringify(b)+"\r\n"))}});d.setCmdFunc("refreshhm",function(a,c){c(JSON.stringify({XC_SUC:{}}))});
d.setCmdFunc("resethm",function(a,c){require("x.hub.m.hm.js").resetChip(function(b){b.error?c(JSON.stringify({XC_ERR:{code:"001000",msg:b.error.message}})):c(JSON.stringify({XC_SUC:{}}))})});d.setCmdFunc("addSensor",function(a,c){a.query.type&&"ENOCEAN"==a.query.type.toUpperCase()?require("x.hub.m.enocean.js").addSensor(a.query,function(b){b.error?c(JSON.stringify({XC_ERR:{code:"001000",msg:b.error.message}})):c(JSON.stringify({XC_SUC:{}}))}):c(null)});d.setCmdFunc("LearnSC",function(a,c){if(a.query.type&&
"HM"==a.query.type.toUpperCase()){var b=require("x.hub.m.hm.js");a.query.key&&a.query.sgtin?b.learnIPDevice(null,a.query.sgtin,a.query.key,function(b){b.error?c(JSON.stringify({XC_ERR:{code:"001000",msg:b.error.message}})):c(JSON.stringify({XC_SUC:{devices:b.data}}))}):a.query.qrkey?b.learnIPDeviceQR(null,a.query.qrkey,function(b){b.error?c(JSON.stringify({XC_ERR:{code:"001000",msg:b.error.message}})):c(JSON.stringify({XC_SUC:{devices:b.data}}))}):a.query.adr?b.learnRFDeviceSN(null,a.query.adr,function(b){b.error?
c(JSON.stringify({XC_ERR:{code:"001000",msg:b.error.message}})):c(JSON.stringify({XC_SUC:{devices:b.data}}))}):b.learnRFDevice(null,function(b){b.error?c(JSON.stringify({XC_ERR:{code:"001000",msg:b.error.message}})):c(JSON.stringify({XC_SUC:{devices:b.data}}))})}else a.query.type&&"ENOCEAN"==a.query.type.toUpperCase()?require("x.hub.m.enocean.js").learnDevice(a.query,function(b){b.error?c(JSON.stringify({XC_ERR:{code:"001000",msg:b.error.message}})):c(JSON.stringify({XC_SUC:b.data}))}):a.query.type&&
"ZIGBEE"==a.query.type.toUpperCase()?require("x.hub.m.zigbee.js").learnDevice(a.query,function(b){b.error?c(JSON.stringify({XC_ERR:{code:"001000",msg:b.error.message}})):c(JSON.stringify({XC_SUC:b.data}))}):c(null)});d.setCmdFunc("SendSC",function(a,c){a.query.type&&"HM"==a.query.type.toUpperCase()?a.query.address&&a.query.data?require("x.hub.m.hm.js").executeCommandLegacy(null,a.query.address,a.query.data,function(b){b.error?c(JSON.stringify({XC_ERR:{code:"001000",msg:b.error.message}})):c(JSON.stringify({XC_SUC:{}}))}):
c(JSON.stringify({XC_ERR:{code:"001000",msg:"address or data invalid"}})):a.query.type&&"ENOCEAN"==a.query.type.toUpperCase()?a.query.address&&a.query.data?require("x.hub.m.enocean.js").executeCommandLegacy(null,a.query.address,a.query.data,function(b){b.error?c(JSON.stringify({XC_ERR:{code:"001000",msg:b.error.message}})):c(JSON.stringify({XC_SUC:{}}))}):c(JSON.stringify({XC_ERR:{code:"001000",msg:"address or data invalid"}})):a.query.type&&"ZWAVE"==a.query.type.toUpperCase()?a.query.address&&a.query.data&&
a.query.devicetype?require("x.hub.m.zwave.js").executeCommandLegacy(null,a.query.address,a.query.devicetype,a.query.data,function(b){b.error?c(JSON.stringify({XC_ERR:{code:"001000",msg:b.error.message}})):c(JSON.stringify({XC_SUC:{}}))}):c(JSON.stringify({XC_ERR:{code:"001000",msg:"address or data or devicetype invalid"}})):a.query.type&&"ZWAVE2"==a.query.type.toUpperCase()?require("x.hub.m.zway.js").executeCommandLegacy(a.query.address,a.query.data,function(b){b.error?c(JSON.stringify({XC_ERR:{code:"001000",
msg:b.error.message}})):c(JSON.stringify({XC_SUC:{}}))}):a.query.type&&"KNX"==a.query.type.toUpperCase()?require("x.hub.m.knx.js").executeCommandLegacy(a.query.address,a.query.data,function(b){b.error?c(JSON.stringify({XC_ERR:{code:b.error.code?b.error.code:"001000",msg:b.error.message}})):c(JSON.stringify({XC_SUC:{}}))}):a.query.type&&"ZIGBEE"==a.query.type.toUpperCase()?require("x.hub.m.zigbee.js").executeCommandLegacy(a.query.address,a.query.data,function(b){b.error?c(JSON.stringify({XC_ERR:{code:b.error.code?
b.error.code:"001000",msg:b.error.message}})):c(JSON.stringify({XC_SUC:{}}))}):"PI2"==d.hostType&&"RGB"==a.query.type&&a.query.data&&8==a.query.data.length?(v5&&v5.setRGBColor(a.query.data.substr(2)),c(JSON.stringify({XC_SUC:{}}))):c(null)});d.setCmdFunc("delSensor",function(a,c){a.query.type&&"HM"==a.query.type.toUpperCase()?a.query.adr?require("x.hub.m.hm.js").deleteDevice(null,a.query.adr,function(b){b.error?c(JSON.stringify({XC_ERR:{code:"001000",msg:b.error.message}})):c(JSON.stringify({XC_SUC:{}}))}):
c(JSON.stringify({XC_ERR:{code:"001000",msg:"adr invalid"}})):a.query.type&&"ENOCEAN"==a.query.type.toUpperCase()?require("x.hub.m.enocean.js").delSensor(a.query.address,function(b){b.error?c(JSON.stringify({XC_ERR:{code:"001000",msg:b.error.message}})):c(JSON.stringify({XC_SUC:{}}))}):a.query.type&&"ZIGBEE"==a.query.type.toUpperCase()?require("x.hub.m.zigbee.js").removeDevice(a.query.address,function(b){b.error?c(JSON.stringify({XC_ERR:{code:"001000",msg:b.error.message}})):c(JSON.stringify({XC_SUC:{}}))}):
c(null)});d.setCmdFunc("gethmconfig",function(a,c){a.query.address?require("x.hub.m.hm.js").getConfig({address:a.query.address},function(b){b.error?c(JSON.stringify({XC_ERR:{code:"001000",msg:b.error.message}})):c(JSON.stringify({XC_SUC:{config:b.data}}))}):c(null)});d.setCmdFunc("sethmconfig",function(a,c){a.query.address&&a.query.config?require("x.hub.m.hm.js").setConfig({address:a.query.address},a.query.config,function(b){b.error?c(JSON.stringify({XC_ERR:{code:"001000",msg:b.error.message}})):
c(JSON.stringify({XC_SUC:{}}))}):c(null)});d.setCmdFunc("setVar",function(a,c){require("x.hub.sysvarman.js").setVar(a.query,function(b){b.error?c(JSON.stringify({XC_ERR:{code:"001000",msg:b.error.message}})):c(JSON.stringify({XC_SUC:{}}))})});d.setCmdFunc("delVar",function(a,c){require("x.hub.sysvarman.js").delVar(a.query.id,function(b){b.error?c(JSON.stringify({XC_ERR:{code:"001000",msg:b.error.message}})):c(JSON.stringify({XC_SUC:{}}))})});var g=[],h=null;d.setCmdFunc("getStates",function(a,c){var b=
function(b,a){var c=g;g=[];b?c.forEach(function(a){a(JSON.stringify({XC_ERR:{code:"001000",msg:b.message}}))}):0<a.length?c.forEach(function(b){b(JSON.stringify({XC_SUC:a}))}):c.forEach(function(b){b(JSON.stringify({XC_SUC:{}}))})},d=[],k=[],e=[],f=g.length,l=(new Date).getTime();0!=f&&18E4<l-h&&(b(Error("get states dead lock")),f=g.length);-1==g.indexOf(c)&&g.push(c);0==f&&(h=(new Date).getTime(),async.parallel([function(b){if("A20"!=global.PLATFORM&&"PI2"!=global.PLATFORM)b();else if(localStorage&&
"true"==localStorage.getItem("x.hub.Server.DISABLE_ST_STATES"))b();else{var a=setTimeout(function(){k.push({type:"ST_ERROR",state:"st timeout"});b&&b();b=null},1E4);xhub.server._doSTMCommandRequest("/cmd?XC_FNC=getStates",!1,function(c){a&&(clearTimeout(a),a=null);if(b){try{var d=JSON.parse(c);d.XC_SUC?Array.isArray(d.XC_SUC)?k=k.concat(d.XC_SUC):0<Object.keys(d.XC_SUC).length&&(k=k.push(d.XC_SUC)):k.push({type:"ST_ERROR",state:"st return:"+c});b()}catch(r){k.push({type:"ST_ERROR",state:"st return invalid json"}),
b()}b=null}})}},function(b){require("x.hub.m.hm.js").getAllStatesLegacy(function(a){a.error?d.push({type:"HM_ERROR",state:a.error}):d=d.concat(a.data);b()})},function(b){-1==global.LOAD_MODULES.indexOf("enocean")?b():require("x.hub.m.enocean.js").getAllStatesLegacy(function(a){a.error?d.push({type:"ENOCEAN_ERROR",state:a.error}):d=d.concat(a.data);b()},a.query)},function(b){-1==global.LOAD_MODULES.indexOf("zwave")?b():require("x.hub.m.zwave.js").getAllStatesLegacy(function(a){a.error?d.push({type:"ZWAVE_ERROR",
state:a.error}):d=d.concat(a.data);b()})},function(b){require("x.hub.m.zway.js").getAllStatesLegacy(function(a){a.error?d.push({type:"ZWAVE2_ERROR",state:a.error}):d=d.concat(a.data);b()})},function(b){-1==global.LOAD_MODULES.indexOf("knx")?b():require("x.hub.m.knx.js").getAllStatesLegacy(function(a){a.error?d.push({type:"KNX_ERROR",state:a.error}):d=d.concat(a.data);b()})},function(b){-1==global.LOAD_MODULES.indexOf("zigbee")?b():require("x.hub.m.zigbee.js").getAllStatesLegacy(function(a){a.error?
d.push({type:"ZIGBEE_ERROR",state:a.error}):d=d.concat(a.data);b()})},function(b){require("x.hub.taskman.js").readAllTasks(function(a){if(a.error)d.push({type:"TASK_ERROR",state:a.error});else{var c=[];a.data.forEach(function(b){b&&c.push({type:"TASK",id:b.id,active:b.active})});d=d.concat(c)}b()})},function(b){require("x.hub.sysvarman.js").getSysvarStates(function(a){a.error?d.push({type:"SYSVAR_ERROR",state:a.error}):e=e.concat(a.data);b()})}],function(a){a?b(a,d):k&&0<k.length?require("x.hub.sysvarman.js").processSysvarST(xhub.server,
k,function(c){c&&!c.error&&c.data&&0<c.data.length&&(d=d.concat(c.data));b(a,d)}):(e&&0<e.length&&(d=d.concat(e)),b(a,d))}))});d.setCmdFunc("getSI",function(a,c){d.doSTMCommand("XC_FNC=GetSI",function(b){b&&b.XC_SUC&&(b.XC_SUC.HWV=d.HWV);c(JSON.stringify(b))})});d.setCommandFunc("GetSI",function(a,c){d.doSTMCommand("XC_FNC=GetSI",function(b){b&&b.XC_SUC?(b.XC_SUC.HWV=d.HWV,c.send("{XC_SUC}"+JSON.stringify(b.XC_SUC))):c.send("{XC_ERR}")})});d.setCmdFunc("SendM",function(a,c){if(a.query&&a.query.m&&
a.query.cmd){var b=a.query.m,d=a.query.cmd;delete a.query.XC_FNC;delete a.query.m;delete a.query.cmd;var e=null;try{e=require("x.hub.m."+b+".js")}catch(p){}e&&e.executeCommand?e.executeCommand(a.query,d,function(){c('{"XC_SUC":{}}')}):c('{"XC_ERR":{"code":"000000","msg":"internal error"}}')}else c('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});d.setCmdFunc("GetM",function(a,c){if(a.query&&a.query.m){var b=a.query.m;delete a.query.XC_FNC;delete a.query.m;var d=null;try{d=require("x.hub.m."+
b+".js")}catch(k){}d&&d.updateStates?d.updateStates(a.query,function(b){b?c('{"XC_SUC":'+JSON.stringify(b)+"}"):c('{"XC_SUC":{}}')}):c('{"XC_ERR":{"code":"000000","msg":"internal error"}}')}else c('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});d.setCmdFunc("SendRM",function(a,c){require("x.logger.js").getLogger("CloudRemoteAccess").log("trace","execute command:"+JSON.stringify(a.query));a.query?require("x.hub.commandman.js").commandHandler2.executeCommandWithIdx(a.query.device,a.query.gateway,
a.query.command,function(b){b.error?c('{"XC_ERR":{"code":"000000","msg":"'+b.error.message+'"}}'):c('{"XC_SUC":{}}')}):c('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});d.setCmdFunc("GetRM",function(a,c){require("x.logger.js").getLogger("CloudRemoteAccess").log("trace","get states:"+JSON.stringify(a.query));a.query?require("x.hub.commandman.js").commandHandler2.getStateWithIdx(a.query.device,a.query.gateway,a.query.status,function(b){b.error?c('{"XC_ERR":{"code":"000000","msg":"'+b.error.message+
'"}}'):c('{"XC_SUC":'+JSON.stringify(b.data)+"}")}):c('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});d.setCmdFunc("DoMacroRM",function(a,c){require("x.logger.js").getLogger("CloudRemoteAccess").log("trace","execute macro:"+JSON.stringify(a.query));a.query?require("x.hub.macroman.js").executeWithIdx2(a.query.groupIdx,a.query.macroIdx,function(b){b.error?c('{"XC_ERR":{"code":"000000","msg":"'+b.error.message+'"}}'):c('{"XC_SUC":{}}')}):c('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});
d.setCmdFunc("GetTask",function(a,c){require("x.hub.taskman.js").doWebRequest("Read",a,c)});d.setCmdFunc("CreateTask",function(a,c){require("x.hub.taskman.js").doWebRequest("Create",a,c)});d.setCmdFunc("UpdateTask",function(a,c){require("x.hub.taskman.js").doWebRequest("Update",a,c)});d.setCmdFunc("DeleteTask",function(a,c){require("x.hub.taskman.js").doWebRequest("Delete",a,c)});d.setCmdFunc("DoTask",function(a,c){require("x.hub.taskman.js").doWebRequest("Do",a,c)});d.setCmdFunc("CancelTask",function(a,
c){require("x.hub.taskman.js").doWebRequest("Cancel",a,c)});d.setCmdFunc("IsTaskRunning",function(a,c){require("x.hub.taskman.js").doWebRequest("isRunning",a,c)});d.setCmdFunc("SetTaskActive",function(a,c){require("x.hub.taskman.js").doWebRequest("SetTaskActive",a,c)});d.setCmdFunc("ToggleTaskActive",function(a,c){require("x.hub.taskman.js").doWebRequest("ToggleTaskActive",a,c)});d.setCmdFunc("SetAlarmActive",function(a,c){require("x.hub.taskman.js").doWebRequest("SetAlarmActive",a,c)});d.setCmdFunc("SetAlarmDelay",
function(a,c){require("x.hub.taskman.js").doWebRequest("SetAlarmDelay",a,c)});d.setCmdFunc("GetAlarmInfo",function(a,c){require("x.hub.taskman.js").doWebRequest("GetAlarmInfo",a,c)});d.setCmdFunc("SelectAlarmTask",function(a,c){require("x.hub.taskman.js").doWebRequest("SelectAlarmTask",a,c)});d.setCmdFunc("SetAlarmPin",function(a,c){require("x.hub.taskman.js").doWebRequest("SetAlarmPin",a,c)});d.setCmdFunc("GetCloudServer",function(a,c){require("x.hub.taskman.js").doWebRequest("GetCloudServer",a,
c)});d.setCmdFunc("SetCloudServer",function(a,c){require("x.hub.taskman.js").doWebRequest("SetCloudServer",a,c)});d.setCmdFunc("RehauPinChallenge",function(a,c){require("x.hub.taskman.js").doWebRequest("RehauPinChallenge",a,c)});d.setCmdFunc("RehauGetAlarmInfo",function(a,c){require("x.hub.taskman.js").doWebRequest("RehauGetAlarmInfo",a,c)});d.setCmdFunc("RehauSetAlarmDelay",function(a,c){require("x.hub.taskman.js").doWebRequest("RehauSetAlarmDelay",a,c)});d.setCmdFunc("RehauSetDoorAlarmDelay",function(a,
c){require("x.hub.taskman.js").doWebRequest("RehauSetDoorAlarmDelay",a,c)});d.setCmdFunc("RehauSetNewPin",function(a,c){require("x.hub.taskman.js").doWebRequest("RehauSetNewPin",a,c)});d.setCmdFunc("RehauSelectAssociateTaskAlarm",function(a,c){require("x.hub.taskman.js").doWebRequest("RehauSelectAssociateTaskAlarm",a,c)});d.setCmdFunc("RehauSelectAssociateTaskPreAlarm",function(a,c){require("x.hub.taskman.js").doWebRequest("RehauSelectAssociateTaskPreAlarm",a,c)});d.setCmdFunc("RehauSetAlarmActive",
function(a,c){require("x.hub.taskman.js").doWebRequest("RehauSetAlarmActive",a,c)});d.setCmdFunc("RehauAddAlarmKey",function(a,c){require("x.hub.taskman.js").doWebRequest("RehauAddAlarmKey",a,c)});d.setCmdFunc("RehauUpdateAlarmKey",function(a,c){require("x.hub.taskman.js").doWebRequest("RehauUpdateAlarmKey",a,c)});d.setCmdFunc("RehauDeleteAlarmKey",function(a,c){require("x.hub.taskman.js").doWebRequest("RehauDeleteAlarmKey",a,c)});d.setCmdFunc("RehauAddAlarmDoor",function(a,c){require("x.hub.taskman.js").doWebRequest("RehauAddAlarmDoor",
a,c)});d.setCmdFunc("RehauUpdateAlarmDoor",function(a,c){require("x.hub.taskman.js").doWebRequest("RehauUpdateAlarmDoor",a,c)});d.setCmdFunc("RehauDeleteAlarmDoor",function(a,c){require("x.hub.taskman.js").doWebRequest("RehauDeleteAlarmDoor",a,c)});d.setCmdFunc("RehauSetAlarmConfirmation",function(a,c){require("x.hub.taskman.js").doWebRequest("RehauSetAlarmConfirmation",a,c)});d.setCmdFunc("AddEventListener",function(a,c){if((a=a.query.data)&&a.sys){var b=require("x.hub.moduleman.js").modulemanager.getModule(a.sys);
b?b.addStateDevice(a,function(b){b.error?c(JSON.stringify({XC_ERR:{code:"000000",msg:b.error.message}})):c(JSON.stringify({XC_SUC:{}}))}):c(JSON.stringify({XC_ERR:{code:"000000",msg:"no module for sys:"+a.sys}}))}else c(JSON.stringify({XC_ERR:{code:"000000",msg:"device format invalid"}}))});d.setCmdFunc("GetMetaInfo",function(a,c){a=require("x.hub.taskman.js").taskManager;c(JSON.stringify({XC_SUC:{version:String(a.version),trial:(a._mode%31) != 0,deploy:{time:localStorage.getItem("x.hub.hubsyncman.SyncManager.TIMESTAMP"),
userid:localStorage.getItem("x.hub.hubsyncman.SyncManager.USERID"),appid:localStorage.getItem("x.hub.hubsyncman.SyncManager.APPID")}}}))});d.setCmdFunc("ConfigSiegeniaWindow",function(a,c){require("x.hub.m.enocean.js").configSiegeniaWindow(null,null,function(b){b.error?c(JSON.stringify({XC_ERR:{message:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:{}}))})});d.setCmdFunc("AddEnoceanVirtualDevice",function(a,c){require("x.hub.m.enocean.js").generateVirtualDevice(a.query,function(b){b.error?
c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("AddEnoceanDevice",function(a,c){require("x.hub.m.enocean.js").addSensor(a.query,function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("UpdateEnoceanDevice",function(a,c){require("x.hub.m.enocean.js").updateSensor(a.query.address,a.query.device,function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,
code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("TeachinEnocean",function(a,c){require("x.hub.m.enocean.js").teachinDevice(a.query,function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("GetUSBDevices",function(a,c){require("x.hub.peripheralman.js").getUSBDevices(function(b){b.error?c(JSON.stringify({XC_ERR:{message:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});
d.setCmdFunc("SetLogger",function(a,c){a.query.level?(require("x.logger.js").setLevel(a.query.level,a.query.tag),c(JSON.stringify({XC_SUC:{}}))):c(JSON.stringify({XC_ERR:{message:"parameter invalid",code:"010001"}}))});d.setCmdFunc("GetLogger",function(a,c){a=require("x.logger.js").getAll();c(JSON.stringify({XC_SUC:a}))});d.setCmdFunc("DummyEvent",function(a,c){a=a.query.data;require("x.hub.eventbus.js").emit("status",a);c(JSON.stringify({XC_SUC:{}}))});d.setCmdFunc("DummyTaskmanEvent",function(a,
c){var b=a.query.event;a=a.query.meta;require("x.hub.taskman.js").onStatusEvt(b,a);c(JSON.stringify({XC_SUC:{}}))});d.setCmdFunc("GetZwaveStates",function(a,c){a=a.query.devices;require("x.hub.m.zwave.js").__getStates(a,function(b){b.error?c(JSON.stringify({XC_ERROR:{message:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("DirectEvent",function(a,c){var b=a.query.event;a=a.query.tag;require("x.hub.m.gateway.js")._onEvent(b,{address:"http call"},a);c(JSON.stringify({XC_SUC:{}}))});
d.setCmdFunc("GetHmMonitors",function(a,c){require("x.hub.m.hm.js").getMonitorStates(function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("GetHmDevices",function(a,c){require("x.hub.m.hm.js").getAllDevices(function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("EnOceanSDK",function(a,c){require("x.hub.m.enocean.js")._doSDK(a.query.data,
function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("ResetEnOceanSenderID",function(a,c){require("x.hub.m.enocean.js").resetDefaultSenderID(function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:{}}))})});d.setCmdFunc("SetRehauInoventHumidityAccessory",function(a,c){require("x.hub.m.enocean.js").setInoventHumidityAccessory(a.query.inoventID,a.query.humiditySensorID,
function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:{}}))})});d.setCmdFunc("SetRehauInoventCo2Accessory",function(a,c){require("x.hub.m.enocean.js").setInoventCo2Accessory(a.query.inoventID,a.query.co2SensorID,function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:{}}))})});d.setCmdFunc("GetRehauInoventAccessories",function(a,c){require("x.hub.m.enocean.js").getInoventAccessories(a.query.inoventID,
function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("RawEnoceanPacket",function(a,c){a=a.query.data;require("x.hub.m.enocean.js").__simulateRawEnoceanPacket(a,function(b){c(JSON.stringify({XC_SUC:{}}))})});d.setCmdFunc("SendESPFrame",function(a,c){var b=a.query.type,d=a.query.data,e=a.query.optData;a=a.query.requireResponse;require("x.hub.m.enocean.js").__sendEspFrame(b,d,e,a,function(b){b.error?c(JSON.stringify({XC_ERROR:{message:b.error.message,
code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("ZWaveInclusion",function(a,c){require("x.hub.m.zway.js").learnDevice(a.query,function(b,a,c){console.log("learn zwave procedure",b,a,c)},function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("ZWaveExclusion",function(a,c){require("x.hub.m.zway.js").removeDevice(a.query,function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):
c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("ZWaveListDevices",function(a,c){require("x.hub.m.zway.js").listDevices(a.query,function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("ZWaveListInterviewResults",function(a,c){require("x.hub.m.zway.js").listInterviewResults(a.query,function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("ZWaveResetController",
function(a,c){require("x.hub.m.zway.js").resetController(function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("ZWaveSetDeviceSetting",function(a,c){require("x.hub.m.zway.js").setDeviceSetting(a.query.deviceID,a.query.setting,function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("ZWaveGetDeviceSetting",function(a,c){require("x.hub.m.zway.js").getDeviceSetting(a.query.deviceID,
function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("ZWaveForcePollDevices",function(a,c){var b=require("x.hub.m.zway.js");a.query.deviceIDs?(a=a.query.deviceIDs.split(","),b.forcePoll(a,function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})):c(JSON.stringify({XC_ERR:{msg:"no device id list",code:"000000"}}))});d.setCmdFunc("GetKnxIpGateways",
function(a,c){require("x.hub.m.knx.js").getIPGateways(function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("AddKnxIpGateway",function(a,c){a=a.query.data;require("x.hub.m.knx.js").addIPGateway(a,function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("UptateKnxIpGateway",function(a,c){a=a.query.data;require("x.hub.m.knx.js").updateIPGateway(a,
function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("DeleteKnxIpGateway",function(a,c){a=a.query.data;require("x.hub.m.knx.js").deleteIPGateway(a,function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:{}}))})});d.setCmdFunc("GetKnxDevices",function(a,c){require("x.hub.m.knx.js").getDevices(function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,
code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("AddKnxDevice",function(a,c){a=a.query.data;require("x.hub.m.knx.js").addDevice(a,function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("UptateKnxDevice",function(a,c){a=a.query.data;require("x.hub.m.knx.js").updateDevice(a,function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});
d.setCmdFunc("DeleteKnxDevice",function(a,c){a=a.query.data;require("x.hub.m.knx.js").deleteDevice(a,function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:{}}))})});d.setCmdFunc("ListKnxMonitors",function(a,c){require("x.hub.m.knx.js").listMonitors(function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("SearchKnxIpGateways",function(a,c){require("x.hub.m.knx.js").searchKNXGateway(function(b){b.error?
c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("DoZigbeeNativeCommandRaw",function(a,c){require("x.hub.m.zigbee.js").executeCommandNativeRaw(a.query,function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCmdFunc("ListZigbeeDevices",function(a,c){require("x.hub.m.zigbee.js").listDevices(a.query,function(b){b.error?c(JSON.stringify({XC_ERR:{msg:b.error.message,
code:b.error.code}})):c(JSON.stringify({XC_SUC:b.data}))})});d.setCommandFunc("AddGroup",function(a,c){c.send("{XC_SUC}")});d.setCommandFunc("setTaskDeviceAddress",function(a,c){var b=a.query.device;a=a.query.address;b&&a&&devices[b]&&(devices[b].address=a,localStorage&&localStorage.setItem("xnm.aio.xhub.siegenia."+b,a));c.send("{XC_SUC}")});d.setCommandFunc("getTaskDeviceAddress",function(a,c){var b="{XC_ERR}";(a=a.query.device)&&devices[a]&&(b='{XC_SUC}{"address":"'+devices[a].address+'"}');c.send(b)});
d.setCommandFunc("setAlarmGroup",function(a,c){for(var b in taskmanager._tasks)80<=b&&(taskmanager._tasks[b].active="1"==a.query.active?!0:!1);c.send("{XC_SUC}")});d.setCommandFunc("DelGroup",function(a,c){var b="{XC_ERR}",d=parseInt(a.query.id),e=parseInt(a.query.nid);taskmanager._tasks[d]&&a.query.nid&&(taskmanager._tasks[e]=taskmanager._tasks[d],delete taskmanager._tasks[d],b="{XC_SUC}");c.send(b)});d.setCommandFunc("saveGroup",function(a,c){var b="{XC_ERR}",d=parseInt(a.query.id);taskmanager._tasks[d]&&
(taskmanager._tasks[d].active="1"==a.query.active?!0:!1,b="{XC_SUC}");c.send(b)});d.setCommandFunc("GetAll",function(a,c){a="";var b=1,d=1;for(taskid in taskmanager._tasks){var e=taskmanager._tasks[taskid],f="0";e.active&&(f="1");for(var g="",l="",h=0;h<e.trigger.length;h++)l+=XC.getHexVal(b,2),""!=a&&(a+=","),a+='{"sys":"EVENT","id":"'+XC.getHexVal(b++,2)+'","code":""}';for(h=0;h<e.action.length;h++)g+=XC.getHexVal(d,2),""!=a&&(a+=","),a+='{"sys":"ACTION","id":"'+XC.getHexVal(d++,2)+'","code":""}';
""!=a&&(a+=",");a+='{"sys":"GROUP","id":"'+XC.getHexVal(taskid,2)+'","name":"'+e.name+'","active":"'+f+'","triggerids":"'+l+'","actionids":"'+g+'"}'}c.send("{XC_SUC}["+a+"]")});return d}
function _setupAutomationManagerMode(d){function f(a){var b=require("crypto"),c=new Buffer("fO4gAeDjh4HwO0D8+/9Bfw==","base64"),d=new Buffer("+ubtPBJR9uejkjXiN6c1Bg==","base64");b=b.createDecipheriv("aes-128-cbc",c,d);b.setAutoPadding(!0);a=[b.update(new Buffer(a,"base64"))];a.push(b.final());return Buffer.concat(a).toString("utf8")}function e(a){if(!a)return 31*g(23,76)+2;try{var b=f(a);if(10>b.length||"t"!=b.charAt(0)||"a"!=b.charAt(2)||"k"!=b.charAt(9))return 31*g(23,76)+2;var c=b.charAt(1)+""+
b.charAt(5)+""+b.charAt(6);return 31*parseInt(c)}catch(k){return 31*g(23,76)+2}}function g(a,b){a=Math.ceil(a);b=Math.floor(b);return Math.floor(Math.random()*(b-a))+a}var h=require("x.hub.taskman.js"),a=localStorage.getItem("info");h.taskManager.version=global.TASKMANAGER_VERSION;h.taskManager._mode=a?e(a):e();a=require("body-parser");d._app.use("/xhub/activate/do",a.text({limit:"100kb"}));d._app.post("/xhub/activate/req",function(a,b){global.TMP_TOKEN=g(1,5E3);setTimeout(function(){global.TMP_TOKEN=
null},3E4);b.json({status:"success",data:global.TMP_TOKEN})});d._app.post("/xhub/activate/do",function(a,b){if(global.TMP_TOKEN)if(a.body)try{var c=f(a.body),d=""+global.TMP_TOKEN,g=c.substr(c.length-d.length);c.length<d.length||g!=d?b.json({status:"fail",message:"invalid token",code:0}):(localStorage.setItem("info",a.body),h.taskManager._mode=e(a.body),b.json({status:"success"}))}catch(q){b.json({status:"fail",message:"invalid request body",code:0})}else b.json({status:"fail",message:"no request body",
code:0});else b.json({status:"fail",message:"token expired",code:0})})}
function _setupLogger(){var d=require("fs-extra"),f=fm.fileManager;require("x.logger.js").setFile(f.getLogFile());require("x.logger.js").setLogFolder(f.getUserLogPath());require("x.logger.js")._fileMaxSize=2048;require("x.logger.js").setLevel("info");require("x.logger.js").setLevel("trace","x.core.debugf");require("x.logger.js").setTagFile("CloudRemoteAccess","cloud_access.log");d.ensureFileSync(path.resolve(f.getUserLogPath(),"v5p_taskmanager.log"));require("x.logger.js").setTagFile("x.hub.taskman",
"v5p_taskmanager.log");require("x.logger.js").setLogToConsole(!1,"x.hub.taskman");d.ensureFileSync(path.resolve(f.getUserLogPath(),"v5p_homematic.log"));require("x.logger.js").setTagFile("x.hub.m.hm","v5p_homematic.log");require("x.logger.js").setTagFile("xnm.aio.hm","v5p_homematic.log");require("x.logger.js").setLogToConsole(!1,"x.hub.m.hm");require("x.logger.js").setLogToConsole(!0,"x.hub.m.hm.Manager");require("x.logger.js").setLogToConsole(!1,"xnm.aio.hm");d.ensureFileSync(path.resolve(f.getUserLogPath(),
"v5p_enocean.log"));require("x.logger.js").setTagFile("x.hub.m.enocean","v5p_enocean.log");require("x.logger.js").setLogToConsole(!0,"x.hub.m.enocean");d.ensureFileSync(path.resolve(f.getUserLogPath(),"v5p_zigbee.log"));require("x.logger.js").setTagFile("x.hub.m.zigbee","v5p_zigbee.log");require("x.logger.js").setLogToConsole(!1,"x.hub.m.zigbee");d.ensureFileSync(path.resolve(f.getUserLogPath(),"v5p_zwave.log"));require("x.logger.js").setTagFile("x.hub.m.zway","v5p_zwave.log");require("x.logger.js").setLogToConsole(!1,
"x.hub.m.zway");require("x.logger.js").setLogToConsole(!0,"x.hub.m.zway.Handler");d.ensureFileSync(path.resolve(f.getUserLogPath(),"v5p_knx.log"));require("x.logger.js").setTagFile("x.hub.m.knx","v5p_knx.log");require("x.logger.js").setTagFile("xnm.aio.knx","v5p_knx.log");require("x.logger.js").setLogToConsole(!1,"x.hub.m.knx");require("x.logger.js").setLogToConsole(!1,"xnm.aio.knx");require("x.logger.js").setLogToConsole(!0,"x.hub.m.knx.MonitorManager");d.ensureFileSync(path.resolve(f.getUserLogPath(),
"v5p_aiogateway.log"));require("x.logger.js").setTagFile("x.hub.m.gateway","v5p_aiogateway.log");require("x.logger.js").setTagFile("x.hub.m.gateway","v5p_aiogateway.log");require("x.logger.js").setLogToConsole(!1,"x.hub.m.gateway");d.ensureFileSync(path.resolve(f.getUserLogPath(),"v5p_rf_st.log"));require("x.logger.js").setTagFile("x.hub.v5.USBSerial","v5p_rf_st.log");require("x.logger.js").setLogToConsole(!1,"x.hub.v5.USBSerial")}
function _setupDebugSite(d){var f=require("x.hub.fileman.js"),e=f.fileManager,g=require("express"),h=require("path"),a=require("ws").Server,c=h.join(__dirname,"site");d._app.use("/debug",g.static(c+"/debug"));d._app.use("/js",g.static(c+"/js"));this._wss=new a({server:d._httpserver,path:"/debug/tracker/ws"});this._wss.on("error",function(b){console.log("web socket server error:"+b.stack)}.bind(this));this._wss.on("connection",function(b){b.__watchDog=setTimeout(function(){b.close()},6E4);b.on("error",
function(a){console.log("web socket error:"+a.stack);b.close()}.bind(this));b.on("close",function(){if(b.__tags){var a=require("x.logger.js");b.__tags.forEach(function(c){a.removeLogTracker(c,b.__tracker)})}b.__tail&&b.__tail.unwatch()});b.on("message",function(a,c){try{var d=JSON.parse(a);if("main"==d.system){var f=new (require("tail").Tail)(h.resolve(e.getUserLogPath(),"v5plus_daemon"));b.__tail=f;f.on("line",function(a){b.send(a+"\r\n")});f.on("error",function(b){console.log("ERROR: ",b)})}else{a=
[];switch(d.system){case "homematic":a=["x.hub.m.hm","xnm.aio.hm"];break;case "knx":a=["x.hub.m.knx","xnm.aio.knx"];break;case "zwave":a=["x.hub.m.zway"];break;case "enocean":a=["x.hub.m.enocean"];break;case "zigbee":a=["x.hub.m.zigbee"];break;case "aio":a=["x.hub.m.gateway"];break;case "taskmanager":a=["x.hub.taskman"];break;case "script":a=["x.hub.scriptman"];break;case "rf":a=["x.hub.v5.USBSerial"]}if(0<a.length){b.__watchDog&&(clearTimeout(b.__watchDog),b.__watchDog=null);b.__tags=a;b.__tracker=
function(a){b.send(a+"\r\n")};var g=require("x.logger.js");a.forEach(function(a){g.setLogTracker(a,b.__tracker)})}}}catch(n){b.send(JSON.stringify({error:n.message})),b.close()}}.bind(this))}.bind(this));d._app.get("/debug/tracker/log",function(b,a){switch(b.query.system){case "taskmanager":var c="v5p_taskmanager.log";break;case "homematic":c="v5p_homematic.log";break;case "knx":c="v5p_knx.log";break;case "zigbee":c="v5p_zigbee.log";break;case "zwave":c="v5p_zwave.log";break;case "enocean":c="v5p_enocean.log";
break;case "aio":c="v5p_aiogateway.log";break;case "rf":c="v5p_rf_st.log";break;case "main":c="v5plus_daemon";break;default:a.status(404).send("system unknow")}b=h.join(f.fileManager.getUserLogPath(),c);a.sendFile(b)});c=h.join(__dirname,"site/debug/enocean");d._app.use("/debug/enocean/tracker",g.static(c));c=h.join(__dirname,"resources");d._app.use("/resources",g.static(c));this._wss=new a({server:d._httpserver,path:"/debug/enocean/ws"});this._wss.on("error",function(b){console.log("web socket server error:"+
b.stack)}.bind(this));this._wss.on("connection",function(b){console.log("web socket connected");var a={onFrame:function(a,c){b.send("+++++++++++++++++++++++++++++++++\r\n");b.send("EnOcean Frame:");b.send(c+"\r\n");b.send(JSON.stringify(a.toJSON())+"\r\n");b.send("+++++++++++++++++++++++++++++++++\r\n")},onTelegram:function(a){b.send("########################################################\r\n");b.send("EnOcean Telegram:\r\n");b.send(JSON.stringify(a.toJSON())+"\r\n");b.send("########################################################\r\n")},
onResolveEvents:function(a,c){b.send("===============================\r\n");b.send("Resolved Events from:"+a+"\r\n");c.forEach(function(a){b.send(JSON.stringify(a)+"\r\n")});b.send("===============================\r\n")}},c=require("x.hub.m.enocean.js");c.__addTelegramTracker(a);b.on("error",function(a){console.log("web socket error:"+a.stack);b.close()}.bind(this));b.on("close",function(){c.__removeTelegramTracker(a)});b.on("message",function(b,a){}.bind(this))}.bind(this));this._wss2=new a({server:d._httpserver,
path:"/siegenia/enocean/windowconfig"});this._wss2.on("error",function(b){console.log("web socket server error:"+b.stack)}.bind(this));this._wss2.on("connection",function(b){var a=require("x.hub.m.enocean.js");b.__watchDog=setTimeout(function(){b.close()},3E5);b.on("error",function(c){console.log("web socket error:"+c.stack);a._siegeniaHandler.stopCalibateWindow();b.close()}.bind(this));b.on("close",function(){clearTimeout(b.__watchDog);a._siegeniaHandler.stopCalibateWindow()});b.on("message",function(c,
d){try{var e=JSON.parse(c);"start"==e.command&&(a._siegeniaHandler.startCalibateWindow(e.windowID,function(a,c,d){a?b.send(JSON.stringify({error:a.message})):b.send(JSON.stringify({windowID:c,message:d}))}),a._siegeniaHandler.configWindow(e.params,e.windowID,function(a){a&&b.send(JSON.stringify({error:a.message,code:a.code}))}))}catch(l){b.send(JSON.stringify({error:l.message}))}}.bind(this))}.bind(this));this._wss3=new a({server:d._httpserver,path:"/zwave2/inclusion"});this._wss3.on("error",function(b){console.log("web socket server zwaveinclusion error:"+
b.stack)}.bind(this));this._wss3.on("connection",function(b){var a=require("x.hub.m.zway.js");b.__watchDog=setTimeout(function(){b.close()},3E5);b.on("error",function(a){console.log("web socket error:"+a.stack);b.close()}.bind(this));b.on("close",function(){clearTimeout(b.__watchDog)});b.on("message",function(c,d){try{var e=JSON.parse(c);"start"==e.command?a.learnDevice(null,function(a,c,d){b.send(JSON.stringify({progress:a,subprogress:c,message:d}))},function(a){a.error?b.send(JSON.stringify({finish:!0,
error:a.error.message,code:a.error.code,device:a.data})):b.send(JSON.stringify({finish:!0,device:a.data}));b.close()}):"updateInterview"==e.command&&(e.address?a.updateInterview(e.address,e.instanceID,e.commandClassID,function(a,c,d){b.send(JSON.stringify({progress:a,subprogress:c,message:d}))},function(a){a.error?b.send(JSON.stringify({finish:!0,error:a.error.message,code:a.error.code,device:a.data})):b.send(JSON.stringify({finish:!0,device:a.data}));b.close()}):b.send(JSON.stringify({finish:!0,
error:"no address parameter",code:"08999"})))}catch(l){b.send(JSON.stringify({error:l.message}))}}.bind(this))}.bind(this));this._wss4=new a({server:d._httpserver,path:"/taskman/tracker"});this._wss4.on("error",function(b){console.log("web socket server error:"+b.stack)}.bind(this));this._wss4.on("connection",function(b){var a=require("url").parse(b.upgradeReq.url);a=require("querystring").parse(a.query);a.taskID||b.close();b.__taskID=a.taskID;b.__watchDog=setTimeout(function(){b.close()},6E4);b.__tmListener=
function(a){b.send(a+"\r\n")};var c=require("x.hub.taskman.js");c.startTaskTrace(b.__taskID,b.__tmListener,function(a){a&&a.error&&(b.send(JSON.stringify({error:a.error.message})),b.close())});b.on("error",function(a){console.log("web socket error:"+a.stack);b.close()}.bind(this));b.on("close",function(){b.__taskID&&b.__tmListener&&c.stopTaskTrace(b.__taskID,b.__tmListener)});b.on("message",function(a,c){try{JSON.parse(a).alive&&(b.__watchDog&&(clearTimeout(b.__watchDog),b.__watchDog=null),b.__watchDog=
setTimeout(function(){b.close()},6E4))}catch(l){b.send(JSON.stringify({error:l.message})),b.close()}}.bind(this))}.bind(this))}_loadCompilerConfig();_loadProgrammEnv();_loadConfigFile();_loadRuntimeConfig();var fm=require("x.hub.fileman.js");
fm.init("A1"==global.HARDWARE_VERSION?"NEO Server":"v5plus",function(){var d=fm.fileManager;if("EA"==global.HARDWARE_VERSION)fs.existsSync("./data")||fs.mkdirSync("./data"),localStorage=new f("./data/localstorage"),fs.existsSync("./localstorage")&&fs.rmdirRecursiveSync("./localstorage");else if("A1"==global.HARDWARE_VERSION&&!hasLocalStorage)try{var f=require("node-localstorage").LocalStorage;localStorage=new f(d.getUserRootDataPath()+path.sep+"localstorage")}catch(h){}_setupLogger();var e=_setupServer();
_setupDebugSite(e);"EA"==global.HARDWARE_VERSION&&"A20"==global.PLATFORM&&(console.log((new Date).toString()+" ===========> LED Start Sequence"),f=new miot.STMUpdater,f.hostType=e.hostType,f.resetST(),setTimeout(function(){e.startSTM(function(d){e.doSTMCommand("XC_FNC=SendSC&type=RGB&data=040305")})},500),0==v5.Native.checkResetPin()&&(console.log((new Date).toString()+" ===========> reset button pressed, start safe mode"),global.SAFE_MODE=!0));require("x.hub.deviceman.js").init(e._app,d,function(){require("x.hub.macroman.js").init(e._app,
d);require("x.hub.scriptman.js").init(e._app,e._httpserver);require("x.hub.commandman.js").init(e._app);var f=require("x.hub.taskman.js");global.SAFE_MODE&&(console.log("!!! run task manager in safe mode"),f.lock());f.init();require("x.hub.sysvarman.js").init(e._app,d);_setupAutomationManagerMode(e);e.startWebserver(global.WEB_SERVER_PORT,function(){"EA"==global.HARDWARE_VERSION&&"A20"==global.PLATFORM&&e.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0400")});e.enableCloudConnect(new v5.CloudConnect);
"A20"==global.PLATFORM&&"EA"==global.HARDWARE_VERSION&&v5.Native.watchResetPin(e,function(a){XC.debugf("RESET: "+a);"reboot"==a?e.restart(0):"network"==a?v5.Native.resetNetwork(function(){e.restart(0)}):"passwords"==a?v5.reset(e,a,function(){e.restart(0)}):"factory"==a&&v5.reset(e,a,function(){v5.Native.resetHM(function(){v5.Native.resetZway(function(){v5.Native.resetNetwork(function(){e.restart(0)})})})})})});"A20"==global.PLATFORM&&"EA"==global.HARDWARE_VERSION&&require("x.hub.datastore.js").init(d);
require("x.hub.peripheralman.js").init(e._app,e._httpserver);require("x.hub.hubsyncman.js").init(e._app,d);var g=require("x.hub.moduleman.js");global.LOAD_MODULES.forEach(function(d){g.Modules.push(d)});g.init();g.initModules();f=require("xnm.aio.gateway.js");f._autoSearchInterval&&clearInterval(f._autoSearchInterval)});process.on("uncaughtException",function(d){console.error(d.stack)});
process.on("SIGINT",function(){console.log("Got SIGINT.");-1!=global.LOAD_MODULES.indexOf("knx")?require("x.hub.m.knx.js").clean(function(){console.log("SIGINT callback.");process.exit(1)}):process.exit(1)});process.on("SIGTERM",function(){console.log("Got SIGTERM.");-1!=global.LOAD_MODULES.indexOf("knx")?require("x.hub.m.knx.js").clean(function(){console.log("SIGINT callback.");process.exit(1)}):process.exit(1)});
