var x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.siegenia=x.hub.m.siegenia||{};x.hub.m.siegenia.SIEGENIA_MODULE=require("xnm.aio.siegenia.js");require("x.logger.js").setLevel("trace","x.hub.m.siegenia");require("x.logger.js").setLevel("trace","xnm.aio.siegenia");x.hub.m.siegenia.Handler=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.siegenia.Handler");this._devices={};this._on={}};x.hub.m.siegenia.Handler.prototype.init=function(a){a&&a()};
x.hub.m.siegenia.Handler.prototype.getSystems=function(){return["siegenia"]};
x.hub.m.siegenia.Handler.prototype.addStateDevice=function(a,b,c){if(a){if(a.address||!a.ip)a.ip=a.address;if(a.ip){var f=x.hub.m.siegenia.SIEGENIA_MODULE.resolveDevice(a);if(f){var d=this._devices[a.ip];if(d){if(c&&d.metas.push(c),a.password!=d.dev.password||a.password!=d.obj.password)d.dev.password=a.password,d.obj.password=a.password}else{d={dev:a,obj:f,metas:[c]};this._devices[a.ip]=d;var e=this;d.obj.startMonitoring(function(b){e._checkStateChange(a,b)},function(){})}b&&b({})}else b&&b({error:Error("device json unknow device")})}else b&&
b({error:Error("device json invalid")})}else b&&b({error:Error("device json invalid")})};
x.hub.m.siegenia.Handler.prototype.removeStateDevice=function(a,b,c){if(!a)b&&b({error:Error("device json invalid")});else if(c){var f=this._devices[a.ip];if(f){var d=f.metas;if(d){for(var e=-1,g=0;g<d.length;g++){var h=d[g];if(h&&"taskman"==h.src&&"taskman"==c.src&&h.taskID==c.taskID&&h.statusKey==c.statusKey){e=g;break}}0<=e&&d.splice(e,1);if(0==d.length){delete this._devices[a.ip];x.hub.m.siegenia.SIEGENIA_MODULE.SessionManager.stopMonitorSession(f.obj,function(){b&&b()});return}}b&&b()}else b&&
b({})}};x.hub.m.siegenia.Handler.prototype.updateStates=function(a,b){var c=x.hub.m.siegenia.SIEGENIA_MODULE.resolveDevice(a);c?c.getSingleDeviceStatesCreator(null,a,null,function(a,c){b&&b({error:a,data:c})}):b&&b({error:Error("device json invalid")})};x.hub.m.siegenia.Handler.prototype.getStates=function(a){return{}};x.hub.m.siegenia.Handler.prototype.getAllStates=function(){return[]};
x.hub.m.siegenia.Handler.prototype.executeCommand=function(a,b,c){a&&a.address&&(a.ip=a.address);x.hub.m.siegenia.SIEGENIA_MODULE.doCommand(a,b,function(a){a?c&&c({error:a}):c&&c({})})};x.hub.m.siegenia.Handler.prototype.getState=function(a,b,c){a&&a.address&&(a.ip=a.address);x.hub.m.siegenia.SIEGENIA_MODULE.doStatus("xhub",a,{value:b},function(a,b){a?c&&c({error:a}):b?c&&c({data:{value:b.status}}):c&&c({error:Error("do status failed")})})};
x.hub.m.siegenia.Handler.prototype.checkDeviceMatch=function(a,b){if(!(b&&b.device&&a&&a.device))return!1;var c=a.device.data;return a.device.address==b.device.address&&c==b.device.data};
x.hub.m.siegenia.Handler.prototype._checkStateChange=function(a,b){this._logger.log("trace","receive status:"+JSON.stringify(b));this._logger.log("trace","for device:"+JSON.stringify(a));if(this._devices[a.ip]){var c=this._devices[a.ip],f=c.states;f||(c.states={},f={});var d=[],e;for(e in b){var g={};g.key=e;g.value=b[e];g.changed=!0;f[e]&&b[e]==f[e].value&&(g.oldvalue=f[e].value,g.changed=!1);c.states[e]={value:b[e],time:(new Date).getTime()};g.changed&&d.push({device:a,data:g});if("warnings"==e){var h=
f[e]?f[e].value:null;b[e].forEach(function(b){var c={key:"warning"};c.value=b;c.changed=!1;h&&-1==h.indexOf(b)&&(c.changed=!0);d.push({device:a,data:c})})}}d&&0<d.length&&this._generateEvent(a,d)}};
x.hub.m.siegenia.Handler.prototype._generateEvent=function(a,b){if(this._devices[a.ip]){var c=require("x.hub.eventbus.js"),f=this._devices[a.ip].metas;if(f&&0<f.length)for(var d=0;d<f.length;d++){var e=f[d];if(e)for(var g=0;g<b.length;g++){var h=b[g];h&&h.data&&(h.data.key==e.statusKey||"*"==h.data.key)&&c.emit("status",{module:"siegenia",device:h.device,data:h.data},e)}}}};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.siegenia.Handler);
