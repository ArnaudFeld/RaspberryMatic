var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.ir=xnm.aio.ir||{};
xnm.aio.ir.RedEye=function(){var d=function(a,b,c){var d=require("x.logger.js");this._logger=d?d.getLogger("RedEye"):{log:function(){}};this._host=a;this._serial=c;this._port=b;if(!this._port||0>this._port)this._port=80};d.SEND_PATH="/cgi-bin/play_iph.sh?/devicedata/";d.LEARN_PATH="/cgi-bin/RedEyeApp?debug=1";d.prototype.executeCommandCreator=function(a,b,c){if(b&&b.value)if(a&&a.ircodes&&a.ircodes.codes){for(var d,e=0;e<a.ircodes.codes.length;e++){var g=a.ircodes.codes[e];if(g.key==b.value){d=g.code;
break}}d?this.executeCommand(a,d,function(b){c&&c(b)}):c&&c(Error("no such ir code:"+b.value))}else c&&c(Error("device has no ir codes"));else c&&c(Error("command invalid"))};d.prototype.executeCommand=function(a,b,c){b?this._doGetRequest(this._host,this._port,d.SEND_PATH+b,function(b){c&&c(b)}):c&&c(Error("command invalid"))};d.prototype.learnIrCode=function(a){this._doPostRequest(this._host,82,d.LEARN_PATH,'<?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>id</key><integer>-1</integer><key>serialNumber</key><string>'+
this._serial+"</string><key>clientType</key><integer>99999</integer><key>softwareVersion</key><string>2.6.0</string><key>type</key><integer>26</integer><key>isInitialRequest</key><string>no</string><key>hostName</key><string></string><key>cookie</key><integer>-1</integer><key>actions</key></dict></plist>",function(b,c){if(b)a&&a(b);else if(c&&-1!=c.indexOf("/devicedata/")){var d=c.indexOf("/devicedata/");c=c.substr(d+12);d=c.indexOf("<");-1==d?a&&a(Error("learn ir code response error")):(d=c.substr(0,
d),a&&a(null,d))}else a&&a(Error("learn ir code response error"))})};d.prototype._doGetRequest=function(a,b,c,d){var e=d;a={host:a,port:b,path:c,method:"GET"};var g=this,k="";a=require("http").request(a,function(c){200==c.statusCode?(c.setEncoding("utf8"),c.on("data",function(c){k+=c}),c.on("end",function(){e&&e(null,k);e=null})):(g._logger.log("warn","Failed to do get request to "+g.ip+" with status code:"+c.statusCode),e&&e(Error("post request failed with status code:"+c.statusCode)),e=null)});
if(a.on&&"function"==typeof a.on)a.on("error",function(c){e&&e(c);e=null});a.end()};d.prototype._doPostRequest=function(a,b,c,d,e){var g=e;a={host:a,port:b,path:c,method:"POST",headers:{"Content-Type":'text/xml; charset="UTF-8"',"Content-Length":d.length,"User-Agent":"mediola",Connection:"close"}};var k=this,l="";a=require("http").request(a,function(c){200==c.statusCode?(c.setEncoding("utf8"),c.on("data",function(c){l+=c}),c.on("end",function(){g&&g(null,l);g=null})):(k._logger.log("warn","Failed to do get request to "+
k.ip+" with status code:"+c.statusCode),g&&g(Error("post request failed with status code:"+c.statusCode)),g=null)});if(a.on&&"function"==typeof a.on)a.on("error",function(c){g&&g(c);g=null});a.write(d);a.end()};d.prototype.toJSON=function(){return{sys:xnm.aio.ir.RedEye.DM.SYS,ip:this._host,port:this._port,serial:this._serial}};d.prototype.equalsTo=function(a){return a&&a instanceof d?this._host==a._host:!1};d.parseJSON=function(a){return a.ip?new d(a.ip,a.port,a.serial):null};d.discoveryWithTimeout=
function(a,b){var c=require("x.mdns.js");c.clearRecordBuffer();c.discoverServiceWithTimeout("_tf_redeye._tcp.local",a,function(c,a){if(c)b&&b(c);else{for(var g=[],k=0;k<a.length;k++){var l=a[k];if(l.target&&l.ip&&0<l.ip.length){var m=l.target.replace("RedEye_",""),m=m.replace(".local",""),l=new d(l.ip[0],80,m);g.push(l)}}b&&b(c,g)}})};return d}();
xnm.aio.ir.RedEye.DM=function(){return{SYS:"redeye",registModule:function(d){d.register(this.SYS,"ir")},getGatewayType:function(){return{sys:this.SYS,name:"RedEye"}},createGateway:function(d,a,b){a=xnm.aio.ir.DMError;var c=xnm.aio.ir.DMError.ERROR_CODE;d?d.ip?b(null,d):b(new a(c.INVALID,"ip is invalid")):b(new a(c.INVALID,"info is invalid"))},updateGateway:function(d,a,b,c){d=xnm.aio.ir.DMError;b=xnm.aio.ir.DMError.ERROR_CODE;a?a.ip?c(null,a):c(new d(b.INVALID,"ip is invalid")):c(new d(b.INVALID,
"update is invalid"))},deleteGateway:function(d,a,b){b()},createDevice:function(d,a,b){var c=xnm.aio.ir.DMError,f=xnm.aio.ir.DMError.ERROR_CODE;if(d.gateway)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var e,g;for(e=0;e<a.length;e++)if(a[e].index===d.gateway){g=a[e];break}g?b(null,d):b(new c(f.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else b(new c(f.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else b(new c(f.INVALID,"gateway is invalid"))},
updateDevice:function(d,a,b){var c=xnm.aio.ir.DMError,f=xnm.aio.ir.DMError.ERROR_CODE;if(d)if(d.gateway){a=a.data.gateways;var e,g;for(e=0;e<a.length;e++)if(a[e].index===d.gateway){g=a[e];break}g?b(null,d):b(new c(f.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else b(new c(f.INVALID,"gateway is invalid"));else b(new c(f.INVALID,"info is invalid"))},deleteDevice:function(d,a,b){b()},getCommandStatusMap:function(d){var a={command:[]};if(d&&d.ircodes&&d.ircodes.codes){for(var b=0;b<d.ircodes.codes.length;b++){var c=
d.ircodes.codes[b];a.command.push({type:"enum",name:c.key,ref:{value:c.key}})}return a}return null}}}();
xnm.aio.ir.IRTrans=function(){var d=function(a,b){var c=require("x.logger.js");this._logger=c?c.getLogger("IRTrans"):{log:function(){}};this._ip=a;this._port=b;this._port||(this._port=21E3);this._idleTimer=this._socket=null;this._commandTasks=[]};d.SO_TIMEOUT=2E3;d.IDLE_TIMEOUT=6E4;d.CONNECTION_PREAMBLE="ASCI";d.prototype.executeCommandCreator=function(a,b,c,d){if(b&&b.value)if(a&&a.ircodes&&a.ircodes.codes){for(var e,g=0;g<a.ircodes.codes.length;g++){var k=a.ircodes.codes[g];if(k.key==b.value){e=
k.code;break}}e?this.executeCommand(a,e,function(){c&&c()},d):c&&c(Error("no such ir code:"+b.value))}else c&&c(Error("device has no ir codes"));else c&&c(Error("command invalid"))};d.prototype.executeCommand=function(a,b,c,d){var e="Asndhex ";switch(a.address){case "LD":case "LI":case "LE":case "LB":case "L1":case "L2":case "L3":case "L4":case "L5":case "L6":case "L7":case "L8":e+=a.address+" "}var e=e+("H"+b),g=this;this._createSocket(function(b){b?c&&c(b):g._addTask("command",e,d,c)})};d.prototype.learnIrCode=
function(a,b){var c="Alearn M"+(a&a.mode?a.mode:0)+" I"+(a&a.timeout?a.timeout:0)+" R"+(a&a.receiver?a.receiver:"I1")+" W10",d=this;this._createSocket(function(a){a?b&&b(a):d._addTask("learn",c,!0,b)})};d.prototype.toJSON=function(){return{sys:xnm.aio.ir.IRTrans.DM.SYS,ip:this._ip,port:this._port}};d.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.ir.IRTrans?this._ip==a._ip&&this._port==a._port:!1};d.prototype._createSocket=function(a){if(this._socket)a();else{var b=this,c={port:this._port,
host:this._ip},f=require("net").connect(c);f.setTimeout(d.SO_TIMEOUT);f.setEncoding("utf8");f.on("connect",function(){b._logger.log("trace","connect to irtrans:"+b._ip);f.write(d.CONNECTION_PREAMBLE);b._socket=f;a()});f.on("data",function(c){b._logger.log("trace","receive from irtrans:"+b._ip+" data:"+c);b._onSocketData(c)});f.on("error",function(c){b._socket?(b._logger.log("trace","irtrans:"+b._ip+" error:"+c.message),b._onSocketError(c)):(b._logger.log("trace","irtrans:"+b._ip+" connection error:"+
c.message),a(c))});f.on("timeout",function(){b._socket?(b._logger.log("trace","irtrans:"+b._ip+" data timeout"),b._onSocketTimeout()):(b._logger.log("trace","irtrans:"+b._ip+" connection timeout"),f.destroy(),a(Error("timeout")))});f.on("close",function(){b._logger.log("trace","irtrans:"+b._ip+" close socket");b._onSocketClose()});f._doConnect&&"function"==typeof f._doConnect&&f._doConnect()}};d.prototype._closeSocket=function(){this._socket&&this._socket.end();this._clean()};d.prototype._clean=function(){this._idleTimer&&
(clearTimeout(this._idleTimer),this._idleTimer=null);this._socket=null;if(this._commandTasks)for(var a=0;a<this._commandTasks.length;a++){var b=this._commandTasks[a];b&&b.callback&&b.callback(Error("socket closed"))}this._commandTasks=[]};d.prototype._onSocketError=function(a){this._closeSocket()};d.prototype._onSocketTimeout=function(){4<this._commandTasks.length&&this._closeSocket()};d.prototype._onSocketClose=function(){this._clean()};d.prototype._onSocketData=function(a){a=a.split(" ");var b=
2<a.length&&"LEARN"==a[1],c;b&&(c=a[2].replace(/\r?\n|\r/g,""));var d=!1;if(0<this._commandTasks.length){var e=this._commandTasks[0],d=e.closeSocket;this._commandTasks.splice(0,1);var g;"learn"==e.type&&0==a[2].indexOf("Error")&&(a=a.slice(2),g=Error(a.join(" ").replace(/\r?\n|\r/g,"")));e.callback&&e.callback(g,b?c:null)}d&&0==this._commandTasks.length&&this._closeSocket()};d.prototype._addTask=function(a,b,c,f){this._logger.log("trace","add task to buffer");this._commandTasks.push({type:a,data:b,
callback:f,closeSocket:c});var e=this;this._idleTimer&&clearTimeout(this._idleTimer);this._idleTimer=setTimeout(function(){e._closeSocket()},d.IDLE_TIMEOUT);this._doRequest(b)};d.prototype._doRequest=function(a){this._logger.log("trace","send data to irtrans:"+this._ip+" data:"+a);this._socket&&this._socket.write(a)};d.parseJSON=function(a){return a.ip?new d(a.ip,a.port):null};d._discovery=function(a,b){var c=function(c,b,a){c=c.toString("hex");2<c.length&&0==c.toLowerCase().indexOf("e7")&&(b=new xnm.aio.ir.IRTrans(b.address),
a.push(b))},d=function(b,a,d,f){var e=f,h=require("dgram").createSocket({type:"udp4",reuseAddr:!0});h.on("listening",function(){h.setBroadcast(!0);e&&(e(null,h),e=null)});h.on("message",function(b,a){c(b,a,d)});h.on("error",function(c){e&&(e(c),e=null)});h.bind(b,a);return h},e=function(c){var b=new Buffer([200,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,214,2,39,11,100,179,139]);c.send(b,0,b.length,21E3,"255.255.255.255")};
(function(b){var a=b,e=[],m=[],n,h=require("os"),q=require("dgram");h&&h.networkInterfaces?(n=q.createSocket({type:"udp4",reuseAddr:!0}),n.on("listening",function(){n.setBroadcast(!0);var c=h.networkInterfaces(),b=[],g;for(g in c)for(var v=c[g],t=0;t<v.length;t++)"IPv4"==v[t].family&&0==v[t].internal&&b.push(v[t].address);for(var q=0,c=0;c<b.length;c++)d(21E3,b[c],e,function(c,d){!c&&d&&m.push(d);q++;q==b.length&&a&&(a(null,m,e),a=null)})}),n.on("message",function(b,a){c(b,a,e)}),n.on("error",function(c){n.close();
a&&(a(c),a=null)}),n.bind(21E3),n._isListenerSocket=!0,m.push(n)):d(21E3,null,e,function(c,a){c?b&&b(c):(a&&m.push(a),b&&b(null,m,e))})})(function(c,d,f){if(!c&&d){for(c=0;c<d.length;c++){var m=d[c];m._isListenerSocket||e(m)}setTimeout(function(){if(d)for(var c=0;c<d.length;c++)d[c].close();b&&b(null,f)},a)}})};return d}();
xnm.aio.ir.IRTrans.DM=function(){return{SYS:"irtrans",registModule:function(d){d.register(this.SYS,"ir")},getGatewayType:function(){return{sys:this.SYS,name:"IRTrans"}},createGateway:function(d,a,b){a=xnm.aio.ir.DMError;var c=xnm.aio.ir.DMError.ERROR_CODE;d?d.ip?b(null,d):b(new a(c.INVALID,"ip is invalid")):b(new a(c.INVALID,"info is invalid"))},updateGateway:function(d,a,b,c){d=xnm.aio.ir.DMError;b=xnm.aio.ir.DMError.ERROR_CODE;a?a.ip?c(null,a):c(new d(b.INVALID,"ip is invalid")):c(new d(b.INVALID,
"update is invalid"))},deleteGateway:function(d,a,b){b()},createDevice:function(d,a,b){var c=xnm.aio.ir.DMError,f=xnm.aio.ir.DMError.ERROR_CODE;if(d.gateway)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var e,g;for(e=0;e<a.length;e++)if(a[e].index===d.gateway){g=a[e];break}g?b(null,d):b(new c(f.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else b(new c(f.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else b(new c(f.INVALID,"gateway is invalid"))},
updateDevice:function(d,a,b){var c=xnm.aio.ir.DMError,f=xnm.aio.ir.DMError.ERROR_CODE;if(d)if(d.gateway){a=a.data.gateways;var e,g;for(e=0;e<a.length;e++)if(a[e].index===d.gateway){g=a[e];break}g?b(null,d):b(new c(f.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else b(new c(f.INVALID,"gateway is invalid"));else b(new c(f.INVALID,"info is invalid"))},deleteDevice:function(d,a,b){b()},getCommandStatusMap:function(d){var a={command:[]};if(d&&d.ircodes&&d.ircodes.codes){for(var b=0;b<d.ircodes.codes.length;b++){var c=
d.ircodes.codes[b];a.command.push({type:"enum",name:c.key,ref:{value:c.key}})}return a}return null}}}();
xnm.aio.ir.iTach=function(){var d=function(c,b,a){this.type="learnIR";this.itach=c;this.closeSocket=b;this.callback=a;this.timer=null;this._step=0;this._data=""};d.prototype.run=function(){var c=this;this.itach._createSocket(function(b){b?(c.itach._delTask(c),c.callback&&c.callback(b),c._taskFinish()):(c.itach._doRequest("get_IRL\r"),c._step=1,c.timer=setTimeout(function(){c.itach._doRequest("stop_IRL\r");c.callback&&c.callback(Error("learn ir code timeout"));c.itach._delTask(c);c._taskFinish()},
2E4))})};d.prototype.onData=function(c){this._data+=c;-1!=this._data.indexOf("\r")&&(1==this._step?"IR Learner Enabled"==this._data.trim()?(this._data="",this._step=2):(this.timer&&clearTimeout(this.timer),this.itach._delTask(this),this.callback&&this.callback(Error(this._data)),this._taskFinish()):2==this._step&&(0==this._data.indexOf("sendir")?(c=this._data.split(","),c.splice(0,2),c=c.join().trim(),this._step=3,this.timer&&clearTimeout(this.timer),this.itach._delTask(this),this.callback&&this.callback(null,
c),this._taskFinish()):this._data=""))};d.prototype.onTimeout=function(){switch(this._step){case 1:this.timer&&clearTimeout(this.timer),this.itach._delTask(this),this.callback&&this.callback(Error("learn ir code req timeout")),this._taskFinish()}};d.prototype._taskFinish=function(){this.itach._taskBuffer&&0==this.itach._taskBuffer.length?this.closeSocket&&this.itach._closeSocket():this.itach._doNextTask()};var a=function(c,b,a){this.type="sendIR";this.itach=c;this.closeSocket=b.closeSocket;this.address=
b.address?b.address:"1:1";this.code=b.code;this.callback=a;this._step=0;this._data=""};a.prototype.run=function(){var c=this;this.itach._createSocket(function(b){b?(c.itach._delTask(c),c.callback&&c.callback(b),c._taskFinish()):(c.itach._doRequest("set_IR,"+c.address+",IR\r"),c._step=1)})};a.prototype.onData=function(c){this._data+=c;if(-1!=this._data.indexOf("\r"))if(1==this._step)-1!=this._data.trim().indexOf("ERR")?(this.itach._delTask(this),this.callback&&this.callback(Error(this._data)),this._taskFinish()):
(this._data="",this._step=2,this.itach._doRequest("sendir,"+this.address+","+this.code+"\r"));else if(2==this._step){var b;if(-1!=this._data.trim().indexOf("ERR")||-1!=this._data.trim().indexOf("busyIR"))b=Error(this._data);this.itach._delTask(this);this.callback&&this.callback(b);this._taskFinish()}};a.prototype.onTimeout=function(){switch(this._step){case 1:case 2:this.timer&&clearTimeout(this.timer),this.itach._delTask(this),this.callback&&this.callback("send ir code timeout"),this._taskFinish()}};
a.prototype._taskFinish=function(){this.itach._taskBuffer&&0==this.itach._taskBuffer.length?this.closeSocket&&this.itach._closeSocket():this.itach._doNextTask()};var b=function(c,b,a){var d=require("x.logger.js");this.ip=c;this.port=b?b:4998;this.uuid=a;this.model=null;this._logger=d?d.getLogger("xnm.aio.ir.iTach"):{log:function(){}};this._idleTimer=this._socket=null;this._taskBuffer=[]};b.prototype.toJSON=function(){return{sys:xnm.aio.ir.iTach.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid?this.uuid:
"",model:this.model?this.model:""}};b.prototype.equalsTo=function(c){return c&&c instanceof b?this.ip==c.ip&&this.port==c.port:!1};b.prototype.executeCommandCreator=function(c,b,a,d){if(b&&b.value)if(c&&c.ircodes&&c.ircodes.codes){for(var k,l=0;l<c.ircodes.codes.length;l++){var m=c.ircodes.codes[l];if(m.key==b.value){k=m.code;break}}k?this.executeCommand(c.address,k,d,function(){a&&a()}):a&&a(Error("no such ir code:"+b.value))}else a&&a(Error("device has no ir codes"));else a&&a(Error("command invalid"))};
b.prototype.executeCommand=function(c,b,d,g){c=new a(this,{address:c,code:b,closeSocket:d},g);this._addTask(c)};b.prototype.learnIrCode=function(c,b){if(b){var a=new d(this,c,b);this._addTask(a)}};b.SO_TIMEOUT=2E3;b.IDLE_TIMEOUT=6E4;b.prototype._createSocket=function(c){if(this._socket)c();else{var a=this,d={port:this.port,host:this.ip},g=require("net").connect(d);g.setTimeout(b.SO_TIMEOUT);g.setEncoding("utf8");g.on("connect",function(){a._logger.log("trace","connect to itach:"+a.ip);a._socket=g;
c()});g.on("data",function(c){a._logger.log("trace","receive from itach:"+a.ip+" data:"+c);a._onSocketData(c)});g.on("error",function(b){a._socket?(a._logger.log("trace","itach:"+a.ip+" error:"+b.message),a._onSocketError(b)):(a._logger.log("trace","itach:"+a.ip+" connection error:"+b.message),c(b))});g.on("timeout",function(){a._socket?(a._logger.log("trace","itach:"+a.ip+" data timeout"),a._onSocketTimeout()):(a._logger.log("trace","itach:"+a.ip+" connection timeout"),g.destroy(),c(Error("timeout")))});
g.on("close",function(){a._logger.log("trace","itach:"+a.ip+" close socket");a._onSocketClose()});g._doConnect&&"function"==typeof g._doConnect&&g._doConnect()}};b.prototype._closeSocket=function(){this._logger.log("trace","to close itach socket");this._socket&&this._socket.end();this._clean()};b.prototype._clean=function(){this._idleTimer&&(clearTimeout(this._idleTimer),this._idleTimer=null);this._socket=null;if(this._taskBuffer)for(var c=0;c<this._taskBuffer.length;c++){var b=this._taskBuffer[c];
b&&b.callback&&b.callback(Error("socket closed"))}this._taskBuffer=[]};b.prototype._onSocketError=function(c){this._closeSocket()};b.prototype._onSocketTimeout=function(){if(this._taskBuffer&&0<this._taskBuffer.length)this._taskBuffer[0].onTimeout()};b.prototype._onSocketClose=function(){this._clean()};b.prototype._onSocketData=function(c){if(this._taskBuffer&&0<this._taskBuffer.length)this._taskBuffer[0].onData(c)};b.prototype._addTask=function(c){this._logger.log("trace","add task to buffer");this._idleTimer&&
clearTimeout(this._idleTimer);var a=this;this._idleTimer=setTimeout(function(){a._logger.log("trace","idle timer triggered");a._closeSocket()},b.IDLE_TIMEOUT);var d=this._taskBuffer.length;this._taskBuffer.push(c);0==d&&this._doNextTask()};b.prototype._delTask=function(c){this._logger.log("trace","delete task from buffer");for(var b=-1,a=0;a<this._taskBuffer.length;a++)if(this._taskBuffer[a]===c){b=a;break}-1!=b&&this._taskBuffer.splice(b,1)};b.prototype._doNextTask=function(){this._taskBuffer&&0<
this._taskBuffer.length&&this._taskBuffer[0].run()};b.prototype._doRequest=function(c){this._logger.log("trace","send data to itach:"+this.ip+" data:"+c);this._socket&&this._socket.write(c)};b.parseJSON=function(c){if(!c||!c.ip)return null;var a=new b(c.ip,c.port,c.uuid);a.model=c.model;return a};b.discovery=function(c){if(c&&(this._discoverCallbacks||(this._discoverCallbacks=[]),this._addDiscoverCallback(c),!this._discoverRunning)){this._discoverRunning=!0;var b=this;this._startDiscovery(function(c){if(c){for(var a=
0;a<b._discoverCallbacks.length;a++)b._discoverCallbacks[a](c);b._discoverCallbacks=[];b._discoverRunning=!1}else setTimeout(function(){b._stopDiscovery(function(){var c=[],a;for(a in b._discoverResults)b._discoverResults.hasOwnProperty(a)&&c.push(b._discoverResults[a]);for(a=0;a<b._discoverCallbacks.length;a++)b._discoverCallbacks[a](null,c);b._discoverCallbacks=[]})},1E4)})}};b._addDiscoverCallback=function(c){for(var b=!1,a=0;a<this._discoverCallbacks.length;a++)if(this._discoverCallbacks[a]===
c){b=!0;break}b||this._discoverCallbacks.push(c)};b._removeDiscoverCallback=function(c){for(var a=-1,b=0;b<this._discoverCallbacks.length;b++)if(this._discoverCallbacks[b]===c){a=b;break}-1!=a&&this._discoverCallbacks.splice(a,1)};b._startDiscovery=function(a){var d=require("x.logger.js");this._logger||(this._logger=d?d.getLogger("xnm.aio.ir.iTach"):{log:function(){}});this._discoverResults={};var e=this;(function(a,b){var c=b,d=[],e=require("os"),f=require("dgram");if(e&&e.networkInterfaces){var e=
e.networkInterfaces(),q;for(q in e)if(e.hasOwnProperty(q))for(var u=e[q],r=0;r<u.length;r++)"IPv4"==u[r].family&&0==u[r].internal&&d.push(u[r].address)}var p=f.createSocket("udp4");p.on("listening",function(){p.setBroadcast(!0);if(0<d.length)for(var a=0;a<d.length;a++)p.addMembership("239.255.250.250",d[a]);else p.addMembership("239.255.250.250");c&&(c(null,p),c=null)});p.on("message",function(b,c){a(b,c)});p.on("error",function(a){p.close();c&&(c(a),c=null)});p.bind(9131)})(function(a,c){var d=a.toString();
if(0==d.indexOf("AMXB")){0==d.indexOf("AMXB")&&(d=d.substr(4));for(var f=d.split(/<-/g),d={},n=0;n<f.length;n++){var h=f[n].trim(),h=h.substr(0,h.length-1),h=h.split("=");2<=h.length&&h[0]&&(d[h[0]]=h[1])}e._logger.log("trace","find iTach:"+JSON.stringify(d));d.UUID&&!e._discoverResults[d.UUID]&&(f=new b(c.address,4998,d.UUID),f.model=d.Model,e._discoverResults[d.UUID]=f)}},function(b,d){b?a&&a(b):(e._discoverSocket=d,a&&a())})};b._stopDiscovery=function(a){this._discoverSocket||a&&a();this._discoverSocket.close();
this._discoverSocket=null;this._discoverRunning=!1;a&&a()};return b}();
xnm.aio.ir.iTach.DM=function(){return{SYS:"itach",registModule:function(d){d.register(this.SYS,"ir")},getGatewayType:function(){return{sys:this.SYS,name:"Global Cach\u00e9 iTach (IR)"}},createGateway:function(d,a,b){a=xnm.aio.ir.DMError;var c=xnm.aio.ir.DMError.ERROR_CODE;d?d.ip?b(null,d):b(new a(c.INVALID,"ip is invalid")):b(new a(c.INVALID,"info is invalid"))},updateGateway:function(d,a,b,c){d=xnm.aio.ir.DMError;b=xnm.aio.ir.DMError.ERROR_CODE;a?a.ip?c(null,a):c(new d(b.INVALID,"ip is invalid")):
c(new d(b.INVALID,"update is invalid"))},deleteGateway:function(d,a,b){b()},createDevice:function(d,a,b){var c=xnm.aio.ir.DMError,f=xnm.aio.ir.DMError.ERROR_CODE;if(d.gateway)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var e,g;for(e=0;e<a.length;e++)if(a[e].index===d.gateway){g=a[e];break}g?b(null,d):b(new c(f.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else b(new c(f.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else b(new c(f.INVALID,"gateway is invalid"))},
updateDevice:function(d,a,b){var c=xnm.aio.ir.DMError,f=xnm.aio.ir.DMError.ERROR_CODE;if(d)if(d.gateway){a=a.data.gateways;var e,g;for(e=0;e<a.length;e++)if(a[e].index===d.gateway){g=a[e];break}g?b(null,d):b(new c(f.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else b(new c(f.INVALID,"gateway is invalid"));else b(new c(f.INVALID,"info is invalid"))},deleteDevice:function(d,a,b){b()},getCommandStatusMap:function(d){var a={command:[]};if(d&&d.ircodes&&d.ircodes.codes){for(var b=0;b<d.ircodes.codes.length;b++){var c=
d.ircodes.codes[b];a.command.push({type:"enum",name:c.key,ref:{value:c.key}})}return a}return null}}}();xnm.aio.ir.DMError=function(){var d=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};d.prototype=Error();d.prototype.name="IrDmError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return d}();
xnm.aio.ir.DM=function(){return{getGatewayType:function(d){var a=[],b;for(b in xnm.aio.ir)if(xnm.aio.ir.hasOwnProperty(b)){var c=xnm.aio.ir[b];c&&c.DM&&c.DM.getGatewayType&&(c=c.DM.getGatewayType(d))&&a.push(c)}return a},_getSystem:function(d){for(var a in xnm.aio.ir)if(xnm.aio.ir.hasOwnProperty(a)){var b=xnm.aio.ir[a];if(b&&b.DM&&b.DM.SYS&&b.DM.SYS==d)return b}return null},createGateway:function(d,a,b){var c=xnm.aio.ir.DMError,f=xnm.aio.ir.DMError.ERROR_CODE;if(d)if(d.sys){var e=this._getSystem(d.sys);
e&&e.DM&&e.DM.createGateway?e.DM.createGateway(d,a,b):b&&b(new c(f.INVALID,"no such sys:"+d.sys))}else b&&b(new c(f.INVALID,"sys is invalid"));else b&&b(new c(f.INVALID,"info is invalid"))},updateGateway:function(d,a,b,c){var f=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;if(a)if(a.sys){var g=this._getSystem(a.sys);g&&g.DM&&g.DM.updateGateway?g.DM.updateGateway(d,a,b,c):c&&c(new f(e.INVALID,"no such sys:"+a.sys))}else c&&c(new f(e.INVALID,"sys is invalid"));else c&&c(new f(e.INVALID,"update is invalid"))},
deleteGateway:function(d,a,b){var c=xnm.aio.ir.DMError,f=xnm.aio.ir.DMError.ERROR_CODE;if(d)if(d.sys){var e=this._getSystem(d.sys);e&&e.DM&&e.DM.deleteGateway?e.DM.deleteGateway(d,a,b):b&&b(new c(f.INVALID,"no such sys:"+d.sys))}else b&&b(new c(f.INVALID,"sys is invalid"));else b&&b()},createDevice:function(d,a,b){var c=xnm.aio.ir.DMError,f=xnm.aio.ir.DMError.ERROR_CODE;if(d)if(d.sys){var e=this._getSystem(d.sys);e&&e.DM&&e.DM.createDevice?e.DM.createDevice(d,a,b):b&&b(new c(f.INVALID,"no such sys:"+
d.sys))}else b&&b(new c(f.INVALID,"sys is invalid"));else b&&b(new c(f.INVALID,"info is invalid"))},updateDevice:function(d,a,b){var c=xnm.aio.ir.DMError,f=xnm.aio.ir.DMError.ERROR_CODE;if(d)if(d.sys){var e=this._getSystem(d.sys);e&&e.DM&&e.DM.updateDevice?e.DM.updateDevice(d,a,b):b&&b(new c(f.INVALID,"no such sys:"+d.sys))}else b&&b(new c(f.INVALID,"sys is invalid"));else b&&b(new c(f.INVALID,"info is invalid"))},deleteDevice:function(d,a,b){var c=xnm.aio.ir.DMError,f=xnm.aio.ir.DMError.ERROR_CODE;
if(d)if(d.sys){var e=this._getSystem(d.sys);e&&e.DM&&e.DM.deleteDevice?e.DM.deleteDevice(d,a,b):b&&b(new c(f.INVALID,"no such sys:"+d.sys))}else b&&b(new c(f.INVALID,"sys is invalid"));else b&&b()},applyUIFilter:function(d,a){var b=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},c=function(a,c,d){var e=[];switch(d.catagory){case "command":a.command&&a.command.forEach(function(a){b(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;
case "status":a.status&&a.status.forEach(function(a){b(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},f=function(a,b){var d=[],e=null,f;a.sys&&(e=this._getSystem(a.sys))&&e.DM&&e.DM.getCommandStatusMap&&(f=e.DM.getCommandStatusMap(a));f&&(e=c(f,a,b),d=d.concat(e));return d};if(!d.sys)return null;var e=JSON.parse(JSON.stringify(d)),g=null;switch(a.catagory){case "command":g=f.call(this,d,a);e.command=g;break;case "status":g=f.call(this,d,a);e.status=g;break;default:return null}return g&&
0!=g.length?e:null}}}();
xnm.aio.ir.Handler=function(){var d=function(){};d.prototype.devicemanager=xnm.aio.ir.DM;d.prototype.registModule=function(a){for(var b in xnm.aio.ir)if(xnm.aio.ir.hasOwnProperty(b)){var c=xnm.aio.ir[b];c&&c.DM&&c.DM.registModule&&c.DM.registModule(a)}};d.prototype.resolveGateway=function(a){switch(a.sys){case xnm.aio.ir.IRTrans.DM.SYS:return xnm.aio.ir.IRTrans.parseJSON(a);case xnm.aio.ir.RedEye.DM.SYS:return xnm.aio.ir.RedEye.parseJSON(a);case xnm.aio.ir.iTach.DM.SYS:return xnm.aio.ir.iTach.parseJSON(a);default:return null}};
d.prototype.getDeviceCommands=function(a,b){var c=xnm.aio.ir.DM.applyUIFilter(a,{catagory:"command",elems:"*"}),c=c?c.command:[];b&&b(null,c)};d.prototype.searchIRTransWithTimeout=function(a,b){xnm.aio.ir.IRTrans._discovery(a,b)};d.prototype.learnIRTransCode=function(a,b,c){(a=xnm.aio.ir.IRTrans.parseJSON(a))?a.learnIrCode(b,c):c&&c(Error("gateway json format invalid"))};d.prototype.doIRTransCommand=function(a,b,c,d){(a=xnm.aio.ir.IRTrans.parseJSON(a))?a.executeCommandCreator(b,c,d,!0):d&&d(Error("gateway json format invalid"))};
d.prototype.searchRedeyeWithTimeout=function(a,b){xnm.aio.ir.RedEye.discoveryWithTimeout(a,b)};d.prototype.learnRedeyeCode=function(a,b){var c=xnm.aio.ir.RedEye.parseJSON(a);c?c.learnIrCode(b):b&&b(Error("gateway json format invalid"))};d.prototype.doRedeyeCommand=function(a,b,c,d){(a=xnm.aio.ir.RedEye.parseJSON(a))?a.executeCommandCreator(b,c,d):d&&d(Error("gateway json format invalid"))};d.prototype.searchITach=function(a){xnm.aio.ir.iTach.discovery(a)};d.prototype.learnITachCode=function(a,b){var c=
xnm.aio.ir.iTach.parseJSON(a);c?c.learnIrCode(!0,b):b&&b(Error("gateway json format invalid"))};d.prototype.doITachCommand=function(a,b,c,d){(a=xnm.aio.ir.iTach.parseJSON(a))?a.executeCommandCreator(b,c,d,!0):d&&d(Error("gateway json format invalid"))};return d}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.ir.Handler);
