var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.ir=xnm.aio.ir||{},xnm.aio.ir.RedEye=function(){var e=function e(_e,t,i){var r=require("x.logger.js");this._logger=r?r.getLogger("RedEye"):{log:function log(){}},this._host=_e,this._serial=i,this._port=t,(!this._port||this._port<0)&&(this._port=80);};return e.SEND_PATH="/cgi-bin/play_iph.sh?/devicedata/",e.LEARN_PATH="/cgi-bin/RedEyeApp?debug=1",e.prototype.executeCommandCreator=function(e,t,i){if(t&&t.value){if(e&&e.ircodes&&e.ircodes.codes){for(var r,o=0;o<e.ircodes.codes.length;o++){var a=e.ircodes.codes[o];if(a.key==t.value){r=a.code;break;}}r?this.executeCommand(e,r,function(e){i&&i(e);}):i&&i(new Error("no such ir code:"+t.value));}else i&&i(new Error("device has no ir codes"));}else i&&i(new Error("command invalid"));},e.prototype.executeCommand=function(t,i,r){if(i){var o=e.SEND_PATH+i;this._doGetRequest(this._host,this._port,o,function(e){r&&r(e);});}else r&&r(new Error("command invalid"));},e.prototype.learnIrCode=function(t){var i='<?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>id</key><integer>-1</integer><key>serialNumber</key><string>'+this._serial+"</string><key>clientType</key><integer>99999</integer><key>softwareVersion</key><string>2.6.0</string><key>type</key><integer>26</integer><key>isInitialRequest</key><string>no</string><key>hostName</key><string></string><key>cookie</key><integer>-1</integer><key>actions</key></dict></plist>";this._doPostRequest(this._host,82,e.LEARN_PATH,i,function(e,i){if(e)t&&t(e);else if(i&&-1!=i.indexOf("/devicedata/")){var r=i.indexOf("/devicedata/");if(-1!=(r=(i=i.substr(r+12)).indexOf("<"))){var o=i.substr(0,r);t&&t(null,o);}else t&&t(new Error("learn ir code response error"));}else t&&t(new Error("learn ir code response error"));});},e.prototype._doGetRequest=function(e,t,i,r){var o=r,a={host:e,port:t,path:i,method:"GET"},n=this,s="",c=require("http").request(a,function(e){200==e.statusCode?(e.setEncoding("utf8"),e.on("data",function(e){s+=e;}),e.on("end",function(){o&&o(null,s),o=null;})):(n._logger.log("warn","Failed to do get request to "+n.ip+" with status code:"+e.statusCode),o&&o(new Error("post request failed with status code:"+e.statusCode)),o=null);});c.on&&"function"==typeof c.on&&c.on("error",function(e){o&&o(e),o=null;}),c.end();},e.prototype._doPostRequest=function(e,t,i,r,o){var a=o,n={host:e,port:t,path:i,method:"POST",headers:{"Content-Type":'text/xml; charset="UTF-8"',"Content-Length":r.length,"User-Agent":"mediola",Connection:"close"}},s=this,c="",l=require("http").request(n,function(e){200==e.statusCode?(e.setEncoding("utf8"),e.on("data",function(e){c+=e;}),e.on("end",function(){a&&a(null,c),a=null;})):(s._logger.log("warn","Failed to do get request to "+s.ip+" with status code:"+e.statusCode),a&&a(new Error("post request failed with status code:"+e.statusCode)),a=null);});l.on&&"function"==typeof l.on&&l.on("error",function(e){a&&a(e),a=null;}),l.write(r),l.end();},e.prototype.toJSON=function(){return{sys:xnm.aio.ir.RedEye.DM.SYS,ip:this._host,port:this._port,serial:this._serial};},e.prototype.equalsTo=function(t){return!!t&&t instanceof e&&this._host==t._host;},e.parseJSON=function(t){return t.ip?new e(t.ip,t.port,t.serial):null;},e.discoveryWithTimeout=function(t,i){var r=require("x.mdns.js");r.clearRecordBuffer(),r.discoverServiceWithTimeout("_tf_redeye._tcp.local",t,function(t,r){if(t)i&&i(t);else{for(var o=[],a=0;a<r.length;a++){var n=r[a];if(n.target&&n.ip&&n.ip.length>0){var s=n.target.replace("RedEye_","");s=s.replace(".local","");var c=new e(n.ip[0],80,s);o.push(c);}}i&&i(t,o);}});},e;}(),xnm.aio.ir.RedEye.DM={SYS:"redeye",registModule:function registModule(e){e.register(this.SYS,"ir");},getGatewayType:function getGatewayType(){return{sys:this.SYS,name:"RedEye"};},createGateway:function createGateway(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;e?e.ip?i(null,e):i(new r(o.INVALID,"ip is invalid")):i(new r(o.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,i,r){var o=xnm.aio.ir.DMError,a=xnm.aio.ir.DMError.ERROR_CODE;t?t.ip?r(null,t):r(new o(a.INVALID,"ip is invalid")):r(new o(a.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,i){i();},createDevice:function createDevice(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e.gateway){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var a,n,s=t.data.gateways;for(a=0;a<s.length;a++)if(s[a].index===e.gateway){n=s[a];break;}n?i(null,e):i(new r(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else i(new r(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else i(new r(o.INVALID,"gateway is invalid"));},updateDevice:function updateDevice(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e){if(e.gateway){var a,n,s=t.data.gateways;for(a=0;a<s.length;a++)if(s[a].index===e.gateway){n=s[a];break;}n?i(null,e):i(new r(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else i(new r(o.INVALID,"gateway is invalid"));}else i(new r(o.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,i){i();},getCommandStatusMap:function getCommandStatusMap(e){var t={command:[]};if(e&&e.ircodes&&e.ircodes.codes){for(var i=0;i<e.ircodes.codes.length;i++){var r=e.ircodes.codes[i];t.command.push({type:"enum",name:r.key,ref:{value:r.key}});}return t;}return null;}},xnm.aio.ir.IRTrans=function(){var e=function e(_e2,t){var i=require("x.logger.js");this._logger=i?i.getLogger("IRTrans"):{log:function log(){}},this._ip=_e2,this._port=t,this._port||(this._port=21e3),this._socket=null,this._idleTimer=null,this._commandTasks=[];};return e.SO_TIMEOUT=2e3,e.IDLE_TIMEOUT=6e4,e.CONNECTION_PREAMBLE="ASCI\n",e.prototype.executeCommandCreator=function(e,t,i,r){if(t&&t.value){if(e&&e.ircodes&&e.ircodes.codes){for(var o,a=0;a<e.ircodes.codes.length;a++){var n=e.ircodes.codes[a];if(n.key==t.value){o=n.code;break;}}o?this.executeCommand(e,o,function(){i&&i();},r):i&&i(new Error("no such ir code:"+t.value));}else i&&i(new Error("device has no ir codes"));}else i&&i(new Error("command invalid"));},e.prototype.executeCommand=function(e,t,i,r){var o="Asndhex ";switch(e.address){case"LD":case"LI":case"LE":case"LB":case"L1":case"L2":case"L3":case"L4":case"L5":case"L6":case"L7":case"L8":o+=e.address+" ";}o+="H"+t+"\n";var a=this;this._createSocket(function(e){e?i&&i(e):a._addTask("command",o,r,i);});},e.prototype.learnIrCode=function(e,t){var i="Alearn M"+(e&e.mode?e.mode:0)+" I"+(e&e.timeout?e.timeout:0)+" R"+(e&e.receiver?e.receiver:"I1")+" W10\n",r=this;this._createSocket(function(e){e?t&&t(e):r._addTask("learn",i,!0,t);});},e.prototype.toJSON=function(){return{sys:xnm.aio.ir.IRTrans.DM.SYS,ip:this._ip,port:this._port};},e.prototype.equalsTo=function(e){return!!e&&e instanceof xnm.aio.ir.IRTrans&&this._ip==e._ip&&this._port==e._port;},e.prototype._createSocket=function(t){if(this._socket)t();else{var i=this,r={port:this._port,host:this._ip},o=require("net").connect(r);o.setTimeout(e.SO_TIMEOUT),o.setEncoding("utf8"),o.on("connect",function(){i._logger.log("trace","connect to irtrans:"+i._ip),o.write(e.CONNECTION_PREAMBLE),i._socket=o,t();}),o.on("data",function(e){i._logger.log("trace","receive from irtrans:"+i._ip+" data:"+e),i._onSocketData(e);}),o.on("error",function(e){i._socket?(i._logger.log("trace","irtrans:"+i._ip+" error:"+e.message),i._onSocketError(e)):(i._logger.log("trace","irtrans:"+i._ip+" connection error:"+e.message),t(e));}),o.on("timeout",function(){i._socket?(i._logger.log("trace","irtrans:"+i._ip+" data timeout"),i._onSocketTimeout()):(i._logger.log("trace","irtrans:"+i._ip+" connection timeout"),o.destroy(),t(new Error("timeout")));}),o.on("close",function(){i._logger.log("trace","irtrans:"+i._ip+" close socket"),i._onSocketClose();}),o._doConnect&&"function"==typeof o._doConnect&&o._doConnect();}},e.prototype._closeSocket=function(){this._socket&&this._socket.end(),this._clean();},e.prototype._clean=function(){if(this._idleTimer&&(clearTimeout(this._idleTimer),this._idleTimer=null),this._socket=null,this._commandTasks)for(var e=0;e<this._commandTasks.length;e++){var t=this._commandTasks[e];t&&t.callback&&t.callback(new Error("socket closed"));}this._commandTasks=[];},e.prototype._onSocketError=function(e){this._closeSocket();},e.prototype._onSocketTimeout=function(){this._commandTasks.length>4&&this._closeSocket();},e.prototype._onSocketClose=function(){this._clean();},e.prototype._onSocketData=function(e){var t,i=e.split(" "),r=i.length>2&&"LEARN"==i[1];r&&(t=i[2].replace(/\r?\n|\r/g,""));var o=!1;if(this._commandTasks.length>0){var a,n=this._commandTasks[0];o=n.closeSocket,this._commandTasks.splice(0,1),"learn"==n.type&&0==i[2].indexOf("Error")&&(i=i.slice(2),a=new Error(i.join(" ").replace(/\r?\n|\r/g,""))),n.callback&&n.callback(a,r?t:null);}o&&0==this._commandTasks.length&&this._closeSocket();},e.prototype._addTask=function(t,i,r,o){this._logger.log("trace","add task to buffer"),this._commandTasks.push({type:t,data:i,callback:o,closeSocket:r});var a=this;this._idleTimer&&clearTimeout(this._idleTimer),this._idleTimer=setTimeout(function(){a._closeSocket();},e.IDLE_TIMEOUT),this._doRequest(i);},e.prototype._doRequest=function(e){this._logger.log("trace","send data to irtrans:"+this._ip+" data:"+e),this._socket&&this._socket.write(e);},e.parseJSON=function(t){return t.ip?new e(t.ip,t.port):null;},e._discovery=function(e,t){var i=function i(e,t,_i){var r=e.toString("hex");if(r.length>2&&0==r.toLowerCase().indexOf("e7")){var o=new xnm.aio.ir.IRTrans(t.address);_i.push(o);}},r=function r(e,t,_r,o){var a=o,n=require("dgram").createSocket({type:"udp4",reuseAddr:!0});return n.on("listening",function(){n.setBroadcast(!0),a&&(a(null,n),a=null);}),n.on("message",function(e,t){i(e,t,_r);}),n.on("error",function(e){a&&(a(e),a=null);}),n.bind(e,t),n;},o=function o(e){var t=new Buffer([200,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,214,2,39,11,100,179,139]);e.send(t,0,t.length,21e3,"255.255.255.255");};!function(e){var t,o=e,a=[],n=[],s=require("os"),c=require("dgram");s&&s.networkInterfaces?((t=c.createSocket({type:"udp4",reuseAddr:!0})).on("listening",function(){t.setBroadcast(!0);var e=s.networkInterfaces(),i=[];for(var c in e)for(var l=e[c],u=0;u<l.length;u++)"IPv4"==l[u].family&&0==l[u].internal&&i.push(l[u].address);for(var d=0,h=0;h<i.length;h++)r(21e3,i[h],a,function(e,t){!e&&t&&n.push(t),++d==i.length&&o&&(o(null,n,a),o=null);});}),t.on("message",function(e,t){i(e,t,a);}),t.on("error",function(e){t.close(),o&&(o(e),o=null);}),t.bind(21e3),t._isListenerSocket=!0,n.push(t)):r(21e3,null,a,function(t,i){t?e&&e(t):(i&&n.push(i),e&&e(null,n,a));});}(function(i,r,a){if(!i&&r){for(var n=0;n<r.length;n++){var s=r[n];s._isListenerSocket||o(s);}setTimeout(function(){if(r)for(var e=0;e<r.length;e++)r[e].close();t&&t(null,a);},e);}});},e;}(),xnm.aio.ir.IRTrans.DM={SYS:"irtrans",registModule:function registModule(e){e.register(this.SYS,"ir");},getGatewayType:function getGatewayType(){return{sys:this.SYS,name:"IRTrans"};},createGateway:function createGateway(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;e?e.ip?i(null,e):i(new r(o.INVALID,"ip is invalid")):i(new r(o.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,i,r){var o=xnm.aio.ir.DMError,a=xnm.aio.ir.DMError.ERROR_CODE;t?t.ip?r(null,t):r(new o(a.INVALID,"ip is invalid")):r(new o(a.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,i){i();},createDevice:function createDevice(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e.gateway){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var a,n,s=t.data.gateways;for(a=0;a<s.length;a++)if(s[a].index===e.gateway){n=s[a];break;}n?i(null,e):i(new r(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else i(new r(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else i(new r(o.INVALID,"gateway is invalid"));},updateDevice:function updateDevice(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e){if(e.gateway){var a,n,s=t.data.gateways;for(a=0;a<s.length;a++)if(s[a].index===e.gateway){n=s[a];break;}n?i(null,e):i(new r(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else i(new r(o.INVALID,"gateway is invalid"));}else i(new r(o.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,i){i();},getCommandStatusMap:function getCommandStatusMap(e){var t={command:[]};if(e&&e.ircodes&&e.ircodes.codes){for(var i=0;i<e.ircodes.codes.length;i++){var r=e.ircodes.codes[i];t.command.push({type:"enum",name:r.key,ref:{value:r.key}});}return t;}return null;}},xnm.aio.ir.iTach=function(){var e=function e(_e3,t,i){this.type="learnIR",this.itach=_e3,this.closeSocket=t,this.callback=i,this.timer=null,this._step=0,this._data="";};e.prototype.run=function(){var e=this;this.itach._createSocket(function(t){if(t)return e.itach._delTask(e),e.callback&&e.callback(t),void e._taskFinish();e.itach._doRequest("get_IRL\r"),e._step=1,e.timer=setTimeout(function(){e.itach._doRequest("stop_IRL\r"),e.callback&&e.callback(new Error("learn ir code timeout")),e.itach._delTask(e),e._taskFinish();},2e4);});},e.prototype.onData=function(e){if(this._data+=e,-1!=this._data.indexOf("\r"))if(1==this._step)"IR Learner Enabled"==this._data.trim()?(this._data="",this._step=2):(this.timer&&clearTimeout(this.timer),this.itach._delTask(this),this.callback&&this.callback(new Error(this._data)),this._taskFinish());else if(2==this._step)if(0==this._data.indexOf("sendir")){var t=this._data.split(",");t.splice(0,2);var i=t.join().trim();this._step=3,this.timer&&clearTimeout(this.timer),this.itach._delTask(this),this.callback&&this.callback(null,i),this._taskFinish();}else this._data="";},e.prototype.onTimeout=function(){1===this._step&&(this.timer&&clearTimeout(this.timer),this.itach._delTask(this),this.callback&&this.callback(new Error("learn ir code req timeout")),this._taskFinish());},e.prototype._taskFinish=function(){this.itach._taskBuffer&&0==this.itach._taskBuffer.length?this.closeSocket&&this.itach._closeSocket():this.itach._doNextTask();};var t=function t(e,_t,i){this.type="sendIR",this.itach=e,this.closeSocket=_t.closeSocket,this.address=_t.address?_t.address:"1:1",this.code=_t.code,this.callback=i,this._step=0,this._data="";};t.prototype.run=function(){var e=this;this.itach._createSocket(function(t){if(t)return e.itach._delTask(e),e.callback&&e.callback(t),void e._taskFinish();e.itach._doRequest("set_IR,"+e.address+",IR\r"),e._step=1;});},t.prototype.onData=function(e){if(this._data+=e,-1!=this._data.indexOf("\r"))if(1==this._step)-1!=this._data.trim().indexOf("ERR")?(this.itach._delTask(this),this.callback&&this.callback(new Error(this._data)),this._taskFinish()):(this._data="",this._step=2,this.itach._doRequest("sendir,"+this.address+","+this.code+"\r"));else if(2==this._step){var t;-1==this._data.trim().indexOf("ERR")&&-1==this._data.trim().indexOf("busyIR")||(t=new Error(this._data)),this.itach._delTask(this),this.callback&&this.callback(t),this._taskFinish();}},t.prototype.onTimeout=function(){switch(this._step){case 1:case 2:this.timer&&clearTimeout(this.timer),this.itach._delTask(this),this.callback&&this.callback("send ir code timeout"),this._taskFinish();}},t.prototype._taskFinish=function(){this.itach._taskBuffer&&0==this.itach._taskBuffer.length?this.closeSocket&&this.itach._closeSocket():this.itach._doNextTask();};var i=function i(e,t,_i2){var r=require("x.logger.js");this.ip=e,this.port=t||4998,this.uuid=_i2,this.model=null,this._logger=r?r.getLogger("xnm.aio.ir.iTach"):{log:function log(){}},this._socket=null,this._idleTimer=null,this._taskBuffer=[];};return i.prototype.toJSON=function(){return{sys:xnm.aio.ir.iTach.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid?this.uuid:"",model:this.model?this.model:""};},i.prototype.equalsTo=function(e){return!!e&&e instanceof i&&this.ip==e.ip&&this.port==e.port;},i.prototype.executeCommandCreator=function(e,t,i,r){if(t&&t.value){if(e&&e.ircodes&&e.ircodes.codes){for(var o,a=0;a<e.ircodes.codes.length;a++){var n=e.ircodes.codes[a];if(n.key==t.value){o=n.code;break;}}o?this.executeCommand(e.address,o,r,function(){i&&i();}):i&&i(new Error("no such ir code:"+t.value));}else i&&i(new Error("device has no ir codes"));}else i&&i(new Error("command invalid"));},i.prototype.executeCommand=function(e,i,r,o){var a=new t(this,{address:e,code:i,closeSocket:r},o);this._addTask(a);},i.prototype.learnIrCode=function(t,i){if(i){var r=new e(this,t,i);this._addTask(r);}},i.SO_TIMEOUT=2e3,i.IDLE_TIMEOUT=6e4,i.prototype._createSocket=function(e){if(this._socket)e();else{var t=this,r={port:this.port,host:this.ip},o=require("net").connect(r);o.setTimeout(i.SO_TIMEOUT),o.setEncoding("utf8"),o.on("connect",function(){t._logger.log("trace","connect to itach:"+t.ip),t._socket=o,e();}),o.on("data",function(e){t._logger.log("trace","receive from itach:"+t.ip+" data:"+e),t._onSocketData(e);}),o.on("error",function(i){t._socket?(t._logger.log("trace","itach:"+t.ip+" error:"+i.message),t._onSocketError(i)):(t._logger.log("trace","itach:"+t.ip+" connection error:"+i.message),e(i));}),o.on("timeout",function(){t._socket?(t._logger.log("trace","itach:"+t.ip+" data timeout"),t._onSocketTimeout()):(t._logger.log("trace","itach:"+t.ip+" connection timeout"),o.destroy(),e(new Error("timeout")));}),o.on("close",function(){t._logger.log("trace","itach:"+t.ip+" close socket"),t._onSocketClose();}),o._doConnect&&"function"==typeof o._doConnect&&o._doConnect();}},i.prototype._closeSocket=function(){this._logger.log("trace","to close itach socket"),this._socket&&this._socket.end(),this._clean();},i.prototype._clean=function(){if(this._idleTimer&&(clearTimeout(this._idleTimer),this._idleTimer=null),this._socket=null,this._taskBuffer)for(var e=0;e<this._taskBuffer.length;e++){var t=this._taskBuffer[e];t&&t.callback&&t.callback(new Error("socket closed"));}this._taskBuffer=[];},i.prototype._onSocketError=function(e){this._closeSocket();},i.prototype._onSocketTimeout=function(){this._taskBuffer&&this._taskBuffer.length>0&&this._taskBuffer[0].onTimeout();},i.prototype._onSocketClose=function(){this._clean();},i.prototype._onSocketData=function(e){this._taskBuffer&&this._taskBuffer.length>0&&this._taskBuffer[0].onData(e);},i.prototype._addTask=function(e){this._logger.log("trace","add task to buffer"),this._idleTimer&&clearTimeout(this._idleTimer);var t=this;this._idleTimer=setTimeout(function(){t._logger.log("trace","idle timer triggered"),t._closeSocket();},i.IDLE_TIMEOUT);var r=this._taskBuffer.length;this._taskBuffer.push(e),0==r&&this._doNextTask();},i.prototype._delTask=function(e){this._logger.log("trace","delete task from buffer");for(var t=-1,i=0;i<this._taskBuffer.length;i++)if(this._taskBuffer[i]===e){t=i;break;}-1!=t&&this._taskBuffer.splice(t,1);},i.prototype._doNextTask=function(){this._taskBuffer&&this._taskBuffer.length>0&&this._taskBuffer[0].run();},i.prototype._doRequest=function(e){this._logger.log("trace","send data to itach:"+this.ip+" data:"+e),this._socket&&this._socket.write(e);},i.parseJSON=function(e){if(!e||!e.ip)return null;var t=new i(e.ip,e.port,e.uuid);return t.model=e.model,t;},i.discovery=function(e){if(e&&(this._discoverCallbacks||(this._discoverCallbacks=[]),this._addDiscoverCallback(e),!this._discoverRunning)){this._discoverRunning=!0;var t=this;this._startDiscovery(function(e){if(e){for(var i=0;i<t._discoverCallbacks.length;i++)t._discoverCallbacks[i](e);return t._discoverCallbacks=[],void(t._discoverRunning=!1);}setTimeout(function(){t._stopDiscovery(function(){var e=[];for(var i in t._discoverResults)t._discoverResults.hasOwnProperty(i)&&e.push(t._discoverResults[i]);for(var r=0;r<t._discoverCallbacks.length;r++)t._discoverCallbacks[r](null,e);t._discoverCallbacks=[];});},1e4);});}},i._addDiscoverCallback=function(e){for(var t=!1,i=0;i<this._discoverCallbacks.length;i++)if(this._discoverCallbacks[i]===e){t=!0;break;}t||this._discoverCallbacks.push(e);},i._removeDiscoverCallback=function(e){for(var t=-1,i=0;i<this._discoverCallbacks.length;i++)if(this._discoverCallbacks[i]===e){t=i;break;}-1!=t&&this._discoverCallbacks.splice(t,1);},i._startDiscovery=function(e){var t=require("x.logger.js");this._logger||(this._logger=t?t.getLogger("xnm.aio.ir.iTach"):{log:function log(){}}),this._discoverResults={};var r=this;!function(e,t){var i=t,r=[],o=require("os"),a=require("dgram");if(o&&o.networkInterfaces){var n=o.networkInterfaces();for(var s in n)if(n.hasOwnProperty(s))for(var c=n[s],l=0;l<c.length;l++)"IPv4"==c[l].family&&0==c[l].internal&&r.push(c[l].address);}var u=a.createSocket("udp4");u.on("listening",function(){if(u.setBroadcast(!0),r.length>0)for(var e=0;e<r.length;e++)u.addMembership("239.255.250.250",r[e]);else u.addMembership("239.255.250.250");i&&(i(null,u),i=null);}),u.on("message",function(t,i){e(t,i);}),u.on("error",function(e){u.close(),i&&(i(e),i=null);}),u.bind(9131);}(function(e,t){var o=e.toString();if(0==o.indexOf("AMXB")){var a=function(e){0==e.indexOf("AMXB")&&(e=e.substr(4));for(var t=e.split(/<-/g),i={},r=0;r<t.length;r++){var o=t[r].trim(),a=(o=o.substr(0,o.length-1)).split("=");a.length>=2&&a[0]&&(i[a[0]]=a[1]);}return i;}(o);if(r._logger.log("trace","find iTach:"+JSON.stringify(a)),a.UUID&&!r._discoverResults[a.UUID]){var n=new i(t.address,4998,a.UUID);n.model=a.Model,r._discoverResults[a.UUID]=n;}}},function(t,i){t?e&&e(t):(r._discoverSocket=i,e&&e());});},i._stopDiscovery=function(e){this._discoverSocket||e&&e(),this._discoverSocket.close(),this._discoverSocket=null,this._discoverRunning=!1,e&&e();},i;}(),xnm.aio.ir.iTach.DM={SYS:"itach",registModule:function registModule(e){e.register(this.SYS,"ir");},getGatewayType:function getGatewayType(){return{sys:this.SYS,name:"Global Caché iTach (IR)"};},createGateway:function createGateway(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;e?e.ip?i(null,e):i(new r(o.INVALID,"ip is invalid")):i(new r(o.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,i,r){var o=xnm.aio.ir.DMError,a=xnm.aio.ir.DMError.ERROR_CODE;t?t.ip?r(null,t):r(new o(a.INVALID,"ip is invalid")):r(new o(a.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,i){i();},createDevice:function createDevice(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e.gateway){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var a,n,s=t.data.gateways;for(a=0;a<s.length;a++)if(s[a].index===e.gateway){n=s[a];break;}n?i(null,e):i(new r(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else i(new r(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else i(new r(o.INVALID,"gateway is invalid"));},updateDevice:function updateDevice(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e){if(e.gateway){var a,n,s=t.data.gateways;for(a=0;a<s.length;a++)if(s[a].index===e.gateway){n=s[a];break;}n?i(null,e):i(new r(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else i(new r(o.INVALID,"gateway is invalid"));}else i(new r(o.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,i){i();},getCommandStatusMap:function getCommandStatusMap(e){var t={command:[]};if(e&&e.ircodes&&e.ircodes.codes){for(var i=0;i<e.ircodes.codes.length;i++){var r=e.ircodes.codes[i];t.command.push({type:"enum",name:r.key,ref:{value:r.key}});}return t;}return null;}},xnm.aio.ir.DMError=function(){var e=function e(_e4,t){this.code=_e4,this.message=t,this.stack=new Error().stack;};return(e.prototype=new Error()).name="IrDmError",e.prototype.code=0,e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},e;}(),xnm.aio.ir.DM={getGatewayType:function getGatewayType(e){var t=[];for(var i in xnm.aio.ir)if(xnm.aio.ir.hasOwnProperty(i)){var r=xnm.aio.ir[i];if(r&&r.DM&&r.DM.getGatewayType){var o=r.DM.getGatewayType(e);o&&t.push(o);}}return t;},_getSystem:function _getSystem(e){for(var t in xnm.aio.ir)if(xnm.aio.ir.hasOwnProperty(t)){var i=xnm.aio.ir[t];if(i&&i.DM&&i.DM.SYS&&i.DM.SYS==e)return i;}return null;},createGateway:function createGateway(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e){if(e.sys){var a=this._getSystem(e.sys);a&&a.DM&&a.DM.createGateway?a.DM.createGateway(e,t,i):i&&i(new r(o.INVALID,"no such sys:"+e.sys));}else i&&i(new r(o.INVALID,"sys is invalid"));}else i&&i(new r(o.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,i,r){var o=xnm.aio.ir.DMError,a=xnm.aio.ir.DMError.ERROR_CODE;if(t){if(t.sys){var n=this._getSystem(t.sys);n&&n.DM&&n.DM.updateGateway?n.DM.updateGateway(e,t,i,r):r&&r(new o(a.INVALID,"no such sys:"+t.sys));}else r&&r(new o(a.INVALID,"sys is invalid"));}else r&&r(new o(a.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e){if(e.sys){var a=this._getSystem(e.sys);a&&a.DM&&a.DM.deleteGateway?a.DM.deleteGateway(e,t,i):i&&i(new r(o.INVALID,"no such sys:"+e.sys));}else i&&i(new r(o.INVALID,"sys is invalid"));}else i&&i();},createDevice:function createDevice(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e){if(e.sys){var a=this._getSystem(e.sys);a&&a.DM&&a.DM.createDevice?a.DM.createDevice(e,t,i):i&&i(new r(o.INVALID,"no such sys:"+e.sys));}else i&&i(new r(o.INVALID,"sys is invalid"));}else i&&i(new r(o.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e){if(e.sys){var a=this._getSystem(e.sys);a&&a.DM&&a.DM.updateDevice?a.DM.updateDevice(e,t,i):i&&i(new r(o.INVALID,"no such sys:"+e.sys));}else i&&i(new r(o.INVALID,"sys is invalid"));}else i&&i(new r(o.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e){if(e.sys){var a=this._getSystem(e.sys);a&&a.DM&&a.DM.deleteDevice?a.DM.deleteDevice(e,t,i):i&&i(new r(o.INVALID,"no such sys:"+e.sys));}else i&&i(new r(o.INVALID,"sys is invalid"));}else i&&i();},applyUIFilter:function applyUIFilter(e,t){var i=function i(e,t){if("*"==e)return!0;for(var i=!1,r=0;r<e.length;r++)if(e[r]==t){i=!0;break;}return i;},r=function r(e,t){var r,o=[],a=null;if(e.sys){var n=this._getSystem(e.sys);n&&n.DM&&n.DM.getCommandStatusMap&&(r=n.DM.getCommandStatusMap(e));}return r&&(a=function(e,t,r){var o=[];switch(r.catagory){case"command":e.command&&e.command.forEach(function(e){if(i(r.elems,e.type)){var t=JSON.parse(JSON.stringify(e));o.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(i(r.elems,e.type)){var t=JSON.parse(JSON.stringify(e));o.push(t);}});}return o;}(r,0,t),o=o.concat(a)),o;};if(!e.sys)return null;var o=JSON.parse(JSON.stringify(e)),a=null;switch(t.catagory){case"command":a=r.call(this,e,t),o.command=a;break;case"status":a=r.call(this,e,t),o.status=a;break;default:return null;}return a&&0!=a.length?o:null;}},xnm.aio.ir.Handler=function(){var e=function e(){};return e.prototype.devicemanager=xnm.aio.ir.DM,e.prototype.registModule=function(e){for(var t in xnm.aio.ir)if(xnm.aio.ir.hasOwnProperty(t)){var i=xnm.aio.ir[t];i&&i.DM&&i.DM.registModule&&i.DM.registModule(e);}},e.prototype.resolveGateway=function(e){switch(e.sys){case xnm.aio.ir.IRTrans.DM.SYS:return xnm.aio.ir.IRTrans.parseJSON(e);case xnm.aio.ir.RedEye.DM.SYS:return xnm.aio.ir.RedEye.parseJSON(e);case xnm.aio.ir.iTach.DM.SYS:return xnm.aio.ir.iTach.parseJSON(e);default:return null;}},e.prototype.getDeviceCommands=function(e,t){var i=xnm.aio.ir.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),r=i?i.command:[];t&&t(null,r);},e.prototype.searchIRTransWithTimeout=function(e,t){xnm.aio.ir.IRTrans._discovery(e,t);},e.prototype.learnIRTransCode=function(e,t,i){var r=xnm.aio.ir.IRTrans.parseJSON(e);r?r.learnIrCode(t,i):i&&i(new Error("gateway json format invalid"));},e.prototype.doIRTransCommand=function(e,t,i,r){var o=xnm.aio.ir.IRTrans.parseJSON(e);o?o.executeCommandCreator(t,i,r,!0):r&&r(new Error("gateway json format invalid"));},e.prototype.searchRedeyeWithTimeout=function(e,t){xnm.aio.ir.RedEye.discoveryWithTimeout(e,t);},e.prototype.learnRedeyeCode=function(e,t){var i=xnm.aio.ir.RedEye.parseJSON(e);i?i.learnIrCode(t):t&&t(new Error("gateway json format invalid"));},e.prototype.doRedeyeCommand=function(e,t,i,r){var o=xnm.aio.ir.RedEye.parseJSON(e);o?o.executeCommandCreator(t,i,r):r&&r(new Error("gateway json format invalid"));},e.prototype.searchITach=function(e){xnm.aio.ir.iTach.discovery(e);},e.prototype.learnITachCode=function(e,t){var i=xnm.aio.ir.iTach.parseJSON(e);i?i.learnIrCode(!0,t):t&&t(new Error("gateway json format invalid"));},e.prototype.doITachCommand=function(e,t,i,r){var o=xnm.aio.ir.iTach.parseJSON(e);o?o.executeCommandCreator(t,i,r,!0):r&&r(new Error("gateway json format invalid"));},e;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.ir.Handler());