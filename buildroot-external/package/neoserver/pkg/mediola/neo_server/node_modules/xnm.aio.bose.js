var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.bose=xnm.aio.bose||{};
xnm.aio.bose.SoundTouch=function(){var f=function(a){this._logger="undefined"!=typeof require&&require?require("x.logger.js").getLogger("xnm.aio.bose.SoundTouch"):{log:{}};this._renderer=null;this.mac=a?a.mac:null;this.name=a?a.name:null;this.bass=a?a.base:null;this.sources=a?a.sources:null;this.isMaster=!1;this.members=null;a&&a.ip&&a.port&&a.uuid&&(this._renderer=this._getRenderer(a.ip,a.port,a.uuid))};f.PLAY_STATUS=["PLAY_STATE","PAUSE_STATE","STOP_STATE","BUFFERING_STATE","INVALID_PLAY_STATUS"];
f.prototype.getIP=function(){return this._renderer?this._renderer.ip:null};f.prototype.setIP=function(a){this._renderer&&(this._renderer.ip=a)};f.prototype.getPort=function(){return this._renderer?this._renderer.port:null};f.prototype.setPort=function(a){this._renderer&&(this._renderer.port=a)};f.prototype.getUUID=function(){return this._renderer?this._renderer.uuid:null};f.prototype.getName=function(){return this.name?this.name:this._renderer?this._renderer.name:null};f.prototype.getMac=function(){return this.mac?
this.mac:this._renderer?this._renderer.serialNumber:null};f.prototype.getInfos=function(a){var c=4,b={},d=function(e){c--;e?a&&a(e):0==c&&a&&a(null,b)};this._getInfo(function(c,a){a&&(b.name=a.name,b.mac=a.mac);d&&d(c);c&&(d=null)});this._getBassCap(function(c,a){a&&(b.bass=a.bass);d&&d(c);c&&(d=null)});this._getSources(function(c,a){a&&(b.sources=a);d&&d(c);c&&(d=null)});this._getZone(function(c,a){a&&(b.zoneInfo=a);d&&d(c);c&&(d=null)})};f.prototype.getRooms=function(a){var c=this;require("xnm.aio.bose.js").master.getZones(function(b,
d){if(b)a&&a(b);else{for(var e={},g=0;g<d.length;g++){var f=d[g];if(f&&f.masterMac==c.mac){for(g=0;g<f.players.length;g++){var k=f.players[g];k&&k.mac&&k.name&&(e[k.mac]=k.name)}break}}a&&a(null,e)}})};f.prototype.getPlayInfo=function(a){this._getNowPlaying(function(c,b){if(c)a&&a(c);else{var d={trackMetaData:b};d.trackMetaData.albumArtURI=b.art;d.trackMetaData.title=b.track;a&&a(null,d)}})};f.prototype.play=function(a,c,b){if(a&&c&&c["class"]&&c.id)if(this._renderer){var d=this;a.browseMetaData(c.id,
function(e,g){e?b&&b(e):0!=c["class"].indexOf("object.container")||c.res&&c.res.url?c.res&&c.res.url?d._renderer.playResource({url:c.res.url},g.result,b):b&&b(Error("resource url invalid")):a.uuid?d._renderer.playContainer({containerID:c.id,server_uuid:a.uuid},g.result,b):b&&b(Error("media server uuid invalid"))})}else b&&b(Error("renderer not inited"));else b&&b(Error("play obj invalid"))};f.prototype.browser=function(a,c,b,d,e){a?(c||(c=0),b||(b=0),d||(d=0),a.browseChildren(c,b,d,null,function(c,
b,a){e&&e(c,b,a)})):e&&e(Error("play obj invalid"))};f.prototype.executeCommandCreator=function(a,c,b){c&&c.value?this._executeCommand(c.value,c.ext,function(c){b&&b(c)}):b&&b(Error("command value is empty"))};f.prototype.getStatesCreator=function(a,c,b){this._getStates(function(a,e){if(a)b&&b(a);else{for(var g=[],f=0;f<c.length;f++){var k=c[f];if(k&&k.id&&k.status){var l="?";switch(k.status.value){case "power":case "muted":case "volume":case "repeatMode":case "shuffleMode":case "playState":case "durationS":case "positionS":case "bass":l=
e[k.status.value];break;case "artist":case "title":case "album":case "radio":(l=e[k.status.value])||(l="")}if("undefined"==typeof l||null==l)l="?";g.push({id:k.id,status:l})}}b&&b(null,g)}})};f.prototype._executeCommand=function(a,c,b){if(this._renderer){var d=this,e;switch(a){case "play":this._clickKey("PLAY",b);break;case "pause":this._clickKey("PAUSE",b);break;case "tooglePlay":this._clickKey("PLAY_PAUSE",b);break;case "stop":this._clickKey("STOP",b);break;case "previous":this._clickKey("PREV_TRACK",
b);break;case "next":this._clickKey("NEXT_TRACK",b);break;case "togglePower":this._clickKey("POWER",b);break;case "toggleMute":this._clickKey("MUTE",b);break;case "volumeUp":this._clickKey("VOLUME_UP",b);break;case "volumeDown":this._clickKey("VOLUME_DOWN",b);break;case "setVolume":if("undefined"==typeof c||null==c){b&&b(Error("volume value invalid"));break}c=parseInt(c);100<c&&(c=100);0>c&&(c=0);this._setVolume(c,b);break;case "thumbUp":this._clickKey("THUMBS_UP",b);break;case "thumbDown":this._clickKey("THUMBS_DOWN",
b);break;case "bookmark":this._clickKey("BOOKMARK",b);break;case "preset":if(!c){b&&b(Error("preset value invalid"));break}this._clickKey("PRESET_"+c,b);break;case "shuffleOn":this._clickKey("SHUFFLE_ON",b);break;case "shuffleOff":this._clickKey("SHUFFLE_OFF",b);break;case "toggleShuffle":this._getNowPlaying(function(c,a){if(c)b&&b(c);else if(a&&a.shuffleSetting){var e="SHUFFLE_ON";"SHUFFLE_ON"==a.shuffleSetting&&(e="SHUFFLE_OFF");d._clickKey(e,b)}else b&&b(Error("no shuffle setting"))});break;case "setRepeatMode":if(!c){b&&
b(Error("play mode value invalid"));break}this._clickKey(c,b);break;case "addFav":this._clickKey("ADD_FAVORITE",b);break;case "removeFav":this._clickKey("REMOVE_FAVORITE",b);break;case "bassUp":case "bassDown":if("undefined"==typeof c||null==c){b&&b(Error("seek value invalid"));break}this._getBass(function(c,g){if(c)b&&b(c);else if(g&&"undefined"!=typeof g.actualbass&&null!=g.actualbass){var f=g.actualbass;"bassUp"==a?f+=1:--f;if(this.bass&&(e=this.bass.indexOf("-",1),-1!=e)){var h=this.bass.substring(0,
e),m=this.bass.substr(e+1),h=parseInt(h),m=parseInt(m);f<h&&(f=h);f>m&&(f=m)}d._setBass(f,b)}else b&&b(Error("no bass info"))});break;case "setBass":if("undefined"==typeof c||null==c){b&&b(Error("volume value invalid"));break}c=parseInt(c);if(this.bass&&(e=this.bass.indexOf("-",1),-1!=e)){var g=this.bass.substring(0,e),f=this.bass.substr(e+1),g=parseInt(g),f=parseInt(f);c<g&&(c=g);c>f&&(c=f)}this._setBass(c,b);break;default:a&&"select:"==a.substr(0,7)?(g=a.substr(7),e=g.indexOf("@"),c=g.substring(0,
e),g=g.substr(e+1),d._setSource(c,g,b)):b&&b(Error("unknown command"))}}else b&&b(Error("renderer not initialized"))};f.prototype._getStates=function(a){var c=function(){d--;0==d&&a&&a(null,b)},b={},d=3;this._getBass(function(a,d){!a&&d&&(b.bass=d.actualbass);c()});this._getVolume(function(a,d){!a&&d&&(b.volume=d.actualvolume,b.muted=d.muteenabled);c()});this._getNowPlaying(function(a,d){!a&&d&&(b.power="STANDBY"==d.source?"off":"on",d.repeatSetting&&(b.repeatMode=d.repeatSetting),d.shuffleSetting&&
(b.shuffleMode=d.shuffleSetting),d.playStatus&&(b.playState=d.playStatus),d.duration&&(b.durationS=d.duration),d.position&&(b.positionS=d.position),d.position&&(b.positionS=d.position),d.track&&(b.title=d.track),d.stationName&&(b.radio=d.stationName),d.artist&&(b.artist=d.artist),d.album&&(b.album=d.album));c()})};f.prototype._getRenderer=function(a,c,b){var d=new (require("x.upnp.js").MediaRenderer);d.init(a,c,b,{avTransport:{type:"urn:schemas-upnp-org:service:AVTransport:1",url:"/UD/"+b+"?2"},connectionManager:{type:"urn:schemas-upnp-org:service:ConnectionManager:1",
url:"/UD/"+b+"?1"},renderingControl:{type:"urn:schemas-upnp-org:service:RenderingControl:1",url:"/UD/"+b+"?0"}});return d};f.prototype._clickKey=function(a,c){var b=this;this._pressKey(a,function(d){d?c&&c(d):b._releaseKey(a,function(a){c&&c(a)})})};f.prototype._getInfo=function(a){var c=this;this._sendRequest("GET","/info",null,function(b,d){if(b)a&&a(b);else{var e=d.find("info");e&&e[0]?(e=$(e[0]),c.mac=e.attr("deviceID"),(e=e.find("name"))&&e[0]&&(c.name=$(e[0]).text()),a&&a(null,{name:c.name,
mac:c.mac})):a&&a(Error("get info xml invalid"))}})};f.prototype._pressKey=function(a,c){this._sendRequest("POST","/key",'<key state="press" sender="Gabbo">'+a+"</key>",c)};f.prototype._releaseKey=function(a,c){this._sendRequest("POST","/key",'<key state="release" sender="Gabbo">'+a+"</key>",c)};f.prototype._getSources=function(a){var c=this;this._sendRequest("GET","/sources",null,function(b,d){if(b)a&&a(b);else{var e=[];d.find("sourceItem").each(function(){var a=$(this);e.push({source:a.attr("source"),
sourceAccount:a.attr("sourceAccount")?a.attr("sourceAccount"):null,isLocal:a.attr("isLocal"),name:a.text()?a.text():null})});c.sources=e;a&&a(null,e)}})};f.prototype._setSource=function(a,c,b){a='<ContentItem source="'+a+'"';c&&(a+=' sourceAccount="'+c+'"');this._sendRequest("POST","/select",a+"></ContentItem>",b)};f.prototype._setBass=function(a,c){this._sendRequest("POST","/bass","<bass>"+a+"</bass>",c)};f.prototype._getBass=function(a){this._sendRequest("GET","/bass",null,function(c,b){if(c)a&&
a(c);else{var d={},e=b.find("targetbass");e&&e[0]&&(d.targetbass=parseInt($(e[0]).text()));(e=b.find("actualbass"))&&e[0]&&(d.actualbass=parseInt($(e[0]).text()));a&&a(c,d)}})};f.prototype._getBassCap=function(a){var c=this;this._sendRequest("GET","/bassCapabilities",null,function(b,d){if(b)a&&a(b);else{var e=d.find("bassAvailable");if(e&&e[0])if((e=$(e[0]).text())&&"false"!=e.toLowerCase()){var e=0,f=d.find("bassMin");f&&f[0]&&(e=$(f[0]).text());var f=100,h=d.find("bassMax");h&&h[0]&&(f=$(h[0]).text());
c.bass=e+"-"+f;a&&a(null,{bass:c.bass})}else a&&a(null,null);else a&&a(Error("get bass cap xml invalid"))}})};f.prototype._getZone=function(a){var c=this;this._sendRequest("GET","/getZone",null,function(b,d){if(b)a&&a(b);else{var e={isMaster:!1},f=d.find("zone");if(f&&f[0]){var h=$(f[0]).attr("master");if(!h){e.isMaster=!0;e.master=c.getMac();e.members={};e.members[c.getMac()]=c.getIP();c.isMaster=!0;c.members=e.members;a&&a(null,e);return}e.master=h;h==c.getMac()&&(e.isMaster=!0)}$(f[0]).find("member").each(function(){var a=
$(this),c=a.attr("ipaddress"),a=a.text();c&&a&&(e.members||(e.members={}),e.members[a]=c)});c.isMaster=e.isMaster;c.members=e.members;a&&a(null,e)}})};f.prototype._setZone=function(a,c,b){a='<zone master="'+a+'" senderIPAddress="0.0.0.0">';for(var d in c)c.hasOwnProperty(d)&&c[d]&&(a+='<member ipaddress="'+c[d]+'">'+d+"</member>");this._sendRequest("POST","/setZone",a+"</zone>",b)};f.prototype._getVolume=function(a){this._sendRequest("GET","/volume",null,function(c,b){if(c)a&&a(c);else{var d={},e=
b.find("targetvolume");e&&e[0]&&(d.targetvolume=parseInt($(e[0]).text()));(e=b.find("actualvolume"))&&e[0]&&(d.actualvolume=parseInt($(e[0]).text()));(e=b.find("muteenabled"))&&e[0]&&(d.muteenabled=$(e[0]).text());a&&a(c,d)}})};f.prototype._setVolume=function(a,c){this._sendRequest("POST","/volume","<volume>"+a+"</volume>",c)};f.prototype._getNowPlaying=function(a){this._sendRequest("GET","/now_playing",null,function(c,b){if(c)a&&a(c);else{var d={},e=b.find("nowPlaying");if(e&&e[0])var f=$(e[0]).getAttributes(),
d=JSON.parse(JSON.stringify(f));(e=b.find("ContentItem"))&&e[0]&&(f=$(e[0]).getAttributes(),d.content=JSON.parse(JSON.stringify(f)),(e=$(e[0]).find("itemName"))&&e[0]&&(d.content.itemName=$(e[0]).text()));(e=b.find("track"))&&e[0]&&(d.track=$(e[0]).text());(e=b.find("artist"))&&e[0]&&(d.artist=$(e[0]).text());(e=b.find("album"))&&e[0]&&(d.album=$(e[0]).text());(e=b.find("stationName"))&&e[0]&&(d.stationName=$(e[0]).text());(e=b.find("art"))&&e[0]&&(d.artImageStatus=$(e[0]).attr("artImageStatus"),
d.art=$(e[0]).text());(e=b.find("playStatus"))&&e[0]&&(d.playStatus=$(e[0]).text());(e=b.find("description"))&&e[0]&&(d.description=$(e[0]).text());(e=b.find("stationLocation"))&&e[0]&&(d.description=$(e[0]).text());(e=b.find("time"))&&e[0]&&(d.duration=$(e[0]).attr("total"),d.position=$(e[0]).text());(e=b.find("shuffleSetting"))&&e[0]&&(d.shuffleSetting=$(e[0]).text());(e=b.find("repeatSetting"))&&e[0]&&(d.repeatSetting=$(e[0]).text());a&&a(null,d)}})};f.prototype._sendRequest=function(a,c,b,d){this._doRequest(this.getIP(),
8090,a,c,b,function(a,c){if(a)d&&d(a);else try{var b=$($.parseXML(c)),f=b.find("error");if(f&&f[0]){var l=$(f[0]),t=l.text(),n=l.attr("name");d&&d(Error(t+":"+n))}else d&&d(null,b)}catch(m){d&&d(m)}})};f.prototype._doRequest=function(a,c,b,d,e,f){var h=this;a="http://"+a+":"+c+d;this._logger.log("trace","send "+b+" to url:"+a);e&&this._logger.log("trace","with data "+e);var k=f;f={url:a,type:b,timeout:2E3,contentType:"text/xml",dataType:"text",cache:!0,success:function(a){h._logger.log("trace","http request success:"+
a);k&&(k(null,a),k=null)},error:function(a,c){var b="http request error:"+(a?a.status:"0")+"-"+c;h._logger.log("trace",b);k&&(k(Error(b)),k=null)}};"post"==b.toLowerCase()&&e&&(f.data=e);$.ajax(f)};f.prototype.toJSON=function(){return{sys:"bose",ip:this.getIP(),port:this.getPort(),uuid:this.getUUID(),type:"SoundTouch",model:this._renderer?this._renderer.modelName:null,mac:this.getMac(),bass:this.bass,sources:this.sources,name:this.getName()}};f.prototype.equalsTo=function(a){return a&&a instanceof
f?this.getIP()==a.getIP()&&this.getPort()==a.getPort():!1};return f}();
xnm.aio.bose.Master=function(){var f=function(){"undefined"!=typeof require&&require?(this._logger=require("x.logger.js").getLogger("xnm.aio.bose.Master"),require("x.logger.js").setLevel("trace","xnm.aio.bose.Master")):this._logger={log:{}};this._mediaServer={};this._soundTouchs={};this._currentZone=null;var a=this;this._discovery=new xnm.aio.bose.Discovery;this._discoveryListener=function(c,b){c&&b&&("mediaServer"==c?a._mediaServer[b.uuid]=b:"soundTouch"==c&&a._onFindSoundTouch(b))};this._discovery.addListener(this._discoveryListener);
this._discoveryCB=[];this._autoSearchTO=null;this.searchSoundTouch()};f.prototype._onFindSoundTouch=function(a){var c=a.getUUID();this._soundTouchs[c]?(c=this._soundTouchs[c],c.dummy=!1,c.player.setIP(a.getIP()),c.player.setPort(a.getPort()),c.player.isMaster=a.isMaster,c.player.members=a.members):this._soundTouchs[c]={missCount:0,dummy:!1,player:a};this._currentZone?a.getMac()!=this._currentZone||a.isMaster||this.setCurrentZone():a.isMaster&&(this._currentZone=a.getMac())};f.prototype.searchSoundTouch=
function(a){var c=this._discoveryCB.length;a||(a=function(){});a&&-1==this._discoveryCB.indexOf(a)&&this._discoveryCB.push(a);if(0==c){this._autoSearchTO&&(clearTimeout(this._autoSearchTO),this._autoSearchTO=null);this._search();var b=this;setTimeout(function(){b._autoSearchTO=setTimeout(function(){b.searchSoundTouch(null)},3E4);var a=b._discoveryCB;b._discoveryCB=[];a.forEach(function(a){a(null,b._getFoundSoundTouchs())})},5E3)}};f.prototype._search=function(){for(var a in this._soundTouchs)if(this._soundTouchs.hasOwnProperty(a)){var c=
this._soundTouchs[a];5<=c.missCount?delete this._soundTouchs[a]:c.missCount++}this._discovery.searchSoundTouch()};f.prototype.getCurrentZone=function(a){var c=this,b=this._getFoundSoundTouchs();if(b&&0!=b.length)if(this._currentZone){var d=this._findPlayerWithMac(this._currentZone);if(d){var b=d.members,d={masterPlayer:d,masterMac:this._currentZone,players:[]},e;for(e in b)if(b.hasOwnProperty(e)){var f=this._findPlayerWithMac(e);f&&d.players.push(f)}a&&a(null,d)}else a&&a(Error("no player with mac:"+
this._currentZone))}else this.setCurrentZone(null,function(b){b?a&&a(b):c.getCurrentZone(a)});else this.searchSoundTouch(function(b,d){b?a&&a(b):d&&0!=d.length?c.getCurrentZone(a):a&&a(Error("find no sound touch player"))})};f.prototype._findPlayerWithMac=function(a){for(var c in this._soundTouchs)if(this._soundTouchs.hasOwnProperty(c)){var b=this._soundTouchs[c];if(b&&b.player&&b.player.getMac()==a)return b.player}return null};f.prototype.setCurrentZone=function(a,c){var b=null;if(a)(b=this._findPlayerWithMac(a))&&
!b.isMaster&&(b=null);else for(var d in this._soundTouchs)if(this._soundTouchs.hasOwnProperty(d)){var e=this._soundTouchs[d];if(e&&e.player&&e.player.isMaster){b=e.player;break}}b?(this._currentZone=b.getMac(),c&&c()):c&&c(Error("no such master"))};f.prototype.getZones=function(a){var c=this,b=this._getFoundSoundTouchs();if(b&&0!=b.length)for(var d=0,e={},f=function(f,g){d++;!f&&g&&g.isMaster&&g.master&&g.members&&(e[g.master]=g.members);if(d==b.length){var h=[],n;for(n in e)if(e.hasOwnProperty(n)){var m=
{masterMac:n,players:[]},r=e[n],p;for(p in r)if(r.hasOwnProperty(p)){var q=c._findPlayerWithMac(p);q&&-1==m.players.indexOf(q)&&m.players.push(q)}h.push(m)}a&&a(null,h)}},h=0;h<b.length;h++)b[h]._getZone(f);else this.searchSoundTouch(function(b,d){b?a&&a(b):d&&0!=d.length?c.getZones(a):a&&a(Error("find no sound touch player"))})};f.prototype.createZone=function(a,c){if(a&&0!=a.length){var b={},d=a[0],e=d.getMac();if(1<a.length)for(var f=0;f<a.length;f++){var h=a[f];b[h.getMac()]=h.getIP()}var k=this;
d._setZone(e,b,function(a){a?c&&c(a):k.getZones(function(a){c&&c(a)})})}else c&&c()};f.prototype._getFoundSoundTouchs=function(){var a=[],c;for(c in this._soundTouchs)if(this._soundTouchs.hasOwnProperty(c)){var b=this._soundTouchs[c];b&&!b.dummy&&b.player&&a.push(b.player)}return a};f.prototype.getSoundTouch=function(a){if(!a.uuid)return null;if("master"==a.uuid)return this;var c=this._soundTouchs[a.uuid];if(c&&c.player)return c.player;c=new xnm.aio.bose.SoundTouch(a);this._soundTouchs[a.uuid]={missCount:0,
dummy:!0,player:c};return c};f.prototype.executeCommandCreator=function(a,c,b){if(this._currentZone){var d=this._findPlayerWithMac(this._currentZone);d?d.executeCommandCreator(a,c,b):b&&b(Error("current zone not found"))}else b&&b(Error("current zone not set"))};f.prototype.getStatesCreator=function(a,c,b){if(this._currentZone){var d=this._findPlayerWithMac(this._currentZone);d?d.getStatesCreator(a,c,b):b&&b(Error("current zone not found"))}else b&&b(Error("current zone not set"))};f.prototype.toJSON=
function(){return{sys:"bose",ip:"xxxxxxx",port:0,uuid:"master",type:"master"}};return f}();
xnm.aio.bose.Discovery=function(){var f=function(a){a._setAVTransportURI=function(a,c,e,f){a="<InstanceID>"+a+"</InstanceID><CurrentURI>"+this._maskMetaData('<TrackInfo index="0" byteOffsetIntoTrack="0" timeOffsetIntoTrack="0" url="'+this._maskMetaData(c)+'" trackData="" sourceId="0" />')+"</CurrentURI><CurrentURIMetaData>"+(e?this._maskMetaData(e):"")+"</CurrentURIMetaData>";this._doSOAPBodyRequest(this.getURL(this.avTransport.url),this.avTransport.type,"SetAVTransportURI",a,f)};a._doSOAPBodyRequest=
function(a,c,e,f,h){f="<u:"+e+' xmlns:u="'+c+'">'+f;f+="</u:"+e+">";var k=this;this._doRequest(a,'"'+c+"#"+e+'"',f,function(a,c){if(a)h&&h(a);else{var b=k._parseSOAPResponse(c,e+"Response");b?h&&h(null,b):h&&h(Error(e+" reponse format invalid"))}})};return a},a=function(){"undefined"!=typeof require&&require?(this._logger=require("x.logger.js").getLogger("xnm.aio.bose.Discovery"),require("x.logger.js").setLevel("info","xnm.aio.bose.Discovery")):this._logger={log:{}};this._upnpCB=null;this._searchCB=
[];this._searching=!1};a.prototype.addListener=function(a){a&&-1==this._searchCB.indexOf(a)&&this._searchCB.push(a)};a.prototype.removeListener=function(a){a&&(a=this._searchCB.indexOf(a),-1!=a&&this._searchCB.splice(a,1))};a.prototype.searchSoundTouch=function(){if(!this._searching){this._searching=!0;this._search();var a=this;setTimeout(function(){a._searching=!1},5E3)}};a.prototype._search=function(){if(!this._upnpCB){var a=this;this._upnpCB=function(b){a._findUpnpDevice(b)}}var b=require("x.upnp.js").getDiscoveryService();
b.addCallback("upnp:rootdevice",this._upnpCB);b.discoverTarget("upnp:rootdevice")};a.prototype._findUpnpDevice=function(a){if(a){var b=this;switch(a.deviceType){case "urn:schemas-upnp-org:device:MediaServer:1":this._logger.log("trace","find media server:"+a.name+" @"+a.ip);this._searchCB.forEach(function(b){b&&b("mediaServer",a)});break;case "urn:schemas-upnp-org:device:MediaRenderer:1":if(a.modelName&&-1!=a.modelName.indexOf("SoundTouch")){this._logger.log("trace","find SoundTouch:"+a.name+" @"+
a.ip);a=f(a);var d=new xnm.aio.bose.SoundTouch;d._renderer=a;d.getInfos(function(a){a||b._searchCB.forEach(function(a){a&&a("soundTouch",d)})})}}}};return a}();
xnm.aio.bose.DM=function(){var f={command:[{type:"enum",name:"play",ref:{value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"play/pause",ref:{value:"tooglePlay"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}},{type:"enum",name:"toggle power",ref:{value:"togglePower"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},
{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume",ref:{value:"setVolume",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"thumb up",ref:{value:"thumbUp"}},{type:"enum",name:"thumb down",ref:{value:"thumbDown"}},{type:"enum",name:"bookmark",ref:{value:"bookmark"}},{type:"enum",name:"preset",ref:{value:"preset",ext:"%e",extMeta:"123456".split("")}},{type:"enum",name:"shuffle on",ref:{value:"shuffleOn"}},{type:"enum",name:"shuffle off",ref:{value:"shuffleOff"}},{type:"enum",
name:"toggle shuffle",ref:{value:"toggleShuffle"}},{type:"enum",name:"set repeat mode",ref:{value:"setRepeatMode",ext:"%e",extMeta:["REPEAT_OFF","REPEAT_ONE","REPEAT_ALL"]}},{type:"enum",name:"add to favorite",ref:{value:"addFav"}},{type:"enum",name:"remove from favorite",ref:{value:"removeFav"}}],status:[{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"muted",ref:{value:"muted",options:["true","false"]}},{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-100"}},
{type:"enum",name:"repeat mode",ref:{value:"repeatMode",options:["REPEAT_OFF","REPEAT_ONE","REPEAT_ALL"]}},{type:"enum",name:"shuffle mode",ref:{value:"shuffleMode",options:["SHUFFLE_ON","SHUFFLE_OFF"]}},{type:"string",name:"play state",ref:{value:"playState",options:["PLAY_STATE","PAUSE_STATE","STOP_STATE","BUFFERING_STATE","INVALID_PLAY_STATUS"]}},{type:"int",name:"track duration (seconds)",ref:{value:"durationS"}},{type:"int",name:"track position (seconds)",ref:{value:"positionS"}},{type:"string",
name:"radio station",ref:{value:"radio"}},{type:"string",name:"artist",ref:{value:"artist"}},{type:"string",name:"title",ref:{value:"title"}},{type:"string",name:"album",ref:{value:"album"}}]},a=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};a.prototype=Error();a.prototype.name="RaumfeldDMError";a.prototype.code=0;a.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"bose",getIPDeviceType:function(){return[{sys:this.SYS,name:"Bose SoundTouch"}]},
createDevice:function(c,b,d){b=a.ERROR_CODE;c?c.type?c.ip?c.port?c.uuid?d(null,c):d(new a(b.INVALID,"uuid is invalid")):d(new a(b.INVALID,"port is invalid")):d(new a(b.INVALID,"ip is invalid")):d(new a(b.INVALID,"type is invalid")):d(new a(b.INVALID,"info is invalid"))},updateDevice:function(c,b,d){b=a.ERROR_CODE;c?c.type?c.ip?c.port?c.uuid?d(null,c):d(new a(b.INVALID,"uuid is invalid")):d(new a(b.INVALID,"port is invalid")):d(new a(b.INVALID,"ip is invalid")):d(new a(b.INVALID,"type is invalid")):
d(new a(b.INVALID,"info is invalid"))},deleteDevice:function(a,b,d){d()},applyUIFilter:function(a,b,d){var e=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},f=function(a,b,c){var d=[];switch(c.catagory){case "command":a.command&&a.command.forEach(function(a){e(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))});break;case "status":a.status&&a.status.forEach(function(a){e(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))})}return d},
h=function(a,b){var c=[],e=null;if(e=xnm.aio.bose.DM.getCommandStatusMap(a,d))e=f(e,a,b),c=c.concat(e);return c};if(!a.sys)return null;var k=JSON.parse(JSON.stringify(a)),l=null;switch(b.catagory){case "command":l=h(a,b);k.command=l;break;case "status":l=h(a,b);k.status=l;break;default:return null}return l&&0!=l.length?k:null},getCommandStatusMap:function(a,b){var d=JSON.parse(JSON.stringify(f));a&&a.bass&&(d.command.push({type:"enum",name:"bass up",ref:{value:"bassUp"}}),d.command.push({type:"enum",
name:"bass down",ref:{value:"bassDown"}}),d.command.push({type:"int",name:"set bass",ref:{value:"setBass",ext:"%d",extMeta:a.bass}}),d.status.push({type:"int",name:"bass",ref:{value:"bass",extMeta:a.bass}}));a&&a.sources&&a.sources.forEach(function(a){if(a&&"true"==a.isLocal){var b=a.source;a.name&&(b=a.name);var c=a.sourceAccount?a.sourceAccount:"";a.source&&d.command.push({type:"enum",name:"select "+b,ref:{value:"select:"+a.source+"@"+c}})}});return d}}}();
xnm.aio.bose.Handler=function(){var f=function(){this.master=new xnm.aio.bose.Master};f.prototype.devicemanager=xnm.aio.bose.DM;f.prototype.SoundTouch=xnm.aio.bose.SoundTouch;f.prototype.registModule=function(a){a.register(xnm.aio.bose.DM.SYS,"bose")};f.prototype.resolveDevice=function(a){return a?this.master.getSoundTouch(a):null};f.prototype.getDeviceCommands=function(a,c){var b=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}),b=b?b.command:[];c&&c(null,b)};f.prototype.getDeviceStatus=
function(a,c){var b=this.devicemanager.applyUIFilter(a,{catagory:"status",elems:"*"}),b=b?b.status:[];c&&c(null,b)};f.prototype.doCommand=function(a,c,b){var d=this.resolveDevice(a);d?d.executeCommandCreator(a,c,function(a){b&&b(a)}):b&&b(Error("device json format invalid"))};f.prototype.doStatus=function(a,c,b,d){var e=this.resolveDevice(c);e?e.getStatesCreator(null,[{id:a,device:c,status:b}],function(a,b){a?d&&d(a):d&&d(null,b[0])}):d&&d(Error("device json format invalid"))};f.prototype.discover=
function(a){var c=this;this.master.searchSoundTouch(function(b,d){!b&&d&&d.push(c.master);a&&a(b,d)})};f.prototype.getPlayer=function(a,c){if(a&&a.uuid)if("master"==a.uuid)c&&c(null,this.master);else{var b=this.master.getSoundTouch(a);if(b)c&&c(null,b);else{var d=this;this.master.searchSoundTouch(function(){b=d.master.getSoundTouch(a);c&&c(null,b)})}}else c&&c(Error("device json invalid"))};return f}();
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.bose.Handler);
