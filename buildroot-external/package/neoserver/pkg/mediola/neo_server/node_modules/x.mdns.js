var x=x||{};x.mdns=x.mdns||{};
x.mdns.DNS_SD=function(){var n=function(){this.data=this.length=this.ttl=this.class=this.type=this.name=null};n.prototype.resolveData=function(a){this.data=a};n.prototype.toJSON=function(){return this};var r=function(){this._info={}};r.prototype.resolveData=function(a,b,d,g){for(b=0;b<a.length-1;){d=2*parseInt(a.substr(b,2),16);var c;if(c=b+2+d>a.length?a.substr(b+2,a.length-b-2):a.substr(b+2,d)){c=f._hex2a(c);var e=c.indexOf("=");-1!=e&&e!=c.length-1&&(g=c.substr(0,e),c=c.substr(e+1),this._info[g]=
c)}b+=2+d}};r.prototype.toJSON=function(){};var l=function(){};l.prototype.resolveData=function(a,b,d,g){this.domain=f._parseName(b,d,g).name};l.prototype.getNameTxt=function(){return this.name?f._hex2name(this.name):null};l.prototype.getDomainTxt=function(){return this.domain?f._hex2name(this.domain):null};l.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,class:this.class,ttl:this.ttl,length:this.length,domain:this.getDomainTxt()}};var e=function(){};e.prototype.resolveData=
function(a,b,d,g){this.priority=parseInt(a.substr(0,4),16);this.weight=parseInt(a.substr(4,4),16);this.port=parseInt(a.substr(8,4),16);this.target=f._parseName(b+12,d,g).name};e.prototype.getNameTxt=function(){return this.name?f._hex2name(this.name):null};e.prototype.getTargetTxt=function(){return this.target?f._hex2name(this.target):null};e.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,class:this.class,ttl:this.ttl,length:this.length,priority:this.priority,weight:this.weight,
port:this.port,target:this.getTargetTxt()}};var h=function(){};h.prototype.resolveData=function(a){this.addr=a};h.prototype.getNameTxt=function(){return this.name?f._hex2name(this.name):null};h.prototype.getAddrTxt=function(){return h._hex2ipv4(this.addr)};h.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,class:this.class,ttl:this.ttl,length:this.length,addr:this.getAddrTxt()}};h._hex2ipv4=function(a){if(!a||8>a.length)return null;var b=""+(parseInt(a.substr(0,2),16)+".");
b+=parseInt(a.substr(2,2),16)+".";b+=parseInt(a.substr(4,2),16)+".";return b+=parseInt(a.substr(6,2),16)};var c=function(){};c.prototype.resolveData=function(a){this.addr=a};c.prototype.getNameTxt=function(){return this.name?f._hex2name(this.name):null};c.prototype.getAddrTxt=function(){if(!this.addr||32>this.addr.length)return null;var a=""+(this.addr.substr(0,4)+":");a+=this.addr.substr(4,4)+":";a+=this.addr.substr(8,4)+":";a+=this.addr.substr(12,4)+":";a+=this.addr.substr(16,4)+":";a+=this.addr.substr(20,
4)+":";a+=this.addr.substr(24,4)+":";return a+=this.addr.substr(28,4)};c.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,class:this.class,ttl:this.ttl,length:this.length,addr:this.getAddrTxt()}};var k=function(a,b){this.name=a;this.type=b};k.prototype._name2Array=function(){if(!this.name)return null;for(var a=[],b=0;b<this.name.length-1;b+=2){var d=this.name.substr(b,2);a.push(parseInt(d,16))}return a};k.prototype.toArray=function(){var a=[];a.push(0);a.push(0);a.push(0);
a.push(0);a.push(0);a.push(1);a.push(0);a.push(0);a.push(0);a.push(0);a.push(0);a.push(0);var b=this._name2Array(this.name);if(!b)return null;for(var d=0;d<b.length;d++)a.push(b[d]);a.push(0);switch(this.type){case 12:a.push(0);a.push(12);break;case 33:a.push(0);a.push(33);break;case 1:a.push(0);a.push(1);break;default:return null}a.push(0);a.push(1);return a};var f=function(){this.arCount=this.nsCount=this.anCount=this.qdCount=this.flag=this.id=0;this.querys=[];this.answers=[];this.authorities=[];
this.additionals=[]};f.prototype.isResponse=function(){return 1==this.flag>>15};f.prototype.toJSON=function(){var a={id:this.id,flag:this.flag,qdCount:this.qdCount,anCount:this.anCount,nsCount:this.nsCount,arCount:this.arCount,querys:[],answers:[],authorities:[],additionals:[]},b;for(b=0;b<this.querys.length;b++)a.querys.push(this.querys[b].toJSON());for(b=0;b<this.answers.length;b++)a.answers.push(this.answers[b].toJSON());for(b=0;b<this.additionals.length;b++)a.additionals.push(this.additionals[b].toJSON());
return a};f.parse=function(a){var b=new f;4<a.length&&(b.id=parseInt(a.substr(0,4),16));8<a.length&&(b.flag=parseInt(a.substr(4,4),16));12<a.length&&(b.qdCount=parseInt(a.substr(8,4),16));16<a.length&&(b.anCount=parseInt(a.substr(12,4),16));20<a.length&&(b.nsCount=parseInt(a.substr(16,4),16));24<a.length&&(b.arCount=parseInt(a.substr(20,4),16));var d=24,g;if(0<b.qdCount)for(g=0;g<b.qdCount;g++){var c=f._parseQuery(d,a);d=c.queryEnd;b.querys.push(c.query)}if(0<b.anCount)for(g=0;g<b.anCount;g++)c=f._parseAnswer(d,
a),d=c.answerEnd,b.answers.push(c.answer);if(0<b.nsCount)for(g=0;g<b.arCount;g++)c=f._parseAuthority(d,a),d=c.nsEnd,b.authorities.push(c.ns);if(0<b.arCount)for(g=0;g<b.arCount;g++)c=f._parseAdditional(d,a),d=c.addiEnd,b.additionals.push(c.addi);return b};f._parseName=function(a,b,d){for(var g=a,c=!1,e;d.length>g+2&&"00"!=d.substr(g,2)&&!(b&&g-a>=2*b);)if(1==parseInt(d.substr(g,2),16)>>7){e=parseInt(d.substr(g,4),16)&16383;e=f._parseName(2*e,null,d).name;c=!0;g+=4;break}else{var h=parseInt(d.substr(g,
2),16);g+=2+2*h}c?(a=d.substr(a,g-a-4),a+=e):(a=d.substr(a,g-a),g+=2);return{index:g,name:a}};f._name2hex=function(a){var b="";a=a.split(".");for(var d=0;d<a.length;d++){for(var g=a[d].length.toString(16);2>g.length;)g="0"+g;b+=g;for(g=0;g<a[d].length;g++){for(var c=a[d].charCodeAt(g).toString(16);2>c.length;)c="0"+c;b+=c}}return b};f._hex2name=function(a){for(var b="",d=0;d<a.length;){var g=parseInt(a.substr(d,2),16),c=a.substr(d+2,2*g);c=f._hex2a(c);b&&(b+=".");b+=c;d+=2+2*g}return b};f._hex2a=
function(a){a=a.toString();for(var b="",d=0;d<a.length;d+=2)b+=String.fromCharCode(parseInt(a.substr(d,2),16));return b};f._parseRR=function(a,b){var d=f._parseName(a,null,b);var g=a=d.index;d=d.name;if(b.length>a+4){g=a+4;var k=parseInt(b.substr(a,4),16)}if(b.length>a+4+4){g=a+8;var q=parseInt(b.substr(a+4,4),16)}if(b.length>a+8+8){g=a+16;var w=parseInt(b.substr(a+8,8),16)}if(b.length>a+16+4){g=a+20;var p=parseInt(b.substr(a+16,4),16)}if(0<p&&b.length>=a+20+2*p){g=a+20+2*p;var v=b.substr(a+20,2*
p)}switch(k){case 12:var m=new l;break;case 16:m=new r;break;case 33:m=new e;break;case 1:m=new h;break;case 28:m=new c;break;default:m=new n}m&&(m.name=d,m.type=k,m.class=q,m.ttl=w,m.length=p,(m.dataRaw=v)&&m.resolveData(v,a+20,p,b));return{end:g,rr:m}};f._parseQuery=function(a,b){var d=new k;a=f._parseName(a,null,b);var g=a.index;d.name=a.name;b.length>g+4&&(d.type=parseInt(b.substr(g,4),16));b.length>=g+4+4&&(d.class=parseInt(b.substr(g+4,4),16));return{queryEnd:g+8,query:d}};f._parseAnswer=function(a,
b){a=f._parseRR(a,b);return{answerEnd:a.end,answer:a.rr}};f._parseAuthority=function(a,b){a=f._parseRR(a,b);return{nsEnd:a.end,ns:a.rr}};f._parseAdditional=function(a,b){a=f._parseRR(a,b);return{addiEnd:a.end,addi:a.rr}};var q=function(){this._sockets=[];this._searchCallbacks={};this._rrBuffer={_txtRecords:{},_ptrRecords:{},_srvRecords:{},_aRecords:{},_aaaaRecords:{}}};q.prototype.startListener=function(a){function b(a,b,c){var g=this,d=c;c=require("dgram");try{var f=c.createSocket({type:"udp4",reuseAddr:!0})}catch(z){f=
c.createSocket("udp4")}f.on("message",function(a,b){g._onReceiveDNSPacket(a,b)});f.on("listening",function(){f.setBroadcast(!0);f.addMembership("224.0.0.251");d&&(d(null,f),d=null)});f.on("error",function(a){d&&(d(a),d=null)});f.bind(a,b)}var d=function(a,b){var c=this,d=b;b=require("dgram");try{var g=b.createSocket({type:"udp4",reuseAddr:!0})}catch(y){g=b.createSocket("udp4")}g.on("message",function(a,b){c._onReceiveDNSPacket(a,b)});g.on("listening",function(){g.setBroadcast(!0);for(var b=0;b<a.length;b++)g.addMembership("224.0.0.251",
a[b]);d&&(d(null,g),d=null)});g.on("error",function(a){d&&(d(a),d=null)});g.bind(5353)},g=this,c=require("os");if(c&&c.networkInterfaces){c=c.networkInterfaces();var f=[],e;for(e in c)if(c.hasOwnProperty(e))for(var h=c[e],k=0;k<h.length;k++)"IPv4"==h[k].family&&0==h[k].internal&&f.push(h[k].address);d.call(this,f,function(d,c){if(d)a&&a(d);else{c&&g._sockets.push(c);var e=0;for(d=0;d<f.length;d++)b.call(g,5353,f[d],function(b,d){e++;!b&&d&&(d._isSendSocket=!0,g._sockets.push(d));e==f.length&&a&&a()})}})}else b.call(this,
5353,null,function(b,d){b?a&&a(b):(d&&(d._isSendSocket=!0,g._sockets.push(d)),a&&a())})};q.prototype.stopListener=function(a){if(this._sockets)for(var b=0;b<this._sockets.length;b++){var d=this._sockets[b];d&&d.close()}a&&a()};q.prototype.removeDiscoverServiceCallback=function(a,b){if(a&&b&&(a=this._searchCallbacks[a])){for(var d=-1,c=0;c<a.length;c++)if(a[c]===b){d=c;break}-1!=d&&a.splice(d,1)}};q.prototype.clearRecordBuffer=function(){this._rrBuffer={_txtRecords:{},_ptrRecords:{},_srvRecords:{},
_aRecords:{},_aaaaRecords:{}}};q.prototype.discoverService=function(a,b){if(a){var d=this._searchCallbacks[a];d||(this._searchCallbacks[a]=[],d=this._searchCallbacks[a]);b&&-1==d.indexOf(b)&&d.push(b);b._targets=[];b._domains=[];a=f._name2hex(a);(a=(new k(a,12)).toArray())&&this._sendQuery(new Buffer(a))}else b&&b(Error("serviceType is empty"))};q.prototype._sendQuery=function(a){for(var b=0;b<this._sockets.length;b++){var d=this._sockets[b];d._isSendSocket&&d.send(a,0,a.length,5353,"224.0.0.251")}};
q.prototype._searchRecords=function(){var a;for(a in this._searchCallbacks)if(this._searchCallbacks.hasOwnProperty(a)){var b=f._name2hex(a);if(this._rrBuffer._ptrRecords[b])for(var d=0;d<this._rrBuffer._ptrRecords[b].length;d++){var c=this._rrBuffer._ptrRecords[b][d],e=this._rrBuffer._txtRecords[c];if(this._rrBuffer._srvRecords[c])for(var q=0;q<this._rrBuffer._srvRecords[c].length;q++){var l=this._rrBuffer._srvRecords[c][q];if(!this._rrBuffer._aRecords[l]){var p=new k(l,1);(p=p.toArray())&&this._sendQuery(new Buffer(p))}else if(0<
this._rrBuffer._aRecords[l].length){p=[];for(var n=0;n<this._rrBuffer._aRecords[l].length;n++){var m=h._hex2ipv4(this._rrBuffer._aRecords[l][n]);m&&p.push(m)}if(0<p.length&&(n=this._searchCallbacks[a])){l=f._hex2name(l);m=f._hex2name(c);for(var r=0;r<n.length;r++){var t=n[r];if(t){var u=t._domains;u||(t._domains=[],u=t._domains);-1==u.indexOf(m)&&(t._domains.push(m),t(null,{target:l,domain:m,ip:p,info:e}))}}}}}else p=new k(c,33),(p=p.toArray())&&this._sendQuery(new Buffer(p))}}};q.prototype._handleRR=
function(a){switch(a.type){case 12:var b=a.name;var d=a.domain;var c=this._rrBuffer._ptrRecords[b];c||(this._rrBuffer._ptrRecords[b]=[],c=this._rrBuffer._ptrRecords[b]);b=!1;for(a=0;a<c.length;a++)if(c[a]==d){b=!0;break}b||c.push(d);break;case 16:b=a.name;this._rrBuffer._txtRecords[b]=a._info;break;case 33:b=a.name;d=a.target;c=this._rrBuffer._srvRecords[b];c||(this._rrBuffer._srvRecords[b]=[],c=this._rrBuffer._srvRecords[b]);b=!1;for(a=0;a<c.length;a++)if(c[a]==d){b=!0;break}b||c.push(d);break;case 1:b=
a.name;d=a.addr;c=this._rrBuffer._aRecords[b];c||(this._rrBuffer._aRecords[b]=[],c=this._rrBuffer._aRecords[b]);b=!1;for(a=0;a<c.length;a++)if(c[a]==d){b=!0;break}b||c.push(d);break;case 28:b=a.name;d=a.addr;c=this._rrBuffer._aaaaRecords[b];c||(this._rrBuffer._aaaaRecords[b]=[],c=this._rrBuffer._aaaaRecords[b]);b=!1;for(a=0;a<c.length;a++)if(c[a]==d){b=!0;break}b||c.push(d)}};q.prototype._onReceiveDNSPacket=function(a,b){a=a.toString("hex");if((a=f.parse(a))&&a.isResponse()){var c;if(a.answers)for(b=
0;b<a.answers.length;b++)(c=a.answers[b])&&this._handleRR(c);if(a.authorities)for(b=0;b<a.authorities.length;b++)(c=a.authorities[b])&&this._handleRR(c);if(a.additionals)for(b=0;b<a.additionals.length;b++)(c=a.additionals[b])&&this._handleRR(c);this._searchRecords()}};return q}();
x.mdns.Handler=function(){var n=function(){this._mDns=null};n.prototype.start=function(e){if(this._mDns)e&&e();else{var h=this,c=new x.mdns.DNS_SD;c.startListener(function(k){k||(h._mDns=c);e&&e(k)})}};n.prototype.stop=function(e){if(this._mDns){var h=this;this._mDns.stopListener(function(){h._mDns=null;e&&e()})}else e&&e(Error("mDns not started"))};n.prototype.clearRecordBuffer=function(){this._mDns&&this._mDns.clearRecordBuffer()};n.prototype.discoverServiceWithTimeout=function(e,h,c){var k=this,
f=[];this.discoverService(e,function(c,a){!c&&a&&f.push(a)});setTimeout(function(){k._mDns&&k._mDns.removeDiscoverServiceCallback(e,c);c&&c(null,f)},h)};n.prototype.discoverService=function(e,h){if(e){-1==e.indexOf(".local")&&(e+=".local");var c=this;this._mDns?this._mDns.discoverService(e,h):this.start(function(k){k?h&&h(k):c._mDns.discoverService(e,h)})}else h&&h(Error("serviceType is empty"))};n.prototype.stopDiscover=function(e,h){this._mDns?this._mDns.removeDiscoverServiceCallback(e,h):h&&h()};
var r=function(){var e=function(c,e,f){this._serviceType=c;this._domain=e;this._ios=f;this._running=!1;this._callbacks=[];this._services=[]};e.prototype.discover=function(c){c&&-1==this._callbacks.indexOf(c)&&this._callbacks.push(c);if(this._running)for(var e=0;e<this._services.length;e++)c&&c(null,this._services[e]);else if(!this._running){this._running=!0;var f=this;XC.callHost("mdns","search",{service:this._serviceType},function(c){if(c.error){for(var a=0;a<f._callbacks.length;a++)f._callbacks[a](Error(c.error));
f._callbacks=[];f._stop()}else for(c.target&&"."==c.target.charAt(c.target.length-1)&&(c.target=c.target.substr(0,c.target.length-1)),c.domain&&"."==c.domain.charAt(c.domain.length-1)&&(c.domain=c.domain.substr(0,c.domain.length-1)),f._services.push(c),a=0;a<f._callbacks.length;a++)f._callbacks[a](null,c)})}};e.prototype.removeCallback=function(c){var e=!1;c&&0<this._callbacks.length&&(c=this._callbacks.indexOf(c),-1!=c&&this._callbacks.splice(c,1));0==this._callbacks.length&&(this._stop(),e=!0);
return e};e.prototype._stop=function(){XC.callHost("mdns","stop",{service:this._serviceType},function(c){})};var h=function(){this._serviceHandlers={}};h.prototype.start=function(c){c&&c()};h.prototype.stop=function(c){c&&c()};h.prototype.clearRecordBuffer=function(){};h.prototype.discoverServiceWithTimeout=function(c,e,f){var h=this,a=[],b=function(b,c){!b&&c&&a.push(c)};this.discoverService(c,b);setTimeout(function(){h._removeDiscoverServiceCallback(c,b);f&&f(null,a)},e)};h.prototype.discoverService=
function(c,h){if(c){-1!=c.indexOf(".local")&&(c=c.replace(".local",""));var f=this._serviceHandlers[c];f||(f=new e(c,"local",this),this._serviceHandlers[c]=f);f.discover(h)}else h&&h(Error("serviceType is empty"))};h.prototype.stopDiscover=function(c,e){if(c){-1!=c.indexOf(".local")&&(c=c.replace(".local",""));var f=this._serviceHandlers[c];f?f.removeCallback(e)&&delete this._serviceHandlers[c]:e&&e()}else e&&e(Error("serviceType is empty"))};h.prototype._removeDiscoverServiceCallback=function(c,
e){-1!=c.indexOf(".local")&&(c=c.replace(".local",""));var f=this._serviceHandlers[c];f&&f.removeCallback(e)&&delete this._serviceHandlers[c]};return h}(),l=function(){this._nativeHandler=null};l.prototype.start=function(e){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());this._nativeHandler.start(e)};l.prototype.stop=function(e){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());this._nativeHandler.stop(e)};l.prototype.clearRecordBuffer=function(){this._nativeHandler||
(this._nativeHandler=this._getNativeHandler());this._nativeHandler.clearRecordBuffer()};l.prototype.discoverServiceWithTimeout=function(e,h,c){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());this._nativeHandler.discoverServiceWithTimeout(e,h,c)};l.prototype.discoverService=function(e,h){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());this._nativeHandler.discoverService(e,h)};l.prototype.stopDiscover=function(e,h){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());
this._nativeHandler.stopDiscover(e,h)};l.prototype._getNativeHandler=function(){var e=null;"undefined"!=typeof window&&null!=window&&window.XCHost||(e="node-webkit");"undefined"!=typeof window&&null!=window&&window.XCHost&&window.XCHost.getType&&(e=window.XCHost.getType());return"Android"==e?new r:"node-webkit"==e||"undefined"!=typeof process&&null!=process&&"node"==process.title?new n:new r};return l}();"undefined"!=typeof module&&null!=module&&(module.exports=new x.mdns.Handler);
