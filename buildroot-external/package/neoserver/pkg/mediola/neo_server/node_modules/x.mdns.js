var x=x||{};x.mdns=x.mdns||{},x.mdns.DNS_SD=function(){var t=function t(){this.name=null,this.type=null,this["class"]=null,this.ttl=null,this.length=null,this.data=null;};t.prototype.resolveData=function(t){this.data=t;},t.prototype.toJSON=function(){return this;};var e=function e(){this._info={};};e.prototype.resolveData=function(t,e,r,s){for(var n=0;n<t.length-1;){var a,i=2*parseInt(t.substr(n,2),16);if(a=n+2+i>t.length?t.substr(n+2,t.length-n-2):t.substr(n+2,i)){var h=(a=o._hex2a(a)).indexOf("=");if(-1!=h&&h!=a.length-1){var l=a.substr(0,h),u=a.substr(h+1);this._info[l]=u;}}n+=2+i;}},e.prototype.toJSON=function(){};var r=function r(){};r.prototype.resolveData=function(t,e,r,s){this.domain=o._parseName(e,r,s).name;},r.prototype.getNameTxt=function(){return this.name?o._hex2name(this.name):null;},r.prototype.getDomainTxt=function(){return this.domain?o._hex2name(this.domain):null;},r.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,"class":this["class"],ttl:this.ttl,length:this.length,domain:this.getDomainTxt()};};var s=function s(){};s.prototype.resolveData=function(t,e,r,s){this.priority=parseInt(t.substr(0,4),16),this.weight=parseInt(t.substr(4,4),16),this.port=parseInt(t.substr(8,4),16),this.target=o._parseName(e+12,r,s).name;},s.prototype.getNameTxt=function(){return this.name?o._hex2name(this.name):null;},s.prototype.getTargetTxt=function(){return this.target?o._hex2name(this.target):null;},s.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,"class":this["class"],ttl:this.ttl,length:this.length,priority:this.priority,weight:this.weight,port:this.port,target:this.getTargetTxt()};};var n=function n(){};n.prototype.resolveData=function(t){this.addr=t;},n.prototype.getNameTxt=function(){return this.name?o._hex2name(this.name):null;},n.prototype.getAddrTxt=function(){return n._hex2ipv4(this.addr);},n.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,"class":this["class"],ttl:this.ttl,length:this.length,addr:this.getAddrTxt()};},n._hex2ipv4=function(t){if(!t||t.length<8)return null;var e="";return e+=parseInt(t.substr(0,2),16)+".",e+=parseInt(t.substr(2,2),16)+".",(e+=parseInt(t.substr(4,2),16)+".")+parseInt(t.substr(6,2),16);};var a=function a(){};a.prototype.resolveData=function(t){this.addr=t;},a.prototype.getNameTxt=function(){return this.name?o._hex2name(this.name):null;},a.prototype.getAddrTxt=function(){if(!this.addr||this.addr.length<32)return null;var t="";return t+=this.addr.substr(0,4)+":",t+=this.addr.substr(4,4)+":",t+=this.addr.substr(8,4)+":",t+=this.addr.substr(12,4)+":",t+=this.addr.substr(16,4)+":",t+=this.addr.substr(20,4)+":",(t+=this.addr.substr(24,4)+":")+this.addr.substr(28,4);},a.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,"class":this["class"],ttl:this.ttl,length:this.length,addr:this.getAddrTxt()};};var i=function i(t,e){this.name=t,this.type=e;};i.prototype._name2Array=function(){if(!this.name)return null;for(var t=[],e=0;e<this.name.length-1;e+=2){var r=this.name.substr(e,2);t.push(parseInt(r,16));}return t;},i.prototype.toArray=function(){var t=[];t.push(0),t.push(0),t.push(0),t.push(0),t.push(0),t.push(1),t.push(0),t.push(0),t.push(0),t.push(0),t.push(0),t.push(0);var e=this._name2Array(this.name);if(!e)return null;for(var r=0;r<e.length;r++)t.push(e[r]);switch(t.push(0),this.type){case 12:t.push(0),t.push(12);break;case 33:t.push(0),t.push(33);break;case 1:t.push(0),t.push(1);break;default:return null;}return t.push(0),t.push(1),t;};var o=function o(){this.id=0,this.flag=0,this.qdCount=0,this.anCount=0,this.nsCount=0,this.arCount=0,this.querys=[],this.answers=[],this.authorities=[],this.additionals=[];};o.prototype.isResponse=function(){return this.flag>>15==1;},o.prototype.toJSON=function(){var t,e={id:this.id,flag:this.flag,qdCount:this.qdCount,anCount:this.anCount,nsCount:this.nsCount,arCount:this.arCount,querys:[],answers:[],authorities:[],additionals:[]};for(t=0;t<this.querys.length;t++)e.querys.push(this.querys[t].toJSON());for(t=0;t<this.answers.length;t++)e.answers.push(this.answers[t].toJSON());for(t=0;t<this.additionals.length;t++)e.additionals.push(this.additionals[t].toJSON());return e;},o.parse=function(t){var e=new o();t.length>4&&(e.id=parseInt(t.substr(0,4),16)),t.length>8&&(e.flag=parseInt(t.substr(4,4),16)),t.length>12&&(e.qdCount=parseInt(t.substr(8,4),16)),t.length>16&&(e.anCount=parseInt(t.substr(12,4),16)),t.length>20&&(e.nsCount=parseInt(t.substr(16,4),16)),t.length>24&&(e.arCount=parseInt(t.substr(20,4),16));var r,s=24;if(e.qdCount>0)for(r=0;r<e.qdCount;r++){var n=o._parseQuery(s,t);s=n.queryEnd,e.querys.push(n.query);}if(e.anCount>0)for(r=0;r<e.anCount;r++){var a=o._parseAnswer(s,t);s=a.answerEnd,e.answers.push(a.answer);}if(e.nsCount>0)for(r=0;r<e.arCount;r++){var i=o._parseAuthority(s,t);s=i.nsEnd,e.authorities.push(i.ns);}if(e.arCount>0)for(r=0;r<e.arCount;r++){var h=o._parseAdditional(s,t);s=h.addiEnd,e.additionals.push(h.addi);}return e;},o._parseName=function(t,e,r,s){if((s=s?s+1:1)>10)return{index:t,name:""};for(var n,a,i=t,h=t,l=!1;r.length>h+2&&"00"!=r.substr(h,2)&&!(e&&h-i>=2*e);){if(parseInt(r.substr(h,2),16)>>7==1){var u=16383&parseInt(r.substr(h,4),16);a=o._parseName(2*u,null,r,s).name,l=!0,h+=4;break;}h+=2+2*parseInt(r.substr(h,2),16);}return l?(n=r.substr(i,h-i-4),n+=a):(n=r.substr(i,h-i),h+=2),{index:h,name:n};},o._name2hex=function(t){for(var e="",r=t.split("."),s=0;s<r.length;s++){for(var n=r[s].length.toString(16);n.length<2;)n="0"+n;e+=n;for(var a=0;a<r[s].length;a++){for(var i=r[s].charCodeAt(a).toString(16);i.length<2;)i="0"+i;e+=i;}}return e;},o._hex2name=function(t){for(var e="",r=0;r<t.length;){var s=parseInt(t.substr(r,2),16),n=t.substr(r+2,2*s);e&&(e+="."),e+=o._hex2a(n),r+=2+2*s;}return e;},o._hex2a=function(t){for(var e=t.toString(),r="",s=0;s<e.length;s+=2)r+=String.fromCharCode(parseInt(e.substr(s,2),16));return r;},o._parseRR=function(i,h){var l,u={},c=o._parseName(i,null,h),p=c.index,d=p;switch(u.name=c.name,h.length>p+4&&(d=p+4,u.type=parseInt(h.substr(p,4),16)),h.length>p+4+4&&(d=p+8,u["class"]=parseInt(h.substr(p+4,4),16)),h.length>p+8+8&&(d=p+16,u.ttl=parseInt(h.substr(p+8,8),16)),h.length>p+16+4&&(d=p+20,u.length=parseInt(h.substr(p+16,4),16)),u.length>0&&h.length>=p+20+2*u.length&&(d=p+20+2*u.length,u.data=h.substr(p+20,2*u.length)),u.type){case 12:l=new r();break;case 16:l=new e();break;case 33:l=new s();break;case 1:l=new n();break;case 28:l=new a();break;default:l=new t();}return l&&(l.name=u.name,l.type=u.type,l["class"]=u["class"],l.ttl=u.ttl,l.length=u.length,l.dataRaw=u.data,u.data&&l.resolveData(u.data,p+20,u.length,h)),{end:d,rr:l};},o._parseQuery=function(t,e){var r=new i(),s=o._parseName(t,null,e),n=s.index;return r.name=s.name,e.length>n+4&&(r.type=parseInt(e.substr(n,4),16)),e.length>=n+4+4&&(r["class"]=parseInt(e.substr(n+4,4),16)),{queryEnd:n+8,query:r};},o._parseAnswer=function(t,e){var r=o._parseRR(t,e);return{answerEnd:r.end,answer:r.rr};},o._parseAuthority=function(t,e){var r=o._parseRR(t,e);return{nsEnd:r.end,ns:r.rr};},o._parseAdditional=function(t,e){var r=o._parseRR(t,e);return{addiEnd:r.end,addi:r.rr};};var h=function h(){this._sockets=[],this._searchCallbacks={},this._rrBuffer={_txtRecords:{},_ptrRecords:{},_srvRecords:{},_aRecords:{},_aaaaRecords:{}};};return h.prototype.startListener=function(t){var e="undefined"!=typeof console&&"function"==typeof console.error;function r(t,r,s){var n,a=this,i=s,o=require("dgram");try{n=o.createSocket({type:"udp4",reuseAddr:!0});}catch(t){n=o.createSocket("udp4");}n.on("message",function(t,e){a._onReceiveDNSPacket(t,e);}),n.on("listening",function(){try{n.setBroadcast(!0),n.addMembership("224.0.0.251"),i&&(i(null,n),i=null);}catch(s){e&&console.error("Caught error:",s),e&&console.error("Address causing the error: "+r,t),i&&(i(s),i=null);}}),n.on("error",function(t){e&&console.error("Socket on error:",t),i&&(i(t),i=null);}),n.bind(t,r);}var s=this,n=require("os");if(n&&n.networkInterfaces){var a=n.networkInterfaces(),i=[];for(var o in a)if(a.hasOwnProperty(o))for(var h=a[o],l=0;l<h.length;l++)"IPv4"==h[l].family&&0==h[l].internal&&i.push(h[l].address);(function(t,r){var s,n=this,a=r,i=require("dgram");try{s=i.createSocket({type:"udp4",reuseAddr:!0});}catch(t){s=i.createSocket("udp4");}s.on("message",function(t,e){n._onReceiveDNSPacket(t,e);}),s.on("listening",function(){var r=null;try{s.setBroadcast(!0);for(var n=0;n<t.length;n++)r=t[n],s.addMembership("224.0.0.251",r);a&&(a(null,s),a=null);}catch(s){e&&console.error("Caught error:",s),e&&console.error("Address causing the error: "+r,"| All: "+t.join(", ")),a&&(a(s),a=null);}}),s.on("error",function(t){e&&console.error("Socket on error:",t),a&&(a(t),a=null);}),s.bind(5353);}).call(this,i,function(e,n){if(e)t&&t(e);else{n&&s._sockets.push(n);for(var a=0,o=0;o<i.length;o++)r.call(s,5353,i[o],function(e,r){a++,!e&&r&&(r._isSendSocket=!0,s._sockets.push(r)),a==i.length&&t&&t();});}});}else r.call(this,5353,null,function(e,r){e?t&&t(e):(r&&(r._isSendSocket=!0,s._sockets.push(r)),t&&t());});},h.prototype.stopListener=function(t){if(this._sockets)for(var e=0;e<this._sockets.length;e++){var r=this._sockets[e];r&&r.close();}t&&t();},h.prototype.removeDiscoverServiceCallback=function(t,e){if(t&&e){var r=this._searchCallbacks[t];if(r){for(var s=-1,n=0;n<r.length;n++)if(r[n]===e){s=n;break;}-1!=s&&r.splice(s,1);}}},h.prototype.clearRecordBuffer=function(){this._rrBuffer={_txtRecords:{},_ptrRecords:{},_srvRecords:{},_aRecords:{},_aaaaRecords:{}};},h.prototype.discoverService=function(t,e){if(t){var r=this._searchCallbacks[t];r||(this._searchCallbacks[t]=[],r=this._searchCallbacks[t]),e&&-1==r.indexOf(e)&&r.push(e),e._targets=[],e._domains=[];var s=o._name2hex(t),n=new i(s,12).toArray();n&&this._sendQuery(new Buffer(n));}else e&&e(new Error("serviceType is empty"));},h.prototype._sendQuery=function(t){for(var e=0;e<this._sockets.length;e++){var r=this._sockets[e];r._isSendSocket&&r.send(t,0,t.length,5353,"224.0.0.251");}},h.prototype._searchRecords=function(){var t;for(var e in this._searchCallbacks)if(this._searchCallbacks.hasOwnProperty(e)){var r=o._name2hex(e);if(this._rrBuffer._ptrRecords[r])for(var s=0;s<this._rrBuffer._ptrRecords[r].length;s++){var a=this._rrBuffer._ptrRecords[r][s],h=this._rrBuffer._txtRecords[a];if(this._rrBuffer._srvRecords[a])for(var l=0;l<this._rrBuffer._srvRecords[a].length;l++){var u=this._rrBuffer._srvRecords[a][l];if(this._rrBuffer._aRecords[u]){if(this._rrBuffer._aRecords[u].length>0){for(var c=[],p=0;p<this._rrBuffer._aRecords[u].length;p++){var d=this._rrBuffer._aRecords[u][p],f=n._hex2ipv4(d);f&&c.push(f);}if(c.length>0){var _=this._searchCallbacks[e];if(_)for(var v=o._hex2name(u),g=o._hex2name(a),m=0;m<_.length;m++){var y=_[m];if(y){var b=y._domains;b||(y._domains=[],b=y._domains),-1==b.indexOf(g)&&(y._domains.push(g),y(null,{target:v,domain:g,ip:c,info:h}));}}}}}else(t=new i(u,1).toArray())&&this._sendQuery(new Buffer(t));}else(t=new i(a,33).toArray())&&this._sendQuery(new Buffer(t));}}},h.prototype._handleRR=function(t){var e,r,s,n;switch(t.type){case 12:e=t.name;var a=t.domain,i=this._rrBuffer._ptrRecords[e];for(i||(this._rrBuffer._ptrRecords[e]=[],i=this._rrBuffer._ptrRecords[e]),r=!1,s=0;s<i.length;s++)if(i[s]==a){r=!0;break;}r||i.push(a);break;case 16:e=t.name,this._rrBuffer._txtRecords[e]=t._info;break;case 33:e=t.name;var o=t.target,h=this._rrBuffer._srvRecords[e];for(h||(this._rrBuffer._srvRecords[e]=[],h=this._rrBuffer._srvRecords[e]),r=!1,s=0;s<h.length;s++)if(h[s]==o){r=!0;break;}r||h.push(o);break;case 1:e=t.name,n=t.addr;var l=this._rrBuffer._aRecords[e];for(l||(this._rrBuffer._aRecords[e]=[],l=this._rrBuffer._aRecords[e]),r=!1,s=0;s<l.length;s++)if(l[s]==n){r=!0;break;}r||l.push(n);break;case 28:e=t.name,n=t.addr;var u=this._rrBuffer._aaaaRecords[e];for(u||(this._rrBuffer._aaaaRecords[e]=[],u=this._rrBuffer._aaaaRecords[e]),r=!1,s=0;s<u.length;s++)if(u[s]==n){r=!0;break;}r||u.push(n);}},h.prototype._onReceiveDNSPacket=function(t,e){var r=t.toString("hex"),s=o.parse(r);if(s&&s.isResponse()){var n,a;if(s.answers)for(n=0;n<s.answers.length;n++)(a=s.answers[n])&&this._handleRR(a);if(s.authorities)for(n=0;n<s.authorities.length;n++)(a=s.authorities[n])&&this._handleRR(a);if(s.additionals)for(n=0;n<s.additionals.length;n++)(a=s.additionals[n])&&this._handleRR(a);this._searchRecords();}},h;}(),x.mdns.Handler=function(){var t=function t(){this._mDns=null;};t.prototype.start=function(t){if(this._mDns)t&&t();else{var e=this,r=new x.mdns.DNS_SD();r.startListener(function(s){s||(e._mDns=r),t&&t(s);});}},t.prototype.stop=function(t){if(this._mDns){var e=this;this._mDns.stopListener(function(){e._mDns=null,t&&t();});}else t&&t(new Error("mDns not started"));},t.prototype.clearRecordBuffer=function(){this._mDns&&this._mDns.clearRecordBuffer();},t.prototype.discoverServiceWithTimeout=function(t,e,r){var s=this,n=[];this.discoverService(t,function(t,e){!t&&e&&n.push(e);}),setTimeout(function(){s._mDns&&s._mDns.removeDiscoverServiceCallback(t,r),r&&r(null,n);},e);},t.prototype.discoverService=function(t,e){if(t){-1==t.indexOf(".local")&&(t+=".local");var r=this;this._mDns?this._mDns.discoverService(t,e):this.start(function(s){s?e&&e(s):r._mDns.discoverService(t,e);});}else e&&e(new Error("serviceType is empty"));},t.prototype.stopDiscover=function(t,e){this._mDns?this._mDns.removeDiscoverServiceCallback(t,e):e&&e();};var e=function(){var t=function t(_t,e,r){this._serviceType=_t,this._domain=e,this._ios=r,this._running=!1,this._callbacks=[],this._services=[];};t.prototype.discover=function(t){if(t&&-1==this._callbacks.indexOf(t)&&this._callbacks.push(t),this._running)for(var e=0;e<this._services.length;e++)t&&t(null,this._services[e]);else if(!this._running){this._running=!0;var r=this;var _t2=this._callbackWrapperSearch;this._callbackWrapperSearch=function(e){if(_t2&&XC.removeCallback(_t2),e){if(e.error){for(var s=0;s<r._callbacks.length;s++)r._callbacks[s](new Error(e.error));return r._callbacks=[],void r._stop();}e.target&&"."==e.target.charAt(e.target.length-1)&&(e.target=e.target.substr(0,e.target.length-1)),e.domain&&"."==e.domain.charAt(e.domain.length-1)&&(e.domain=e.domain.substr(0,e.domain.length-1)),r._services.push(e);for(var n=0;n<r._callbacks.length;n++)r._callbacks[n](null,e);}},XC.callHost("mdns","search",{service:this._serviceType},this._callbackWrapperSearch);}},t.prototype.removeCallback=function(t){var e=!1;if(t&&this._callbacks.length>0){var r=this._callbacks.indexOf(t);-1!=r&&this._callbacks.splice(r,1);}return 0==this._callbacks.length&&(this._stop(),e=!0),e;},t.prototype._stop=function(){XC.callHost("mdns","stop",{service:this._serviceType}),this._callbackWrapperSearch&&XC.removeCallback(this._callbackWrapperSearch);};var e=function e(){this._serviceHandlers={};};return e.prototype.start=function(t){t&&t();},e.prototype.stop=function(t){t&&t();},e.prototype.clearRecordBuffer=function(){},e.prototype.discoverServiceWithTimeout=function(t,e,r){var s=this,n=[],a=function a(t,e){!t&&e&&n.push(e);};this.discoverService(t,a),setTimeout(function(){s._removeDiscoverServiceCallback(t,a),r&&r(null,n);},e);},e.prototype.discoverService=function(e,r){if(e){-1!=e.indexOf(".local")&&(e=e.replace(".local",""));var s=this._serviceHandlers[e];s||(s=new t(e,"local",this),this._serviceHandlers[e]=s),s.discover(r);}else r&&r(new Error("serviceType is empty"));},e.prototype.stopDiscover=function(t,e){if(t){-1!=t.indexOf(".local")&&(t=t.replace(".local",""));var r=this._serviceHandlers[t];r?r.removeCallback(e)&&delete this._serviceHandlers[t]:e&&e();}else e&&e(new Error("serviceType is empty"));},e.prototype._removeDiscoverServiceCallback=function(t,e){-1!=t.indexOf(".local")&&(t=t.replace(".local",""));var r=this._serviceHandlers[t];r&&r.removeCallback(e)&&delete this._serviceHandlers[t];},e;}(),r=e,s=function s(){this._nativeHandler=null;};return s.prototype.start=function(t){this._nativeHandler||(this._nativeHandler=this._getNativeHandler()),this._nativeHandler.start(t);},s.prototype.stop=function(t){this._nativeHandler||(this._nativeHandler=this._getNativeHandler()),this._nativeHandler.stop(t);},s.prototype.clearRecordBuffer=function(){this._nativeHandler||(this._nativeHandler=this._getNativeHandler()),this._nativeHandler.clearRecordBuffer();},s.prototype.discoverServiceWithTimeout=function(t,e,r){this._nativeHandler||(this._nativeHandler=this._getNativeHandler()),this._nativeHandler.discoverServiceWithTimeout(t,e,r);},s.prototype.discoverService=function(t,e){this._nativeHandler||(this._nativeHandler=this._getNativeHandler()),this._nativeHandler.discoverService(t,e);},s.prototype.stopDiscover=function(t,e){this._nativeHandler||(this._nativeHandler=this._getNativeHandler()),this._nativeHandler.stopDiscover(t,e);},s.prototype._getNativeHandler=function(){var s=null;return"undefined"!=typeof window&&null!=window&&window.XCHost||(s="node-webkit"),"undefined"!=typeof window&&null!=window&&window.XCHost&&window.XCHost.getType&&(s=window.XCHost.getType()),"Android"==s?new r():"node-webkit"==s||"undefined"!=typeof process&&null!=process&&"node"==process.title?new t():new e();},s;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new x.mdns.Handler());