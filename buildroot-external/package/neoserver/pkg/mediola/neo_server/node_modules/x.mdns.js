var x=x||{};x.mdns=x.mdns||{};
x.mdns.DNS_SD=function(){var p=function(){this.data=this.length=this.ttl=this.class=this.type=this.name=null};p.prototype.resolveData=function(a){this.data=a};p.prototype.toJSON=function(){return this};var r=function(){this._info={}};r.prototype.resolveData=function(a,b,g,d){for(b=0;b<a.length-1;){g=2*parseInt(a.substr(b,2),16);var c;if(c=b+2+g>a.length?a.substr(b+2,a.length-b-2):a.substr(b+2,g)){c=e._hex2a(c);var f=c.indexOf("=");-1!=f&&f!=c.length-1&&(d=c.substr(0,f),c=c.substr(f+1),this._info[d]=
c)}b+=2+g}};r.prototype.toJSON=function(){};var k=function(){};k.prototype.resolveData=function(a,b,g,d){this.domain=e._parseName(b,g,d).name};k.prototype.getNameTxt=function(){return this.name?e._hex2name(this.name):null};k.prototype.getDomainTxt=function(){return this.domain?e._hex2name(this.domain):null};k.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,class:this.class,ttl:this.ttl,length:this.length,domain:this.getDomainTxt()}};var f=function(){};f.prototype.resolveData=
function(a,b,g,d){this.priority=parseInt(a.substr(0,4),16);this.weight=parseInt(a.substr(4,4),16);this.port=parseInt(a.substr(8,4),16);this.target=e._parseName(b+12,g,d).name};f.prototype.getNameTxt=function(){return this.name?e._hex2name(this.name):null};f.prototype.getTargetTxt=function(){return this.target?e._hex2name(this.target):null};f.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,class:this.class,ttl:this.ttl,length:this.length,priority:this.priority,weight:this.weight,
port:this.port,target:this.getTargetTxt()}};var h=function(){};h.prototype.resolveData=function(a){this.addr=a};h.prototype.getNameTxt=function(){return this.name?e._hex2name(this.name):null};h.prototype.getAddrTxt=function(){return h._hex2ipv4(this.addr)};h.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,class:this.class,ttl:this.ttl,length:this.length,addr:this.getAddrTxt()}};h._hex2ipv4=function(a){if(!a||8>a.length)return null;var b=""+(parseInt(a.substr(0,2),16)+".");
b+=parseInt(a.substr(2,2),16)+".";b+=parseInt(a.substr(4,2),16)+".";return b+=parseInt(a.substr(6,2),16)};var c=function(){};c.prototype.resolveData=function(a){this.addr=a};c.prototype.getNameTxt=function(){return this.name?e._hex2name(this.name):null};c.prototype.getAddrTxt=function(){if(!this.addr||32>this.addr.length)return null;var a=""+(this.addr.substr(0,4)+":");a+=this.addr.substr(4,4)+":";a+=this.addr.substr(8,4)+":";a+=this.addr.substr(12,4)+":";a+=this.addr.substr(16,4)+":";a+=this.addr.substr(20,
4)+":";a+=this.addr.substr(24,4)+":";return a+=this.addr.substr(28,4)};c.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,class:this.class,ttl:this.ttl,length:this.length,addr:this.getAddrTxt()}};var l=function(a,b){this.name=a;this.type=b};l.prototype._name2Array=function(){if(!this.name)return null;for(var a=[],b=0;b<this.name.length-1;b+=2){var g=this.name.substr(b,2);a.push(parseInt(g,16))}return a};l.prototype.toArray=function(){var a=[];a.push(0);a.push(0);a.push(0);
a.push(0);a.push(0);a.push(1);a.push(0);a.push(0);a.push(0);a.push(0);a.push(0);a.push(0);var b=this._name2Array(this.name);if(!b)return null;for(var g=0;g<b.length;g++)a.push(b[g]);a.push(0);switch(this.type){case 12:a.push(0);a.push(12);break;case 33:a.push(0);a.push(33);break;case 1:a.push(0);a.push(1);break;default:return null}a.push(0);a.push(1);return a};var e=function(){this.arCount=this.nsCount=this.anCount=this.qdCount=this.flag=this.id=0;this.querys=[];this.answers=[];this.authorities=[];
this.additionals=[]};e.prototype.isResponse=function(){return 1==this.flag>>15};e.prototype.toJSON=function(){var a={id:this.id,flag:this.flag,qdCount:this.qdCount,anCount:this.anCount,nsCount:this.nsCount,arCount:this.arCount,querys:[],answers:[],authorities:[],additionals:[]},b;for(b=0;b<this.querys.length;b++)a.querys.push(this.querys[b].toJSON());for(b=0;b<this.answers.length;b++)a.answers.push(this.answers[b].toJSON());for(b=0;b<this.additionals.length;b++)a.additionals.push(this.additionals[b].toJSON());
return a};e.parse=function(a){var b=new e;4<a.length&&(b.id=parseInt(a.substr(0,4),16));8<a.length&&(b.flag=parseInt(a.substr(4,4),16));12<a.length&&(b.qdCount=parseInt(a.substr(8,4),16));16<a.length&&(b.anCount=parseInt(a.substr(12,4),16));20<a.length&&(b.nsCount=parseInt(a.substr(16,4),16));24<a.length&&(b.arCount=parseInt(a.substr(20,4),16));var g=24,d;if(0<b.qdCount)for(d=0;d<b.qdCount;d++){var c=e._parseQuery(g,a);g=c.queryEnd;b.querys.push(c.query)}if(0<b.anCount)for(d=0;d<b.anCount;d++)c=e._parseAnswer(g,
a),g=c.answerEnd,b.answers.push(c.answer);if(0<b.nsCount)for(d=0;d<b.arCount;d++)c=e._parseAuthority(g,a),g=c.nsEnd,b.authorities.push(c.ns);if(0<b.arCount)for(d=0;d<b.arCount;d++)c=e._parseAdditional(g,a),g=c.addiEnd,b.additionals.push(c.addi);return b};e._parseName=function(a,b,g){for(var d=a,c=!1,f;g.length>d+2&&"00"!=g.substr(d,2)&&!(b&&d-a>=2*b);)if(1==parseInt(g.substr(d,2),16)>>7){f=parseInt(g.substr(d,4),16)&16383;f=e._parseName(2*f,null,g).name;c=!0;d+=4;break}else{var h=parseInt(g.substr(d,
2),16);d+=2+2*h}c?(a=g.substr(a,d-a-4),a+=f):(a=g.substr(a,d-a),d+=2);return{index:d,name:a}};e._name2hex=function(a){var b="";a=a.split(".");for(var g=0;g<a.length;g++){for(var d=a[g].length.toString(16);2>d.length;)d="0"+d;b+=d;for(d=0;d<a[g].length;d++){for(var c=a[g].charCodeAt(d).toString(16);2>c.length;)c="0"+c;b+=c}}return b};e._hex2name=function(a){for(var b="",g=0;g<a.length;){var d=parseInt(a.substr(g,2),16),c=a.substr(g+2,2*d);c=e._hex2a(c);b&&(b+=".");b+=c;g+=2+2*d}return b};e._hex2a=
function(a){a=a.toString();for(var b="",g=0;g<a.length;g+=2)b+=String.fromCharCode(parseInt(a.substr(g,2),16));return b};e._parseRR=function(a,b){var g=e._parseName(a,null,b);var d=a=g.index;g=g.name;if(b.length>a+4){d=a+4;var l=parseInt(b.substr(a,4),16)}if(b.length>a+4+4){d=a+8;var m=parseInt(b.substr(a+4,4),16)}if(b.length>a+8+8){d=a+16;var z=parseInt(b.substr(a+8,8),16)}if(b.length>a+16+4){d=a+20;var q=parseInt(b.substr(a+16,4),16)}if(0<q&&b.length>=a+20+2*q){d=a+20+2*q;var w=b.substr(a+20,2*
q)}switch(l){case 12:var n=new k;break;case 16:n=new r;break;case 33:n=new f;break;case 1:n=new h;break;case 28:n=new c;break;default:n=new p}n&&(n.name=g,n.type=l,n.class=m,n.ttl=z,n.length=q,(n.dataRaw=w)&&n.resolveData(w,a+20,q,b));return{end:d,rr:n}};e._parseQuery=function(a,b){var g=new l;a=e._parseName(a,null,b);var d=a.index;g.name=a.name;b.length>d+4&&(g.type=parseInt(b.substr(d,4),16));b.length>=d+4+4&&(g.class=parseInt(b.substr(d+4,4),16));return{queryEnd:d+8,query:g}};e._parseAnswer=function(a,
b){a=e._parseRR(a,b);return{answerEnd:a.end,answer:a.rr}};e._parseAuthority=function(a,b){a=e._parseRR(a,b);return{nsEnd:a.end,ns:a.rr}};e._parseAdditional=function(a,b){a=e._parseRR(a,b);return{addiEnd:a.end,addi:a.rr}};var m=function(){this._sockets=[];this._searchCallbacks={};this._rrBuffer={_txtRecords:{},_ptrRecords:{},_srvRecords:{},_aRecords:{},_aaaaRecords:{}}};m.prototype.startListener=function(a){function b(a,b,c){var d=this,e=c;c=require("dgram");try{var f=c.createSocket({type:"udp4",reuseAddr:!0})}catch(v){f=
c.createSocket("udp4")}f.on("message",function(a,b){d._onReceiveDNSPacket(a,b)});f.on("listening",function(){try{f.setBroadcast(!0),f.addMembership("224.0.0.251"),e&&(e(null,f),e=null)}catch(v){g&&console.error("Caught error:",v),g&&console.error("Address causing the error: "+b,a),e&&(e(v),e=null)}});f.on("error",function(a){g&&console.error("Socket on error:",a);e&&(e(a),e=null)});f.bind(a,b)}var g="undefined"!==typeof console&&"function"===typeof console.error,d=function(a,b){var c=this,d=b;b=require("dgram");
try{var e=b.createSocket({type:"udp4",reuseAddr:!0})}catch(A){e=b.createSocket("udp4")}e.on("message",function(a,b){c._onReceiveDNSPacket(a,b)});e.on("listening",function(){var b=null;try{e.setBroadcast(!0);for(var c=0;c<a.length;c++)b=a[c],e.addMembership("224.0.0.251",b);d&&(d(null,e),d=null)}catch(y){g&&console.error("Caught error:",y),g&&console.error("Address causing the error: "+b,"| All: "+a.join(", ")),d&&(d(y),d=null)}});e.on("error",function(a){g&&console.error("Socket on error:",a);d&&
(d(a),d=null)});e.bind(5353)},c=this,e=require("os");if(e&&e.networkInterfaces){e=e.networkInterfaces();var f=[],h;for(h in e)if(e.hasOwnProperty(h))for(var l=e[h],m=0;m<l.length;m++)"IPv4"==l[m].family&&0==l[m].internal&&f.push(l[m].address);d.call(this,f,function(d,g){if(d)a&&a(d);else{g&&c._sockets.push(g);var e=0;for(d=0;d<f.length;d++)b.call(c,5353,f[d],function(b,d){e++;!b&&d&&(d._isSendSocket=!0,c._sockets.push(d));e==f.length&&a&&a()})}})}else b.call(this,5353,null,function(b,d){b?a&&a(b):
(d&&(d._isSendSocket=!0,c._sockets.push(d)),a&&a())})};m.prototype.stopListener=function(a){if(this._sockets)for(var b=0;b<this._sockets.length;b++){var c=this._sockets[b];c&&c.close()}a&&a()};m.prototype.removeDiscoverServiceCallback=function(a,b){if(a&&b&&(a=this._searchCallbacks[a])){for(var c=-1,d=0;d<a.length;d++)if(a[d]===b){c=d;break}-1!=c&&a.splice(c,1)}};m.prototype.clearRecordBuffer=function(){this._rrBuffer={_txtRecords:{},_ptrRecords:{},_srvRecords:{},_aRecords:{},_aaaaRecords:{}}};m.prototype.discoverService=
function(a,b){if(a){var c=this._searchCallbacks[a];c||(this._searchCallbacks[a]=[],c=this._searchCallbacks[a]);b&&-1==c.indexOf(b)&&c.push(b);b._targets=[];b._domains=[];a=e._name2hex(a);(a=(new l(a,12)).toArray())&&this._sendQuery(new Buffer(a))}else b&&b(Error("serviceType is empty"))};m.prototype._sendQuery=function(a){for(var b=0;b<this._sockets.length;b++){var c=this._sockets[b];c._isSendSocket&&c.send(a,0,a.length,5353,"224.0.0.251")}};m.prototype._searchRecords=function(){var a;for(a in this._searchCallbacks)if(this._searchCallbacks.hasOwnProperty(a)){var b=
e._name2hex(a);if(this._rrBuffer._ptrRecords[b])for(var c=0;c<this._rrBuffer._ptrRecords[b].length;c++){var d=this._rrBuffer._ptrRecords[b][c],f=this._rrBuffer._txtRecords[d];if(this._rrBuffer._srvRecords[d])for(var m=0;m<this._rrBuffer._srvRecords[d].length;m++){var k=this._rrBuffer._srvRecords[d][m];if(!this._rrBuffer._aRecords[k]){var q=new l(k,1);(q=q.toArray())&&this._sendQuery(new Buffer(q))}else if(0<this._rrBuffer._aRecords[k].length){q=[];for(var p=0;p<this._rrBuffer._aRecords[k].length;p++){var n=
h._hex2ipv4(this._rrBuffer._aRecords[k][p]);n&&q.push(n)}if(0<q.length&&(p=this._searchCallbacks[a])){k=e._hex2name(k);n=e._hex2name(d);for(var r=0;r<p.length;r++){var t=p[r];if(t){var u=t._domains;u||(t._domains=[],u=t._domains);-1==u.indexOf(n)&&(t._domains.push(n),t(null,{target:k,domain:n,ip:q,info:f}))}}}}}else q=new l(d,33),(q=q.toArray())&&this._sendQuery(new Buffer(q))}}};m.prototype._handleRR=function(a){switch(a.type){case 12:var b=a.name;var c=a.domain;var d=this._rrBuffer._ptrRecords[b];
d||(this._rrBuffer._ptrRecords[b]=[],d=this._rrBuffer._ptrRecords[b]);b=!1;for(a=0;a<d.length;a++)if(d[a]==c){b=!0;break}b||d.push(c);break;case 16:b=a.name;this._rrBuffer._txtRecords[b]=a._info;break;case 33:b=a.name;c=a.target;d=this._rrBuffer._srvRecords[b];d||(this._rrBuffer._srvRecords[b]=[],d=this._rrBuffer._srvRecords[b]);b=!1;for(a=0;a<d.length;a++)if(d[a]==c){b=!0;break}b||d.push(c);break;case 1:b=a.name;c=a.addr;d=this._rrBuffer._aRecords[b];d||(this._rrBuffer._aRecords[b]=[],d=this._rrBuffer._aRecords[b]);
b=!1;for(a=0;a<d.length;a++)if(d[a]==c){b=!0;break}b||d.push(c);break;case 28:b=a.name;c=a.addr;d=this._rrBuffer._aaaaRecords[b];d||(this._rrBuffer._aaaaRecords[b]=[],d=this._rrBuffer._aaaaRecords[b]);b=!1;for(a=0;a<d.length;a++)if(d[a]==c){b=!0;break}b||d.push(c)}};m.prototype._onReceiveDNSPacket=function(a,b){a=a.toString("hex");if((a=e.parse(a))&&a.isResponse()){var c;if(a.answers)for(b=0;b<a.answers.length;b++)(c=a.answers[b])&&this._handleRR(c);if(a.authorities)for(b=0;b<a.authorities.length;b++)(c=
a.authorities[b])&&this._handleRR(c);if(a.additionals)for(b=0;b<a.additionals.length;b++)(c=a.additionals[b])&&this._handleRR(c);this._searchRecords()}};return m}();
x.mdns.Handler=function(){var p=function(){this._mDns=null};p.prototype.start=function(f){if(this._mDns)f&&f();else{var h=this,c=new x.mdns.DNS_SD;c.startListener(function(l){l||(h._mDns=c);f&&f(l)})}};p.prototype.stop=function(f){if(this._mDns){var h=this;this._mDns.stopListener(function(){h._mDns=null;f&&f()})}else f&&f(Error("mDns not started"))};p.prototype.clearRecordBuffer=function(){this._mDns&&this._mDns.clearRecordBuffer()};p.prototype.discoverServiceWithTimeout=function(f,h,c){var l=this,
e=[];this.discoverService(f,function(c,a){!c&&a&&e.push(a)});setTimeout(function(){l._mDns&&l._mDns.removeDiscoverServiceCallback(f,c);c&&c(null,e)},h)};p.prototype.discoverService=function(f,h){if(f){-1==f.indexOf(".local")&&(f+=".local");var c=this;this._mDns?this._mDns.discoverService(f,h):this.start(function(l){l?h&&h(l):c._mDns.discoverService(f,h)})}else h&&h(Error("serviceType is empty"))};p.prototype.stopDiscover=function(f,h){this._mDns?this._mDns.removeDiscoverServiceCallback(f,h):h&&h()};
var r=function(){var f=function(c,f,e){this._serviceType=c;this._domain=f;this._ios=e;this._running=!1;this._callbacks=[];this._services=[]};f.prototype.discover=function(c){c&&-1==this._callbacks.indexOf(c)&&this._callbacks.push(c);if(this._running)for(var f=0;f<this._services.length;f++)c&&c(null,this._services[f]);else if(!this._running){this._running=!0;var e=this;XC.callHost("mdns","search",{service:this._serviceType},function(c){if(c.error){for(var a=0;a<e._callbacks.length;a++)e._callbacks[a](Error(c.error));
e._callbacks=[];e._stop()}else for(c.target&&"."==c.target.charAt(c.target.length-1)&&(c.target=c.target.substr(0,c.target.length-1)),c.domain&&"."==c.domain.charAt(c.domain.length-1)&&(c.domain=c.domain.substr(0,c.domain.length-1)),e._services.push(c),a=0;a<e._callbacks.length;a++)e._callbacks[a](null,c)})}};f.prototype.removeCallback=function(c){var f=!1;c&&0<this._callbacks.length&&(c=this._callbacks.indexOf(c),-1!=c&&this._callbacks.splice(c,1));0==this._callbacks.length&&(this._stop(),f=!0);
return f};f.prototype._stop=function(){XC.callHost("mdns","stop",{service:this._serviceType},function(c){})};var h=function(){this._serviceHandlers={}};h.prototype.start=function(c){c&&c()};h.prototype.stop=function(c){c&&c()};h.prototype.clearRecordBuffer=function(){};h.prototype.discoverServiceWithTimeout=function(c,f,e){var h=this,a=[],b=function(b,c){!b&&c&&a.push(c)};this.discoverService(c,b);setTimeout(function(){h._removeDiscoverServiceCallback(c,b);e&&e(null,a)},f)};h.prototype.discoverService=
function(c,h){if(c){-1!=c.indexOf(".local")&&(c=c.replace(".local",""));var e=this._serviceHandlers[c];e||(e=new f(c,"local",this),this._serviceHandlers[c]=e);e.discover(h)}else h&&h(Error("serviceType is empty"))};h.prototype.stopDiscover=function(c,f){if(c){-1!=c.indexOf(".local")&&(c=c.replace(".local",""));var e=this._serviceHandlers[c];e?e.removeCallback(f)&&delete this._serviceHandlers[c]:f&&f()}else f&&f(Error("serviceType is empty"))};h.prototype._removeDiscoverServiceCallback=function(c,
f){-1!=c.indexOf(".local")&&(c=c.replace(".local",""));var e=this._serviceHandlers[c];e&&e.removeCallback(f)&&delete this._serviceHandlers[c]};return h}(),k=function(){this._nativeHandler=null};k.prototype.start=function(f){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());this._nativeHandler.start(f)};k.prototype.stop=function(f){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());this._nativeHandler.stop(f)};k.prototype.clearRecordBuffer=function(){this._nativeHandler||
(this._nativeHandler=this._getNativeHandler());this._nativeHandler.clearRecordBuffer()};k.prototype.discoverServiceWithTimeout=function(f,h,c){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());this._nativeHandler.discoverServiceWithTimeout(f,h,c)};k.prototype.discoverService=function(f,h){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());this._nativeHandler.discoverService(f,h)};k.prototype.stopDiscover=function(f,h){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());
this._nativeHandler.stopDiscover(f,h)};k.prototype._getNativeHandler=function(){var f=null;"undefined"!=typeof window&&null!=window&&window.XCHost||(f="node-webkit");"undefined"!=typeof window&&null!=window&&window.XCHost&&window.XCHost.getType&&(f=window.XCHost.getType());return"Android"==f?new r:"node-webkit"==f||"undefined"!=typeof process&&null!=process&&"node"==process.title?new p:new r};return k}();"undefined"!=typeof module&&null!=module&&(module.exports=new x.mdns.Handler);
