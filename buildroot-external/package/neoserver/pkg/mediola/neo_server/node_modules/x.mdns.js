var x=x||{};x.mdns=x.mdns||{};
x.mdns.DNS_SD=function(){var r=function(){this.data=this.length=this.ttl=this.class=this.type=this.name=null};r.prototype.resolveData=function(a){this.data=a};r.prototype.toJSON=function(){return this};var u=function(){this._info={}};u.prototype.resolveData=function(a,b,d,f){for(b=0;b<a.length-1;){d=2*parseInt(a.substr(b,2),16);var k;if(k=b+2+d>a.length?a.substr(b+2,a.length-b-2):a.substr(b+2,d)){k=e._hex2a(k);var c=k.indexOf("=");-1!=c&&c!=k.length-1&&(f=k.substr(0,c),k=k.substr(c+1),this._info[f]=
k)}b+=2+d}};u.prototype.toJSON=function(){};var m=function(){};m.prototype.resolveData=function(a,b,d,f){this.domain=e._parseName(b,d,f).name};m.prototype.getNameTxt=function(){return this.name?e._hex2name(this.name):null};m.prototype.getDomainTxt=function(){return this.domain?e._hex2name(this.domain):null};m.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,class:this.class,ttl:this.ttl,length:this.length,domain:this.getDomainTxt()}};var g=function(){};g.prototype.resolveData=
function(a,b,d,f){this.priority=parseInt(a.substr(0,4),16);this.weight=parseInt(a.substr(4,4),16);this.port=parseInt(a.substr(8,4),16);this.target=e._parseName(b+12,d,f).name};g.prototype.getNameTxt=function(){return this.name?e._hex2name(this.name):null};g.prototype.getTargetTxt=function(){return this.target?e._hex2name(this.target):null};g.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,class:this.class,ttl:this.ttl,length:this.length,priority:this.priority,weight:this.weight,
port:this.port,target:this.getTargetTxt()}};var h=function(){};h.prototype.resolveData=function(a){this.addr=a};h.prototype.getNameTxt=function(){return this.name?e._hex2name(this.name):null};h.prototype.getAddrTxt=function(){return h._hex2ipv4(this.addr)};h.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,class:this.class,ttl:this.ttl,length:this.length,addr:this.getAddrTxt()}};h._hex2ipv4=function(a){if(!a||8>a.length)return null;var b;b=""+(parseInt(a.substr(0,2),16)+".");
b+=parseInt(a.substr(2,2),16)+".";b+=parseInt(a.substr(4,2),16)+".";return b+=parseInt(a.substr(6,2),16)};var c=function(){};c.prototype.resolveData=function(a){this.addr=a};c.prototype.getNameTxt=function(){return this.name?e._hex2name(this.name):null};c.prototype.getAddrTxt=function(){if(!this.addr||32>this.addr.length)return null;var a;a=""+(this.addr.substr(0,4)+":");a+=this.addr.substr(4,4)+":";a+=this.addr.substr(8,4)+":";a+=this.addr.substr(12,4)+":";a+=this.addr.substr(16,4)+":";a+=this.addr.substr(20,
4)+":";a+=this.addr.substr(24,4)+":";return a+=this.addr.substr(28,4)};c.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,class:this.class,ttl:this.ttl,length:this.length,addr:this.getAddrTxt()}};var n=function(a,b){this.name=a;this.type=b};n.prototype._name2Array=function(){if(!this.name)return null;for(var a=[],b=0;b<this.name.length-1;b+=2){var d=this.name.substr(b,2);a.push(parseInt(d,16))}return a};n.prototype.toArray=function(){var a=[];a.push(0);a.push(0);a.push(0);
a.push(0);a.push(0);a.push(1);a.push(0);a.push(0);a.push(0);a.push(0);a.push(0);a.push(0);var b=this._name2Array(this.name);if(!b)return null;for(var d=0;d<b.length;d++)a.push(b[d]);a.push(0);switch(this.type){case 12:a.push(0);a.push(12);break;case 33:a.push(0);a.push(33);break;case 1:a.push(0);a.push(1);break;default:return null}a.push(0);a.push(1);return a};var e=function(){this.arCount=this.nsCount=this.anCount=this.qdCount=this.flag=this.id=0;this.querys=[];this.answers=[];this.authorities=[];
this.additionals=[]};e.prototype.isResponse=function(){return 1==this.flag>>15};e.prototype.toJSON=function(){var a={id:this.id,flag:this.flag,qdCount:this.qdCount,anCount:this.anCount,nsCount:this.nsCount,arCount:this.arCount,querys:[],answers:[],authorities:[],additionals:[]},b;for(b=0;b<this.querys.length;b++)a.querys.push(this.querys[b].toJSON());for(b=0;b<this.answers.length;b++)a.answers.push(this.answers[b].toJSON());for(b=0;b<this.additionals.length;b++)a.additionals.push(this.additionals[b].toJSON());
return a};e.parse=function(a){var b=new e;4<a.length&&(b.id=parseInt(a.substr(0,4),16));8<a.length&&(b.flag=parseInt(a.substr(4,4),16));12<a.length&&(b.qdCount=parseInt(a.substr(8,4),16));16<a.length&&(b.anCount=parseInt(a.substr(12,4),16));20<a.length&&(b.nsCount=parseInt(a.substr(16,4),16));24<a.length&&(b.arCount=parseInt(a.substr(20,4),16));var d=24,f;if(0<b.qdCount)for(f=0;f<b.qdCount;f++){var k=e._parseQuery(d,a),d=k.queryEnd;b.querys.push(k.query)}if(0<b.anCount)for(f=0;f<b.anCount;f++)k=e._parseAnswer(d,
a),d=k.answerEnd,b.answers.push(k.answer);if(0<b.nsCount)for(f=0;f<b.arCount;f++)k=e._parseAuthority(d,a),d=k.nsEnd,b.authorities.push(k.ns);if(0<b.arCount)for(f=0;f<b.arCount;f++)k=e._parseAdditional(d,a),d=k.addiEnd,b.additionals.push(k.addi);return b};e._parseName=function(a,b,d){for(var f=a,k=!1,c;d.length>f+2&&"00"!=d.substr(f,2)&&!(b&&f-a>=2*b);)if(1==parseInt(d.substr(f,2),16)>>7){c=parseInt(d.substr(f,4),16)&16383;c=e._parseName(2*c,null,d).name;k=!0;f+=4;break}else var g=parseInt(d.substr(f,
2),16),f=f+(2+2*g);k?(a=d.substr(a,f-a-4),a+=c):(a=d.substr(a,f-a),f+=2);return{index:f,name:a}};e._name2hex=function(a){var b="";a=a.split(".");for(var d=0;d<a.length;d++){for(var f=a[d].length.toString(16);2>f.length;)f="0"+f;b+=f;for(f=0;f<a[d].length;f++){for(var c=a[d].charCodeAt(f).toString(16);2>c.length;)c="0"+c;b+=c}}return b};e._hex2name=function(a){for(var b="",d=0;d<a.length;){var f=parseInt(a.substr(d,2),16),c=a.substr(d+2,2*f),c=e._hex2a(c);b&&(b+=".");b+=c;d+=2+2*f}return b};e._hex2a=
function(a){a=a.toString();for(var b="",d=0;d<a.length;d+=2)b+=String.fromCharCode(parseInt(a.substr(d,2),16));return b};e._parseRR=function(a,b){var d,f,k,n,p,v;d=e._parseName(a,null,b);var l=d.index,t=l;d=d.name;b.length>l+4&&(t=l+4,f=parseInt(b.substr(l,4),16));b.length>l+4+4&&(t=l+8,k=parseInt(b.substr(l+4,4),16));b.length>l+8+8&&(t=l+16,n=parseInt(b.substr(l+8,8),16));b.length>l+16+4&&(t=l+20,p=parseInt(b.substr(l+16,4),16));0<p&&b.length>=l+20+2*p&&(t=l+20+2*p,v=b.substr(l+20,2*p));var q;switch(f){case 12:q=
new m;break;case 16:q=new u;break;case 33:q=new g;break;case 1:q=new h;break;case 28:q=new c;break;default:q=new r}q&&(q.name=d,q.type=f,q.class=k,q.ttl=n,q.length=p,(q.dataRaw=v)&&q.resolveData(v,l+20,p,b));return{end:t,rr:q}};e._parseQuery=function(a,b){var d=new n,f=e._parseName(a,null,b),c=f.index;d.name=f.name;b.length>c+4&&(d.type=parseInt(b.substr(c,4),16));b.length>=c+4+4&&(d.class=parseInt(b.substr(c+4,4),16));return{queryEnd:c+8,query:d}};e._parseAnswer=function(a,b){var d=e._parseRR(a,
b);return{answerEnd:d.end,answer:d.rr}};e._parseAuthority=function(a,b){var d=e._parseRR(a,b);return{nsEnd:d.end,ns:d.rr}};e._parseAdditional=function(a,b){var d=e._parseRR(a,b);return{addiEnd:d.end,addi:d.rr}};var p=function(){this._sockets=[];this._searchCallbacks={};this._rrBuffer={_txtRecords:{},_ptrRecords:{},_srvRecords:{},_aRecords:{},_aaaaRecords:{}}};p.prototype.startListener=function(a){function b(a,b,d){var f=this,c=d;d=require("dgram");var e;try{e=d.createSocket({type:"udp4",reuseAddr:!0})}catch(g){e=
d.createSocket("udp4")}e.on("message",function(a,b){f._onReceiveDNSPacket(a,b)});e.on("listening",function(){e.setBroadcast(!0);e.addMembership("224.0.0.251");c&&(c(null,e),c=null)});e.on("error",function(a){c&&(c(a),c=null)});e.bind(a,b)}var d=function(a,b){var d=this,f=b,c=require("dgram"),e;try{e=c.createSocket({type:"udp4",reuseAddr:!0})}catch(g){e=c.createSocket("udp4")}e.on("message",function(a,b){d._onReceiveDNSPacket(a,b)});e.on("listening",function(){e.setBroadcast(!0);for(var b=0;b<a.length;b++)e.addMembership("224.0.0.251",
a[b]);f&&(f(null,e),f=null)});e.on("error",function(a){f&&(f(a),f=null)});e.bind(5353)},f=this,c=require("os");if(c&&c.networkInterfaces){var c=c.networkInterfaces(),e=[],g;for(g in c)if(c.hasOwnProperty(g))for(var n=c[g],h=0;h<n.length;h++)"IPv4"==n[h].family&&0==n[h].internal&&e.push(n[h].address);d.call(this,e,function(d,c){if(d)a&&a(d);else{c&&f._sockets.push(c);for(var g=0,k=0;k<e.length;k++)b.call(f,5353,e[k],function(b,d){g++;!b&&d&&(d._isSendSocket=!0,f._sockets.push(d));g==e.length&&a&&a()})}})}else b.call(this,
5353,null,function(b,d){b?a&&a(b):(d&&(d._isSendSocket=!0,f._sockets.push(d)),a&&a())})};p.prototype.stopListener=function(a){if(this._sockets)for(var b=0;b<this._sockets.length;b++){var d=this._sockets[b];d&&d.close()}a&&a()};p.prototype.removeDiscoverServiceCallback=function(a,b){if(a&&b){var d=this._searchCallbacks[a];if(d){for(var f=-1,c=0;c<d.length;c++)if(d[c]===b){f=c;break}-1!=f&&d.splice(f,1)}}};p.prototype.clearRecordBuffer=function(){this._rrBuffer={_txtRecords:{},_ptrRecords:{},_srvRecords:{},
_aRecords:{},_aaaaRecords:{}}};p.prototype.discoverService=function(a,b){if(a){var d=this._searchCallbacks[a];d||(this._searchCallbacks[a]=[],d=this._searchCallbacks[a]);b&&-1==d.indexOf(b)&&d.push(b);b._targets=[];b._domains=[];d=e._name2hex(a);(d=(new n(d,12)).toArray())&&this._sendQuery(new Buffer(d))}else b&&b(Error("serviceType is empty"))};p.prototype._sendQuery=function(a){for(var b=0;b<this._sockets.length;b++){var d=this._sockets[b];d._isSendSocket&&d.send(a,0,a.length,5353,"224.0.0.251")}};
p.prototype._searchRecords=function(){var a,b;for(b in this._searchCallbacks)if(this._searchCallbacks.hasOwnProperty(b)){var d=e._name2hex(b);if(this._rrBuffer._ptrRecords[d])for(var f=0;f<this._rrBuffer._ptrRecords[d].length;f++){var c=this._rrBuffer._ptrRecords[d][f],g=this._rrBuffer._txtRecords[c];if(this._rrBuffer._srvRecords[c])for(var p=0;p<this._rrBuffer._srvRecords[c].length;p++){var m=this._rrBuffer._srvRecords[c][p];if(!this._rrBuffer._aRecords[m])a=new n(m,1),(a=a.toArray())&&this._sendQuery(new Buffer(a));
else if(0<this._rrBuffer._aRecords[m].length){a=[];for(var l=0;l<this._rrBuffer._aRecords[m].length;l++){var t=h._hex2ipv4(this._rrBuffer._aRecords[m][l]);t&&a.push(t)}if(0<a.length&&(l=this._searchCallbacks[b]))for(var m=e._hex2name(m),t=e._hex2name(c),q=0;q<l.length;q++){var r=l[q];if(r){var u=r._domains;u||(r._domains=[],u=r._domains);-1==u.indexOf(t)&&(r._domains.push(t),r(null,{target:m,domain:t,ip:a,info:g}))}}}}else a=new n(c,33),(a=a.toArray())&&this._sendQuery(new Buffer(a))}}};p.prototype._handleRR=
function(a){var b,d;switch(a.type){case 12:b=a.name;d=a.domain;var c=this._rrBuffer._ptrRecords[b];c||(this._rrBuffer._ptrRecords[b]=[],c=this._rrBuffer._ptrRecords[b]);b=!1;for(a=0;a<c.length;a++)if(c[a]==d){b=!0;break}b||c.push(d);break;case 16:b=a.name;this._rrBuffer._txtRecords[b]=a._info;break;case 33:b=a.name;d=a.target;c=this._rrBuffer._srvRecords[b];c||(this._rrBuffer._srvRecords[b]=[],c=this._rrBuffer._srvRecords[b]);b=!1;for(a=0;a<c.length;a++)if(c[a]==d){b=!0;break}b||c.push(d);break;case 1:b=
a.name;d=a.addr;c=this._rrBuffer._aRecords[b];c||(this._rrBuffer._aRecords[b]=[],c=this._rrBuffer._aRecords[b]);b=!1;for(a=0;a<c.length;a++)if(c[a]==d){b=!0;break}b||c.push(d);break;case 28:b=a.name;d=a.addr;c=this._rrBuffer._aaaaRecords[b];c||(this._rrBuffer._aaaaRecords[b]=[],c=this._rrBuffer._aaaaRecords[b]);b=!1;for(a=0;a<c.length;a++)if(c[a]==d){b=!0;break}b||c.push(d)}};p.prototype._onReceiveDNSPacket=function(a,b){var c=a.toString("hex");if((c=e.parse(c))&&c.isResponse()){var f,g;if(c.answers)for(f=
0;f<c.answers.length;f++)(g=c.answers[f])&&this._handleRR(g);if(c.authorities)for(f=0;f<c.authorities.length;f++)(g=c.authorities[f])&&this._handleRR(g);if(c.additionals)for(f=0;f<c.additionals.length;f++)(g=c.additionals[f])&&this._handleRR(g);this._searchRecords()}};return p}();
x.mdns.Handler=function(){var r=function(){this._mDns=null};r.prototype.start=function(g){if(this._mDns)g&&g();else{var h=this,c=new x.mdns.DNS_SD;c.startListener(function(n){n||(h._mDns=c);g&&g(n)})}};r.prototype.stop=function(g){if(this._mDns){var h=this;this._mDns.stopListener(function(){h._mDns=null;g&&g()})}else g&&g(Error("mDns not started"))};r.prototype.clearRecordBuffer=function(){this._mDns&&this._mDns.clearRecordBuffer()};r.prototype.discoverServiceWithTimeout=function(g,h,c){var n=this,
e=[];this.discoverService(g,function(c,a){!c&&a&&e.push(a)});setTimeout(function(){n._mDns&&n._mDns.removeDiscoverServiceCallback(g,c);c&&c(null,e)},h)};r.prototype.discoverService=function(g,h){if(g){-1==g.indexOf(".local")&&(g+=".local");var c=this;this._mDns?this._mDns.discoverService(g,h):this.start(function(n){n?h&&h(n):c._mDns.discoverService(g,h)})}else h&&h(Error("serviceType is empty"))};r.prototype.stopDiscover=function(g,h){this._mDns?this._mDns.removeDiscoverServiceCallback(g,h):h&&h()};
var u=function(){var g=function(c,g,e){this._serviceType=c;this._domain=g;this._ios=e;this._running=!1;this._callbacks=[];this._services=[]};g.prototype.discover=function(c){c&&-1==this._callbacks.indexOf(c)&&this._callbacks.push(c);if(this._running)for(var g=0;g<this._services.length;g++)c&&c(null,this._services[g]);else if(!this._running){this._running=!0;var e=this;XC.callHost("mdns","search",{service:this._serviceType},function(c){if(c.error){for(var a=0;a<e._callbacks.length;a++)e._callbacks[a](Error(c.error));
e._callbacks=[];e._stop()}else for(c.target&&"."==c.target.charAt(c.target.length-1)&&(c.target=c.target.substr(0,c.target.length-1)),c.domain&&"."==c.domain.charAt(c.domain.length-1)&&(c.domain=c.domain.substr(0,c.domain.length-1)),e._services.push(c),a=0;a<e._callbacks.length;a++)e._callbacks[a](null,c)})}};g.prototype.removeCallback=function(c){var g=!1;c&&0<this._callbacks.length&&(c=this._callbacks.indexOf(c),-1!=c&&this._callbacks.splice(c,1));0==this._callbacks.length&&(this._stop(),g=!0);
return g};g.prototype._stop=function(){XC.callHost("mdns","stop",{service:this._serviceType},function(c){})};var h=function(){this._serviceHandlers={}};h.prototype.start=function(c){c&&c()};h.prototype.stop=function(c){c&&c()};h.prototype.clearRecordBuffer=function(){};h.prototype.discoverServiceWithTimeout=function(c,g,e){var h=this,a=[],b=function(b,c){!b&&c&&a.push(c)};this.discoverService(c,b);setTimeout(function(){h._removeDiscoverServiceCallback(c,b);e&&e(null,a)},g)};h.prototype.discoverService=
function(c,h){if(c){-1!=c.indexOf(".local")&&(c=c.replace(".local",""));var e=this._serviceHandlers[c];e||(e=new g(c,"local",this),this._serviceHandlers[c]=e);e.discover(h)}else h&&h(Error("serviceType is empty"))};h.prototype.stopDiscover=function(c,g){if(c){-1!=c.indexOf(".local")&&(c=c.replace(".local",""));var e=this._serviceHandlers[c];e?e.removeCallback(g)&&delete this._serviceHandlers[c]:g&&g()}else g&&g(Error("serviceType is empty"))};h.prototype._removeDiscoverServiceCallback=function(c,
g){-1!=c.indexOf(".local")&&(c=c.replace(".local",""));var e=this._serviceHandlers[c];e&&e.removeCallback(g)&&delete this._serviceHandlers[c]};return h}(),m=function(){this._nativeHandler=null};m.prototype.start=function(g){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());this._nativeHandler.start(g)};m.prototype.stop=function(g){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());this._nativeHandler.stop(g)};m.prototype.clearRecordBuffer=function(){this._nativeHandler||
(this._nativeHandler=this._getNativeHandler());this._nativeHandler.clearRecordBuffer()};m.prototype.discoverServiceWithTimeout=function(g,h,c){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());this._nativeHandler.discoverServiceWithTimeout(g,h,c)};m.prototype.discoverService=function(g,h){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());this._nativeHandler.discoverService(g,h)};m.prototype.stopDiscover=function(g,h){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());
this._nativeHandler.stopDiscover(g,h)};m.prototype._getNativeHandler=function(){var g=null;"undefined"!=typeof window&&null!=window&&window.XCHost||(g="node-webkit");"undefined"!=typeof window&&null!=window&&window.XCHost&&window.XCHost.getType&&(g=window.XCHost.getType());return"Android"==g?new u:"node-webkit"==g||"undefined"!=typeof process&&null!=process&&"node"==process.title?new r:new u};return m}();"undefined"!=typeof module&&null!=module&&(module.exports=new x.mdns.Handler);
