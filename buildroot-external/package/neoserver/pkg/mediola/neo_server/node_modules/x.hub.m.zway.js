var util=require("util"),EventEmitter=require("events"),path=require("path"),fs=require("fs"),fs_extra=require("fs-extra"),fileman=require("x.hub.fileman.js"),logger=require("x.logger.js"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.zway=x.hub.m.zway||{};logger.setLevel("info","x.hub.m.zway");
x.hub.m.zway.PollManager=function(){var l=["37","38","49","64","67"],g=function(e){this._logger=logger.getLogger("x.hub.m.zway.Poller");this._pollManager=e;this._deviceID=null;this._pollInterval=0;this._running=!1;this._pollTO=this._startPollTO=null;this._errorCount=0};g.prototype.setDeviceID=function(e){this._deviceID=e};g.prototype.setPollInterval=function(e){this._pollInterval=e};g.prototype.start=function(){this._logger.log("trace","start for device: "+this._deviceID+" with interval: "+this._pollInterval+
"s");if(!this._running){this._running=!0;var e=this;this._startPollTO=setTimeout(function(){e._pollTO=setInterval(function(){e._pollDevice()},1E3*e._pollInterval)},1E3*Math.floor(10*Math.random()+1))}};g.prototype.stop=function(){this._logger.log("trace","stop for device: "+this._deviceID);this._running&&(this._running=!1,this._pollTO&&(clearInterval(this._pollTO),this._pollTO=null),this._startPollTO&&(clearInterval(this._startPollTO),this._startPollTO=null))};g.prototype.immediatelyPoll=function(){this._pollDevice()};
g.prototype._pollDevice=function(){var e=this._pollManager.getHandler().getZway().getDevice(this._deviceID);e?(this._errorCount=0,this._logger.log("trace","poll device:"+this._deviceID),(e=this._findCommandClassesToPoll(this._deviceID,e))&&0<e.length&&this._pollManager._pollCommandClass(e)):(this._logger.log("trace","no such device: "+this._deviceID),this._errorCount++,10<this._errorCount&&(this._logger.log("trace","too many error with no such device, stop poller: "+this._deviceID),this._pollManager.stopPoller(this._deviceID)))};
g.prototype._findCommandClassesToPoll=function(e,h){if(!h||!h.instances)return null;var g=[],a;for(a in h.instances){var b=h.instances[a];if(b&&b.commandClasses)for(var c in b.commandClasses)-1!=l.indexOf(c)&&g.push(e+"."+a+"."+c)}return g};return{_logger:require("x.logger.js").getLogger("x.hub.m.zway.PollManager"),_handler:null,_tasks:[],_pollers:{},_pollWait:200,_pollTO:null,init:function(e,h){this._handler=e;h&&h()},getHandler:function(){return this._handler},startPoller:function(e,h){if(e&&h&&
!(0>h)){if(!this._pollers[e]){var k=new g(this);k.setDeviceID(e);k.setPollInterval(h);this._pollers[e]=k}this._pollers[e].start()}},stopPoller:function(e){if(e){var h=this._pollers[e];h&&(h.stop(),delete this._pollers[e])}},immediatelyPoll:function(e){if(e)for(var h=0;h<e.length;h++){var k=e[h],a=this._pollers[k];a||(a=new g(this),a.setDeviceID(k));a.immediatelyPoll()}},_pollCommandClass:function(e){for(var h=this._tasks.length,g=0;g<e.length;g++){var a=e[g];-1==this._tasks.indexOf(a)&&this._tasks.push(a)}0!=
h||this._pollTO||this._doNextPollTask()},_doNextPollTask:function(){this._pollTO&&(clearTimeout(this._pollTO),this._pollTO=null);var e=this._tasks.shift();if(e){var g=this;this._doGetRequest(e,function(){g._pollTO=setTimeout(function(){g._pollTO=null;g._doNextPollTask()},g._pollWait)})}},_doGetRequest:function(e,g){this._logger.log("trace","do Get() for command class:"+e);var k=this._handler.getZway();if(k){var a=e.split(".");if(!(3>a.length)){var b=this;k._doRunRequest("devices["+a[0]+"].instances["+
a[1]+"].commandClasses["+a[2]+"].Get()",null,function(a){a&&b._logger.log("warn","do Get() for command class:"+e+" error:"+a.message);g&&g()})}}}}}();
x.hub.m.zway.SettingsManager=function(){var l=function(g,e){this._settingsManager=g;this._deviceID=e;this._autoPoll=!1;this._pollInterval=0};l.prototype.init=function(){this.start()};l.prototype.start=function(){this._autoPoll&&0<this._pollInterval&&this._settingsManager._startPoller(this)};l.prototype.stop=function(){this._settingsManager._stopPoller(this)};l.prototype.getDeviceID=function(){return this._deviceID};l.prototype.getPollInterval=function(){return this._pollInterval};l.prototype.toJSON=
function(){return{autoPoll:this._autoPoll,pollInterval:this._pollInterval}};l.prototype.fromJSON=function(g){g&&(this._autoPoll=g.autoPoll?!0:!1,this._pollInterval=g.pollInterval?g.pollInterval:0)};return{ZWAY_FILE:"zwave.json",_logger:require("x.logger.js").getLogger("x.hub.m.zway.SettingsManager"),_handler:null,_settings:{},init:function(g,e){this._logger.log("trace","init");this._handler=g;var h=this;this._loadSettings(function(g,a){g&&h._logger.log("warn","init error:"+g.message);a&&(h._settings=
a,h._initSettings());e&&e()})},setSetting:function(g,e,h){if(this._handler.getZway().getDevice(g)){var k=this._settings[g];k&&k.stop();k=new l(this,g);k.fromJSON(e);this._settings[g]=k;k.start();this._saveSettings(function(a){h&&h(a?a:null,a?null:k)})}else h&&h(Error("no such device:"+g))},getSetting:function(g,e){if(this._handler.getZway().getDevice(g)){var h=this._settings[g];h||(h=new l(this,g));e&&e(null,h)}else e&&e(Error("no such device:"+g))},deleteSetting:function(g,e){if(this._handler.getZway().getDevice(g)){var h=
this._settings[g];h||(h.stop(),delete this._settings[g]);this._saveSettings(e)}else e&&e(Error("no such device:"+g))},_startPoller:function(g){this._handler.startPoller(g.getDeviceID(),g.getPollInterval())},_stopPoller:function(g){this._handler.stopPoller(g.getDeviceID())},_initSettings:function(){for(var g in this._settings){var e=this._settings[g];e&&e.init()}},_loadSettings:function(g){var e=this;this._loadFile(function(h,k){if(h)g&&g(h);else{var a=e._jsonToSettingsMap(k);g&&g(null,a)}})},_jsonToSettingsMap:function(g){if(!g)return{};
var e={},h;for(h in g){var k=g[h];if(k){var a=new l(this,h);a.fromJSON(k);e[h]=a}}return e},_loadFile:function(g){var e=this._getFilePath();fs_extra.ensureFile(e,function(h){h?g&&g(h):fs_extra.readFile(e,"utf8",function(e,a){if(e)g&&g(e);else if(a)try{var b=JSON.parse(a);g&&g(null,b)}catch(c){g&&g(c)}else g&&g(null,{})})})},_getFilePath:function(){var g=fileman.fileManager.getUserRootDataPath();return path.resolve(g,this.ZWAY_FILE)},_saveSettings:function(g){var e=this._settingsMapToJson(this._settings);
this._saveFile(e,function(e){g&&g(e)})},_settingsMapToJson:function(g){if(!g)return{};var e={},h;for(h in g){var k=g[h];k&&(k=k.toJSON(),e[h]=k)}return e},_saveFile:function(g,e){var h=this._getFilePath();fs_extra.writeFile(h,JSON.stringify(g,null,2),function(g){e&&e(g)})}}}();
x.hub.m.zway.ZWay=function(){var l={sendSTAEvent:function(a){var b=require("x.hub.eventbus.js");b.emit("gatewayevent",a,{address:"ZWAVE"},"STA");b.emit("udpevent",a,"STA")}},g={_alarms:{},_alarmEvents:{},setAlarm:function(a,b){this._alarms[a]=b},getAlarm:function(a){return this._alarms[a]},setAlarmEvent:function(a,b){this._alarmEvents[a]=b},getAlarmEvent:function(a){return this._alarmEvents[a]},deleteAlarmEvent:function(a){delete this._alarmEvents[a]}},e=function(a){this.INTERVIEW_TIMEOUT=2E4;this._logger=
require("x.logger.js").getLogger("x.hub.m.zway.ZWay.LearnHander");this._zway=a;this._inclusion=!1;this._inclusionDeviceId=this._inclusionCB=this._inclusionListener=this._inclusionTO=null;this._inclusionInterViewProgress=0;this._inclusionInterViewTO=null;this._exclusion=!1;this._exclusionDeviceId=this._exclusionCB=this._exclusionTO=null;this._updateInterview=this._exclusionAny=!1;this._updateInterviewCommandClassID=this._updateInterviewInstanceID=this._updateInterviewDeviceId=this._updateInterviewListener=
this._updateInterviewCB=this._updateInterviewTO=null;this._updateInterviewProgress=0;var b=this;this._dataUpdateListener=function(a){b._onDataUpdate(a)}};e.prototype.inclusion=function(a,b){var c;if(this._inclusion)c=Error("inclusion process running"),c.code="08001",b&&b(c);else if(this._exclusion)c=Error("exclusion process running"),c.code="08002",b&&b(c);else if(this._updateInterview)c=Error("update interview process running"),c.code="08006",b&&b(c);else{this._logger.log("info","start inclusion");
var d=this;this._inclusionListener=a;this._inclusionCB=b;this._inclusionTO=setTimeout(function(){c=Error("inclusion timeout");c.code="08003";d._inclusionFinish(c)},2E4);this._inclusionListener&&this._inclusionListener(1,0,"start inclusion");this._zway.addDataUpdateListener(this._dataUpdateListener);this._inclusion=!0;this._zway._startInclusion(function(a){a?d._inclusionFinish(a):d._inclusionListener&&d._inclusionListener(2,0,"set device")})}};e.prototype.exclusion=function(a,b){var c;if(this._inclusion)c=
Error("inclusion process running"),c.code="08001",b&&b(c);else if(this._exclusion)c=Error("exclusion process running"),c.code="08002",b&&b(c);else if(this._updateInterview)c=Error("update interview process running"),c.code="08006",b&&b(c);else{this._logger.log("info","start exclusion");var d=this;this._exclusionCB=b;this._exclusionTO=setTimeout(function(){c=Error("exclusion timeout");c.code="08005";d._exclusionFinish(c)},2E4);this._zway.addDataUpdateListener(this._dataUpdateListener);this._exclusion=
!0;-1==a&&(this._exclusionAny=!0);this._zway._startExclusion(function(a){a&&d._exclusionFinish(a)})}};e.prototype.updateInterview=function(a,b,c,d,f){var e;if(this._inclusion)e=Error("inclusion process running"),e.code="08001",f&&f(e);else if(this._exclusion)e=Error("exclusion process running"),e.code="08002",f&&f(e);else if(this._updateInterview)e=Error("update interview process running"),e.code="08006",f&&f(e);else if(a)if(this._zway.getDevice(a)){var g=this._updateInterviewProgress=this._zway.getInterviewProgress(a);
if(100==g)f&&f(null,this._zway.getSimplifiedJSON(a));else{this._logger.log("info","update interview for device:"+a);var h=this;this._updateInterviewCB=f;this._updateInterviewDeviceId=a;this._updateInterviewInstanceID=b;this._updateInterviewCommandClassID=c;this._updateInterviewListener=d;this._updateInterviewTO=setTimeout(function(){e=Error("update interview timeout");e.code="08008";h._updateInterviewFinish(e,h._updateInterviewDeviceId)},1E4);this._zway.addDataUpdateListener(this._dataUpdateListener);
this._updateInterview=!0;this._updateInterviewProgress=g;this._updateInterviewListener&&this._updateInterviewListener(1,g,"start update interview");this._zway._startUpdateInterview(a,b,c,function(a){a&&h._updateInterviewFinish(a)})}}else e=Error("update interview deviceID invalid"),e.code="08006",f&&f(e);else e=Error("update interview deviceID invalid"),e.code="08006",f&&f(e)};e.prototype._inclusionFinish=function(a,b){a?this._logger.log("warn","inclusion finish with error:"+a.stack):this._logger.log("info",
"inclusion finish:"+b);this._inclusionTO&&clearTimeout(this._inclusionTO);this._inclusionInterViewTO&&clearTimeout(this._inclusionInterViewTO);var c=this;this._zway._stopInclusion(function(){c._zway.removeDataUpdateListener(c._dataUpdateListener);var d=c._inclusionCB;c._inclusion=!1;c._inclusionTO=null;c._inclusionListener=null;c._inclusionCB=null;c._inclusionInterViewProgress=0;c._inclusionInterViewTO=null;c._inclusionDeviceId=null;setTimeout(function(){var f=null;b&&(f=c._zway.getSimplifiedJSON(b));
f&&(f.interViewDone=!0);a&&"08004"==a.code&&f&&(a=null,f.interViewDone=!1);d&&d(a,f)},5E3)})};e.prototype._exclusionFinish=function(a,b){a?this._logger.log("warn","exclusion finish with error:"+a.stack):this._logger.log("info","exclusion finish:"+b);this._exclusionTO&&clearTimeout(this._exclusionTO);var c=this;setTimeout(function(){c._zway._stopExclusion(function(){c._zway.removeDataUpdateListener(c._dataUpdateListener);var d=c._exclusionCB;c._exclusion=!1;c._exclusionTO=null;c._exclusionCB=null;
c._exclusionDeviceId=null;c._exclusionAny=!1;d&&d(a,b)})},1E3)};e.prototype._updateInterviewFinish=function(a,b){a?this._logger.log("warn","update interview finish with error:"+a.stack):this._logger.log("info","update interview finish:"+b);var c=null;b&&(c=this._zway.getSimplifiedJSON(b));this._updateInterviewTO&&clearTimeout(this._updateInterviewTO);this._zway.removeDataUpdateListener(this._dataUpdateListener);var d=this._updateInterviewCB;this._updateInterview=!1;this._updateInterviewCommandClassID=
this._updateInterviewInstanceID=this._updateInterviewDeviceId=this._updateInterviewListener=this._updateInterviewCB=this._updateInterviewTO=null;this._updateInterviewProgress=0;d&&d(a,c)};e.prototype._onDataUpdate=function(a){this._logger.log("debug","on data update");this._logger.log("debug",JSON.stringify(a,null,2));a&&(this._inclusion?this._onInclusionDataUpdate(a):this._exclusion?this._onExclusionDataUpdate(a):this._updateInterview&&this._onUpdateInterviewDataUpdate(a))};e.prototype._onInclusionDataUpdate=
function(a){if(!this._inclusionDeviceId&&a["controller.data.lastIncludedDevice"]){var b=a["controller.data.lastIncludedDevice"].value;b&&(this._inclusionDeviceId=b,this._inclusionTO&&(clearTimeout(this._inclusionTO),this._inclusionTO=null),this._inclusionListener&&this._inclusionListener(3,0,"run interview"))}var c=this,d=null;this._inclusionDeviceId&&(d=this._zway.getDevice(this._inclusionDeviceId),this._inclusionInterViewTO||(this._inclusionInterViewTO=setTimeout(function(){var a=Error("interview timeout");
a.code="08004";c._inclusionFinish(a,c._inclusionDeviceId)},this.INTERVIEW_TIMEOUT)));if(d&&d.instances){var f=b=0,e;for(e in d.instances){var g=d.instances[e];if(g&&g.commandClasses)for(var h in g.commandClasses){var k=g.commandClasses[h];k&&k.data&&(k.data.interviewDone&&(b+=1),k.data.interviewDone.value&&(f+=1))}}e=!1;for(var l in a)if(0==l.indexOf("devices."+this._inclusionDeviceId)){e=!0;break}a=0;if(0!=b&&0!=f){a=Math.round(f/b*100);if(a!=this._inclusionInterViewProgress||e)this._inclusionInterViewProgress=
a,this._inclusionInterViewTO&&clearTimeout(this._inclusionInterViewTO),this._inclusionInterViewTO=setTimeout(function(){var a=Error("interview timeout");a.code="08004";c._inclusionFinish(a,c._inclusionDeviceId)},this.INTERVIEW_TIMEOUT);this._logger.log("debug","inclusion progress:"+a);this._inclusionListener&&this._inclusionListener(3,a,"run interview")}100==a&&this._inclusionFinish(null,this._inclusionDeviceId)}};e.prototype._onExclusionDataUpdate=function(a){a["controller.data.lastExcludedDevice"]&&
(a=a["controller.data.lastExcludedDevice"].value,this._exclusionAny?"undefined"!=typeof a&&null!=a&&(this._exclusionDeviceId=a,this._exclusionTO&&(clearTimeout(this._exclusionTO),this._exclusionTO=null),this._exclusionFinish(null,-1)):a&&(this._exclusionDeviceId=a,this._exclusionTO&&(clearTimeout(this._exclusionTO),this._exclusionTO=null),this._exclusionFinish(null,this._exclusionDeviceId)))};e.prototype._onUpdateInterviewDataUpdate=function(a){var b=this;a=this._zway.getInterviewProgress(this._updateInterviewDeviceId);
a!=this._updateInterviewProgress&&(this._updateInterviewProgress=a,this._updateInterviewTO&&clearTimeout(this._updateInterviewTO),this._updateInterviewTO=setTimeout(function(){var a=Error("update interview timeout");a.code="08008";b._updateInterviewFinish(a,b._updateInterviewDeviceId)},1E4));this._logger.log("debug","update interview progress:"+a);this._updateInterviewListener&&this._updateInterviewListener(2,a,"run interview");"undefined"!=typeof this._updateInterviewInstanceID&&null!=this._updateInterviewInstanceID&&
this._updateInterviewCommandClassID?(a=this._zway.listInterviewResults(this._updateInterviewDeviceId))&&a[this._updateInterviewInstanceID]&&a[this._updateInterviewInstanceID].commandClasses&&a[this._updateInterviewInstanceID].commandClasses[this._updateInterviewCommandClassID]&&a[this._updateInterviewInstanceID].commandClasses[this._updateInterviewCommandClassID].interviewDone&&this._updateInterviewFinish(null,this._updateInterviewDeviceId):100==a&&this._updateInterviewFinish(null,this._updateInterviewDeviceId)};
var h={LIST:[37,38,48,49,50,64,66,67,68,69,91,98,113,128,156],getCommandClassFromId:function(a){if(!a)return null;a=parseInt(a);if(isNaN(a)||-1==this.LIST.indexOf(a))return null;switch(a){case 37:return this.SwitchBinary;case 38:return this.SwitchMultilevel;case 48:return this.SensorBinary;case 49:return this.SensorMultilevel;case 50:return this.Meter;case 64:return this.ThermostatMode;case 66:return this.ThermostatOperatingState;case 67:return this.ThermostatSetPoint;case 68:return this.ThermostatFanMode;
case 69:return this.ThermostatFanState;case 91:return this.CentralScene;case 98:return this.DoorLock;case 113:return this.Alarm;case 128:return this.Battery;case 156:return this.AlarmSensor}},SwitchBinary:{buildCMD:function(a,b,c){return a?"on"==a.value?"Set(true)":"off"==a.value?"Set(false)":"toggle"==a.value&&c&&c.data&&c.data.level?(a=c.data.level.value)?"Set(false)":"Set(true)":null:null},resolveState:function(a){return a&&a.data&&a.data.level?[{id:"37",state:a.data.level.value?"on":"off"}]:null},
getSimplifiedJSON:function(a){return a&&a.data&&a.data.level&&"SwitchBinary"==a.name?{37:{type:a.name,valueType:a.data.level.type}}:null}},SwitchMultilevel:{buildCMD:function(a,b,c){if(!a)return null;b=null;8<a.value.length&&"toggleTo"==a.value.substr(0,8)?(b=a.value.substr(8),a.value="toggleTo",a.ext=b):7<a.value.length&&"valueTo"==a.value.substr(0,7)&&(b=a.value.substr(7),a.value="valueTo",a.ext=b);var d;switch(a.value){case "on":return"Set(255,0)";case "off":return c&&c.data&&(c.data.level={value:0}),
"Set(0,0)";case "toggle":if(c&&c.data&&c.data.level){if(d=c.data.level.value)c.data.level={value:0};return d?"Set(0,0)":"Set(255,0)"}break;case "toggleTo":if("undefined"==typeof a.ext||null==a.ext)break;if(c&&c.data&&c.data.level){if(d=c.data.level.value)return"Set(0,0)";d=Math.round(parseInt(a.ext)/100*99);99<d&&(d=99);0>d&&(d=0);c&&c.data&&(c.data.level={value:d});return"Set("+d+",0)"}break;case "stop":return"StopLevelChange()";case "up":return"Set(99)";case "down":return"Set(0)";case "stepUp":b=
5;if("undefined"!=typeof a.ext||null!=a.ext)b=parseInt(a.ext);if(c&&c.data&&c.data.level)return d=c.data.level.value,d=Math.round(parseInt(d)/99*100),d+=b,100<d&&(d=100),d=Math.round(parseInt(d)/100*99),c&&c.data&&(c.data.level={value:d}),"Set("+d+",0)";break;case "stepDown":b=5;if("undefined"!=typeof a.ext||null!=a.ext)b=parseInt(a.ext);if(c&&c.data&&c.data.level)return d=c.data.level.value,d=Math.round(parseInt(d)/99*100),d-=b,0>d&&(d=0),d=Math.round(parseInt(d)/100*99),c&&c.data&&(c.data.level=
{value:d}),"Set("+d+",0)";break;case "valueTo":if("undefined"==typeof a.ext||null==a.ext)break;d=Math.round(parseInt(a.ext)/100*99);99<d&&(d=99);0>d&&(d=0);c&&c.data&&(c.data.level={value:d});return"Set("+d+",0)"}return null},resolveState:function(a){if(!a||!a.data||!a.data.level)return null;var b=a.data.level.value,b=Math.round(parseInt(a.data.level.value)/99*100);return[{id:"38",state:b}]},getSimplifiedJSON:function(a){return a&&a.data&&a.data.level&&"SwitchMultilevel"==a.name?{38:{type:a.name,
valueType:a.data.level.type}}:null}},SensorMultilevel:{resolveState:function(a){if(!a||!a.data)return null;var b=null,c;for(c in a.data){var d=parseInt(c);if(!isNaN(d)){var f=a.data[c];f&&f.val&&(b||(b=[]),b.push({id:"49."+d,state:f.val.value}))}}return b},getSimplifiedJSON:function(a){if(!a||!a.data||"SensorMultilevel"!=a.name)return null;var b=null,c;for(c in a.data){var d=parseInt(c);isNaN(d)||(d=a.data[c])&&d.sensorTypeString&&d.scaleString&&d.val&&(b||(b={}),b["49."+c]={name:d.sensorTypeString.value,
unit:d.scaleString.value,valueType:d.val.type,type:"SensorMultilevel"})}return b}},SensorBinary:{resolveState:function(a){if(!a||!a.data)return null;var b=null,c;for(c in a.data){var d=parseInt(c);if(!isNaN(d)){var f=a.data[c];f&&f.level&&(b||(b=[]),b.push({id:"48."+d,state:f.level.value}))}}return b},getSimplifiedJSON:function(a){if(!a||!a.data||"SensorBinary"!=a.name)return null;var b=null,c;for(c in a.data){var d=parseInt(c);isNaN(d)||(d=a.data[c])&&d.sensorTypeString&&d.level&&(b||(b={}),b["48."+
c]={name:d.sensorTypeString.value,type:"SensorBinary"})}return b}},Meter:{buildCMD:function(a,b,c){return a?"reset"==a.value?"Reset()":null:null},resolveState:function(a){if(!a||!a.data)return null;var b=null,c;for(c in a.data){var d=parseInt(c);if(!isNaN(d)){var f=a.data[c];f&&f.val&&(b||(b=[]),b.push({id:"50."+d,state:f.val.value}))}}return b},getSimplifiedJSON:function(a){if(!a||!a.data||"Meter"!=a.name)return null;var b=null,c;for(c in a.data){var d=parseInt(c);isNaN(d)||(d=a.data[c])&&d.sensorTypeString&&
d.scaleString&&d.val&&(b||(b={}),b["50."+c]={name:d.sensorTypeString.value,unit:d.scaleString.value,valueType:d.val.type,type:"Meter"})}return b}},ThermostatSetPoint:{buildCMD:function(a,b,c){if(!a)return null;var d=null;5<a.value.length&&"setTo"==a.value.substr(0,5)?(d=a.value.substr(5),a.value="setTo",a.ext=d):2<a.value.length&&"up"==a.value.substr(0,2)?(d=a.value.substr(2),a.value="up",a.ext=d):4<a.value.length&&"down"==a.value.substr(0,4)&&(d=a.value.substr(4),a.value="down",a.ext=d);b=b[b.length-
1];var f;switch(a.value){case "up":d=.5;if("undefined"!=typeof a.ext||null!=a.ext)d=parseFloat(a.ext);if(c&&c.data&&c.data[b]&&c.data[b].setVal)return a=c.data[b],f=a.setVal.value,f+=d,a.max&&f>a.max.value&&(f=a.max.value),c.data[b].setVal.value=f,"Set("+b+","+f+")";break;case "down":d=.5;if("undefined"!=typeof a.ext||null!=a.ext)d=parseFloat(a.ext);if(c&&c.data&&c.data[b]&&c.data[b].setVal)return a=c.data[b],f=a.setVal.value,f-=d,a.min&&f<a.min.value&&(f=a.min.value),c.data[b].setVal.value=f,"Set("+
b+","+f+")";break;case "setTo":if("undefined"==typeof a.ext||null==a.ext)break;f=parseFloat(a.ext);if(c&&c.data&&c.data[b]&&c.data[b].setVal)return c.data[b].setVal.value=f,"Set("+b+","+f+")"}return null},resolveState:function(a){if(!a||!a.data)return null;var b=null,c;for(c in a.data){var d=parseInt(c);if(!isNaN(d)){var f=a.data[c];if(f&&f.val){var e=f.val.value,e=f.setVal?e+(":"+f.setVal.value):e+(":"+e);b||(b=[]);b.push({id:"67."+d,state:e})}}}return b},getSimplifiedJSON:function(a){if(!a||!a.data||
"ThermostatSetPoint"!=a.name)return null;var b=null,c;for(c in a.data){var d=parseInt(c);if(!isNaN(d)&&(d=a.data[c])&&d.modeName&&d.scaleString&&d.val){b||(b={});var f={name:d.modeName.value,unit:d.scaleString.value,valueType:d.val.type,type:"ThermostatSetPoint"};d.min&&(f.min=d.min.value);d.max&&(f.max=d.max.value);b["67."+c]=f}}return b}},ThermostatMode:{_MODES:["OFF","HEAT","COOL","AUTO","AUXILIARY_HEAT","RESUME","FAN_ONLY","FURNACE","DRY_AIR","MOIST","AUTO_CHANGEOVER","ENERGY_SAVE_HEAT","ENERGY_SAVE_COOL",
"AWAY",null,"FULL_POWER"],buildCMD:function(a,b,c){if(!a)return null;b=null;13<a.value.length&&"setThermoMode"==a.value.substr(0,13)&&(b=a.value.substr(13),a.value="setThermoMode",a.ext=b);switch(a.value){case "thermoModeOff":return"Set(0)";case "thermoModeHeat":return"Set(1)";case "thermoModeCool":return"Set(2)";case "thermoModeAuto":return"Set(3)";case "setThermoMode":return"Set("+a.ext+")"}return null},resolveState:function(a){if(!a||!a.data||!a.data.mode)return null;var b=[];b.push({id:"64",state:a.data.mode.value});
return b},getSimplifiedJSON:function(a){if(!a||!a.data||"ThermostatMode"!=a.name)return null;var b=null,c;for(c in a.data){var d=parseInt(c);isNaN(d)||(d=a.data[c])&&d.modeName&&d.modeName.value&&(b||(b={}),b[c]=d.modeName.value)}return{64:{type:"ThermostatMode",valueType:"int",modes:b}}}},ThermostatOperatingState:{_MODES:"IDLE HEATING COOLING FAN_ONLY PENDING_HEAT PENDING_COOL VENT_ECONOMIZER AUX_HEATING 2ND_STAGE_HEATING 2ND_STAGE_COOLING 2ND_STAGE_AUX_HEAT 3RD_STAGE_AUX_HEAT".split(" "),resolveState:function(a){if(!a||
!a.data||!a.data.state)return null;var b=[];b.push({id:"66",state:a.data.state.value});return b},getSimplifiedJSON:function(a){return a&&a.data&&"ThermostatOperatingState"==a.name?{66:{type:"ThermostatOperatingState",valueType:a.data.state.type}}:null}},ThermostatFanMode:{_MODES:"AUTO_LOW LOW AUTO_HIGH HIGH AUTO_MEDIUM MEDIUM CIRCULATION HUMIDITY LEFT_RIGHT UP_DOWN QUIET 3RD_STAGE_AUX_HEAT".split(" "),buildCMD:function(a,b,c){if(!a)return null;b=null;16<a.value.length&&"setThermoFanMode"==a.value.substr(0,
16)&&(b=a.value.substr(16),a.value="setThermoFanMode",a.ext=b);b=1;b="Off"==a.ext?0:1;switch(a.value){case "thermoFanModeAutoLow":return"Set("+b+",0)";case "thermoFanModeLow":return"Set("+b+",1)";case "thermoFanModeAutoHigh":return"Set("+b+",2)";case "thermoFanModeHigh":return"Set("+b+",3)";case "setThermoFanMode":return b?"Set("+b+","+a.ext+")":"Set("+b+",1)"}return null},resolveState:function(a){if(!a||!a.data||!a.data.mode)return null;var b=[],c={id:"68",state:a.data.mode.value};a.data&&a.data.on&&
!a.data.on.value&&(c={id:"68",state:"off"});b.push(c);return b},getSimplifiedJSON:function(a){if(!a||!a.data||"ThermostatFanMode"!=a.name)return null;var b=null,c;for(c in a.data){var d=parseInt(c);isNaN(d)||(d=a.data[c])&&d.modeName&&d.modeName.value&&(b||(b={}),b[c]=d.modeName.value)}return{68:{type:"ThermostatFanMode",valueType:"int",modes:b}}}},ThermostatFanState:{resolveState:function(a){if(!a||!a.data||!a.data.state)return null;var b=[];b.push({id:"69",state:a.data.state.value?"on":"off"});
return b},getSimplifiedJSON:function(a){return a&&a.data&&"ThermostatFanState"==a.name?{69:{type:"ThermostatFanState"}}:null}},CentralScene:{resolveState:function(a,b,c){if(!(a&&a.data&&a.data.currentScene&&a.data.keyAttribute))return null;var d=a.data.currentScene.value;if(d){var f=null;switch(a.data.keyAttribute.value){case 0:f="press";break;case 1:f="release";break;case 2:f="hold"}if(!f)return null;a={};a[c+"."+b+".91."+d]=f;l.sendSTAEvent({type:"ZWAVE2",adr:c,state:a});return null}},getSimplifiedJSON:function(a){if(!a||
!a.data||!a.data.maxScenes||"CentralScene"!=a.name)return null;var b={};a=a.data.maxScenes.value;for(var c=1;c<=a;c++)b["91."+c]={name:"Key "+c,type:"CentralScene"};return b}},Alarm:{_EVNETS:{1:{1:"Smoke",2:"Smoke",3:"Smoke Alarm Test",4:"Replacement",5:"Replacement End-of-life",6:"Alarm Silenced",7:"Maintenance",8:"Maintenance Dust"},2:{1:"CO",2:"CO",3:"CO Test",4:"Replacement",5:"Replacement End-of-life",6:"Alarm Silenced",7:"Maintenance"},3:{1:"CO2",2:"CO2",3:"CO Test",4:"Replacement",5:"Replacement End-of-life",
6:"Alarm Silenced",7:"Maintenance"},4:{1:"Overheat",2:"Overheat",3:"Rapid Temperature Rise",4:"Rapid Temperature Rise",5:"Under Heat",6:"Under Heat",7:"Heat Alarm Test",8:"Replacement End-of-life",9:"Alarm Silenced",10:"Maintenance Dust",11:"Maintenance"},5:{1:"Water Leak",2:"Water Leak",3:"Water Level Dropped",4:"Water Level Dropped",5:"Replace Water Filter",6:"Water Flow Alarm",7:"Water Pressure Alarm"},6:{1:"Manual Lock",2:"Manual Unlock",3:"RF Lock",4:"RF Unlock",5:"Keypad Lock",6:"Keypad Unlock",
7:"Manual Not Fully Locked",8:"RF Not Fully Locked",9:"Auto Lock Locked",10:"Auto Lock Not Fully Locked",11:"Lock Jammed",22:"Contact Opened",23:"Contact Closed"},7:{1:"Intrusion",2:"Intrusion",3:"Tampering",4:"Tampering",5:"Glass Breakage",6:"Glass Breakage",7:"Motion Detection",8:"Motion Detection",9:"Motion Detection"},8:{1:"Replace battery soon",2:"Replace battery now",3:"Charge battery soon",4:"Charge battery now"}},buildCMD:function(a,b,c){if(!a||!b)return null;b=b[b.length-1];if("on"==a.value)return"Set("+
b+",255)";if("off"==a.value)return"Set("+b+",0)";if("toggle"==a.value){if(c&&c.data&&c.data[b]&&(c=c.data[b].status))return(c=c.value)?"Set("+b+",0)":"Set("+b+",255)"}else if("resetAlarm"==a.value){if(c&&c.data)for(b in c.data)if(a=parseInt(b),!isNaN(a)){var d=c.data[b];if(d&&d.status&&(g.setAlarmEvent("113."+a,0),d.event&&d.event.value&&(g.setAlarm("113."+a+"."+d.event.value,!1),d.event.value=null),d.eventMask&&d.eventMask.value))for(var f=1;24>f;f++)d.eventMask.value>>f&1&&g.getAlarm("113."+a+"."+
f,!1)}return-1}return null},resolveState:function(a){if(!a||!a.data)return null;var b=null,c;for(c in a.data){var d=parseInt(c);if(!isNaN(d)){var f=a.data[c];if(f&&f.status){b||(b=[]);var e={id:"113."+d,state:f.status.value?"on":"off"};b.push(e);if(f.event)if(g.setAlarmEvent("113."+d,f.event.value),e={id:"113."+d+".event",state:f.event.value},b.push(e),f.event.value&&this._EVNETS[d]&&this._EVNETS[d][f.event.value]?b.push({id:"113."+d+".eventName",state:this._EVNETS[d][f.event.value]}):0==f.event.value&&
b.push({id:"113."+d+".eventName",state:"No Alarm"}),f.event.value)g.setAlarm("113."+d+"."+f.event.value,!0);else if(0==f.event.value&&f.eventParameters&&f.eventParameters.value)if(e=f.eventParameters.value,0==e.length){if(f.eventMask&&f.eventMask.value)for(var h=1;24>h;h++)(e=f.eventMask.value>>h&1)&&g.setAlarm("113."+d+"."+h,!1)}else for(h=0;h<e.length;h++)g.setAlarm("113."+d+"."+e[h],!1);if(f.eventMask&&f.eventMask.value)for(h=1;24>h;h++)if(e=f.eventMask.value>>h&1){var e={id:"113."+d+"."+h,state:!1},
k=g.getAlarm("113."+d+"."+h);k&&(e.state=k);b.push(e)}}}}return b},getSimplifiedJSON:function(a){if(!a||!a.data||"Alarm"!=a.name)return null;var b=null,c;for(c in a.data){var d=parseInt(c);if(!isNaN(d)){var f=a.data[c];if(f&&f.typeString&&f.status&&(b||(b={}),b["113."+c]={name:f.typeString.value,subtype:c,type:"Alarm"},f.eventMask&&f.eventMask.value))switch(f=f.eventMask.value,d){case 1:f&2&&(b["113."+c+".1"]={name:"Smoke",eventID:1,type:"Alarm.Event"});f&4&&(b["113."+c+".2"]={name:"Smoke",eventID:2,
type:"Alarm.Event"});f&8&&(b["113."+c+".3"]={name:"Smoke Alarm Test",eventID:3,type:"Alarm.Event"});f&16&&(b["113."+c+".4"]={name:"Replacement",eventID:4,type:"Alarm.Event"});f&32&&(b["113."+c+".5"]={name:"Replacement End-of-life",eventID:5,type:"Alarm.Event"});f&64&&(b["113."+c+".6"]={name:"Alarm Silenced",eventID:6,type:"Alarm.Event"});f&128&&(b["113."+c+".7"]={name:"Maintenance",eventID:7,type:"Alarm.Event"});f&256&&(b["113."+c+".8"]={name:"Maintenance Dust",eventID:7,type:"Alarm.Event"});break;
case 2:f&2&&(b["113."+c+".1"]={name:"CO",eventID:1,type:"Alarm.Event"});f&4&&(b["113."+c+".2"]={name:"CO",eventID:2,type:"Alarm.Event"});f&8&&(b["113."+c+".3"]={name:"CO Test",eventID:3,type:"Alarm.Event"});f&16&&(b["113."+c+".4"]={name:"Replacement",eventID:4,type:"Alarm.Event"});f&32&&(b["113."+c+".5"]={name:"Replacement End-of-life",eventID:5,type:"Alarm.Event"});f&64&&(b["113."+c+".6"]={name:"Alarm Silenced",eventID:6,type:"Alarm.Event"});f&128&&(b["113."+c+".7"]={name:"Maintenance",eventID:7,
type:"Alarm.Event"});break;case 3:f&2&&(b["113."+c+".1"]={name:"CO2",eventID:1,type:"Alarm.Event"});f&4&&(b["113."+c+".2"]={name:"CO2",eventID:2,type:"Alarm.Event"});f&8&&(b["113."+c+".3"]={name:"CO2 Test",eventID:3,type:"Alarm.Event"});f&16&&(b["113."+c+".4"]={name:"Replacement",eventID:4,type:"Alarm.Event"});f&32&&(b["113."+c+".5"]={name:"Replacement End-of-life",eventID:5,type:"Alarm.Event"});f&64&&(b["113."+c+".6"]={name:"Alarm Silenced",eventID:6,type:"Alarm.Event"});f&128&&(b["113."+c+".7"]=
{name:"Maintenance",eventID:7,type:"Alarm.Event"});break;case 4:f&2&&(b["113."+c+".1"]={name:"Overheat",eventID:1,type:"Alarm.Event"});f&4&&(b["113."+c+".2"]={name:"Overheat",eventID:2,type:"Alarm.Event"});f&8&&(b["113."+c+".3"]={name:"Rapid Temperature Rise",eventID:3,type:"Alarm.Event"});f&16&&(b["113."+c+".4"]={name:"Rapid Temperature Rise",eventID:4,type:"Alarm.Event"});f&32&&(b["113."+c+".5"]={name:"Under Heat",eventID:5,type:"Alarm.Event"});f&64&&(b["113."+c+".6"]={name:"Under Heat",eventID:6,
type:"Alarm.Event"});f&128&&(b["113."+c+".7"]={name:"Heat Alarm Test",eventID:7,type:"Alarm.Event"});f&256&&(b["113."+c+".8"]={name:"Replacement End-of-life",eventID:8,type:"Alarm.Event"});f&512&&(b["113."+c+".9"]={name:"Alarm Silenced",eventID:9,type:"Alarm.Event"});f&1024&&(b["113."+c+".10"]={name:"Maintenance Dust",eventID:10,type:"Alarm.Event"});f&2048&&(b["113."+c+".11"]={name:"Maintenance",eventID:11,type:"Alarm.Event"});break;case 5:f&2&&(b["113."+c+".1"]={name:"Water Leak",eventID:1,type:"Alarm.Event"});
f&4&&(b["113."+c+".2"]={name:"Water Leak",eventID:2,type:"Alarm.Event"});f&8&&(b["113."+c+".3"]={name:"Water Level Dropped",eventID:3,type:"Alarm.Event"});f&16&&(b["113."+c+".4"]={name:"Water Level Dropped",eventID:4,type:"Alarm.Event"});f&32&&(b["113."+c+".5"]={name:"Replace Water Filter",eventID:5,type:"Alarm.Event"});f&64&&(b["113."+c+".6"]={name:"Water Flow Alarm",eventID:6,type:"Alarm.Event"});f&128&&(b["113."+c+".7"]={name:"Water Pressure Alarm",eventID:7,type:"Alarm.Event"});break;case 6:f&
2&&(b["113."+c+".1"]={name:"Manual Lock",eventID:1,type:"Alarm.Event"});f&4&&(b["113."+c+".2"]={name:"Manual Unlock",eventID:2,type:"Alarm.Event"});f&8&&(b["113."+c+".3"]={name:"RF Lock",eventID:3,type:"Alarm.Event"});f&16&&(b["113."+c+".4"]={name:"RF Unlock",eventID:4,type:"Alarm.Event"});f&32&&(b["113."+c+".5"]={name:"Keypad Lock",eventID:5,type:"Alarm.Event"});f&64&&(b["113."+c+".6"]={name:"Keypad Unlock",eventID:6,type:"Alarm.Event"});f&128&&(b["113."+c+".7"]={name:"Manual Not Fully Locked",eventID:7,
type:"Alarm.Event"});f&256&&(b["113."+c+".8"]={name:"RF Not Fully Locked",eventID:8,type:"Alarm.Event"});f&512&&(b["113."+c+".9"]={name:"Auto Lock Locked",eventID:9,type:"Alarm.Event"});f&1024&&(b["113."+c+".10"]={name:"Auto Lock Not Fully Locked",eventID:10,type:"Alarm.Event"});f&2048&&(b["113."+c+".11"]={name:"Lock Jammed",eventID:11,type:"Alarm.Event"});f&4194304&&(b["113."+c+".22"]={name:"Contact Opened",eventID:22,type:"Alarm.Event"});f&8388608&&(b["113."+c+".23"]={name:"Contact Closed",eventID:23,
type:"Alarm.Event"});break;case 7:f&2&&(b["113."+c+".1"]={name:"Intrusion",eventID:1,type:"Alarm.Event"});f&4&&(b["113."+c+".2"]={name:"Intrusion",eventID:2,type:"Alarm.Event"});f&8&&(b["113."+c+".3"]={name:"Tampering",eventID:3,type:"Alarm.Event"});f&16&&(b["113."+c+".4"]={name:"Tampering",eventID:4,type:"Alarm.Event"});f&32&&(b["113."+c+".5"]={name:"Glass Breakage",eventID:5,type:"Alarm.Event"});f&64&&(b["113."+c+".6"]={name:"Glass Breakage",eventID:6,type:"Alarm.Event"});f&128&&(b["113."+c+".7"]=
{name:"Motion Detection",eventID:7,type:"Alarm.Event"});f&256&&(b["113."+c+".8"]={name:"Motion Detection",eventID:8,type:"Alarm.Event"});f&512&&(b["113."+c+".9"]={name:"Tampering, Product Moved",eventID:9,type:"Alarm.Event"});break;case 8:f&&(b["113."+c+".10"]={name:"Replace battery soon",eventID:10,type:"Alarm.Event"}),f&&(b["113."+c+".11"]={name:"Replace battery now",eventID:11,type:"Alarm.Event"}),f&&(b["113."+c+".14"]={name:"Charge battery soon",eventID:14,type:"Alarm.Event"}),f&&(b["113."+c+
".15"]={name:"Charge battery now",eventID:15,type:"Alarm.Event"})}}}return b}},Battery:{resolveState:function(a){return a&&a.data&&a.data.last?[{id:"128",state:a.data.last.value}]:null},getSimplifiedJSON:function(a){return a&&a.data&&"Battery"==a.name?{128:{name:"Battery",valueType:"int",type:"Battery"}}:null}},AlarmSensor:{resolveState:function(a){if(!a||!a.data)return null;var b=null,c;for(c in a.data){var d=parseInt(c);if(!isNaN(d)){var f=a.data[c];f&&f.sensorState&&(b||(b=[]),b.push({id:"156."+
d,state:f.sensorState.value?"on":"off"}))}}return b},getSimplifiedJSON:function(a){if(!a||!a.data||"AlarmSensor"!=a.name)return null;var b=null,c;for(c in a.data){var d=parseInt(c);isNaN(d)||(d=a.data[c])&&d.typeString&&(b||(b={}),b["156."+c]={name:d.typeString.value,subtype:c,type:"AlarmSensor"})}return b}},DoorLock:{_MODE:{0:"unlock",1:"unlock_with_timeout",16:"inside_handle_unlock",17:"inside_handle_unlock_with_timeout",32:"outside_handle_unlock",33:"outside_handle_unlock_with_timeout",254:"unknown",
255:"lock"},buildCMD:function(a,b,c){if(!a)return null;b=null;8<a.value.length&&"toggleTo"==a.value.substr(0,8)?(b=a.value.substr(8),a.value="toggleTo",a.ext=b):7<a.value.length&&"valueTo"==a.value.substr(0,7)&&(b=a.value.substr(7),a.value="valueTo",a.ext=b);switch(a.value){case "unlock":return"Set(0)";case "unlock_with_timeout":return"Set(1)";case "inside_handle_unlock":return"Set(16)";case "inside_handle_unlock_with_timeout":return"Set(17)";case "outside_handle_unlock":return"Set(32)";case "outside_handle_unlock_with_timeout":return"Set(33)";
case "lock":return"Set(255)"}return null},resolveState:function(a){if(!a||!a.data)return null;var b=[];if(a.data.mode){var c=this._MODE[a.data.mode.value];c&&b.push({id:"98.mode",state:c})}a.data.opType&&b.push({id:"98.op_mode",state:1==a.data.opType.value?"constant":"autolock"});return 0==b.length?null:b},getSimplifiedJSON:function(a){return a&&a.data&&"DoorLock"==a.name?{98:{name:"DoorLock",type:a.name}}:null}}},k=function(a,b){this._logger=require("x.logger.js").getLogger("x.hub.m.zway.ZWay");
this._learnHandler=new e(this);this._ip=a;this._port=b;this._data=null;this._dataUpdateListeners=[];this._dataUpdateRunning=!1;this._dataUpdateCB=[];this._dataUpdatePeriod=1E3;this._dataUpdateTO=null;this._dataFullRunning=!1;this._dataFullCB=[];this._dataFullPeriod=1E4;this._running=!1};k.prototype.start=function(a){this._running||(this._running=!0,this._getDataFull());a&&a()};k.prototype.stop=function(a){this._running&&(this._running=!1);this._dataUpdateTO&&(clearTimeout(this._dataUpdateTO),this._dataUpdateTO=
null);a&&a()};k.prototype.addDataUpdateListener=function(a){a&&-1==this._dataUpdateListeners.indexOf(a)&&this._dataUpdateListeners.push(a)};k.prototype.removeDataUpdateListener=function(a){a&&(a=this._dataUpdateListeners.indexOf(a),-1!=a&&this._dataUpdateListeners.splice(a,1))};k.prototype.getData=function(){return this._data};k.prototype.getDevices=function(){return this._data&&this._data.devices?this._data.devices:null};k.prototype.getDevice=function(a){return a&&this._data&&this._data.devices?
this._data.devices[a]:null};k.prototype.getSimplifiedJSON=function(a){if(!this._data||!this._data.devices||!this._data.devices[a])return null;var b=this._data.devices[a];if(!b.data||!b.instances)return null;var c=b.data,d={};d.id=a;d.basicType=c.basicType?c.basicType.value:null;d.genericType=c.genericType?c.genericType.value:null;d.specificType=c.specificType?c.specificType.value:null;d.type=c.deviceTypeString?c.deviceTypeString.value:null;d.vendor=c.vendorString?c.vendorString.value:null;d.name=
c.givenName?c.givenName.value:null;d.interViewProgress=this.getInterviewProgress(a);c=this.listInterviewResults(a);d.instanceInterViewProgress={};for(var f in c)if(c[f]&&c[f].commandClasses){a=c[f].commandClasses;var e=0,g=0,k;for(k in a)e+=1,a[k]&&a[k].interviewDone&&(g+=1);d.instanceInterViewProgress[f]=Math.round(100*g/e)}d.instance={};b=b.instances;for(f in b)if((a=b[f])&&a.commandClasses){d.instance[f]={commandClasses:{}};a=a.commandClasses;for(var l in a)if(k=a[l])if(c=null,(e=h.getCommandClassFromId(l))&&
(c=e.getSimplifiedJSON(k)),c)for(var m in c)d.instance[f].commandClasses[m]=c[m]}return d};k.prototype.getInterviewProgress=function(a){a=this.getDevice(a);if(!a)return-1;var b=0,c=0,d;for(d in a.instances){var f=a.instances[d];if(f&&f.commandClasses)for(var e in f.commandClasses){var g=f.commandClasses[e];g&&g.data&&(g.data.interviewDone&&(b+=1),g.data.interviewDone.value&&(c+=1))}}return Math.round(c/b*100)};k.prototype.listInterviewResults=function(a){a=this.getDevice(a);if(!a)return null;var b=
{},c;for(c in a.instances){var d=a.instances[c];if(d&&d.commandClasses)for(var f in d.commandClasses){var e=d.commandClasses[f];e&&e.data&&e.data.interviewDone&&(b[c]||(b[c]={commandClasses:{}}),b[c].commandClasses[f]={interviewDone:e.data.interviewDone.value})}}return b};k.prototype.executeCommand=function(a,b,c){if(a&&b){b.value||(b={value:b});var d=a.split(".");if(3>d.length)c&&c(Error("address invalid"));else if(this._data&&this._data.devices){var f=this._data.devices[d[0]];if(f)if(f.instances&&
f.instances[d[1]]){var e=f.instances[d[1]];if(e.commandClasses&&e.commandClasses[d[2]]){var g=e.commandClasses[d[2]],e=null,k=h.getCommandClassFromId(d[2]);k&&(e=k.buildCMD(b,d,g));if(e)if(-1==e)c&&c();else{b="devices["+d[0]+"].instances["+d[1]+"].commandClasses["+d[2]+"].";var l=this;this._doRunRequest(b+e,null,function(b){b||l._postCommandExecution(f,a);c&&c(b)})}else c&&c(Error("command invalid"))}else c&&c(Error("no such command class:"+d[2]))}else c&&c(Error("no such instance:"+d[1]));else c&&
c(Error("no such device with id:"+d[0]))}else c&&c(Error("initialization not finish"))}else c&&c(Error("address or command is null"))};k.prototype._postCommandExecution=function(a,b){if(a&&b&&a.data&&a.data.vendorString&&"Fibaro"==a.data.vendorString.value){var c=b.split(".");"64"!=c[2]&&"67"!=c[2]||setTimeout(function(){x.hub.m.zway.PollManager._pollCommandClass([b])},2E3)}};k.prototype.getStates=function(a){var b=this._getStates();a&&a(null,b)};k.prototype._getStates=function(){if(!this._data||
!this._data.devices)return{};var a={},b;for(b in this._data.devices)if(1!=b){var c=this._getState(b);if(c)for(var d in c)a[d]=c[d]}return a};k.prototype._getState=function(a){return this._data&&this._data.devices?this._resolveDeviceState(a,this._data.devices[a]):null};k.prototype._resolveDeviceState=function(a,b){if(!b)return null;var c={};if(b&&b.instances)for(var d in b.instances){var f=b.instances[d];if(f.commandClasses)for(var e in f.commandClasses){var g=f.commandClasses[e],k=null,l=h.getCommandClassFromId(e);
l&&(k=l.resolveState(g,d,a));if(k)for(g=0;g<k.length;g++){var m=l=null;k[g].id&&(l=a+"."+d+"."+k[g].id);"undefined"!=typeof k[g].state&&null!=k[g].state&&(m=k[g].state);l&&"undefined"!=typeof m&&null!=m&&(c[a]||(c[a]={}),c[a][l]=m)}}}return c};k.prototype.inclusion=function(a,b){this._learnHandler.inclusion(a,b)};k.prototype.exclusion=function(a,b){this._learnHandler.exclusion(a,b)};k.prototype.updateInterview=function(a,b,c,d,f){this._learnHandler.updateInterview(a,b,c,d,f)};k.prototype.resetController=
function(a){this._resetController(a)};k.prototype.pollDataUpdate=function(){this._data?this._getDataUpdate():this._getDataFull()};k.prototype._onDataUpdate=function(a){if(this._running){var b=this;this._dataUpdateTO&&clearTimeout(this._dataUpdateTO);this._dataUpdateTO=setTimeout(function(){b.pollDataUpdate()},this._dataUpdatePeriod);if(a){var c=Object.keys(a);1<c.length&&this._logger.log("info","get data update:"+JSON.stringify(a));var d=null;c.forEach(function(c){if("updateTime"==c)b._data[c]=a[c];
else if("devices"==c)b._data.devices=a[c];else{var e=c.split(".");if(2<e.length&&"devices"==e[0]){var g=e[1],h=b._data.devices[g];d||(d={});d[g]||(d[g]={device:h,updates:{}});d[g].updates[c]=a[c]}g=b._data;for(h=0;h<e.length-1;){g=g[e[h]];if(!g)break;h++}g&&(g[e[e.length-1]]=a[c])}});d&&this._onDeviceEvent(d);this._dataUpdateListeners.forEach(function(c){c&&c(a)})}}};k.prototype._onDataFull=function(a){if(this._running){this._logger.log("info","get data full:"+JSON.stringify(a));var b=this;this._dataUpdateTO&&
clearTimeout(this._dataUpdateTO);var c=this._dataUpdatePeriod;a||(c=this._dataFullPeriod);this._dataUpdateTO=setTimeout(function(){b.pollDataUpdate()},c);this._data=a}};k.prototype._onDeviceEvent=function(a){if(a)for(var b in a){var c=a[b];if(c&&c.updates){var d=!1,f;for(f in c.updates)for(var c=f.split("."),e=0;e<c.length;e++)if("commandClasses"==c[e]&&e+1!=c.length){var g=parseInt(c[e+1]);if(-1!=h.LIST.indexOf(g)){d=!0;break}}d&&(d=this._getState(b))&&d[b]&&l.sendSTAEvent({type:"ZWAVE2",adr:b,state:d[b]})}}};
k.prototype._startInclusion=function(a){var b=this;this._doRunRequest("controller.AddNodeToNetwork(1)",null,function(c,d,f){c?b._logger.log("warn","start include device error:"+c.stack):200!=f?(c=Error("start include device http response code:"+f),b._logger.log("warn","start include device  http error:"+f+" data:"+d)):b._logger.log("debug","start include device success:"+d);a&&a(c,d)})};k.prototype._stopInclusion=function(a){var b=this;this._doRunRequest("controller.AddNodeToNetwork(0)",null,function(c,
d,f){c?b._logger.log("warn","stop include device error:"+c.stack):200!=f?(c=Error("stop include device http response code:"+f),b._logger.log("warn","stop include device  http error:"+f+" data:"+d)):b._logger.log("debug","stop include device success:"+d);a&&a(c,d)})};k.prototype._startExclusion=function(a){var b=this;this._doRunRequest("controller.RemoveNodeFromNetwork(1)",null,function(c,d,f){c?b._logger.log("warn","start exclude device error:"+c.stack):200!=f?(c=Error("start exclude device http response code:"+
f),b._logger.log("warn","start exclude device http error:"+f+" data:"+d)):b._logger.log("debug","start exclude device success:"+d);a&&a(c,d)})};k.prototype._stopExclusion=function(a){var b=this;this._doRunRequest("controller.RemoveNodeFromNetwork(0)",null,function(c,d,f){c?b._logger.log("warn","stop exclude device error:"+c.stack):200!=f?(c=Error("stop exclude device http response code:"+f),b._logger.log("warn","stop exclude device http error:"+f+" data:"+d)):b._logger.log("debug","stop exclude device success:"+
d);a&&a(c,d)})};k.prototype._startUpdateInterview=function(a,b,c,d){var f=this.getDevice(a);if(f){var e=[];if("undefined"!=typeof b&&null!=b&&c)e.push({deviceID:a,instanceID:b,commandClassID:c});else for(var g in f.instances)if((b=f.instances[g])&&b.commandClasses)for(var h in b.commandClasses)(c=b.commandClasses[h])&&c.data&&c.data.interviewDone&&!c.data.interviewDone.value&&e.push({deviceID:a,instanceID:g,commandClassID:h});if(0==e.length)d&&d();else{var k=this,l=0,n=function(){l++;l==e.length?
d&&d():k._startInterview(e[l].deviceID,e[l].instanceID,e[l].commandClassID,n)};this._startInterview(e[l].deviceID,e[l].instanceID,e[l].commandClassID,n)}}else d&&d(Error("no such device:"+a))};k.prototype._startInterview=function(a,b,c,d){var f=a+"."+b+"."+c;this._logger.log("debug","start interview:"+f);var e=this;this._doRunRequest("devices["+a+"].instances["+b+"].commandClasses["+c+"].Interview()",null,function(a,c,b){a?e._logger.log("warn","start interview "+f+" error:"+a.stack):200!=b?(a=Error("start interview "+
f+" http response code:"+b),e._logger.log("warn","start interview "+f+" http error:"+b+" data:"+c)):e._logger.log("debug","start interview "+f+" success:"+c);d&&d(a,c)})};k.prototype._resetController=function(a){var b=this;this._doRunRequest("controller.SetDefault()",null,function(c,d,f){c?b._logger.log("warn","reset controller error:"+c.stack):200!=f?(c=Error("reset controller http response code:"+f),b._logger.log("warn","reset controller http error:"+f+" data:"+d)):b._logger.log("debug","reset controller success:"+
d);a&&a(c,d)})};k.prototype._getDataFull=function(a){a&&-1==this._dataFullCB.indexOf(a)&&this._dataFullCB.push(a);if(!this._dataFullRunning){this._dataFullRunning=!0;this._dataUpdateTO&&(clearTimeout(this._dataUpdateTO),this._dataUpdateTO=null);var b=this;this._logger.log("debug","get data all");this._doDataRequest(null,function(a,d,f){a?b._logger.log("warn","get data full error:"+a.stack):200!=f?(a=Error("get data http response code:"+f),b._logger.log("warn","get data full http error:"+f+" data:"+
d)):b._logger.log("debug","get data full success:"+JSON.stringify(d));b._dataFullRunning=!1;f=b._dataFullCB;b._dataFullCB=[];!a&&d?b._onDataFull(d):a&&b._onDataFull(null);f.forEach(function(b){b&&b(a,d)})})}};k.prototype._getDataUpdate=function(a){a&&-1==this._dataUpdateCB.indexOf(a)&&this._dataUpdateCB.push(a);if(!this._dataUpdateRunning){this._dataUpdateRunning=!0;this._dataUpdateTO&&(clearTimeout(this._dataUpdateTO),this._dataUpdateTO=null);var b=this;(a=this._data.updateTime)||(a=Math.floor((new Date).getTime()/
1E3));this._logger.log("trace","get data update with timestamp:"+a);this._doDataRequest(a,function(a,d,f){a?b._logger.log("warn","get data update error:"+a.stack):200!=f?(a=Error("get data update http response code:"+f),b._logger.log("warn","get data update  http error:"+f+" data:"+d)):b._logger.log("trace","get data update success:"+JSON.stringify(d));b._dataUpdateRunning=!1;f=b._dataUpdateCB;b._dataUpdateCB=[];!a&&d?b._onDataUpdate(d):a&&b._onDataUpdate(null);f.forEach(function(b){b&&b(a,d)})})}};
k.prototype._doDataRequest=function(a,b){var c="/ZWaveAPI/Data/";a&&(c+=a);var d=1E4;a&&(d=1E3);var f=this;this._logger.log("trace","get data with path:"+c);this._doRequest(c,null,null,d,function(a,d,e){if(a)f._logger.log("trace","get data with path:"+c+" error:"+a.stack),b&&b(a);else{f._logger.log("trace","get data with path:"+c+" status:"+e);f._logger.log("trace","get data result:"+d);try{var g=JSON.parse(d);b&&b(null,g,e)}catch(h){b&&b(h)}}})};k.prototype._doRunRequest=function(a,b,c){var d="/ZWaveAPI/Run/"+
a;b||(b=1E3);var f=this;this._logger.log("trace","do run request:"+d);this._doRequest(d,null,null,b,function(a,b,e){a?(f._logger.log("trace","do run request with path:"+d+" error:"+a.stack),c&&c(a)):(f._logger.log("trace","do run request with path:"+d+" status:"+e),f._logger.log("trace","do run request result:"+b),c&&c(null,b,e))})};k.prototype._doRequest=function(a,b,c,d,f){a={host:this._ip,port:this._port,path:a,method:"POST"};b&&(a.headers=b);c&&(a.headers["Content-Length"]=c.length);var e=f,g=
this;this._logger.log("trace","send http request:"+JSON.stringify(a));this._logger.log("trace","send http data:"+c);b=require("http").request(a,function(a){var b="";a.setEncoding("utf-8");a.on("data",function(a){b+=a});a.on("end",function(){g._logger.log("trace","http response status:"+a.statusCode);g._logger.log("trace","http response data:"+b);var c=null;200!=a.statusCode&&(c=Error("http response "+a.statusCode+" data:"+b));e&&e(c,b,a.statusCode)})});b.on("error",function(a){g._logger.log("trace",
"http request error:"+a.stack);e&&e(a);e=null});b.setTimeout(d,function(){g._logger.log("trace","http request timeout");e&&e(Error("http timeout"));e=null});c&&b.write(c);b.end()};return k}();
x.hub.m.zway.Handler=function(){var l=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.zway.Handler");this._zway=null;this._pollManager=x.hub.m.zway.PollManager;this._settingsManager=x.hub.m.zway.SettingsManager};util.inherits(l,EventEmitter);l.prototype.ZWay=x.hub.m.zway.ZWay;l.prototype.getSystems=function(){return["zway"]};l.prototype.init=function(g){var e=this,h=require("x.hub.eventbus.js");h.on("x.hub.peripheralman.ADD_ZWAVE",function(g){e._logger.log("debug","insert zwave usb stick");
e._logger.log("info","connect to local zwave server");e._start()});h.on("x.hub.peripheralman.REMOVE_ZWAVE",function(g){e._logger.log("debug","eject zwave usb stick");e._logger.log("info","disconnect from local zwave server");e._stop()});global.ZWAVE2_URL&&"A20"!=global.PLATFORM&&"PI2"!=global.PLATFORM&&(this._logger.log("info","connect to remote zwave server"),this._start());this._pollManager.init(this,function(){e._settingsManager.init(e,function(){g&&g({})})})};l.prototype._start=function(){this._zway||
(this._zway=new this.ZWay(global.ZWAVE2_URL,global.ZWAVE2_PORT));this._zway.start()};l.prototype._stop=function(){this._zway&&this._zway.stop()};l.prototype.getAllStates=function(){return this._zway?this._zway._getStates():null};l.prototype.executeCommand=function(g,e,h){g&&g.address&&g.type?e&&e.value?this._ozw?this._ozw.executeCommand(g,e.value,function(e){h&&h({error:e})}):h&&h({error:Error("zwave serial not initialized")}):h&&h({error:Error("command invalid")}):h&&h({error:Error("device invalid")})};
l.prototype.learnDevice=function(g,e,h){this._zway.inclusion(e,function(e,a){h&&h({error:e,data:a})})};l.prototype.removeDevice=function(g,e){this._zway.exclusion(g?g.address:-1,function(g,k){e&&e({error:g,data:{deviceID:k}})})};l.prototype.listDevices=function(g,e){var h=this._zway.getDevices();if(h){var k=[],a;for(a in h)a&&(h=this._zway.getSimplifiedJSON(a))&&k.push(h);e&&e({data:k})}else e&&e({data:[]})};l.prototype.updateInterview=function(g,e,h,k,a){this._zway.updateInterview(g,e,h,k,function(b,
c){a&&a({error:b,data:c})})};l.prototype.listInterviewResults=function(g,e){if(g&&g.address){var h=this._zway.listInterviewResults(g.address);e&&e({data:h})}else{var k=this._zway.getDevices();if(k){var h={},a;for(a in k)a&&(k=this._zway.listInterviewResults(a))&&(h[a]||(h[a]={instances:{}}),h[a].instances=k);e&&e({data:h})}else e&&e({data:[]})}};l.prototype.resetController=function(g){this._zway.resetController(function(e,h){g&&g({error:e})})};l.prototype.getAllStatesLegacy=function(g){var e=[],h=
this.getAllStates();if(h)for(var k in h)e.push({type:"ZWAVE2",adr:k,state:h[k]});g&&g({data:e})};l.prototype.executeCommandLegacy=function(g,e,h){g?e?this._zway.executeCommand(g,e,function(e){h&&h({error:e})}):h&&h({error:Error("command invalid")}):h&&h({error:Error("address invalid")})};l.prototype.getZway=function(){return this._zway};l.prototype.startPoller=function(g,e){this._pollManager.startPoller(g,e)};l.prototype.stopPoller=function(g){this._pollManager.stopPoller(g)};l.prototype.forcePoll=
function(g,e){this._pollManager.immediatelyPoll(g);e&&e({data:{}})};l.prototype.setDeviceSetting=function(g,e,h){this._zway?this._zway.getData()?g?e?this._settingsManager.setSetting(g,e,function(e,a){h&&h({error:e?e:null,data:a?a.toJSON():null})}):h&&h({error:Error("setting json invalid")}):h&&h({error:Error("device id invalid")}):h&&h({error:Error("zwave module initialization not finish")}):h&&h({error:Error("zwave module not running")})};l.prototype.getDeviceSetting=function(g,e){this._zway?this._zway.getData()?
g?this._settingsManager.getSetting(g,function(g,k){e&&e({error:g?g:null,data:k?k.toJSON():null})}):e&&e({error:Error("device id invalid")}):e&&e({error:Error("zwave module initialization not finish")}):e&&e({error:Error("zwave module not running")})};return l}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.zway.Handler);
