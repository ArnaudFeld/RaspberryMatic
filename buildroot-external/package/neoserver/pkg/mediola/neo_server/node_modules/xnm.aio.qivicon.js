var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.qivicon=xnm.aio.qivicon||{};xnm.aio.qivicon.SessionCache={_cache:{},getSessionID:function(d){return d?this._cache[d]?this._cache[d].sessionID:null:null},getToken:function(d){return d?this._cache[d]?this._cache[d].token:null:null},setSessionID:function(d,c){if(d&&c){var b=this._cache[d];b||(this._cache[d]={},b=this._cache[d]);b.sessionID=c}},setToken:function(d,c){if(d&&c){var b=this._cache[d];b||(this._cache[d]={},b=this._cache[d]);b.token=c}}};
xnm.aio.qivicon.HomeBase=function(){var d=function(c,b,a,g,d){this._logger=require("x.logger.js").getLogger("xnm.aio.qivicon.HomeBase");this.ip=c;this.port=b;b||(this.port=443);this.user=a;this.password=g;this.uuid=d;this.CommandHandler=null};d.prototype._setSessionID=function(c){return xnm.aio.qivicon.SessionCache.setSessionID(this.ip,c)};d.prototype._getSessionID=function(){return xnm.aio.qivicon.SessionCache.getSessionID(this.ip)};d.prototype._setCachedToken=function(c){return xnm.aio.qivicon.SessionCache.setToken(this.ip,
c)};d.prototype._getCachedToken=function(){return xnm.aio.qivicon.SessionCache.getToken(this.ip)};d.prototype._doRequest=function(c,b,a,g){c={host:this.ip,port:this.port,path:b,method:c,headers:{Connection:"close","Content-Type":"application/x-www-form-urlencoded"}};a&&(c.headers["Content-Length"]=a.length);this._getSessionID()&&(c.headers.Cookie="JSESSIONID="+this._getSessionID()+"End");this._getCachedToken()&&(c.headers.Authorization="Bearer "+this._getCachedToken());b=require("https");"undefined"!=
typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");this._logger.log("trace","do request:"+JSON.stringify(c));var d=this,e=g,k=b.request(c,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){d._logger.log("trace","receive code:"+a.statusCode+" headers:"+JSON.stringify(a.headers)+" response:"+b);e&&(e(null,b,a),e=null)})});if(k.on)k.on("error",function(a){e&&(e(a),e=null)});k.setTimeout&&k.setTimeout(2E3,function(){d._logger.log("trace",
"do request timeout");k.abort();e&&(e(Error("timeout")),e=null)});k.setAllowRedirect&&k.setAllowRedirect(!1);a&&(this._logger.log("trace","do request send body:"+a),k.write(a));k.end()};d.prototype._sendRequest=function(c,b,a,g){var d=this;this._doRequest(c,b,a,function(e,k,h){e?g&&g(e):h&&401==h.statusCode?d._login(function(e){e?g&&g(e):d._sendRequest(c,b,a,g)}):(e=h&&200==h.statusCode?null:Error("http error"),g&&g(e,k))})};d.prototype._doJSONRPC=function(c,b){var a=JSON.stringify(c);this._sendRequest("POST",
"/remote/json-rpc",a,function(a,c){if(a||!c)a||c||(a=Error("response text invalid")),b&&b(a);else{var d=null;try{d=JSON.parse(c)}catch(k){a=k}b&&b(a,d)}})};d.prototype._getToken=function(c){var b=this;this._doRequest("GET","/dashboard/system.app.basicclient/index.html",null,function(a,g){var d;if(g){var e=g.indexOf(' data-access-token="');0<e&&(g=g.substring(e+20),e=g.indexOf('" '),0<e&&(d=g.substring(0,e)))}d?b._setCachedToken(d):a=Error("get token response error");c&&c(a,d)})};d.prototype._login=
function(c){var b="u="+encodeURIComponent(this.user)+"&p="+encodeURIComponent(this.password),a=this;this._doRequest("POST","/system/http/login",b,function(b,d,e){if(b)c&&c(b);else{if(e&&302==e.statusCode&&(b=null,e.headers&&e.headers["set-cookie"]&&(e=e.headers["set-cookie"],e.constructor===Array&&(e=e[0]),d=e.indexOf("End;"),0==e.indexOf("JSESSIONID=")&&0<d&&(b=e.substring(11,d))),b)){a._setSessionID(b);a._getToken(function(a){c&&c(a)});return}c&&c(Error("login error"))}})};d.prototype._executeCommand=
function(c,b,a,d,f){c=[{jsonrpc:"2.0",method:"BasicClientJsonRpc/processDevice",params:[c,b,a,JSON.parse(d)]}];this._doJSONRPC(c,function(a){f&&f(a)})};d.prototype.getDevices=function(c){this._doJSONRPC([{jsonrpc:"2.0",method:"BasicClientJsonRpc/getAllRooms",id:"mk98-4",params:[]},{jsonrpc:"2.0",method:"BasicClientJsonRpc/getAllDevices",id:"mk98-6",params:[]}],function(b,a){if(b)c&&c(b);else{var d={};if(a&&0<a.length)for(var f=0;f<a.length;f++){var e=a[f];if(e.result){if(e.result.devices)for(var k=
0;k<e.result.devices.length;k++){var h=e.result.devices[k];if(h.roomId){d[h.roomId]||(d[h.roomId]={});d[h.roomId].devices||(d[h.roomId].devices={});var l={channels:{}};l.name=h.name;l.state=h.status;h.compoundType&&h.compoundType.id&&(l.address=h.compoundType.id);h.compoundType&&h.compoundType.deviceTypeName&&(l.type=h.compoundType.deviceTypeName);if(h.compoundType&&h.compoundType.types)for(var m=h.compoundType.types,n=0;n<m.length;n++)if(m[n].states){for(var t=m[n].id,p=m[n].deviceClassName,u={},
q=0;q<m[n].states.length;q++){var r=m[n].states[q];r.name&&null!=r.value&&(u[r.name]=r.value)}if(t&&p){if(l.channels[p])for(q=1,r=p;l.channels[p];)q++,p=r+"@"+q;l.channels[p]={address:t,state:u,type:m[n].deviceTypeName}}}d[h.roomId].devices[h.id]=l}}if(e.result.rooms)for(k=0;k<e.result.rooms.length;k++)h=e.result.rooms[k],d[h.id]||(d[h.id]={}),d[h.id].name=h.name,d[h.id].devices={}}}c&&c(null,d)}})};d.prototype.executeCommand=function(c,b,a){var d=c.address,f=null,e=null,k="[]";"on"==b?(e="turnOn",
f="binarySwitch"):"off"==b?(e="turnOff",f="binarySwitch"):"toggle"==b?(e=b,f="binarySwitch"):"dimUp"==b?(e="stepUp",f="multiLevelSwitch"):"dimDown"==b?(e="stepDown",f="multiLevelSwitch"):"stopMovement"==b?(e=b,f="blinds"):0==b.indexOf("dimTo")?(b=parseInt(b.replace(/dimTo/g,"")),e="setLevel",f="multiLevelSwitch",k='["'+b+'"]'):0==b.indexOf("moveTo")?(b=parseInt(b.replace(/moveTo/g,"")),e="setLevel",f="blinds",k='["'+b+'"]'):0==b.indexOf("setTo")&&(b=b.replace(/setTo/g,""),"0"!=b&&"100"!=b&&(b=(parseFloat(b)/
2).toFixed(1)),e="setTemperature",f="temperatureActuator",k='["'+b+'"]');f&&e?(c.channels&&c.channels[f]&&c.channels[f].address&&(d=c.channels[f].address),this._executeCommand(d,f,e,k,a)):a&&a()};d.prototype.getStates=function(c,b,a){this.CommandHandler=c;this.getDevices(function(c,d){var e={},k;for(k in d)for(var h in d[k].devices)for(var l=0;l<b.length;l++){var m=b[l];if(m.address==h){m.id||(m.id=h);e[m.id]={};for(var n in d[k].devices[h].channels){e[m.id][n]={};for(var t in d[k].devices[h].channels[n].state)e[m.id][n][t]=
d[k].devices[h].channels[n].state[t]}e[m.id].reachable="2"==d[k].devices[h].state?!0:!1;break}}a&&a(e)})};d.prototype.getStateValues=function(c,b){return b};d.prototype.executeCommandCreator=function(c,b,a){if(c&&c.address&&c.channels)if(b&&b.value){var d=b.value;if("dimTo"==b.value){if("undefined"==typeof b.ext||null==b.ext){a&&a(Error("command dimTo ext format invalid"));return}d=b.value+b.ext}else if("setTo"==b.value){if("undefined"==typeof b.ext||null==b.ext){a&&a(Error("command setTo ext format invalid"));
return}d=parseFloat(b.ext);d=b.value+2*d}else if("moveTo"==b.value){if("undefined"==typeof b.ext||null==b.ext){a&&a(Error("command moveTo ext format invalid"));return}d=b.value+b.ext}this.executeCommand(c,d,function(b){a&&a(b)})}else a&&a(Error("command json format invalid"));else a&&a(Error("device json format invalid"))};d.prototype.getStatesCreator=function(c,b,a){if(b)if(0==b.length)a&&a(null,[]);else{for(var d=this,f=[],e=0;e<b.length;e++)if(b[e]&&b[e].device&&b[e].device.address){for(var k=
b[e].device.address,h=!1,l=0;l<f.length;l++)if(f[l].address==k){h=!0;break}h||f.push(b[e].device)}this.getStates(c,f,function(c){var e=[];if(c)for(var f=0;f<b.length;f++)if(b[f]&&b[f].id){var h="?";b[f].device&&b[f].device.address&&b[f].status&&b[f].status.value&&c[b[f].device.address]&&(h=d._resolveState(c[b[f].device.address],b[f].status,b[f].device));h||(h="?");e.push({id:b[f].id,status:h})}a&&a(null,e)})}else a&&a(Error("deviceList is null"))};d.prototype._resolveState=function(c,b,a){if(!c||
!b||!b.value)return null;var d,f=c;switch(b.value){case "switchState":c=f.binarySwitch;a=c.state;"0"==a?a="off":"1"==a&&(a="on");break;case "dimState":c=f.multiLevelSwitch;(a=c.level)&&(a=parseInt(a));break;case "tempSet":c=f.temperatureActuator;(a=c.temperature)&&(a=parseFloat(a).toFixed(1));break;case "currentTemp":c="multiLevelSensor";if(a&&a.channels)for(d in a.channels)if(a.channels.hasOwnProperty(d)&&a.channels[d]&&"TemperatureSensor"==a.channels[d].type){c=d;break}c=f[c];(a=c.value)&&(a=parseFloat(a).toFixed(1));
break;case "currentHum":c="multiLevelSensor";if(a&&a.channels)for(d in a.channels)if(a.channels.hasOwnProperty(d)&&a.channels[d]&&"HumiditySensor"==a.channels[d].type){c=d;break}c=f[c];(a=c.value)&&(a=parseInt(a));break;case "currentBri":c="multiLevelSensor";if(a&&a.channels)for(d in a.channels)if(a.channels.hasOwnProperty(d)&&a.channels[d]&&"MotionDetector"==a.channels[d].type){c=d;break}c=f[c];(a=c.value)&&(a=parseInt(a));break;case "waterState":c="multiLevelSensor";if(a&&a.channels)for(d in a.channels)if(a.channels.hasOwnProperty(d)&&
a.channels[d]&&"WaterSensor"==a.channels[d].type){c=d;break}c=f[c];(a=c.value)&&(a=parseInt(a));1==a?a="dry":2==a?a="wet":3==a&&(a="water");break;case "blindState":c=f.blinds;(a=c.level)&&(a=parseInt(a));break;case "meterTotalPower":c=f.meter;(a=c.total)&&(a=(1E3*parseFloat(a)).toFixed(2));break;case "meterCurrentPower":c=f.meter;(a=c.current)&&(a=(1E3*parseFloat(a)).toFixed(2));break;case "contactState":c=f.binarySensor;a=c.state;a="true"==a?"open":"closed";break;case "motionState":c=f.binarySensor;
a=c.state;a="true"==a?"on":"off";break;case "binaryState":c=f.binarySensor;a=c.state;break;case "reachable":a=c.reachable;break;default:return null}return a};d.prototype.toJSON=function(){return{sys:xnm.aio.qivicon.DM.SYS,ip:this.ip,port:this.port,username:this.user,password:this.password,uuid:this.uuid}};d.prototype.equalsTo=function(c){return c&&c instanceof d?this.ip==c.ip&&this.port==c.port&&this.user==c.user&&this.password==c.password:!1};return d}();
xnm.aio.qivicon.DM=function(){var d=function(c,b){this.code=c;this.message=b;this.stack=Error().stack};d.prototype=Error();d.prototype.name="QiviconDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"qivicon",MAP:{binarySwitch:{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"switch status",ref:{value:"switchState",
options:["on","off"]}}]},multiLevelSwitch:{command:[{type:"enum",name:"dim up",ref:{value:"dimUp"}},{type:"enum",name:"dim down",ref:{value:"dimDown"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}}],status:[{type:"int",name:"dim level",ref:{value:"dimState",extMeta:"0-100"}}]},temperatureActuator:{command:[{type:"float",name:"temperature",ref:{value:"setTo",ext:"%f",extMeta:"5.0-30.0",scale:"0.5"}}],status:[{type:"float",name:"set temperature",ref:{value:"tempSet",extMeta:"5.0-30.0",
scale:"0.5"}}]},multiLevelSensor:{},binarySensor:{},blinds:{command:[{type:"enum",name:"blind stop",ref:{value:"stopMovement"}},{type:"int",name:"move to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}}],status:[{type:"int",name:"blind position",ref:{value:"blindState",extMeta:"0-100"}}]},meter:{status:[{type:"float",name:"total power",ref:{value:"meterTotalPower"}},{type:"float",name:"current power",ref:{value:"meterCurrentPower"}}]},general:{status:[{type:"enum",name:"reachable",ref:{value:"reachable",
options:["true","false"]}}]}},getGatewayType:function(){return[{sys:this.SYS,name:"QIVICON / Magenta SmartHome",port:443}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"OnOffSocket",name:"Switch"},{sys:this.SYS,type:"Thermostat",name:"Thermostat"},{sys:this.SYS,type:"ColorLight",name:"Color Light"},{sys:this.SYS,type:"BlindsUnit",name:"Blind"},{sys:this.SYS,type:"OnOffMeter",name:"Power Meter Swicth"}]},createGateway:function(c,b,a){b=d.ERROR_CODE;c?c.ip?c.username?c.password?a(null,
c):a(new d(b.INVALID,"password is invalid")):a(new d(b.INVALID,"username is invalid")):a(new d(b.INVALID,"ip is invalid")):a(new d(b.INVALID,"info is invalid"))},updateGateway:function(c,b,a,g){c=d.ERROR_CODE;b?b.ip?b.username?b.password?g(null,b):g(new d(c.INVALID,"password is invalid")):g(new d(c.INVALID,"username is invalid")):g(new d(c.INVALID,"ip is invalid")):g(new d(c.INVALID,"update is invalid"))},deleteGateway:function(c,b,a){a()},createDevice:function(c,b,a){var g=d.ERROR_CODE;if(c)if(c.gateway)if(c.address)if(c.type)if(c.channels)if(b.data&&
b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var f,e;for(f=0;f<b.length;f++)if(b[f].index===c.gateway){e=b[f];break}e?a(null,c):a(new d(g.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else a(new d(g.NOT_FOUND,"gateway with index "+c.gateway+" not exists"));else a(new d(g.INVALID,"channels is invalid"));else a(new d(g.INVALID,"type is invalid"));else a(new d(g.INVALID,"address is invalid"));else a(new d(g.INVALID,"gateway is invalid"));else a(new d(g.INVALID,"info is invalid"))},
updateDevice:function(c,b,a){var g=d.ERROR_CODE;if(c)if(c.gateway)if(c.address)if(c.type)if(c.channels)if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var f,e;for(f=0;f<b.length;f++)if(b[f].index===c.gateway){e=b[f];break}e?a(null,c):a(new d(g.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else a(new d(g.NOT_FOUND,"gateway with index "+c.gateway+" not exists"));else a(new d(g.INVALID,"channels is invalid"));else a(new d(g.INVALID,"type is invalid"));else a(new d(g.INVALID,
"address is invalid"));else a(new d(g.INVALID,"gateway is invalid"));else a(new d(g.INVALID,"info is invalid"))},deleteDevice:function(c,b,a){a()},applyUIFilter:function(c,b){var a=this,d=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},f=function(a,b,c){var e=[];switch(c.catagory){case "command":a.command&&a.command.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){d(c.elems,
a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},e=function(b,c){var d=[],e=null;if(e=a.getCommandStatusMap(b))e=f(e,b,c),d=d.concat(e);return d};if(!c||null==c.type||"undefined"==typeof c.type)return null;var k=JSON.parse(JSON.stringify(c)),h=null;switch(b.catagory){case "command":h=e(c,b);k.command=h;break;case "status":h=e(c,b);k.status=h;break;default:return null}return h&&0!=h.length?k:null},getCommandStatusMap:function(c){if(!c||!c.channels)return null;var b={command:[],status:[]},
a;for(a in c.channels)if(a&&c.channels.hasOwnProperty(a)){var d=c.channels[a],f=a.indexOf("@");-1!=f&&(a=a.substr(0,f));if(f=this.MAP[a]){var e=c.type;d.type&&(e=d.type);"multiLevelSensor"==a?"Thermostat"==e||"TemperatureSensor"==e?b.status=b.status.concat([{type:"float",name:"current temperature",ref:{value:"currentTemp"}}]):"HumiditySensor"==e?b.status=b.status.concat([{type:"int",name:"current humidity",ref:{value:"currentHum"}}]):"MotionDetector"==e?b.status=b.status.concat([{type:"int",name:"current brightness",
ref:{value:"currentBri"}}]):"WaterSensor"==e&&(b.status=b.status.concat([{type:"enum",name:"water state",ref:{value:"waterState",options:["dry","wet","water"]}}])):"binarySensor"==a?b.status="ContactDetector"==e?b.status.concat([{type:"enum",name:"state",ref:{value:"contactState",options:["open","closed"]}}]):"MotionDetector"==e?b.status.concat([{type:"enum",name:"motion state",ref:{value:"motionState",options:["on","off"]}}]):b.status.concat([{type:"enum",name:"sensor state",ref:{value:"binaryState",
options:["true","false"]}}]):(f&&f.command&&(b.command=b.command.concat(f.command)),f&&f.status&&(b.status=b.status.concat(f.status)))}}b.status=b.status.concat(this.MAP.general.status);return b}}}();xnm.aio.qivicon.Handler=function(){this.detectedHomebases={}};xnm.aio.qivicon.Handler.prototype.HomeBase=xnm.aio.qivicon.HomeBase;xnm.aio.qivicon.Handler.prototype.devicemanager=xnm.aio.qivicon.DM;xnm.aio.qivicon.Handler.prototype.registModule=function(d){d.register(this.devicemanager.SYS,"qivicon")};
xnm.aio.qivicon.Handler.prototype.resolveGateway=function(d){return d&&d.ip?new xnm.aio.qivicon.HomeBase(d.ip,d.port,d.username,d.password,d.uuid):null};xnm.aio.qivicon.Handler.prototype.getDeviceCommands=function(d,c){var b=this.devicemanager.applyUIFilter(d,{catagory:"command",elems:"*"}),b=b?b.command:[];c&&c(null,b)};xnm.aio.qivicon.Handler.prototype.getDeviceStatus=function(d,c){var b=this.devicemanager.applyUIFilter(d,{catagory:"status",elems:"*"}),b=b?b.status:[];c&&c(null,b)};
xnm.aio.qivicon.Handler.prototype.doCommand=function(d,c,b,a){(d=this.resolveGateway(d))?d.executeCommandCreator(c,b,function(b){a&&a(b)}):a&&a(Error("gateway json format invalid"))};xnm.aio.qivicon.Handler.prototype.doStatus=function(d,c,b,a,g){(c=this.resolveGateway(c))?c.getStatesCreator(null,[{id:d,device:b,status:a}],function(a,b){a?g&&g(a):g&&g(null,b[0])}):g&&g(Error("gateway json format invalid"))};
xnm.aio.qivicon.Handler.prototype.discoverWithTimeout=function(d,c){var b={};this.discoverHomeBases(function(a){a&&a.uuid&&!b[a.uuid]&&(b[a.uuid]=a)});setTimeout(function(){var a=[],d;for(d in b)b.hasOwnProperty(d)&&a.push(b[d]);c&&c(null,a)},d)};
xnm.aio.qivicon.Handler.prototype.discoverHomeBases=function(d){var c=require("x.upnp.js");if(c){var b=this;c.discoverDevices(function(a){if(0==a.name.toLowerCase().indexOf("qivicon")){var c=new xnm.aio.qivicon.HomeBase(a.ip,443,null,null,a.uuid);b.detectedHomebases["uuid:"+a.uuid]||(b.detectedHomebases["uuid:"+a.uuid]=c);d(c)}})}};xnm.aio.qivicon.Handler.prototype.getDeviceList=function(d,c){var b=this.resolveGateway(d);b?b.getDevices(function(a,b){c&&c(a,b)}):c&&c(Error("gateway json format invalid"))};
xnm.aio.qivicon.Handler.prototype.getStateValues=function(d,c){return(new xnm.aio.qivicon.HomeBase).getStateValues(d.type,c)};
xnm.aio.qivicon.Handler.prototype.getDeviceCommandList=function(d,c,b){var a=[];if(c)a.push({id:window.XC_Text.on,cmd:"on"}),a.push({id:window.XC_Text.off,cmd:"off"});else if(b&&d.channels)for(var g in d.channels)"binarySwitch"==g?(a.push({id:"on",cmd:"on"}),a.push({id:"off",cmd:"off"}),a.push({id:"toggle",cmd:"toggle"})):"multiLevelSwitch"==g?(a.push({id:"dimUp",cmd:"dimUp"}),a.push({id:"dimDown",cmd:"dimDown"}),a.push({id:"dimTo",cmd:"dimTo",step:"1",min:"0",max:"100"})):"temperatureActuator"==
g?a.push({id:"setTo",cmd:"setTo",step:"0.5",min:"5",max:"30",fact:"2"}):"blinds"==g&&(a.push({id:"moveTo",cmd:"moveTo",step:"1",min:"0",max:"100"}),a.push({id:"stop",cmd:"stopMovement"}));return a};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.qivicon.Handler);
