var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.qivicon=xnm.aio.qivicon||{};xnm.aio.qivicon.SessionCache={_cache:{},getSessionID:function(d){return d?this._cache[d]?this._cache[d].sessionID:null:null},getToken:function(d){return d?this._cache[d]?this._cache[d].token:null:null},setSessionID:function(d,b){if(d&&b){var c=this._cache[d];c||(this._cache[d]={},c=this._cache[d]);c.sessionID=b}},setToken:function(d,b){if(d&&b){var c=this._cache[d];c||(this._cache[d]={},c=this._cache[d]);c.token=b}}};
xnm.aio.qivicon.HomeBase=function(){var d=function(b,c,a,g,d){this._logger=require("x.logger.js").getLogger("xnm.aio.qivicon.HomeBase");this.ip=b;this.port=c;c||(this.port=443);this.user=a;this.password=g;this.uuid=d;this.CommandHandler=null};d.prototype._setSessionID=function(b){return xnm.aio.qivicon.SessionCache.setSessionID(this.ip,b)};d.prototype._getSessionID=function(){return xnm.aio.qivicon.SessionCache.getSessionID(this.ip)};d.prototype._setCachedToken=function(b){return xnm.aio.qivicon.SessionCache.setToken(this.ip,
b)};d.prototype._getCachedToken=function(){return xnm.aio.qivicon.SessionCache.getToken(this.ip)};d.prototype._doRequest=function(b,c,a,g){b={host:this.ip,port:this.port,path:c,method:b,headers:{Connection:"close","Content-Type":"application/x-www-form-urlencoded"}};a&&(b.headers["Content-Length"]=a.length);this._getSessionID()&&(b.headers.Cookie="JSESSIONID="+this._getSessionID()+"End");this._getCachedToken()&&(b.headers.Authorization="Bearer "+this._getCachedToken());c=require("https");"undefined"!=
typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");this._logger.log("trace","do request:"+JSON.stringify(b));var d=this,f=g,h=c.request(b,function(a){a.setEncoding("utf-8");var c="";a.on("data",function(a){c+=a});a.on("end",function(){d._logger.log("trace","receive code:"+a.statusCode+" headers:"+JSON.stringify(a.headers)+" response:"+c);f&&(f(null,c,a),f=null)})});if(h.on)h.on("error",function(a){f&&(f(a),f=null)});h.setTimeout&&h.setTimeout(2E3,function(){d._logger.log("trace",
"do request timeout");h.abort();f&&(f(Error("timeout")),f=null)});h.setAllowRedirect&&h.setAllowRedirect(!1);a&&(this._logger.log("trace","do request send body:"+a),h.write(a));h.end()};d.prototype._sendRequest=function(b,c,a,g){var d=this;this._doRequest(b,c,a,function(e,h,k){e?g&&g(e):k&&401==k.statusCode?d._login(function(e){e?g&&g(e):d._sendRequest(b,c,a,g)}):(e=k&&200==k.statusCode?null:Error("http error"),g&&g(e,h))})};d.prototype._doJSONRPC=function(b,c){b=JSON.stringify(b);this._sendRequest("POST",
"/remote/json-rpc",b,function(a,b){if(a||!b)a||b||(a=Error("response text invalid")),c&&c(a);else{var g=null;try{g=JSON.parse(b)}catch(f){a=f}c&&c(a,g)}})};d.prototype._getToken=function(b){var c=this;this._doRequest("GET","/dashboard/system.app.basicclient/index.html",null,function(a,g){var d;if(g){var f=g.indexOf(' data-access-token="');0<f&&(g=g.substring(f+20),f=g.indexOf('" '),0<f&&(d=g.substring(0,f)))}d?c._setCachedToken(d):a=Error("get token response error");b&&b(a,d)})};d.prototype._login=
function(b){var c="u="+encodeURIComponent(this.user)+"&p="+encodeURIComponent(this.password),a=this;this._doRequest("POST","/system/http/login",c,function(c,d,f){if(c)b&&b(c);else{if(f&&302==f.statusCode&&(c=null,f.headers&&f.headers["set-cookie"]&&(f=f.headers["set-cookie"],f.constructor===Array&&(f=f[0]),d=f.indexOf("End;"),0==f.indexOf("JSESSIONID=")&&0<d&&(c=f.substring(11,d))),c)){a._setSessionID(c);a._getToken(function(a){b&&b(a)});return}b&&b(Error("login error"))}})};d.prototype._executeCommand=
function(b,c,a,d,e){b=[{jsonrpc:"2.0",method:"BasicClientJsonRpc/processDevice",params:[b,c,a,JSON.parse(d)]}];this._doJSONRPC(b,function(a){e&&e(a)})};d.prototype.getDevices=function(b){this._doJSONRPC([{jsonrpc:"2.0",method:"BasicClientJsonRpc/getAllRooms",id:"mk98-4",params:[]},{jsonrpc:"2.0",method:"BasicClientJsonRpc/getAllDevices",id:"mk98-6",params:[]}],function(c,a){if(c)b&&b(c);else{c={};if(a&&0<a.length)for(var d=0;d<a.length;d++){var e=a[d];if(e.result){if(e.result.devices)for(var f=0;f<
e.result.devices.length;f++){var h=e.result.devices[f];if(h.roomId){c[h.roomId]||(c[h.roomId]={});c[h.roomId].devices||(c[h.roomId].devices={});var k={channels:{}};k.name=h.name;k.state=h.status;h.compoundType&&h.compoundType.id&&(k.address=h.compoundType.id);h.compoundType&&h.compoundType.deviceTypeName&&(k.type=h.compoundType.deviceTypeName);if(h.compoundType&&h.compoundType.types)for(var l=h.compoundType.types,m=0;m<l.length;m++)if(l[m].states){for(var r=l[m].id,n=l[m].deviceClassName,t={},p=0;p<
l[m].states.length;p++){var q=l[m].states[p];q.name&&null!=q.value&&(t[q.name]=q.value)}if(r&&n){if(k.channels[n])for(p=1,q=n;k.channels[n];)p++,n=q+"@"+p;k.channels[n]={address:r,state:t,type:l[m].deviceTypeName}}}c[h.roomId].devices[h.id]=k}}if(e.result.rooms)for(f=0;f<e.result.rooms.length;f++)h=e.result.rooms[f],c[h.id]||(c[h.id]={}),c[h.id].name=h.name,c[h.id].devices={}}}b&&b(null,c)}})};d.prototype.executeCommand=function(b,c,a){var d=b.address,e=null,f=null,h="[]";"on"==c?(f="turnOn",e="binarySwitch"):
"off"==c?(f="turnOff",e="binarySwitch"):"toggle"==c?(f=c,e="binarySwitch"):"dimUp"==c?(f="stepUp",e="multiLevelSwitch"):"dimDown"==c?(f="stepDown",e="multiLevelSwitch"):"stopMovement"==c?(f=c,e="blinds"):0==c.indexOf("dimTo")?(c=parseInt(c.replace(/dimTo/g,"")),f="setLevel",e="multiLevelSwitch",h='["'+c+'"]'):0==c.indexOf("moveTo")?(c=parseInt(c.replace(/moveTo/g,"")),f="setLevel",e="blinds",h='["'+c+'"]'):0==c.indexOf("setTo")&&(c=c.replace(/setTo/g,""),"0"!=c&&"100"!=c&&(c=(parseFloat(c)/2).toFixed(1)),
f="setTemperature",e="temperatureActuator",h='["'+c+'"]');e&&f?(b.channels&&b.channels[e]&&b.channels[e].address&&(d=b.channels[e].address),this._executeCommand(d,e,f,h,a)):a&&a()};d.prototype.getStates=function(b,c,a){this.CommandHandler=b;this.getDevices(function(b,d){b={};for(var g in d)for(var e in d[g].devices)for(var k=0;k<c.length;k++){var l=c[k];if(l.address==e){l.id||(l.id=e);b[l.id]={};for(var m in d[g].devices[e].channels){b[l.id][m]={};for(var r in d[g].devices[e].channels[m].state)b[l.id][m][r]=
d[g].devices[e].channels[m].state[r]}b[l.id].reachable="2"==d[g].devices[e].state?!0:!1;break}}a&&a(b)})};d.prototype.getStateValues=function(b,c){return c};d.prototype.executeCommandCreator=function(b,c,a){if(b&&b.address&&b.channels)if(c&&c.value){var d=c.value;if("dimTo"==c.value){if("undefined"==typeof c.ext||null==c.ext){a&&a(Error("command dimTo ext format invalid"));return}d=c.value+c.ext}else if("setTo"==c.value){if("undefined"==typeof c.ext||null==c.ext){a&&a(Error("command setTo ext format invalid"));
return}d=parseFloat(c.ext);d=c.value+2*d}else if("moveTo"==c.value){if("undefined"==typeof c.ext||null==c.ext){a&&a(Error("command moveTo ext format invalid"));return}d=c.value+c.ext}this.executeCommand(b,d,function(c){a&&a(c)})}else a&&a(Error("command json format invalid"));else a&&a(Error("device json format invalid"))};d.prototype.getStatesCreator=function(b,c,a){if(c)if(0==c.length)a&&a(null,[]);else{for(var d=this,e=[],f=0;f<c.length;f++)if(c[f]&&c[f].device&&c[f].device.address){for(var h=
c[f].device.address,k=!1,l=0;l<e.length;l++)if(e[l].address==h){k=!0;break}k||e.push(c[f].device)}this.getStates(b,e,function(b){var g=[];if(b)for(var e=0;e<c.length;e++)if(c[e]&&c[e].id){var f="?";c[e].device&&c[e].device.address&&c[e].status&&c[e].status.value&&b[c[e].device.address]&&(f=d._resolveState(b[c[e].device.address],c[e].status,c[e].device));f||(f="?");g.push({id:c[e].id,status:f})}a&&a(null,g)})}else a&&a(Error("deviceList is null"))};d.prototype._resolveState=function(b,c,a){if(!b||
!c||!c.value)return null;var d,e=b;switch(c.value){case "switchState":b=e.binarySwitch;a=b.state;"0"==a?a="off":"1"==a&&(a="on");break;case "dimState":b=e.multiLevelSwitch;(a=b.level)&&(a=parseInt(a));break;case "tempSet":b=e.temperatureActuator;(a=b.temperature)&&(a=parseFloat(a).toFixed(1));break;case "currentTemp":b="multiLevelSensor";if(a&&a.channels)for(d in a.channels)if(a.channels.hasOwnProperty(d)&&a.channels[d]&&"TemperatureSensor"==a.channels[d].type){b=d;break}b=e[b];(a=b.value)&&(a=parseFloat(a).toFixed(1));
break;case "currentHum":b="multiLevelSensor";if(a&&a.channels)for(d in a.channels)if(a.channels.hasOwnProperty(d)&&a.channels[d]&&"HumiditySensor"==a.channels[d].type){b=d;break}b=e[b];(a=b.value)&&(a=parseInt(a));break;case "currentBri":b="multiLevelSensor";if(a&&a.channels)for(d in a.channels)if(a.channels.hasOwnProperty(d)&&a.channels[d]&&"MotionDetector"==a.channels[d].type){b=d;break}b=e[b];(a=b.value)&&(a=parseInt(a));break;case "waterState":b="multiLevelSensor";if(a&&a.channels)for(d in a.channels)if(a.channels.hasOwnProperty(d)&&
a.channels[d]&&"WaterSensor"==a.channels[d].type){b=d;break}b=e[b];(a=b.value)&&(a=parseInt(a));1==a?a="dry":2==a?a="wet":3==a&&(a="water");break;case "blindState":b=e.blinds;(a=b.level)&&(a=parseInt(a));break;case "meterTotalPower":b=e.meter;(a=b.total)&&(a=(1E3*parseFloat(a)).toFixed(2));break;case "meterCurrentPower":b=e.meter;(a=b.current)&&(a=(1E3*parseFloat(a)).toFixed(2));break;case "contactState":b=e.binarySensor;a=b.state;a="true"==a?"open":"closed";break;case "motionState":b=e.binarySensor;
a=b.state;a="true"==a?"on":"off";break;case "binaryState":b=e.binarySensor;a=b.state;break;case "reachable":a=b.reachable;break;default:return null}return a};d.prototype.toJSON=function(){return{sys:xnm.aio.qivicon.DM.SYS,ip:this.ip,port:this.port,username:this.user,password:this.password,uuid:this.uuid}};d.prototype.equalsTo=function(b){return b&&b instanceof d?this.ip==b.ip&&this.port==b.port&&this.user==b.user&&this.password==b.password:!1};return d}();
xnm.aio.qivicon.DM=function(){var d=function(b,c){this.code=b;this.message=c;this.stack=Error().stack};d.prototype=Error();d.prototype.name="QiviconDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"qivicon",MAP:{binarySwitch:{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"switch status",ref:{value:"switchState",
options:["on","off"]}}]},multiLevelSwitch:{command:[{type:"enum",name:"dim up",ref:{value:"dimUp"}},{type:"enum",name:"dim down",ref:{value:"dimDown"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}}],status:[{type:"int",name:"dim level",ref:{value:"dimState",extMeta:"0-100"}}]},temperatureActuator:{command:[{type:"float",name:"temperature",ref:{value:"setTo",ext:"%f",extMeta:"5.0-30.0",scale:"0.5"}}],status:[{type:"float",name:"set temperature",ref:{value:"tempSet",extMeta:"5.0-30.0",
scale:"0.5"}}]},multiLevelSensor:{},binarySensor:{},blinds:{command:[{type:"enum",name:"blind stop",ref:{value:"stopMovement"}},{type:"int",name:"move to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}}],status:[{type:"int",name:"blind position",ref:{value:"blindState",extMeta:"0-100"}}]},meter:{status:[{type:"float",name:"total power",ref:{value:"meterTotalPower"}},{type:"float",name:"current power",ref:{value:"meterCurrentPower"}}]},general:{status:[{type:"enum",name:"reachable",ref:{value:"reachable",
options:["true","false"]}}]}},getGatewayType:function(){return[{sys:this.SYS,name:"QIVICON / Magenta SmartHome",port:443}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"OnOffSocket",name:"Switch"},{sys:this.SYS,type:"Thermostat",name:"Thermostat"},{sys:this.SYS,type:"ColorLight",name:"Color Light"},{sys:this.SYS,type:"BlindsUnit",name:"Blind"},{sys:this.SYS,type:"OnOffMeter",name:"Power Meter Swicth"}]},createGateway:function(b,c,a){c=d.ERROR_CODE;b?b.ip?b.username?b.password?a(null,
b):a(new d(c.INVALID,"password is invalid")):a(new d(c.INVALID,"username is invalid")):a(new d(c.INVALID,"ip is invalid")):a(new d(c.INVALID,"info is invalid"))},updateGateway:function(b,c,a,g){b=d.ERROR_CODE;c?c.ip?c.username?c.password?g(null,c):g(new d(b.INVALID,"password is invalid")):g(new d(b.INVALID,"username is invalid")):g(new d(b.INVALID,"ip is invalid")):g(new d(b.INVALID,"update is invalid"))},deleteGateway:function(b,c,a){a()},createDevice:function(b,c,a){var g=d.ERROR_CODE;if(b)if(b.gateway)if(b.address)if(b.type)if(b.channels)if(c.data&&
c.data.gateways&&0!==c.data.gateways.length){c=c.data.gateways;var e;for(e=0;e<c.length;e++)if(c[e].index===b.gateway){var f=c[e];break}f?a(null,b):a(new d(g.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else a(new d(g.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));else a(new d(g.INVALID,"channels is invalid"));else a(new d(g.INVALID,"type is invalid"));else a(new d(g.INVALID,"address is invalid"));else a(new d(g.INVALID,"gateway is invalid"));else a(new d(g.INVALID,"info is invalid"))},
updateDevice:function(b,c,a){var g=d.ERROR_CODE;if(b)if(b.gateway)if(b.address)if(b.type)if(b.channels)if(c.data&&c.data.gateways&&0!==c.data.gateways.length){c=c.data.gateways;var e;for(e=0;e<c.length;e++)if(c[e].index===b.gateway){var f=c[e];break}f?a(null,b):a(new d(g.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else a(new d(g.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));else a(new d(g.INVALID,"channels is invalid"));else a(new d(g.INVALID,"type is invalid"));else a(new d(g.INVALID,
"address is invalid"));else a(new d(g.INVALID,"gateway is invalid"));else a(new d(g.INVALID,"info is invalid"))},deleteDevice:function(b,c,a){a()},applyUIFilter:function(b,c){var a=this,d=function(a,c){if("*"==a)return!0;for(var b=!1,d=0;d<a.length;d++)if(a[d]==c){b=!0;break}return b},e=function(a,c,b){var e=[];switch(b.catagory){case "command":a.command&&a.command.forEach(function(a){d(b.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){d(b.elems,
a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},f=function(b,c){var d=[],f=a.getCommandStatusMap(b);f&&(b=e(f,b,c),d=d.concat(b));return d};if(!b||null==b.type||"undefined"==typeof b.type)return null;var h=JSON.parse(JSON.stringify(b)),k=null;switch(c.catagory){case "command":k=f(b,c);h.command=k;break;case "status":k=f(b,c);h.status=k;break;default:return null}return k&&0!=k.length?h:null},getCommandStatusMap:function(b){if(!b||!b.channels)return null;var c={command:[],status:[]},
a;for(a in b.channels)if(a&&b.channels.hasOwnProperty(a)){var d=b.channels[a],e=a.indexOf("@");-1!=e&&(a=a.substr(0,e));if(e=this.MAP[a]){var f=b.type;d.type&&(f=d.type);"multiLevelSensor"==a?"Thermostat"==f||"TemperatureSensor"==f?c.status=c.status.concat([{type:"float",name:"current temperature",ref:{value:"currentTemp"}}]):"HumiditySensor"==f?c.status=c.status.concat([{type:"int",name:"current humidity",ref:{value:"currentHum"}}]):"MotionDetector"==f?c.status=c.status.concat([{type:"int",name:"current brightness",
ref:{value:"currentBri"}}]):"WaterSensor"==f&&(c.status=c.status.concat([{type:"enum",name:"water state",ref:{value:"waterState",options:["dry","wet","water"]}}])):"binarySensor"==a?c.status="ContactDetector"==f?c.status.concat([{type:"enum",name:"state",ref:{value:"contactState",options:["open","closed"]}}]):"MotionDetector"==f?c.status.concat([{type:"enum",name:"motion state",ref:{value:"motionState",options:["on","off"]}}]):c.status.concat([{type:"enum",name:"sensor state",ref:{value:"binaryState",
options:["true","false"]}}]):(e&&e.command&&(c.command=c.command.concat(e.command)),e&&e.status&&(c.status=c.status.concat(e.status)))}}c.status=c.status.concat(this.MAP.general.status);return c}}}();xnm.aio.qivicon.Handler=function(){this.detectedHomebases={}};xnm.aio.qivicon.Handler.prototype.HomeBase=xnm.aio.qivicon.HomeBase;xnm.aio.qivicon.Handler.prototype.devicemanager=xnm.aio.qivicon.DM;xnm.aio.qivicon.Handler.prototype.registModule=function(d){d.register(this.devicemanager.SYS,"qivicon")};
xnm.aio.qivicon.Handler.prototype.resolveGateway=function(d){return d&&d.ip?new xnm.aio.qivicon.HomeBase(d.ip,d.port,d.username,d.password,d.uuid):null};xnm.aio.qivicon.Handler.prototype.getDeviceCommands=function(d,b){d=(d=this.devicemanager.applyUIFilter(d,{catagory:"command",elems:"*"}))?d.command:[];b&&b(null,d)};xnm.aio.qivicon.Handler.prototype.getDeviceStatus=function(d,b){d=(d=this.devicemanager.applyUIFilter(d,{catagory:"status",elems:"*"}))?d.status:[];b&&b(null,d)};
xnm.aio.qivicon.Handler.prototype.doCommand=function(d,b,c,a){(d=this.resolveGateway(d))?d.executeCommandCreator(b,c,function(b){a&&a(b)}):a&&a(Error("gateway json format invalid"))};xnm.aio.qivicon.Handler.prototype.doStatus=function(d,b,c,a,g){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:d,device:c,status:a}],function(a,b){a?g&&g(a):g&&g(null,b[0])}):g&&g(Error("gateway json format invalid"))};
xnm.aio.qivicon.Handler.prototype.discoverWithTimeout=function(d,b){var c={};this.discoverHomeBases(function(a){a&&a.uuid&&!c[a.uuid]&&(c[a.uuid]=a)});setTimeout(function(){var a=[],d;for(d in c)c.hasOwnProperty(d)&&a.push(c[d]);b&&b(null,a)},d)};
xnm.aio.qivicon.Handler.prototype.discoverHomeBases=function(d){var b=require("x.upnp.js");if(b){var c=this;b.discoverDevices(function(a){if(0==a.name.toLowerCase().indexOf("qivicon")){var b=new xnm.aio.qivicon.HomeBase(a.ip,443,null,null,a.uuid);c.detectedHomebases["uuid:"+a.uuid]||(c.detectedHomebases["uuid:"+a.uuid]=b);d(b)}})}};xnm.aio.qivicon.Handler.prototype.getDeviceList=function(d,b){(d=this.resolveGateway(d))?d.getDevices(function(c,a){b&&b(c,a)}):b&&b(Error("gateway json format invalid"))};
xnm.aio.qivicon.Handler.prototype.getStateValues=function(d,b){return(new xnm.aio.qivicon.HomeBase).getStateValues(d.type,b)};
xnm.aio.qivicon.Handler.prototype.getDeviceCommandList=function(d,b,c){var a=[];if(b)a.push({id:window.XC_Text.on,cmd:"on"}),a.push({id:window.XC_Text.off,cmd:"off"});else if(c&&d.channels)for(var g in d.channels)"binarySwitch"==g?(a.push({id:"on",cmd:"on"}),a.push({id:"off",cmd:"off"}),a.push({id:"toggle",cmd:"toggle"})):"multiLevelSwitch"==g?(a.push({id:"dimUp",cmd:"dimUp"}),a.push({id:"dimDown",cmd:"dimDown"}),a.push({id:"dimTo",cmd:"dimTo",step:"1",min:"0",max:"100"})):"temperatureActuator"==
g?a.push({id:"setTo",cmd:"setTo",step:"0.5",min:"5",max:"30",fact:"2"}):"blinds"==g&&(a.push({id:"moveTo",cmd:"moveTo",step:"1",min:"0",max:"100"}),a.push({id:"stop",cmd:"stopMovement"}));return a};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.qivicon.Handler);
