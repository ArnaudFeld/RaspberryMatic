var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.hue=xnm.aio.hue||{};
xnm.aio.hue.Util={_HSVToRGB:function(a,c,b){var d,e,g,f=Math.floor(6*a),h=6*a-f;a=b*(1-c);var k=b*(1-h*c);c=b*(1-(1-h)*c);switch(f%6){case 0:d=b;e=c;g=a;break;case 1:d=k;e=b;g=a;break;case 2:d=a;e=b;g=c;break;case 3:d=a;e=k;g=b;break;case 4:d=c;e=a;g=b;break;case 5:d=b,e=a,g=k}return[255*d,255*e,255*g]},_RGBToHex:function(a,c,b){for(a=a.toString(16);2>a.length;)a="0"+a;for(c=c.toString(16);2>c.length;)c="0"+c;for(b=b.toString(16);2>b.length;)b="0"+b;return(a+c+b).toUpperCase()}};
xnm.aio.hue.Bridge=function(a,c,b,d,e){this._logger=(d=require("x.logger.js"))?d.getLogger("xnm.aio.hue.Bridge"):{log:function(){}};this._USER="IQONTROLUser";e&&(this._USER=e);this.ip=a;this.port=c;this.uuid=b;this.CommandHandler=null};xnm.aio.hue.Bridge.prototype._RGBToHSV=function(a,c,b){a/=255;c/=255;b/=255;var d=Math.min(a,Math.min(c,b)),e=Math.max(a,Math.max(c,b));return d==e?[0,0,d]:[60*((a==d?3:b==d?1:5)-(a==d?c-b:b==d?a-c:b-a)/(e-d)),(e-d)/e,e]};
xnm.aio.hue.Bridge.prototype._doRequest=function(a,c,b,d){var e="/api/"+this._USER+c;c||(e="/api");a={host:this.ip,port:this.port,path:e,method:a,headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}};var g=this,f=d,h=require("http").request(a,function(b){if(200==b.statusCode){b.setEncoding("utf-8");var a="";b.on("data",function(b){a+=b});b.on("end",function(){var b={};try{var c=JSON.parse(a);c&&c[0]&&c[0].error?(b.error="unknown",1==c[0].error.type&&
(b.error="unauthorized"),101==c[0].error.type&&(b.error="unpressed")):b.data=c}catch(d){}f&&(f(b),f=null)})}else XC.debugf("Failed to post request to "+g.ip),f&&(f(null),f=null)});h.setTimeout(1E3,function(){h.abort()});h.on("error",function(b){f&&(f(null),f=null)});b&&h.write(b);h.end()};
xnm.aio.hue.Bridge.prototype._doRequestForAuth=function(a,c,b,d){var e="/api/"+this._USER+c;c||(e="/api");a={host:this.ip,port:this.port,path:e,method:a,headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}};this._logger.log("debug","do auth:"+JSON.stringify(a));var g=this,f=d,h=null,k=require("http").request(a,function(b){g._logger.log("trace","do auth return status:"+b.statusCode);h=b.statusCode;if(200==b.statusCode){b.setEncoding("utf-8");var a=
"";b.on("data",function(b){a+=b});b.on("end",function(){g._logger.log("trace","do auth return:"+a);var b={};try{var c=JSON.parse(a);c&&c[0]&&c[0].error?(b.error="unknown",1==c[0].error.type&&(b.error="unauthorized"),101==c[0].error.type&&(b.error="unpressed")):b.data=c}catch(d){}f&&(f(b),f=null)})}else XC.debugf("Failed to post request to "+g.ip),f&&(f(null),f=null)});k.setTimeout(1E3,function(){g._logger.log("trace","do auth timeout");k.abort()});k.on("error",function(b){h&&"ECONNRESET"==b.code?
g._logger.log("trace","do auth connection reset"):(g._logger.log("trace","do auth error:"+b.message),f&&(f(null),f=null))});b&&k.write(b);k.end()};xnm.aio.hue.Bridge.prototype.getLights=function(a){this._doRequest("GET","/lights",null,function(c){a&&a(c)})};
xnm.aio.hue.Bridge.prototype.executeCommand=function(a,c,b,d){"power"==c&&(c="toggle");if("ct"==a.channel||3<c.length&&"CT:"==c.substr(0,3)){var e=Math.floor(500-3.46*parseInt(c));3<c.length&&"CT:"==c.substr(0,3)&&(e=parseInt(c.substr(3)));500<e&&(e=500);154>e&&(e=154);this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",'{"ct": '+e+', "on": true}',b)}else if("on"==c)this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",JSON.stringify({on:!0}),
b);else if("off"==c)e={on:!1},a.manufacturer&&"osram"==a.manufacturer.toLowerCase()&&(e.transitiontime=0),this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",JSON.stringify(e),b);else if("alertStop"==c||"alertOne"==c||"alertRepeat"==c)e="none","alertOne"==c?e="select":"alertRepeat"==c&&(e="lselect"),this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",'{"alert": "'+e+'"}',b);else if("effectNone"==c||"effectColorloop"==c)e="none","effectColorloop"==
c&&(e="colorloop"),this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",'{"effect": "'+e+'"}',b);else if("string"==typeof c&&"setscene"==c.substr(0,8))e=c.split("@"),2>e.length?b&&b():this._doRequest("PUT","/groups/"+a.address+"/action",'{"scene": "'+e[1]+'"}',b);else if("toggle"==c){var g=this;this._doRequest("GET",d?"/groups/"+a.address:"/lights/"+a.address,null,function(c){if(!c||c.error)b&&b(c);else if(c.data){var e;a.type&&0==a.type.indexOf("On/Off")&&a.manufacturer&&
"osram"==a.manufacturer.toLowerCase()?c=c.data.state:d&&c.data.action&&null!=c.data.action.bri&&"undefined"!=typeof c.data.action.bri?(e=c.data.action.bri,c=c.data.action):!d&&c.data.state&&null!=c.data.state.bri&&"undefined"!=typeof c.data.state.bri?(e=c.data.state.bri,c=c.data.state):(e=0,c={on:!1});var f={on:!0};a.type&&0==a.type.indexOf("On/Off")&&a.manufacturer&&"osram"==a.manufacturer.toLowerCase()?c.on&&(f.on=!1):(c.on&&(f.on=!1,a.manufacturer&&"osram"==a.manufacturer.toLowerCase()&&(f.transitiontime=
0)),f.on&&0==e&&(f.bri=10));e=JSON.stringify(f);g._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",e,b)}else b&&b({error:Error("no data field")})})}else if("up"==c||"down"==c)g=this,this._doRequest("GET",d?"/groups/"+a.address:"/lights/"+a.address,null,function(e){if(e&&e.error)b&&b(e);else{if(e&&e.data){var f=-1;d&&e.data.action&&null!=e.data.action.bri&&"undefined"!=typeof e.data.action.bri?f=e.data.action.bri:!d&&e.data.state&&null!=e.data.state.bri&&"undefined"!=
typeof e.data.state.bri&&(f=e.data.state.bri);-1!=f&&(e=f,e="up"==c?Math.floor(e+25.4):Math.floor(e-25.4),254<e&&(e=254),0>e&&(e=0),f='{"bri": '+e+', "on": true}',0==e&&(f='{"bri": '+e+', "on": false, "transitiontime":0}'),g._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",f,b),b=null)}b&&b()}});else if("string"==typeof c&&7<c.length&&"briRamp"==c.substr(0,7)){var e=c.substr(7).split(":"),f=Math.floor(2.54*parseInt(e[0])),h=parseInt(e[1]),e=null,e=0==f?{on:!1,transitiontime:h}:
{on:!0,bri:f,transitiontime:h};this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",JSON.stringify(e),b)}else if(6==c.length){var e=parseInt(c.substr(0,2),16),f=parseInt(c.substr(2,2),16),h=parseInt(c.substr(4,2),16),e=this._RGBToHSV(e,f,h),k=Math.floor(e[0]/360*65535+3E3);65535<k&&(k=65535);0>k&&(k=0);var l=Math.floor(254*e[1]);254<l&&(l=254);0>l&&(l=0);g=this;this._doRequest("GET",d?"/groups/"+a.address:"/lights/"+a.address,null,function(c){if(c&&c.error)b&&b(c);
else{if(c&&c.data){var e=-1;d&&c.data.action&&null!=c.data.action.bri&&"undefined"!=typeof c.data.action.bri?e=c.data.action.bri:!d&&c.data.state&&null!=c.data.state.bri&&"undefined"!=typeof c.data.state.bri&&(e=c.data.state.bri);-1!=e&&(c='{"hue": '+k+', "sat": '+l+', "on": true}',0==e&&(c='{"hue": '+k+', "sat": '+l+', "bri": 10, "on": true}'),g._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",c,b),b=null)}b&&b()}})}else 8==c.length?(k=Math.floor(parseInt(c.substr(0,
4),16)),l=Math.floor(parseInt(c.substr(4,2),16)),h=Math.floor(parseInt(c.substr(6,2),16)),e='{"hue": '+k+', "sat": '+l+', "bri": '+h+', "on": true}'):(f=Math.floor(2.54*parseInt(c)),254<f&&(f=254),0>f&&(f=0),e='{"bri": '+f+', "on": true}',0==f&&(e='{"bri": '+f+', "on": false, "transitiontime":0}')),this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",e,b)};
xnm.aio.hue.Bridge.prototype.authorizeUser=function(a){this._doRequest("POST",null,'{"username": "'+this._USER+'", "devicetype": "IQONTROL"}',a)};
xnm.aio.hue.Bridge.prototype.getStates=function(a,c,b){var d=this;this.CommandHandler=a;this.getLights(function(a){if(a&&a.error&&"unauthorized"==a.error)b&&b("AUT");else if(a&&a.data&&a.data.XC_ERR)XC.debugf("[xnm.aio.hue.Bridge.getStates] "+JSON.stringify(a.data),"error"),b&&b("XC_ERR",a.data.XC_ERR);else{if(a&&a.data)if(c&&d.CommandHandler.setState)for(var g=0;g<c.length;g++){var f=c[g],h;if(a.data[f.address]&&(h=a.data[f.address].state)){var k=d.getStateValues(f.subtype,h),l;for(l in k)"state"==
l?d.CommandHandler.setState(f.id,k[l]):d.CommandHandler.setState(f.id+":"+l,k[l])}}else if(d.CommandHandler.receivedState)for(g in a.data)d.CommandHandler.receivedState("hue",g,a.data[g].state);b&&b("OK")}})};xnm.aio.hue.Bridge.prototype.getStateValues=function(a,c){var b={};c.on?(b.state=""+Math.round(c.bri/2.54),1==c.bri&&(b.state="1"),b.power="on"):(b.state="0",b.power="off");c.ct&&(b.ct=""+c.ct);return b};
xnm.aio.hue.Discovery=function(){var a=function(){};a.prototype.discoverBridges=function(c){};return a}();xnm.aio.hue.Handler=function(){var a=require("x.logger.js");xnm.aio.hue.DM._logger=a?a.getLogger("xnm.aio.hue.DM"):{log:function(){}};this._logger=a?a.getLogger("xnm.aio.hue.Handler"):{log:function(){}};this.detectedBridges={}};
xnm.aio.hue.Handler.prototype.discoverBridges=function(a){var c=this;(function(b){var a=require("x.upnp.js");a&&a.discoverDevices(function(a){if("hue"==a.type){c._logger.log("trace","upnp find hue:"+a.ip+" uuid:"+a.uuid);var d=new xnm.aio.hue.Bridge(a.ip,80,a.uuid);c.detectedBridges[a.uuid]=d;b(d)}})})(a);(function(b){var a=function(b,c){var a="http://"+b+"/description.xml";(new (require("x.upnp.js").DescLoader)(b)).load(a,function(b,a){c&&c(b,a)})};(function(b){var a=b;$.ajax({url:"https://www.meethue.com/api/nupnp",
type:"GET",timeout:3E3,dataType:"text",cache:!0,success:function(b){c._logger.log("trace","nupnp request success:"+b);try{var d=JSON.parse(b);a&&(a(null,d),a=null)}catch(e){a&&(a(e),a=null)}},error:function(b,d){var e="nupnp request error:"+(b?b.status:"0")+"-"+d;c._logger.log("trace",e);a&&(a(Error(e)),a=null)}})})(function(e,g){if(!e&&g&&0!=g.length)for(var f=0;f<g.length;f++)g[f]&&g[f].internalipaddress&&a(g[f].internalipaddress,function(a,d){if(!a&&d&&"hue"==d.type){c._logger.log("trace","nupnp find hue:"+
d.ip+" uuid:"+d.uuid);var e=new xnm.aio.hue.Bridge(d.ip,80,d.uuid);c.detectedBridges[d.uuid]=e;b(e)}})})})(a)};xnm.aio.hue.Handler.prototype._NUPnP=function(a){};xnm.aio.hue.Handler.prototype.Bridge=xnm.aio.hue.Bridge;xnm.aio.hue.Handler.prototype.getStateValues=function(a,c){return(new xnm.aio.hue.Bridge).getStateValues(a.type,c)};
xnm.aio.hue.Handler.prototype.getDeviceCommandList=function(a,c){var b=[];if("rgb"==a.data||"colortemplight"==a.data)c||("rgb"==a.data?b.push({id:window.XC_Text.colorvalue+" (RGBA)",cmd:"colorvalue"}):"colortemplight"==a.data&&b.push({id:window.XC_Text.colorvalue,cmd:"colorvalue"})),b.push({id:window.XC_Text.on,cmd:"on"}),b.push({id:window.XC_Text.off,cmd:"off"});else if(b.push({id:window.XC_Text.on,cmd:"on"}),b.push({id:window.XC_Text.off,cmd:"off"}),"dimmer"==a.data&&!c)for(var d=0;100>=d;d+=5)b.push({id:d+
"%",cmd:""+d});return b};xnm.aio.hue.Bridge.prototype.authorizeUser2=function(a){a.__count||(a.__count=0);var c=this;this._doRequestForAuth("POST",null,'{"devicetype": "mediola#user"}',function(b){b&&b.data&&b.data[0]&&b.data[0].success&&b.data[0].success.username?(b=b.data[0].success.username,a&&a(null,b)):50<=a.__count?(b=Error("push button error"),a&&a(b)):(a.__count++,setTimeout(function(){c.authorizeUser2(a)},500))})};
xnm.aio.hue.Bridge.prototype.getGroupStates=function(a,c,b){var d=this;this.CommandHandler=a;c&&0!=c.length?xnm.aio.hue.Group.getAllGroups(this,function(a,g){if(a&&1==a.error)b&&b("AUT");else{if(g)if(c&&d.CommandHandler.setState)for(var f=0;f<c.length;f++)for(var h=c[f],k,l=0;l<g.length;l++){if(g[l]&&g[l]._meta&&g[l]._meta.action&&g[l]._address==h.address){k=g[l]._meta.action;k=d.getStateValues(h.subtype,k);for(var m in k)"state"==m?d.CommandHandler.setState(h.id,k[m]):d.CommandHandler.setState(h.id+
":"+m,k[m])}}else if(d.CommandHandler.receivedState)for(l=0;l<g.length;l++)g[l]&&g[l]._meta&&g[l]._meta.action&&g[l]._address&&d.CommandHandler.receivedState("hue",g[l]._address,g[l]._meta.action,!0);b&&b("OK")}}):b&&b("OK")};
xnm.aio.hue.Bridge.prototype.executeCommandCreator=function(a,c,b){if(a)if(c){var d=c.value;if("rgb"==d||"rgbS"==d||"hue"==d||"bri"==d)d=c.ext;else if("ct"==d){d=parseInt(c.ext);if(!(153<=d||500>=d)){b&&b(Error("ct command invalid"));return}153>d&&(d=153);500<d&&(d=500);d="CT:"+d}else if("alert"==d)switch(d=c.ext,d){case "stop":d="alertStop";break;case "one":d="alertOne";break;case "repeat":d="alertRepeat";break;default:b&&b(Error("alert command ext invalid"));return}else if("effect"==d)switch(d=
c.ext,d){case "none":d="effectNone";break;case "colorloop":d="effectColorloop";break;default:b&&b(Error("effect command ext invalid"));return}else if("setScene"==d){d=c.ext;if(!d){b&&b(Error("setScene command ext invalid"));return}d="setscene@"+d}else if("briRamp"==d){if(!c.ext||0==c.ext.length)return b&&b(Error("briRamp command ext invalid")),null;for(var e,g,d=0;d<c.ext.length;d++){var f=c.ext[d];if(f)switch(f.value){case "bri":e=f.ext;break;case "transtime":g=f.ext}}if("undefined"==typeof e||null==
e||"undefined"==typeof g||null==g){b&&b(Error("briRamp command ext invalid"));return}d="briRamp"+e+":"+g}a.manufacturer=a.manufacturername;switch(a.category){case "light":this.executeCommand(a,d,function(a){var c;a&&a.error&&(c=Error(a.error),"unauthorized"==a.error&&(c.code=1,c.module=xnm.aio.hue.DM.SYS));b&&b(c)});break;case "group":this.executeCommandGroup(a,d,function(a){var c;a&&a.error&&(c=Error(a.error),"unauthorized"==a.error&&(c.code=1,c.module=xnm.aio.hue.DM.SYS));b&&b(c)});break;default:b&&
b(Error("no such category:"+a.category))}}else b&&b(Error("command is null"));else b&&b(Error("device is null"))};
xnm.aio.hue.Bridge.prototype.getStatesCreator=function(a,c,b){if(c){a=[];for(var d=[],e=0;e<c.length;e++){var g=c[e];"group"==g.device.category?d.push({id:g.id,address:g.device.address}):a.push({id:g.id,address:g.device.address})}var f=[],e={},h=this;e.receivedState=function(b,a,d,e){d=h.getStateValues(0,d);for(var g=0;g<c.length;g++)c[g]&&c[g].device&&c[g].device.address==a&&c[g].status&&(!e||"group"==c[g].device.category)&&("power"==c[g].status.value&&null!==d.power&&"undefined"!=typeof d.power?
(b={id:c[g].id,status:d.power},f.push(b)):"brightness"==c[g].status.value&&null!==d.state&&"undefined"!=typeof d.state?(b={id:c[g].id,status:parseInt(d.state)},f.push(b)):"ct"==c[g].status.value&&null!==d.ct&&"undefined"!=typeof d.ct&&(d=parseInt(d.ct),153<=d||500>=d)&&(b={id:c[g].id,status:d},f.push(b)))};var k=3,l=b;this.getStates(e,a,function(b){k--;"AUT"==b?(b=Error(b),b.code=1,b.module=xnm.aio.hue.DM.SYS,l&&l(b)):0==k&&(l&&l(null,f),l=null)});this.getGroupStates(e,d,function(b){k--;"AUT"==b?
(b=Error(b),b.code=1,b.module=xnm.aio.hue.DM.SYS,l&&l(b),l=null):0==k&&(l&&l(null,f),l=null)});xnm.aio.hue.Sensor._getAllSensors(this,function(b,a){k--;if(b)l&&l(b),l=null;else{if(a)for(var d=0;d<c.length;d++)if(c[d]){var e=c[d].id,g=c[d].device,h=c[d].status;if(e&&h&&h.value&&g&&g.address&&"sensor"==g.category){var q=a[g.address];if(q&&(g=xnm.aio.hue.Sensor._parseSensor(g.address,q))&&(g=g.getStates())){h=g[h.value];if("undefined"==typeof h||null==h)h="?";f.push({id:e,status:h})}}}0==k&&(l&&l(null,
f),l=null)}})}else b&&b(Error("deviceList is null"))};xnm.aio.hue.Bridge.prototype.executeCommandGroup=function(a,c,b){this.executeCommand(a,c,b,!0)};xnm.aio.hue.Bridge.prototype.getAllGroups=function(a){xnm.aio.hue.Group.getAllGroups(this,a)};xnm.aio.hue.Bridge.prototype.toJSON=function(){return{sys:xnm.aio.hue.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid,username:this._USER}};
xnm.aio.hue.Bridge.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.hue.Bridge?this.ip==a.ip&&this.port==a.port:!1};xnm.aio.hue.Bridge.prototype.getAllStates=function(a){xnm.aio.hue.Light.getAllLights(this,function(a,b){});xnm.aio.hue.Group.getAllGroups(this,function(a,b){});xnm.aio.hue.Sensor.getAllSensors(this,function(a,b){})};
xnm.aio.hue.Light=function(){var a=function(c,b){this._category=a.CATEGORY;this._address=c;this._meta=b};a.CATEGORY="light";a.getAllLights=function(a,b){var d=this;a.getLights(function(a){if(a)if(a.error){var c=Error(a.error);"unauthorized"==a.error&&(c.code=1,c.module=xnm.aio.hue.DM.SYS);b&&b(c)}else a.data?b&&b(null,d.parseLights(a.data)):b&&b(null,[]);else b&&b(Error("hue request error"))})};a.parseLights=function(c){for(var b=[],d=Object.keys(c),e=0;e<d.length;e++){var g=new a(d[e],c[d[e]]);b.push(g)}return b};
a.prototype.getStates=function(){if(!this._meta)return null;var a={};if(this._meta.state){var b=a=this._meta.state;b.on?(a.state=""+Math.round(b.bri/2.54),1==b.bri&&(a.state="1"),a.power="on"):(a.state="0",a.power="off");b.ct&&(a.ct=b.ct);"undefined"!=typeof b.hue&&null!=b.hue&&"undefined"!=typeof b.sat&&null!=b.sat&&"undefined"!=typeof b.bri&&null!=b.bri&&(b=xnm.aio.hue.Util._HSVToRGB(b.hue/65535,b.sat/254,b.bri/254),a.rgb=xnm.aio.hue.Util._RGBToHex(Math.round(b[0]),Math.round(b[1]),Math.round(b[2])))}return a};
a.prototype.toJSON=function(){var a=JSON.parse(JSON.stringify(this._meta));a.sys=xnm.aio.hue.DM.SYS;a.category=this._category;a.address=this._address;return a};return a}();
xnm.aio.hue.Group=function(){var a=function(c,b){this._category=a.CATEGORY;this._address=c;this._meta=b};a.prototype.toJSON=function(){var a=JSON.parse(JSON.stringify(this._meta));a.sys=xnm.aio.hue.DM.SYS;a.category=this._category;a.address=this._address;return a};a.CATEGORY="group";a.getAllGroups=function(a,b){var d=this,e,g;this._getGroupWithID(a,0,function(f,h){f?b&&b(f):(g=h,d._getGroups(a,function(a,c){a?b&&b(a):(e=c?c:{},g&&(e["0"]=g),b&&b(null,d._parseGroupList(e)))}))})};a.createGroup=function(c,
b,d){if(b)if(b.name)if(b.lights)if(b.lights.length){var e=this;this._createGroup(c,b,function(b,f){b?d&&d(b):e._getGroupWithID(c,f,function(b,c){if(b)d&&d(b);else{var e=new a(f,c);d&&d(null,e)}})})}else d&&d(Error("group lights is empty"));else d&&d(Error("group lights is invalid"));else d&&d(Error("group name is invalid"));else d&&d(Error("group is null"))};a._getGroups=function(a,b){a._doRequest("GET","/groups",null,function(a){if(a)if(a.error){var c=Error(a.error);"unauthorized"==a.error&&(c.code=
1,c.module=xnm.aio.hue.DM.SYS);b&&b(c)}else a.data?b&&b(null,a.data):b&&b(Error("heu response format invalid"));else b&&b(Error("hue request error"))})};a._getGroupWithID=function(a,b,d){a._doRequest("GET","/groups/"+b,null,function(a){if(a)if(a.error){var b=Error(a.error);"unauthorized"==a.error&&(b.code=1,b.module=xnm.aio.hue.DM.SYS);d&&d(b)}else a.data?d&&d(null,a.data):d&&d(Error("heu response format invalid"));else d&&d(Error("hue request error"))})};a._createGroup=function(a,b,d){a._doRequest("POST",
"/groups",JSON.stringify({name:b.name,lights:b.lights}),function(a){if(a)if(a.error){var b=Error(a.error);"unauthorized"==a.error&&(b.code=1,b.module=xnm.aio.hue.DM.SYS);d&&d(b)}else a.data&&a.data[0]&&a.data[0].success&&a.data[0].success.id?(a=a.data[0].success.id,0==a.indexOf("/groups/")&&(a=a.substr(8)),d&&d(null,a)):d&&d(Error("heu response format invalid"));else d&&d(Error("hue request error"))})};a._parseGroupList=function(c){for(var b=[],d=Object.keys(c),e=0;e<d.length;e++){"0"==d[e]&&(c[d[e]].name=
"All Lights");var g=new a(d[e],c[d[e]]);b.push(g)}return b};return a}();xnm.aio.hue.Scene=function(){var a=function(){};a.getAllScenes=function(a,b){a._doRequest("GET","/scenes",null,function(a){if(a)if(a.error){var c=Error(a.error);"unauthorized"==a.error&&(c.code=1,c.module=xnm.aio.hue.DM.SYS);b&&b(c)}else a.data?b&&b(null,a.data):b&&b(Error("heu response format invalid"));else b&&b(Error("hue request error"))})};return a}();
xnm.aio.hue.Sensor=function(){var a=function(b,c){this._category=a.CATEGORY;this._address=b;this._meta=c};a.CATEGORY="sensor";a.getAllSensors=function(a,b){var c=this;this._getAllSensors(a,function(a,d){a?b&&b(a):b&&b(null,c._parseSensors(d))})};a._parseSensors=function(a){for(var b=[],c=Object.keys(a),d=0;d<c.length;d++){var e=this._parseSensor(c[d],a[c[d]]);e&&b.push(e)}return b};a._parseSensor=function(a,f){switch(f.type){case "Daylight":return new c(a,f);case "ZGPSwitch":return new b(a,f);case "ZLLSwitch":return new d(a,
f);case "ZLLPresence":return new e(a,f);default:return null}};a._getAllSensors=function(a,b){a._doRequest("GET","/sensors",null,function(a){if(a)if(a.error){var c=Error(a.error);"unauthorized"==a.error&&(c.code=1,c.module=xnm.aio.hue.DM.SYS);b&&b(c)}else a.data?b&&b(null,a.data):b&&b(Error("hue response format invalid"));else b&&b(Error("hue request error"))})};a.prototype.getType=function(){return this._meta?this._meta.type:null};a.prototype.getAddress=function(){return this._address};a.prototype.getStates=
function(){return null};a.prototype.toJSON=function(){var a=JSON.parse(JSON.stringify(this._meta));a.sys=xnm.aio.hue.DM.SYS;a.category=this._category;a.address=this._address;return a};var c=function(b,c){a.call(this,b,c)};c.prototype=new a;c.prototype.constructor=c;c.prototype.getStates=function(){if(!this._meta)return null;var a={};this._meta.state&&(a.daylight=this._meta.state.daylight,a.ltime=this._meta.state.lastupdated);return a};var b=function(b,c){a.call(this,b,c)};b.prototype=new a;b.prototype.constructor=
b;b.prototype.getStates=function(){if(!this._meta)return null;var a={};if(this._meta.state){switch(this._meta.state.buttonevent){case 34:a.levent="Press_Button1";break;case 16:a.levent="Press_Button2";break;case 17:a.levent="Press_Button3";break;case 18:a.levent="Press_Button4"}a.ltime=this._meta.state.lastupdated}return a};var d=function(b,c){a.call(this,b,c)};d.prototype=new a;d.prototype.constructor=d;d.prototype.getStates=function(){if(!this._meta)return null;var a={};if(this._meta.state){switch(this._meta.state.buttonevent){case 1E3:case 1001:case 1002:case 1003:a.levent=
"ON";break;case 2E3:case 2001:case 2002:case 2003:a.levent="DIM_UP";break;case 3E3:case 3001:case 3002:case 3003:a.levent="DIM_DOWN";break;case 4E3:case 4001:case 4002:case 4003:a.levent="OFF"}a.ltime=this._meta.state.lastupdated}return a};var e=function(b,c){a.call(this,b,c)};e.prototype=new a;e.prototype.constructor=e;e.prototype.getStates=function(){if(!this._meta)return null;var a={};this._meta.state&&(a.motion=this._meta.state.presence,a.motion2=this._meta.state.presence?"on":"off",a.ltime=this._meta.state.lastupdated);
this._meta.config&&(a.battery=this._meta.config.battery);return a};return a}();
xnm.aio.hue.MAP={onoff:{command:[{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"alert",ref:{value:"alert",ext:"%e",extMeta:["stop","one","repeat"]}}],status:[{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}}]},dimmable:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"int",name:"brightness",ref:{value:"bri",ext:"%d",extMeta:"0-100"}},
{type:"multi",name:"brightness (transition)",ref:{value:"briRamp",ext:"%multi",extMeta:[{type:"int",name:"brightness",ref:{value:"bri",ext:"%d",extMeta:"0-100"}},{type:"int",name:"transition time (100ms)",ref:{value:"transtime",ext:"%d",extMeta:"0-16343"}}]}}],status:[{type:"int",name:"brightness",ref:{value:"brightness",extMeta:"0-100"}}]},colortemp:{command:[{type:"int",name:"color temperature",ref:{value:"ct",ext:"%d",extMeta:"153-500",scale:"1"}}],status:[{type:"int",name:"color temperature",
ref:{value:"ct",extMeta:"153-500",scale:"1"}}]},colorlight:{command:[{type:"string",name:"rgb color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"rgb color",ref:{value:"rgb",ext:"%s"}},{type:"enum",name:"effect",ref:{value:"effect",ext:"%e",extMeta:["none","colorloop"]}},{type:"string",name:"hsb color",ref:{value:"hue",ext:"%s"}}]},extendcolor:{},group:{command:[{type:"dynamic",name:"set scene",ref:{value:"setScene",ext:"%dynamic"}}]},sensor:{Daylight:{status:[{type:"enum",name:"day light",ref:{value:"daylight",
options:["true","fasle"]}},{type:"string",name:"last event time",ref:{value:"ltime"}}],ipevt:[{type:"enum",name:"event",ref:{value:"event",options:["sunrise","sunset"]}}]},ZGPSwitch:{status:[{type:"enum",name:"last event",ref:{value:"levent",options:["Press_Button1","Press_Button2","Press_Button3","Press_Button4"]}},{type:"string",name:"last event time",ref:{value:"ltime"}}],ipevt:[{type:"enum",name:"event",ref:{value:"levent",options:["Press_Button1","Press_Button2","Press_Button3","Press_Button4"]}}]},
ZLLSwitch:{status:[{type:"enum",name:"last event",ref:{value:"levent",options:["ON","DIM_UP","DIM_DOWN","OFF"]}},{type:"string",name:"last event time",ref:{value:"ltime"}}],ipevt:[{type:"enum",name:"event",ref:{value:"levent",options:["ON","DIM_UP","DIM_DOWN","OFF"]}}]},ZLLPresence:{status:[{type:"enum",name:"detect motion",ref:{value:"motion",options:["true","false"]}},{type:"string",name:"last event time",ref:{value:"ltime"}},{type:"int",name:"battery",ref:{value:"battery"}},{type:"enum",name:"detect motion (on/off)",
ref:{value:"motion2",options:["on","off"]}}],ipevt:[{type:"enum",name:"detect motion",ref:{value:"motion",options:["true","false"]}}]}}};xnm.aio.hue.DMError=function(a,c){this.code=a;this.message=c;this.stack=Error().stack};xnm.aio.hue.DMError.prototype=Error();xnm.aio.hue.DMError.prototype.name="HUEDeviceManagerError";xnm.aio.hue.DMError.prototype.code=0;xnm.aio.hue.DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};
xnm.aio.hue.DM={SYS:"hue",getGatewayType:function(){return[{sys:this.SYS,name:"Philips HUE"}]},createGateway:function(a,c,b){c=xnm.aio.hue.DMError;var d=xnm.aio.hue.DMError.ERROR_CODE;a?a.ip?b(null,a):b(new c(d.INVALID,"ip is invalid")):b(new c(d.INVALID,"info is invalid"))},updateGateway:function(a,c,b,d){a=xnm.aio.hue.DMError;b=xnm.aio.hue.DMError.ERROR_CODE;c?c.ip?d(null,c):d(new a(b.INVALID,"ip is invalid")):d(new a(b.INVALID,"update is invalid"))},deleteGateway:function(a,c,b){b()},createDevice:function(a,
c,b){var d=xnm.aio.hue.DMError,e=xnm.aio.hue.DMError.ERROR_CODE;if(a)if(a.gateway)if(null==a.address||"undefined"==typeof a.address)b(new d(e.INVALID,"address is invalid"));else if(a.category)if(c.data&&c.data.gateways&&0!==c.data.gateways.length){c=c.data.gateways;var g,f;for(g=0;g<c.length;g++)if(c[g].index===a.gateway){f=c[g];break}f?b(null,a):b(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else b(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else b(new d(e.INVALID,
"catagory is invalid"));else b(new d(e.INVALID,"gateway is invalid"));else b(new d(e.INVALID,"info is invalid"))},updateDevice:function(a,c,b){var d=xnm.aio.hue.DMError,e=xnm.aio.hue.DMError.ERROR_CODE;if(a)if(null==a.address||"undefined"==typeof a.address)b(new d(e.INVALID,"address is invalid"));else if(a.category)if(a.gateway){c=c.data.gateways;var g,f;for(g=0;g<c.length;g++)if(c[g].index===a.gateway){f=c[g];break}f?b(null,a):b(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else b(new d(e.INVALID,
"gateway is invalid"));else b(new d(e.INVALID,"catagory is invalid"));else b(new d(e.INVALID,"info is invalid"))},deleteDevice:function(a,c,b){b()},applyUIFilter:function(a,c){var b=function(a,b){var c=[],d=[];a&&a.command&&0<a.command.length&&(c=c.concat(a.command));b&&b.command&&0<b.command.length&&(c=c.concat(b.command));a&&a.status&&0<a.status.length&&(d=d.concat(a.status));b&&b.status&&0<b.status.length&&(d=d.concat(b.status));return{command:c,status:d}},d=function(a,b){if("*"==a)return!0;for(var c=
!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},e=function(a,b,c){var e=[];switch(c.catagory){case "command":a.command&&a.command.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},g=function(a,b){if(!a.type)return null;var c=xnm.aio.hue.MAP.sensor[a.type];if(!c)return null;switch(b.catagory){case "command":return c.command;
case "status":return c.status;default:return null}},f=function(a,c){if("sensor"==a.category)return g(a,c);var d=[],f=null;if(!a.type)return null;var f=a.type.toLowerCase(),h=[];if(a.state||a.action){var k=a.state;if("room"==f||"lightgroup"==f||"luminaire"==f||"lightsource"==f)k=a.action;k&&(null!=k.on&&"undefined"!=typeof k.on&&(h=b(h,xnm.aio.hue.MAP.onoff)),null!=k.bri&&"undefined"!=typeof k.bri&&(h=b(h,xnm.aio.hue.MAP.dimmable)),null!=k.ct&&"undefined"!=typeof k.ct&&(h=b(h,xnm.aio.hue.MAP.colortemp)),
null!=k.hue&&"undefined"!=typeof k.hue&&(h=b(h,xnm.aio.hue.MAP.colorlight)),"room"==f||"lightgroup"==f||"luminaire"==f||"lightsource"==f)&&(h=b(h,xnm.aio.hue.MAP.group))}else switch(a.type.toLowerCase()){case "on/off light":case "on/off plug-in unit":h=xnm.aio.hue.MAP.onoff;break;case "dimmable light":case "dimmable plug-in unit":h=b(xnm.aio.hue.MAP.onoff,xnm.aio.hue.MAP.dimmable);break;case "color temperature light":h=b(xnm.aio.hue.MAP.onoff,xnm.aio.hue.MAP.colortemp);break;case "color light":h=
b(b(xnm.aio.hue.MAP.onoff,xnm.aio.hue.MAP.dimmable),xnm.aio.hue.MAP.colorlight);break;case "extended color light":case "lightgroup":case "luminaire":case "lightsource":if(h=b(b(b(xnm.aio.hue.MAP.onoff,xnm.aio.hue.MAP.dimmable),xnm.aio.hue.MAP.colortemp),xnm.aio.hue.MAP.colorlight),"lightgroup"==f||"luminaire"==f||"lightsource"==f)h=b(h,xnm.aio.hue.MAP.group)}h&&(f=e(h,a,c),d=d.concat(f));return d};if(!a.category)return null;var h=JSON.parse(JSON.stringify(a)),k=null;switch(c.catagory){case "command":k=
f(a,c);h.command=k;break;case "status":k=f(a,c);h.status=k;break;default:return null}return k&&0!=k.length?h:null},applyIPEventFilter:function(a,c){if(!a.sys||"sensor"!=a.category)return null;var b=xnm.aio.hue.MAP.sensor[a.type];if(!b)return null;var d=JSON.parse(JSON.stringify(a));d.ipevt=b.ipevt;return d},supportSmartWidget:function(a){if(!a||!a.type)return!1;if("ZLLPresence"==a.type)return!0;a=this.applyUIFilter(a,{catagory:"command",elems:"*"});if(!a||!a.command||0==a.command.length)return!1;
for(var c=0;c<a.command.length;c++){var b=a.command[c];if(b&&b.ref&&("on"==b.ref.value||"up"==b.ref.value||"ct"==b.ref.value||"rgb"==b.ref.value))return!0}return!1},applySmartWidgetFilter:function(a,c,b){if(!a||!a.type)return!1;var d=this.applyUIFilter(a,{catagory:"command",elems:"*"});if(!d||!d.command||0==d.command.length)return!1;for(var e=!1,g=!1,f=!1,h=!1,k=0;k<d.command.length;k++){var l=d.command[k];l&&l.ref&&("on"==l.ref.value&&(e=!0),"up"==l.ref.value&&(g=!0),"ct"==l.ref.value&&(f=!0),"rgb"==
l.ref.value&&(h=!0))}var m,p,n;"ZLLPresence"==a.type&&(p={"%motionState%":{value:"motion2",options:["on","off"],name:"detect motion (on/off)"}},n=["motion"]);e&&(m||(m={}),m["%on%"]||(m["%on%"]={value:"on",name:"on"}),m["%off%"]||(m["%off%"]={value:"off",name:"off"}),m["%toggle%"]||(m["%toggle%"]={value:"toggle",name:"toggle"}),p||(p={}),p["%switchState%"]||(p["%switchState%"]={value:"power",options:["off","on"],name:"power"}),n||(n=[]),-1==n.indexOf("switch")&&n.push("switch"));g&&(m||(m={}),m["%dimOn%"]||
(m["%dimOn%"]={value:"on",name:"on"}),m["%dimOff%"]||(m["%dimOff%"]={value:"off",name:"off"}),m["%dimUp%"]||(m["%dimUp%"]={value:"up",name:"up"}),m["%dimDown%"]||(m["%dimDown%"]={value:"down",name:"down"}),m["%dimTo%"]||(m["%dimTo%"]={value:"bri",ext:"%d",extMeta:"0-100",name:"brightness"}),p||(p={}),p["%dimmerState%"]||(p["%dimmerState%"]={value:"brightness",name:"brightness"}),n||(n=[]),-1==n.indexOf("dimmer")&&n.push("dimmer"));f&&(m||(m={}),m["%colorTemp%"]||(m["%colorTemp%"]={value:"ct",ext:"%d",
extMeta:"153-500",name:"color temperature"}),n||(n=[]),-1==n.indexOf("color_temp")&&n.push("color_temp"));h&&(m||(m={}),m["%rgb%"]||(m["%rgb%"]={value:"rgb",ext:"%s",name:"rgb color"}),m["%white%"]||(m["%white%"]={value:"rgbS",ext:"FFFFFF",name:"rgb color"}),n||(n=[]),-1==n.indexOf("rgb")&&n.push("rgb"));return n&&0!=n.length?this._injectToSmartWidgetTemplate(c,n,b,m,p):null},_injectToSmartWidgetTemplate:function(a,c,b,d,e){var g=[];a||(d={});d||(d={});e||(e={});for(var f=0;f<a.length;f++){var h=
a[f];if(h.meta&&-1!=c.indexOf(h.meta.type)&&h.elements){var h=JSON.parse(JSON.stringify(h)),k=!1,l;for(l in h.elements){var m=h.elements[l];if(m&&Array.isArray(m))for(var p=0;p<m.length;p++){var n=m[p];n&&(n.action&&"command"==n.action.type&&n.action.ref&&n.action.ref.value&&(d[n.action.ref.value]?(n.action.ref=d[n.action.ref.value],n.action.device=b,k=!0):n.action=null),n.status&&n.status.ref&&n.status.ref.value&&(e[n.status.ref.value]?(n.status.ref=e[n.status.ref.value],n.status.device=b,k=!0):
n.status=null))}}k&&g.push(h)}}return g}};xnm.aio.hue.Handler.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"hue")};xnm.aio.hue.Handler.prototype.devicemanager=xnm.aio.hue.DM;xnm.aio.hue.Handler.prototype.Light=xnm.aio.hue.Light;xnm.aio.hue.Handler.prototype.Group=xnm.aio.hue.Group;xnm.aio.hue.Handler.prototype.Scene=xnm.aio.hue.Scene;xnm.aio.hue.Handler.prototype.Sensor=xnm.aio.hue.Sensor;
xnm.aio.hue.Handler.prototype.discoverBridgesWithTimeout=function(a,c){this._discoverCallbacks||(this._discoverCallbacks=[]);for(var b=!1,d=0;d<this._discoverCallbacks.length;d++)if(this._discoverCallbacks[d]===c){b=!0;break}b||this._discoverCallbacks.push(c);var e=this,g=[];10>=a&&(a=10);setTimeout(function(){if(null!=e._discoverCallbacks)for(var a=0;a<e._discoverCallbacks.length;a++)e._discoverCallbacks[a](null,g);e._discoverCallbacks=null},1E3*a);this.discoverBridges(function(a){if(a){for(var b=
0;b<g.length;b++)if(g[b].uuid==a.uuid)return;g.push(a)}})};xnm.aio.hue.Handler.prototype.auth=function(a,c){if(a.ip){var b=this.resolveGateway(a);b?b.authorizeUser2(function(a,b){c&&c(a,b)}):c&&c(Error("gateway json format invalid"))}else c&&c(Error("bridge format invalid"))};
xnm.aio.hue.Handler.prototype.getDeviceList=function(a,c){if(a.ip){var b=this.resolveGateway(a);if(b){var d=3,e=[];xnm.aio.hue.Light.getAllLights(b,function(a,b){d--;b&&(e=e.concat(b));0==d&&c&&c(a,e)});xnm.aio.hue.Group.getAllGroups(b,function(a,b){d--;b&&(e=e.concat(b));0==d&&c&&c(a,e)});xnm.aio.hue.Sensor.getAllSensors(b,function(a,b){d--;b&&(e=e.concat(b));0==d&&c&&c(a,e)})}else c&&c(Error("gateway json format invalid"))}else c&&c(Error("bridge format invalid"))};
xnm.aio.hue.Handler.prototype.createGroup=function(a,c,b){a.ip?(a=this.resolveGateway(a))?xnm.aio.hue.Group.createGroup(a,c,b):b&&b(Error("gateway json format invalid")):b&&b(Error("bridge format invalid"))};xnm.aio.hue.Handler.prototype.resolveGateway=function(a){return new xnm.aio.hue.Bridge(a.ip,a.port,a.uuid,null,a.username)};xnm.aio.hue.Handler.prototype.getDeviceCommands=function(a,c){var b=xnm.aio.hue.DM.applyUIFilter(a,{catagory:"command",elems:"*"}),b=b?b.command:[];c&&c(null,b)};
xnm.aio.hue.Handler.prototype.getDeviceStatus=function(a,c){var b=xnm.aio.hue.DM.applyUIFilter(a,{catagory:"status",elems:"*"}),b=b?b.status:[];c&&c(null,b)};xnm.aio.hue.Handler.prototype.getSceneCommands=function(a,c){if(a.ip){var b=this.resolveGateway(a);b?xnm.aio.hue.Scene.getAllScenes(b,function(a,b){if(a)c&&c(a);else{var g={};if(b)for(var f in b)b.hasOwnProperty(f)&&b[f]&&b[f].name&&(g[f]=b[f].name);c&&c(null,g)}}):c&&c(Error("gateway json format invalid"))}else c&&c(Error("bridge format invalid"))};
xnm.aio.hue.Handler.prototype.doCommand=function(a,c,b,d){(a=this.resolveGateway(a))?a.executeCommandCreator(c,b,function(a){d&&d(a)}):d&&d(Error("gateway json format invalid"))};xnm.aio.hue.Handler.prototype.doStatus=function(a,c,b,d,e){(c=this.resolveGateway(c))?c.getStatesCreator(null,[{id:a,device:b,status:d}],function(a,b){a?e&&e(a):e&&e(null,b[0])}):e&&e(Error("gateway json format invalid"))};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.hue.Handler);
