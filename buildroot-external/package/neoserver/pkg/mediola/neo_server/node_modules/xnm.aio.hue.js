var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var c=0;return function(){return c<a.length?{done:!1,value:a[c++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,b){a!=Array.prototype&&a!=Object.prototype&&(a[c]=b.value)};$jscomp.getGlobal=function(a){a=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,a];for(var c=0;c<a.length;++c){var b=a[c];if(b&&b.Math==Math)return b}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(a,c){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:c})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function a(b){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(b||"")+"_"+c++,b)}var c=0;return a}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.asyncIterator;a||(a=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};
$jscomp.iteratorFromArray=function(a,c){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var b=0,d={next:function(){if(b<a.length){var e=b++;return{value:c(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
$jscomp.polyfill=function(a,c,b,d){if(c){b=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in b||(b[e]={});b=b[e]}a=a[a.length-1];d=b[a];c=c(d);c!=d&&null!=c&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:c})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.hue=xnm.aio.hue||{};
xnm.aio.hue.Util={_HSVToRGB:function(a,c,b){var d=Math.floor(6*a),e=6*a-d;a=b*(1-c);var f=b*(1-e*c);c=b*(1-(1-e)*c);switch(d%6){case 0:var g=b;var h=c;var k=a;break;case 1:g=f;h=b;k=a;break;case 2:g=a;h=b;k=c;break;case 3:g=a;h=f;k=b;break;case 4:g=c;h=a;k=b;break;case 5:g=b,h=a,k=f}return[255*g,255*h,255*k]},_RGBToHex:function(a,c,b){for(a=a.toString(16);2>a.length;)a="0"+a;for(c=c.toString(16);2>c.length;)c="0"+c;for(b=b.toString(16);2>b.length;)b="0"+b;return(a+c+b).toUpperCase()}};
xnm.aio.hue.Bridge=function(a,c,b,d,e){this._logger=(d=require("x.logger.js"))?d.getLogger("xnm.aio.hue.Bridge"):{log:function(){}};this._USER="IQONTROLUser";e&&(this._USER=e);this.ip=a;this.port=c;this.uuid=b;this.CommandHandler=null};xnm.aio.hue.Bridge.prototype._RGBToHSV=function(a,c,b){a/=255;c/=255;b/=255;var d=Math.min(a,Math.min(c,b)),e=Math.max(a,Math.max(c,b));return d==e?[0,0,d]:[60*((a==d?3:b==d?1:5)-(a==d?c-b:b==d?a-c:b-a)/(e-d)),(e-d)/e,e]};
xnm.aio.hue.Bridge.prototype._RGBToXY=function(a,c,b){function d(a,c){return a[0]*c[1]-a[1]*c[0]}function e(a,c,b){return null!=a&&null!=c&&null!=b?(b=[b[0]-a[0],b[1]-a[1]],c=[c[0]-a[0],c[1]-a[1]],b=(b[0]*c[0]+b[1]*c[1])/(c[0]*c[0]+c[1]*c[1]),0>b?b=0:1<b&&(b=1),[a[0]+c[0]*b,a[1]+c[1]*b]):null}function f(a,c){var b=a[0]-c[0];a=a[1]-c[1];return Math.sqrt(b*b+a*a)}var g=[[.703,.296],[.214,.709],[.139,.081]],h=[[.674,.322],[.408,.517],[.168,.041]],k=[[.692,.308],[.17,.7],[.153,.048]],m=[[1,0],[0,1],[0,
0]],n="LLC001 LLC005 LLC006 LLC007 LLC010 LLC011 LLC012 LLC014 LLC013 LST001".split(" "),p="LCT001 LCT002 LCT003 LCT004 LLM001 LCT005 LCT006 LCT007".split(" "),l="LCT010 LCT011 LCT012 LCT014 LCT015 LCT016 LLC020 LST002".split(" "),u="HBL001 HBL002 HBL003 HIL001 HIL002 HEL001 HEL002".split(" ");return function(a,c,b,q){a/=255;c/=255;b/=255;a=.04045<a?Math.pow((a+.055)/1.055,2.4000000953674316):a/12.92;c=.04045<c?Math.pow((c+.055)/1.055,2.4000000953674316):c/12.92;var t=.04045<b?Math.pow((b+.055)/1.055,
2.4000000953674316):b/12.92;b=.664511*a+.154324*c+.162028*t;var r=.283881*a+.668433*c+.047685*t;a=8.8E-5*a+.07231*c+.986039*t;a=[b/(b+r+a),r/(b+r+a)];isNaN(a[0])&&(a[0]=0);isNaN(a[1])&&(a[1]=0);null==q&&(q=" ");q=-1==p.indexOf(q)&&-1==u.indexOf(q)?0<=n.indexOf(q)?g:0<=l.indexOf(q)?k:m:h;null!=a&&null!=q?(b=q[0],c=q[1],r=q[2],c=[c[0]-b[0],c[1]-b[1]],r=[r[0]-b[0],r[1]-b[1]],t=[a[0]-b[0],a[1]-b[1]],b=d(t,r)/d(c,r),c=d(c,t)/d(c,r),c=0<=b&&0<=c&&1>=b+c):c=!1;if(!c){b=e(q[0],q[1],a);c=e(q[2],q[0],a);q=
e(q[1],q[2],a);r=f(a,b);t=f(a,c);var w=f(a,q),v=r;t<r&&(v=t,b=c);w<v&&(b=q);a[0]=b[0];a[1]=b[1]}a[0]=Math.round(1E4*a[0])/1E4;a[1]=Math.round(1E4*a[1])/1E4;return a}(a,c,b)};
xnm.aio.hue.Bridge.prototype._doRequest=function(a,c,b,d){var e="/api/"+this._USER+c;c||(e="/api");e={host:this.ip,port:this.port,path:e,method:a,headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}};var f=this,g=d;this._logger.log("trace","send '"+a+"' to "+this.ip+":"+this.port+"/api/xxxxxxxx"+(c?c:""));b&&this._logger.log("trace","with data: "+b);var h=require("http").request(e,function(a){if(200==a.statusCode){a.setEncoding("utf-8");var c="";a.on("data",
function(a){c+=a});a.on("end",function(){f._logger.log("trace","http response 200: "+c);var a={};try{var b=JSON.parse(c);b&&b[0]&&b[0].error?(a.error="unknown",1==b[0].error.type&&(a.error="unauthorized"),101==b[0].error.type&&(a.error="unpressed")):a.data=b}catch(l){}g&&(g(a),g=null)})}else f._logger.log("trace","http response "+a.statusCode),g&&(g(null),g=null)});h.setTimeout(1E3,function(){f._logger.log("trace","http request timeout");h.abort()});h.on("error",function(a){f._logger.log("trace",
"http request error:"+a.message);g&&(g(null),g=null)});b&&h.write(b);h.end()};
xnm.aio.hue.Bridge.prototype._doRequestForAuth=function(a,c,b,d){var e="/api/"+this._USER+c;c||(e="/api");a={host:this.ip,port:this.port,path:e,method:a,headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}};this._logger.log("debug","do auth:"+JSON.stringify(a));var f=this,g=d,h=null,k=require("http").request(a,function(a){f._logger.log("trace","do auth return status:"+a.statusCode);h=a.statusCode;if(200==a.statusCode){a.setEncoding("utf-8");var c=
"";a.on("data",function(a){c+=a});a.on("end",function(){f._logger.log("trace","do auth return:"+c);var a={};try{var b=JSON.parse(c);b&&b[0]&&b[0].error?(a.error="unknown",1==b[0].error.type&&(a.error="unauthorized"),101==b[0].error.type&&(a.error="unpressed")):a.data=b}catch(u){}g&&(g(a),g=null)})}else XC.debugf("Failed to post request to "+f.ip),g&&(g(null),g=null)});k.setTimeout(1E3,function(){f._logger.log("trace","do auth timeout");k.abort()});k.on("error",function(a){h&&"ECONNRESET"==a.code?
f._logger.log("trace","do auth connection reset"):(f._logger.log("trace","do auth error:"+a.message),g&&(g(null),g=null))});b&&k.write(b);k.end()};xnm.aio.hue.Bridge.prototype.getLights=function(a){this._doRequest("GET","/lights",null,function(c){a&&a(c)})};
xnm.aio.hue.Bridge.prototype.executeCommand=function(a,c,b,d){"power"==c&&(c="toggle");if("ct"==a.channel||3<c.length&&"CT:"==c.substr(0,3)){var e=Math.floor(500-3.46*parseInt(c));3<c.length&&"CT:"==c.substr(0,3)&&(e=parseInt(c.substr(3)));500<e&&(e=500);154>e&&(e=154);this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",'{"ct": '+e+', "on": true}',b)}else if("on"==c)this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",JSON.stringify({on:!0}),
b);else if("off"==c)e={on:!1},a.manufacturer&&"osram"==a.manufacturer.toLowerCase()&&(e.transitiontime=0),this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",JSON.stringify(e),b);else if("alertStop"==c||"alertOne"==c||"alertRepeat"==c)e="none","alertOne"==c?e="select":"alertRepeat"==c&&(e="lselect"),this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",'{"alert": "'+e+'"}',b);else if("effectNone"==c||"effectColorloop"==c)e="none","effectColorloop"==
c&&(e="colorloop"),this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",'{"effect": "'+e+'"}',b);else if("string"==typeof c&&"setscene"==c.substr(0,8))e=c.split("@"),2>e.length?b&&b():this._doRequest("PUT","/groups/"+a.address+"/action",'{"scene": "'+e[1]+'"}',b);else if("toggle"==c){var f=this;this._doRequest("GET",d?"/groups/"+a.address:"/lights/"+a.address,null,function(c){if(!c||c.error)b&&b(c);else if(c.data){if(a.type&&0==a.type.indexOf("On/Off"))c=c.data.state;
else if(d&&c.data.action&&null!=c.data.action.bri&&"undefined"!=typeof c.data.action.bri){var e=c.data.action.bri;c=c.data.action}else!d&&c.data.state&&null!=c.data.state.bri&&"undefined"!=typeof c.data.state.bri?(e=c.data.state.bri,c=c.data.state):(e=0,c={on:!1});var h={on:!0};a.type&&0==a.type.indexOf("On/Off")?c.on&&(h.on=!1):(c.on&&(h.on=!1,a.manufacturer&&"osram"==a.manufacturer.toLowerCase()&&(h.transitiontime=0)),h.on&&0==e&&(h.bri=10));e=JSON.stringify(h);f._doRequest("PUT",d?"/groups/"+a.address+
"/action":"/lights/"+a.address+"/state",e,b)}else b&&b({error:Error("no data field")})})}else if("up"==c||"down"==c)f=this,this._doRequest("GET",d?"/groups/"+a.address:"/lights/"+a.address,null,function(e){if(e&&e.error)b&&b(e);else{if(e&&e.data){var h=-1;d&&e.data.action&&null!=e.data.action.bri&&"undefined"!=typeof e.data.action.bri?h=e.data.action.bri:!d&&e.data.state&&null!=e.data.state.bri&&"undefined"!=typeof e.data.state.bri&&(h=e.data.state.bri);-1!=h&&(e=h,e="up"==c?Math.floor(e+25.4):Math.floor(e-
25.4),254<e&&(e=254),0>e&&(e=0),h='{"bri": '+e+', "on": true}',0==e&&(h='{"bri": '+e+', "on": false, "transitiontime":0}'),f._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",h,b),b=null)}b&&b()}});else if("string"==typeof c&&7<c.length&&"briRamp"==c.substr(0,7)){e=c.substr(7).split(":");var g=Math.floor(2.54*parseInt(e[0])),h=parseInt(e[1]);e=null;e=0==g?{on:!1,transitiontime:h}:{on:!0,bri:g,transitiontime:h};this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+
a.address+"/state",JSON.stringify(e),b)}else if(6==c.length){var k=parseInt(c.substr(0,2),16),m=parseInt(c.substr(2,2),16),n=parseInt(c.substr(4,2),16);e=this._RGBToHSV(k,m,n);var p=Math.floor(e[0]/360*65535+3E3);65535<p&&(p=65535);0>p&&(p=0);var l=Math.floor(254*e[1]);254<l&&(l=254);0>l&&(l=0);f=this;this._doRequest("GET",d?"/groups/"+a.address:"/lights/"+a.address,null,function(c){if(c&&c.error)b&&b(c);else{if(c&&c.data){var e=-1;d&&c.data.action&&null!=c.data.action.bri&&"undefined"!=typeof c.data.action.bri?
e=c.data.action.bri:!d&&c.data.state&&null!=c.data.state.bri&&"undefined"!=typeof c.data.state.bri&&(e=c.data.state.bri);-1!=e&&(c.data.state&&"xy"==c.data.state.colormode?(c=f._RGBToXY(k,m,n),0==e&&(e=10),c=JSON.stringify({xy:c,on:!0,bri:e})):(c='{"hue": '+p+', "sat": '+l+', "on": true}',0==e&&(c='{"hue": '+p+', "sat": '+l+', "bri": 10, "on": true}')),f._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",c,b),b=null)}b&&b()}})}else 8==c.length?(p=Math.floor(parseInt(c.substr(0,
4),16)),l=Math.floor(parseInt(c.substr(4,2),16)),n=Math.floor(parseInt(c.substr(6,2),16)),this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",'{"hue": '+p+', "sat": '+l+', "bri": '+n+', "on": true}',b)):(g=Math.floor(2.54*parseInt(c)),254<g&&(g=254),0>g&&(g=0),e='{"bri": '+g+', "on": true}',0==g&&(e='{"bri": '+g+', "on": false, "transitiontime":0}'),this._doRequest("PUT",d?"/groups/"+a.address+"/action":"/lights/"+a.address+"/state",e,b))};
xnm.aio.hue.Bridge.prototype.authorizeUser=function(a){this._doRequest("POST",null,'{"username": "'+this._USER+'", "devicetype": "IQONTROL"}',a)};
xnm.aio.hue.Bridge.prototype.getStates=function(a,c,b){var d=this;this.CommandHandler=a;this.getLights(function(a){if(a&&a.error&&"unauthorized"==a.error)b&&b("AUT");else if(a&&a.data&&a.data.XC_ERR)XC.debugf("[xnm.aio.hue.Bridge.getStates] "+JSON.stringify(a.data),"error"),b&&b("XC_ERR",a.data.XC_ERR);else{if(a&&a.data)if(c&&d.CommandHandler.setState)for(var e=0;e<c.length;e++){var g=c[e],h;if(a.data[g.address]&&(h=a.data[g.address].state)){var k=d.getStateValues(g.subtype,h),m;for(m in k)"state"==
m?d.CommandHandler.setState(g.id,k[m]):d.CommandHandler.setState(g.id+":"+m,k[m])}}else if(d.CommandHandler.receivedState)for(e in a.data)d.CommandHandler.receivedState("hue",e,a.data[e].state);b&&b("OK")}})};xnm.aio.hue.Bridge.prototype.getStateValues=function(a,c){a={};c.on?(a.state=""+Math.round(c.bri/2.54),1==c.bri&&(a.state="1"),a.power="on"):(a.state="0",a.power="off");c.ct&&(a.ct=""+c.ct);return a};
xnm.aio.hue.Discovery=function(){var a=function(){};a.prototype.discoverBridges=function(a){};return a}();xnm.aio.hue.Handler=function(){var a=require("x.logger.js");xnm.aio.hue.DM._logger=a?a.getLogger("xnm.aio.hue.DM"):{log:function(){}};this._logger=a?a.getLogger("xnm.aio.hue.Handler"):{log:function(){}};this.detectedBridges={}};
xnm.aio.hue.Handler.prototype.discoverBridges=function(a){var c=this;(function(a){var b=require("x.upnp.js");b&&b.discoverDevices(function(b){if("hue"==b.type){c._logger.log("trace","upnp find hue:"+b.ip+" uuid:"+b.uuid);var e=new xnm.aio.hue.Bridge(b.ip,80,b.uuid);c.detectedBridges[b.uuid]=e;a(e)}})})(a);(function(a){var b=function(a,c){var b="http://"+a+"/description.xml";(new (require("x.upnp.js").DescLoader)(a)).load(b,function(a,b){c&&c(a,b)})};(function(a){var b=a;$.ajax({url:"https://discovery.meethue.com",
type:"GET",timeout:3E3,dataType:"text",cache:!0,success:function(a){c._logger.log("trace","nupnp request success:"+a);try{var e=JSON.parse(a);b&&(b(null,e),b=null)}catch(k){b&&(b(k),b=null)}},error:function(a,e){a="nupnp request error:"+(a?a.status:"0")+"-"+e;c._logger.log("trace",a);b&&(b(Error(a)),b=null)}})})(function(e,d){if(!e&&d&&0!=d.length)for(e=0;e<d.length;e++)d[e]&&d[e].internalipaddress&&b(d[e].internalipaddress,function(b,e){!b&&e&&"hue"==e.type&&(c._logger.log("trace","nupnp find hue:"+
e.ip+" uuid:"+e.uuid),b=new xnm.aio.hue.Bridge(e.ip,80,e.uuid),c.detectedBridges[e.uuid]=b,a(b))})})})(a);(function(a){var b=function(a,c){var b="http://"+a+"/description.xml";(new (require("x.upnp.js").DescLoader)(a)).load(b,function(a,b){c&&c(a,b)})};(function(a){var b=a;$.ajax({url:"https://www.meethue.com/api/nupnp",type:"GET",timeout:3E3,dataType:"text",cache:!0,success:function(a){c._logger.log("trace","nupnp request success:"+a);try{var e=JSON.parse(a);b&&(b(null,e),b=null)}catch(k){b&&(b(k),
b=null)}},error:function(a,e){a="nupnp request error:"+(a?a.status:"0")+"-"+e;c._logger.log("trace",a);b&&(b(Error(a)),b=null)}})})(function(e,d){if(!e&&d&&0!=d.length)for(e=0;e<d.length;e++)d[e]&&d[e].internalipaddress&&b(d[e].internalipaddress,function(b,e){!b&&e&&"hue"==e.type&&(c._logger.log("trace","nupnp find hue:"+e.ip+" uuid:"+e.uuid),b=new xnm.aio.hue.Bridge(e.ip,80,e.uuid),c.detectedBridges[e.uuid]=b,a(b))})})})(a)};xnm.aio.hue.Handler.prototype._NUPnP=function(a){};
xnm.aio.hue.Handler.prototype.Bridge=xnm.aio.hue.Bridge;xnm.aio.hue.Handler.prototype.getStateValues=function(a,c){return(new xnm.aio.hue.Bridge).getStateValues(a.type,c)};
xnm.aio.hue.Handler.prototype.getDeviceCommandList=function(a,c){var b=[];if("rgb"==a.data||"colortemplight"==a.data)c||("rgb"==a.data?b.push({id:window.XC_Text.colorvalue+" (RGBA)",cmd:"colorvalue"}):"colortemplight"==a.data&&b.push({id:window.XC_Text.colorvalue,cmd:"colorvalue"})),b.push({id:window.XC_Text.on,cmd:"on"}),b.push({id:window.XC_Text.off,cmd:"off"});else if(b.push({id:window.XC_Text.on,cmd:"on"}),b.push({id:window.XC_Text.off,cmd:"off"}),"dimmer"==a.data&&!c)for(a=0;100>=a;a+=5)b.push({id:a+
"%",cmd:""+a});return b};xnm.aio.hue.Bridge.prototype.authorizeUser2=function(a){a.__count||(a.__count=0);var c=this;this._doRequestForAuth("POST",null,'{"devicetype": "mediola#user"}',function(b){b&&b.data&&b.data[0]&&b.data[0].success&&b.data[0].success.username?(b=b.data[0].success.username,a&&a(null,b)):50<=a.__count?(b=Error("push button error"),a&&a(b)):(a.__count++,setTimeout(function(){c.authorizeUser2(a)},500))})};
xnm.aio.hue.Bridge.prototype.getGroupStates=function(a,c,b){var d=this;this.CommandHandler=a;c&&0!=c.length?xnm.aio.hue.Group.getAllGroups(this,function(a,f){if(a&&1==a.error)b&&b("AUT");else{if(f)if(c&&d.CommandHandler.setState)for(a=0;a<c.length;a++)for(var e=c[a],h,k=0;k<f.length;k++){if(f[k]&&f[k]._meta&&f[k]._meta.action&&f[k]._address==e.address){h=f[k]._meta.action;h=d.getStateValues(e.subtype,h);for(var m in h)"state"==m?d.CommandHandler.setState(e.id,h[m]):d.CommandHandler.setState(e.id+
":"+m,h[m])}}else if(d.CommandHandler.receivedState)for(k=0;k<f.length;k++)f[k]&&f[k]._meta&&f[k]._meta.action&&f[k]._address&&d.CommandHandler.receivedState("hue",f[k]._address,f[k]._meta.action,!0);b&&b("OK")}}):b&&b("OK")};
xnm.aio.hue.Bridge.prototype.executeCommandCreator=function(a,c,b){if(a)if(c){var d=c.value;if("rgb"==d||"rgbS"==d||"hue"==d||"bri"==d)d=c.ext;else if("ct"==d){d=parseInt(c.ext);if(!(153<=d||500>=d)){b&&b(Error("ct command invalid"));return}153>d&&(d=153);500<d&&(d=500);d="CT:"+d}else if("alert"==d)switch(d=c.ext,d){case "stop":d="alertStop";break;case "one":d="alertOne";break;case "repeat":d="alertRepeat";break;default:b&&b(Error("alert command ext invalid"));return}else if("effect"==d)switch(d=
c.ext,d){case "none":d="effectNone";break;case "colorloop":d="effectColorloop";break;default:b&&b(Error("effect command ext invalid"));return}else if("setScene"==d){d=c.ext;if(!d){b&&b(Error("setScene command ext invalid"));return}d="setscene@"+d}else if("briRamp"==d){if(!c.ext||0==c.ext.length)return b&&b(Error("briRamp command ext invalid")),null;for(d=0;d<c.ext.length;d++){var e=c.ext[d];if(e)switch(e.value){case "bri":var f=e.ext;break;case "transtime":var g=e.ext}}if("undefined"==typeof f||null==
f||"undefined"==typeof g||null==g){b&&b(Error("briRamp command ext invalid"));return}d="briRamp"+f+":"+g}a.manufacturer=a.manufacturername;switch(a.category){case "light":this.executeCommand(a,d,function(a){if(a&&a.error){var c=Error(a.error);"unauthorized"==a.error&&(c.code=1,c.module=xnm.aio.hue.DM.SYS)}b&&b(c)});break;case "group":this.executeCommandGroup(a,d,function(a){if(a&&a.error){var c=Error(a.error);"unauthorized"==a.error&&(c.code=1,c.module=xnm.aio.hue.DM.SYS)}b&&b(c)});break;default:b&&
b(Error("no such category:"+a.category))}}else b&&b(Error("command is null"));else b&&b(Error("device is null"))};
xnm.aio.hue.Bridge.prototype.getStatesCreator=function(a,c,b){if(c){a=[];for(var d=[],e=0;e<c.length;e++){var f=c[e];"group"==f.device.category?d.push({id:f.id,address:f.device.address}):a.push({id:f.id,address:f.device.address})}var g=[];e={};var h=this;e.receivedState=function(a,b,e,d){e=h.getStateValues(0,e);for(a=0;a<c.length;a++)if(c[a]&&c[a].device&&c[a].device.address==b&&c[a].status&&(!d||"group"==c[a].device.category))if("power"==c[a].status.value&&null!==e.power&&"undefined"!=typeof e.power){var f=
{id:c[a].id,status:e.power};g.push(f)}else"brightness"==c[a].status.value&&null!==e.state&&"undefined"!=typeof e.state?(f={id:c[a].id,status:parseInt(e.state)},g.push(f)):"ct"==c[a].status.value&&null!==e.ct&&"undefined"!=typeof e.ct&&(f=parseInt(e.ct),153<=f||500>=f)&&(f={id:c[a].id,status:f},g.push(f))};var k=3,m=b;this.getStates(e,a,function(a){k--;"AUT"==a?(a=Error(a),a.code=1,a.module=xnm.aio.hue.DM.SYS,m&&m(a)):0==k&&(m&&m(null,g),m=null)});this.getGroupStates(e,d,function(a){k--;"AUT"==a?(a=
Error(a),a.code=1,a.module=xnm.aio.hue.DM.SYS,m&&m(a),m=null):0==k&&(m&&m(null,g),m=null)});xnm.aio.hue.Sensor._getAllSensors(this,function(a,b){k--;if(a)m&&m(a),m=null;else{if(b)for(a=0;a<c.length;a++)if(c[a]){var e=c[a].id,d=c[a].device,h=c[a].status;if(e&&h&&h.value&&d&&d.address&&"sensor"==d.category){var f=b[d.address];if(f&&(d=xnm.aio.hue.Sensor._parseSensor(d.address,f))&&(d=d.getStates())){h=d[h.value];if("undefined"==typeof h||null==h)h="?";g.push({id:e,status:h})}}}0==k&&(m&&m(null,g),m=
null)}})}else b&&b(Error("deviceList is null"))};xnm.aio.hue.Bridge.prototype.executeCommandGroup=function(a,c,b){this.executeCommand(a,c,b,!0)};xnm.aio.hue.Bridge.prototype.getAllGroups=function(a){xnm.aio.hue.Group.getAllGroups(this,a)};xnm.aio.hue.Bridge.prototype.toJSON=function(){return{sys:xnm.aio.hue.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid,username:this._USER}};
xnm.aio.hue.Bridge.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.hue.Bridge?this.ip==a.ip&&this.port==a.port:!1};xnm.aio.hue.Bridge.prototype.getAllStates=function(a){xnm.aio.hue.Light.getAllLights(this,function(a,b){});xnm.aio.hue.Group.getAllGroups(this,function(a,b){});xnm.aio.hue.Sensor.getAllSensors(this,function(a,b){})};
xnm.aio.hue.Light=function(){var a=function(c,b){this._category=a.CATEGORY;this._address=c;this._meta=b};a.CATEGORY="light";a.getAllLights=function(a,b){var c=this;a.getLights(function(a){if(a)if(a.error){var e=Error(a.error);"unauthorized"==a.error&&(e.code=1,e.module=xnm.aio.hue.DM.SYS);b&&b(e)}else a.data?b&&b(null,c.parseLights(a.data)):b&&b(null,[]);else b&&b(Error("hue request error"))})};a.parseLights=function(c){for(var b=[],d=Object.keys(c),e=0;e<d.length;e++){var f=new a(d[e],c[d[e]]);b.push(f)}return b};
a.prototype.getStates=function(){if(!this._meta)return null;var a={};if(this._meta.state){var b=a=this._meta.state;b.on?(a.state=""+Math.round(b.bri/2.54),1==b.bri&&(a.state="1"),a.power="on"):(a.state="0",a.power="off");b.ct&&(a.ct=b.ct);"undefined"!=typeof b.hue&&null!=b.hue&&"undefined"!=typeof b.sat&&null!=b.sat&&"undefined"!=typeof b.bri&&null!=b.bri&&(b=xnm.aio.hue.Util._HSVToRGB(b.hue/65535,b.sat/254,b.bri/254),a.rgb=xnm.aio.hue.Util._RGBToHex(Math.round(b[0]),Math.round(b[1]),Math.round(b[2])))}return a};
a.prototype.toJSON=function(){var a=JSON.parse(JSON.stringify(this._meta));a.sys=xnm.aio.hue.DM.SYS;a.category=this._category;a.address=this._address;return a};return a}();
xnm.aio.hue.Group=function(){var a=function(c,b){this._category=a.CATEGORY;this._address=c;this._meta=b};a.prototype.toJSON=function(){var a=JSON.parse(JSON.stringify(this._meta));a.sys=xnm.aio.hue.DM.SYS;a.category=this._category;a.address=this._address;return a};a.CATEGORY="group";a.getAllGroups=function(a,b){var c=this,e,f;this._getGroupWithID(a,0,function(d,h){d?b&&b(d):(f=h,c._getGroups(a,function(a,d){a?b&&b(a):(e=d?d:{},f&&(e["0"]=f),b&&b(null,c._parseGroupList(e)))}))})};a.createGroup=function(c,
b,d){if(b)if(b.name)if(b.lights)if(b.lights.length){var e=this;this._createGroup(c,b,function(b,g){b?d&&d(b):e._getGroupWithID(c,g,function(b,c){b?d&&d(b):(b=new a(g,c),d&&d(null,b))})})}else d&&d(Error("group lights is empty"));else d&&d(Error("group lights is invalid"));else d&&d(Error("group name is invalid"));else d&&d(Error("group is null"))};a._getGroups=function(a,b){a._doRequest("GET","/groups",null,function(a){if(a)if(a.error){var c=Error(a.error);"unauthorized"==a.error&&(c.code=1,c.module=
xnm.aio.hue.DM.SYS);b&&b(c)}else a.data?b&&b(null,a.data):b&&b(Error("heu response format invalid"));else b&&b(Error("hue request error"))})};a._getGroupWithID=function(a,b,d){a._doRequest("GET","/groups/"+b,null,function(a){if(a)if(a.error){var b=Error(a.error);"unauthorized"==a.error&&(b.code=1,b.module=xnm.aio.hue.DM.SYS);d&&d(b)}else a.data?d&&d(null,a.data):d&&d(Error("heu response format invalid"));else d&&d(Error("hue request error"))})};a._createGroup=function(a,b,d){a._doRequest("POST","/groups",
JSON.stringify({name:b.name,lights:b.lights}),function(a){if(a)if(a.error){var b=Error(a.error);"unauthorized"==a.error&&(b.code=1,b.module=xnm.aio.hue.DM.SYS);d&&d(b)}else a.data&&a.data[0]&&a.data[0].success&&a.data[0].success.id?(a=a.data[0].success.id,0==a.indexOf("/groups/")&&(a=a.substr(8)),d&&d(null,a)):d&&d(Error("heu response format invalid"));else d&&d(Error("hue request error"))})};a._parseGroupList=function(c){for(var b=[],d=Object.keys(c),e=0;e<d.length;e++){"0"==d[e]&&(c[d[e]].name=
"All Lights");var f=new a(d[e],c[d[e]]);b.push(f)}return b};return a}();xnm.aio.hue.Scene=function(){var a=function(){};a.getAllScenes=function(a,b){a._doRequest("GET","/scenes",null,function(a){if(a)if(a.error){var c=Error(a.error);"unauthorized"==a.error&&(c.code=1,c.module=xnm.aio.hue.DM.SYS);b&&b(c)}else a.data?b&&b(null,a.data):b&&b(Error("heu response format invalid"));else b&&b(Error("hue request error"))})};return a}();
xnm.aio.hue.Sensor=function(){var a=function(b,c){this._category=a.CATEGORY;this._address=b;this._meta=c};a.CATEGORY="sensor";a.getAllSensors=function(a,b){var c=this;this._getAllSensors(a,function(a,d){a?b&&b(a):b&&b(null,c._parseSensors(d))})};a._parseSensors=function(a){for(var b=[],c=Object.keys(a),d=0;d<c.length;d++){var e=this._parseSensor(c[d],a[c[d]]);e&&b.push(e)}return b};a._parseSensor=function(a,k){switch(k.type){case "Daylight":return new c(a,k);case "ZGPSwitch":return new b(a,k);case "ZLLSwitch":return new d(a,
k);case "ZLLPresence":return new e(a,k);case "ZLLTemperature":return new f(a,k);case "ZLLLightLevel":return new g(a,k);default:return null}};a._getAllSensors=function(a,b){a._doRequest("GET","/sensors",null,function(a){if(a)if(a.error){var c=Error(a.error);"unauthorized"==a.error&&(c.code=1,c.module=xnm.aio.hue.DM.SYS);b&&b(c)}else a.data?b&&b(null,a.data):b&&b(Error("hue response format invalid"));else b&&b(Error("hue request error"))})};a.prototype.getType=function(){return this._meta?this._meta.type:
null};a.prototype.getAddress=function(){return this._address};a.prototype.getStates=function(){return null};a.prototype.toJSON=function(){var a=JSON.parse(JSON.stringify(this._meta));a.sys=xnm.aio.hue.DM.SYS;a.category=this._category;a.address=this._address;return a};var c=function(b,c){a.call(this,b,c)};c.prototype=new a;c.prototype.constructor=c;c.prototype.getStates=function(){if(!this._meta)return null;var a={};this._meta.state&&(a.daylight=this._meta.state.daylight,a.ltime=this._meta.state.lastupdated);
return a};var b=function(b,c){a.call(this,b,c)};b.prototype=new a;b.prototype.constructor=b;b.prototype.getStates=function(){if(!this._meta)return null;var a={};if("FOHSWITCH"==this._meta.modelid){if(this._meta.state){switch(this._meta.state.buttonevent){case 20:a.levent="Press_Button1";break;case 21:a.levent="Press_Button2";break;case 23:a.levent="Press_Button3";break;case 22:a.levent="Press_Button4"}a.ltime=this._meta.state.lastupdated}}else if(this._meta.state){switch(this._meta.state.buttonevent){case 34:a.levent=
"Press_Button1";break;case 16:a.levent="Press_Button2";break;case 17:a.levent="Press_Button3";break;case 18:a.levent="Press_Button4"}a.ltime=this._meta.state.lastupdated}return a};var d=function(b,c){a.call(this,b,c)};d.prototype=new a;d.prototype.constructor=d;d.prototype.getStates=function(){if(!this._meta)return null;var a={};if(this._meta.state){switch(this._meta.state.buttonevent){case 1E3:a.levent="ROM001"==this._meta.modelid?"INITIAL_PRESS":"ON";break;case 1001:a.levent="ROM001"==this._meta.modelid?
"HOLD":"ON";break;case 1002:a.levent="ROM001"==this._meta.modelid?"SHORT_RELEASED":"ON";a.btn1event="shortPress";break;case 1003:a.levent="ROM001"==this._meta.modelid?"LONG_RELEASED":"ON";a.btn1event="longPress";break;case 2E3:case 2001:case 2002:case 2003:2002==this._meta.state.buttonevent?a.btn2event="shortPress":2003==this._meta.state.buttonevent&&(a.btn2event="longPress");a.levent="DIM_UP";break;case 3E3:case 3001:case 3002:case 3003:3002==this._meta.state.buttonevent?a.btn3event="shortPress":
3003==this._meta.state.buttonevent&&(a.btn3event="longPress");a.levent="DIM_DOWN";break;case 4E3:case 4001:case 4002:case 4003:4002==this._meta.state.buttonevent?a.btn4event="shortPress":4003==this._meta.state.buttonevent&&(a.btn4event="longPress"),a.levent="OFF"}a.ltime=this._meta.state.lastupdated;this._meta.config&&("undefined"!=typeof this._meta.config.battery&&null!=this._meta.config.battery&&(a.battery=this._meta.config.battery),"undefined"!=typeof this._meta.config.reachable&&null!=this._meta.config.reachable&&
(a.reachable=this._meta.config.reachable))}return a};var e=function(b,c){a.call(this,b,c)};e.prototype=new a;e.prototype.constructor=e;e.prototype.getStates=function(){if(!this._meta)return null;var a={};this._meta.state&&(a.motion=this._meta.state.presence,a.motion2=this._meta.state.presence?"on":"off",a.ltime=this._meta.state.lastupdated);this._meta.config&&(a.battery=this._meta.config.battery);return a};var f=function(b,c){a.call(this,b,c)};f.prototype=new a;f.prototype.constructor=f;f.prototype.getStates=
function(){if(!this._meta)return null;var a={};this._meta.state&&(a.temperature=this._meta.state.temperature/100,a.ltime=this._meta.state.lastupdated);this._meta.config&&(a.battery=this._meta.config.battery);return a};var g=function(b,c){a.call(this,b,c)};g.prototype=new a;g.prototype.constructor=g;g.prototype.getStates=function(){if(!this._meta)return null;var a={};this._meta.state&&(a.lightlevel=this._meta.state.lightlevel,a.dark=this._meta.state.dark,a.daylight=this._meta.state.daylight,a.ltime=
this._meta.state.lastupdated);this._meta.config&&(a.battery=this._meta.config.battery);return a};return a}();
xnm.aio.hue.MAP={onoff:{command:[{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"alert",ref:{value:"alert",ext:"%e",extMeta:["stop","one","repeat"]}}],status:[{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}}]},dimmable:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"int",name:"brightness",ref:{value:"bri",ext:"%d",extMeta:"0-100"}},
{type:"multi",name:"brightness (transition)",ref:{value:"briRamp",ext:"%multi",extMeta:[{type:"int",name:"brightness",ref:{value:"bri",ext:"%d",extMeta:"0-100"}},{type:"int",name:"transition time (100ms)",ref:{value:"transtime",ext:"%d",extMeta:"0-16343"}}]}}],status:[{type:"int",name:"brightness",ref:{value:"brightness",extMeta:"0-100"}}]},colortemp:{command:[{type:"int",name:"color temperature",ref:{value:"ct",ext:"%d",extMeta:"153-500",scale:"1"}}],status:[{type:"int",name:"color temperature",
ref:{value:"ct",extMeta:"153-500",scale:"1"}}]},colorlight:{command:[{type:"string",name:"rgb color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"rgb color",ref:{value:"rgb",ext:"%s"}},{type:"enum",name:"effect",ref:{value:"effect",ext:"%e",extMeta:["none","colorloop"]}},{type:"string",name:"hsb color",ref:{value:"hue",ext:"%s"}}]},extendcolor:{},group:{command:[{type:"dynamic",name:"set scene",ref:{value:"setScene",ext:"%dynamic"}}]},sensor:{Daylight:{status:[{type:"enum",name:"day light",ref:{value:"daylight",
options:["true","fasle"]}},{type:"string",name:"last event time",ref:{value:"ltime"}}],ipevt:[{type:"enum",name:"event",ref:{value:"event",options:["sunrise","sunset"]}}]},ZGPSwitch:{status:[{type:"enum",name:"last event",ref:{value:"levent",options:["Press_Button1","Press_Button2","Press_Button3","Press_Button4"]}},{type:"string",name:"last event time",ref:{value:"ltime"}}],ipevt:[{type:"enum",name:"event",ref:{value:"levent",options:["Press_Button1","Press_Button2","Press_Button3","Press_Button4"]}}]},
ZLLSwitch:{status:[{type:"enum",name:"last event",ref:{value:"levent",options:["ON","DIM_UP","DIM_DOWN","OFF"]}},{type:"enum",name:"last button",ref:{value:"lbutton",options:["button1","button2","button3","button4"]}},{type:"string",name:"last event time",ref:{value:"ltime"}}],ipevt:[{type:"enum",name:"event",ref:{value:"levent",options:["ON","DIM_UP","DIM_DOWN","OFF"]}},{type:"enum",name:"button 1 event",ref:{value:"btn1event",options:["shortPress","longPress"]}},{type:"enum",name:"button 2 event",
ref:{value:"btn2event",options:["shortPress","longPress"]}},{type:"enum",name:"button 3 event",ref:{value:"btn3event",options:["shortPress","longPress"]}},{type:"enum",name:"button 4 event",ref:{value:"btn4event",options:["shortPress","longPress"]}}]},SmartButton:{status:[{type:"enum",name:"last event",ref:{value:"levent",options:["INITIAL_PRESS","HOLD","SHORT_RELEASED","LONG_RELEASED"]}},{type:"int",name:"battery",ref:{value:"battery",extMeta:"0-100"}},{type:"enum",name:"reachable",ref:{value:"reachable",
options:["true","false"]}},{type:"string",name:"last event time",ref:{value:"ltime"}}],ipevt:[{type:"int",name:"battery",ref:{value:"battery",extMeta:"0-100"}},{type:"enum",name:"button event",ref:{value:"btn1event",options:["shortPress","longPress"]}}]},ZLLPresence:{status:[{type:"enum",name:"detect motion",ref:{value:"motion",options:["true","false"]}},{type:"string",name:"last event time",ref:{value:"ltime"}},{type:"int",name:"battery",ref:{value:"battery"}},{type:"enum",name:"detect motion (on/off)",
ref:{value:"motion2",options:["on","off"]}}],ipevt:[{type:"enum",name:"detect motion",ref:{value:"motion",options:["true","false"]}}]},ZLLTemperature:{status:[{type:"float",name:"temperature",ref:{value:"temperature"}},{type:"string",name:"last event time",ref:{value:"ltime"}},{type:"int",name:"battery",ref:{value:"battery"}}],ipevt:[{type:"float",name:"temperature",ref:{value:"temperature"}},{type:"int",name:"battery",ref:{value:"battery"}}]},ZLLLightLevel:{status:[{type:"int",name:"light level",
ref:{value:"lightlevel"}},{type:"enum",name:"dark",ref:{value:"dark",options:["true","false"]}},{type:"enum",name:"daylight",ref:{value:"daylight",options:["true","false"]}},{type:"string",name:"last event time",ref:{value:"ltime"}},{type:"int",name:"battery",ref:{value:"battery"}}],ipevt:[{type:"int",name:"light level",ref:{value:"lightlevel"}},{type:"enum",name:"dark",ref:{value:"dark",options:["true","false"]}},{type:"enum",name:"daylight",ref:{value:"daylight",options:["true","false"]}},{type:"int",
name:"battery",ref:{value:"battery"}}]}}};xnm.aio.hue.DMError=function(a,c){this.code=a;this.message=c;this.stack=Error().stack};xnm.aio.hue.DMError.prototype=Error();xnm.aio.hue.DMError.prototype.name="HUEDeviceManagerError";xnm.aio.hue.DMError.prototype.code=0;xnm.aio.hue.DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};
xnm.aio.hue.DM={SYS:"hue",getGatewayType:function(){return[{sys:this.SYS,name:"Philips HUE"}]},createGateway:function(a,c,b){c=xnm.aio.hue.DMError;var d=xnm.aio.hue.DMError.ERROR_CODE;a?a.ip?b(null,a):b(new c(d.INVALID,"ip is invalid")):b(new c(d.INVALID,"info is invalid"))},updateGateway:function(a,c,b,d){a=xnm.aio.hue.DMError;b=xnm.aio.hue.DMError.ERROR_CODE;c?c.ip?d(null,c):d(new a(b.INVALID,"ip is invalid")):d(new a(b.INVALID,"update is invalid"))},deleteGateway:function(a,c,b){b()},createDevice:function(a,
c,b){var d=xnm.aio.hue.DMError,e=xnm.aio.hue.DMError.ERROR_CODE;if(a)if(a.gateway)if(null==a.address||"undefined"==typeof a.address)b(new d(e.INVALID,"address is invalid"));else if(a.category)if(c.data&&c.data.gateways&&0!==c.data.gateways.length){c=c.data.gateways;var f;for(f=0;f<c.length;f++)if(c[f].index===a.gateway){var g=c[f];break}g?b(null,a):b(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else b(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else b(new d(e.INVALID,
"catagory is invalid"));else b(new d(e.INVALID,"gateway is invalid"));else b(new d(e.INVALID,"info is invalid"))},updateDevice:function(a,c,b){var d=xnm.aio.hue.DMError,e=xnm.aio.hue.DMError.ERROR_CODE;if(a)if(null==a.address||"undefined"==typeof a.address)b(new d(e.INVALID,"address is invalid"));else if(a.category)if(a.gateway){c=c.data.gateways;var f;for(f=0;f<c.length;f++)if(c[f].index===a.gateway){var g=c[f];break}g?b(null,a):b(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else b(new d(e.INVALID,
"gateway is invalid"));else b(new d(e.INVALID,"catagory is invalid"));else b(new d(e.INVALID,"info is invalid"))},deleteDevice:function(a,c,b){b()},applyUIFilter:function(a,c){var b=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},d=function(a,c,d){var e=[];switch(d.catagory){case "command":a.command&&a.command.forEach(function(a){b(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){b(d.elems,
a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},e=function(a,b){var c=[],e=xnm.aio.hue.DM.getCommandStatusMap(a);e&&(a=d(e,a,b),c=c.concat(a));return c};if(!a.category)return null;var f=JSON.parse(JSON.stringify(a)),g=null;switch(c.catagory){case "command":g=e(a,c);f.command=g;break;case "status":g=e(a,c);f.status=g;break;default:return null}return g&&0!=g.length?f:null},applyIPEventFilter:function(a,c){if(!a.sys||"sensor"!=a.category)return null;c=this.getCommandStatusMap(a);if(!c)return null;
a=JSON.parse(JSON.stringify(a));a.ipevt=c.ipevt;return a},getCommandStatusMap:function(a,c){c=function(a,b){var c=[],d=[];a&&a.command&&0<a.command.length&&(c=c.concat(a.command));b&&b.command&&0<b.command.length&&(c=c.concat(b.command));a&&a.status&&0<a.status.length&&(d=d.concat(a.status));b&&b.status&&0<b.status.length&&(d=d.concat(b.status));return{command:c,status:d}};if(!a.type)return null;if("sensor"==a.category)return"ROM001"==a.modelid?xnm.aio.hue.MAP.sensor.SmartButton:xnm.aio.hue.MAP.sensor[a.type];
var b=a.type.toLowerCase(),d=[];if(a.state||a.action){var e=a.state;if("room"==b||"lightgroup"==b||"luminaire"==b||"lightsource"==b||"zone"==b)e=a.action;e&&(null!=e.on&&"undefined"!=typeof e.on&&(d=c(d,xnm.aio.hue.MAP.onoff)),null!=e.bri&&"undefined"!=typeof e.bri&&(d=c(d,xnm.aio.hue.MAP.dimmable)),null!=e.ct&&"undefined"!=typeof e.ct&&(d=c(d,xnm.aio.hue.MAP.colortemp)),null!=e.hue&&"undefined"!=typeof e.hue&&(d=c(d,xnm.aio.hue.MAP.colorlight)),"room"==b||"lightgroup"==b||"luminaire"==b||"lightsource"==
b||"zone"==b)&&(d=c(d,xnm.aio.hue.MAP.group))}else switch(a.type.toLowerCase()){case "on/off light":case "on/off plug-in unit":d=xnm.aio.hue.MAP.onoff;break;case "dimmable light":case "dimmable plug-in unit":d=c(xnm.aio.hue.MAP.onoff,xnm.aio.hue.MAP.dimmable);break;case "color temperature light":d=c(xnm.aio.hue.MAP.onoff,xnm.aio.hue.MAP.colortemp);break;case "color light":d=c(c(xnm.aio.hue.MAP.onoff,xnm.aio.hue.MAP.dimmable),xnm.aio.hue.MAP.colorlight);break;case "extended color light":case "lightgroup":case "luminaire":case "lightsource":if(d=
c(c(c(xnm.aio.hue.MAP.onoff,xnm.aio.hue.MAP.dimmable),xnm.aio.hue.MAP.colortemp),xnm.aio.hue.MAP.colorlight),"lightgroup"==b||"luminaire"==b||"lightsource"==b)d=c(d,xnm.aio.hue.MAP.group)}return d},supportSmartWidget:function(a){if(!a||!a.type)return!1;if("ZLLPresence"==a.type)return!0;a=this.applyUIFilter(a,{catagory:"command",elems:"*"});if(!a||!a.command||0==a.command.length)return!1;for(var c=0;c<a.command.length;c++){var b=a.command[c];if(b&&b.ref&&("on"==b.ref.value||"up"==b.ref.value||"ct"==
b.ref.value||"rgb"==b.ref.value))return!0}return!1},applySmartWidgetFilter:function(a,c,b){if(!a||!a.type)return!1;var d=this.applyUIFilter(a,{catagory:"command",elems:"*"});if(!d||!d.command||0==d.command.length)return!1;for(var e=!1,f=!1,g=!1,h=!1,k=0;k<d.command.length;k++){var m=d.command[k];m&&m.ref&&("on"==m.ref.value&&(e=!0),"up"==m.ref.value&&(f=!0),"ct"==m.ref.value&&(g=!0),"rgb"==m.ref.value&&(h=!0))}var n;if("ZLLPresence"==a.type){var p={"%motionState%":{value:"motion2",options:["on","off"],
name:"detect motion (on/off)"}};var l=["motion"]}e&&(n||(n={}),n["%on%"]||(n["%on%"]={value:"on",name:"on"}),n["%off%"]||(n["%off%"]={value:"off",name:"off"}),n["%toggle%"]||(n["%toggle%"]={value:"toggle",name:"toggle"}),p||(p={}),p["%switchState%"]||(p["%switchState%"]={value:"power",options:["off","on"],name:"power"}),l||(l=[]),-1==l.indexOf("switch")&&l.push("switch"));f&&(n||(n={}),n["%dimOn%"]||(n["%dimOn%"]={value:"on",name:"on"}),n["%dimOff%"]||(n["%dimOff%"]={value:"off",name:"off"}),n["%dimUp%"]||
(n["%dimUp%"]={value:"up",name:"up"}),n["%dimDown%"]||(n["%dimDown%"]={value:"down",name:"down"}),n["%dimTo%"]||(n["%dimTo%"]={value:"bri",ext:"%d",extMeta:"0-100",name:"brightness"}),p||(p={}),p["%dimmerState%"]||(p["%dimmerState%"]={value:"brightness",name:"brightness"}),l||(l=[]),-1==l.indexOf("dimmer")&&l.push("dimmer"));g&&(n||(n={}),n["%colorTemp%"]||(n["%colorTemp%"]={value:"ct",ext:"%d",extMeta:"153-500",name:"color temperature"}),l||(l=[]),-1==l.indexOf("color_temp")&&l.push("color_temp"));
h&&(n||(n={}),n["%rgb%"]||(n["%rgb%"]={value:"rgb",ext:"%s",name:"rgb color"}),n["%white%"]||(n["%white%"]={value:"rgbS",ext:"FFFFFF",name:"rgb color"}),l||(l=[]),-1==l.indexOf("rgb")&&l.push("rgb"));return l&&0!=l.length?this._injectToSmartWidgetTemplate(c,l,b,n,p):null},_injectToSmartWidgetTemplate:function(a,c,b,d,e){var f=[];a||(d={});d||(d={});e||(e={});for(var g=0;g<a.length;g++){var h=a[g];if(h.meta&&-1!=c.indexOf(h.meta.type)&&h.elements){h=JSON.parse(JSON.stringify(h));var k=!1,m;for(m in h.elements){var n=
h.elements[m];if(n&&Array.isArray(n))for(var p=0;p<n.length;p++){var l=n[p];l&&(l.action&&"command"==l.action.type&&l.action.ref&&l.action.ref.value&&(d[l.action.ref.value]?(l.action.ref=d[l.action.ref.value],l.action.device=b,k=!0):l.action=null),l.status&&l.status.ref&&l.status.ref.value&&(e[l.status.ref.value]?(l.status.ref=e[l.status.ref.value],l.status.device=b,k=!0):l.status=null))}}k&&f.push(h)}}return f}};
xnm.aio.hue.Handler.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"hue")};xnm.aio.hue.Handler.prototype.devicemanager=xnm.aio.hue.DM;xnm.aio.hue.Handler.prototype.Light=xnm.aio.hue.Light;xnm.aio.hue.Handler.prototype.Group=xnm.aio.hue.Group;xnm.aio.hue.Handler.prototype.Scene=xnm.aio.hue.Scene;xnm.aio.hue.Handler.prototype.Sensor=xnm.aio.hue.Sensor;
xnm.aio.hue.Handler.prototype.discoverBridgesWithTimeout=function(a,c){this._discoverCallbacks||(this._discoverCallbacks=[]);for(var b=!1,d=0;d<this._discoverCallbacks.length;d++)if(this._discoverCallbacks[d]===c){b=!0;break}b||this._discoverCallbacks.push(c);var e=this,f=[];10>=a&&(a=10);setTimeout(function(){if(null!=e._discoverCallbacks)for(var a=0;a<e._discoverCallbacks.length;a++)e._discoverCallbacks[a](null,f);e._discoverCallbacks=null},1E3*a);this.discoverBridges(function(a){if(a){for(var b=
0;b<f.length;b++)if(f[b].uuid==a.uuid)return;f.push(a)}})};xnm.aio.hue.Handler.prototype.auth=function(a,c){a.ip?(a=this.resolveGateway(a))?a.authorizeUser2(function(a,d){c&&c(a,d)}):c&&c(Error("gateway json format invalid")):c&&c(Error("bridge format invalid"))};
xnm.aio.hue.Handler.prototype.getDeviceList=function(a,c){if(a.ip)if(a=this.resolveGateway(a)){var b=3,d=[];xnm.aio.hue.Light.getAllLights(a,function(a,f){b--;f&&(d=d.concat(f));0==b&&c&&c(a,d)});xnm.aio.hue.Group.getAllGroups(a,function(a,f){b--;f&&(d=d.concat(f));0==b&&c&&c(a,d)});xnm.aio.hue.Sensor.getAllSensors(a,function(a,f){b--;f&&(d=d.concat(f));0==b&&c&&c(a,d)})}else c&&c(Error("gateway json format invalid"));else c&&c(Error("bridge format invalid"))};
xnm.aio.hue.Handler.prototype.createGroup=function(a,c,b){a.ip?(a=this.resolveGateway(a))?xnm.aio.hue.Group.createGroup(a,c,b):b&&b(Error("gateway json format invalid")):b&&b(Error("bridge format invalid"))};xnm.aio.hue.Handler.prototype.resolveGateway=function(a){return new xnm.aio.hue.Bridge(a.ip,a.port,a.uuid,null,a.username)};xnm.aio.hue.Handler.prototype.getDeviceCommands=function(a,c){a=(a=xnm.aio.hue.DM.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];c&&c(null,a)};
xnm.aio.hue.Handler.prototype.getDeviceStatus=function(a,c){a=(a=xnm.aio.hue.DM.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];c&&c(null,a)};xnm.aio.hue.Handler.prototype.getSceneCommands=function(a,c){a.ip?(a=this.resolveGateway(a))?xnm.aio.hue.Scene.getAllScenes(a,function(a,d){if(a)c&&c(a);else{a={};if(d)for(var b in d)d.hasOwnProperty(b)&&d[b]&&d[b].name&&(a[b]=d[b].name);c&&c(null,a)}}):c&&c(Error("gateway json format invalid")):c&&c(Error("bridge format invalid"))};
xnm.aio.hue.Handler.prototype.doCommand=function(a,c,b,d){(a=this.resolveGateway(a))?a.executeCommandCreator(c,b,function(a){d&&d(a)}):d&&d(Error("gateway json format invalid"))};xnm.aio.hue.Handler.prototype.doStatus=function(a,c,b,d,e){(c=this.resolveGateway(c))?c.getStatesCreator(null,[{id:a,device:b,status:d}],function(a,b){a?e&&e(a):e&&e(null,b[0])}):e&&e(Error("gateway json format invalid"))};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.hue.Handler);
