var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.warema=xnm.aio.warema||{};
xnm.aio.warema.WebControl=function(){var g={_buffer:[],addComm:function(a){this._buffer.push(a)},removeComm:function(a){a=this._buffer.indexOf(a);-1!=a&&this._buffer.splice(a)},finalize:function(){for(var a=0;a<this._buffer.length;a++)this._buffer[a]&&this._buffer[a].close();this._buffer=[]}},h=function(a){this._logger=require("x.logger.js").getLogger("xnm.aio.warema.WebControl.Comm");this._listener=a;this._connectCallbacks=[];this._port=this._host=null;this._packetBuffer=[];this._status=0;this._timeout=
1E3;this._responseTimeout=2E3;this._idleTimeout=15E3;this._idleTO=null;this._cnt=0;this._socket=null};h.prototype.connect=function(a,b,c){if(2==this._status)c&&c();else if(c&&-1==this._connectCallbacks.indexOf(c)&&this._connectCallbacks.push(c),1!=this._status){this._host=a;this._port=b;this._logger.log("trace","connect socket:"+this._host);var e=this;a={port:this._port,host:this._host};var f=require("net").connect(a);f.setTimeout(this._timeout);this._status=1;f.on("connect",function(){e._logger.log("trace",
"connected to warema:"+e._host);f.__disconnected||e._onSocketConnect()});f.on("data",function(a){e._logger.log("trace","receive from warema "+(f.__disconnected?"(closed)":"")+":"+e._host+" data:"+a.toString("hex"));f.__disconnected||e._onSocketData(a)});f.on("error",function(a){e._logger.log("trace","warema gateway:"+e._host+" error:"+a.message);f.__disconnected||(1==e._status?e._onSocketConnect(a):(f.destroy&&f.destroy(),f.end(),e._onSocketClose(a)))});f.on("timeout",function(){f.__disconnected||
1!=e._status||(e._logger.log("trace","warema connect:"+e._host+" timeout"),f.destroy&&f.destroy(),e._onSocketConnect(Error("connect timeout")))});f.on("close",function(){e._logger.log("trace","warema gateway:"+(f.__disconnected?"(closed)":"")+":"+e._host+" close socket");f.__disconnected||e._onSocketClose()});f._doConnect&&"function"==typeof f._doConnect&&f._doConnect();this._socket=f}};h.prototype.close=function(){this._logger.log("trace","close socket");this._socket&&(this._socket.__disconnected=
!0,this._socket.end());this._onSocketClose()};h.prototype.sendPacket=function(a,b){if(2!=this._status)b&&b(Error("socket not connected"));else{var c=this;this._cnt++;255<this._cnt&&(this._cnt=0);var e={cnt:this._cnt,data:a,callback:b};this._packetBuffer.push(e);e.timeout=setTimeout(function(){c._logger.log("trace","response timeout for packet:"+e.cnt);var a=c._packetBuffer.indexOf(e);-1!=a&&c._packetBuffer.splice(a,1);b&&b(Error("reponse timeout"))},this._responseTimeout);this._send(e.cnt,a)}};h.prototype._send=
function(a,b){this._idleTO&&(clearTimeout(this._idleTO),this._idleTO=null);var c=this;this._idleTO=setTimeout(function(){c._logger.log("trace","idle timeout");c.close()},this._idleTimeout);var e=[144,this._cnt,b.length].concat(b);this._logger.log("trace","send data:"+(new Buffer(e)).toString("hex"));this._socket&&this._socket.write(new Buffer(e))};h.prototype._onSocketConnect=function(a){this._status=a?0:2;var b=this._connectCallbacks;this._connectCallbacks=[];for(var c=0;c<b.length;c++){var e=b[c];
e&&e(a)}if(!a){var f=this;this._idleTO&&clearTimeout(this._idleTO);this._idleTO=setTimeout(function(){f._logger.log("trace","connection idle timeout");f.close()},this._idleTimeout)}a||g.addComm(this)};h.prototype._onSocketClose=function(a){this._logger.log("trace","socket closed with err:"+(a?a.message:null));g.removeComm(this);this._idleTO&&(clearTimeout(this._idleTO),this._idleTO=null);this._socket&&(this._socket.__disconnected=!0);this._status=0;this._socket=null;var b=this._packetBuffer;this._packetBuffer=
[];for(var c=0;c<b.length;c++){var e=b[c];e.timeout&&clearTimeout(e.timeout);a||(a=Error("socket closed"));e.callback&&e.callback(a)}};h.prototype._onSocketData=function(a){var b=-1;if(2<a.length)for(var c=a[1],e=0;e<this._packetBuffer.length;e++){var f=this._packetBuffer[e];if(f&&f.cnt==c){f.timeout&&clearTimeout(f.timeout);b=e;f.callback&&f.callback(null,a.slice(2));break}}-1!=b&&this._packetBuffer.splice(b,1)};var d=function(a,b){this._logger=require("x.logger.js").getLogger("xnm.aio.warema.WebControl");
this._host=a;this._port=b;this._port||(this._port=5E4);this._comm=new h(this);this.CommandHandler=null;this._reqBuffer=[];this._positionReqCallbacks={};this._blackList=[]};d.prototype._setPersistantData=function(a){};d.prototype._getString=function(a){for(var b="",c=0;c<a.length;c++)b+=String.fromCharCode(a[c]);return b};d.prototype._adr2id=function(a){var b=a.split(".");a=parseInt(b[0]);b=parseInt(b[1]);return{roomid:a,deviceid:b}};d.prototype._sendRequest=function(a,b){var c=this;this._comm.connect(this._host,
this._port,function(e){e?b&&b(e):c._comm.sendPacket(a,function(a,c){a?b&&b(a):c?b&&b(a,c):b&&b(Error("response is null"))})})};d.prototype.POLL_MAP={33:0,35:1,103:11};d.prototype._doRequest=function(a,b){var c=this;this._sendRequest(a,function(e,f){if(e)b&&b(e);else if(3==f[0]&&52==f[1])e=Error("error message"),e.requestID=f[2],e.errorCode=f[3],b&&b(e);else if(3==f[0]&&51==f[1]){var k=c.POLL_MAP[a[0]];if(2==f[3])e=Error("gateway stack timeout"),e.errorCode=-2,b&&b(e);else{var d=function(e,f){e?b&&
b(e):51==f[1]||50==f[1]?51==f[1]&&2==f[3]||50==f[1]&&2==f[5]?(e=Error("gateway stack timeout"),e.errorCode=-2,b&&b(e)):setTimeout(function(){c._poll(a[1],a[2],k,d)},50):b&&b(null,f)};c._poll(a[1],a[2],k,d)}}else b&&b(null,f)})};d.prototype._executeNextRequest=function(){if(0!=this._reqBuffer.length){for(var a=-1,b=0;b<this._reqBuffer.length;b++){var c=this._reqBuffer[b];if(c&&c.data&&35!=c.data[0]){a=b;break}}-1==a&&(a=0);var e=this,f=this._reqBuffer[a];f.timeout&&(clearTimeout(f.timeout),f.timeout=
null);this._doRequest(f.data,function(a,b){f.callback&&f.callback(a,b);var c=e._reqBuffer.indexOf(f);-1!=c&&e._reqBuffer.splice(c,1);e._executeNextRequest()})}};d.prototype._executeRequest=function(a,b){var c=this,e=this._reqBuffer.length,f={data:a,callback:b};f.timeout=setTimeout(function(){var a=c._reqBuffer.indexOf(f);-1!=a&&c._reqBuffer.splice(a,1);b&&b(Error("queue busy"))},1E4);this._reqBuffer.push(f);0==e&&this._executeNextRequest()};d.prototype._closeSocket=function(){this._comm.close()};
d.prototype._getRoomDevice=function(a,b,c){var e=this;this._doRequest([13,a,b],function(a,k){if(a)c&&c(a);else if(!k||6>k[0]||14!=k[1])c&&c(Error("response invalid"));else if(6==k[0])c&&c(null,null);else{var d={};d.name=e._getString(k.slice(7));d.id=b;0==k[4]?(d.type="device",7==k[6]?d.type="switch":2==k[6]?d.type="blind":3==k[6]?d.type="shutter":4==k[6]?d.type="awning":4==k[5]&&5==k[6]||6==k[5]&&5==k[6]?d.type="awning_valance":22==k[5]&&5==k[6]||23==k[5]&&5==k[6]?d.type="awning_valance2":15==k[5]&&
1==k[6]?d.type="window":26==k[5]&&6==k[6]&&(d.type="dimmer"),d.data=[k[5],k[6]]):(d.type="scene",d.data=[k[4]]);c&&c(null,d)}})};d.prototype._getRoomDevices=function(a,b){var c=this,e=0,f=[],d=function(g,h){g?2==g.errorCode?b&&b(null,f):b&&b(g):h?(h.address=a+"."+h.id,f.push(h),c._getRoomDevice(a,++e,d)):b&&b(null,f)};this._getRoomDevice(a,e,d)};d.prototype._getRoom=function(a,b){var c=this;this._doRequest([3,a],function(e,f){if(e)b&&b(e);else if(!f||2>f[0]||4!=f[1])b&&b(Error("response invalid"));
else if(2==f[0])b&&b(null,null);else{var d=c._getString(f.slice(3));c._getRoomDevices(a,function(c,e){b&&b(c,c?null:{name:d,id:a,devices:e})})}})};d.prototype._poll=function(a,b,c,e){this._sendRequest([49,a,b,c],function(a,b){a?e&&e(a):b?e&&e(null,b):e&&e(Error("response invalid"))})};d.prototype._getPosition=function(a,b,c){this._executeRequest([35,a,b],function(a,b){if(a)c&&c(a);else if(!b||8>b[0]||36!=b[1])c&&c(Error("response invalid"));else{var d={};d.roomid=b[2];d.deviceid=b[3];d.fahrt=b[4];
d.position=b[5];d.winkel=b[6];d.pos_volant1=b[7];d.pos_volant2=b[8];c&&c(null,d)}})};d.prototype._control=function(a,b,c,e,d){a=[33,a,b,c];e||(e=[255,255,255,255]);a=a.concat(e);this._executeRequest(a,function(a,b){if(a)d&&d(a);else if(b){var c=null;4==b[0]&&34==b[1]&&(c={code:b[1],roomid:b[2],deviceid:b[3],feedback:b[4]});c||(a=Error("unknow response"));d&&d(a,c)}else d&&d(Error("response is null"))})};d.prototype._comfort=function(a,b,c,d){this._executeRequest([103,a,b,c],function(a,b){if(a)d&&
d(a);else if(b){var c=null;4==b[0]&&104==b[1]&&(c={code:b[1],roomid:b[2],deviceid:b[3],execution:b[4]});c||(a=Error("unknow response"));d&&d(a,c)}else d&&d(Error("response is null"))})};d.prototype._resolveStates=function(a,b){var c=null;if(null==a)return{timeout:!0};switch(b.type){case "switch":200==a.position?c={state:"on"}:0==a.position&&(c={state:"off"});break;case "dimmer":c={};c.state=a.position/2;break;case "blind":case "shutter":case "awning":case "window":case "awning_valance":case "awning_valance2":c=
{};c.position=a.position/2;c.positionT=30>=c.position?"top":70<=c.position?"bottom":"middle";c.winkel=a.winkel-127;c.posVolant1=a.pos_volant1/2;c.posVolant2=a.pos_volant2/2;break;default:return null}c&&(c.timeout=!1);return c};d.prototype._getStates=function(a,b){if(-1!=this._blackList.indexOf(a)){var c=Error("device unreachable");c.errorCode=-2;b&&b(c)}else{c=this._positionReqCallbacks[a];c||(c=[],this._positionReqCallbacks[a]=c);var d=c.length;b&&-1==c.indexOf(b)&&c.push(b);if(0==d){var c=this._adr2id(a),
f=this;this._getPosition(c.roomid,c.deviceid,function(b,c){b&&-2==b.errorCode&&f._blackList.push(a);var d=f._positionReqCallbacks[a];f._positionReqCallbacks[a]=[];for(var e=0;e<d.length;e++)d[e]&&d[e](b,c)})}}};d.prototype.getDevices=function(a){var b=this,c=0,d=[],f=function(k,g){k?1==k.errorCode?a&&a(null,d):a&&a(k):g?(d.push(g),b._getRoom(++c,f)):a&&a(null,d)};this._getRoom(c,f)};d.prototype.executeCommandCreator=function(a,b,c){if(a&&a.address)if(b){var d=a.address.split(".");if(2!=d.length)c&&
c(Error("device address invalid"));else{var f=parseInt(d[0]),d=parseInt(d[1]),k,g=null,h=this;if("reset"==b.value)f=this._blackList.indexOf(a.address),-1!=f&&(this._blackList.splice(f,1),c&&c());else{switch(a.type){case "switch":switch(b.value){case "on":k=21;break;case "off":k=22;break;case "toggle":k=10;break;default:c&&c(Error("no such command"));return}break;case "dimmer":switch(b.value){case "on":k=28;g=[0,0,0,0];break;case "off":k=24;g=[0,0,0,0];break;case "dimTo":if("undefined"==typeof b.ext||
null==b.ext){c&&c(Error("command ext invalid"));return}b=parseFloat(b.ext);k=3;g=[2*b,255,255,255];break;default:c&&c(Error("no such command"));return}break;case "awning":case "shutter":case "window":switch(b.value){case "stepUp":this._getStates(a.address,function(b,d){if(b)c&&c(b);else{var e=h._resolveStates(d,a);e?(e=e.position,0==e?c&&c():h.executeCommandCreator(a,{value:"moveTo",ext:e-.5},c)):c&&c(Error("get rolladen states return invalid"))}});return;case "stepDown":this._getStates(a.address,
function(b,d){if(b)c&&c(b);else{var e=h._resolveStates(d,a);e?(e=e.position,0==e?c&&c():h.executeCommandCreator(a,{value:"moveTo",ext:e+.5},c)):c&&c(Error("get rolladen states return invalid"))}});return}case "blind":case "awning_valance":case "awning_valance2":switch(b.value){case "moveTo":if("undefined"==typeof b.ext||null==b.ext){c&&c(Error("command ext invalid"));return}b=parseFloat(b.ext);k=2;g=[2*b,255,255,255];break;case "winkelTo":if("undefined"==typeof b.ext||null==b.ext){c&&c(Error("command ext invalid"));
return}b=parseFloat(b.ext);k=3;g=[255,b+127,255,255];break;case "valanceTo":if("undefined"==typeof b.ext||null==b.ext){c&&c(Error("command ext invalid"));return}b=parseFloat(b.ext);k=3;"awning_valance"==a.type?g=[255,255,2*b,255]:"awning_valance2"==a.type&&(g=[255,255,2*b,2*b]);break;case "stepUp":k=4;break;case "stepDown":k=5;break;case "up":k=6;break;case "down":k=7;break;case "stop":k=1;break;case "comfort":this._comfort(f,d,1,c);return;default:c&&c(Error("no such command"));return}break;case "scene":switch(b.value){case "run":k=
8;break;default:c&&c(Error("no such command"));return}}this._control(f,d,k,g,function(b,a){c&&c(b,a)})}}}else c&&c(Error("command is null"));else c&&c(Error("device format invalid"))};d.prototype.getStatesCreator=function(a,b,c){var d=function(b,a){for(var c=b.roomid+"."+b.deviceid,d=[],e=0;e<a.length;e++)if(a[e]&&a[e].id){var g="?";if(a[e]&&a[e].device&&a[e].status&&a[e].status.value){var k=a[e].status.value,h=a[e].device;if(h.address&&h.address==c){(h=b.timeout?{timeout:!0}:f._resolveStates(b,h))&&
(g=h[k]);if("undefined"==typeof g||null==g)g="?";d.push({id:a[e].id,status:g})}}}return d},f=this;this.CommandHandler=a;var g=[];for(a=0;a<b.length;a++)if(b[a]&&b[a].device){var h=b[a].device;h.address&&-1==g.indexOf(h.address)&&g.push(h.address)}var m=0,n=[],p=function(a,h){if(a&&-2==a.errorCode){var l=f._adr2id(g[m]);l.timeout=!0;(l=d(l,b))&&(n=n.concat(l))}!a&&h&&(l=d(h,b))&&(n=n.concat(l));m++;m==g.length?c&&c(null,n):f._getStates(g[m],p)};this._getStates(g[m],p)};d.prototype.toJSON=function(){return{sys:"warema",
ip:this._host,port:this._port}};d.prototype.equalsTo=function(a){return a&&a instanceof d?this._host==a._host&&this._port==a._port:!1};d.finalize=function(){g.finalize()};return d}();
xnm.aio.warema.DM=function(){var g=function(d,a){this.code=d;this.message=a;this.stack=Error().stack};g.prototype=Error();g.prototype.name="WaremaDMError";g.prototype.code=0;g.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var h={"switch":{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"enum",name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"enum",
name:"state",ref:{value:"state",options:["on","off"]}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},dimmer:{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"state",ref:{value:"state",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"timeout",ref:{value:"timeout",
options:["true","false"]}}]},blind:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"winkel to",ref:{value:"winkelTo",ext:"%d",extMeta:"-80-80"}},{type:"enum",
name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top","middle","bottom"]}},{type:"int",name:"winkel",ref:{value:"winkel",ext:"%d",extMeta:"-80-80"}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},shutter:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",
name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top",
"middle","bottom"]}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},awning:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"enum",
name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top","middle","bottom"]}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},awning_valance:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},
{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"valance to",ref:{value:"valanceTo",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top","middle",
"bottom"]}},{type:"int",name:"valance",ref:{value:"valance",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},awning_valance2:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",
ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"valance to",ref:{value:"valanceTo",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top","middle","bottom"]}},{type:"int",name:"valance",ref:{value:"valance",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true",
"false"]}}]},window:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",
ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top","middle","bottom"]}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},scene:{command:[{type:"enum",name:"run",ref:{value:"run"}}]}};return{SYS:"warema",getGatewayType:function(){return[{sys:this.SYS,name:"warema WebControl",port:5E4}]},getGatewayDeviceType:function(){return[{sys:this.SYS,name:"Switch",type:"switch"},{sys:this.SYS,name:"Dimmer",type:"dimmer"},
{sys:this.SYS,name:"Blind",type:"blind"},{sys:this.SYS,name:"Shutter",type:"shutter"},{sys:this.SYS,name:"Awning",type:"awning"},{sys:this.SYS,name:"Awning with Valance",type:"awning_valance"},{sys:this.SYS,name:"Awning with 2 Valance",type:"awning_valance2"},{sys:this.SYS,name:"Scene",type:"scene"}]},createGateway:function(d,a,b){a=g.ERROR_CODE;d?d.ip?b(null,d):b(new g(a.INVALID,"ip is invalid")):b(new g(a.INVALID,"info is invalid"))},updateGateway:function(d,a,b,c){d=g.ERROR_CODE;a?a.ip?c(null,
a):c(new g(d.INVALID,"ip is invalid")):c(new g(d.INVALID,"update is invalid"))},deleteGateway:function(d,a,b){b()},createDevice:function(d,a,b){var c=g.ERROR_CODE;if(d)if(d.gateway)if(null==d.address||"undefined"==typeof d.address)b(new g(c.INVALID,"address is invalid"));else if(null==d.type||"undefined"==typeof d.type)b(new g(c.INVALID,"type is invalid"));else if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var e,f;for(e=0;e<a.length;e++)if(a[e].index===d.gateway){f=a[e];
break}f?b(null,d):b(new g(c.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else b(new g(c.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else b(new g(c.INVALID,"gateway is invalid"));else b(new g(c.INVALID,"info is invalid"))},updateDevice:function(d,a,b){var c=g.ERROR_CODE;if(d)if(d.gateway)if(null==d.address||"undefined"==typeof d.address)b(new g(c.INVALID,"address is invalid"));else if(null==d.type||"undefined"==typeof d.type)b(new g(c.INVALID,"type is invalid"));else if(a.data&&
a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var e,f;for(e=0;e<a.length;e++)if(a[e].index===d.gateway){f=a[e];break}f?b(null,d):b(new g(c.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else b(new g(c.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else b(new g(c.INVALID,"gateway is invalid"));else b(new g(c.INVALID,"info is invalid"))},deleteDevice:function(d,a,b){b()},applyUIFilter:function(d,a,b){var c=function(a,b,d){var e=[];a.forEach(function(a){if("root"==
a.type){a=JSON.parse(JSON.stringify(a));var f=c(a.children,b,d);f&&0<f.length&&(a.children=f,e.push(a))}else{f=d.elems;if("*"==f)f=!0;else{for(var g=!1,h=0;h<f.length;h++)if(f[h]==a.type){g=!0;break}f=g}f&&(a=JSON.parse(JSON.stringify(a)),e.push(a))}});return e},e=function(a,d){var e=[],f=xnm.aio.warema.DM.getCommandStatusMap(a,b);if(f){var g=[];switch(d.catagory){case "command":f.command&&(g=c(f.command,a,d));break;case "status":f.status&&(g=c(f.status,a,d))}e=e.concat(g)}return e};if(!d.sys)return null;
var f=JSON.parse(JSON.stringify(d)),g=null;switch(a.catagory){case "command":g=e(d,a);f.command=g;break;case "status":g=e(d,a);f.status=g;break;default:return null}return g&&0!=g.length?f:null},getCommandStatusMap:function(d){return d&&d.type?h[d.type]:null}}}();xnm.aio.warema.Handler=function(){this.detectedWebControls={}};xnm.aio.warema.Handler.prototype.getStateValues=function(g,h){return(new xnm.aio.warema.WebControl).getStateValues(g.type,h)};
xnm.aio.warema.Handler.prototype.getDeviceCommandList=function(g,h,d){h=[];"Switch"==g.type&&(h.push({id:"on",cmd:"ON"}),h.push({id:"off",cmd:"OFF"}));return h};xnm.aio.warema.Handler.prototype.WebControl=xnm.aio.warema.WebControl;xnm.aio.warema.Handler.prototype.devicemanager=xnm.aio.warema.DM;xnm.aio.warema.Handler.prototype.registModule=function(g){g.register(this.devicemanager.SYS,"warema")};
xnm.aio.warema.Handler.prototype.resolveGateway=function(g){return g&&g.ip?new this.WebControl(g.ip,g.port):null};xnm.aio.warema.Handler.prototype.getDeviceCommands=function(g,h){var d=this.devicemanager.applyUIFilter(g,{catagory:"command",elems:"*"}),d=d?d.command:[];h&&h(null,d)};xnm.aio.warema.Handler.prototype.getDeviceStatus=function(g,h){var d=this.devicemanager.applyUIFilter(g,{catagory:"status",elems:"*"}),d=d?d.status:[];h&&h(null,d)};
xnm.aio.warema.Handler.prototype.doCommand=function(g,h,d,a){(g=this.resolveGateway(g))?g.executeCommandCreator(h,d,function(b){a&&a(b)}):a&&a(Error("gateway json format invalid"))};xnm.aio.warema.Handler.prototype.doStatus=function(g,h,d,a,b){(h=this.resolveGateway(h))?h.getStatesCreator(null,[{id:g,device:d,status:a}],function(a,d){a?b&&b(a):b&&b(null,d[0])}):b&&b(Error("gateway json format invalid"))};
xnm.aio.warema.Handler.prototype.discoveryWithTimeout=function(g,h){var d=this,a=require("x.mdns.js");a.clearRecordBuffer();a.discoverServiceWithTimeout("_ipp._tcp.local",g,function(a,c){if(a)h&&h(a);else{for(var e=[],f=0;f<c.length;f++){var g=c[f];g.target&&g.ip&&0<g.ip.length&&-1!=g.target.toLowerCase().indexOf("webcontrol")&&(g=new d.WebControl(g.ip[0]),e.push(g))}h&&h(a,e)}})};
xnm.aio.warema.Handler.prototype.getDeviceList=function(g,h){var d=this.resolveGateway(g);d?d.getDevices(function(a,b){h&&h(a,b)}):h&&h(Error("gateway json format invalid"))};xnm.aio.warema.Handler.prototype.finalize=function(g){var h=g;setTimeout(function(){h&&(h(),h=null)},3E3);this.WebControl.finalize(function(){h&&(h(),h=null)})};xnm.aio.warema.Handler.prototype.pause=function(g){this.finalize(g)};
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.warema.Handler);
