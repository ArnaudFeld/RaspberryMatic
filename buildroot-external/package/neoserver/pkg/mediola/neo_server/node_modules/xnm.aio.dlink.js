var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.dlink=xnm.aio.dlink||{};
xnm.aio.dlink.WifiDevice=function(){var d=function(c){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.WifiDevice");c&&(this.ip=c.ip,this.port=c.port,this.port||(this.port=80),this.username=c.username,this.username||(this.username="admin"),this.password=c.password,this.model=c.model,this.mac=c.mac);this._logginTime=this._cookie=this._privateKey=this._challenge=null;this._loginRunning=!1;this._loginCallbacks=[]};d.prototype.HNAP_PATH=
"/HNAP1";d.prototype.HNAP_METHOD="POST";d.prototype.HNAP1_XMLNS="http://purenetworks.com/HNAP1/";d.prototype.HNAP_LOGIN_ACTION="Login";d.prototype.toJSON=function(){return{sys:"dlink",type:"wifi",model:this.model,mac:this.mac,ip:this.ip,port:this.port,username:this.username,password:this.password}};d.prototype.equalsTo=function(c){return c&&c instanceof d?this.type==c.type&&this.data==c.data&&this.ip==c.ip&&this.port==c.port&&this.username==c.username&&this.password==c.password:!1};d.prototype.getStatesCreator=
function(c,a,b){c=[];for(var g=0;g<a.length;g++)if(a[g]&&a[g].id&&a[g].status&&a[g].status.value){var f=a[g].status.value;-1==c.indexOf(f)&&c.push(f)}this._getStates(c,function(c,g){for(var f=[],d=0;d<a.length;d++)if(a[d]&&a[d].id){var m="?";if(g&&a[d].status&&a[d].status.value){var n=a[d].status.value;null!=g[n]&&"undefined"!=typeof g[n]&&(m=g[n])}f.push({id:a[d].id,status:m})}b&&b(null,f)})};d.prototype._getModuleProfile=function(c,a){this._doAction("GetModuleProfile",this._requestBody("GetModuleProfile",
this._moduleParameters(c)),"GetModuleProfileResponse",function(b,c){if(b)a&&a(b);else if(c){var f=c.find("GetModuleProfileResult");f&&0!=f.length?"OK"!=$(f[0]).text()?a&&a(Error("get module profile fail")):a&&a(null,c):a&&a(Error("get module profile without GetModuleProfileResult"))}else a&&a(Error("get module profile format error"))})};d.prototype._moduleParameters=function(c){return"<ModuleID>"+c+"</ModuleID>"};d.prototype._doAction=function(c,a,b,g){if(this._logginTime){var f=(new Date).getTime()-
this._logginTime;if(0>f||3E5<f)this._logginTime=this._cookie=this._privateKey=this._challenge=null}if(this._challenge&&this._privateKey&&this._cookie)this._soapAction(c,a,b,g);else{var e=this;this._login(function(f){f?g&&g(f):e._doAction(c,a,b,g)})}};d.prototype._loginRequest=function(){return"<Action>request</Action><Username>"+this.username+"</Username><LoginPassword></LoginPassword><Captcha></Captcha>"};d.prototype._loginParameters=function(){var c=require("x.crypt.js").HMAC_MD5(this._privateKey,
this._challenge);return"<Action>login</Action><Username>"+this.username+"</Username><LoginPassword>"+c.toUpperCase()+"</LoginPassword><Captcha></Captcha>"};d.prototype._handleLoginResult=function(c){var a=c.find("Challenge")[0];if(!a)return!1;this._challenge=a=$(a).text();var b=c.find("PublicKey")[0];if(!b)return!1;b=$(b).text();c=c.find("Cookie")[0];if(!c)return!1;this._cookie=c=$(c).text();this._privateKey=require("x.crypt.js").HMAC_MD5(b+this.password,a).toUpperCase();return!0};d.prototype._login=
function(c){c&&-1==this._loginCallbacks.indexOf(c)&&this._loginCallbacks.push(c);if(!this._loginRunning){this._loginRunning=!0;var a=this;this._soapAction(this.HNAP_LOGIN_ACTION,this._requestBody(this.HNAP_LOGIN_ACTION,this._loginRequest()),"LoginResponse",function(b,c){var f;b?(a._loginRunning=!1,f=a._loginCallbacks,a._loginCallbacks=[],f.forEach(function(c){c&&c(b)})):a._handleLoginResult(c)?(a._logginTime=(new Date).getTime(),a._soapAction(a.HNAP_LOGIN_ACTION,a._requestBody(a.HNAP_LOGIN_ACTION,
a._loginParameters()),"LoginResult",function(b,c){!b&&c&&"success"!=c.text()&&(b=Error("login failed"));a._loginRunning=!1;var g=a._loginCallbacks;a._loginCallbacks=[];g.forEach(function(c){c&&c(b)})})):(b=Error("LoginResponse format error"),a._loginRunning=!1,f=a._loginCallbacks,a._loginCallbacks=[],f.forEach(function(c){c&&c(b)}))})}};d.prototype._requestBody=function(c,a){return'<?xml version="1.0" encoding="utf-8"?><soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"><soap:Body><'+
c+' xmlns="'+this.HNAP1_XMLNS+'">'+a+"</"+c+"></soap:Body></soap:Envelope>"};d.prototype._getHnapAuth=function(c,a){var b=Math.round((new Date).getTime()/1E3);return require("x.crypt.js").HMAC_MD5(a,b+c).toUpperCase()+" "+b};d.prototype._soapAction=function(c,a,b,g){var f={"Content-Type":"text/xml; charset=utf-8",SOAPAction:'"'+this.HNAP1_XMLNS+c+'"'};this._privateKey&&(f.HNAP_AUTH=this._getHnapAuth('"'+this.HNAP1_XMLNS+c+'"',this._privateKey));this._cookie&&(f.Cookie="uid="+this._cookie);var e=this;
this._doRequest(this.HNAP_METHOD,this.HNAP_PATH,f,a,function(f,k,d){if(f)g&&g(f);else if(401==d)e._logger.log("warn","unauthorized soap action"),e._challenge=null,e._privateKey=null,e._cookie=null,e._login(function(f){f?g&&g(f):e._soapAction(c,a,b,g)});else if(200!=d)e._logger.log("warn","http request error with status code:"+d),g&&g(Error("http request error with status code:"+d));else try{var m=null;$($($.parseXML(k)).children()[0]).find(b).each(function(){m=$(this)});m?g&&g(null,m):g&&g(Error("no response element:"+
b))}catch(n){g&&g(n)}})};d.prototype._doRequest=function(c,a,b,g,f){this._reqBuffer||(this._reqBuffer=[],this._totalReqNo=0);for(var e=0,h=0;h<this._reqBuffer.length;h++)this._reqBuffer[h].running&&e++;c={method:c,path:a,headers:b,data:g,callback:f,running:!1,no:this._totalReqNo++};this._reqBuffer.push(c);10>e&&this._doNextReq()};d.prototype._doNextReq=function(){for(var c=this,a=null,b=0;b<this._reqBuffer.length;b++)if(!this._reqBuffer[b].running){a=this._reqBuffer[b];break}if(a){a.running=!0;var g=
function(b,e,h){a.callback&&a.callback(b,e,h);b=c._reqBuffer.indexOf(g.__req);c._reqBuffer.splice(b,1);c._doNextReq()};g.__req=a;this._doRequest_(a.method,a.path,a.headers,a.data,g)}};d.prototype._doRequest_=function(c,a,b,g,f){var e=this;this._logger.log("trace","send "+c+" to url:"+("http://"+this.ip+":"+this.port+a));this._logger.log("trace","with headers:"+JSON.stringify(b));this._logger.log("trace","with data:"+g);var h=f;c={host:this.ip,port:this.port,path:a,method:c,headers:b};c.headers||(c.headers=
{});c.headers["Content-Type"]="text/xml";c.headers["Content-Length"]=g.length;c.headers["User-Agent"]="mediola";c.headers.Connection="close";var k="",d=require("http").request(c,function(b){b.on("data",function(b){k+=b});b.on("end",function(){e._logger.log("trace","http reponse status code:"+b.statusCode);e._logger.log("trace","http reponse:"+k);h&&h(null,k,b.statusCode);h=null})});d.setTimeout&&d.setTimeout(2E4,function(){d.abort()});if(d.on&&"function"==typeof d.on)d.on("error",function(b){b||(b=
Error("http request error"));h&&h(b);h=null});d.write(g);d.end()};d.parseJSON=function(c){if(!(c&&"wifi"==c.type&&c.data&&c.ip&&c.password))return null;switch(c.data){case "switch":return new xnm.aio.dlink.WifiPlug(c);case "motion":return new xnm.aio.dlink.WifiMotion(c);case "siren":return new xnm.aio.dlink.WifiSiren(c);case "water":return new xnm.aio.dlink.WifiWater(c);case "hub":return new xnm.aio.dlink.WifiHub(c);default:return null}};return d}();
xnm.aio.dlink.WifiPlug=function(){var d=function(c){xnm.aio.dlink.WifiDevice.call(this,c);this._getSettingsCbs=[];this._getReadyCbs=[];this._getTempCbs=[];this._getPowerCbs=[];this._getTotalPCbs=[];this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.WifiPlug")};d.prototype=new xnm.aio.dlink.WifiDevice;d.prototype.constructor=d;d.prototype.toJSON=function(){var c=xnm.aio.dlink.WifiDevice.prototype.toJSON.call(this);c.data="switch";
return c};d.prototype.executeCommandCreator=function(c,a,b){if(a&&a.value){var g=this;switch(a.value){case "on":case "off":xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0)?"on"==a.value?this._on(b):this._off(b):this._getSocketSettings(function(f){f?b&&b(f):g.executeCommandCreator(c,a,b)});break;case "toggle":this._getOnOffState(function(a,e){a?b&&b(a):g.executeCommandCreator(c,{value:"off"==e?"on":"off"},b)});break;default:b&&b(Error("unknown command"))}}else b&&b(Error("command json format invalid"))};
d.prototype._controlParameters=function(c,a,b,g){return this._moduleParameters(c)+"<NickName>"+a+"</NickName><Description>"+b+"</Description><OPStatus>"+g+"</OPStatus><Controller>1</Controller>"};d.prototype._on=function(c){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0),b=this;this._doAction("SetSocketSettings",this._requestBody("SetSocketSettings",this._controlParameters(1,a.nickName,a.description,!0)),"SetSocketSettingsResult",function(a,f){a||f&&"OK"==f.text()||(a=Error("turn plug on failed"));
a||xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,0,{opStatus:"true"});c&&c(a)})};d.prototype._off=function(c){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0),b=this;this._doAction("SetSocketSettings",this._requestBody("SetSocketSettings",this._controlParameters(1,a.nickName,a.description,!1)),"SetSocketSettingsResult",function(a,f){a||f&&"OK"==f.text()||(a=Error("turn plug off failed"));a||xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,0,{opStatus:"false"});c&&c(a)})};d.prototype._getStates=
function(c,a){if(c&&0!=c.length)for(var b={},g=0,f=function(){g++;g==c.length&&a&&a(null,b)},e=0;e<c.length;e++)switch(c[e]){case "ready":this._getDeviceReadyState(function(c,a){!c&&a&&(b.ready=a);f()});break;case "state":this._getOnOffState(function(a,c){!a&&c&&(b.state=c);f()});break;case "temp":this._getTempState(function(c,a){!c&&a&&(b.temp=a);f()});break;case "power":this._getCurrentPowerState(function(a,c){!a&&c&&(b.power=c);f()});break;case "totalPower":this._getTotalPowerState(function(c,
a){!c&&a&&(b.totalPower=a);f()});break;default:f()}else a&&a(null,{})};d.prototype._getSocketSettings=function(c){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0);if(a&&a.opStatus&&a.nickName&&a.description)c&&c(null,a);else if(a=this._getSettingsCbs.length,c&&-1==this._getSettingsCbs.indexOf(c)&&this._getSettingsCbs.push(c),0==a){var b=this;this._doAction("GetSocketSettings",this._requestBody("GetSocketSettings",this._moduleParameters(1)),"GetSocketSettingsResponse",function(a,c){var e=
b._getSettingsCbs;b._getSettingsCbs=[];if(a)e.forEach(function(b){b&&b(a)});else if(c){var h=c.find("GetSocketSettingsResult");if(h&&h[0]&&"OK"==$(h[0]).text()){var d=null,l=null,m=null;c.find("NickName").each(function(){l||(l=$(this).text())});c.find("Description").each(function(){m||(m=$(this).text())});c.find("OPStatus").each(function(){d||(d=$(this).text())});var n={nickName:l,description:m,opStatus:d};xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,0,n);e.forEach(function(b){b&&b(null,n)})}else a=
Error("get socket settings failed"),e.forEach(function(b){b&&b(a)})}else a=Error("get switch on/off state result format error"),e.forEach(function(b){b&&b(a)})})}};d.prototype._getDeviceReadyState=function(c){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0);if(a&&"undefined"!=typeof a.ready&&null!=a.ready)c&&c(null,a.ready);else if(a=this._getReadyCbs.length,c&&-1==this._getReadyCbs.indexOf(c)&&this._getReadyCbs.push(c),0==a){var b=this;this._doAction("IsDeviceReady",this._requestBody("IsDeviceReady",
""),"IsDeviceReadyResult",function(a,c){var e=b._getReadyCbs;b._getReadyCbs=[];if(a)e.forEach(function(b){b&&b(a)});else if(c){var h="OK"==c.text()?"true":"false";xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,0,{ready:h});e.forEach(function(b){b&&b(null,h)})}else a=Error("get device ready state result format error"),e.forEach(function(b){b&&b(a)})})}};d.prototype._getOnOffState=function(c){this._getSocketSettings(function(a,b){if(a)c&&c(a);else{var g=b.opStatus;c&&c(null,"true"==g?"on":"false"==
g?"off":"?")}})};d.prototype._getTempState=function(c){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0);if(a&&"undefined"!=typeof a.temp&&null!=a.temp)c&&c(null,a.temp);else if(a=this._getTempCbs.length,c&&-1==this._getTempCbs.indexOf(c)&&this._getTempCbs.push(c),0==a){var b=this;this._doAction("GetCurrentTemperature",this._requestBody("GetCurrentTemperature",this._moduleParameters(3)),"CurrentTemperature",function(a,c){var e=b._getTempCbs;b._getTempCbs=[];a?e.forEach(function(b){b&&b(a)}):
c?(xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,0,{temp:c.text()}),e.forEach(function(b){b&&b(null,c.text())})):(a=Error("get temperature state result format error"),e.forEach(function(b){b&&b(a)}))})}};d.prototype._getCurrentPowerState=function(c){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0);if(a&&"undefined"!=typeof a.power&&null!=a.power)c&&c(null,a.power);else if(a=this._getPowerCbs.length,c&&-1==this._getPowerCbs.indexOf(c)&&this._getPowerCbs.push(c),0==a){var b=this;this._doAction("GetCurrentPowerConsumption",
this._requestBody("GetCurrentPowerConsumption",this._moduleParameters(2)),"CurrentConsumption",function(a,c){var e=b._getPowerCbs;b._getPowerCbs=[];a?e.forEach(function(b){b&&b(a)}):c?(xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,0,{power:c.text()}),e.forEach(function(b){b&&b(null,c.text())})):(a=Error("get current power state result format error"),e.forEach(function(b){b&&b(a)}))})}};d.prototype._getTotalPowerState=function(c){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0);if(a&&"undefined"!=
typeof a.totalPower&&null!=a.totalPower)c&&c(null,a.totalPower);else if(a=this._getTotalPCbs.length,c&&-1==this._getTotalPCbs.indexOf(c)&&this._getTotalPCbs.push(c),0==a){var b=this;this._doAction("GetPMWarningThreshold",this._requestBody("GetPMWarningThreshold",this._moduleParameters(2)),"TotalConsumption",function(a,c){var e=b._getTotalPCbs;b._getTotalPCbs=[];a?e.forEach(function(b){b&&b(a)}):c?(xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,0,{totalPower:c.text()}),e.forEach(function(b){b&&b(null,
c.text())})):(a=Error("get total power state result format error"),e.forEach(function(b){b&&b(a)}))})}};return d}();
xnm.aio.dlink.WifiMotion=function(){var d=function(c){xnm.aio.dlink.WifiDevice.call(this,c);this._getSettingsCbs=[];this._getLastDetectCbs=[];this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.WifiMotion")};d.prototype=new xnm.aio.dlink.WifiDevice;d.prototype.constructor=d;d.prototype.toJSON=function(){var c=xnm.aio.dlink.WifiDevice.prototype.toJSON.call(this);c.data="motion";return c};d.prototype.executeCommandCreator=function(c,
a,b){if(a&&a.value){var g=this;switch(a.value){case "activate":case "deactivate":case "actToggle":case "sensTo":case "sensUp":case "sensDown":this._getMotionDetectorSettings(function(c,e){if(c)b&&b(c);else{var d;switch(a.value){case "activate":case "deactivate":g._setDetectorActive("activate"==a.value,b);break;case "actToggle":g._setDetectorActive("true"!=e.opStatus,b);break;case "sensTo":if("undefined"==typeof a.ext||null==a.ext){b&&b(Error("command ext invalid"));break}d=parseInt(a.ext);0>=d&&(d=
1);100<d&&(d=100);g._setDetectorSensitivity(d,b);break;case "sensUp":case "sensDown":d=parseInt(e.sensitivity),d="sensUp"==a.value?d+5:d-5,0>=d&&(d=1),100<d&&(d=100),g._setDetectorSensitivity(d,b)}}});break;default:b&&b(Error("unknown command"))}}else b&&b(Error("command json format invalid"))};d.prototype._controlParameters=function(c,a){return this._moduleParameters(c)+"<NickName>"+a.nickName+"</NickName><Description>"+a.description+"</Description><OPStatus>"+a.opStatus+"</OPStatus><Sensitivity>"+
a.sensitivity+"</Sensitivity><Backoff>"+a.backoff+"</Backoff>"};d.prototype._getStates=function(c,a){if(c&&0!=c.length)for(var b={},g=0,f=function(){g++;g==c.length&&a&&a(null,b)},e=0;e<c.length;e++)switch(c[e]){case "active":this._getActiveState(function(a,c){!a&&c&&(b.active=c);f()});break;case "sens":this._getSensitivityState(function(a,c){!a&&c&&(b.sens=c);f()});break;case "dectTime":case "dectTimeStr":this._getDetectTime(function(a,c){!a&&c&&(b.dectTime=c,b.dectTimeStr=(new Date(1E3*c)).toLocaleString());
f()});break;default:f()}else a&&a(null,{})};d.prototype._setDetectorActive=function(c,a){var b=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);b.opStatus=c+"";this._setMotionDetectorSettings(b,a)};d.prototype._setDetectorSensitivity=function(c,a){var b=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);b.sensitivity=c+"";this._setMotionDetectorSettings(b,a)};d.prototype._setMotionDetectorSettings=function(c,a){var b=this;this._doAction("SetMotionDetectorSettings",this._requestBody("SetMotionDetectorSettings",
this._controlParameters(1,c)),"SetMotionDetectorSettingsResult",function(g,f){g||f&&"OK"==f.text()||(g=Error("turn plug on failed"));g||xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,1,c);a&&a(g)})};d.prototype._getActiveState=function(c){this._getMotionDetectorSettings(function(a,b){if(a)c&&c(a);else{var g=b.opStatus;c&&c(null,g)}})};d.prototype._getSensitivityState=function(c){this._getMotionDetectorSettings(function(a,b){if(a)c&&c(a);else{var g=b.sensitivity;c&&c(null,g)}})};d.prototype._getMotionDetectorSettings=
function(c){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(a&&a.backoff&&a.sensitivity&&a.opStatus&&a.nickName&&a.description)c&&c(null,a);else if(a=this._getSettingsCbs.length,c&&-1==this._getSettingsCbs.indexOf(c)&&this._getSettingsCbs.push(c),0==a){var b=this;this._doAction("GetMotionDetectorSettings",this._requestBody("GetMotionDetectorSettings",this._moduleParameters(1)),"GetMotionDetectorSettingsResponse",function(c,a){var e=b._getSettingsCbs;b._getSettingsCbs=[];if(c)e.forEach(function(b){b&&
b(c)});else if(a){var d=a.find("GetMotionDetectorSettingsResult");if(d&&d[0]&&"OK"==$(d[0]).text()){var k={nickName:null,description:null,opStatus:null,sensitivity:null,backoff:null};a.find("NickName").each(function(){k.nickName=$(this).text()});a.find("Description").each(function(){k.description=$(this).text()});a.find("OPStatus").each(function(){k.opStatus=$(this).text()});a.find("Sensitivity").each(function(){k.sensitivity=$(this).text()});a.find("Backoff").each(function(){k.backoff=$(this).text()});
xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,1,k);e.forEach(function(b){b&&b(null,k)})}else c=Error("get socket settings failed"),e.forEach(function(b){b&&b(c)})}else c=Error("get motion detector settings result format error"),e.forEach(function(b){b&&b(c)})})}};d.prototype._getDetectTime=function(c){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(a&&a.lastDetect)c&&c(null,a.lastDetect);else if(a=this._getLastDetectCbs.length,c&&-1==this._getLastDetectCbs.indexOf(c)&&this._getLastDetectCbs.push(c),
0==a){var b=this;this._doAction("GetLatestDetection",this._requestBody("GetLatestDetection",this._moduleParameters(1)),"GetLatestDetectionResponse",function(a,c){var e=b._getLastDetectCbs;b._getLastDetectCbs=[];if(a)e.forEach(function(b){b&&b(a)});else if(c){var d=c.find("GetLatestDetectionResult");if(d&&d[0]&&"OK"==$(d[0]).text())if((d=c.find("LatestDetectTime"))&&d[0]){var k=$(d[0]).text();xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,1,{lastDetect:k});e.forEach(function(b){b&&b(null,k)})}else a=
Error("get motion detector no LatestDetectTime parameter"),e.forEach(function(b){b&&b(a)});else a=Error("get motion detector last detection failed"),e.forEach(function(b){b&&b(a)})}else a=Error("get motion detector last detection result format error"),e.forEach(function(b){b&&b(a)})})}};return d}();
xnm.aio.dlink.WifiSiren=function(){var d=function(c){xnm.aio.dlink.WifiDevice.call(this,c);this._getSettingsCbs=[];this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.WifiSiren")};d.prototype=new xnm.aio.dlink.WifiDevice;d.prototype.constructor=d;d.prototype.TONE="emergency fire ambulance police doorbell acoustic_signal".split(" ");d.prototype.toJSON=function(){var c=xnm.aio.dlink.WifiDevice.prototype.toJSON.call(this);c.data=
"siren";return c};d.prototype.executeCommandCreator=function(c,a,b){if(a&&a.value){var g=this,f;switch(a.value){case "activate":case "deactivate":case "actToggle":case "setTone":case "setDuration":case "setDurationP":case "setVolume":case "volumeUp":case "volumeDown":case "play":this._getSirenAlarmSettings(function(c,d){if(c)b&&b(c);else switch(a.value){case "activate":case "deactivate":g._setSirenActive("activate"==a.value,function(a){b&&b(a)});break;case "actToggle":g._setSirenActive("true"!=d.opStatus,
function(a){b&&b(a)});break;case "setVolume":if("undefined"==typeof a.ext||null==a.ext){b&&b(Error("command ext invalid"));break}f=parseInt(a.ext);0>f&&(f=0);100<f&&(f=100);g._setSirenVolumn(f,function(a){b&&b(a)});break;case "volumeUp":case "volumeDown":f=parseInt(d.volume);100<f&&(f=100);f="volumeUp"==a.value?f+5:f-5;0>f&&(f=0);100<f&&(f=100);g._setSirenVolumn(f,function(a){b&&b(a)});break;case "setDuration":case "setDurationP":if("undefined"==typeof a.ext||null==a.ext){b&&b(Error("command ext invalid"));
break}g._setSirenDuration(a.ext,function(a){b&&b(a)});break;case "setTone":if("undefined"==typeof a.ext||null==a.ext){b&&b(Error("command ext invalid"));break}g._setSirenTone(a.ext,function(a){b&&b(a)});break;case "play":g._doAlarm(function(a){b&&b(a)})}});break;case "stop":this._stopAlarm(function(a){b&&b(a)});break;default:b&&b(Error("unknown command"))}}else b&&b(Error("command invalid"))};d.prototype._controlParameters=function(c,a,b,g,f,e,d){return this._moduleParameters(c)+"<NickName>"+a+"</NickName><Description>"+
b+"</Description><DefaultSound>"+g+"</DefaultSound><OPStatus>"+e+"</OPStatus><Volume>"+f+"</Volume><Duration>"+d+"</Duration>"};d.prototype._soundPlayParameters=function(c,a,b,g){return this._moduleParameters(c)+"<SoundType>"+a+"</SoundType><Volume>"+b+"</Volume><Duration>"+g+"</Duration><Controller>1</Controller>"};d.prototype._dissmissParameters=function(c){return this._moduleParameters(c)+"<Controller>1</Controller>"};d.prototype._doAlarm=function(c){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,
1),b=this;this._doAction("SetSoundPlay",this._requestBody("SetSoundPlay",this._soundPlayParameters(1,a.defaultSound,a.volume,a.duration)),"SetSoundPlayResult",function(a,f){a||f&&"OK"==f.text()||(a=Error("play siren failed"));a||xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,1,{alarm:"true"});c&&c(a)})};d.prototype._stopAlarm=function(c){var a=this;this._doAction("SetAlarmDismissed",this._requestBody("SetAlarmDismissed",this._dissmissParameters(1)),"SetAlarmDismissedResult",function(b,g){b||g&&"OK"==
g.text()||(b=Error("stop siren failed"));b||xnm.aio.dlink._SettingsBuffer.setSettings(a.ip,1,{alarm:"false"});c&&c(b)})};d.prototype._setSirenActive=function(c,a){var b=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);b.opStatus=c+"";this._setSirenAlarmSettings(b,a)};d.prototype._setSirenVolumn=function(c,a){var b=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);b.volume=c+"";this._setSirenAlarmSettings(b,a)};d.prototype._setSirenDuration=function(c,a){var b=null;switch(c){case "3s":b=3;break;
case "10s":b=10;break;case "30s":b=30;break;case "1min":b=60;break;case "repeat":b=88888;break;default:b=parseInt(c);if(isNaN(b)){a&&a(Error("invalid duration"));return}0>=b&&(b=1);86400<b&&(b=86400)}var g=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);g.duration=b+"";this._setSirenAlarmSettings(g,a)};d.prototype._setSirenTone=function(c,a){var b=this.TONE.indexOf(c)+1;if(b){var g=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);g.defaultSound=b+"";this._setSirenAlarmSettings(g,a)}else a&&
a(Error("no such tone"))};d.prototype._setSirenAlarmSettings=function(c,a){var b=this;this._doAction("SetSirenAlarmSettings",this._requestBody("SetSirenAlarmSettings",this._controlParameters(1,c.nickName,c.description,c.defaultSound,c.volume,c.opStatus,c.duration)),"SetSirenAlarmSettingsResult",function(g,f){g||f&&"OK"==f.text()||(g=Error("set siren settings failed"));g||xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,1,c);a&&a(g)})};d.prototype._getStates=function(c,a){if(c&&0!=c.length)for(var b=
{},g=0,f=function(){g++;g==c.length&&a&&a(null,b)},e=this,d=!1,k=0;k<c.length;k++)switch(c[k]){case "active":case "tone":case "volume":case "duration":case "durationStr":case "alarm":d?f():(d=!0,this._getSirenAlarmSettings(function(a,c){if(!a&&c)if(b.active=c.opStatus,b.tone=e.TONE[parseInt(c.defaultSound)-1],b.volume=parseInt(c.volume),999==b.volume&&(b.volume=100),b.alarm=c.alarm,b.duration=parseInt(c.duration),60>b.duration)b.durationStr=b.duration+"s";else if(88888==b.duration||9999==b.duration)b.durationStr=
"repeat";else{var g=Math.floor(b.duration/60),d=b.duration-60*g;b.durationStr=(g?g+"m":"")+(d?d+"s":"")}f()}));break;default:f()}else a&&a(null,{})};d.prototype._getSirenAlarmSettings=function(c){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(a&&a.defaultSound&&a.opStatus&&a.nickName&&a.description&&a.volume&&a.duration&&a.alarm)c&&c(null,a);else if(a=this._getSettingsCbs.length,c&&-1==this._getSettingsCbs.indexOf(c)&&this._getSettingsCbs.push(c),0==a){var b=this;this._doAction("GetSirenAlarmSettings",
this._requestBody("GetSirenAlarmSettings",this._moduleParameters(1)),"GetSirenAlarmSettingsResponse",function(a,c){var d=b._getSettingsCbs;b._getSettingsCbs=[];if(a)d.forEach(function(b){b&&b(a)});else if(c){var h=c.find("GetSirenAlarmSettingsResult");if(h&&h[0]&&"OK"==$(h[0]).text()){var k={nickName:null,description:null,opStatus:null,volume:null,defaultSound:null,duration:null,alarm:null};c.find("NickName").each(function(){k.nickName=$(this).text()});c.find("Description").each(function(){k.description=
$(this).text()});c.find("OPStatus").each(function(){k.opStatus=$(this).text()});c.find("Volume").each(function(){k.volume=$(this).text()});c.find("Duration").each(function(){k.duration=$(this).text()});c.find("DefaultSound").each(function(){k.defaultSound=$(this).text()});c.find("IsSounding").each(function(){k.alarm=$(this).text()});xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,1,k);d.forEach(function(b){b&&b(null,k)})}else a=Error("get siren settings failed"),d.forEach(function(b){b&&b(a)})}else a=
Error("get siren settings result format error"),d.forEach(function(b){b&&b(a)})})}};return d}();
xnm.aio.dlink.WifiWater=function(){var d=function(c){xnm.aio.dlink.WifiDevice.call(this,c);this._getSettingsCbs=[];this._getStateCbs=[];this._getLastDetectCbs=[];this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.WifiWater")};d.prototype=new xnm.aio.dlink.WifiDevice;d.prototype.constructor=d;d.prototype.toJSON=function(){var c=xnm.aio.dlink.WifiDevice.prototype.toJSON.call(this);c.data="water";return c};d.prototype.executeCommandCreator=
function(c,a,b){if(a&&a.value){var g=this;switch(a.value){case "activate":case "deactivate":case "actToggle":this._getWaterDetectorSettings(function(c,d){if(c)b&&b(c);else switch(a.value){case "activate":case "deactivate":g._setDetectorActive("activate"==a.value,b);break;case "actToggle":g._setDetectorActive("true"!=d.opStatus,b)}});break;default:b&&b(Error("unknown command"))}}else b&&b(Error("command json format invalid"))};d.prototype._controlParameters=function(c,a){return this._moduleParameters(c)+
"<NickName>"+a.nickName+"</NickName><Description>"+a.description+"</Description><OPStatus>"+a.opStatus+"</OPStatus>"};d.prototype._setDetectorActive=function(c,a){var b=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);b.opStatus=c+"";this._setWaterDetectorSettings(b,a)};d.prototype._setWaterDetectorSettings=function(c,a){var b=this;this._doAction("SetWaterDetectorSettings",this._requestBody("SetWaterDetectorSettings",this._controlParameters(1,c)),"SetWaterDetectorSettingsResult",function(g,d){g||
d&&"OK"==d.text()||(g=Error("turn plug on failed"));g||xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,1,c);a&&a(g)})};d.prototype._getStates=function(c,a){if(c&&0!=c.length)for(var b={},g=0,d=function(){g++;g==c.length&&a&&a(null,b)},e=0;e<c.length;e++)switch(c[e]){case "active":this._getActiveState(function(a,c){!a&&c&&(b.active=c);d()});break;case "state":this._getWaterDetectorState(function(a,c){!a&&c&&(b.state="true"==c?"water":"dry");d()});break;case "dectTime":case "dectTimeStr":this._getDetectTime(function(a,
c){!a&&c&&(b.dectTime=c,b.dectTimeStr=(new Date(1E3*c)).toLocaleString());d()});break;default:d()}else a&&a(null,{})};d.prototype._getActiveState=function(c){this._getWaterDetectorSettings(function(a,b){if(a)c&&c(a);else{var g=b.opStatus;c&&c(null,g)}})};d.prototype._getDetectTime=function(c){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(a&&a.lastDetect)c&&c(null,a.lastDetect);else if(a=this._getLastDetectCbs.length,c&&-1==this._getLastDetectCbs.indexOf(c)&&this._getLastDetectCbs.push(c),
0==a){var b=this;this._doAction("GetLatestDetection",this._requestBody("GetLatestDetection",this._moduleParameters(1)),"GetLatestDetectionResponse",function(a,c){var d=b._getLastDetectCbs;b._getLastDetectCbs=[];if(a)d.forEach(function(b){b&&b(a)});else if(c){var h=c.find("GetLatestDetectionResult");if(h&&h[0]&&"OK"==$(h[0]).text())if((h=c.find("LatestDetectTime"))&&h[0]){var k=$(h[0]).text();xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,1,{lastDetect:k});d.forEach(function(b){b&&b(null,k)})}else a=
Error("get water detector no LatestDetectTime parameter"),d.forEach(function(b){b&&b(a)});else a=Error("get water detector detection time failed"),d.forEach(function(b){b&&b(a)})}else a=Error("get water detector detection time result format error"),d.forEach(function(b){b&&b(a)})})}};d.prototype._getWaterDetectorState=function(c){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(a&&a.watering)c&&c(null,a.watering);else if(a=this._getStateCbs.length,c&&-1==this._getStateCbs.indexOf(c)&&
this._getStateCbs.push(c),0==a){var b=this;this._doAction("GetWaterDetectorState",this._requestBody("GetWaterDetectorState",this._moduleParameters(1)),"GetWaterDetectorStateResponse",function(a,c){var d=b._getStateCbs;b._getStateCbs=[];if(a)d.forEach(function(b){b&&b(a)});else if(c){var h=c.find("GetWaterDetectorStateResult");if(h&&h[0]&&"OK"==$(h[0]).text())if((h=c.find("IsWater"))&&h[0]){var k=$(h[0]).text();xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,1,{watering:k});d.forEach(function(b){b&&
b(null,k)})}else a=Error("get water detector no IsWater parameter"),d.forEach(function(b){b&&b(a)});else a=Error("get water detector state failed"),d.forEach(function(b){b&&b(a)})}else a=Error("get water detector state result format error"),d.forEach(function(b){b&&b(a)})})}};d.prototype._getWaterDetectorSettings=function(c){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(a&&a.opStatus&&a.nickName&&a.description)c&&c(null,a);else if(a=this._getSettingsCbs.length,c&&-1==this._getSettingsCbs.indexOf(c)&&
this._getSettingsCbs.push(c),0==a){var b=this;this._doAction("GetWaterDetectorSettings",this._requestBody("GetWaterDetectorSettings",this._moduleParameters(1)),"GetWaterDetectorSettingsResponse",function(a,c){var d=b._getSettingsCbs;b._getSettingsCbs=[];if(a)d.forEach(function(b){b&&b(a)});else if(c){var h=c.find("GetWaterDetectorSettingsResult");if(h&&h[0]&&"OK"==$(h[0]).text()){var k={nickName:null,description:null,opStatus:null};c.find("NickName").each(function(){k.nickName=$(this).text()});c.find("Description").each(function(){k.description=
$(this).text()});c.find("OPStatus").each(function(){k.opStatus=$(this).text()});xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,1,k);d.forEach(function(b){b&&b(null,k)})}else a=Error("get water detector settings failed"),d.forEach(function(b){b&&b(a)})}else a=Error("get water detector settings result format error"),d.forEach(function(b){b&&b(a)})})}};return d}();
xnm.aio.dlink.WifiHub=function(){var d=function(c){xnm.aio.dlink.WifiDevice.call(this,c);this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.WifiHub")};d.prototype=new xnm.aio.dlink.WifiDevice;d.prototype.constructor=d;d.prototype.toJSON=function(){var c=xnm.aio.dlink.WifiDevice.prototype.toJSON.call(this);c.data="hub";return c};d.prototype.listZwaveDevice=function(c){this._getModuleProfile(0,function(a,b){if(a)c&&c(a);else{var g=
[];b.find("ModuleProfile").each(function(){var b=$(this),a=b.find("ModuleID");a&&a[0]&&(a=$(a[0]).text());(b=b.find("ModuleSubType"))&&b[0]&&(b=$(b[0]).text());switch(b){case "Contact Sensor":g.push({sys:"dlink",type:"zwave",data:"contact",model:"DCH-Z110",node_id:a.substr(0,a.length-2)});break;case "Motion Detector":g.push({sys:"dlink",type:"zwave",data:"motion",model:"DCH-Z120",node_id:a.substr(0,a.length-2)});break;case "Siren Alarm":g.push({sys:"dlink",type:"zwave",data:"siren",model:"DCH-Z510",
node_id:a.substr(0,a.length-2)})}});c&&c(null,g)}})};d.prototype.executeCommandCreator=function(c,a,b){c?(c=xnm.aio.dlink.ZwaveDevice.parseJSON(c))?c.executeCommand(this,a,b):b&&b(Error("deviceJSON invalid")):b&&b(Error("gateway command not suppoort"))};d.prototype.getStatesCreator=function(c,a,b){for(var g={querys:[],dpts:[]},d={},e,h=0;h<a.length;h++)if(a[h]&&a[h].id&&a[h].device&&a[h].status)if(e=a[h].device,"wifi"==e.type&&"hub"==e.data)g.querys.push(a[h]),(e=a[h].status.value)&&-1==g.dpts.indexOf(e)&&
g.dpts.push(e);else if("zwave"==e.type&&e.data&&e.node_id){var k=e.node_id+"@"+e.data,l=d[k];l||(d[k]={device:e,querys:[]},l=d[k]);l.querys.push(a[h])}var m=this;this._getWifiStatesCreator(c,g,function(a,g){if(a)b&&b(a);else{var e=[];g&&(e=e.concat(g));m._getZwaveStatesCreator(c,d,function(a,c){!a&&c&&(e=e.concat(c));b&&b(null,e)})}})};d.prototype._getWifiStatesCreator=function(c,a,b){if(a&&a.querys&&0!=a.querys.length){var g=a.querys;this._getStates(a.dpts,function(a,c){for(var d=[],k=0;k<g.length;k++)if(g[k]&&
g[k].id){var l="?";if(c&&g[k].status&&g[k].status.value){var m=g[k].status.value;null!=c[m]&&"undefined"!=typeof c[m]&&(l=c[m])}d.push({id:g[k].id,status:l})}b&&b(null,d)})}else b&&b(null,[])};d.prototype._getZwaveStatesCreator=function(c,a,b){var g=[],d=0,e=0,h;for(h in a)a.hasOwnProperty(h)&&a[h]&&(g.push(a[h]),e++);if(0==e)b&&b(null,[]);else{var k=[],l=this,m=function(){d++;d==e&&(b&&b(null,k),b=null)};g.forEach(function(b){if(b.device&&b.querys&&0!=b.querys.length){var a=xnm.aio.dlink.ZwaveDevice.parseJSON(b.device);
a?a.getStatesCreator(l,c,b.querys,function(b,a){!b&&a&&(k=k.concat(a));m()}):m()}else m()})}};d.prototype._getStates=function(c,a){c&&0!=c.length||a&&a(null,{})};return d}();
xnm.aio.dlink._SettingsBuffer={_buffer:{},getSettings:function(d,c){if(!this._buffer[d]||!this._buffer[d][c])return null;var a=this._buffer[d][c],b={},g=Math.round((new Date).getTime()/1E3),f=0,e;for(e in a)if(a.hasOwnProperty(e)){var h=a[e];!h||!h.time||5<g-h.time||(f++,b[e]=h.value)}return f?b:null},setSettings:function(d,c,a){this._buffer[d]||(this._buffer[d]={});this._buffer[d][c]||(this._buffer[d][c]={});var b=Math.round((new Date).getTime()/1E3),g;for(g in a)a.hasOwnProperty(g)&&(this._buffer[d][c][g]||
(this._buffer[d][c][g]={}),this._buffer[d][c][g].value=a[g],this._buffer[d][c][g].time=b)}};
xnm.aio.dlink.ZwaveDevice=function(){var d=function(c){c&&(this.node_id=c.node_id);this._getTempCbs=[];this._getBriCbs=[];this._getBatCbs=[];this._getSabCbs=[]};d.prototype.getStatesCreator=function(c,a,b,g){a=[];for(var d=0;d<b.length;d++)if(b[d]&&b[d].id&&b[d].status&&b[d].status.value){var e=b[d].status.value;-1==a.indexOf(e)&&a.push(e)}this._getStates(c,a,function(a,c){for(var d=[],e=0;e<b.length;e++)if(b[e]&&b[e].id){var f="?";if(c&&b[e].status&&b[e].status.value){var p=b[e].status.value;null!=
c[p]&&"undefined"!=typeof c[p]&&(f=c[p])}d.push({id:b[e].id,status:f})}g&&g(null,d)})};d.prototype._moduleParameters=function(c){return"<ModuleID>"+c+"</ModuleID>"};d.prototype._getTempState=function(c,a,b){this._logger.log("debug","get zwave "+a+" temperature");var g=xnm.aio.dlink._SettingsBuffer.getSettings(c.ip,this.node_id);if(g&&"undefined"!=typeof g.temp&&null!=g.temp)b&&b(null,g.temp);else{var d=this._getTempCbs.length;b&&-1==this._getTempCbs.indexOf(b)&&this._getTempCbs.push(b);if(0==d){var e=
this;c._doAction("GetCurrentTemperature",c._requestBody("GetCurrentTemperature",this._moduleParameters(a)),"CurrentTemperature",function(b,d){var f=e._getTempCbs;e._getTempCbs=[];b?(e._logger.log("warn","get zwave "+a+" temperature error:"+b.stack),f.forEach(function(a){a&&a(b)})):d?(g||(g={}),g.temp=d.text(),xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,e.node_id,g),f.forEach(function(b){b&&b(null,d.text())})):(e._logger.log("warn","get zwave "+a+" temperature result format error"),b=Error("get contact temperature state result format error"),
f.forEach(function(a){a&&a(b)}))})}}};d.prototype._getBriState=function(c,a,b){this._logger.log("debug","get zwave "+a+" brightness");var g=xnm.aio.dlink._SettingsBuffer.getSettings(c.ip,this.node_id);if(g&&"undefined"!=typeof g.bri&&null!=g.bri)b&&b(null,g.bri);else{var d=this._getBriCbs.length;b&&-1==this._getBriCbs.indexOf(b)&&this._getBriCbs.push(b);if(0==d){var e=this;c._doAction("GetIllumination",c._requestBody("GetIllumination",this._moduleParameters(a)),"Illumination",function(b,d){var f=
e._getTempCbs;e._getTempCbs=[];b?(e._logger.log("warn","get zwave "+a+" brightness error:"+b.stack),f.forEach(function(a){a&&a(b)})):d?(g||(g={}),g.bri=d.text(),xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,e.node_id,g),f.forEach(function(b){b&&b(null,d.text())})):(e._logger.log("warn","get zwave "+a+" brightness result format error"),b=Error("get contact brightness state result format error"),f.forEach(function(a){a&&a(b)}))})}}};d.prototype._getBatteryState=function(c,a,b){this._logger.log("debug",
"get zwave "+a+" battery");var d=xnm.aio.dlink._SettingsBuffer.getSettings(c.ip,this.node_id);if(d&&"undefined"!=typeof d.bat&&null!=d.bat)b&&b(null,d.bat);else{var f=this._getBatCbs.length;b&&-1==this._getBatCbs.indexOf(b)&&this._getBatCbs.push(b);if(0==f){var e=this;c._doAction("GetBatteryLevel",c._requestBody("GetBatteryLevel",this._moduleParameters(a)),"BatteryLevel",function(b,f){var l=e._getBatCbs;e._getBatCbs=[];b?(e._logger.log("warn","get zwave "+a+" battery error:"+b.stack),l.forEach(function(a){a&&
a(b)})):f?(d||(d={}),d.bat=f.text(),xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,e.node_id,d),l.forEach(function(b){b&&b(null,f.text())})):(e._logger.log("warn","get zwave "+a+" battery result format error"),b=Error("get contact battery state result format error"),l.forEach(function(a){a&&a(b)}))})}}};d.prototype._getSaboState=function(c,a,b){this._logger.log("debug","get zwave "+a+" sabotage");var d=xnm.aio.dlink._SettingsBuffer.getSettings(c.ip,this.node_id);if(d&&"undefined"!=typeof d.sabo&&
null!=d.sabo)b&&b(null,d.sabo);else{var f=this._getSabCbs.length;b&&-1==this._getSabCbs.indexOf(b)&&this._getSabCbs.push(b);if(0==f){var e=this;c._doAction("GetTamperSensorState",c._requestBody("GetTamperSensorState",this._moduleParameters(a)),"TamperState",function(b,f){var l=e._getSabCbs;e._getSabCbs=[];b?(e._logger.log("warn","get zwave "+a+" sabotage error:"+b.stack),l.forEach(function(a){a&&a(b)})):f?(d||(d={}),d.sabo=f.text(),xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,e.node_id,d),l.forEach(function(b){b&&
b(null,f.text())})):(e._logger.log("warn","get zwave "+a+" sabotage result format error"),b=Error("get contact sabotage state result format error"),l.forEach(function(a){a&&a(b)}))})}}};d.parseJSON=function(c){if(!c||"zwave"!=c.type||!c.data||!c.node_id)return null;switch(c.data){case "contact":return new xnm.aio.dlink.ZwaveContact(c);case "motion":return new xnm.aio.dlink.ZwaveMotion(c);case "siren":return new xnm.aio.dlink.ZwaveSiren(c);default:return null}};return d}();
xnm.aio.dlink.ZwaveContact=function(){var d=function(c){xnm.aio.dlink.ZwaveDevice.call(this,c);this._getActivCbs=[];this._getOpenCbs=[];this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.ZwaveContact ")};d.prototype=new xnm.aio.dlink.ZwaveDevice;d.prototype.constructor=d;d.prototype.executeCommand=function(c,a,b){if(a&&a.value){var d=this;switch(a.value){case "activate":case "deactivate":this._setActive(c,"activate"==a.value,
b);break;case "actToggle":this._getActiveState(c,function(a,e){a?b&&b(a):d.executeCommand(c,{value:"true"==e?"deactivate":"activate"},b)});break;default:b&&b(Error("unknown command"))}}else b&&b(Error("command invalid"))};d.prototype._getStates=function(c,a,b){if(a&&0!=a.length)for(var d={},f=0,e=function(){f++;f==a.length&&b&&b(null,d)},h=0;h<a.length;h++)switch(a[h]){case "active":this._getActiveState(c,function(b,a){!b&&a&&(d.active=a);e()});break;case "state":this._getOpenState(c,function(b,a){!b&&
a&&(d.state=a);e()});break;case "temp":this._getTempState(c,this.node_id+"03",function(b,a){!b&&a&&(d.temp=a);e()});break;case "bri":this._getBriState(c,this.node_id+"04",function(b,a){!b&&a&&(d.bri=a);e()});break;case "bat":this._getBatteryState(c,this.node_id+"05",function(b,a){!b&&a&&(d.bat=a);e()});break;case "sabo":this._getSaboState(c,this.node_id+"02",function(b,a){!b&&a&&(d.sabo=a);e()});break;default:e()}else b&&b(null,{})};d.prototype._controlParameters=function(c,a){return this._moduleParameters(c)+
"<OPStatus>"+a+"</OPStatus>"};d.prototype._setActive=function(c,a,b){var d=this;c._doAction("SetContactSensorSettings",c._requestBody("SetContactSensorSettings",this._controlParameters(this.node_id+"01",a)),"SetContactSensorSettingsResult",function(f,e){f||e&&"OK"==e.text()||(f=Error("activate contact failed"));f||xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,d.node_id,{active:a+""});b&&b(f)})};d.prototype._getActiveState=function(c,a){var b=xnm.aio.dlink._SettingsBuffer.getSettings(c.ip,this.node_id);
if(b&&"undefined"!=typeof b.active&&null!=b.active)a&&a(null,b.active);else{var d=this._getActivCbs.length;a&&-1==this._getActivCbs.indexOf(a)&&this._getActivCbs.push(a);if(0==d){var f=this;c._doAction("GetContactSensorSettings",c._requestBody("GetContactSensorSettings",this._moduleParameters(this.node_id+"01")),"OPStatus",function(d,g){var k=f._getActivCbs;f._getActivCbs=[];d?k.forEach(function(b){b&&b(d)}):g?(b||(b={}),b.active=g.text(),xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,f.node_id,b),
a&&a(null,g.text())):(d=Error("get contact active state result format error"),k.forEach(function(b){b&&b(d)}))})}}};d.prototype._getOpenState=function(c,a){var b=xnm.aio.dlink._SettingsBuffer.getSettings(c.ip,this.node_id);if(b&&"undefined"!=typeof b.state&&null!=b.state)a&&a(null,b.state);else{var d=this._getOpenCbs.length;a&&-1==this._getOpenCbs.indexOf(a)&&this._getOpenCbs.push(a);if(0==d){var f=this;c._doAction("GetContactSensorState",c._requestBody("GetContactSensorState",this._moduleParameters(this.node_id+
"01")),"ContactState",function(d,g){var k=f._getOpenCbs;f._getOpenCbs=[];d?k.forEach(function(b){b&&b(d)}):g?(k=g.text(),"true"==k?k="closed":"false"==k&&(k="open"),b||(b={}),b.state=k,xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,f.node_id,b),a&&a(null,k)):(d=Error("get contact open state result format error"),k.forEach(function(b){b&&b(d)}))})}}};return d}();
xnm.aio.dlink.ZwaveMotion=function(){var d=function(c){xnm.aio.dlink.ZwaveDevice.call(this,c);this._getSettingsCbs=[];this._getDetecCbs=[];this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.ZwaveMotion")};d.prototype=new xnm.aio.dlink.ZwaveDevice;d.prototype.constructor=d;d.prototype.executeCommand=function(c,a,b){if(a&&a.value){var d=this,f;switch(a.value){case "activate":case "deactivate":(f=xnm.aio.dlink._SettingsBuffer.getSettings(c.ip,
this.node_id))?this._setMotionDetectorActive(c,"activate"==a.value,function(a){b&&b(a)}):this._getMotionDetectorSettings(c,function(e){e?b&&b(e):d.executeCommand(c,a,b)});break;case "actToggle":this._getMotionDetectorSettings(c,function(a,e){a?b&&b(a):d.executeCommand(c,{value:"true"==e.opStatus?"deactivate":"activate"},b)});break;case "sensTo":if("undefined"==typeof a.ext||null==a.ext){b&&b(Error("command ext invalid"));break}var e=parseInt(a.ext);1>e&&(e=1);100<e&&(e=100);(f=xnm.aio.dlink._SettingsBuffer.getSettings(c.ip,
this.node_id))?this._setMotionDetectorSensitivity(c,e,function(a){b&&b(a)}):this._getMotionDetectorSettings(c,function(e){e?b&&b(e):d.executeCommand(c,a,b)});break;case "sensUp":case "sensDown":this._getMotionDetectorSettings(c,function(e,f){if(e)b&&b(e);else{var l=parseInt(f.sensitivity);1==l||100==l?b&&b():("sensUp"==a.value?l+=5:"sensDown"==a.value&&(l-=5),d.executeCommand(c,{value:"sensTo",ext:l},b))}});break;default:b&&b(Error("unknown command"))}}else b&&b(Error("command invalid"))};d.prototype._getStates=
function(c,a,b){if(a&&0!=a.length)for(var d={},f=0,e=function(){f++;f==a.length&&b&&b(null,d)},h=!1,k=!1,l=0;l<a.length;l++)switch(a[l]){case "active":case "sens":h?e():(h=!0,this._getMotionDetectorSettings(c,function(b,a){!b&&a&&(d.active=a.opStatus,d.sens=a.sensitivity);e()}));break;case "dectTime":case "dectTimeStr":k?e():(k=!0,this._getLastDetectionState(c,function(b,a){!b&&a&&(d.dectTime=a,a=parseInt(a),d.dectTimeStr=(new Date(1E3*a)).toLocaleString());e()}));break;case "temp":this._getTempState(c,
this.node_id+"03",function(b,a){!b&&a&&(d.temp=a);e()});break;case "bri":this._getBriState(c,this.node_id+"04",function(b,a){!b&&a&&(d.bri=a);e()});break;case "bat":this._getBatteryState(c,this.node_id+"05",function(b,a){!b&&a&&(d.bat=a);e()});break;case "sabo":this._getSaboState(c,this.node_id+"02",function(b,a){!b&&a&&(d.sabo=a);e()});break;default:e()}else b&&b(null,{})};d.prototype._controlParameters=function(c,a,b,d,f,e){return this._moduleParameters(c)+"<NickName>"+a+"</NickName><Description>"+
b+"</Description><Sensitivity>"+d+"</Sensitivity><OPStatus>"+f+"</OPStatus><Backoff>"+e+"</Backoff>"};d.prototype._setMotionDetectorActive=function(c,a,b){var d=this.node_id+"01",f=this,e=xnm.aio.dlink._SettingsBuffer.getSettings(c.ip,this.node_id);c._doAction("SetMotionDetectorSettings",c._requestBody("SetMotionDetectorSettings",this._controlParameters(d,e.nickName,e.description,e.sensitivity,a,e.backoff)),"SetMotionDetectorSettingsResult",function(d,g){d||g&&"OK"==g.text()||(d=Error("activate contact failed"));
d||xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,f.node_id,{opStatus:a+""});b&&b(d)})};d.prototype._setMotionDetectorSensitivity=function(c,a,b){var d=this.node_id+"01",f=this,e=xnm.aio.dlink._SettingsBuffer.getSettings(c.ip,this.node_id);c._doAction("SetMotionDetectorSettings",c._requestBody("SetMotionDetectorSettings",this._controlParameters(d,e.nickName,e.description,a,e.opStatus,e.backoff)),"SetMotionDetectorSettingsResult",function(d,g){d||g&&"OK"==g.text()||(d=Error("activate contact failed"));
d||xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,f.node_id,{sensitivity:a+""});b&&b(d)})};d.prototype._getMotionDetectorSettings=function(c,a){var b=xnm.aio.dlink._SettingsBuffer.getSettings(c.ip,this.node_id);if(b&&b.sensitivity&&b.opStatus&&b.nickName&&b.description&&b.backoff)a&&a(null,b);else if(b=this._getSettingsCbs.length,a&&-1==this._getSettingsCbs.indexOf(a)&&this._getSettingsCbs.push(a),0==b){var d=this;c._doAction("GetMotionDetectorSettings",c._requestBody("GetMotionDetectorSettings",
this._moduleParameters(this.node_id+"01")),"GetMotionDetectorSettingsResponse",function(b,a){var h=d._getSettingsCbs;d._getSettingsCbs=[];if(b)h.forEach(function(a){a&&a(b)});else if(a){var k=a.find("GetMotionDetectorSettingsResult");if(k&&k[0]&&"OK"==$(k[0]).text()){var l=null,m=null,n=null,p=null,q=null;a.find("NickName").each(function(){n||(n=$(this).text())});a.find("Description").each(function(){p||(p=$(this).text())});a.find("OPStatus").each(function(){l||(l=$(this).text())});a.find("Sensitivity").each(function(){m||
(m=$(this).text())});a.find("Backoff").each(function(){q||(q=$(this).text())});var r={nickName:n,description:p,opStatus:l,sensitivity:m,backoff:q};xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,d.node_id,r);h.forEach(function(b){b&&b(null,r)})}else b=Error("get contact settings failed"),h.forEach(function(a){a&&a(b)})}else b=Error("get contact settings result format error"),h.forEach(function(a){a&&a(b)})})}};d.prototype._getLastDetectionState=function(c,a){var b=xnm.aio.dlink._SettingsBuffer.getSettings(c.ip,
this.node_id);if(b&&b.dectTime)a&&a(null,b.dectTime);else if(b=this._getDetecCbs.length,a&&-1==this._getDetecCbs.indexOf(a)&&this._getDetecCbs.push(a),0==b){var d=this;c._doAction("GetLatestDetection",c._requestBody("GetLatestDetection",this._moduleParameters(this.node_id+"01")),"LatestDetectTime",function(b,a){var h=d._getDetecCbs;d._getDetecCbs=[];b?h.forEach(function(a){a&&a(b)}):a?(xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,d.node_id,{dectTime:a.text()}),h.forEach(function(b){b&&b(null,a.text())})):
(b=Error("get contact open state result format error"),h.forEach(function(a){a&&a(b)}))})}};return d}();
xnm.aio.dlink.ZwaveSiren=function(){var d=function(c){xnm.aio.dlink.ZwaveDevice.call(this,c);this._getSettingsCbs=[];this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.ZwaveSiren")};d.prototype=new xnm.aio.dlink.ZwaveDevice;d.prototype.constructor=d;d.prototype.TONE="emergency fire ambulance police doorbell acoustic_signal".split(" ");d.prototype.executeCommand=function(c,a,b){if(a&&a.value){var d=this,f;switch(a.value){case "activate":case "deactivate":case "actToggle":case "setTone":case "setDuration":case "setDurationP":case "setVolume":case "volumeUp":case "volumeDown":case "play":this._getSirenAlarmSettings(c,
function(e,h){if(e)b&&b(e);else switch(a.value){case "activate":case "deactivate":d._setSirenActive(c,"activate"==a.value,function(a){b&&b(a)});break;case "actToggle":d._setSirenActive(c,"true"!=h.opStatus,function(a){b&&b(a)});break;case "setVolume":if("undefined"==typeof a.ext||null==a.ext){b&&b(Error("command ext invalid"));break}f=parseInt(a.ext);0>f&&(f=0);100<f&&(f=100);d._setSirenVolumn(c,f,function(a){b&&b(a)});break;case "volumeUp":case "volumeDown":f=parseInt(h.volume);100<f&&(f=100);f=
"volumeUp"==a.value?f+5:f-5;0>f&&(f=0);100<f&&(f=100);d._setSirenVolumn(c,f,function(a){b&&b(a)});break;case "setDuration":case "setDurationP":if("undefined"==typeof a.ext||null==a.ext){b&&b(Error("command ext invalid"));break}d._setSirenDuration(c,a.ext,function(a){b&&b(a)});break;case "setTone":if("undefined"==typeof a.ext||null==a.ext){b&&b(Error("command ext invalid"));break}d._setSirenTone(c,a.ext,function(a){b&&b(a)});break;case "play":d._doAlarm(c,function(a){b&&b(a)})}});break;case "stop":this._stopAlarm(c,
function(a){b&&b(a)});break;default:b&&b(Error("unknown command"))}}else b&&b(Error("command invalid"))};d.prototype._controlParameters=function(c,a,b,d,f,e,h){return this._moduleParameters(c)+"<NickName>"+a+"</NickName><Description>"+b+"</Description><DefaultSound>"+d+"</DefaultSound><OPStatus>"+e+"</OPStatus><Volume>"+f+"</Volume><Duration>"+h+"</Duration>"};d.prototype._soundPlayParameters=function(c,a,b,d){return this._moduleParameters(c)+"<SoundType>"+a+"</SoundType><Volume>"+b+"</Volume><Duration>"+
d+"</Duration><Controller>1</Controller>"};d.prototype._dissmissParameters=function(c){return this._moduleParameters(c)+"<Controller>1</Controller>"};d.prototype._doAlarm=function(c,a){var b=xnm.aio.dlink._SettingsBuffer.getSettings(c.ip,this.node_id),d=this;c._doAction("SetSoundPlay",c._requestBody("SetSoundPlay",this._soundPlayParameters(this.node_id+"09",b.defaultSound,b.volume,b.duration)),"SetSoundPlayResult",function(b,e){b||e&&"OK"==e.text()||(b=Error("play siren failed"));b||xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,
d.node_id,{alarm:"true"});a&&a(b)})};d.prototype._stopAlarm=function(c,a){var b=this;c._doAction("SetAlarmDismissed",c._requestBody("SetAlarmDismissed",this._dissmissParameters(this.node_id+"09")),"SetAlarmDismissedResult",function(d,f){d||f&&"OK"==f.text()||(d=Error("stop siren failed"));d||xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,b.node_id,{alarm:"false"});a&&a(d)})};d.prototype._setSirenActive=function(c,a,b){var d=xnm.aio.dlink._SettingsBuffer.getSettings(c.ip,this.node_id);d.opStatus=a+
"";this._setSirenAlarmSettings(c,d,b)};d.prototype._setSirenVolumn=function(c,a,b){var d=xnm.aio.dlink._SettingsBuffer.getSettings(c.ip,this.node_id);d.volume=a+"";this._setSirenAlarmSettings(c,d,b)};d.prototype._setSirenDuration=function(c,a,b){var d=null;switch(a){case "30s":d=30;break;case "60s":d=60;break;case "90s":d=90;break;case "3min":d=180;break;case "repeat":d=88888;break;default:d=parseInt(a);if(isNaN(d)){b&&b(Error("invalid duration"));return}0>=d&&(d=1);86400<d&&(d=86400)}a=xnm.aio.dlink._SettingsBuffer.getSettings(c.ip,
this.node_id);a.duration=d+"";this._setSirenAlarmSettings(c,a,b)};d.prototype._setSirenTone=function(c,a,b){if(a=this.TONE.indexOf(a)+1){var d=xnm.aio.dlink._SettingsBuffer.getSettings(c.ip,this.node_id);d.defaultSound=a+"";this._setSirenAlarmSettings(c,d,b)}else b&&b(Error("no such tone"))};d.prototype._setSirenAlarmSettings=function(c,a,b){var d=this;c._doAction("SetSirenAlarmSettings",c._requestBody("SetSirenAlarmSettings",this._controlParameters(this.node_id+"09",a.nickName,a.description,a.defaultSound,
a.volume,a.opStatus,a.duration)),"SetSirenAlarmSettingsResult",function(f,e){f||e&&"OK"==e.text()||(f=Error("set siren settings failed"));f||xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,d.node_id,a);b&&b(f)})};d.prototype._getStates=function(c,a,b){if(a&&0!=a.length)for(var d={},f=0,e=function(){f++;f==a.length&&b&&b(null,d)},h=this,k=!1,l=0;l<a.length;l++)switch(a[l]){case "active":case "tone":case "volume":case "duration":case "durationStr":case "alarm":k?e():(k=!0,this._getSirenAlarmSettings(c,
function(b,a){if(!b&&a)if(d.active=a.opStatus,d.tone=h.TONE[parseInt(a.defaultSound)-1],d.volume=parseInt(a.volume),999==d.volume&&(d.volume=100),d.alarm=a.alarm,d.duration=parseInt(a.duration),180>d.duration)d.durationStr=d.duration+"s";else if(88888==d.duration||9999==d.duration)d.durationStr="repeat";else{var c=Math.floor(d.duration/60),f=d.duration-60*c;d.durationStr=(c?c+"m":"")+(f?f+"s":"")}e()}));break;default:e()}else b&&b(null,{})};d.prototype._getSirenAlarmSettings=function(c,a){var b=xnm.aio.dlink._SettingsBuffer.getSettings(c.ip,
this.node_id);if(b&&b.defaultSound&&b.opStatus&&b.nickName&&b.description&&b.volume&&b.duration&&b.alarm)a&&a(null,b);else if(b=this._getSettingsCbs.length,a&&-1==this._getSettingsCbs.indexOf(a)&&this._getSettingsCbs.push(a),0==b){var d=this;c._doAction("GetSirenAlarmSettings",c._requestBody("GetSirenAlarmSettings",this._moduleParameters(this.node_id+"09")),"GetSirenAlarmSettingsResponse",function(b,a){var h=d._getSettingsCbs;d._getSettingsCbs=[];if(b)h.forEach(function(a){a&&a(b)});else if(a){var k=
a.find("GetSirenAlarmSettingsResult");if(k&&k[0]&&"OK"==$(k[0]).text()){var l={nickName:null,description:null,opStatus:null,volume:null,defaultSound:null,duration:null,alarm:null};a.find("NickName").each(function(){l.nickName=$(this).text()});a.find("Description").each(function(){l.description=$(this).text()});a.find("OPStatus").each(function(){l.opStatus=$(this).text()});a.find("Volume").each(function(){l.volume=$(this).text()});a.find("Duration").each(function(){l.duration=$(this).text()});a.find("DefaultSound").each(function(){l.defaultSound=
$(this).text()});a.find("IsSounding").each(function(){l.alarm=$(this).text()});xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,d.node_id,l);h.forEach(function(b){b&&b(null,l)})}else b=Error("get siren settings failed"),h.forEach(function(a){a&&a(b)})}else b=Error("get contact settings result format error"),h.forEach(function(a){a&&a(b)})})}};return d}();
xnm.aio.dlink.DM=function(){var d=function(b,a){this.code=b;this.message=a;this.stack=Error().stack};d.prototype=Error();d.prototype.name="DlinkDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var c={"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"device ready",ref:{value:"ready",options:["true",
"false"]}},{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"float",name:"temperature",ref:{value:"temp"}},{type:"float",name:"current consumption",ref:{value:"power"}},{type:"float",name:"total consumption",ref:{value:"totalPower"}}]},motion:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}},{type:"int",name:"set sensitivity",ref:{value:"sensTo",
ext:"%d",extMeta:"1-100"}},{type:"enum",name:"sensitivity +",ref:{value:"sensUp"}},{type:"enum",name:"sensitivity -",ref:{value:"sensDown"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"int",name:"last detection (timestamp)",ref:{value:"dectTime"}},{type:"string",name:"last detection (text)",ref:{value:"dectTimeStr"}},{type:"int",name:"sensitivity",ref:{value:"sens"}}]},siren:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",
ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}},{type:"enum",name:"alarm",ref:{value:"play"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"set tone",ref:{value:"setTone",ext:"%e",extMeta:"emergency fire ambulance police doorbell acoustic_signal".split(" ")}},{type:"enum",name:"set duration (preset)",ref:{value:"setDurationP",ext:"%e",extMeta:["3s","10s","30s","1min","repeat"]}},{type:"int",name:"set duration",ref:{value:"setDuration",ext:"%d",
extMeta:"1-86400",unit:"s"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume",ref:{value:"setVolume",ext:"%d",extMeta:"0-100"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"enum",name:"alarming",ref:{value:"alarm",options:["true","false"]}},{type:"enum",name:"tone",ref:{value:"tone",options:"emergency fire ambulance police doorbell acoustic_signal".split(" ")}},
{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-100"}},{type:"int",name:"duration",ref:{value:"duration"}},{type:"string",name:"duration (text)",ref:{value:"durationStr"}}]},water:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"enum",name:"state",ref:{value:"state",options:["water",
"dry"]}},{type:"int",name:"last detection (timestamp)",ref:{value:"dectTime"}},{type:"string",name:"last detection (text)",ref:{value:"dectTimeStr"}}]}},a={contact:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"enum",name:"state",ref:{value:"state",options:["open","closed"]}},
{type:"float",name:"brightness",ref:{value:"bri"}},{type:"float",name:"temperature",ref:{value:"temp"}},{type:"int",name:"battery",ref:{value:"bat"}},{type:"enum",name:"sabotage",ref:{value:"sabo",options:["true","false"]}}]},motion:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}},{type:"int",name:"set sensitivity",ref:{value:"sensTo",ext:"%d",extMeta:"1-100"}},{type:"enum",
name:"sensitivity +",ref:{value:"sensUp"}},{type:"enum",name:"sensitivity -",ref:{value:"sensDown"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"int",name:"last detection (timestamp)",ref:{value:"dectTime"}},{type:"string",name:"last detection (text)",ref:{value:"dectTimeStr"}},{type:"int",name:"sensitivity",ref:{value:"sens"}},{type:"float",name:"brightness",ref:{value:"bri"}},{type:"float",name:"temperature",ref:{value:"temp"}},{type:"int",name:"battery",
ref:{value:"bat"}},{type:"enum",name:"sabotage",ref:{value:"sabo",options:["true","false"]}}]},siren:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}},{type:"enum",name:"alarm",ref:{value:"play"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"set tone",ref:{value:"setTone",ext:"%e",extMeta:"emergency fire ambulance police doorbell acoustic_signal".split(" ")}},
{type:"enum",name:"set duration (preset)",ref:{value:"setDurationP",ext:"%e",extMeta:["30s","60s","90s","3min","repeat"]}},{type:"int",name:"set duration",ref:{value:"setDuration",ext:"%d",extMeta:"1-86400",unit:"s"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"enum",name:"alarming",ref:{value:"alarm",options:["true","false"]}},{type:"enum",name:"tone",ref:{value:"tone",options:"emergency fire ambulance police doorbell acoustic_signal".split(" ")}},{type:"int",
name:"duration",ref:{value:"duration"}},{type:"string",name:"duration (text)",ref:{value:"durationStr"}}]}};return{SYS:"dlink",getIPDeviceType:function(){return[{sys:this.SYS,name:"mydlink Connected Home",port:80}]},getGatewayType:function(){return{sys:this.SYS,name:"mydlink Connected Home Hub",port:80}},getGatewayDeviceType:function(b){return[{sys:this.SYS,data:"contact",name:"Home Door/Window Sensor"},{sys:this.SYS,data:"motion",name:"Battery Motion Sensor"},{sys:this.SYS,data:"siren",name:"Siren"}]},
createGateway:function(b,a,c){a=d.ERROR_CODE;b?b.ip?b.password?c(null,b):c(new d(a.INVALID,"password is invalid")):c(new d(a.INVALID,"ip is invalid")):c(new d(a.INVALID,"info is invalid"))},updateGateway:function(b,a,c,e){b=d.ERROR_CODE;a?a.ip?a.password?e(null,a):e(new d(b.INVALID,"password is invalid")):e(new d(b.INVALID,"ip is invalid")):e(new d(b.INVALID,"update is invalid"))},deleteGateway:function(b,a,c){c()},createDevice:function(b,a,c){var e=d.ERROR_CODE;if(b)if(b.type)if(b.data){if("wifi"==
b.type){if(!b.ip){c(new d(e.INVALID,"ip is invalid"));return}if(!b.password){c(new d(e.INVALID,"password is invalid"));return}}else if("zwave"==b.type){if(!b.gateway){c(new d(e.INVALID,"gateway is invalid"));return}if(!b.node_id){c(new d(e.INVALID,"node_id is invalid"));return}if(!a.data||!a.data.gateways||0===a.data.gateways.length){c(new d(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));return}a=a.data.gateways;var h,k;for(h=0;h<a.length;h++)if(a[h].index===b.gateway){k=a[h];break}if(!k){c(new d(e.NOT_FOUND,
"gateway with index "+b.gateway+" not exists"));return}}c(null,b)}else c(new d(e.INVALID,"data is invalid"));else c(new d(e.INVALID,"type is invalid"));else c(new d(e.INVALID,"info is invalid"))},updateDevice:function(a,c,f){var e=d.ERROR_CODE;if(a)if(a.type)if(a.data){if("wifi"==a.type){if(!a.ip){f(new d(e.INVALID,"ip is invalid"));return}if(!a.password){f(new d(e.INVALID,"password is invalid"));return}}else if("zwave"==a.type){if(!a.gateway){f(new d(e.INVALID,"gateway is invalid"));return}if(!a.node_id){f(new d(e.INVALID,
"node_id is invalid"));return}if(!c.data||!c.data.gateways||0===c.data.gateways.length){f(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));return}c=c.data.gateways;var h,k;for(h=0;h<c.length;h++)if(c[h].index===a.gateway){k=c[h];break}if(!k){f(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));return}}f(null,a)}else f(new d(e.INVALID,"data is invalid"));else f(new d(e.INVALID,"type is invalid"));else f(new d(e.INVALID,"info is invalid"))},deleteDevice:function(a,c,
d){d()},applyUIFilter:function(a,c,d){var e=this,h=function(a,b,c){var d=[];a.forEach(function(a){if("root"==a.type){a=JSON.parse(JSON.stringify(a));var e=h(a.children,b,c);e&&0<e.length&&(a.children=e,d.push(a))}else{e=c.elems;if("*"==e)e=!0;else{for(var f=!1,g=0;g<e.length;g++)if(e[g]==a.type){f=!0;break}e=f}e&&(a=JSON.parse(JSON.stringify(a)),d.push(a))}});return d},k=function(a,b){var c=[],g=e.getCommandStatusMap(a,d);if(g){var k=[];switch(b.catagory){case "command":g.command&&(k=h(g.command,
a,b));break;case "status":g.status&&(k=h(g.status,a,b))}c=c.concat(k)}return c};if(!a.sys)return null;var l=JSON.parse(JSON.stringify(a)),m=null;switch(c.catagory){case "command":m=k(a,c);l.command=m;break;case "status":m=k(a,c);l.status=m;break;default:return null}return m&&0!=m.length?l:null},getCommandStatusMap:function(b){return b&&b.type&&b.data?"wifi"==b.type?c[b.data]:"zwave"==b.type?a[b.data]:null:null}}}();
xnm.aio.dlink.Handler=function(){var d=function(){};d.prototype.WifiPlug=xnm.aio.dlink.WifiPlug;d.prototype.WifiMotion=xnm.aio.dlink.WifiMotion;d.prototype.WifiSiren=xnm.aio.dlink.WifiSiren;d.prototype.WifiWater=xnm.aio.dlink.WifiWater;d.prototype.WifiHub=xnm.aio.dlink.WifiHub;d.prototype.devicemanager=xnm.aio.dlink.DM;d.prototype.registModule=function(c){c.register(this.devicemanager.SYS,"dlink")};d.prototype.resolveGateway=function(c){return c?"wifi"==c.type&&"hub"==c.data?xnm.aio.dlink.WifiDevice.parseJSON(c):
null:null};d.prototype.resolveDevice=function(c){if(!c)return null;switch(c.type){case "wifi":return xnm.aio.dlink.WifiDevice.parseJSON(c);default:return null}};d.prototype.getDeviceCommands=function(c,a){var b=this.devicemanager.applyUIFilter(c,{catagory:"command",elems:"*"}),b=b?b.command:[];a&&a(null,b)};d.prototype.getDeviceStatus=function(c,a){var b=this.devicemanager.applyUIFilter(c,{catagory:"status",elems:"*"}),b=b?b.status:[];a&&a(null,b)};d.prototype.doCommand=function(c,a,b,d){(c=c?this.resolveGateway(c):
this.resolveDevice(a))?c.executeCommandCreator(a,b,function(a){d&&d(a)}):d&&d(Error("gateway/device json format invalid"))};d.prototype.doStatus=function(c,a,b,d,f){(a=a?this.resolveGateway(a):this.resolveDevice(b))?a.getStatesCreator(null,[{id:c,device:b,status:d}],function(a,b){a?f&&f(a):f&&f(null,b[0])}):f&&f(Error("device json format invalid"))};d.prototype.discoverWifiDevice=function(c,a){var b=require("x.mdns.js");b.clearRecordBuffer();b.discoverServiceWithTimeout("_dhnap._tcp.local",c,function(b,
c){if(b)a&&a(b);else{for(var d=[],h=0;h<c.length;h++){var k=c[h],l=null;if(k.info&&k.ip&&0<k.ip.length){var m={ip:k.ip[0],mac:k.info.mac,model:k.info.model_number};switch(k.info.model_number){case "DSP-W215":l=new xnm.aio.dlink.WifiPlug(m);break;case "DCH-G020":l=new xnm.aio.dlink.WifiHub(m);break;case "DCH-S150":l=new xnm.aio.dlink.WifiMotion(m);break;case "DCH-S220":l=new xnm.aio.dlink.WifiSiren(m);break;case "DCH-S160":l=new xnm.aio.dlink.WifiWater(m)}l&&d.push(l)}}a&&a(b,d)}})};d.prototype.listZwaveDevice=
function(c,a){var b=this.resolveGateway(c);b?b.listZwaveDevice(a):a&&a(Error("gateway json format invalid"))};return d}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.dlink.Handler);
