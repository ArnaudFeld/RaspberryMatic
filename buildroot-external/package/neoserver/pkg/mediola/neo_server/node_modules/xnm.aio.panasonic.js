var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.panasonic=xnm.aio.panasonic||{},xnm.aio.panasonic.BDP=function(){var e=function e(_e,t,o,n){this._logger=require("x.logger.js").getLogger("xnm.aio.panasonic.BDP"),this.ip=_e,this.port=t,this.port||(this.port=80),this.username=o,this.password=n;};return e.URL="/WAN/dvdr/dvdr_ctrl.cgi",e.prototype._executeCommand=function(e,t){this._doRequest(e,t);},e.prototype._doRequest=function(t,o){var n=this,r=o;this._logger.log("trace","send data:"+t+" to:"+this.ip);var s={host:this.ip,port:this.port,path:e.URL,method:"POST",headers:{"User-Agent":"MEI-LAN-REMOTE-CALL"}};(this.username||this.password)&&(s.auth=(this.username?this.username:"")+":"+(this.password?this.password:""),s.headers.Authorization="Basic "+new Buffer((this.username?this.username:"")+":"+(this.password?this.password:"")).toString("base64"));var i="",a=require("http").request(s,function(e){e.on("data",function(e){i+=e;}),e.on("end",function(){200==e.statusCode?(n._logger.log("trace","http request success"),r&&(r(null,i),r=null)):(n._logger.log("trace","http request error:"+e.statusCode),r&&(r(new Error("post request failed with status code:"+e.statusCode)),r=null));});});a.setTimeout&&a.setTimeout(3e3,function(){n._logger.log("trace","http request timeout"),a.abort();}),a.on&&"function"==typeof a.on&&a.on("error",function(e){e||(e=new Error("http request error")),n._logger.log("trace","http request error:"+e.message),r&&r(e),r=null;}),a.write(t),a.end();},e;}(),xnm.aio.panasonic.BDP.DM={SYS:"panasonic_bdp",getIPDeviceType:function getIPDeviceType(){return{sys:this.SYS,name:"Panasonic BDP"};}},xnm.aio.panasonic.TV=function(){var e=function e(_e2,t,o,n,r){this._logger=require("x.logger.js").getLogger("xnm.aio.panasonic.TV"),this.ip=_e2,this.port=t,(!t||t<0)&&(this.port=55e3),this.path=o,o||(this.path="/nrc/control_0"),this.username=n,this.password=r;};return e.XML_HEADER='<?xml version="1.0" encoding="utf-8"?>',e.SOAP_EVELOPE_START='<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">',e.SOAP_EVELOPE_END="</s:Envelope>",e.SOAP_BODY_START="<s:Body>",e.SOAP_BODY_END="</s:Body>",e.SOAP_SENDKEY_START='<u:X_SendKey xmlns:u="urn:urn:panasonic-com:service:p00NetworkControl:1">',e.SOAP_SENDKEY_END="</u:X_SendKey>",e.KEY_CODE_START="<X_KeyEvent>",e.KEY_CODE_END="</X_KeyEvent>",e.SOAP_SENDTXT_START='<u:X_SendString xmlns:u="urn:urn:panasonic-com:service:p00NetworkControl:1">',e.SOAP_SENDTXT_END="</u:X_SendString>",e.TXT_START="<X_String>",e.TXT_END="</X_String>",e.prototype._sendTxt=function(e,t){var o=this._buildSoapReq(e,!0);this._doRequest("urn:panasonic-com:service:p00NetworkControl:1#X_SendString",o,function(e){t&&t(e);});},e.prototype._executeCommand=function(e,t){this._logger.log("debug","send key:"+e);var o=this._buildSoapReq(e),n=this;this._doRequest("urn:panasonic-com:service:p00NetworkControl:1#X_SendKey",o,function(e){n._logger.log("debug","send key "+(e?"error:"+e.message:"success")),t&&t(e);});},e.prototype._buildSoapReq=function(t,o){var n=e.XML_HEADER;return n+=e.SOAP_EVELOPE_START,n+=e.SOAP_BODY_START,n+=o?e.SOAP_SENDTXT_START:e.SOAP_SENDKEY_START,n+=o?e.TXT_START:e.KEY_CODE_START,n+=t,n+=o?e.TXT_END:e.KEY_CODE_END,n+=o?e.SOAP_SENDTXT_END:e.SOAP_SENDKEY_END,(n+=e.SOAP_BODY_END)+e.SOAP_EVELOPE_END;},e.prototype._doRequest=function(e,t,o){var n=this,r="http://"+this.ip+":"+this.port+this.path,s=o;this._logger.log("trace","send data:"+t+" to:"+r),$.ajax({url:r,type:"POST",timeout:3e3,data:t,cache:!1,headers:{SOAPAction:'"'+e+'"',"Content-Type":"text/xml; charset=UTF-8","Content-Length":t.length},username:this.username,password:this.password,success:function success(){n._logger.log("trace","http request success"),o&&o();},error:function error(e,t){var o="http request error:"+(e?e.status:"0")+"-"+t;s&&(s(new Error(o)),s=null);}});},e;}(),xnm.aio.panasonic.DM=function(){var e=function e(_e3,t){this.code=_e3,this.message=t,this.stack=new Error().stack;};return(e.prototype=new Error()).name="PanasonicDMError",e.prototype.code=0,e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{getSys:function getSys(){var e=[];for(var t in xnm.aio.lg)xnm.aio.lg.hasOwnProperty(t)&&xnm.aio.lg[t]&&xnm.aio.lg[t].DM&&e.push(xnm.aio.lg[t]);return e;},registModule:function registModule(e){for(var t=this.getSys(),o=0;o<t.length;o++)t[o]&&t[o].DM&&t[o].DM.SYS&&e.register(t[o].DM.SYS,"panasonic");},getIPDeviceType:function getIPDeviceType(){for(var e=[],t=this.getSys(),o=0;o<t.length;o++)if(t[o]&&t[o].DM&&t[o].DM.getIPDeviceType){var n=t[o].DM.getIPDeviceType();n&&e.push(n);}return e;}};}(),xnm.aio.panasonic.Handler=function(){var e=function e(){};return e.prototype.devicemanager=xnm.aio.panasonic.DM,e.prototype.BDP=xnm.aio.panasonic.BDP,e.prototype.TV=xnm.aio.panasonic.TV,e.prototype.registModule=function(e){this.devicemanager.registModule(e);},e;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.panasonic.Handler());