var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.panasonic=xnm.aio.panasonic||{};
xnm.aio.panasonic.BDP=function(){var a=function(a,b,c,e){this._logger=require("x.logger.js").getLogger("xnm.aio.panasonic.BDP");this.ip=a;this.port=b;this.port||(this.port=80);this.username=c;this.password=e};a.URL="/WAN/dvdr/dvdr_ctrl.cgi";a.prototype._executeCommand=function(a,b){this._doRequest(a,b)};a.prototype._doRequest=function(d,b){var c=this,e=b;this._logger.log("trace","send data:"+d+" to:"+this.ip);b={host:this.ip,port:this.port,path:a.URL,method:"POST",headers:{"User-Agent":"MEI-LAN-REMOTE-CALL"}};
if(this.username||this.password)b.auth=(this.username?this.username:"")+":"+(this.password?this.password:""),b.headers.Authorization="Basic "+(new Buffer((this.username?this.username:"")+":"+(this.password?this.password:""))).toString("base64");var g="",f=require("http").request(b,function(a){a.on("data",function(a){g+=a});a.on("end",function(){200==a.statusCode?(c._logger.log("trace","http request success"),e&&(e(null,g),e=null)):(c._logger.log("trace","http request error:"+a.statusCode),e&&(e(Error("post request failed with status code:"+
a.statusCode)),e=null))})});f.setTimeout&&f.setTimeout(3E3,function(){c._logger.log("trace","http request timeout");f.abort()});if(f.on&&"function"==typeof f.on)f.on("error",function(a){a||(a=Error("http request error"));c._logger.log("trace","http request error:"+a.message);e&&e(a);e=null});f.write(d);f.end()};return a}();xnm.aio.panasonic.BDP.DM=function(){return{SYS:"panasonic_bdp",getIPDeviceType:function(){return{sys:this.SYS,name:"Panasonic BDP"}}}}();
xnm.aio.panasonic.TV=function(){var a=function(a,b,c,e,g){this._logger=require("x.logger.js").getLogger("xnm.aio.panasonic.TV");this.ip=a;this.port=b;if(!b||0>b)this.port=55E3;this.path=c;c||(this.path="/nrc/control_0");this.username=e;this.password=g};a.XML_HEADER='<?xml version="1.0" encoding="utf-8"?>';a.SOAP_EVELOPE_START='<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">';a.SOAP_EVELOPE_END="</s:Envelope>";a.SOAP_BODY_START=
"<s:Body>";a.SOAP_BODY_END="</s:Body>";a.SOAP_SENDKEY_START='<u:X_SendKey xmlns:u="urn:urn:panasonic-com:service:p00NetworkControl:1">';a.SOAP_SENDKEY_END="</u:X_SendKey>";a.KEY_CODE_START="<X_KeyEvent>";a.KEY_CODE_END="</X_KeyEvent>";a.SOAP_SENDTXT_START='<u:X_SendString xmlns:u="urn:urn:panasonic-com:service:p00NetworkControl:1">';a.SOAP_SENDTXT_END="</u:X_SendString>";a.TXT_START="<X_String>";a.TXT_END="</X_String>";a.prototype._sendTxt=function(a,b){a=this._buildSoapReq(a,!0);this._doRequest("urn:panasonic-com:service:p00NetworkControl:1#X_SendString",
a,function(a){b&&b(a)})};a.prototype._executeCommand=function(a,b){this._logger.log("debug","send key:"+a);a=this._buildSoapReq(a);var c=this;this._doRequest("urn:panasonic-com:service:p00NetworkControl:1#X_SendKey",a,function(a){c._logger.log("debug","send key "+(a?"error:"+a.message:"success"));b&&b(a)})};a.prototype._buildSoapReq=function(d,b){var c=a.XML_HEADER;c+=a.SOAP_EVELOPE_START;c+=a.SOAP_BODY_START;c+=b?a.SOAP_SENDTXT_START:a.SOAP_SENDKEY_START;c+=b?a.TXT_START:a.KEY_CODE_START;c=c+d+(b?
a.TXT_END:a.KEY_CODE_END);c+=b?a.SOAP_SENDTXT_END:a.SOAP_SENDKEY_END;c+=a.SOAP_BODY_END;return c+=a.SOAP_EVELOPE_END};a.prototype._doRequest=function(a,b,c){var d=this,g="http://"+this.ip+":"+this.port+this.path,f=c;this._logger.log("trace","send data:"+b+" to:"+g);$.ajax({url:g,type:"POST",timeout:3E3,data:b,cache:!1,headers:{SOAPAction:'"'+a+'"',"Content-Type":"text/xml; charset=UTF-8","Content-Length":b.length},username:this.username,password:this.password,success:function(){d._logger.log("trace",
"http request success");c&&c()},error:function(a,b){a="http request error:"+(a?a.status:"0")+"-"+b;f&&(f(Error(a)),f=null)}})};return a}();
xnm.aio.panasonic.DM=function(){return{getSys:function(){var a=[],d;for(d in xnm.aio.lg)xnm.aio.lg.hasOwnProperty(d)&&xnm.aio.lg[d]&&xnm.aio.lg[d].DM&&a.push(xnm.aio.lg[d]);return a},registModule:function(a){for(var d=this.getSys(),b=0;b<d.length;b++)d[b]&&d[b].DM&&d[b].DM.SYS&&a.register(d[b].DM.SYS,"panasonic")},getIPDeviceType:function(){for(var a=[],d=this.getSys(),b=0;b<d.length;b++)if(d[b]&&d[b].DM&&d[b].DM.getIPDeviceType){var c=d[b].DM.getIPDeviceType();c&&a.push(c)}return a}}}();
xnm.aio.panasonic.Handler=function(){var a=function(){};a.prototype.devicemanager=xnm.aio.panasonic.DM;a.prototype.BDP=xnm.aio.panasonic.BDP;a.prototype.TV=xnm.aio.panasonic.TV;a.prototype.registModule=function(a){this.devicemanager.registModule(a)};return a}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.panasonic.Handler);
