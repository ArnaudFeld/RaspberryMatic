"use strict";function _typeof(o){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o;}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o;},_typeof(o);}function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_unsupportedIterableToArray(arr)||_nonIterableSpread();}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen);}function _iterableToArray(iter){if(typeof Symbol!=="undefined"&&iter[Symbol.iterator]!=null||iter["@@iterator"]!=null)return Array.from(iter);}function _arrayWithoutHoles(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr);}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2;}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,_toPropertyKey(descriptor.key),descriptor);}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);Object.defineProperty(Constructor,"prototype",{writable:false});return Constructor;}function _toPropertyKey(arg){var key=_toPrimitive(arg,"string");return _typeof(key)==="symbol"?key:String(key);}function _toPrimitive(input,hint){if(_typeof(input)!=="object"||input===null)return input;var prim=input[Symbol.toPrimitive];if(prim!==undefined){var res=prim.call(input,hint||"default");if(_typeof(res)!=="object")return res;throw new TypeError("@@toPrimitive must return a primitive value.");}return(hint==="string"?String:Number)(input);}var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.matterbridge={PACKET_TYPE:{UNKNOWN:0,RESPONSE:1,STATE:2,PAIRING_STEP1:3,PAIRING_STEP2:4},logger:{log:function log(e,t){console[e](t);}},concatUint8Arrays:function concatUint8Arrays(){var t=0;for(var _len=arguments.length,e=new Array(_len),_key=0;_key<_len;_key++){e[_key]=arguments[_key];}e.forEach(function(e){return t+=e.length;});var s=new Uint8Array(t);var a=0;return e.forEach(function(e){s.set(e,a),a+=e.length;}),s;},generateRandom:function generateRandom(e){var t=new Uint8Array(e);return t=t.fill().map(function(){return Math.round(255*Math.random());}),t;},isEqualUint8Array:function isEqualUint8Array(e,t){if(e.byteLength!==t.byteLength)return!1;for(var s=0;s<e.length;s++)if(e[s]!==t[s])return!1;return!0;},parseJSON:function parseJSON(e){return new xnm.aio.matterbridge.Bridge(e);},strToUint8Array:function strToUint8Array(e,t){var s=Math.min(e.length,(t===null||t===void 0?void 0:t.maxLength)||e.length),a=new Uint8Array(s);for(var _t=0;_t<s;_t++)a[_t]=e.charCodeAt(_t);return a;},uint8ArrayToStr:function uint8ArrayToStr(e){if("function"==typeof TextDecoder)return new TextDecoder().decode(e);try{return new(0,require("util").TextDecoder)().decode(e);}catch(e){xnm.aio.matterbridge.logger.log("error","[uint8ArrayToStr] "+e.message);}return String.fromCharCode.apply(null,e);}},xnm.aio.matterbridge.WebSocket=/*#__PURE__*/function(){function _class(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:443;_classCallCheck(this,_class);this._host=e,this._port=t,this._mode=xnm.aio.matterbridge.WebSocket.MODE.HTTP,this._on={},this._socket=null,this._wsSecKey=xnm.aio.matterbridge.WebSocket.generateSecKey();}_createClass(_class,[{key:"_packageForSending",value:function _packageForSending(e){var t=[];var s=0;if(t[s++]=129,e.byteLength<=125)t[s++]=e.byteLength+128;else{if(!(e.byteLength<=65535))return xnm.aio.matterbridge.logger.log("error","[WebSocket._packageForSending] (".concat(this._host,") Message too long: ")+e.byteLength),null;t[s++]=254,t[s++]=e.byteLength>>8&255,t[s++]=255&e.byteLength;}var a=[];for(var _e=0;_e<4;_e++)a.push(Math.floor(255*Math.random())),t[s++]=a[_e];for(var o=0;o<e.length;o++)t[s++]=e[o]^a[o%4];return new Uint8Array(t);}},{key:"close",value:function close(){this._socket&&(this._socket.destroy(),this._socket=null),this._mode=xnm.aio.matterbridge.WebSocket.MODE.HTTP;}},{key:"connect",value:function connect(){var _this=this;var e=xnm.aio.matterbridge.WebSocket.MODE,t=require("net");this._socket=t.connect({host:this._host,port:this._port}),this._socket.on("connect",function(){xnm.aio.matterbridge.logger.log("debug","[WebSocket] Socket connected to \"".concat(_this._host,"\" on port ").concat(_this._port));var e=["GET /ws HTTP/1.1","Connection: Upgrade","Upgrade: websocket","Sec-WebSocket-Key: "+_this._wsSecKey,"Sec-WebSocket-Version: 13"].join("\n")+"\n\n";_this._socket.write(e);}),this._socket.on("error",function(e){xnm.aio.matterbridge.logger.log("error","[WebSocket] (".concat(_this._host,") Error: ")+e.message),_this._socket&&(_this._socket.end(),_this._socket=null),a=[],_this._on.error&&_this._on.error(e);}),"function"==typeof this._socket._doConnect&&this._socket._doConnect();var s=xnm.aio.matterbridge.PACKET_TYPE;var a=[],o=-1;this._socket.on("data",function(t){if(xnm.aio.matterbridge.logger.log("debug","[WebSocket] (".concat(_this._host,") (mode=").concat(_this._mode,") ")+new Uint8Array(t).toString()),_this._mode===e.HTTP){var _s=xnm.aio.matterbridge.uint8ArrayToStr(new Uint8Array(t));_s.startsWith("HTTP/1.1 101")?(xnm.aio.matterbridge.logger.log("debug","[WebSocket] (".concat(_this._host,") Connection upgrade accepted")),_this._mode=e.WEBSOCKET):xnm.aio.matterbridge.logger.log("debug","[WebSocket] (".concat(_this._host,") Unexpected HTTP message: ")+_s);}else if(_this._mode===e.WEBSOCKET){var _e2=new Uint8Array(t);if(0===_e2.length)return void xnm.aio.matterbridge.logger.log("info","[WebSocket] (".concat(_this._host,") Empty payload, ignore"));if(130===_e2[0]&&o<0){var _t2=0;if(2===_e2.length?(_t2=_e2.length,o=_e2[1]):4===_e2.length&&126===_e2[1]?(_t2=_e2.length,o=(_e2[2]<<8)+_e2[3]):10===_e2.length&&127===_e2[1]&&(_t2=_e2.length,o=(_e2[2]<<56)+(_e2[3]<<48)+(_e2[4]<<40)+(_e2[5]<<32)+(_e2[6]<<24)+(_e2[7]<<16)+(_e2[8]<<8)+_e2[9]),_t2>0)return void xnm.aio.matterbridge.logger.log("debug","[WebSocket] (".concat(_this._host,") Remembering payload length of ").concat(o," for next message. Header length was ").concat(_t2,"."));126===_e2[1]?(o=(_e2[2]<<8)+_e2[3],_e2=_e2.subarray(4)):127===_e2[1]?(o=(_e2[2]<<56)+(_e2[3]<<48)+(_e2[4]<<40)+(_e2[5]<<32)+(_e2[6]<<24)+(_e2[7]<<16)+(_e2[8]<<8)+_e2[9],_e2=_e2.subarray(10)):_e2[1]>0&&(o=_e2[1],_e2=_e2.subarray(2));}var n=[_e2];if(o>-1){n=[_e2.subarray(0,o)];var _t3=_e2.subarray(o);for(;_t3.length>2&&130===_t3[0];)if(126===_t3[1]){var _e3=4;if(_t3.length<_e3)break;var _s2=(_t3[2]<<8)+_t3[3]+_e3;n.push(_t3.subarray(_e3,_s2)),_t3=_t3.subarray(_s2);}else if(127===_t3[1]){var _e4=10;if(_t3.length<_e4)break;var _s3=(_t3[2]<<56)+(_t3[3]<<48)+(_t3[4]<<40)+(_t3[5]<<32)+(_t3[6]<<24)+(_t3[7]<<16)+(_t3[8]<<8)+_t3[9]+_e4;n.push(_t3.subarray(_e4,_s3)),_t3=_t3.subarray(_s3);}else{var _e5=_t3[1]+2;n.push(_t3.subarray(2,_e5)),_t3=_t3.subarray(_e5);}o=-1;}n.forEach(function(e){var t=0;e.length>4&&(t=(e[2]<<8)+e[3]+8);var o=15&e[0],n=(128&e[0])>0;e.length>4&&e.length===t?(a.push(e),n&&(1===o?_this._on.message&&_this._on.message({type:s.STATE,payload:a}):6===o&&_this._on.message&&_this._on.message({type:s.RESPONSE,payload:a}),a=[])):1===o?34!==e.length&&66!==e.length||(_this._on.message&&_this._on.message({type:s.PAIRING_STEP1,payload:e}),a=[]):2===o?(4===e.length||24===e.length&&n)&&(_this._on.message&&_this._on.message({type:s.PAIRING_STEP2,payload:e}),a=[]):(xnm.aio.matterbridge.logger.log("error","[WebSocket] (".concat(_this._host,") Invalid packet.")),a=[]);});}}),this._socket.on("close",function(){xnm.aio.matterbridge.logger.log("debug","[WebSocket] (".concat(_this._host,") Connection closed")),_this._socket=null,_this._on.close&&_this._on.close();});}},{key:"on",value:function on(e,t){if(!["close","error","message","open"].includes(e))throw new Error("Unknown event type: ".concat(e));this._on[e]=t;}},{key:"send",value:function send(e,t){if(!this._socket){var _e6=new Error("No socket for sending.");return xnm.aio.matterbridge.logger.log("error","[WebSocket.send] (".concat(this._host,") ")+_e6.message),void(t&&t(_e6));}var s="utf-8";this._mode===xnm.aio.matterbridge.WebSocket.MODE.WEBSOCKET&&("string"==typeof e&&(e=xnm.aio.matterbridge.strToUint8Array(e)),e=this._packageForSending(e),s="binary"),xnm.aio.matterbridge.logger.log("debug","[WebSocket.send] (".concat(this._host,") Message with length ")+e.length),this._socket.write(e,s,function(){t&&t();});}}],[{key:"generateSecKey",value:function generateSecKey(){var e=xnm.aio.matterbridge.generateRandom(16);return btoa(String.fromCharCode.apply(String,_toConsumableArray(e)));}}]);return _class;}(),xnm.aio.matterbridge.Bridge=/*#__PURE__*/function(){function _class2(e){_classCallCheck(this,_class2);this.id=e.id,this.ip=e.ip,this.port=e.port||80,this.username=e.username||"admin",this.password=e.password,this.home_token=e.home_token,!this.password&&this.home_token&&(this.username="_home",this.password=this.home_token),this._aesKey=null,this._challenge=null,this._challengeDevice=null,this._counter=0,this._counterDevice=0,this._nextMessageCallback=null,this._requestQueue=[],this._expectedSessionCode=null,this._isWaitingForHandshakeResponse=!1,this._ws=null,this._commandHandler=null,this._bridgeCache=null,this._reportedState=!1,this._lastStatesSuccess=0,this.mode=xnm.aio.matterbridge.Bridge.MODE.WEBSOCKET,this.state=xnm.aio.matterbridge.Bridge.STATE.UNCONNECTED;}_createClass(_class2,[{key:"_connectUsingHTTP",value:function _connectUsingHTTP(e){var _this2=this;this._doRequestHTTP("/api/states",null,function(t,s){t?_this2.state=xnm.aio.matterbridge.Bridge.STATE.FAILED:(xnm.aio.matterbridge.logger.log("debug","[_connectUsingHTTP] (".concat(_this2.ip,") Using fallback to HTTP.")),_this2.state=xnm.aio.matterbridge.Bridge.STATE.CONNECTED,_this2.mode=xnm.aio.matterbridge.Bridge.MODE.HTTP),e&&e(t);});}},{key:"_createHmacDigest",value:function _createHmacDigest(e,t){var s=require("x.crypt.js").sjcl,a=new s.misc.hmac(s.codec.bytes.toBits(e),s.hash.sha1).encrypt(s.codec.bytes.toBits(t));return new Uint8Array(s.codec.bytes.fromBits(a,!1));}},{key:"_decryptMessage",value:function _decryptMessage(e){if(0===e.payload.length)return xnm.aio.matterbridge.logger.log("error","[_decryptMessage] (".concat(this.ip,") Unexpected input length of 0")),null;var t={type:e.type,message:new Uint8Array(0)};for(var s=0;s<e.payload.length;s++){var a=e.payload[s];if(a.length<8)return xnm.aio.matterbridge.logger.log("error","[_decryptMessage] (".concat(this.ip,") Payload part is too short: ")+a.length),null;var o=(a[4]<<24)+(a[5]<<16)+(a[6]<<8)+a[7];if(o>this._counterDevice){var _e7=this._decryptMessageAES256CCM(this._aesKey,this._getIV(this._challengeDevice,o),a.subarray(8));_e7.length>0&&(this._counterDevice=o,t.message=xnm.aio.matterbridge.concatUint8Arrays(t.message,_e7));}}return t;}},{key:"_decryptMessageAES256CCM",value:function _decryptMessageAES256CCM(e,t,s){var a=require("x.crypt.js").sjcl,o=new a.cipher.aes(a.codec.bytes.toBits(e)),n=a.mode.ccm.decrypt(o,a.codec.bytes.toBits(s),a.codec.bytes.toBits(t),[],128);return new Uint8Array(a.codec.bytes.fromBits(n,!1));}},{key:"_doHandshake",value:function _doHandshake(e){xnm.aio.matterbridge.logger.log("debug","[Bridge._doHandshake] (".concat(this.ip,") Starting handshake"));var t=require("x.crypt.js"),s=e.subarray(0,32);this._challengeDevice=Uint8Array.from(e.subarray(32));var a=xnm.aio.matterbridge.generateRandom(32),o=t.axlsign.generateKeyPair(a),n=t.axlsign.sharedKey(o["private"],s);this._aesKey=Uint8Array.from(n);var i=xnm.aio.matterbridge.generateRandom(84);this._challenge=Uint8Array.from(i.subarray(0,32));var r=this._getPBKDF2DerivedKey(),l=xnm.aio.matterbridge.concatUint8Arrays(this._challengeDevice,this._challenge),m=this._createHmacDigest(r,l);this._updatePairingData(i,m);var p=this._challengeDevice.subarray(0,13),d=this._encryptMessageAES256CCM(this._aesKey,p,i);100!==d.length&&xnm.aio.matterbridge.logger.log("error","[Bridge._doHandshake] (".concat(this.ip,") Encoded message length is ").concat(d.length," instead of 100"));var u=Uint8Array.from([129,0,0,o["public"].byteLength+d.byteLength]),c=xnm.aio.matterbridge.concatUint8Arrays(u,o["public"],d);this._expectedSessionCode=this._createHmacDigest(r,this._challenge),this._isWaitingForHandshakeResponse=!0,this._ws.send(c);}},{key:"_doRequest",value:function _doRequest(e,t,s){var _this3=this;var a=e;t&&(a+="\n",a+="string"==typeof t?t:JSON.stringify(t));var o=xnm.aio.matterbridge.strToUint8Array(a);xnm.aio.matterbridge.logger.log("debug","[_doRequest] (".concat(this.ip,") (len: ").concat(o.length,") ")+a.replace("\n"," "));var n=function n(e){if(e>=o.length)return void(s&&s());var t=Math.min(o.length-e,1024),a=t+16-t%16;for(;a>1024;)t--,a=t+16-t%16;var i=_this3._nextCounter(),r=_this3._encryptMessageAES256CCM(_this3._aesKey,_this3._getIV(_this3._challenge,i),o.subarray(e,e+t)),l=[5,0,r.length>>8,255&r.length,i>>24,(255&i)>>16,(255&i)>>8,255&i];(e+=t)===o.length&&(l[0]=133);var m=xnm.aio.matterbridge.concatUint8Arrays(l,r);_this3._ws.send(m,function(t){t?s&&s(t):n(e);});};n(0);}},{key:"_doRequestHTTP",value:function _doRequestHTTP(e,t,s){var _this4=this;var a=require("http"),o=Buffer.from(this.username+":"+this.password).toString("base64"),n=t?"POST":"GET",i={host:this.ip,path:e,method:n,headers:{Connection:"close","Content-Type":"application/json",Authorization:"Basic "+o},rejectUnauthorized:!1};t&&("string"!=typeof t&&(t=JSON.stringify(t)),i.headers["Content-Length"]=t.length),"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),xnm.aio.matterbridge.logger.log("debug","[_doRequestHTTP] (".concat(this.ip,") ").concat(n," ").concat(e," with data ").concat(t," as user ").concat(this.username));var r=a.request(i,function(e){var t="";e.setEncoding("utf-8"),e.on("data",function(e){t+=e;}),e.on("end",function(){var a=null,o=null;if(200==e.statusCode)try{o=t?JSON.parse(t):null;}catch(e){a=e;}else a=new Error("HTTP response: "+e.statusCode);s&&(s(a,o,e.statusCode),s=null);});});r.on&&r.on("error",function(e){xnm.aio.matterbridge.logger.log("error","[_doRequestHTTP] (".concat(_this4.ip,") ")+e.message),s&&(s(e),s=null);}),r.setTimeout&&r.setTimeout(1e4,function(){xnm.aio.matterbridge.logger.log("error","[_doRequestHTTP] (".concat(_this4.ip,") Timeout for request \"").concat(e,"\"")),s&&(s(new Error("Timeout")),s=null);}),t&&r.write(t),r.end();}},{key:"_encryptMessageAES256CCM",value:function _encryptMessageAES256CCM(e,t,s){var a=require("x.crypt.js").sjcl,o=new a.cipher.aes(a.codec.bytes.toBits(e)),n=a.mode.ccm.encrypt(o,a.codec.bytes.toBits(s),a.codec.bytes.toBits(t),[],128);return new Uint8Array(a.codec.bytes.fromBits(n,!1));}},{key:"_getError",value:function _getError(e,t){var _t$XC_ERR;return e||(t!==null&&t!==void 0&&t.XC_ERR?new Error(((_t$XC_ERR=t.XC_ERR)===null||_t$XC_ERR===void 0?void 0:_t$XC_ERR.text)||JSON.stringify(t)):t!==null&&t!==void 0&&t.XC_SUC?null:new Error("Response does not include XC_SUC part."));}},{key:"_getIV",value:function _getIV(e,t){var s=new Uint8Array(e.subarray(0,13));return s[9]=(4278190080&t)>>24,s[10]=(16711680&t)>>16,s[11]=(65280&t)>>8,s[12]=255&t,s;}},{key:"_getPBKDF2DerivedKey",value:function _getPBKDF2DerivedKey(){var e=require("x.crypt.js").sjcl,t=this.id+":"+this.username,s=e.misc.pbkdf2(this.password,t,1e3);return new Uint8Array(e.codec.bytes.fromBits(s,!1));}},{key:"_handleConnecting",value:function _handleConnecting(e,t){if(this._isWaitingForHandshakeResponse){this._isWaitingForHandshakeResponse=!1;var s=null;xnm.aio.matterbridge.isEqualUint8Array(e,this._expectedSessionCode)?(xnm.aio.matterbridge.logger.log("info","[Bridge._handleConnecting] (".concat(this.ip,") Success")),this._expectedSessionCode=null,this.state=xnm.aio.matterbridge.Bridge.STATE.CONNECTED):(xnm.aio.matterbridge.logger.log("error","[Bridge._handleConnecting] (".concat(this.ip,") Handshake failed, response did not match")),s=new Error("Connecting to the device failed, mismatch in handshake"),this.state=xnm.aio.matterbridge.Bridge.STATE.FAILED),t(s);}else if(64===e.byteLength){var _t4=Uint8Array.from(e);this._doHandshake(_t4);}}},{key:"_nextCounter",value:function _nextCounter(){return this._counter>4294967295?this._counter=0:this._counter++,this._counter;}},{key:"_updatePairingData",value:function _updatePairingData(e,t){var s=xnm.aio.matterbridge.strToUint8Array(this.username,{maxLength:32});for(var _t5=0;_t5<s.length;_t5++)e[32+_t5]=s[_t5];s.length<32&&(e[32+s.length]=0);for(var _s4=0;_s4<20;_s4++)e[64+_s4]=t[_s4];}},{key:"_prepareConnectingMessage",value:function _prepareConnectingMessage(e){var t=xnm.aio.matterbridge.PACKET_TYPE,s=e.payload.length;var a=new Uint8Array(0);if(e.type===t.PAIRING_STEP1)66!==s&&34!==s||(a=e.payload.subarray(2));else if(e.type===t.PAIRING_STEP2){var _t6=(128&e.payload[0])>0;4===s?a=e.payload.subarray(2):24===s&&_t6&&(a=e.payload.subarray(4));}return a;}},{key:"_updateDeviceStates",value:function _updateDeviceStates(e){if(!this._commandHandler||!this._deviceList||!(e!==null&&e!==void 0&&e.state))return;this._stateCache=this._stateCache||{},this._stateCache[e.id]=e.state;var t=parseInt(e.id,10),s=[];for(var a in this._deviceList){var o=this._deviceList[a];if(!(o&&o.id&&o.device&&o.status))continue;if(t!==parseInt(o.device.id,10))continue;var n=e.state[o.status.value];null!=n&&s.push({id:o.id,status:n});}this._reportedState=!0,this._commandHandler.reportStates(null,s);}},{key:"connect",value:function connect(e){var _this5=this;var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:!1;var s=xnm.aio.matterbridge.Bridge.MODE,a=xnm.aio.matterbridge.Bridge.STATE;if(this.state===a.CONNECTING)return void xnm.aio.matterbridge.logger.log("debug","[Bridge.connect] (".concat(this.ip,") Already in state \"").concat(this.state,"\"."));this._ws&&this._ws.close();var o=null;t||(o=setTimeout(function(){o=null,_this5.state!==a.CONNECTED&&(xnm.aio.matterbridge.logger.log("debug","[Bridge.connect] (".concat(_this5.ip,") Connect timeout. Retrying.")),_this5.state=null,_this5.connect(e,!0));},5e3)),this.mode=s.WEBSOCKET,this.state=a.CONNECTING;var n=xnm.aio.matterbridge.PACKET_TYPE;this._reportedState=!1,this._ws=new xnm.aio.matterbridge.WebSocket(this.ip,this.port),this._ws.on("error",function(t){_this5.state=a.FAILED,_this5._ws=null,null===o&&_this5._connectUsingHTTP(e);}),this._ws.on("message",function(t){if(_this5.state!==a.CONNECTED){var _s5=_this5._prepareConnectingMessage(t);_this5._handleConnecting(_s5,e);}else{var _e8=_this5._decryptMessage(t);if(t.type===n.RESPONSE){var _s6=null,_a=null;try{_s6=xnm.aio.matterbridge.uint8ArrayToStr(_e8.message),_s6=JSON.parse(_s6);}catch(t){xnm.aio.matterbridge.logger.log("error","(".concat(_this5.ip,") Parsing WebSocket response message: ").concat(t.message," (").concat(_e8.message,")")),_a=t;}_this5._latestStatesRequest?_this5._latestStatesRequest.cb(_a,_s6):_this5._latestCommand&&_this5._latestCommand.cb(_a,_s6);}else if(t.type===n.STATE)try{var _t7=xnm.aio.matterbridge.uint8ArrayToStr(_e8.message);_t7=JSON.parse(_t7),xnm.aio.matterbridge.logger.log("debug","(".concat(_this5.ip,") STATE message received")),_this5._updateDeviceStates(_t7);}catch(e){xnm.aio.matterbridge.logger.log("error","(".concat(_this5.ip,") STATE message parse error: ")+e.message);}else xnm.aio.matterbridge.logger.log("warn","[Bridge] (on message) (".concat(_this5.ip,") Unexpected message type: ").concat(t.type));}}),this._ws.connect();}},{key:"destroy",value:function destroy(){this._ws&&(this._ws.close(),this._ws=null),this._aesKey=null,this._challenge=null,this._challengeDevice=null,this._counter=0,this._counterDevice=0,this._nextMessageCallback=null,this._requestQueue=[],this._expectedSessionCode=null,this._isWaitingForHandshakeResponse=!1,this._lastStatesSuccess=0,this._latestCommand=null,this._latestStatesRequest=null,this._reportedState=!1,this.mode=xnm.aio.matterbridge.Bridge.MODE.WEBSOCKET,this.state=xnm.aio.matterbridge.Bridge.STATE.DESTROYED;}},{key:"executeCommandCreator",value:function executeCommandCreator(e,t,s){var _this6=this;var a=xnm.aio.matterbridge.Bridge.MODE,o=xnm.aio.matterbridge.Bridge.STATE;if(this.state===o.DESTROYED)return void(s&&s(new Error("Instance has been destroyed.")));if(!t||!t.value)return void(s&&s(new Error("Command value is empty.")));this._latestCommand={cb:function cb(e,t){_this6._latestCommand=null,(e=_this6._getError(e,t))?(xnm.aio.matterbridge.logger.log("error","[excuteCommandCreator] (".concat(_this6.ip,") ")+e.message),s&&s(e)):s&&s(null,t.XC_SUC);}};var n={path:"/api/command",data:{id:parseInt(e.id,10),command:t.value}};void 0!==t.ext&&(n.data.value=t.ext),this.state===o.CONNECTED?this.mode===a.HTTP?this._doRequestHTTP(n.path,n.data,function(e,t){_this6._latestCommand&&_this6._latestCommand.cb(e,t);}):this._doRequest(n.path,n.data):this.state!==o.CONNECTING?(xnm.aio.matterbridge.logger.log("warn","[executeCommandCreator] (".concat(this.ip,") Bridge is not yet connected (state: \"").concat(this.state,"\"), trying to connect first.")),this.connect(function(e){e?s&&s(e):_this6.mode===a.HTTP?_this6._doRequestHTTP(n.path,n.data,function(e,t){_this6._latestCommand&&_this6._latestCommand.cb(e,t);}):_this6._doRequest(n.path,n.data);})):xnm.aio.matterbridge.logger.log("warn","[executeCommandCreator] (".concat(this.ip,") Bridge is not yet connected (state: \"").concat(this.state,"\"), cannot execute command."));}},{key:"getInfoHTTP",value:function getInfoHTTP(e){var _this7=this;var t=require("http"),s={host:this.ip,path:"/info",method:"GET",headers:{Connection:"close","Content-Type":"application/json"},rejectUnauthorized:!1};"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),xnm.aio.matterbridge.logger.log("debug","[getInfoHTTP] (".concat(this.ip,") Sending request..."));var a=t.request(s,function(t){var s="";t.setEncoding("utf-8"),t.on("data",function(e){s+=e;}),t.on("end",function(){var _o,_o2;var a=null,o=null;if(200==t.statusCode)try{o=s?JSON.parse(s):null;}catch(e){a=e;}else a=new Error("HTTP response: "+t.statusCode);!a&&(_o=o)!==null&&_o!==void 0&&_o.XC_ERR&&(a=new Error(JSON.stringify(o.XC_ERR))),e&&(e(a,(_o2=o)===null||_o2===void 0?void 0:_o2.XC_SUC),e=null);});});a.on&&a.on("error",function(t){xnm.aio.matterbridge.logger.log("error","[getInfoHTTP] (".concat(_this7.ip,") ")+t.message),e&&(e(t),e=null);}),a.setTimeout&&a.setTimeout(1e4,function(){xnm.aio.matterbridge.logger.log("error","[getInfoHTTP] (".concat(_this7.ip,") Timeout for request")),e&&(e(new Error("Timeout")),e=null);}),a.end();}},{key:"getStatesCreator",value:function getStatesCreator(e,t,s){var _this8=this;var a=xnm.aio.matterbridge.Bridge.MODE,o=xnm.aio.matterbridge.Bridge.STATE;if(this.state===o.DESTROYED)return void(s&&s(new Error("Instance has been destroyed.")));this._commandHandler=e,this._deviceList=this._deviceList||{},this._stateCache=this._stateCache||{},t.forEach(function(e){_this8._deviceList[e.id]=e;});var n=t||[],i=Date.now();var r=Date.now()-this._lastStatesSuccess;if(this._latestStatesRequest&&(i=this._latestStatesRequest.start,this._latestStatesRequest.deviceList.forEach(function(e){n.find(function(t){var _t$status,_e$status;return t.id==e.id&&((_t$status=t.status)===null||_t$status===void 0?void 0:_t$status.value)==((_e$status=e.status)===null||_e$status===void 0?void 0:_e$status.value);})||n.push(e);}),this._latestStatesRequest.deviceList=n,Date.now()-i<500))return;if(this._latestStatesRequest={start:i,deviceList:n,cb:function cb(e,t){var _this8$_latestStatesR;var a=((_this8$_latestStatesR=_this8._latestStatesRequest)===null||_this8$_latestStatesR===void 0?void 0:_this8$_latestStatesR.deviceList)||n;if(_this8._latestStatesRequest=null,e=_this8._getError(e,t))return xnm.aio.matterbridge.logger.log("error","[getStatesCreator] (".concat(_this8.ip,") ")+e.message),void(s&&s(e,[]));r>=500&&(_this8._lastStatesSuccess=Date.now());var o=t.XC_SUC,i=[];for(var _e9 in o)_this8._stateCache[_e9]=o[_e9];for(var _e10=0;_e10<a.length;_e10++){var _t8=a[_e10];if(!(_t8&&_t8.id&&_t8.device&&_t8.status))continue;var _s7=parseInt(_t8.device.id,10),_n=o[_s7]||_this8._stateCache[_s7];if(!_n)continue;var _r=_n[_t8.status.value];null!=_r&&i.push({id:_t8.id,status:_r});}s&&s(null,i);}},r<500)return xnm.aio.matterbridge.logger.log("debug","[getStatesCreator] Last response was ".concat(r,"ms ago. Answering from cache instead.")),void this._latestStatesRequest.cb(null,{XC_SUC:{}});var l="/api/states";this.state===o.CONNECTED?this.mode===a.HTTP?this._doRequestHTTP(l,null,function(e,t){_this8._latestStatesRequest&&_this8._latestStatesRequest.cb(e,t);}):this._doRequest(l):this.state!==o.CONNECTING?(xnm.aio.matterbridge.logger.log("warn","[getStatesCreator] (".concat(this.ip,") Bridge is not yet connected (state: \"").concat(this.state,"\"), trying to connect first.")),this.connect(function(e){e?s&&s(e):_this8.mode===a.HTTP?_this8._doRequestHTTP(l,null,function(e,t){_this8._latestStatesRequest&&_this8._latestStatesRequest.cb(e,t);}):_this8._doRequest(l);})):xnm.aio.matterbridge.logger.log("warn","[getStatesCreator] (".concat(this.ip,") Bridge is not yet connected (state: \"").concat(this.state,"\"), cannot get states."));}},{key:"getStatesCreatorHTTP",value:function getStatesCreatorHTTP(e,t,s){var _this9=this;this._commandHandler=e,this._deviceList=this._deviceList||{},t.forEach(function(e){_this9._deviceList[e.id]=e;}),this._doRequestHTTP("/api/states",null,function(e,a){if(e=_this9._getError(e,a))return xnm.aio.matterbridge.logger.log("error","[getStatesCreator] (".concat(_this9.ip,") ")+e.message),void(s&&s(e,[]));var o=a.XC_SUC,n=[];for(var _e11=0;_e11<t.length;_e11++){var _s8=t[_e11];if(!(_s8&&_s8.id&&_s8.device&&_s8.status))continue;var _a2=o[parseInt(_s8.device.id,10)];if(!_a2)continue;var i=_a2[_s8.status.value];null!=i&&n.push({id:_s8.id,status:i});}s&&s(null,n);});}}]);return _class2;}(),xnm.aio.matterbridge.DM={CAPABILITIES_GENERIC:{onoff:{commands:{on:{},off:{}},states:{state:{values:["on","off"]}}},toggle:{commands:{toggle:{}}},power:{states:{power:{type:"FLOAT"}}},current:{states:{current:{type:"FLOAT"}}},tilted:{states:{state:{values:["open","closed","tilted"]}}},stop:{commands:{stop:{}}},updown:{commands:{up:{},down:{}}},openclose:{commands:{open:{},close:{}}},step:{commands:{stepUp:{},stepDown:{}}},brightness:{commands:{brightness:{value:{type:"INT",min:0,max:100,step:1}}},states:{brightness:{type:"INT"}}},position:{commands:{position:{value:{type:"INT",min:0,max:100,step:1}}},states:{position:{type:"INT"}}},color:{commands:{color:{value:{type:"RGB"}}}},colortemperature:{commands:{colortemperature:{value:{type:"INT",min:0,max:100,step:1}}}},battery:{states:{battery:{type:"INT"}}},sabotage:{states:{sabotage:{type:"BOOL"}}},timeout:{states:{timeout:{type:"BOOL"}}},temperature:{states:{temperature:{type:"FLOAT"}}},humidity:{states:{humidity:{type:"INT"}}},co2:{states:{co2:{type:"INT"}}},water:{states:{water:{type:"BOOL"}}},illumination:{states:{illumination:{type:"INT"}}},speed:{states:{speed:{type:"FLOAT"}}},rain:{states:{rain:{type:"BOOL"}}},direction:{states:{direction:{values:["N","NO","O","SO","S","SW","W","NW"]}}}},CAPABILITIES_DEVICE:{aio:{"switch":{systems:{B4:{commands:{on:{},off:{}},states:{}},CR:{commands:{on:{},off:{}},states:{}},R2:{commands:{on:{},off:{}},states:{}},ENOCEAN:{commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]}},capabilities:["power"],subtypes:{TF:{commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]}}}}},EO:{commands:{on:{},off:{}},states:{}},FS:{commands:{on:{},off:{},toggle:{}},states:{}},HM:{commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]}},capabilities:["power","current"]},HMIP:{commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]}}},IT:{commands:{on:{},off:{},toggle:{}},states:{}},JL:{commands:{on:{},off:{}},states:{}},KN:{commands:{on:{},off:{}},states:{}},KP:{commands:{on:{},off:{}},states:{}},F3:{commands:{on:{},off:{}},states:{},capabilities:["onoff","toggle"]},NY:{commands:{on:{},off:{}},states:{}},PE:{commands:{on:{},off:{}},states:{},capabilities:["onoff","power"]},RTS:{commands:{on:{},off:{}},states:{state:{values:["on","off"]}}}}},light:{systems:{B4:{commands:{on:{},off:{}},states:{}},CR:{commands:{on:{},off:{}},states:{}},R2:{commands:{on:{},off:{}},states:{}},ENOCEAN:{commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]}},capabilities:["power"],subtypes:{TF:{commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]}}}}},EO:{commands:{on:{},off:{}},states:{}},FS:{commands:{on:{},off:{},toggle:{}},states:{}},HM:{commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]}},capabilities:["power","current"]},HMIP:{commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]}}},IT:{commands:{on:{},off:{},toggle:{}},states:{},capabilities:["brightness"]},JL:{commands:{on:{},off:{}},states:{}},KN:{commands:{on:{},off:{}},states:{}},KP:{commands:{on:{},off:{}},states:{}},F3:{commands:{on:{},off:{}},states:{},capabilities:["onoff","toggle"]},NY:{commands:{on:{},off:{}},states:{}},PE:{commands:{on:{},off:{}},states:{},capabilities:["onoff","power"]},RTS:{commands:{on:{},off:{}},states:{state:{values:["on","off"]}}}}},dimmer:{systems:{ENOCEAN:{commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100,step:1}},toggleTo:{value:{type:"INT",min:0,max:100,step:1}}},states:{state:{values:["on","off"]},brightness:{type:"INT"}}},FS:{commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100,step:10}},up:{},down:{}},states:{}},HM:{commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100,step:1}}},states:{state:{values:["on","off"]},brightness:{type:"INT"}}},HMIP:{commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100,step:1}}},states:{state:{values:["on","off"]},brightness:{type:"INT"}}},IT:{commands:{on:{},off:{},brightness:{value:{type:"INT",min:0,max:100,step:1}}},states:{}},KP:{commands:{on:{},off:{},brightness:{value:{type:"INT",min:0,max:100,step:1}}},states:{}}}},colorlight:{systems:{ENOCEAN:{commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100,step:1}},toggleTo:{value:{type:"INT",min:0,max:100,step:1}},color:{value:{type:"RGB"}}},states:{state:{values:["on","off"]},brightness:{type:"INT"}}},HMIP:{commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100,step:1}},hsv:{extended:{h:{value:{type:"INT",min:0,max:359}},s:{value:{type:"INT",min:0,max:100}},v:{value:{type:"INT",min:0,max:100}}}},color:{value:{type:"RGB"}}},states:{state:{values:["on","off"]},brightness:{type:"INT"},hsv:{type:"OBJECT"}}},CF3:{commands:{on:{},off:{},scene:{values:["1","2","3"]},brightness:{value:{type:"INT",min:0,max:100,step:1}},color:{value:{type:"RGB"}}},states:{}},CF4:{commands:{on:{},off:{},scene:{values:["1","2","3"]},brightness:{value:{type:"INT",min:0,max:100,step:1}},color:{value:{type:"RGB"}}},states:{}}}},heater:{systems:{B4:{commands:{day:{},night:{}},states:{}},ENOCEAN:{commands:{up:{},down:{},temperature:{value:{type:"FLOAT",min:5,max:30,step:.5}},mode:{values:["auto","manu","cent","limit"]}},states:{state:{type:"FLOAT"},temperature:{type:"FLOAT"},mode:{values:["auto","manu","cent","limit"]}}},HM:{commands:{up:{},down:{},temperature:{value:{type:"FLOAT",min:5,max:30,step:.5}},mode:{values:["auto","manu","boost"]}},states:{state:{type:"FLOAT"},temperature:{type:"FLOAT"},mode:{values:["auto","manu","boost"]},battery:{type:"INT"},error:{type:"STRING"}},events:["temperature"]},HMIP:{commands:{up:{},down:{},boostOff:{},temperature:{value:{type:"FLOAT",min:5,max:30,step:.5}},mode:{values:["manu","boost"]}},states:{state:{type:"FLOAT"},temperature:{type:"FLOAT"},mode:{values:["manu","boost"]},battery:{type:"INT"},error:{type:"STRING"}},events:["temperature"]}}},window:{systems:{ENOCEAN:{commands:{},states:{state:{values:["open","closed"]}},events:["state"]},HM:{commands:{},states:{state:{values:["open","closed"]}},events:["state"],subtypes:{"3way":{commands:{},states:{state:{values:["open","closed","tilted"]}},events:["state"]}}},HMIP:{commands:{},states:{state:{values:["open","closed"]}},events:["state"],subtypes:{"3way":{commands:{},states:{state:{values:["open","closed","tilted"]}},events:["state"]}}},IW:{commands:{},states:{state:{values:["open","closed","tilted"]},battery:{type:"INT"}},events:["state"]},IT:{commands:{},states:{state:{values:["open","closed"]}}}}},door:{systems:{ENOCEAN:{commands:{},states:{state:{values:["open","closed"]}},events:["state"]},HM:{commands:{},states:{state:{values:["open","closed"]}},events:["state"],subtypes:{"3way":{commands:{},states:{state:{values:["open","closed","tilted"]}},events:["state"]}}},HMIP:{commands:{},states:{state:{values:["open","closed"]}},events:["state"],subtypes:{"3way":{commands:{},states:{state:{values:["open","closed","tilted"]}},events:["state"]}}},IW:{commands:{},states:{state:{values:["open","closed","tilted"]},battery:{type:"INT"}},events:["state"]},IT:{commands:{},states:{state:{values:["open","closed"]}}}}},fan:{systems:{IN:{commands:{up:{},down:{},level:{value:{type:"INT",min:0,max:3}},mode:{values:["auto","turbo"]}},states:{state:{type:"INT"},mode:{values:["manu","auto","turbo"]},battery:{type:"INT"},filter:{type:"INT"},error:{type:"STRING"}}}}},shutter:{systems:{BK:{commands:{up:{},down:{},stop:{},stepUp:{},stepDown:{},position:{values:["1","2"]}},states:{}},R2:{commands:{up:{},down:{}},states:{},capabilities:["stop"]},DY:{commands:{up:{},down:{},stop:{},stepUp:{},stepDown:{}},states:{}},DY2:{commands:{up:{},down:{},stop:{},stepUp:{},stepDown:{},position:{value:{type:"INT",min:0,max:100},extended:{percent:{value:{type:"INT",min:0,max:100}}}}},states:{state:{type:"INT"}}},ER:{commands:{up:{},down:{},stop:{},stepUp:{},stepDown:{},silentUp:{},silentDown:{},position:{values:["air","shadow"]}},states:{state:{type:"INT"}}},ENOCEAN:{commands:{up:{},down:{},stop:{},stepUp:{},stepDown:{},position:{value:{type:"INT",min:0,max:100}}},states:{state:{type:"INT"}}},EO:{commands:{up:{},down:{}},states:{}},FS:{commands:{up:{},down:{}},states:{}},HU:{commands:{up:{},down:{}},states:{},capabilities:["stop"]},HM:{commands:{up:{},down:{},stop:{},position:{value:{type:"INT",min:0,max:100}}},states:{state:{type:"INT"}}},HMIP:{commands:{up:{},down:{},stop:{},position:{value:{type:"INT",min:0,max:100}}},states:{state:{type:"INT"}}},JL:{commands:{up:{},down:{},stop:{},position:{value:{type:"INT",min:0,max:100}},toggleStepMode:{},teachInActivate:{}},states:{state:{type:"INT"}},capabilities:["step"]},JM:{commands:{up:{},down:{},stop:{},position:{value:{type:"INT",min:0,max:100}},toggleStepMode:{},teachInActivate:{}},states:{state:{type:"INT"}},capabilities:["step"]},KN:{commands:{up:{},down:{}},states:{},capabilities:["stop"]},KP:{commands:{up:{},down:{}},states:{}},F3:{commands:{up:{},down:{}},states:{},capabilities:["stop","step"]},CL:{commands:{up:{},down:{},stop:{},stepUp:{},stepDown:{},position:{value:{type:"INT",min:0,max:100}}},states:{state:{type:"INT"}},subtypes:{tdbu:{commands:{up:{},down:{},stop:{},stepUp:{},stepDown:{},position:{value:{type:"INT",min:0,max:100},extended:{top:{value:{type:"INT",min:0,max:100}},bottom:{value:{type:"INT",min:0,max:100}}}}},states:{top:{type:"INT"},bottom:{type:"INT"}}}}},NY:{commands:{up:{},down:{},stop:{},position:{value:{type:"INT",min:0,max:100}}},states:{state:{type:"INT"}}},N2:{commands:{up:{},down:{},stop:{},position:{value:{type:"INT",min:0,max:100}}},states:{state:{type:"INT"}}},FX3:{commands:{up:{},down:{}},states:{},capabilities:["stop"]},SL:{commands:{up:{},down:{}},states:{},capabilities:["step"]},RT:{commands:{up:{},down:{}},states:{},capabilities:["stop","step"]},RTS:{commands:{up:{},down:{},stop:{},position:{value:{type:"INT",min:0,max:100}}},states:{state:{type:"INT"}}},WA:{commands:{up:{},down:{}},states:{},capabilities:["stop","step"]},WR:{commands:{up:{},down:{}},states:{},capabilities:["stop","position"]}}},blind:{systems:{HU:{commands:{up:{},down:{}},states:{},capabilities:["stop","step"]},HM:{commands:{up:{},down:{},stop:{},position:{value:{type:"INT",min:0,max:100},extended:{percent:{value:{type:"INT",min:0,max:100}},lamella:{value:{type:"INT",optional:!0,min:0,max:100}}}},lamella:{value:{type:"INT",min:0,max:100}}},states:{state:{type:"INT"},lamella:{type:"INT"}}},HMIP:{commands:{up:{},down:{},stop:{},position:{value:{type:"INT",min:0,max:100},extended:{percent:{value:{type:"INT",min:0,max:100}},lamella:{value:{type:"INT",optional:!0,min:0,max:100}}}},lamella:{value:{type:"INT",min:0,max:100}}},states:{state:{type:"INT"},lamella:{type:"INT"}}},IN:{commands:{up:{},down:{},stop:{},scene:{value:{type:"INT",min:0,max:8}},position:{value:{type:"INT",min:0,max:100},extended:{percent:{value:{type:"INT",min:0,max:100}},lamella:{value:{type:"INT",optional:!0,min:0,max:100}}}},lamella:{value:{type:"INT",min:0,max:100}}},states:{state:{type:"INT"},lamella:{type:"INT"},battery:{type:"INT"},error:{type:"STRING"}}},JL:{commands:{up:{},down:{},stop:{},position:{value:{type:"INT",min:0,max:100},extended:{percent:{value:{type:"INT",min:0,max:100}},lamella:{value:{type:"INT",optional:!0,min:0,max:100}}}},toggleStepMode:{},teachInActivate:{},lamella:{value:{type:"INT",min:0,max:100}}},states:{state:{type:"INT"},lamella:{type:"INT"}},capabilities:["step"]},JM:{commands:{up:{},down:{},stop:{},position:{value:{type:"INT",min:0,max:100},extended:{percent:{value:{type:"INT",min:0,max:100}},lamella:{value:{type:"INT",optional:!0,min:0,max:100}}}},toggleStepMode:{},teachInActivate:{},lamella:{value:{type:"INT",min:0,max:100}}},states:{state:{type:"INT"},lamella:{type:"INT"}},capabilities:["step"]},CL:{commands:{up:{},down:{},stop:{},stepUp:{},stepDown:{},position:{value:{type:"INT",min:0,max:100}},lamella:{value:{type:"INT",min:0,max:100}}},states:{state:{type:"INT"},lamella:{type:"INT"}}},RTS:{commands:{up:{},down:{},stop:{},position:{value:{type:"INT",min:0,max:100},extended:{percent:{value:{type:"INT",min:0,max:100}},lamella:{value:{type:"INT",optional:!0,min:0,max:100}}}},lamella:{value:{type:"INT",min:0,max:100}}},states:{state:{type:"INT"},lamella:{type:"INT"}},capabilities:["step"]}}},awning:{systems:{JL:{commands:{open:{},close:{},stop:{},position:{value:{type:"INT",min:0,max:100}},toggleStepMode:{},teachInActivate:{}},states:{state:{type:"INT"}}},JM:{commands:{open:{},close:{},stop:{},position:{value:{type:"INT",min:0,max:100}},toggleStepMode:{},teachInActivate:{}},states:{state:{type:"INT"}}},RTS:{commands:{open:{},close:{},stop:{},position:{value:{type:"INT",min:0,max:100}}},states:{state:{type:"INT"}}}}},sensor:{systems:{HM:{subtypes:{illumination:{commands:{},states:{},capabilities:["illumination"]},weather:{commands:{},states:{},capabilities:["temperature","humidity","speed","rain","direction"],events:["temperature"]}}},HMIP:{subtypes:{water:{commands:{},states:{battery:{type:"INT"},water:{type:"BOOL"},sabotage:{type:"BOOL"},timeout:{type:"BOOL"}}}}}}},doorlock:{systems:{HMIP:{commands:{lock:{},unlock:{},open:{}},states:{state:{values:["locked","unlocked"]},battery:{type:"INT"}}}}},button:{systems:{HMIP:{subtypes:{button2:{commands:{},states:{button1:{values:["shortPress","longPress"]},button2:{values:["shortPress","longPress"]}},events:["button1","button2"]},button4:{commands:{},states:{button1:{values:["shortPress","longPress"]},button2:{values:["shortPress","longPress"]},button3:{values:["shortPress","longPress"]},button4:{values:["shortPress","longPress"]}},events:["button1","button2","button3","button4"]},button6:{commands:{},states:{button1:{values:["shortPress","longPress"]},button2:{values:["shortPress","longPress"]},button3:{values:["shortPress","longPress"]},button4:{values:["shortPress","longPress"]},button5:{values:["shortPress","longPress"]},button6:{values:["shortPress","longPress"]}},events:["button1","button2","button3","button4","button5","button6"]},button8:{commands:{},states:{button1:{values:["shortPress","longPress"]},button2:{values:["shortPress","longPress"]},button3:{values:["shortPress","longPress"]},button4:{values:["shortPress","longPress"]},button5:{values:["shortPress","longPress"]},button6:{values:["shortPress","longPress"]},button7:{values:["shortPress","longPress"]},button8:{values:["shortPress","longPress"]}},events:["button1","button2","button3","button4","button5","button6","button7","button8"]}}},ENOCEAN:{subtypes:{eltako2:{commands:{},states:{buttonAI:{values:["pressed","released"]},buttonAO:{values:["pressed","released"]}},events:["buttonAI","buttonAO"]},eltako4:{commands:{},states:{buttonAI:{values:["pressed","released"]},buttonAO:{values:["pressed","released"]},buttonBI:{values:["pressed","released"]},buttonBO:{values:["pressed","released"]}},events:["buttonAI","buttonAO","buttonBI","buttonBO"]}}}}}},fritz:{"switch":{commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]},power:{type:"FLOAT"}}},colorlight:{commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100,step:1}},color:{value:{type:"RGB"}}},states:{state:{values:["on","off"]},brightness:{type:"INT"}}},heater:{commands:{temperature:{value:{type:"FLOAT",min:8,max:28,step:.5}}},states:{state:{type:"STRING"},temperature:{type:"FLOAT"},battery:{type:"INT"}}},shutter:{commands:{up:{},down:{},stop:{},position:{value:{type:"INT",min:0,max:100}}},states:{state:{type:"INT"}}},temperature:{commands:{},states:{state:{type:"FLOAT"},battery:{type:"INT"}}}},junghome:{"switch":{commands:{on:{},off:{}},states:{state:{values:["on","off"]}}},light:{commands:{on:{},off:{}},states:{state:{values:["on","off"]}}},dimmer:{commands:{on:{},off:{},brightness:{value:{type:"INT",min:0,max:100,step:1}}},states:{state:{values:["on","off"]},brightness:{type:"INT"}}},heater:{commands:{temperature:{value:{type:"FLOAT",min:5,max:30,step:1}},mode:{values:["auto","manu"]},presetMode:{values:["none","frost","eco","comfort"]}},states:{state:{type:"FLOAT"},mode:{values:["auto","manu"]},presetMode:{values:["none","frost","eco","comfort"]}}},shutter:{commands:{up:{},down:{},stop:{},position:{value:{type:"INT",min:0,max:100}}},states:{state:{type:"INT"}}},blind:{commands:{up:{},down:{},stop:{},position:{value:{type:"INT",min:0,max:100},extended:{percent:{value:{type:"INT",min:0,max:100}},lamella:{value:{type:"INT",optional:!0,min:0,max:100}}}},lamella:{value:{type:"INT",min:0,max:100}}},states:{state:{type:"INT"},lamella:{type:"INT"}}}},knx:{"switch":{commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]}}},light:{commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]}}},dimmer:{commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100,step:1}}},states:{state:{values:["on","off"]},brightness:{type:"INT"}}},shutter:{commands:{up:{},down:{},stop:{},position:{value:{type:"INT",min:0,max:100}}},states:{state:{type:"INT"}}},blind:{commands:{up:{},down:{},stop:{},position:{value:{type:"INT",min:0,max:100},extended:{percent:{value:{type:"INT",min:0,max:100}},lamella:{value:{type:"INT",optional:!0,min:0,max:100}}}},lamella:{value:{type:"INT",min:0,max:100}}},states:{state:{type:"INT"},lamella:{type:"INT"}}}},shelly:{"switch":{commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]}},capabilities:["power"]},light:{commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]}},capabilities:["power"],subtypes:{rgbw:{commands:{on:{},off:{},toggle:{},color:{value:{type:"RGB(W)"}},white:{value:{type:"INT",min:0,max:100,step:1}},brightness:{value:{type:"INT",min:0,max:100,step:1}}},states:{state:{values:["on","off"]},brightness:{type:"INT"}}},wwww:{commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100,step:1}}},states:{state:{values:["on","off"]},brightness:{type:"INT"}}}}},dimmer:{commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100,step:1}}},states:{state:{values:["on","off"]},brightness:{type:"INT"},power:{type:"FLOAT"}}},shutter:{commands:{up:{},down:{},stop:{},position:{value:{type:"INT",min:0,max:100}}},states:{state:{type:"INT"}}}},nanoleaf:{light:{commands:{on:{},off:{},scene:{value:{type:"STRING"}},brightness:{value:{type:"INT",min:0,max:100,step:1}},color:{value:{type:"RGB"}}},states:{state:{values:["on","off"]},brightness:{type:"INT"}}}},hue:{light:{commands:{on:{},off:{},alert:{values:["none","select","lselect"]},alarm:{extended:{time:{value:{type:"INT",min:15,max:300,step:1,unit:"seconds"}}}},brightness:{value:{type:"INT",min:0,max:100,step:1}}},states:{state:{values:["on","off"]},brightness:{type:"INT"}}},colorlight:{commands:{on:{},off:{},alert:{values:["none","select","lselect"]},alarm:{extended:{time:{value:{type:"INT",min:15,max:300,step:1,unit:"seconds"}}}},brightness:{value:{type:"INT",min:0,max:100,step:1}},color:{value:{type:"RGB"}}},states:{state:{values:["on","off"]},brightness:{type:"INT"}}}},mhome:{light:{commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100,step:1}},color:{value:{type:"RGB"}}},states:{state:{values:["on","off"]},brightness:{type:"INT"}},subtypes:{rgbw:{commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100,step:1}},color:{value:{type:"RGB(W)"}},white:{value:{type:"INT",min:0,max:100,step:1}}},states:{state:{values:["on","off"]},brightness:{type:"INT"}}}}}},alpha:{heater:{commands:{temperature:{value:{type:"FLOAT",min:5,max:30,step:.2}},mode:{values:["auto","day","night"]},weekday:{value:{type:"INT",min:0,max:3,step:1}},weekend:{value:{type:"INT",min:0,max:3,step:1}},disableVacation:{},vacation:{extended:{start:{value:{type:"DATE"}},end:{value:{type:"DATE"}}}}},states:{state:{type:"FLOAT"},temperature:{type:"FLOAT"},mode:{values:["auto","day","night"]},battery:{type:"INT"},signal:{type:"INT"},weekday:{type:"INT"},weekend:{type:"INT"},party:{type:"INT"},vacation:{type:"INT"}}}},sonos:{speaker:{commands:{play:{value:{type:"STRING",optional:!0}},pause:{},stop:{},previous:{},next:{},mute:{},unmute:{},volume:{value:{type:"INT",min:0,max:100,step:1}},alarm:{extended:{file:{value:{type:"STRING"}},volume:{value:{type:"INT",min:0,max:100,step:1}},time:{value:{type:"INT",min:1,max:300,step:1,unit:"seconds"}}}}},states:{state:{values:["playing","paused"]},volume:{type:"INT"},muted:{type:"BOOL"}}}},hautau:{window:{subtypes:{drive:{commands:{open:{},close:{},stop:{}},states:{state:{values:["open","closed","partly_open"]},blocked:{type:"BOOL"}},models:{comfort:{commands:{open:{},close:{},stop:{}},states:{state:{values:["open","closed","partly_open"]},blocked:{type:"BOOL"},cycles:{type:"INT"}}}}},ska20cd:{commands:{open:{},close:{},stop:{}},states:{state:{values:["open","closed","partly_open"]},blocked:{type:"BOOL"}}},hscd:{commands:{open:{},close:{},stop:{},lock:{},unlock:{}},states:{state:{values:["open","closed","partly_open"]},locked:{type:"BOOL"},down:{type:"BOOL"}},models:{internorm:{commands:{open:{},close:{},stop:{},lock:{},unlock:{}},states:{state:{values:["open","closed","partly_open"]},locked:{type:"BOOL"},down:{type:"BOOL"},position:{type:"INT"},cycles:{type:"INT"}}}}}}},door:{subtypes:{drive:{commands:{open:{},close:{},stop:{}},states:{state:{values:["open","closed","partly_open"]},blocked:{type:"BOOL"}},models:{comfort:{commands:{open:{},close:{},stop:{}},states:{state:{values:["open","closed","partly_open"]},blocked:{type:"BOOL"},cycles:{type:"INT"}}}}},ska20cd:{commands:{open:{},close:{},stop:{}},states:{state:{values:["open","closed","partly_open"]},blocked:{type:"BOOL"}}},hscd:{commands:{open:{},close:{},stop:{},lock:{},unlock:{}},states:{state:{values:["open","closed","partly_open"]},locked:{type:"BOOL"},down:{type:"BOOL"}},models:{internorm:{commands:{open:{},close:{},stop:{},lock:{},unlock:{}},states:{state:{values:["open","closed","partly_open"]},locked:{type:"BOOL"},down:{type:"BOOL"},position:{type:"INT"},cycles:{type:"INT"}}}}}}},fan:{subtypes:{ventra:{commands:{up:{},down:{},level:{value:{type:"INT",min:0,max:4}},enableKeys:{},disableKeys:{}},states:{state:{type:"INT"},keys:{type:"BOOL"},filter:{type:"INT"},change:{type:"BOOL"},runtime:{type:"STRING"},error:{type:"STRING"}},models:{105:{commands:{up:{},down:{},level:{value:{type:"INT",min:0,max:5}},enableKeys:{},disableKeys:{}},states:{state:{type:"INT"},keys:{type:"BOOL"},filter:{type:"INT"},change:{type:"BOOL"},runtime:{type:"STRING"},error:{type:"STRING"},temperature:{type:"FLOAT"},humidity:{type:"INT"}}}}}}},temperature:{subtypes:{multisensor:{commands:{},states:{state:{type:"FLOAT"},humidity:{type:"INT"},co2:{type:"INT"}}}}}},siegenia:{window:{subtypes:{geniusB:{commands:{open:{value:{type:"INT",min:1,max:720},extended:{wing:{optional:!0,values:["1","2"]},duration:{optional:!0,value:{type:"INT",min:1,max:720}}}},close:{extended:{wing:{optional:!0,values:["1","2"]}}},stop:{extended:{wing:{optional:!0,values:["1","2"]}}},lock:{},enableTimer:{value:{type:"INT",min:1,max:720}},disableTimer:{},mode:{values:["day","night"]},position:{values:["1","2"],extended:{value:{values:["1","2"]},duration:{optional:!0,value:{type:"INT",min:1,max:720}}}}},states:{state:{values:["open","closed","tilted","partly_open"]},wing1:{values:["open","closed","tilted","partly_open"]},wing2:{values:["open","closed","tilted","partly_open"]},locked:{type:"BOOL"},timer:{type:"BOOL"},time:{type:"INT"},mode:{values:["day","night"]}}},axxentDK:{commands:{open:{value:{type:"INT",min:1,max:720},extended:{wing:{optional:!0,values:["1","2"]},duration:{optional:!0,value:{type:"INT",min:1,max:720}}}},close:{extended:{wing:{optional:!0,values:["1","2"]}}},stop:{extended:{wing:{optional:!0,values:["1","2"]}}},lock:{},enableTimer:{value:{type:"INT",min:1,max:720}},disableTimer:{},mode:{values:["day","night"]},position:{values:["1","2"],extended:{value:{values:["1","2"]},duration:{optional:!0,value:{type:"INT",min:1,max:720}}}}},states:{state:{values:["open","closed","tilted","partly_open"]},wing1:{values:["open","closed","tilted","partly_open"]},wing2:{values:["open","closed","tilted","partly_open"]},locked:{type:"BOOL"},timer:{type:"BOOL"},time:{type:"INT"},mode:{values:["day","night"]}}},axxentHSA:{commands:{open:{value:{type:"INT",min:1,max:720},extended:{wing:{optional:!0,values:["1","2"]},duration:{optional:!0,value:{type:"INT",min:1,max:720}}}},close:{extended:{wing:{optional:!0,values:["1","2"]}}},stop:{extended:{wing:{optional:!0,values:["1","2"]}}},lock:{},enableTimer:{value:{type:"INT",min:1,max:720}},disableTimer:{},mode:{values:["day","night"]},position:{values:["1","2"],extended:{value:{values:["1","2"]},duration:{optional:!0,value:{type:"INT",min:1,max:720}}}}},states:{state:{values:["open","closed","tilted","partly_open"]},wing1:{values:["open","closed","tilted","partly_open"]},wing2:{values:["open","closed","tilted","partly_open"]},locked:{type:"BOOL"},timer:{type:"BOOL"},time:{type:"INT"},mode:{values:["day","night"]}}},axxentHSA2:{commands:{open:{value:{type:"INT",min:1,max:720},extended:{wing:{optional:!0,values:["1","2"]},duration:{optional:!0,value:{type:"INT",min:1,max:720}}}},close:{extended:{wing:{optional:!0,values:["1","2"]}}},stop:{extended:{wing:{optional:!0,values:["1","2"]}}},lock:{},enableTimer:{value:{type:"INT",min:1,max:720}},disableTimer:{},mode:{values:["day","night"]},position:{values:["1","2"],extended:{value:{values:["1","2"]},duration:{optional:!0,value:{type:"INT",min:1,max:720}}}}},states:{state:{values:["open","closed","tilted","partly_open"]},wing1:{values:["open","closed","tilted","partly_open"]},wing2:{values:["open","closed","tilted","partly_open"]},locked:{type:"BOOL"},timer:{type:"BOOL"},time:{type:"INT"},mode:{values:["day","night"]}}}}},door:{subtypes:{geniusB:{commands:{open:{value:{type:"INT",min:1,max:720},extended:{wing:{optional:!0,values:["1","2"]},duration:{optional:!0,value:{type:"INT",min:1,max:720}}}},close:{extended:{wing:{optional:!0,values:["1","2"]}}},stop:{extended:{wing:{optional:!0,values:["1","2"]}}},lock:{},enableTimer:{value:{type:"INT",min:1,max:720}},disableTimer:{},mode:{values:["day","night"]},position:{values:["1","2"],extended:{value:{values:["1","2"]},duration:{optional:!0,value:{type:"INT",min:1,max:720}}}}},states:{state:{values:["open","closed","tilted","partly_open"]},wing1:{values:["open","closed","tilted","partly_open"]},wing2:{values:["open","closed","tilted","partly_open"]},locked:{type:"BOOL"},timer:{type:"BOOL"},time:{type:"INT"},mode:{values:["day","night"]}}},axxentDK:{commands:{open:{value:{type:"INT",min:1,max:720},extended:{wing:{optional:!0,values:["1","2"]},duration:{optional:!0,value:{type:"INT",min:1,max:720}}}},close:{extended:{wing:{optional:!0,values:["1","2"]}}},stop:{extended:{wing:{optional:!0,values:["1","2"]}}},lock:{},enableTimer:{value:{type:"INT",min:1,max:720}},disableTimer:{},mode:{values:["day","night"]},position:{values:["1","2"],extended:{value:{values:["1","2"]},duration:{optional:!0,value:{type:"INT",min:1,max:720}}}}},states:{state:{values:["open","closed","tilted","partly_open"]},wing1:{values:["open","closed","tilted","partly_open"]},wing2:{values:["open","closed","tilted","partly_open"]},locked:{type:"BOOL"},timer:{type:"BOOL"},time:{type:"INT"},mode:{values:["day","night"]}}},axxentHSA:{commands:{open:{value:{type:"INT",min:1,max:720},extended:{wing:{optional:!0,values:["1","2"]},duration:{optional:!0,value:{type:"INT",min:1,max:720}}}},close:{extended:{wing:{optional:!0,values:["1","2"]}}},stop:{extended:{wing:{optional:!0,values:["1","2"]}}},lock:{},enableTimer:{value:{type:"INT",min:1,max:720}},disableTimer:{},mode:{values:["day","night"]},position:{values:["1","2"],extended:{value:{values:["1","2"]},duration:{optional:!0,value:{type:"INT",min:1,max:720}}}}},states:{state:{values:["open","closed","tilted","partly_open"]},wing1:{values:["open","closed","tilted","partly_open"]},wing2:{values:["open","closed","tilted","partly_open"]},locked:{type:"BOOL"},timer:{type:"BOOL"},time:{type:"INT"},mode:{values:["day","night"]}}},axxentHSA2:{commands:{open:{value:{type:"INT",min:1,max:720},extended:{wing:{optional:!0,values:["1","2"]},duration:{optional:!0,value:{type:"INT",min:1,max:720}}}},close:{extended:{wing:{optional:!0,values:["1","2"]}}},stop:{extended:{wing:{optional:!0,values:["1","2"]}}},lock:{},enableTimer:{value:{type:"INT",min:1,max:720}},disableTimer:{},mode:{values:["day","night"]},position:{values:["1","2"],extended:{value:{values:["1","2"]},duration:{optional:!0,value:{type:"INT",min:1,max:720}}}}},states:{state:{values:["open","closed","tilted","partly_open"]},wing1:{values:["open","closed","tilted","partly_open"]},wing2:{values:["open","closed","tilted","partly_open"]},locked:{type:"BOOL"},timer:{type:"BOOL"},time:{type:"INT"},mode:{values:["day","night"]}}}}},fan:{subtypes:{aeropac:{commands:{on:{value:{type:"INT",min:1,max:720}},off:{},enableTimer:{value:{type:"INT",min:1,max:720}},disableTimer:{},enableEco:{value:{type:"INT",min:1,max:720}},disableEco:{},mode:{values:["auto","manu"]},level:{value:{type:"INT",min:0,max:100},extended:{value:{type:"INT",min:0,max:100},duration:{optional:!0,value:{type:"INT",min:1,max:720}}}}},states:{state:{type:"INT"},power:{values:["on","off"]},temperature:{type:"FLOAT"},temperature2:{type:"FLOAT"},humidity:{type:"INT"},humidity2:{type:"INT"},mode:{values:["auto","manu"]},eco:{type:"BOOL"},airquality:{type:"INT"},time:{type:"INT"}}},aerovital:{commands:{on:{value:{type:"INT",min:1,max:720}},off:{},enableTimer:{value:{type:"INT",min:1,max:720}},disableTimer:{},enableEco:{value:{type:"INT",min:1,max:720}},disableEco:{},mode:{values:["auto","manu"]},level:{value:{type:"INT",min:0,max:100},extended:{value:{type:"INT",min:0,max:100},duration:{optional:!0,value:{type:"INT",min:1,max:720}}}}},states:{state:{type:"INT"},power:{values:["on","off"]},temperature:{type:"FLOAT"},temperature2:{type:"FLOAT"},humidity:{type:"INT"},humidity2:{type:"INT"},mode:{values:["auto","manu"]},eco:{type:"BOOL"},airquality:{type:"INT"},time:{type:"INT"}}},aerotube:{commands:{on:{value:{type:"INT",min:1,max:720}},off:{},enableTimer:{value:{type:"INT",min:1,max:720}},disableTimer:{},enableEco:{value:{type:"INT",min:1,max:720}},disableEco:{},mode:{values:["auto","manu"]},level:{value:{type:"INT",min:0,max:100},extended:{value:{type:"INT",min:0,max:100},duration:{optional:!0,value:{type:"INT",min:1,max:720}}}}},states:{state:{type:"INT"},power:{values:["on","off"]},temperature:{type:"FLOAT"},temperature2:{type:"FLOAT"},humidity:{type:"INT"},humidity2:{type:"INT"},mode:{values:["auto","manu"]},eco:{type:"BOOL"},airquality:{type:"INT"},time:{type:"INT"}}}}}},gealan:{fan:{commands:{on:{},off:{},up:{},down:{},mode:{values:["auto","manu"]},level:{value:{type:"INT",min:0,max:5}}},states:{state:{type:"INT"},mode:{values:["manu","auto","night_in","night_out","flap_closed","frost_protection"]},sleep:{type:"BOOL"},temperature:{type:"FLOAT"},humidity:{type:"INT"},temperature2:{type:"FLOAT"},humidity2:{type:"INT"},filter:{type:"INT"},error:{type:"STRING"}}}},winkhaus:{doorlock:{subtypes:{eav:{commands:{unlock:{}},states:{state:{values:["open","closed","nocontact"]},locked:{type:"BOOL"}}},bm:{commands:{unlock:{},mode:{values:["day","night"]}},states:{state:{values:["open","closed","nocontact"]},locked:{type:"BOOL"},mode:{values:["day","night"]}}}}}}},SYS:"matterbridge",_buildCommand:function _buildCommand(e,t){if("string"!=typeof e&&"object"==_typeof(t)&&t)return null;var s={type:"enum",name:e,ref:{value:e}};if(t.value){switch(t.value.type){case"BOOL":s.ref.ext="%e",s.ref.extMeta=["true","false"];break;case"FLOAT":s.type="float",s.ref.ext="%f";break;case"INT":s.type="int",s.ref.ext="%d";break;case"RGB":s.type="rgb",s.ref.ext="%rgb";break;case"STRING":s.type="string",s.ref.ext="%s";}"number"==typeof t.value.min&&"number"==typeof t.value.max&&(s.ref.extMeta="".concat(t.value.min,"-").concat(t.value.max)),t.value.unit&&(s.ref.unit=t.value.unit);}if(Array.isArray(t.values)&&(s.ref.ext="%e",s.ref.extMeta=t.values),t.extended){s.type="multi",s.ref.ext="%multi",s.ref.extMeta=[];for(var _e12 in t.extended){var a=t.extended[_e12],o=this._buildCommand(_e12,a);o&&s.ref.extMeta.push(o);}}return s;},_buildStatus:function _buildStatus(e,t){if("string"!=typeof e&&"object"==_typeof(t)&&t)return null;var s={type:"enum",name:e,ref:{value:e}};switch(t.type){case"BOOL":s.ref.options=["true","false"];break;case"FLOAT":s.type="float";break;case"INT":s.type="int";break;case"RGB":s.type="rgb";break;case"STRING":s.type="string";}return Array.isArray(t.values)&&(s.ref.options=t.values),"number"==typeof t.min&&"number"==typeof t.max&&(s.ref.extMeta="".concat(t.min,"-").concat(t.max)),s;},_extendWithCapability:function _extendWithCapability(e,t,s){"string"==typeof t&&(t=t.toLowerCase());var a=s||this.CAPABILITIES_GENERIC[t];if(!a)return;a=JSON.parse(JSON.stringify(a));var o=function o(t,s){e[t]=e[t]||[],e[t].find(function(e){var _e$ref;return((_e$ref=e.ref)===null||_e$ref===void 0?void 0:_e$ref.value)===s.ref.value;})||e[t].push(s);};a.commands=a.commands||{},a.states=a.states||{};for(var _e13 in a.commands){var _t9=a.commands[_e13],_s9=this._buildCommand(_e13,_t9);_s9&&o("command",_s9);}for(var _e14 in a.states){var _t10=a.states[_e14],_s10=this._buildStatus(_e14,_t10);_s10&&o("status",_s10);}},_setBaseCapabilities:function _setBaseCapabilities(e,t){var _a$t$type,_this10=this;if(!t.type||!t.device_sys)return void xnm.aio.matterbridge.logger.log("warn","[_setBaseCapabilities] Missing device type or system: "+JSON.stringify(t));var s=t.mod||"aio";var a=this.CAPABILITIES_DEVICE[s];if(!a||!((_a$t$type=a[t.type])!==null&&_a$t$type!==void 0&&_a$t$type.systems))return;var o=a[t.type].systems,n=t.device_sys;if(a=o[n],"GN"===n&&t.subsys&&(a=o[t.subsys]||a),a){if(a.subtypes){var _e15=t.subtype;_e15||"aio"!==s||(_e15=t.device_sys),_e15&&a.subtypes[_e15]&&(a=a.subtypes[_e15],a.models&&t.model&&(a=a.models[t.model]||a));}this._extendWithCapability(e,null,a),Array.isArray(a.capabilities)&&a.capabilities.forEach(function(t){_this10._extendWithCapability(e,t);});}},applyIPEventFilter:function applyIPEventFilter(e,t){if(!e.sys)return null;var s=this.getCommandStatusMap(e);if(!s)return null;var a=JSON.parse(JSON.stringify(e));return a.ipevt=s.ipevt,a;},applyUIFilter:function applyUIFilter(e,t,s){if(!e.sys)return null;var a=function a(e,t){if("*"===e||"*"===e[0])return!0;for(var s=0;s<e.length;s++)if(e[s]==t)return!0;return!1;},o=function o(e,t){var o=[],n=null,i=xnm.aio.matterbridge.DM.getCommandStatusMap(e,s);return i&&(n=function(e,t,s){var o=[];switch(s.catagory){case"command":e.command&&e.command.forEach(function(e){if(a(s.elems,e.type)){var t=JSON.parse(JSON.stringify(e));o.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(a(s.elems,e.type)){var t=JSON.parse(JSON.stringify(e));o.push(t);}});}return o;}(i,0,t),o=o.concat(n)),o;},n=JSON.parse(JSON.stringify(e)),i=null;switch(t.catagory){case"command":i=o(e,t),n.command=i;break;case"status":i=o(e,t),n.status=i;break;default:return null;}return i&&0!=i.length?n:null;},createDevice:function createDevice(e,t,s){s(null,e);},createGateway:function createGateway(e,t,s){var a=xnm.aio.matterbridge.DM;e?e.ip?new xnm.aio.matterbridge.Bridge(e).getInfoHTTP(function(t,o){t?s(t):(o&&(e.home=o.home,e.hwv=o.hwv,e.id=o.id,e.mac=o.mac,e.mfv=o.mfv,e.mhv=o.mhv,e.msv=o.msv,e.pt=o.pt,e.systems=o.sys),e.id?s(null,e):s(new a.Error(a.Error.ERROR_CODE.INVALID,"ID (serial number) is missing")));}):s(new a.Error(a.Error.ERROR_CODE.INVALID,"IP is missing")):s(new a.Error(a.Error.ERROR_CODE.INVALID,"info is missing"));},deleteDevice:function deleteDevice(e,t,s){s&&s();},deleteGateway:function deleteGateway(e,t,s){s&&s();},getCommandStatusMap:function getCommandStatusMap(e,t){var _this11=this;var s={command:[],status:[]};return this._setBaseCapabilities(s,e),Array.isArray(e.capabilities)&&e.capabilities.forEach(function(e){_this11._extendWithCapability(s,e);}),s;},getGatewayType:function getGatewayType(){return[{sys:xnm.aio.matterbridge.DM.SYS,name:"Matter Bridge"}];},supportSmartWidget:function supportSmartWidget(e){return!(!e||!e.type)&&"unknown"!==e.type;},applySmartWidgetFilter:function applySmartWidgetFilter(e,t,s,a,o){if(!t)return null;var n=this.getCommandStatusMap(t);if(!n)return null;var i={},r={};(n.command||[]).forEach(function(e){var t=e.ref.value;i["%".concat(t,"%")]=e.ref,"brightness"===t?i["%dimTo%"]=e.ref:"on"===t?i["%dimOn%"]=e.ref:"off"===t&&(i["%dimOff%"]=e.ref);}),(n.status||[]).forEach(function(e){var s=e.ref.value;r["%".concat(s,"%")]=e.ref,"state"===s?"roller_blind"===t.type?r["%blindState%"]=e.ref:"heater"===t.type||"temperature"===t.type?r["%tempState%"]=e.ref:"dimmer"!==t.type&&(r["%".concat(t.type,"State%")]=e.ref):"brightness"===s?r["%dimmerState%"]=e.ref:r["%".concat(s,"State%")]=e.ref;});var l=[];return"dimmer"===t.type?l.push("dimmer","light","switch"):"colorlight"===t.type?l.push("rgb","dimmer","light","switch"):["light","switch"].includes(t.type)?l.push("light","switch"):["awning","blind","roller_blind","shutter"].includes(t.type)?l.push("awning","blind","shutter"):["heater","temperature"].includes(t.type)?l.push("thermostat"):"water"===t.type?l.push("sensor_"+t.type):l.push(t.type),e._injectToSmartWidgetTemplate(a,l,o,i,r);},toGeneralDevice:function toGeneralDevice(e){var t=xnm.aio.matterbridge.parseJSON(e);return t&&"function"==typeof t.toGeneralDevice?t.toGeneralDevice():null;},updateDevice:function updateDevice(e,t,s){s(null,e);},updateGateway:function updateGateway(e,t,s,a){var o=xnm.aio.matterbridge.DM;t?t.id?t.ip?a(null,t):a(new o.Error(o.Error.ERROR_CODE.INVALID,"IP is missing")):a(new o.Error(o.Error.ERROR_CODE.INVALID,"ID (serial number) is missing")):a(new o.Error(o.Error.ERROR_CODE.INVALID,"info is missing"));}},xnm.aio.matterbridge.DM.Error=function(e,t){this.code=e,this.message=t,this.stack=new Error().stack;},xnm.aio.matterbridge.DM.Error.prototype=new Error(),xnm.aio.matterbridge.DM.Error.prototype.name="MatterBridgeDMError",xnm.aio.matterbridge.DM.Error.prototype.code=0,xnm.aio.matterbridge.DM.Error.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,INVALID:2,UNKNOWN:3,NOT_FOUND:4,IP_EXISTS:5},xnm.aio.matterbridge.Handler=/*#__PURE__*/function(){function _class3(){_classCallCheck(this,_class3);this.devicemanager=xnm.aio.matterbridge.DM,this.Bridge=xnm.aio.matterbridge.Bridge,this._bridgeCache={};var e=require("x.logger.js");e&&(xnm.aio.matterbridge.logger=e.getLogger("xnm.aio.matterbridge"));}_createClass(_class3,[{key:"discoverWithTimeout",value:function discoverWithTimeout(e,t){var s=require("xnm.aio.gateway.js"),a=function a(e,s){if(s===e.length)return void(t&&t(null,e));var o=e[s];new xnm.aio.matterbridge.Bridge(o).getInfoHTTP(function(t,n){!t&&n&&(o.home="string"==typeof n.home?n.home:null,o.hwv=n.hwv||o.hwv,o.id=n.id||o.id,o.mac=n.mac||o.mac,o.mfv=n.mfv||o.mfv,o.mhv=n.mhv||o.mhv,o.msv=n.msv||o.msv,o.name=n.name||o.name,o.pt=n.pt||o.pt,o.systems=n.sys||o.systems),a(e,s+1);});};s.discoverWithTimeout(e,null,function(e,s){if(e)t&&t(e,null);else{var _e16=s.filter(function(e){return String(e._hwv).startsWith("B");}).map(function(e){return{hwv:e._hwv||null,ip:e._ip,mac:e._mac,name:e._name,msv:e._swv||null,sys:xnm.aio.matterbridge.DM.SYS};});a(_e16,0);}});}},{key:"getDeviceCommands",value:function getDeviceCommands(e,t){var s=xnm.aio.matterbridge.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),a=s?s.command:[];t&&t(null,a);}},{key:"getDeviceStatus",value:function getDeviceStatus(e,t){var s=xnm.aio.matterbridge.DM.applyUIFilter(e,{catagory:"status",elems:"*"}),a=s?s.status:[];t&&t(null,a);}},{key:"finalize",value:function finalize(e){var t=0;for(var _e17 in this._bridgeCache)this._bridgeCache[_e17].destroy(),t++;this._bridgeCache={},xnm.aio.matterbridge.logger.log("debug","[finalize] Destroyed ".concat(t," Bridge instance(s).")),e&&(0!==t?setTimeout(function(){e();},250):e());}},{key:"listDevices",value:function listDevices(e,t){var _this12=this;xnm.aio.matterbridge.logger.log("debug","[listDevices] For bridge: "+e.ip),new xnm.aio.matterbridge.Bridge(e)._doRequestHTTP("/api/devices",null,function(s,a){if(xnm.aio.matterbridge.logger.log("debug","[listDevices] Result: "+JSON.stringify(a)),!s&&a!==null&&a!==void 0&&a.XC_ERR&&(s=new Error(JSON.stringify(a.XC_ERR))),s)return xnm.aio.matterbridge.logger.log("error","[listDevices] "+s.message),void(t&&t(s,null));var o=[];if(a!==null&&a!==void 0&&a.XC_SUC)for(var _e18 in a.XC_SUC)o.push(a.XC_SUC[_e18]);0!==o.length?_this12.listRooms(e,function(e,s){!e&&s&&o.forEach(function(e){var _s$e$room;e.room=((_s$e$room=s[e.room])===null||_s$e$room===void 0?void 0:_s$e$room.name)||e.room;}),t&&t(null,o);}):t&&t(null,o);});}},{key:"listRooms",value:function listRooms(e,t){new xnm.aio.matterbridge.Bridge(e)._doRequestHTTP("/data/rooms",null,function(e,s){if(xnm.aio.matterbridge.logger.log("debug","[listRooms] Result: "+JSON.stringify(s)),!e&&s!==null&&s!==void 0&&s.XC_ERR&&(e=new Error(JSON.stringify(s.XC_ERR))),e)return xnm.aio.matterbridge.logger.log("error","[listRooms] "+e.message),void(t&&t(e,null));var a={};if(s!==null&&s!==void 0&&s.XC_SUC)for(var _e19 in s.XC_SUC)a[_e19]=s.XC_SUC[_e19];t&&t(null,a);});}},{key:"parseQRCode",value:function parseQRCode(e){return"string"!=typeof e?null:e.startsWith("MMB://")?this.parseQRCodeBridge(e):e.startsWith("MMBTKN://")?this.parseQRCodeHomeToken(e):null;}},{key:"parseQRCodeBridge",value:function parseQRCodeBridge(e){if("string"!=typeof e||!e.startsWith("MMB://"))return null;var t=Buffer.from(e.substring(6),"base64");return 40!==t.length?null:{bridgeID:"MMB_"+t.subarray(5,10).toString("hex").toUpperCase(),hardwareID:t.subarray(5,6).toString("hex").toUpperCase(),productType:t.subarray(1,5).toString("hex").toUpperCase(),productTypeMic:t.subarray(16,24).toString("hex").toUpperCase(),serialNumber:t.subarray(6,10).toString("hex").toUpperCase(),MAC:t.subarray(10,16).toString("hex").toUpperCase(),deviceSecret:t.subarray(24).toString("hex")};}},{key:"parseQRCodeHomeToken",value:function parseQRCodeHomeToken(e){if("string"!=typeof e||!e.startsWith("MMBTKN://"))return null;var t=Buffer.from(e.substring(9),"base64");var s=null;try{s=JSON.parse(t.toString());}catch(e){return null;}return s.token?{token:s.token,uuid:s.uuid}:null;}},{key:"pause",value:function pause(e){var t=0;for(var _e20 in this._bridgeCache){var s=this._bridgeCache[_e20];s.destroy(),s.state=xnm.aio.matterbridge.Bridge.STATE.UNCONNECTED,t++;}xnm.aio.matterbridge.logger.log("debug","[pause] Destroyed ".concat(t," Bridge instance(s) but kept them in cache.")),e&&(0!==t?setTimeout(function(){e();},250):e());}},{key:"registModule",value:function registModule(e){e.register(xnm.aio.matterbridge.DM.SYS,"matterbridge");}},{key:"resolveGateway",value:function resolveGateway(e){if(!e||!e.ip)return xnm.aio.matterbridge.logger.log("error","[resolveGateway] Info incomplete: "+JSON.stringify(e)),null;var t=Buffer.from("".concat(e.ip,":").concat(e.password,":").concat(e.home_token)).toString("base64");var s=this._bridgeCache[t];return s&&s.state!==xnm.aio.matterbridge.Bridge.STATE.FAILED||(s=xnm.aio.matterbridge.parseJSON(e),this._bridgeCache[t]=s),s;}}]);return _class3;}(),xnm.aio.matterbridge.WebSocket.MODE={HTTP:"http",WEBSOCKET:"ws"},xnm.aio.matterbridge.Bridge.MODE={HTTP:"http",WEBSOCKET:"ws"},xnm.aio.matterbridge.Bridge.STATE={UNCONNECTED:"unconnected",CONNECTING:"connecting",CONNECTED:"connected",DESTROYED:"destroyed",FAILED:"failed"},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.matterbridge.Handler());