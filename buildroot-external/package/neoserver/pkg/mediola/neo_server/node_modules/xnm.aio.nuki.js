var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.nuki=xnm.aio.nuki||{};
xnm.aio.nuki.SmartLockBridge=function(){var d={0:"uncalibrated",1:"locked",2:"unlocking",3:"unlocked",4:"locking",5:"unlatched",6:"unlocked_lock_n_go",7:"unlatching",254:"motor_blocked",255:"undefined"},b=function(a,c,b){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.nuki.SmartLock");this.ip=a;this.port=c;this.port||(this.port=8080);this.token=b;this.timeout=5E4};b.prototype.executeCommandCreator=function(a,c,b){if(a&&a.address)if(c&&
c.value){switch(c.value){case "unlock":c=1;break;case "lock":c=2;break;case "unlatch":c=3;break;case "lockGo":c=4;break;case "lockGoUnlatch":c=5;break;default:b&&b(Error("no such command"));return}this._lockAction(a.address,c,0,b)}else b&&b(Error("command json format invalid"));else b&&b(Error("device json format invalid"))};b.prototype.getStatesCreator=function(a,c,b){this.getLocalStates(function(a,k){for(var d=[],e=0;e<c.length;e++)if(c[e]&&c[e].id){var l="?";if(k&&c[e].status&&c[e].status.value&&
c[e].device&&c[e].device.address){var m=c[e].status.value,n=c[e].device.address;k[n]&&(l=k[n][m],"undefined"==typeof l||null==l)&&(l="?")}d.push({id:c[e].id,status:l})}b&&b(null,d)})};b.prototype.getLocalStates=function(a){var c=this;this._list(function(b,f){if(b)a&&a(b);else{for(var d={},g=0;g<f.length;g++){var e=f[g];if(e.nukiId&&e.lastKnownState){var l=c._toState(e.lastKnownState);l&&(d[e.nukiId]=l)}}a&&a(null,d)}})};b.prototype.getDevices=function(a){this._list(function(c,b){if(c)a&&a(c);else{for(var f=
[],d=0;d<b.length;d++){var g=b[d];g.nukiId&&g.name&&f.push({sys:"nuki",type:"smartlock",address:g.nukiId,name:g.name})}a&&a(null,f)}})};b.prototype._toState=function(a){var c={};c.state=d[a.state];c.lowbat=a.batteryCritical;c.stateCode=a.state;c.stateName=a.stateName;return c};b.prototype._lockAction=function(a,c,b,d){this._doLocalRequest("/lockAction",{token:this.token,nukiId:a,action:c,noWait:b},function(c,a,b){c?(401==parseInt(a)?(c=Error("invalid token"),c.code=1E3):400==parseInt(a)?(c=Error("invalid action"),
c.code=1003):404==parseInt(a)?(c=Error("unknown smart lock"),c.code=1001):503==parseInt(a)&&(c=Error("smart lock offline"),c.code=1002),d&&d(c)):d&&d(null,b)})};b.prototype._lockState=function(a,c){this._doLocalRequest("/lockState",{token:this.token,nukiId:a},function(a,b,d){a?(401==parseInt(b)?(a=Error("invalid token"),a.code=1E3):404==parseInt(b)?(a=Error("unknown smart lock"),a.code=1001):503==parseInt(b)&&(a=Error("smart lock offline"),a.code=1002),c&&c(a)):c&&c(null,d)})};b.prototype._list=function(a){this._doLocalRequest("/list",
{token:this.token},function(c,b,d){c?(401==parseInt(b)&&(c=Error("invalid token"),c.code=1E3),a&&a(c)):a&&a(null,d)})};b.prototype._doLocalRequest=function(a,c,b){var d=this;a="http://"+this.ip+":"+this.port+a;if(c){var k=[],g;for(g in c)if(c.hasOwnProperty(g)){var e=g+"=",l=c[g];"undefined"!=typeof l&&null!=l&&(e+=encodeURIComponent(l));k.push(e)}a+="?"+k.join("&")}this._logger.log("trace","send get to url:"+a);var m=b;$.ajax({url:a,type:"GET",timeout:this.timeout,dataType:"text",cache:!0,success:function(a){d._logger.log("trace",
"http request success:"+a);try{var c=JSON.parse(a);m&&(m(null,200,c),m=null)}catch(b){m&&(m(b,200),m=null)}},error:function(a,c){var b="http request error:"+(a?a.status:"0")+"-"+c;d._logger.log("trace",b);m&&(m(Error(b),a?a.status:"0"),m=null)}})};return b}();
xnm.aio.nuki.DM=function(){var d=function(b,a){this.code=b;this.message=a;this.stack=Error().stack};d.prototype=Error();d.prototype.name="NukiDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"nuki",MAP:{command:[{type:"enum",name:"unlock",ref:{value:"unlock"}},{type:"enum",name:"lock",ref:{value:"lock"}},{type:"enum",name:"unlatch",ref:{value:"unlatch"}},{type:"enum",name:"lock 'n' go",ref:{value:"lockGo"}},{type:"enum",
name:"lock 'n' go with unlatch",ref:{value:"lockGoUnlatch"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:"uncalibrated locked unlocking unlocked locking unlatched unlocked_lock_n_go unlatching motor_blocked undefined".split(" ")}},{type:"enum",name:"low battery",ref:{value:"lowbat",options:["true","false"]}}]},getGatewayType:function(){return[{sys:this.SYS,name:"NUKI Bridge",port:8080}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"smartlock",name:"Smart Lock"}]},createGateway:function(b,
a,c){a=d.ERROR_CODE;b?b.ip?b.token?c(null,b):c(new d(a.INVALID,"token is invalid")):c(new d(a.INVALID,"ip is invalid")):c(new d(a.INVALID,"info is invalid"))},updateGateway:function(b,a,c,h){b=d.ERROR_CODE;a?a.ip?a.token?h(null,a):h(new d(b.INVALID,"token is invalid")):h(new d(b.INVALID,"ip is invalid")):h(new d(b.INVALID,"update is invalid"))},deleteGateway:function(b,a,c){c()},createDevice:function(b,a,c){var h=d.ERROR_CODE;if(b)if(b.gateway)if(b.address)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=
a.data.gateways;var f,k;for(f=0;f<a.length;f++)if(a[f].index===b.gateway){k=a[f];break}k?c(null,b):c(new d(h.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else c(new d(h.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));else c(new d(h.INVALID,"address is invalid"));else c(new d(h.INVALID,"gateway is invalid"));else c(new d(h.INVALID,"info is invalid"))},updateDevice:function(b,a,c){var h=d.ERROR_CODE;if(b)if(b.gateway)if(b.address)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=
a.data.gateways;var f,k;for(f=0;f<a.length;f++)if(a[f].index===b.gateway){k=a[f];break}k?c(null,b):c(new d(h.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else c(new d(h.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));else c(new d(h.INVALID,"address is invalid"));else c(new d(h.INVALID,"gateway is invalid"));else c(new d(h.INVALID,"info is invalid"))},deleteDevice:function(b,a,c){c()},applyUIFilter:function(b,a){var c=this,d=function(a,c){if("*"==a)return!0;for(var b=!1,d=0;d<
a.length;d++)if(a[d]==c){b=!0;break}return b},f=function(a,c,b){var f=[];switch(b.catagory){case "command":a.command&&a.command.forEach(function(a){d(b.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),f.push(a))});break;case "status":a.status&&a.status.forEach(function(a){d(b.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),f.push(a))})}return f},k=function(a,b){var d=[],e=null;if(e=c.getCommandStatusMap(a))e=f(e,a,b),d=d.concat(e);return d};if(!b||null==b.type||"undefined"==typeof b.type)return null;
var g=JSON.parse(JSON.stringify(b)),e=null;switch(a.catagory){case "command":e=k(b,a);g.command=e;break;case "status":e=k(b,a);g.status=e;break;default:return null}return e&&0!=e.length?g:null},getCommandStatusMap:function(b){return this.MAP}}}();
xnm.aio.nuki.Handler=function(){var d=function(){};d.prototype.devicemanager=xnm.aio.nuki.DM;d.prototype.SmartLockBridge=xnm.aio.nuki.SmartLockBridge;d.prototype.registModule=function(b){b.register(this.devicemanager.SYS,"nuki")};d.prototype.resolveGateway=function(b){return b&&b.ip?new this.SmartLockBridge(b.ip,b.port,b.token):null};d.prototype.getDeviceCommands=function(b,a){var c=this.devicemanager.applyUIFilter(b,{catagory:"command",elems:"*"}),c=c?c.command:[];a&&a(null,c)};d.prototype.getDeviceStatus=
function(b,a){var c=this.devicemanager.applyUIFilter(b,{catagory:"status",elems:"*"}),c=c?c.status:[];a&&a(null,c)};d.prototype.doCommand=function(b,a,c,d){(b=this.resolveGateway(b))?b.executeCommandCreator(a,c,function(a){d&&d(a)}):d&&d(Error("gateway json format invalid"))};d.prototype.doStatus=function(b,a,c,d,f){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:b,device:c,status:d}],function(a,b){a?f&&f(a):f&&f(null,b[0])}):f&&f(Error("gateway json format invalid"))};d.prototype.getDeviceList=
function(b,a){var c=this.resolveGateway(b);c?c.getDevices(function(b,c){a&&a(b,c)}):a&&a(Error("gateway json format invalid"))};return d}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.nuki.Handler);
