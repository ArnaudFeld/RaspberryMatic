var util=require("util"),EventEmitter=require("events");require("x.logger.js").setLevel("info","x.hub.scriptman");var x=x||{};x.hub=x.hub||{};x.hub.scriptman=x.hub.scriptman||{};x.hub.scriptman.Error=function(c,a){Error.call(this,c);this.code=a};util.inherits(x.hub.scriptman.Error,Error);
x.hub.scriptman.Hashids=function(){function c(a,b,d){this.version="1.0.1";this.minAlphabetLength=16;this.sepDiv=3.5;this.guardDiv=12;this.errorAlphabetLength="error: alphabet must contain at least X unique characters";this.errorAlphabetSpace="error: alphabet cannot contain spaces";this.alphabet="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890";this.seps="cfhistuCFHISTU";this.minHashLength=0<parseInt(b,10)?b:0;this.salt="string"===typeof a?a:"";"string"===typeof d&&(this.alphabet=d);
d="";a=0;for(b=this.alphabet.length;a!==b;a++)-1===d.indexOf(this.alphabet[a])&&(d+=this.alphabet[a]);this.alphabet=d;if(this.alphabet.length<this.minAlphabetLength)throw this.errorAlphabetLength.replace("X",this.minAlphabetLength);if(-1!==this.alphabet.search(" "))throw this.errorAlphabetSpace;a=0;for(b=this.seps.length;a!==b;a++)d=this.alphabet.indexOf(this.seps[a]),-1===d?this.seps=this.seps.substr(0,a)+" "+this.seps.substr(a+1):this.alphabet=this.alphabet.substr(0,d)+" "+this.alphabet.substr(d+
1);this.alphabet=this.alphabet.replace(/ /g,"");this.seps=this.seps.replace(/ /g,"");this.seps=this.consistentShuffle(this.seps,this.salt);if(!this.seps.length||this.alphabet.length/this.seps.length>this.sepDiv)a=Math.ceil(this.alphabet.length/this.sepDiv),1===a&&a++,a>this.seps.length?(a-=this.seps.length,this.seps+=this.alphabet.substr(0,a),this.alphabet=this.alphabet.substr(a)):this.seps=this.seps.substr(0,a);this.alphabet=this.consistentShuffle(this.alphabet,this.salt);a=Math.ceil(this.alphabet.length/
this.guardDiv);3>this.alphabet.length?(this.guards=this.seps.substr(0,a),this.seps=this.seps.substr(a)):(this.guards=this.alphabet.substr(0,a),this.alphabet=this.alphabet.substr(a))}c.prototype.encode=function(){var a,b,d=Array.prototype.slice.call(arguments);if(!d.length)return"";d[0]instanceof Array&&(d=d[0]);a=0;for(b=d.length;a!==b;a++)if("number"!==typeof d[a]||0!==d[a]%1||0>d[a])return"";return this._encode(d)};c.prototype.decode=function(a){var b=[];return a.length&&"string"===typeof a?this._decode(a,
this.alphabet):b};c.prototype.encodeHex=function(a){var b,d;a=a.toString();if(!/^[0-9a-fA-F]+$/.test(a))return"";d=a.match(/[\w\W]{1,12}/g);a=0;for(b=d.length;a!==b;a++)d[a]=parseInt("1"+d[a],16);return this.encode.apply(this,d)};c.prototype.decodeHex=function(a){var b=[],d,f=this.decode(a);a=0;for(d=f.length;a!==d;a++)b+=f[a].toString(16).substr(1);return b};c.prototype._encode=function(a){var b,d,f,g,e,h,c,k=this.alphabet,m=a.length;f=c=0;for(g=a.length;f!==g;f++)c+=a[f]%(f+100);d=b=k[c%k.length];
f=0;for(g=a.length;f!==g;f++)e=a[f],h=d+this.salt+k,k=this.consistentShuffle(k,h.substr(0,k.length)),h=this.hash(e,k),b+=h,f+1<m&&(e%=h.charCodeAt(0)+f,e%=this.seps.length,b+=this.seps[e]);b.length<this.minHashLength&&(a=(c+b[0].charCodeAt(0))%this.guards.length,a=this.guards[a],b=a+b,b.length<this.minHashLength&&(a=(c+b[2].charCodeAt(0))%this.guards.length,a=this.guards[a],b+=a));for(c=parseInt(k.length/2,10);b.length<this.minHashLength;)k=this.consistentShuffle(k,k),b=k.substr(c)+b+k.substr(0,c),
a=b.length-this.minHashLength,0<a&&(b=b.substr(a/2,this.minHashLength));return b};c.prototype._decode=function(a,b){var d=[],f=0,c,e,h,l;e=new RegExp("["+this.guards+"]","g");h=a.replace(e," ");var k=h.split(" ");if(3===k.length||2===k.length)f=1;h=k[f];if("undefined"!==typeof h[0]){c=h[0];h=h.substr(1);e=new RegExp("["+this.seps+"]","g");h=h.replace(e," ");k=h.split(" ");f=0;for(e=k.length;f!==e;f++)h=k[f],l=c+this.salt+b,b=this.consistentShuffle(b,l.substr(0,b.length)),d.push(this.unhash(h,b));
this._encode(d)!==a&&(d=[])}return d};c.prototype.consistentShuffle=function(a,b){var d,f,c,e,h;if(!b.length)return a;c=a.length-1;for(h=e=0;0<c;c--,e++)e%=b.length,h+=d=b[e].charCodeAt(0),d=(d+e+h)%c,f=a[d],a=a.substr(0,d)+a[c]+a.substr(d+1),a=a.substr(0,c)+f+a.substr(c+1);return a};c.prototype.hash=function(a,b){var d="",f=b.length;do d=b[a%f]+d,a=parseInt(a/f,10);while(a);return d};c.prototype.unhash=function(a,b){var d=0,f,c;for(c=0;c<a.length;c++)f=b.indexOf(a[c]),d+=f*Math.pow(b.length,a.length-
c-1);return d};"function"===typeof define&&"object"===typeof define.amd&&define.amd&&define(function(){return c});return c}();
x.hub.scriptman.Debugger=function(){var c=function(a){this._ws=a;this._executor=null;var b=this;a.on("message",function(a,b){});a.on("error",function(a){});a.on("close",function(a,f){b._ws=null;b._executor&&x.hub.scriptman.ScriptExecutorService.stop(b._executor._id)})};c.prototype.onStart=function(a){this._executor=a;this._ws&&this._ws.send(JSON.stringify({type:"start"}))};c.prototype.onError=function(a){this._ws&&(this._ws.send(JSON.stringify({type:"error",message:a.message})),this._ws&&this._ws.close(),
this._ws=null)};c.prototype.onSTDOutMessage=function(a){this._ws&&this._ws.send(JSON.stringify({type:"stdout",message:a}))};c.prototype.onSTDErrMessage=function(a){this._ws&&this._ws.send(JSON.stringify({type:"stderr",message:a}))};c.prototype.onFinish=function(){this._ws&&(this._ws.send(JSON.stringify({type:"finish"})),this._ws.close(),this._ws=null)};return c}();
x.hub.scriptman.Executor=function(){var c=function(a,b,d,f){this._logger=require("x.logger.js").getLogger("x.hub.scriptman.Executor");this._id=(new x.hub.scriptman.Hashids).encode((new Date).getTime());this._executorService=a;this.scriptInfo=b;this.callback=d;this.finishCallback=f;this._debugListener=this._childProcess=null;this._jsonrpcRequests=[]};c.prototype.isForScript=function(a){return a&&this.scriptInfo&&a.id==this.scriptInfo.id};c.prototype.setDebugListener=function(a){this._debugListener=
a};c.prototype.start=function(a){this._logger.log("debug","start script:"+this.scriptInfo.id);var b=this;this._processJsFile(a,function(a,f){a&&b._logger.log("warn","process script file:"+b.scriptInfo.id+" error:"+a.message);if(a||!f)b._executorService._removeExecutor(b),b.callback&&(b.callback(a?a:Error("js file path is empty")),b.callback=null),b._debugListener&&(b._debugListener.onError(a?a:Error("js file path is empty")),b._debugListener=null);else{var c=[];process.execArgv.forEach(function(a){-1==
a.indexOf("--debug")&&c.push(a)});process.execArgv=c;var e=require("x.hub.scriptman.js").httpServer.address().port;b._logger.log("trace","start child process for script:"+b.scriptInfo.id);b._logger.log("trace","callback port:"+e);e=require("child_process").fork(f,[e],{silent:!0});e.stdout.setEncoding("utf8");e.stderr.setEncoding("utf8");e.stdout.on("data",function(a){b._logger.log("trace","stdout data:"+a);b._logger.log("debug",a);process.stdout.write(a);b._debugListener&&b._debugListener.onSTDOutMessage(a)});
e.stdout.on("error",function(a){b._logger.log("trace","stdout error:"+a.stack);console.error("child process stdout error",a);b._debugListener&&b._debugListener.onError(a)});e.stderr.on("data",function(a){b._logger.log("trace","stderr data:"+a);b._logger.log("debug",a);process.stderr.write(a);b._debugListener&&b._debugListener.onSTDErrMessage(a)});e.stderr.on("error",function(a){b._logger.log("trace","stderr error:"+a.stack);console.error("child process stderr error",a);b._debugListener&&b._debugListener.onError(a)});
e.on("message",function(a){b._onChildprocessMessage(a)});e.on("error",function(a){b._logger.log("error","child process error:"+a.stack);console.error("child process error",a);b._onProcessExit(a);b._debugListener&&b._debugListener.onError(a)});e.on("exit",function(a,d){b._logger.log("trace","child process exit for script:"+b.scriptInfo.id);console.log("child process exit",a,d);b._onProcessExit();b._debugListener&&b._debugListener.onFinish()});b._childProcess=e;b._debugListener&&b._debugListener.onStart(b);
b.callback&&b.callback();b.callback=null}})};c.prototype.stop=function(){this._childProcess&&this._childProcess.kill();this.callback&&this.callback(Error("interrupted"));this.callback=null;this.finishCallback&&this.finishCallback(Error("canceled"));this.finishCallback=null};c.prototype.toJSON=function(){return{id:this._id,scriptInfo:this.scriptInfo,debug:this._debugListener?!0:!1}};c.prototype._onProcessExit=function(a){this._logger.log("debug","finish execute script:"+this.scriptInfo.id+(a?"with error:"+
a.message:""));this._executorService._removeExecutor(this);this.finishCallback&&this.finishCallback()};c.prototype._processJsFile=function(a,b){var d=require("fs"),f=require("path"),c=f.resolve(__dirname,"runner.js"),e=require("loop-protect");e.method="protect";d.readFile(c,{encoding:"utf8"},function(c,g){if(c)b(c);else{var k=g.replace("//%CODE",a),k=e.rewriteLoops(k),m=require("os").tmpdir()+f.sep+"_runner_"+(new Date).getTime()+".js";d.writeFile(m,k,function(a){b(a,m)})}})};c.prototype._onChildprocessMessage=
function(a){this._logger.log("trace","child process message:"+JSON.stringify(a));a&&"2.0"==a.jsonrpc?this._onChildProcessJsonRPC(a):"win32"==process.platform&&(a&&a.log?(process.stdout.write(JSON.stringify(a.log)),this._debugListener&&this._debugListener.onSTDOutMessage(a.log)):a&&a.error&&(process.stderr.write(JSON.stringify(a.error)),this._debugListener&&this._debugListener.onSTDErrMessage(a.error)))};c.prototype._onChildProcessJsonRPC=function(a){};return c}();
x.hub.scriptman.ScriptExecutorService={_executors:[],execute:function(c,a,b,d){c&&a?(c=new x.hub.scriptman.Executor(this,c,b,d),this._executors.push(c),c.start(a)):b&&b(Error("argument invalid"))},debug:function(c,a,b,d){if(c&&a)c=new x.hub.scriptman.Executor(this,c,d),c.setDebugListener(b),this._executors.push(c),c.start(a);else b.onError(Error("argument invalid"))},stop:function(c,a){if(c){for(var b=[],d=null,f=0;f<this._executors.length;f++)this._executors[f]&&this._executors[f]._id==c?d=this._executors[f]:
this._executors[f]&&b.push(this._executors[f]);this._executors=b;d&&d.stop();a&&a()}else a&&a(Error("argument invalid"))},stopScript:function(c,a){if(c){for(var b=[],d=0;d<this._executors.length;d++)this._executors[d]&&this._executors[d].isForScript(c)?this._executors[d].stop():this._executors[d]&&b.push(this._executors[d]);this._executors=b;a&&a()}else a&&a(Error("argument invalid"))},getAllRunning:function(){var c=[];this._executors.forEach(function(a){c.push(a.toJSON())});return c},_removeExecutor:function(c){for(var a=
-1,b=0;b<this._executors.length;b++)if(this._executors[b]===c){a=b;break}-1!=a&&this._executors.splice(a,1)}};
x.hub.scriptman.ScriptExecutorService2=function(){var c=function(a,d){this._executor=a;this._request=d};c.prototype.execute=function(){if(this._request&&this._request.method){var a=this,d=require("x.hub.scriptman.js");switch(this._request.method){case "executeCommand":case "getStatus":case "executeMacro":d._doCallback(this._request.params,function(d,c){var e=null;d&&(e={},e.message=d instanceof Error?d.message:d,e.code=d.code?d.code:0);a._finishWithResponse(e,c)});break;default:this._finishWithResponse({code:-32601,
message:"Method not found"})}}else this._finishWithResponse({code:-32600,message:"Invalid Request"})};c.prototype._finishWithResponse=function(a,d){var f={jsonrpc:"2.0",id:this._request.id,error:a,result:d};this._executor&&this._executor._childProcess&&this._executor._childProcess.send(f);this._executor&&this._executor._jsonrpcRequests&&(f=this._executor._jsonrpcRequests.indexOf(this),-1!=f&&this._executor._jsonrpcRequests.splice(f,1))};var a=function(){this._logger=require("x.logger.js").getLogger("x.hub.scriptman.ScriptExecutorService2");
this._childProcess=null;this._jsonrpcRequests=[];this._start()};a.prototype.execute=function(a,d,f,c){if(a&&d)if(this._childProcess){this._logger.log("debug","start script:"+a.id);var e=this;this._processJsFile(d,function(d,l){d&&e._logger.log("warn","process script file:"+a.id+" error:"+d.message);d||!l?f&&f(d?d:Error("js file path is empty")):(e._childProcess.send({runScript:l}),f&&f(),c&&c())})}else f&&f(Error("child process is null"));else f&&f(Error("argument invalid"))};a.prototype.execute2=
function(a,d,f){a?this._childProcess?(this._logger.log("debug","start script:"+a),this._childProcess.send({runScript:a}),d&&d(),f&&f()):d&&d(Error("child process is null")):d&&d(Error("argument invalid"))};a.prototype.stopScript=function(a,d){a?d&&d():d&&d(Error("argument invalid"))};a.prototype._processJsFile=function(a,d){var f=require("fs"),c=require("path"),e=c.resolve(__dirname,"runner2.js"),h=require("loop-protect");h.method="protect";f.readFile(e,{encoding:"utf8"},function(e,k){if(e)d(e);else{var m=
k.replace("//%CODE",a),m=h.rewriteLoops(m),n=require("os").tmpdir()+c.sep+"_runner_"+(new Date).getTime()+".js";f.writeFile(n,m,function(a){d(a,n)})}})};a.prototype._start=function(a){require("fs");var d=require("path").resolve(__dirname,"script_executor.js"),c=[];process.execArgv.forEach(function(a){-1==a.indexOf("--debug")&&-1==a.indexOf("--inspect")&&c.push(a)});process.execArgv=c;this._logger.log("trace","start js executor child process");var g=this,e=require("child_process").fork(d,[],{silent:!0});
e.stdout.setEncoding("utf8");e.stderr.setEncoding("utf8");e.stdout.on("data",function(a){g._logger.log("trace","stdout data:"+a);g._logger.log("debug",a);process.stdout.write(a)});e.stdout.on("error",function(a){g._logger.log("trace","stdout error:"+a.stack);console.error("child process stdout error",a)});e.stderr.on("data",function(a){g._logger.log("trace","stderr data:"+a);g._logger.log("debug",a);process.stderr.write(a)});e.stderr.on("error",function(a){g._logger.log("trace","stderr error:"+a.stack);
console.error("child process stderr error",a)});e.on("message",function(a){g._onChildprocessMessage(a)});e.on("error",function(a){g._logger.log("error","child process error:"+a.stack);console.error("child process error",a);e.__closed||(e.__closed=!0,g._onProcessExit(a))});e.on("exit",function(a,b){g._logger.log("trace","child process exit for script executor");console.log("child process exit",a,b);e.__closed||(e.__closed=!0,g._onProcessExit())});this._childProcess=e;a&&a()};a.prototype._onChildprocessMessage=
function(a){this._logger.log("trace","child process message:"+JSON.stringify(a));a&&"2.0"==a.jsonrpc?this._onChildProcessJsonRPC(a):"win32"==process.platform&&(a&&a.log?process.stdout.write(JSON.stringify(a.log)):a&&a.error&&process.stderr.write(JSON.stringify(a.error)))};a.prototype._onChildProcessJsonRPC=function(a){a=new c(this,a);this._jsonrpcRequests.push(a);a.execute()};a.prototype._onProcessExit=function(a){this._logger.log("debug","script executor finished"+(a?" with error:"+a.message:""));
this._start()};return a}();
x.hub.scriptman.ScriptManager=function(){var c=function(){this._logger=require("x.logger.js").getLogger("x.hub.scriptman.ScriptManager");this._scripts=[];this._service=x.hub.scriptman.ScriptExecutorService;this._service2=new x.hub.scriptman.ScriptExecutorService2};c.FOLDER_NAME="scripts";c.FILE_NAME="sm.json";c.prototype.init=function(a){var b=this._getScriptIndexFile(),d=this;require("fs-extra").ensureFile(b,function(b){b?a&&a(b):d._loadData(function(b,c){b?a&&a(b):(d._scripts=c,d._sort(),a&&a())})})};
c.prototype.reload=function(a){this.init(a)};c.prototype.createScript=function(a,b,d){if(a){for(var c=1,g=-1,e=1,h=0;h<this._scripts.length;h++)if(this._scripts[h].id>c){e=c;g=h;break}else c++;-1==g&&(e=c,g=this._scripts.length);var l=this,k={id:e,name:a,file:e};this._writeScript(e,b,function(a){a?d&&d(a):(l._scripts.splice(g,0,k),l._writeData(function(a){a&&l._scripts.splice(g,1);d&&d(a,k)}))})}else d&&d(Error("name is null"))};c.prototype.readScriptContent=function(a,b){if(a){for(var d=null,c=0;c<
this._scripts.length;c++){var g=this._scripts[c];if(g.id==a){d=g;break}}d?this._readScript(a,function(a,d){b&&b(a,d)}):b&&b(Error("no such script with id:"+a))}else b&&b(Error("script id is null"))};c.prototype.readAllScripts=function(a){a&&a(null,this._scripts)};c.prototype.updateScript=function(a,b,d,c){if(a){for(var g=null,e=0;e<this._scripts.length;e++){var h=this._scripts[e];if(h.id==a){g=h;break}}if(g){var l=this;this._writeScript(a,d,function(a){a?c&&c(a):b&&g.name!=b?(g.name=b,l._writeData(c)):
c&&c()})}else c&&c(Error("no such script with id:"+a))}else c&&c(Error("script id is null"))};c.prototype.deleteScript=function(a,b){if(a){for(var d=-1,c=null,g=0;g<this._scripts.length;g++){var e=this._scripts[g];if(e.id==a){d=g;c=e;break}}var h=this;this.stopScript(a);this._deleteScript(a,function(a){a?b&&b(a):(h._scripts.splice(d,1),h._writeData(function(a){a&&h._scripts.splice(d,0,c);b&&b(a)}))})}else b&&b(Error("script id is null"))};c.prototype.runScript=function(a,b,d){if(a){for(var c=null,
g=0;g<this._scripts.length;g++){var e=this._scripts[g];if(e.id==a){c=e;break}}c?(c=require("path"),a+="",g=this._getScriptDir(),a=c.resolve(g,a),this._service2.execute2(a,b,d)):b&&b(Error("no such script with id:"+a))}else b&&b(Error("script id is null"))};c.prototype.debugScript=function(a,b,d){if(a){for(var c=null,g=0;g<this._scripts.length;g++){var e=this._scripts[g];if(e.id==a){c=e;break}}if(c){var h=this;this.readScriptContent(a,function(a,e){if(a)b.onError(a);else h._service.debug(c,e,b,d)})}else b.onError(Error("no such script with id:"+
a))}else b.onError(Error("script id is null"))};c.prototype.stopScript=function(a,b){if(a){for(var d=[],c=0;c<this._scripts.length;c++){var g=this._scripts[c];if(g.id==a){d.push(g);break}}if(0==d.length)b&&b(Error("no such script with id:"+a));else{var e=this,h=0,l=function(){h++;h>=d.length?b&&b():e._service.stopScript(d[h],l)};this._service2.stopScript(d[h],l)}}else b&&b(Error("script id is null"))};c.prototype._getScriptDir=function(){var a=require("path"),b=require("x.hub.fileman.js").fileManager.getUserRootDataPath();
return a.resolve(b,c.FOLDER_NAME)};c.prototype._getScriptIndexFile=function(){var a=require("path"),b=this._getScriptDir();return a.resolve(b,c.FILE_NAME)};c.prototype._writeData=function(a){var b=this._scripts,d=require("fs"),c=this._getScriptIndexFile();d.writeFile(c,JSON.stringify(b,null,2),function(b){a&&a(b)})};c.prototype._loadData=function(a){var b=require("path"),d=require("fs"),f=this._getScriptDir(),b=b.resolve(f,c.FILE_NAME);d.readFile(b,"utf8",function(b,d){if(b)a&&a(b);else if(d)try{a&&
a(null,JSON.parse(d))}catch(c){a&&a(c)}else a&&a(null,[])})};c.prototype._writeScript=function(a,b,d){var c=require("fs-extra"),g=require("path");a+="";var e=this._getScriptDir();a=g.resolve(e,a);c.writeFile(a,b,function(a){d&&d(a)})};c.prototype._readScript=function(a,b){var d=require("fs-extra"),c=require("path");a+="";var g=this._getScriptDir(),c=c.resolve(g,a);d.readFile(c,"utf8",function(a,d){b&&b(a,d)})};c.prototype._deleteScript=function(a,b){var d=require("fs-extra"),c=require("path");a+=
"";var g=this._getScriptDir(),c=c.resolve(g,a);d.remove(c,function(a){b&&b(a)})};c.prototype._sort=function(){var a=this._scripts.length-1,b=!1;do for(var b=!1,d=0;d<a;++d)this._scripts[d].id>this._scripts[d+1].id&&(b=this._scripts[d],this._scripts[d]=this._scripts[d+1],this._scripts[d+1]=b,b=!0);while(b)};return c}();
x.hub.scriptman.Handler=function(){var c=function(){this._logger=require("x.logger.js").getLogger("x.hub.scriptman.Handler");this.scriptManager=new x.hub.scriptman.ScriptManager;this.httpServer=null};c.prototype.ScriptManager=x.hub.scriptman.ScriptManager;c.prototype.init=function(a,b,d){this._config(a,b);this.scriptManager.init(d)};c.prototype._config=function(a,b){var d=this;this.httpServer=b;var c=require("url"),g=new (require("ws").Server)({server:b,path:"/xhub/script/debug"});g.on("connection",
function(a){var b=c.parse(a.upgradeReq.url,!0);b.query&&b.query.id?(a=new x.hub.scriptman.Debugger(a),d.scriptManager.debugScript(b.query.id,a)):(a.send(JSON.stringify({type:"error",message:"no script id"})),a.close())});g.on("error",function(a){d._logger.log("warn","script web socket server error:"+a.stack)});g=require("body-parser");a.use("/xhub/script/callback",g.json({limit:"50mb"}));a.use("/xhub/script",g.text({limit:"50mb"}));a.post("/xhub/script",function(a,b){var c=a.query.name;c?d.scriptManager.createScript(c,
a.body,function(a,c){b.send(d._toRestfulResponse(a,c))}):b.send(d._toRestfulResponse(new x.hub.scriptman.Error("no script name")))}.bind(this));a.get("/xhub/script",function(a,b){var c=a.query.id;c?d.scriptManager.readScriptContent(c,function(a,c){a?b.send(d._toRestfulResponse(a)):b.send(c)}):b.send(d._toRestfulResponse(new x.hub.scriptman.Error("no script id")))}.bind(this));a.get("/xhub/scripts",function(a,b){d.scriptManager.readAllScripts(function(a,c){a?b.send(d._toRestfulResponse(a)):b.send(JSON.stringify(c))})}.bind(this));
a.put("/xhub/script",function(a,b){var c=a.query.id;c?d.scriptManager.updateScript(c,a.query.name,a.body,function(a){b.send(d._toRestfulResponse(a,"ok"))}):b.send(d._toRestfulResponse(new x.hub.scriptman.Error("no script id")))}.bind(this));a.delete("/xhub/script",function(a,b){var c=a.query.id;c?d.scriptManager.deleteScript(c,function(a){b.send(d._toRestfulResponse(a,"ok"))}):b.send(d._toRestfulResponse(new x.hub.scriptman.Error("no script id")))}.bind(this));a.get("/xhub/script/do",function(a,b){var c=
a.query.id;c?d.scriptManager.runScript(c,function(a){b.send(d._toRestfulResponse(a,"ok"))}):b.send(d._toRestfulResponse(new x.hub.scriptman.Error("no script id")))}.bind(this));a.get("/xhub/script/stop",function(a,b){var c=a.query.id;c?x.hub.scriptman.ScriptExecutorService.stop(c,function(a){b.send(d._toRestfulResponse(a,"ok"))}):b.send(d._toRestfulResponse(new x.hub.scriptman.Error("no executor id")))}.bind(this));a.get("/xhub/script/running",function(a,b){var c=x.hub.scriptman.ScriptExecutorService.getAllRunning();
b.send(d._toRestfulResponse(null,c))}.bind(this));a.post("/xhub/script/callback",function(a,b){var c=a.body;c?d._doCallback(c,function(a,c){b.send(d._toRestfulResponse(a,c))}):b.send(d._toRestfulResponse(new x.hub.scriptman.Error("no callback body")))}.bind(this))};c.prototype._toRestfulResponse=function(a,b){return a?{status:"fail",message:a.message,code:a.code?a.code:0}:{status:"success",data:b}};c.prototype._doCallback=function(a,b){this._logger.log("trace","do callback:"+JSON.stringify(a));var c=
require("x.hub.commandman.js").commandHandler;"executeCommand"==a.func?a.device&&a.command&&a.device.device&&a.device.room?c.executeCommandWithRef(a.device.room,a.device.device,null,a.command,function(a){b&&b(a.error,a.data)}):b&&b(Error("execute command argument invalid")):"getStatus"==a.func?a.device&&a.status&&a.device.device&&a.device.room?c.getStateWithRef(a.device.room,a.device.device,null,a.status,function(a){b&&b(a.error,a.data)}):b&&b(Error("get status argument invalid")):"executeMacro"==
a.func?a.groupName&&a.macroName?require("x.hub.macroman.js").execute(a.groupName,a.macroName,function(a){b&&b(a.error,a.data)}):b&&b(Error("execute macro argument invalid")):b&&b()};return c}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.scriptman.Handler);
