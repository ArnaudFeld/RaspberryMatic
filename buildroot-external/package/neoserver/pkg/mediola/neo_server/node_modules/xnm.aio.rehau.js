var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.rehau=xnm.aio.rehau||{};
xnm.aio.rehau.Gauzy=function(){var d=function(b,a){this.address=b;this.port=a;a&&""!=a||(this.port=5E3)};d.prototype._setScene=function(b,a){this._doJsonRequest("POST","/scene",{scene:b},function(b,e){a&&a(b,e)})};d.prototype._setInvert=function(b,a){var c=this;this._getBlindStates(function(e,h){e?a&&a(e):c._setInvertAndBlindOpacity(b,h.opacity,a)})};d.prototype._setBlindPosition=function(b,a){var c=this;this._getBlindStates(function(e,h){e?a&&a(e):c._setInvertAndBlindOpacity(h.invert,b,a)})};d.prototype._setBlindOpacity=
function(b,a){var c=this;this._getBlindStates(function(e,h){e?a&&a(e):c._setInvertAndBlindOpacity(h.invert,b,a)})};d.prototype._setInvertAndBlindOpacity=function(b,a,c){this._doJsonRequest("POST","/blind",{opacity:a,invert:b},function(a,b){c&&c(a,b)})};d.prototype._setLightsensor=function(b,a){var c=this;this._getLEDStates(function(e,h){e?a&&a(e):c._setLedPaintAndLightsensor(h.ledpaint,b,a)})};d.prototype._setLedPaint=function(b,a){var c=this;this._getLEDStates(function(e,h){e?a&&a(e):c._setLedPaintAndLightsensor(b,
h.lightsensoractive,a)})};d.prototype._setLedPaintAndLightsensor=function(b,a,c){this._doJsonRequest("POST","/external",{ledpaint:b,lightsensoractive:a},function(a,b){c&&c(a,b)})};d.prototype.getAllStates=function(b){this._getAllStates(function(a,c){a?b&&b(a):(c&&(c.ledpaint=c.ledpaint?"on":"off",c.lightsensoractive=c.lightsensoractive?"on":"off",c.invert=c.invert?"on":"off"),b&&b(null,c))})};d.prototype._getAllStates=function(b){var a=function(a){[].slice.call(arguments,1).forEach(function(b){for(var c in b)a[c]=
b[c]});return a},c=this;this._getBlindStates(function(e,h){e?b&&b(e):c._getLEDStates(function(c,e){if(c)b&&b(c);else{var d=a({},e,h);b&&b(null,d)}})})};d.prototype._getLEDStates=function(b){this._doJsonRequest("GET","/external",null,function(a,c){b&&b(a,c)})};d.prototype._getBlindStates=function(b){this._doJsonRequest("GET","/blind",null,function(a,c){b&&b(a,c)})};d.prototype._doJsonRequest=function(b,a,c,e){try{var d=c?JSON.stringify(c):null;this._doRequest(b,a,d,function(a,b){if(a)e&&e(a);else try{var c=
null;b&&(c=JSON.parse(b));e&&e(null,c)}catch(d){e&&e(d)}})}catch(f){e&&e(f)}};d.prototype._doRequest=function(b,a,c,e){b={host:this.address,port:this.port,path:a,method:b,headers:{"Content-Type":"application/json"}};b=require("http").request(b,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){e&&e(null,b)})});c&&b.write(c);b.setTimeout&&b.setTimeout(2E3,function(){e&&e(Error("http request timeout"))});b.on("error",function(a){e&&e(a)});b.end()};d.prototype.executeCommand=
function(b,a,c){console.log("======> command",a);if(a){var e=this,d,f;0<=a&&100>=a?this._getBlindStates(function(b,d){b?c&&c(b):e._setInvertAndBlindOpacity(d.invert,0==d.invert?100-a:a,c)}):-1!=a.indexOf("lightsensoractive")||-1!=a.indexOf("ledpaint")?(b=a.split("_"),-1!=a.indexOf("lightsensoractive")?(f=parseInt(b[1]),d="?"!=b[2]?parseInt(b[2]):0):-1!=a.indexOf("ledpaint")&&(d=parseInt(b[1]),f="?"!=b[2]?parseInt(b[2]):0),this._setLedPaintAndLightsensor(d,f,c)):-1!=a.indexOf("scene")?(b=a.split("_"),
this._setScene(parseInt(b[1]),c)):-1!=a.indexOf("invert")&&(b=a.split("_"),d=parseInt(b[1]),b=parseInt(b[2]),this._setInvertAndBlindOpacity(d,b,c,!0))}else c&&c("missing params")};d.prototype.getStates=function(b,a,c){this._getAllStates(function(c,d){if(!c&&d&&b)for(var f in d)if(d.hasOwnProperty(f))if("opacity"==f){var g=d.opacity;0===d.invert&&(g=100-d.opacity);b.setState(a.id+":opacity",d.opacity);b.setState(a.id+":slider_opacity",g)}else b.setState(a.id+":"+f,d[f])})};d.prototype.executeCommandCreator=
function(b,a,c){if(a&&a.value)switch(a.value){case "invertOn":case "invertOff":b=0;"invertOn"==a.value&&(b=1);this._setInvert(b,c);break;case "ledpaintOn":case "ledpaintOff":b=0;"ledpaintOn"==a.value&&(b=1);this._setLedPaint(b,c);break;case "lightsensorOn":case "lightsensorOff":b=0;"lightsensorOn"==a.value&&(b=1);this._setLightsensor(b,c);break;case "doScene":if("undefined"==typeof a.ext||null==a.ext){c&&c("command ext invalid");break}a=parseInt(a.ext);1>a&&(a=1);6<a&&(a=6);this._setScene(a,c);break;
case "moveTo":if("undefined"==typeof a.ext||null==a.ext){c&&c("command ext invalid");break}a=parseInt(a.ext);0>a&&(a=0);100<a&&(a=100);this._setBlindPosition(a,c);break;default:c&&c(Error("unknown command"))}else c&&c(Error("command json format invalid"))};d.prototype.getStatesCreator=function(b,a,c){this._getAllStates(function(b,d){if(b)c&&c(b);else{for(var f=[],g=0;g<a.length;g++)if(a[g]&&a[g].id){var k="?";a[g].status&&a[g].status.value&&(k=d[a[g].status.value],"undefined"!=typeof k&&null!=k&&
f.push({id:a[g].id,status:k}))}c&&c(null,f)}})};d.prototype.getSingleDeviceStatesCreator=function(b,a,c,d){this.getAllStates(function(a,b){d&&d(a,b)})};d.prototype.toJSON=function(){return{sys:"rehau",type:"gauzy",address:this.address,port:this.port}};d.prototype.equalsTo=function(b){return b&&b instanceof d?this.address==b.address&&this.port==b.port:!1};return d}();
xnm.aio.rehau.DM=function(){var d=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};d.prototype=Error();d.prototype.name="RehauDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var b={gauzy:{command:[{type:"enum",name:"invert on",ref:{value:"invertOn"}},{type:"enum",name:"invert off",ref:{value:"invertOff"}},{type:"int",name:"move to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100",scale:"5"}},{type:"enum",name:"LED-Paint on",
ref:{value:"ledpaintOn"}},{type:"enum",name:"LED-Paint off",ref:{value:"ledpaintOff"}},{type:"enum",name:"activate light sensor",ref:{value:"lightsensorOn"}},{type:"enum",name:"deactivate light sensor",ref:{value:"lightsensorOff"}},{type:"int",name:"do scene",ref:{value:"doScene",ext:"%d",extMeta:"1-6",scale:"1"}}],status:[{type:"int",name:"position",ref:{value:"position",extMeta:"0-100",scale:"5"}},{type:"enum",name:"invert",ref:{value:"invert",options:["on","off"]}},{type:"enum",name:"LED-Paint",
ref:{value:"ledpaint",options:["on","off"]}},{type:"enum",name:"light sensor",ref:{value:"lightsensoractive",options:["on","off"]}}]}};return{SYS:"rehau",getIPDeviceType:function(){return[{sys:this.SYS,name:"Gauzy Scheibe",type:"gauzy"}]},createDevice:function(a,b,e){b=d.ERROR_CODE;a?a.address?e(null,a):e(new d(b.INVALID,"address is invalid")):e(new d(b.INVALID,"info is invalid"))},updateDevice:function(a,b,e){b=d.ERROR_CODE;a?a.address?e(null,a):e(new d(b.INVALID,"address is invalid")):e(new d(b.INVALID,
"info is invalid"))},deleteDevice:function(a,b,d){d()},applyUIFilter:function(a,b,d){var h=function(a,b,c){var d=[];a.forEach(function(a){if("root"==a.type){a=JSON.parse(JSON.stringify(a));var e=h(a.children,b,c);e&&0<e.length&&(a.children=e,d.push(a))}else{e=c.elems;if("*"==e)e=!0;else{for(var f=!1,g=0;g<e.length;g++)if(e[g]==a.type){f=!0;break}e=f}e&&(a=JSON.parse(JSON.stringify(a)),d.push(a))}});return d},f=function(a,b){var c=[],f=xnm.aio.pioneer.DM.getCommandStatusMap(a,d);if(f){var g=[];switch(b.catagory){case "command":f.command&&
(g=h(f.command,a,b));break;case "status":f.status&&(g=h(f.status,a,b))}c=c.concat(g)}return c};if(!a.sys)return null;var g=JSON.parse(JSON.stringify(a)),k=null;switch(b.catagory){case "command":k=f(a,b);g.command=k;break;case "status":k=f(a,b);g.status=k;break;default:return null}return k&&0!=k.length?g:null},getCommandStatusMap:function(a){return a&&a.type?b[a.type]:null}}}();
xnm.aio.rehau.Handler=function(){var d=function(){};d.prototype.devicemanager=xnm.aio.rehau.DM;d.prototype.Gauzy=xnm.aio.rehau.Gauzy;d.prototype.registModule=function(b){b.register("rehau","rehau")};d.prototype.resolveDevice=function(b){if(!b)return null;switch(b.type){case "gauzy":return b.address?new this.Gauzy(b.address,b.port):null;default:return null}};d.prototype.getDeviceCommands=function(b,a){var c=this.devicemanager.applyUIFilter(b,{catagory:"command",elems:"*"}),c=c?c.command:[];a&&a(null,
c)};d.prototype.getDeviceStatus=function(b,a){var c=this.devicemanager.applyUIFilter(b,{catagory:"status",elems:"*"}),c=c?c.status:[];a&&a(null,c)};d.prototype.doCommand=function(b,a,c){var d=this.resolveDevice(b);d?d.executeCommandCreator(b,a,function(a){c&&c(a)}):c&&c(Error("device json format invalid"))};d.prototype.doStatus=function(b,a,c,d){var h=this.resolveDevice(a);h?h.getStatesCreator(null,[{id:b,device:a,status:c}],function(a,b){a?d&&d(a):d&&d(null,b[0])}):d&&d(Error("device json format invalid"))};
d.prototype.getDevice=function(b){return new xnm.aio.rehau.Gauzy(b.address,b.port)};return d}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.rehau.Handler);
