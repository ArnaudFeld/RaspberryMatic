var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.ip=xnm.aio.ip||{};
xnm.aio.ip.Http=function(){var d=function(a,b){this._options=a;this._deviceInfo=b};d.prototype.executeCommandCreator=function(a,b,c){this.executeCommand(b.value,function(a){c&&c(a)})};d.prototype.executeCommand=function(a,b){if(a)if(this._options&&this._options.ip){var c=this._getPort();if(c){var e=this._getMethod();if(e){var d=this._buildControlUrl(a);if(d){var k=this._buildPostData(a);this._doRequest({host:this._options.ip,port:c,path:d,method:e,username:this._options.username,password:this._options.password},
k,function(a,c){b&&b(a,c)})}else b&&b(Error("build control url error"))}else b&&b(Error("build method error"))}else b&&b(Error("build port error"))}else b&&b(Error("ip is empty"));else b&&b(Error("command is empty"))};d.prototype._getPort=function(){if(this._options&&this._options.port&&0<this._options.port)return this._options.port;if(!this._deviceInfo||!this._deviceInfo.controlport)return 0;var a=parseInt(this._deviceInfo.controlport);return 0>=a?0:a};d.prototype._getMethod=function(){return this._deviceInfo?
this._deviceInfo.controlpostdata?"POST":this._deviceInfo.controlurl?"GET":null:null};d.prototype._buildControlUrl=function(a){if(!this._deviceInfo||!this._deviceInfo.controlurl)return null;var b=xnm.aio.ip.Util._decodeXml(this._deviceInfo.controlurl);a=this._getCommandCode(a);if(!a)return null;a=xnm.aio.ip.Util._decodeXml(a);return b.replace("%@",a)};d.prototype._buildPostData=function(a){if(!this._deviceInfo||!this._deviceInfo.controlpostdata)return null;var b=xnm.aio.ip.Util._decodeXml(this._deviceInfo.controlpostdata);
a=this._getCommandCode(a);if(!a)return null;a=xnm.aio.ip.Util._decodeXml(a);return b.replace("%@",a)};d.prototype._getCommandCode=function(a){if(!a||!this._deviceInfo||!this._deviceInfo.keys)return null;for(var b=0;b<this._deviceInfo.keys.length;b++){var c=this._deviceInfo.keys[b];if(c.id&&c.id==a)return c.code}return null};d.prototype._doRequest=function(a,b,c){var e={host:a.host,port:a.port,path:a.path,method:a.method,headers:{"Content-Type":'text/plain; charset="utf-8"',Connection:"close"}};a.username&&
(a.password||(a.password=""),e.user=a.username,e.password=a.password,e.headers.Authorization="Basic "+(new Buffer(a.username+":"+a.password)).toString("base64"));b&&(e.headers["Content-Length"]=b.length);a=require("http").request(e,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){var e;200!=a.statusCode&&(e=Error("http response:"+a.statusCode));c&&c(e,b)})});if(a.on)a.on("error",function(a){c&&c(a)});b&&a.write(b);a.end()};return d}();
xnm.aio.ip.Tcp=function(){var d=function(a,b){this._options=a;this._deviceInfo=b;this._logger=require("x.logger.js").getLogger("xnm.aio.ip.Tcp")};d.prototype.executeCommandCreator=function(a,b,c){this.executeCommand(b.value,function(a){c&&c(a)})};d.prototype.executeCommand=function(a,b){if(a)if(this._options&&this._options.ip)if(this._getPort()){var c=this._buildTcpData(a);if(c){var e="utf8";switch(this._deviceInfo.tcptype){case "text":case "textnl":case "pioneer":e="utf8";break;case "binary":e="binary",
c=new Buffer(c)}this._doRequest(c,e,function(a){setTimeout(function(){b&&b(a)},150)})}else b&&b(Error("build data return null"))}else b&&b(Error("build port error"));else b&&b(Error("ip is empty"));else b&&b(Error("command is empty"))};d.prototype._getPort=function(){if(this._options&&this._options.port&&0<this._options.port)return this._options.port;if(!this._deviceInfo||!this._deviceInfo.controlport)return 0;var a=parseInt(this._deviceInfo.controlport);return 0>=a?0:a};d.prototype._buildTcpData=
function(a){if(!this._deviceInfo||!this._deviceInfo.tcptype)return null;a=this._getCommandCode(a);if(!a)return null;a=xnm.aio.ip.Util._decodeXml(a);switch(this._deviceInfo.tcptype){case "text":return a;case "textnl":case "pioneer":return a+"\r";case "binary":return xnm.aio.ip.Util._hex2arr(a);default:return null}};d.prototype._getCommandCode=function(a){if(!a||!this._deviceInfo||!this._deviceInfo.keys)return null;for(var b=0;b<this._deviceInfo.keys.length;b++){var c=this._deviceInfo.keys[b];if(c.id&&
c.id==a)return c.code}return null};d.prototype._doRequest=function(a,b,c){var e=this,d={port:this._options.port,host:this._options.ip},k=!1,h=!1,f=c,g=require("net").connect(d);g.setTimeout(1E3);b&&"binary"!=b&&g.setEncoding(b);this._logger.log("trace","try to connect tcp to:"+e._options.ip);g.on("connect",function(){e._logger.log("trace","tcp connected to:"+e._options.ip);e._logger.log("trace","write data:"+a.toString());k=!0;g.write(a,b);h=!0});g.on("data",function(a){e._logger.log("trace","receive from tcp:"+
e._options.ip+" data:"+a);h&&g.end()});g.on("error",function(a){k?(e._logger.log("trace","tcp:"+e._options.ip+" error:"+a.message),g.end()):e._logger.log("trace","tcp:"+e._options.ip+" connection error:"+a.message);f&&(f(a),f=null)});g.on("timeout",function(){k?(e._logger.log("trace","tcp:"+e._options.ip+" data timeout"),g.end(),f&&(f(),f=null)):(e._logger.log("trace","tcp:"+e._options.ip+" connection timeout"),g.end(),f&&(f(Error("connection timeout")),f=null))});g.on("close",function(){e._logger.log("trace",
"tcp:"+e._options.ip+" close socket");f&&(f(),f=null)});g._doConnect&&"function"==typeof g._doConnect&&g._doConnect()};return d}();
xnm.aio.ip.Udp=function(){var d=function(a,b){this._options=a;this._deviceInfo=b;this._logger=require("x.logger.js").getLogger("xnm.aio.ip.Udp")};d.prototype.executeCommandCreator=function(a,b,c){this.executeCommand(b.value,function(a){c&&c(a)})};d.prototype.executeCommand=function(a,b){if(a)if(this._options&&this._options.ip)if(this._getPort()){var c=this._buildUdpData(a);c?this._doRequest(new Buffer(c),function(a){b&&b(a)}):b&&b(Error("build data return null"))}else b&&b(Error("build port error"));
else b&&b(Error("ip is empty"));else b&&b(Error("command is empty"))};d.prototype._getPort=function(){if(this._options&&this._options.port&&0<this._options.port)return this._options.port;if(!this._deviceInfo||!this._deviceInfo.controlport)return 0;var a=parseInt(this._deviceInfo.controlport);return 0>=a?0:a};d.prototype._buildUdpData=function(a){if(!this._deviceInfo||!this._deviceInfo.udptype)return null;a=this._getCommandCode(a);if(!a)return null;a=xnm.aio.ip.Util._decodeXml(a);switch(this._deviceInfo.udptype){case "text":return a;
case "textnl":return a+"\r";case "binary":return xnm.aio.ip.Util._hex2arr(a);default:return null}};d.prototype._getCommandCode=function(a){if(!a||!this._deviceInfo||!this._deviceInfo.keys)return null;for(var b=0;b<this._deviceInfo.keys.length;b++){var c=this._deviceInfo.keys[b];if(c.id&&c.id==a)return c.code}return null};d.prototype._doRequest=function(a,b){var c=require("dgram").createSocket("udp4");c.send(a,0,a.length,this._options.port,this._options.ip,function(a){c.close();b&&b(a)})};return d}();
xnm.aio.ip._Proxy=function(){var d=function(a,b){this._options=a;this._deviceInfo=b;this._logger=require("x.logger.js").getLogger("xnm.aio.ip._Proxy")};d.prototype.executeCommandCreator=function(a,b,c){this.executeCommand(b.value,function(a){c&&c(a)})};d.prototype.executeCommand=function(a,b){if(a)if(this._options&&this._options.ip)if(this._getPort()){var c=this._buildData(a);c?this._doRequest(c,function(a){b&&b(a)}):b&&b(Error("build data return null"))}else b&&b(Error("build port error"));else b&&
b(Error("ip is empty"));else b&&b(Error("command is empty"))};d.prototype._getPort=function(){if(this._options&&this._options.port&&0<this._options.port)return this._options.port;if(!this._deviceInfo||!this._deviceInfo.controlport)return 0;var a=parseInt(this._deviceInfo.controlport);return 0>=a?0:a};d.prototype._buildData=function(a){return this._deviceInfo?(a=this._getCommandCode(a))?xnm.aio.ip.Util._decodeXml(a):null:null};d.prototype._getCommandCode=function(a){if(!a||!this._deviceInfo||!this._deviceInfo.keys)return null;
for(var b=0;b<this._deviceInfo.keys.length;b++){var c=this._deviceInfo.keys[b];if(c.id&&c.id==a)return c.code}return null};d.prototype._doRequest=function(a,b){if("samsung_tv"==this._deviceInfo.id){var c=require("xnm.aio.samsung.js").SamsungTV,c=new c(this._options.ip,this._getPort());c._executeCommand(a,function(a){b&&b(a)})}else this._deviceInfo.ircccontrolurl?(new (require("xnm.aio.sony.js").IRCC)(this._options.ip,this._getPort(),this._deviceInfo.ircccontrolurl))._executeCommand(a,function(a){b&&
b(a)}):this._deviceInfo.pnccontrolurl?(c=require("xnm.aio.panasonic.js").TV,c=new c(this._options.ip,this._getPort(),this._deviceInfo.pnccontrolurl),c._executeCommand(a,function(a){b&&b(a)})):"onkyo"==this._deviceInfo.tcptype?(new (require("xnm.aio.onkyo.js").AVReceiver)(this._options.ip,this._getPort())).executeCommand(a,function(a){b&&b(a)}):"lgav"==this._deviceInfo.tcptype?(c=require("xnm.aio.lg.js").BDP,c=new c(this._options.ip,this._getPort()),c._executeCommand(a,function(a){b&&b(a)})):"panasonicbdp"==
this._deviceInfo.tcptype?(c=require("xnm.aio.panasonic.js").BDP,c=new c(this._options.ip,this._getPort()),c._executeCommand(a,function(a){b&&b(a)})):"lgtv"==this._deviceInfo.tcptype?(c=require("xnm.aio.lg.js"),c="lgtv2012"==this._deviceInfo.id?c.TV2012:c.TV,c=new c(this._options.ip,this._getPort(),this._options.authKey),c._executeCommand(a,function(a){b&&b(a)})):"philips2011"==this._deviceInfo.tcptype?(c=require("xnm.aio.philips.js").JointSpaceTV,c=new c(this._options.ip,this._getPort()),c._executeCommand(a,
function(a){b&&b(a)})):b&&b(Error("unknow ip device proxy type"))};return d}();xnm.aio.ip.Util=function(){return{_decodeXml:function(d){return d.replace(/&apos;/g,"'").replace(/&quot;/g,'"').replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&")},_hex2arr:function(d){for(var a=[];2<=d.length;)a.push(parseInt(d.substring(0,2),16)),d=d.substring(2,d.length);return a}}}();
xnm.aio.ip.DM=function(){var d=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};d.prototype=Error();d.prototype.name="IpDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"ip",getIPDeviceType:function(a,b){var c=[];if(a){var d=a.getDevices();if(d)for(var l=0;l<d.length;l++){var k=d[l],h=$(k).getAttributes();if(h&&h.id&&h.name){var f=this._deviceinfoXml2Json($(k)),g=this.getDeviceInfoType(f);g&&(k=
{sys:this.SYS,type:g,id:h.id,name:h.name,port:h.controlport},"proxy"==g&&!h.controlport&&(h=this._getProxyDeviceClass(f))&&(h=new h,k.port=h.port),c.push(k))}}}return c},createDevice:function(a,b,c){b=d.ERROR_CODE;a?a.type?a.id?a.ip?c(null,a):c(new d(b.INVALID,"ip is invalid")):c(new d(b.INVALID,"id is invalid")):c(new d(b.INVALID,"type is invalid")):c(new d(b.INVALID,"info is invalid"))},updateDevice:function(a,b,c){b=d.ERROR_CODE;a?a.type?a.id?a.ip?c(null,a):c(new d(b.INVALID,"ip is invalid")):
c(new d(b.INVALID,"id is invalid")):c(new d(b.INVALID,"type is invalid")):c(new d(b.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){c()},applyUIFilter:function(a,b,c){var d=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},l=function(a,b,c){var f=[];switch(c.catagory){case "command":a.command&&a.command.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),f.push(a))});break;case "status":a.status&&a.status.forEach(function(a){d(c.elems,
a.type)&&(a=JSON.parse(JSON.stringify(a)),f.push(a))})}return f},k=function(a,b){var d=[],e=null;if(e=xnm.aio.ip.DM.getCommandStatusMap(a,c))e=l(e,a,b),d=d.concat(e);return d};if(!a.sys)return null;var h=JSON.parse(JSON.stringify(a)),f=null;switch(b.catagory){case "command":f=k(a,b);h.command=f;break;case "status":f=k(a,b);h.status=f;break;default:return null}return f&&0!=f.length?h:null},getDeviceInfo:function(a,b){if(!a.id||!b)return null;var c;var d=b.find('device[id="'+a.id+'"]');d&&0<d.length&&
(c=d[0]);c=c?$(c):null;return c?this._deviceinfoXml2Json(c):null},getDeviceInfoType:function(a){if("samsung_tv"==a.id||a.ircccontrolurl||a.pnccontrolurl)return"proxy";if(a.tcptype){if("text"==a.tcptype||"textnl"==a.tcptype||"pioneer"==a.tcptype||"binary"==a.tcptype)return"tcp";if("generic"!=a.tcptype)return"proxy"}return a.udptype?"udp":a.controlurl?"http":null},getCommandStatusMap:function(a,b){var c=this.getDeviceInfo(a,b);if(!c)return null;var d={command:[]};if(c.keys)for(var l=0;l<c.keys.length;l++){var k=
c.keys[l];d.command.push({type:"enum",name:k.id,ref:{value:k.id}})}return d},_getProxyDeviceClass:function(a){var b=null;"samsung_tv"==a.id?b=require("xnm.aio.samsung.js").SamsungTV:a.ircccontrolurl?b=require("xnm.aio.sony.js").IRCC:a.pnccontrolurl?b=require("xnm.aio.panasonic.js").TV:"onkyo"==a.tcptype?b=require("xnm.aio.onkyo.js").AVReceiver:"lgav"==a.tcptype?b=require("xnm.aio.lg.js").BDP:"panasonicbdp"==a.tcptype?b=require("xnm.aio.panasonic.js").BDP:"lgtv"==a.tcptype?b=require("xnm.aio.lg.js").TV:
"philips2011"==a.tcptype&&(b=require("xnm.aio.philips.js").JointSpaceTV);return b},_deviceinfoXml2Json:function(a){var b=a.getAttributes(),b=JSON.parse(JSON.stringify(b));a=a.children();for(var c=0;c<a.length;c++){var d=a[c];if(d){var l=$(d).attr("id"),d=$(d).attr("code");l&&d&&(b.keys||(b.keys=[]),b.keys.push({id:l,code:d}))}}return b}}}();
xnm.aio.ip.Handler=function(){var d=function(){};d.prototype.devicemanager=xnm.aio.ip.DM;d.prototype.Http=xnm.aio.ip.Http;d.prototype.Tcp=xnm.aio.ip.Tcp;d.prototype.Udp=xnm.aio.ip.Udp;d.prototype.registModule=function(a){a.register(xnm.aio.ip.DM.SYS,"ip")};d.prototype.resolveDevice=function(a,b){var c=xnm.aio.ip.DM.getDeviceInfo(a,b);if(!c)return null;switch(xnm.aio.ip.DM.getDeviceInfoType(c)){case "http":return new xnm.aio.ip.Http(a,c);case "tcp":return new xnm.aio.ip.Tcp(a,c);case "udp":return new xnm.aio.ip.Udp(a,
c);case "proxy":return new xnm.aio.ip._Proxy(a,c);default:return null}};d.prototype.getDeviceCommands=function(a,b){var c=xnm.aio.cams.DM.applyUIFilter(a,{catagory:"command",elems:"*"}),c=c?c.command:[];b&&b(null,c)};return d}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.ip.Handler);
