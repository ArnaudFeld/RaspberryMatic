var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.heos=xnm.aio.heos||{};
xnm.aio.heos.HEOS=function(){var f=function(e){this._ip=e.ip;this._port=e.port;this._username=e.username;this._password=e.password;this._uuid=e.uuid;this._port||(this._port=1255);this._controller=require("xnm.aio.heos.js").getController()};f.prototype.executeCommandCreator=function(e,d,b){if(e&&e.type)if(d&&d.value){var a=null;if("player"==e.type){if(!e.pid){b&&b(Error("invalid player pid"));return}a=e.pid}else if("group"==e.type){if(!e.gid){b&&b(Error("invalid group gid"));return}a=e.gid}else b&&
b(Error("unknonwn device type"));var c=function(c){!c||-5!=c.code&&-6!=c.code||(c.source="heos");b&&b(c)};switch(d.value){case "play":this.play(a,c);break;case "pause":this.pause(a,c);break;case "stop":this.pause(a,c);break;case "previous":this.previous(a,c);break;case "next":this.next(a,c);break;case "toggleMute":"player"==e.type?this.togglePlayerMute(a,c):this.toggleGroupMute(a,c);break;case "mute":"player"==e.type?this.playerMute(a,!0,c):this.groupMute(a,!0,c);break;case "unmute":"player"==e.type?
this.playerMute(a,!1,c):this.groupMute(a,!1,c);break;case "volume":if("undefined"==typeof d.ext||null==d.ext){b&&b(Error("invalid volume value"));break}d=parseInt(d.ext);if(isNaN(d)){b&&b(Error("invalid volume value"));break}"player"==e.type?this.setPlayerVolume(a,d,c):this.setGroupVolume(a,d,c);break;case "volumeUp":"player"==e.type?this.playerVolumeUp(a,c):this.groupVolumeUp(a,c);break;case "volumeDown":"player"==e.type?this.playerVolumeDown(a,c):this.groupVolumeDown(a,c);break;case "shuffleOn":this.shuffle(a,
"on",c);break;case "shuffleOff":this.shuffle(a,"off",c);break;case "shuffleToggle":this.toggleShuffle(a,c);break;case "repeatOff":this.repeat(a,"off",c);break;case "repeatAll":this.repeat(a,"on_all",c);break;case "repeatOne":this.repeat(a,"on_one",c);break;case "repeatSwitch":this.switchRepeat(a,c);break;case "playUrl":if("undefined"==typeof d.ext||null==d.ext){b&&b(Error("invalid url value"));break}this.playUrl(a,d.ext,c);break;case "clearQueue":this.clearQueue(a,c);break;default:b&&b(Error("unknonw command"))}}else b&&
b(Error("device json invalid"));else b&&b(Error("device json invalid"))};f.prototype.getStatesCreator=function(e,d,b){var a=this,c=function(c,b,g,d){switch(g){case "mute":"player"==c?a.isPlayerMute(b,function(a,l){d(a,l,c,b,g)}):a.isGroupMute(b,function(a,l){d(a,l,c,b,g)});break;case "level":"player"==c?a.getPlayerVolume(b,function(a,l){d(a,l,c,b,g)}):a.getGroupVolume(b,function(a,l){d(a,l,c,b,g)});break;case "shuffle":a.getShuffle(b,function(a,l){d(a,l,c,b,g)});break;case "repeat":a.getRepeat(b,
function(a,l){d(a,l,c,b,g)});break;case "play_state":a.getPlayState(b,function(a,l){d(a,l,c,b,g)});break;case "playing_media":a.getPlayingMedia(b,function(a,l){d(a,l,c,b,g)});break;case "duration":a.getPlayingProgress(b,function(a,l,e){d(a,e,c,b,g)});break;case "cur_pos":a.getPlayingProgress(b,function(a,l,e){d(a,l,c,b,g)})}},g=[],l=function(c,a){for(var b=[],g=0;g<c.length;g++){var d=c[g];if(d&&d.id)if(d.device&&d.device.type&&d.status&&d.status.value){var l=d.device.type,e="player"==l?d.device.pid:
d.device.gid,m=null;switch(d.status.value){case "muted":m="mute";break;case "volume":m="level";break;case "shuffle":m="shuffle";break;case "repeat":m="repeat";break;case "playState":m="play_state";break;case "artist":case "title":case "album":m="playing_media";break;case "duration":case "durationS":m="duration";break;case "position":case "positionS":m="cur_pos"}for(var d=!1,f=0;f<b.length;f++){var u=b[f];u.type==l&&u.id==e&&u.key==m&&(d=!0)}d||b.push({type:l,id:e,key:m})}else a.push({id:d.id,status:"?"})}return b}(d,
g);if(0!=l.length){var m=0,f=function(a,k,v,w,x){if(!a){a=[];for(var t=0;t<d.length;t++){var h=d[t];if(h&&h.id&&h.device&&h.status&&h.status.value){var p="player"==v?h.device.pid:h.device.gid;if(v==h.device.type&&w==p)switch(x){case "mute":"muted"==h.status.value&&(g.push({id:h.id,status:k}),a.push({id:h.id,status:k}));break;case "level":"volume"==h.status.value&&(g.push({id:h.id,status:k}),a.push({id:h.id,status:k}));break;case "shuffle":"shuffle"==h.status.value&&(g.push({id:h.id,status:k?k:"?"}),
a.push({id:h.id,status:k?k:"?"}));break;case "repeat":"repeat"==h.status.value&&(g.push({id:h.id,status:k?k:"?"}),a.push({id:h.id,status:k?k:"?"}));break;case "play_state":"playState"==h.status.value&&(g.push({id:h.id,status:k?k:"?"}),a.push({id:h.id,status:k?k:"?"}));break;case "playing_media":"artist"==h.status.value?(g.push({id:h.id,status:k?k.artist:"?"}),a.push({id:h.id,status:k?k.artist:"?"})):"title"==h.status.value?(g.push({id:h.id,status:k?k.title:"?"}),a.push({id:h.id,status:k?k.title:"?"})):
"album"==h.status.value&&(g.push({id:h.id,status:k?k.album:"?"}),a.push({id:h.id,status:k?k.album:"?"}));break;case "duration":if("durationS"==h.status.value)g.push({id:h.id,status:isNaN(k)?0:Math.round(k/1E3)}),a.push({id:h.id,status:isNaN(k)?0:Math.round(k/1E3)});else if("duration"==h.status.value)if(null==k)g.push({id:h.id,status:"?"}),a.push({id:h.id,status:"?"});else{var p=Math.floor(k/6E4),q=Math.round(k%6E4/1E3),n=q+"";2!=n.length&&(n="0"+q);g.push({id:h.id,status:p+":"+n});a.push({id:h.id,
status:p+":"+n})}break;case "cur_pos":"positionS"==h.status.value?(g.push({id:h.id,status:isNaN(k)?0:Math.round(k/1E3)}),a.push({id:h.id,status:isNaN(k)?0:Math.round(k/1E3)})):"position"==h.status.value&&(null==k?(g.push({id:h.id,status:"?"}),a.push({id:h.id,status:"?"})):(p=Math.floor(k/6E4),q=Math.round(k%6E4/1E3),n=q+"",2!=n.length&&(n="0"+q),g.push({id:h.id,status:p+":"+n}),a.push({id:h.id,status:p+":"+n})))}}}0<a.length&&"undefined"!=typeof e&&null!=e&&"undefined"!=typeof e.reportStates&&null!=
e.reportStates&&e.reportStates(null,a)}m++;m<l.length?c(l[m].type,l[m].id,l[m].key,f):b&&b(null,g)};c(l[m].type,l[m].id,l[m].key,f)}};f.prototype.play=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.setPlayerState(e,"play",d)};f.prototype.pause=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.setPlayerState(e,"pause",d)};f.prototype.stop=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());
this._controller.setPlayerState(e,"stop",d)};f.prototype.previous=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.playerPlayPrevious(e,d)};f.prototype.next=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.playerPlayNext(e,d)};f.prototype.playerMute=function(e,d,b){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.setPlayerMute(e,d?"on":"off",b)};f.prototype.togglePlayerMute=
function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.togglePlayerMute(e,d)};f.prototype.groupMute=function(e,d,b){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.setGroupMute(e,d?"on":"off",b)};f.prototype.toggleGroupMute=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.toggleGroupMute(e,d)};f.prototype.setPlayerVolume=function(e,d,b){this._controller.isIdle()&&this._controller.open(this.toJSON());
100<d&&(d=100);0>d&&(d=0);this._controller.setPlayerVolume(e,d,b)};f.prototype.setGroupVolume=function(e,d,b){this._controller.isIdle()&&this._controller.open(this.toJSON());100<d&&(d=100);0>d&&(d=0);this._controller.setGroupVolume(e,d,b)};f.prototype.playerVolumeUp=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.playerVolumeUp(e,null,d)};f.prototype.playerVolumeDown=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.playerVolumeDown(e,
null,d)};f.prototype.clearQueue=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.playerClearQueue(e,d)};f.prototype.groupVolumeUp=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.groupVolumeUp(e,null,d)};f.prototype.groupVolumeDown=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.groupVolumeDown(e,null,d)};f.prototype.shuffle=function(e,d,b){this._controller.isIdle()&&
this._controller.open(this.toJSON());this._controller.setPlayerMode(e,null,d,b)};f.prototype.toggleShuffle=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());var b=this;this._controller.getPlayerMode(e,function(a,c,g){a?d&&d(a):(a="off","off"==g&&(a="on"),b._controller.setPlayerMode(e,null,a,d))})};f.prototype.repeat=function(e,d,b){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.setPlayerMode(e,d,null,b)};f.prototype.switchRepeat=function(e,
d){this._controller.isIdle()&&this._controller.open(this.toJSON());var b=this;this._controller.getPlayerMode(e,function(a,c,g){a?d&&d(a):(a="off","off"==c?a="on_all":"on_all"==c&&(a="on_one"),b._controller.setPlayerMode(e,a,null,d))})};f.prototype.getShuffle=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayerMode(e,function(b,a,c){d&&d(b,c)})};f.prototype.getRepeat=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayerMode(e,
function(b,a,c){b?d&&d(b):(c=null,"on_all"==a?c="all":"on_one"==a?c="one":"off"==a&&(c="off"),d&&d(b,c))})};f.prototype.getPlayState=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayerState(e,function(b,a){d&&d(b,a)})};f.prototype.getPlayingMedia=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayerNowPlayingMedia(e,function(b,a){if(b)d&&d(b);else{var c=null;a&&(c=JSON.parse(JSON.stringify(a)),
c.title=a.song);d&&d(null,c)}})};f.prototype.getPlayingProgress=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayerNowPlayingProgress(e,function(b,a,c){d&&d(b,a,c)})};f.prototype.getPlayers=function(e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayers(e)};f.prototype.isPlayerMute=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayerMute(e,function(b,a){if(b)d&&
d(b);else{var c=null;"on"==a?c=!0:"off"==a&&(c=!1);d&&d(null,c)}})};f.prototype.getPlayerVolume=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getPlayerVolume(e,function(b,a){d&&d(b,a)})};f.prototype.getGroups=function(e){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getGroups(e)};f.prototype.isGroupMute=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getGroupMute(e,function(b,
a){b?d&&d(b):d&&d(null,"on"==a?!0:!1)})};f.prototype.getGroupVolume=function(e,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getGroupVolume(e,function(b,a){d&&d(b,a)})};f.prototype.playUrl=function(e,d,b){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.playerPlayURL(e,d,b)};f.prototype.toJSON=function(){return{sys:"heos",ip:this._ip,port:this._port,username:this._username,password:this._password,uuid:this._uuid}};f.prototype.equalsTo=
function(e){return e&&e instanceof f?this.ip==e.ip&&this.port==e.port:!1};f.parseJSON=function(e){return e&&e.ip?new f(e):null};return f}();
xnm.aio.heos._Controller=function(){var f=function(){this._stateExpiredTime=300;this._errorStateExpiredTime=10;this._playerBuffer={};this._groupBuffer={}};f.prototype.reset=function(){this._playerBuffer={};this._groupBuffer={}};f.prototype.removePlayerState=function(b,a){var c=this._playerBuffer[b];c||(this._playerBuffer[b]={},c=this._playerBuffer[b]);c[a]=null};f.prototype.putPlayerState=function(b,a,c){var g=this._playerBuffer[b];g||(this._playerBuffer[b]={},g=this._playerBuffer[b]);b=g[a];b||(g[a]=
{},b=g[a]);b.update=Math.round((new Date).getTime()/1E3);b.value=c};f.prototype.getPlayerState=function(b,a){var c=this._playerBuffer[b];c||(this._playerBuffer[b]={},c=this._playerBuffer[b]);var g=c[a];g||(c[a]={},g=c[a]);if("cur_pos"==a||"duration"==a)return g.value?g.value:null;c=Math.round((new Date).getTime()/1E3);if(!g.update||null==g.value&&c-g.update>this._errorStateExpiredTime||c-g.update>this._stateExpiredTime)g.update=c,g.value=null;else return g.value};f.prototype.getPlayerStateRaw=function(b,
a){var c=this._playerBuffer[b];c||(this._playerBuffer[b]={},c=this._playerBuffer[b]);var g=c[a];g||(c[a]={},g=c[a]);return g.value};f.prototype.removeGroupState=function(b,a){var c=this._groupBuffer[b];c||(this._groupBuffer[b]={},c=this._groupBuffer[b]);c[a]=null};f.prototype.putGroupState=function(b,a,c){var g=this._groupBuffer[b];g||(this._groupBuffer[b]={},g=this._groupBuffer[b]);b=g[a];b||(g[a]={},b=g[a]);b.update=Math.round((new Date).getTime()/1E3);b.value=c};f.prototype.getGroupState=function(b,
a){var c=this._groupBuffer[b];c||(this._groupBuffer[b]={},c=this._groupBuffer[b]);var g=c[a];g||(c[a]={},g=c[a]);c=Math.round((new Date).getTime()/1E3);if(!g.update||null==g.value&&c-g.update>this._errorStateExpiredTime||c-g.update>this._stateExpiredTime)g.update=c,g.value=null;else return g.value};f.prototype.getGroupStateRaw=function(b,a){var c=this._groupBuffer[b];c||(this._groupBuffer[b]={},c=this._groupBuffer[b]);var g=c[a];g||(c[a]={},g=c[a]);return g.value};var e=function(){var b=function(a){this._controller=
a};b.prototype.getPlayers=function(a){this._doRequest({path:"player/get_players"},null,function(c,b,d){a&&a(c,d)})};b.prototype.getPlayerState=function(a,c){this._doRequest({path:"player/get_play_state",attributes:{pid:a}},null,function(a,b){a?c&&c(a):b&&"undefined"!=typeof b.state&&null!=b.state?c&&c(null,b.state):c&&c(Error("invalid get player state reponse"))})};b.prototype.setPlayerState=function(a,c,b){this._doRequest({path:"player/set_play_state",attributes:{pid:a,state:c}},null,function(c,
a){c?b&&b(c):a&&"undefined"!=typeof a.state&&null!=a.state?b&&b(null,a.state):b&&b(Error("invalid get player state reponse"))})};b.prototype.getPlayerNowPlayingMedia=function(a,c){this._doRequest({path:"player/get_now_playing_media",attributes:{pid:a}},null,function(a,b,d){a?c&&c(a):d?c&&c(null,d):c&&c(Error("invalid now playing media reponse"))})};b.prototype.getPlayerVolume=function(a,c){this._doRequest({path:"player/get_volume",attributes:{pid:a}},null,function(a,b){if(a)c&&c(a);else if(b&&"undefined"!=
typeof b.level&&null!=b.level){var d=parseInt(b.level);isNaN(d)?c&&c(Error("invalid get player volume reponse")):c&&c(null,d)}else c&&c(Error("invalid get player volume reponse"))})};b.prototype.setPlayerVolume=function(a,c,b){this._doRequest({path:"player/set_volume",attributes:{pid:a,level:c}},null,function(c,a){if(c)b&&b(c);else if(a&&"undefined"!=typeof a.level&&null!=a.level){var d=parseInt(a.level);isNaN(d)?b&&b(Error("invalid set player volume reponse")):b&&b(null,d)}else b&&b(Error("invalid set player volume reponse"))})};
b.prototype.playerVolumeUp=function(a,c,b){a={path:"player/volume_up",attributes:{pid:a}};c&&(a.attributes.step=c);this._doRequest(a,null,function(c,a){if(c)b&&b(c);else if(a&&"undefined"!=typeof a.step&&null!=a.step){var d=parseInt(a.step);isNaN(d)?b&&b(Error("invalid player volume up reponse")):b&&b(null,d)}else b&&b(Error("invalid player volume up reponse"))})};b.prototype.playerVolumeDown=function(a,c,b){a={path:"player/volume_down",attributes:{pid:a}};c&&(a.attributes.step=c);this._doRequest(a,
null,function(c,a){if(c)b&&b(c);else if(a&&"undefined"!=typeof a.step&&null!=a.step){var d=parseInt(a.step);isNaN(d)?b&&b(Error("invalid player volume down reponse")):b&&b(null,d)}else b&&b(Error("invalid player volume down reponse"))})};b.prototype.getPlayerMute=function(a,c){this._doRequest({path:"player/get_mute",attributes:{pid:a}},null,function(a,b){a?c&&c(a):b&&b.state?c&&c(null,b.state):c&&c(Error("invalid get player mute reponse"))})};b.prototype.setPlayerMute=function(a,c,b){this._doRequest({path:"player/set_mute",
attributes:{pid:a,state:c}},null,function(c,a){c?b&&b(c):a&&a.state?b&&b(null,a.state):b&&b(Error("invalid set player mute reponse"))})};b.prototype.togglePlayerMute=function(a,c){this._doRequest({path:"player/toggle_mute",attributes:{pid:a}},null,function(a,b){a?c&&c(a):c&&c(null)})};b.prototype.getPlayerMode=function(a,c){this._doRequest({path:"player/get_play_mode",attributes:{pid:a}},null,function(a,b){a?c&&c(a):b&&b.repeat&&b.shuffle?c&&c(null,b.repeat,b.shuffle):c&&c(Error("invalid get player mute reponse"))})};
b.prototype.setPlayerMode=function(a,c,b,d){a={path:"player/set_play_mode",attributes:{pid:a}};c&&(a.attributes.repeat=c);b&&(a.attributes.shuffle=b);this._doRequest(a,null,function(c,a){c?d&&d(c):a&&(a.repeat||a.shuffle)?d&&d(null,a.repeat,a.shuffle):d&&d(Error("invalid set player mode reponse"))})};b.prototype.playerClearQueue=function(a,c){this._doRequest({path:"player/clear_queue",attributes:{pid:a}},null,function(a){c&&c(a)})};b.prototype.playerPlayNext=function(a,c){this._doRequest({path:"player/play_next",
attributes:{pid:a}},null,function(a){c&&c(a)})};b.prototype.playerPlayPrevious=function(a,c){this._doRequest({path:"player/play_previous",attributes:{pid:a}},null,function(a){c&&c(a)})};b.prototype.getGroups=function(a){this._doRequest({path:"player/get_groups"},null,function(c,b,d){a&&a(c,d)})};b.prototype.getGroupVolume=function(a,c){this._doRequest({path:"group/get_volume",attributes:{gid:a}},null,function(a,b){if(a)c&&c(a);else if(b&&"undefined"!=typeof b.level&&null!=b.level){var d=parseInt(b.level);
isNaN(d)?c&&c(Error("invalid get group volume reponse")):c&&c(null,d)}else c&&c(Error("invalid get group volume reponse"))})};b.prototype.setGroupVolume=function(a,c,b){this._doRequest({path:"group/set_volume",attributes:{gid:a,level:c}},null,function(c,a){if(c)b&&b(c);else if(a&&"undefined"!=typeof a.level&&null!=a.level){var d=parseInt(a.level);isNaN(d)?b&&b(Error("invalid set group volume reponse")):b&&b(null,d)}else b&&b(Error("invalid set group volume reponse"))})};b.prototype.groupVolumeUp=
function(a,c,b){a={path:"group/volume_up",attributes:{gid:a}};c&&(a.attributes.step=c);this._doRequest(a,null,function(c,a){if(c)b&&b(c);else if(a&&"undefined"!=typeof a.step&&null!=a.step){var d=parseInt(a.step);isNaN(d)?b&&b(Error("invalid group volume up reponse")):b&&b(null,d)}else b&&b(Error("invalid group volume up reponse"))})};b.prototype.groupVolumeDown=function(a,c,b){a={path:"group/volume_down",attributes:{gid:a}};c&&(a.attributes.step=c);this._doRequest(a,null,function(c,a){if(c)b&&b(c);
else if(a&&"undefined"!=typeof a.step&&null!=a.step){var d=parseInt(a.step);isNaN(d)?b&&b(Error("invalid group volume down reponse")):b&&b(null,d)}else b&&b(Error("invalid group volume down reponse"))})};b.prototype.getGroupMute=function(a,c){this._doRequest({path:"group/get_mute",attributes:{gid:a}},null,function(a,b){a?c&&c(a):b&&b.state?c&&c(null,b.state):c&&c(Error("invalid get group mute reponse"))})};b.prototype.setGroupMute=function(a,c,b){this._doRequest({path:"group/set_mute",attributes:{gid:a,
state:c}},null,function(a,c){a?b&&b(a):c&&c.state?b&&b(null,c.state):b&&b(Error("invalid set group mute reponse"))})};b.prototype.toggleGroupMute=function(a,c){this._doRequest({path:"group/toggle_mute",attributes:{gid:a}},null,function(a,b){a?c&&c(a):c&&c(null)})};b.prototype.getMusicSources=function(a){this._doRequest({path:"browse/get_music_sources"},null,function(c,b,d){c?a&&a(c):a&&a(null,d)})};b.prototype.browserSource=function(a,c,b,d,e){a={path:"browse/browse",attributes:{sid:a}};c&&(a.attributes.id=
c);b&&(a.attributes.scid=b);d&&(a.attributes.range=d);this._doRequest(a,null,function(a,c,b,d){a?e&&e(a):e&&e(null,c,b,d)})};b.prototype.playerPlayURL=function(a,c,b){this._doRequest({path:"browse/play_stream",attributes:{pid:a,url:c}},null,function(a,c){a?b&&b(a):b&&b(null,c)})};b.prototype._doRequest=function(a,c,b){this._controller._sendCommand(a,c,function(a,c){a?b(a):b(null,c.message,c.payload,c.options)})};return b}(),d=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.heos._Controller");
var b=this;this._api=new e(this);this._session=new xnm.aio.heos._Session;this._session.on("open",function(){b._state="OPEN";b._logger.log("trace","session opened");b._emitEvent("open")});this._session.on("close",function(){b._state="IDLE";b._reset();b._logger.log("trace","session closed");b._emitEvent("close")});this._session.on("error",function(a){b._state="CONNECT";b._logger.log("trace","session error:"+a.message);b._reset()});this._session.on("event",function(a){b._logger.log("trace","receive session event:"+
JSON.stringify(a));b._processHeosEvent(a)});this._state="IDLE";this._stateBuffer=new f;this._listeners={}};d.prototype.on=function(b,a){b&&a&&(this._listeners[b]||(this._listeners[b]=[]),-1==this._listeners[b].indexOf(a)&&this._listeners[b].push(a))};d.prototype.off=function(b,a){if(b&&a&&this._listeners[b]){var c=this._listeners[b].indexOf(a);-1!=c&&this._listeners[b].splice(c,1)}};d.prototype.open=function(b){"IDLE"==this._state&&(this._logger.log("trace","open session"),this._state="CONNECT",this._session.open(b))};
d.prototype.close=function(){"IDLE"!=this._state&&(this._logger.log("trace","close session"),this._state="CLOSED",this._session.close())};d.prototype.isOpen=function(){return"OPEN"==this._state};d.prototype.isIdle=function(){return"IDLE"==this._state};d.prototype.getPlayers=function(b){this._api.getPlayers(b)};d.prototype.getPlayerState=function(b,a){var c=this._getBufferedState("player",b,"play_state");if("undefined"!=typeof c)a&&a(null,c);else{var d=this;this._api.getPlayerState(b,function(c,e){!c||
-5!=c.code&&-6!=c.code?d._putBufferedState("player",b,"play_state",c?null:e):d._removeBufferedState("player",b,"play_state");a&&a(c,e)})}};d.prototype.setPlayerState=function(b,a,c){var d=this;this._api.setPlayerState(b,a,function(a,e){a||d._putBufferedState("player",b,"play_state",e);c&&c(a,e)})};d.prototype.getPlayerNowPlayingMedia=function(b,a){var c=this._getBufferedState("player",b,"playing_media");if("undefined"!=typeof c)a&&a(null,c);else{var d=this;this._api.getPlayerNowPlayingMedia(b,function(c,
e){!c||-5!=c.code&&-6!=c.code?d._putBufferedState("player",b,"playing_media",c?null:e):d._removeBufferedState("player",b,"playing_media");a&&a(c,e)})}};d.prototype.getPlayerVolume=function(b,a){var c=this._getBufferedState("player",b,"level");if("undefined"!=typeof c)a&&a(null,c);else{var d=this;this._api.getPlayerVolume(b,function(c,e){!c||-5!=c.code&&-6!=c.code?d._putBufferedState("player",b,"level",c?null:e):d._removeBufferedState("player",b,"level");a&&a(c,e)})}};d.prototype.setPlayerVolume=function(b,
a,c){var d=this;this._api.setPlayerVolume(b,a,function(a,e){a||d._putBufferedState("player",b,"level",e);c&&c(a,e)})};d.prototype.playerVolumeUp=function(b,a,c){var d=this;this._api.playerVolumeUp(b,a,function(a,e){if(!a){var f=d._stateBuffer.getPlayerStateRaw(b,"level");"undefined"!=typeof f&&null!=f&&(f+=e,100<f&&(f=100),d._putBufferedState("player",b,"level",f))}c&&c(a,e)})};d.prototype.playerVolumeDown=function(b,a,c){var d=this;this._api.playerVolumeDown(b,a,function(a,e){if(!a){var f=d._stateBuffer.getPlayerStateRaw(b,
"level");"undefined"!=typeof f&&null!=f&&(f-=e,0>f&&(f=0),d._putBufferedState("player",b,"level",f))}c&&c(a,e)})};d.prototype.getPlayerMute=function(b,a){var c=this._getBufferedState("player",b,"mute");if("undefined"!=typeof c)a&&a(null,c);else{var d=this;this._api.getPlayerMute(b,function(c,e){!c||-5!=c.code&&-6!=c.code?d._putBufferedState("player",b,"mute",c?null:e):d._removeBufferedState("player",b,"mute");a&&a(c,e)})}};d.prototype.setPlayerMute=function(b,a,c){var d=this;this._api.setPlayerMute(b,
a,function(a,e){a||d._putBufferedState("player",b,"mute",e);c&&c(a,e)})};d.prototype.togglePlayerMute=function(b,a){var c=this;this._api.togglePlayerMute(b,function(d){if(!d){var e=c._stateBuffer.getPlayerStateRaw(b,"mute");"undefined"!=typeof e&&null!=e&&c._putBufferedState("player",b,"mute","on"==e?"off":"on")}a&&a(d)})};d.prototype.getPlayerMode=function(b,a){var c=this._getBufferedState("player",b,"repeat"),d=this._getBufferedState("player",b,"shuffle");if("undefined"!=typeof c&&"undefined"!=
typeof d)a&&a(null,c,d);else{var e=this;this._api.getPlayerMode(b,function(c,d,g){!c||-5!=c.code&&-6!=c.code?(e._putBufferedState("player",b,"repeat",c?null:d),e._putBufferedState("player",b,"shuffle",c?null:g)):(e._removeBufferedState("player",b,"repeat"),e._removeBufferedState("player",b,"shuffle"));a&&a(c,d,g)})}};d.prototype.getPlayerNowPlayingProgress=function(b,a){var c=this._getBufferedState("player",b,"cur_pos"),d=this._getBufferedState("player",b,"duration");a&&a(null,c,d)};d.prototype.getGroups=
function(b){this._api.getGroups(b)};d.prototype.setPlayerMode=function(b,a,c,d){var e=this;this._api.setPlayerMode(b,a,c,function(c,a,f){c||e._putBufferedState("player",b,"repeat",a);c||e._putBufferedState("player",b,"shuffle",f);d&&d(c,a,f)})};d.prototype.playerClearQueue=function(b,a){this._api.playerClearQueue(b,function(c){a&&a(c)})};d.prototype.playerPlayNext=function(b,a){this._api.playerPlayNext(b,function(c){a&&a(c)})};d.prototype.playerPlayPrevious=function(b,a){this._api.playerPlayPrevious(b,
function(c){a&&a(c)})};d.prototype.getGroupVolume=function(b,a){var c=this._getBufferedState("group",b,"level");if("undefined"!=typeof c)a&&a(null,c);else{var d=this;this._api.getGroupVolume(b,function(c,e){!c||-5!=c.code&&-6!=c.code?d._putBufferedState("group",b,"level",c?null:e):d._removeBufferedState("group",b,"level");a&&a(c,e)})}};d.prototype.setGroupVolume=function(b,a,c){var d=this;this._api.setGroupVolume(b,a,function(a,e){a||d._putBufferedState("group",b,"level",e);c&&c(a,e)})};d.prototype.groupVolumeUp=
function(b,a,c){var d=this;this._api.groupVolumeUp(b,a,function(a,e){if(!a){var f=d._stateBuffer.getGroupStateRaw(b,"level");"undefined"!=typeof f&&null!=f&&(f+=e,100<f&&(f=100),d._putBufferedState("group",b,"level",f))}c&&c(a,e)})};d.prototype.groupVolumeDown=function(b,a,c){var d=this;this._api.groupVolumeDown(b,a,function(a,e){if(!a){var f=d._stateBuffer.getGroupStateRaw(b,"level");"undefined"!=typeof f&&null!=f&&(f-=e,0>f&&(f=0),d._putBufferedState("group",b,"level",f))}c&&c(a,e)})};d.prototype.getGroupMute=
function(b,a){var c=this._getBufferedState("group",b,"mute");if("undefined"!=typeof c)a&&a(null,c);else{var d=this;this._api.getGroupMute(b,function(c,e){!c||-5!=c.code&&-6!=c.code?d._putBufferedState("group",b,"mute",c?null:e):d._removeBufferedState("group",b,"mute");a&&a(c,e)})}};d.prototype.setGroupMute=function(b,a,c){var d=this;this._api.setGroupMute(b,a,function(a,e){a||d._putBufferedState("group",b,"mute",e);c&&c(a,e)})};d.prototype.toggleGroupMute=function(b,a){var c=this;this._api.toggleGroupMute(b,
function(d){if(!d){var e=c._stateBuffer.getGroupStateRaw(b,"mute");"undefined"!=typeof e&&null!=e&&c._putBufferedState("group",b,"mute","on"==e?"off":"on")}a&&a(d)})};d.prototype.getMusicSources=function(b){this._api.getMusicSources(function(a,c){b&&b(a,c)})};d.prototype.browserSource=function(b,a,c,d,e){this._api.browserSource(b,a,c,d,function(c,a,b,d){e&&e(c,a,b,d)})};d.prototype.playerPlayURL=function(b,a,c){this._api.playerPlayURL(b,a,function(a,b){a?c&&c(a):c&&c(null,b)})};d.prototype._putBufferedState=
function(b,a,c,d){"player"==b?this._stateBuffer.putPlayerState(a,c,d):"group"==b&&this._stateBuffer.putGroupState(a,c,d)};d.prototype._getBufferedState=function(b,a,c){if("player"==b)return this._stateBuffer.getPlayerState(a,c);if("group"==b)return this._stateBuffer.getGroupState(a,c)};d.prototype._removeBufferedState=function(b,a,c){"player"==b?this._stateBuffer.removePlayerState(a,c):"group"==b&&this._stateBuffer.removeGroupState(a,c)};d.prototype._sendCommand=function(b,a,c){this._session.sendCommand(b,
a,c)};d.prototype._emitEvent=function(b,a){if(b){var c=this._listeners[b];if(c&&0<c.length)for(var d=0;d<c.length;d++){var e=c[d];try{e(a)}catch(f){this._logger.log("trace","call "+b+" listener failed, error:"+f.message)}}}};d.prototype._processHeosEvent=function(b){if(b&&b.heos&&b.heos.command){var a=b.heos.message;switch(b.heos.command){case "event/player_state_changed":a&&a.pid&&a.state&&this._stateBuffer.putPlayerState(a.pid,"play_state",a.state);break;case "event/player_now_playing_changed":a&&
a.pid&&(this._stateBuffer.removePlayerState(a.pid,"playing_media"),this._stateBuffer.removePlayerState(a.pid,"cur_pos"),this._stateBuffer.removePlayerState(a.pid,"duration"));break;case "event/player_now_playing_progress":a&&a.pid&&a.cur_pos&&a.duration&&(this._stateBuffer.putPlayerState(a.pid,"cur_pos",parseInt(a.cur_pos)),this._stateBuffer.putPlayerState(a.pid,"duration",parseInt(a.duration)));break;case "event/player_volume_changed":a&&a.pid&&a.level&&a.mute&&(this._stateBuffer.putPlayerState(a.pid,
"level",parseInt(a.level)),this._stateBuffer.putPlayerState(a.pid,"mute",a.mute));break;case "event/repeat_mode_changed":a&&a.pid&&a.repeat&&this._stateBuffer.putPlayerState(a.pid,"repeat",a.repeat);break;case "event/shuffle_mode_changed":a&&a.pid&&a.shuffle&&this._stateBuffer.putPlayerState(a.pid,"shuffle",a.shuffle);break;case "event/group_volume_changed":a&&a.gid&&a.level&&a.mute&&(this._stateBuffer.putGroupState(a.gid,"level",parseInt(a.level)),this._stateBuffer.putGroupState(a.gid,"mute",a.mute))}}};
d.prototype._reset=function(){this._stateBuffer.reset()};return d}();
xnm.aio.heos._Session=function(){var f=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.heos._Session._Monitor");this._monitorCallback=this._socket=null;this._commandTimeoutCount=0;this._heartBeatTo=null;this._heatBeatMissCount=0;var c=this;this._socketErrorCallback=function(a){c._finishRun(a)};this._socketCloseCallback=function(){c._finishRun(Error("socket closed"))}};f.prototype.run=function(c,a){this._socket=c;this._monitorCallback=a;this._setListener();this.scheduleNextHeartBeat()};
f.prototype.reset=function(){this._monitorCallback=null;this._heatBeatMissCount=0;this._heartBeatTo&&(clearTimeout(this._heartBeatTo),this._heartBeatTo=null);if(this._socket){var c=this._socket;this._clearListener();this._socket=null;c.close()}};f.prototype.executeCommandTimeout=function(c){c?(this._commandTimeoutCount++,this._logger.log("warn","execute command timeout#"+this._commandTimeoutCount),3<this._commandTimeoutCount&&this._finishRun(Error("execute command is always timeout"))):this._commandTimeoutCount=
0};f.prototype.scheduleNextHeartBeat=function(c){this._scheduleNextHeartBeat(c?c:15E3)};f.prototype._scheduleNextHeartBeat=function(c){var a=this;this._heartBeatTo&&clearTimeout(this._heartBeatTo);this._heartBeatTo=setTimeout(function(){a._checkHeartBeat()},c)};f.prototype._checkHeartBeat=function(){if(this._socket){this._logger.log("trace","check heart beat");var c=this;this._socket.sendCommand({path:"system/heart_beat"},2E3,function(a){a?(c._heatBeatMissCount++,c._logger.log("warn","check heart beat failed #"+
c._heatBeatMissCount+", error:"+a.message),c._scheduleNextHeartBeat(2E3)):(c._heatBeatMissCount=0,c._scheduleNextHeartBeat(15E3));3<c._heatBeatMissCount&&c._finishRun(Error("heart beat failed"))})}};f.prototype._setListener=function(){this._socket&&(this._socket.on("error",this._socketErrorCallback),this._socket.on("close",this._socketCloseCallback))};f.prototype._clearListener=function(){this._socket&&(this._socket.off("error",this._socketErrorCallback),this._socket.off("close",this._socketCloseCallback))};
f.prototype._finishRun=function(a){var b=this._socket;this._socket&&(this._clearListener(),this._socket=null);a&&b&&b.close();this._heartBeatInterval&&(clearInterval(this._heartBeatInterval),this._heartBeatInterval=null);this._heatBeatMissCount=this._commandTimeoutCount=0;this._monitorCallback&&(b=this._monitorCallback,this._monitorCallback=null,b(a))};var e=function(){this._warmupCallback=this._password=this._username=this._socket=null;var a=this;this._socketErrorCallback=function(b){a._finishWarmup(b)};
this._socketCloseCallback=function(){a._finishWarmup(Error("socket closed"))}};e.prototype.warmup=function(a,b,d,e){this._socket=a;this._username=b;this._password=d;this._warmupCallback=e;this._setListener();var f=this;this._registerEvents("off",function(a){a?f._finishWarmup(a):f._signIn(function(a){a?f._finishWarmup(a):f._getPlayers(function(a){a?f._finishWarmup(a):f._registerEvents("on",function(a){f._finishWarmup(a)})})})})};e.prototype.reset=function(){this._warmupCallback=null;if(this._socket){var a=
this._socket;this._clearListener();this._socket=null;a.close()}};e.prototype._registerEvents=function(a,b){this._socket.sendCommand({path:"system/register_for_change_events",attributes:{enable:a}},5E3,function(a,c){b(a,c)})};e.prototype._signIn=function(a){this._username&&this._password?this._socket.sendCommand({path:"system/sign_in",attributes:{un:this._username,pw:this._password}},5E3,function(b,d){a(b,d)}):a()};e.prototype._getPlayers=function(a){this._socket.sendCommand({path:"player/get_players"},
5E3,function(b,d){b?a(b):d&&d.heos&&d.payload&&"success"==d.heos.result?a(null,d.payload):a(Error("get players response error"))})};e.prototype._setListener=function(){this._socket&&(this._socket.on("error",this._socketErrorCallback),this._socket.on("close",this._socketCloseCallback))};e.prototype._clearListener=function(){this._socket&&(this._socket.off("error",this._socketErrorCallback),this._socket.off("close",this._socketCloseCallback))};e.prototype._finishWarmup=function(a){var b=this._socket;
this._socket&&(this._clearListener(),this._socket=null);a&&b&&b.close();this._warmupCallback&&(this._warmupCallback(a),this._warmupCallback=null)};var d=function(){this._connectCallback=this._socket=null;var a=this;this._socketOpenCallback=function(){a._finishConnect()};this._socketErrorCallback=function(b){a._finishConnect(b)};this._socketCloseCallback=function(){a._finishConnect(Error("socket closed"))}};d.prototype.connect=function(a,b){this._connectCallback=b;this._socket=new xnm.aio.heos._Socket(a);
this._setListener();this._socket.open()};d.prototype.reset=function(){this._connectCallback=null;if(this._socket){var a=this._socket;this._clearListener();this._socket=null;a.close()}};d.prototype._setListener=function(){this._socket&&(this._socket.on("open",this._socketOpenCallback),this._socket.on("error",this._socketErrorCallback),this._socket.on("close",this._socketCloseCallback))};d.prototype._clearListener=function(){this._socket&&(this._socket.off("open",this._socketOpenCallback),this._socket.off("error",
this._socketErrorCallback),this._socket.off("close",this._socketCloseCallback))};d.prototype._finishConnect=function(a){var b=this._socket;this._socket&&(this._clearListener(),this._socket=null);a&&b&&b.close();if(this._connectCallback){var d=this._connectCallback;this._connectCallback=null;d(a,b)}};var b=function(){this._state="idle";this._heos=[];this._searchTo=this._fetchCallback=this._lastFetch=null};b.prototype.reset=function(){this._state="idle";this._heos=[];this._fetchCallback=this._lastFetch=
null;this._searchTo&&clearTimeout(this._searchTo);this._searchTo=null};b.prototype.fetchHEOS=function(a){var b=Math.round((new Date).getTime()/1E3);this._lastFetch&&600<b-this._lastFetch&&(this._heos=[]);var d=this._getUnfetchedHEOSFromBuffer();if(d)this._lastFetch=b,a(null,d);else if(this._fetchCallback=a,"run"!=this._state){var e=this;this._state="run";this._searchTo=setTimeout(function(){e._state="idle";e._heos=[];if(e._fetchCallback){var a=e._fetchCallback;e._fetchCallback=null;a(null,null)}},
12E3);require("x.upnp.js").discoverTargetWithTimeout("urn:schemas-denon-com:device:ACT-Denon:1",1E4,function(a){if(a&&a.ip&&"run"==e._state){a={fetched:!1,data:{ip:a.ip,port:1255,uuid:a.uuid}};var c=e._heos.length;e._heos.push(a);0==c&&(a.fetched=!0,e._lastFetch=b,e._fetchCallback&&(c=e._fetchCallback,e._fetchCallback=null,c(null,a.data)))}})}};b.prototype._getUnfetchedHEOSFromBuffer=function(){for(var a=null,b=0;b<this._heos.length;b++){var d=this._heos[b];if(0==d.fetched){d.fetched=!0;a=d.data;
break}}return a};var a=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.heos._Session");this._discover=new b;this._connect=new d;this._runner=new e;this._monitor=new f;var a=this;this._socketEventCallback=function(b){b&&b.heos&&b.heos.message&&(b.heos.message=a._parseMessage(b.heos.message));a._monitor.scheduleNextHeartBeat();a._emitEvent("event",b)};this._socket=null;this._state="IDLE";this._uuid=this._password=this._username=this._port=this._ip=null;this._eventListeners={}};a.prototype.on=
function(a,b){a&&b&&(this._eventListeners[a]||(this._eventListeners[a]=[]),-1==this._eventListeners[a].indexOf(b)&&this._eventListeners[a].push(b))};a.prototype.off=function(a,b){if(a&&b&&this._eventListeners[a]){var d=this._eventListeners[a].indexOf(b);-1!=d&&this._eventListeners[a].splice(d,1)}};a.prototype.open=function(a){"IDLE"==this._state&&(this._ip=a?a.ip:null,this._port=a?a.port:null,this._username=a?a.username:null,this._password=a?a.password:null,this._uuid=a?a.uuid:null,this._logger.log("debug",
"start controller"+(this._ip?" with ip:"+this._ip:" without ip")),this._doFSM(this._ip?"init_with_ip":"init_without_ip"))};a.prototype.close=function(){"IDLE"!=this._state&&(this._logger.log("debug","stop controller"),this._doFSM("stop"))};a.prototype.sendCommand=function(a,b,d){if("IDLE"==this._state)a=Error("session not initialized"),a.sys="heos",a.code=-5,d&&d(a);else if("RUN"!=this._state)a=Error("session is initialling"),a.sys="heos",a.code=-6,d&&d(a);else{var e=this;this._socket.sendCommand(a,
b,function(a,b){a?-3==a.code?(e._monitor.scheduleNextHeartBeat(),e._monitor.executeCommandTimeout(!0)):e._monitor.executeCommandTimeout(!1):(e._monitor.scheduleNextHeartBeat(),e._monitor.executeCommandTimeout(!1));if(a)d&&d(a);else if(b&&b.heos&&b.heos.result){var c={command:b.heos.comamnd,result:b.heos.result};b.heos.message&&(c.message=e._parseMessage(b.heos.message));b.payload&&(c.payload=b.payload);b.options&&(c.options=b.options);"fail"==b.heos.result&&(c.message?(a=Error(c.message.text),a.code=
parseInt(c.message.eid)):(a=Error("response fail"),a.code=0));d&&d(a,c)}else a=Error("invalid response"),a.code=-4,d&&d(a)})}};a.prototype._emitEvent=function(a,b){if(a){var d=this._eventListeners[a];if(d&&0<d.length)for(var e=0;e<d.length;e++){var f=d[e];try{f(b)}catch(r){this._logger.log("trace","call "+a+" listener failed, error:"+r.message)}}}};a.prototype._searchHEOS=function(){this._logger.log("trace","search heos device");var a=this;this._discover.fetchHEOS(function(b,d){d?(a._logger.log("trace",
"found heos device:"+d.ip),a._ip=d.ip,a._uuid=d.uuid,a._doFSM("find_heos")):(a._logger.log("trace","do not found heos device"),a._doFSM("no_heos"))})};a.prototype._stopSearchHEOS=function(){this._logger.log("trace","stop search heos device");this._discover.reset();this._reset()};a.prototype._connectHEOS=function(){this._logger.log("trace","connect heos device:"+this._ip);var a=this;this._connect.connect({ip:this._ip,port:this._port,username:this._username,passsword:this._password,uuid:this._uuid},
function(b,d){b?(a._logger.log("trace","connect to heos device:"+a._ip+" failed, error:"+b.message),a._doFSM("conn_fail")):(a._logger.log("trace","connect to heos device:"+a._ip+" success"),a._socket=d,a._doFSM("conn_ok"))})};a.prototype._stopConnectHEOS=function(){this._logger.log("trace","stop connect heos device:"+this._ip);this._connect.reset();this._reset()};a.prototype._warmupHEOS=function(){this._logger.log("trace","warmup heos device:"+this._ip);var a=this;this._runner.warmup(this._socket,
this._username,this._password,function(b){b?(a._logger.log("trace","warmup heos device:"+a._ip+" failed, error:"+b.message),a._socket=null,a._doFSM("not_ready")):(a._logger.log("trace","warmup heos device:"+a._ip+" success"),a._doFSM("ready"))})};a.prototype._stopWarmupHEOS=function(){this._logger.log("trace","stop warmup heos device:"+this._ip);this._runner.reset();this._reset()};a.prototype._runHEOS=function(){this._logger.log("trace","monitor heos device:"+this._ip);var a=this;this._monitor.run(this._socket,
function(b){b&&(a._logger.log("trace","monitor heos device:"+a._ip+" failed, error:"+b.message),a._socket=null,a._doFSM("run_error"),a._emitEvent("error",b))});this._setListener();this._emitEvent("open")};a.prototype._stopRunHEOS=function(){this._logger.log("trace","stop monitor heos device:"+this._ip);this._monitor.reset();this._clearListener();this._emitEvent("close");this._reset()};a.prototype._parseMessage=function(a){if(!a)return null;var b={};a=a.split("&");for(var d=0;d<a.length;d++){var e=
a[d],f=e.indexOf("=");if(-1!=f){var r=e.substr(0,f),e=e.substr(f+1);b[r]=e}}return b};a.prototype._setListener=function(){if(this._socket)this._socket.on("event",this._socketEventCallback)};a.prototype._clearListener=function(){this._socket&&this._socket.off("event",this._socketEventCallback)};a.prototype._reset=function(){this._uuid=this._password=this._username=this._port=this._ip=this._socket=null};a.prototype._doFSM=function(a){this._logger.log("trace","FSM current state:"+this._state+" input:"+
a);switch(this._state){case "IDLE":switch(a){case "init_with_ip":this._state="CONNECT";this._logger.log("trace","FSM new state:"+this._state);this._connectHEOS();break;case "init_without_ip":this._state="SEARCH",this._logger.log("trace","FSM new state:"+this._state),this._searchHEOS()}break;case "SEARCH":switch(a){case "no_heos":this._state="SEARCH";this._logger.log("trace","FSM new state:"+this._state);this._searchHEOS();break;case "find_heos":this._state="CONNECT";this._logger.log("trace","FSM new state:"+
this._state);this._connectHEOS();break;case "stop":this._state="IDLE",this._logger.log("trace","FSM new state:"+this._state),this._stopSearchHEOS()}break;case "CONNECT":switch(a){case "conn_fail":this._state="SEARCH";this._logger.log("trace","FSM new state:"+this._state);this._searchHEOS();break;case "conn_ok":this._state="WARMUP";this._logger.log("trace","FSM new state:"+this._state);this._warmupHEOS();break;case "stop":this._state="IDLE",this._logger.log("trace","FSM new state:"+this._state),this._stopConnectHEOS()}break;
case "WARMUP":switch(a){case "not_ready":this._state="SEARCH";this._logger.log("trace","FSM new state:"+this._state);this._searchHEOS();break;case "ready":this._state="RUN";this._logger.log("trace","FSM new state:"+this._state);this._runHEOS();break;case "stop":this._state="IDLE",this._logger.log("trace","FSM new state:"+this._state),this._stopWarmupHEOS()}break;case "RUN":switch(a){case "run_error":this._state="CONNECT";this._logger.log("trace","FSM new state:"+this._state);this._connectHEOS();break;
case "stop":this._state="IDLE",this._logger.log("trace","FSM new state:"+this._state),this._stopRunHEOS()}}};return a}();
xnm.aio.heos._Socket=function(){var f=function(e){if(!e)throw Error("options is null");if(!e.ip)throw Error("no ip");this._logger=require("x.logger.js").getLogger("xnm.aio.heos._Socket");this._responseTimeout=1E3;this._ip=e.ip;this._port=e.port;this._port||(this._port=1255);this._username=e.username;this._password=e.password;this._uuid=e.uuid;this._timeout=2E3;this._listeners={};this._socket=null;this._buf="";this._state="IDLE";this._commands=[]};f.prototype.on=function(e,d){e&&d&&(this._listeners[e]||
(this._listeners[e]=[]),-1==this._listeners[e].indexOf(d)&&this._listeners[e].push(d))};f.prototype.off=function(e,d){if(e&&d&&this._listeners[e]){var b=this._listeners[e].indexOf(d);-1!=b&&this._listeners[e].splice(b,1)}};f.prototype.open=function(){if(!this._socket&&"IDLE"==this._state){var e=this;this._state="CONNECT";this._buf="";var d=require("net").connect({port:this._port,host:this._ip});d.setTimeout(this._timeout);d.setEncoding("utf8");this._logger.log("trace","start connect to "+this._ip+
":"+this._port);d.on("connect",function(){e._logger.log("trace","success to connect "+e._ip+":"+e._port);e._state="CONNECTED";e._emitEvent("open");e._executeNextCommand()});d.on("data",function(b){e._logger.log("trace","receive data: "+b.toString());e._buf+=b.toString();e._processBuffer()});d.on("error",function(b){e._logger.log("trace","socket error: "+b.message);e._emitEvent("error",b)});d.on("timeout",function(){"CONNECT"==e._state&&(e._logger.log("trace","connect timeout"),e._emitEvent("error",
Error("connect timeout")),e.close())});d.on("close",function(){e._logger.log("trace","socket closed");e._onClose()});d._doConnect&&"function"==typeof d._doConnect&&d._doConnect();this._socket=d}};f.prototype.close=function(){this._socket&&(this._state="CLOSED",this._socket.destroy(),this._onClose())};f.prototype.sendCommand=function(e,d,b){var a=null;"CLOSED"==this._state?(a=Error("socket closed"),a.code=-1,b&&b(a)):e&&e.path?(d||(d=this._responseTimeout),a=this._commands.length,this._commands.push({command:e,
callback:b,timeout:null,state:"IDLE",responseTimeout:d}),0==a&&this._executeNextCommand()):(a=Error("invalid command"),a.code=-2,b&&b(a))};f.prototype._executeNextCommand=function(){var e=this._commands[0];if(e&&"IDLE"==e.state&&"CONNECTED"==this._state){var d=this._buildPacket(e.command);e.state="SENT";this._setupReponseTimeout(e);this._logger.log("debug","send command:"+d);e=new Buffer(d);this._socket.write(e)}};f.prototype._setupReponseTimeout=function(e){var d=this;e.timeout=setTimeout(function(){d._commands.splice(0,
1);e.state="TIMEOUT";if(e.callback){d._logger.log("debug","response timeout");var b=Error("response timeout");b.code=-3;e.callback(b)}d._executeNextCommand()},e.responseTimeout)};f.prototype._buildPacket=function(e){var d="heos://"+e.path;if(e.attributes){var d=d+"?",b=[],a;for(a in e.attributes){var c=this._escape(a)+"="+this._escape(e.attributes[a]);b.push(c)}d+=b.join("&")}return d+"\r\n"};f.prototype._escape=function(e){if(!e||"string"!=typeof e)return e;e=e.replace(/%/g,"%25");e=e.replace(/&/g,
"%26");return e=e.replace(/=/g,"%3D")};f.prototype._emitEvent=function(e,d){if(e){var b=this._listeners[e];if(b&&0<b.length)for(var a=0;a<b.length;a++){var c=b[a];try{c(d)}catch(f){this._logger.log("trace","call "+e+" listener failed, error:"+f.message)}}}};f.prototype._processBuffer=function(){for(var e=this._buf.indexOf("\r\n");-1!=e;){if(0!=e){var d=this._buf.substr(0,e);this._processResponse(d)}this._buf=this._buf.substr(e+2);e=this._buf.indexOf("\r\n")}};f.prototype._processResponse=function(e){this._logger.log("debug",
"receive response: "+e);try{var d=JSON.parse(e);if(!d||!d.heos||!d.heos.command)throw Error("invalid response");var b=this._commands[0];b&&"SENT"==b.state&&b.command&&b.command.path==d.heos.command?-1!=d.heos.message.indexOf("command under process")?(clearTimeout(b.timeout),this._setupReponseTimeout(b)):(this._commands.splice(0,1),clearTimeout(b.timeout),b.callback&&b.callback(null,d),this._executeNextCommand()):"event"==d.heos.command.substr(0,5)&&this._emitEvent("event",d)}catch(a){this._logger.log("debug",
"process response error: "+a.message)}};f.prototype._onClose=function(){this._state="CLOSED";this._socket=null;this._emitEvent("close");this._listeners={};var e=Error("socket closed");e.code=-1;for(var d=0;d<this._commands.length;d++){var b=this._commands[d];b.timeout&&clearTimeout(b.timeout);b.callback&&b.callback(e)}this._commands=[];this._buf=""};return f}();
xnm.aio.heos.DM=function(){var f=function(d,b){this.code=d;this.message=b;this.stack=Error().stack};f.prototype=Error();f.prototype.name="HEOSDMError";f.prototype.code=0;f.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var e={command:[{type:"enum",name:"play",ref:{value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}},
{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"int",name:"volume",ref:{value:"volume",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"enum",name:"shuffle on",ref:{value:"shuffleOn"}},{type:"enum",name:"shuffle off",ref:{value:"shuffleOff"}},{type:"enum",name:"toggle shuffle",ref:{value:"shuffleToggle"}},
{type:"enum",name:"repeat off",ref:{value:"repeatOff"}},{type:"enum",name:"repeat all",ref:{value:"repeatAll"}},{type:"enum",name:"repeat one",ref:{value:"repeatOne"}},{type:"enum",name:"switch repeat",ref:{value:"repeatSwitch"}},{type:"string",name:"play url",ref:{value:"playUrl",ext:"%s"}}],status:[{type:"enum",name:"muted",ref:{value:"muted",options:["true","false"]}},{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-100"}},{type:"enum",name:"shuffle state",ref:{value:"shuffle",options:["on",
"off"]}},{type:"enum",name:"repeat state",ref:{value:"repeat",options:["off","one","all"]}},{type:"string",name:"play state",ref:{value:"playState",options:["play","pause","stop"]}},{type:"string",name:"track duration",ref:{value:"duration"}},{type:"int",name:"track duration (seconds)",ref:{value:"durationS"}},{type:"string",name:"track position",ref:{value:"position"}},{type:"int",name:"track position (seconds)",ref:{value:"positionS"}},{type:"string",name:"artist",ref:{value:"artist"}},{type:"string",
name:"title",ref:{value:"title"}},{type:"string",name:"album",ref:{value:"album"}}]};return{SYS:"heos",getGatewayType:function(){return[{sys:this.SYS,name:"HEOS Controller",port:1255}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"player",name:"Player"},{sys:this.SYS,type:"group",name:"Group"}]},createGateway:function(d,b,a){b=f.ERROR_CODE;d?d.ip?a(null,d):a(new f(b.INVALID,"ip is invalid")):a(new f(b.INVALID,"info is invalid"))},updateGateway:function(d,b,a,c){d=f.ERROR_CODE;b?b.ip?
c(null,b):c(new f(d.INVALID,"ip is invalid")):c(new f(d.INVALID,"update is invalid"))},deleteGateway:function(d,b,a){a()},createDevice:function(d,b,a){var c=f.ERROR_CODE;if(d)if(d.gateway)if(null==d.type||"undefined"==typeof d.type)a(new f(c.INVALID,"type is invalid"));else if("player"!=d.type||null!=d.pid&&"undefined"!=typeof d.pid)if("group"!=d.type||null!=d.gid&&"undefined"!=typeof d.gid){b=b.data.gateways;var e,l;for(e=0;e<b.length;e++)if(b[e].index===d.gateway){l=b[e];break}l?a(null,d):a(new f(c.NOT_FOUND,
"gateway with index "+d.gateway+" not exists"))}else a(new f(c.INVALID,"gid is invalid"));else a(new f(c.INVALID,"pid is invalid"));else a(new f(c.INVALID,"gateway is invalid"));else a(new f(c.INVALID,"info is invalid"))},updateDevice:function(d,b,a){var c=f.ERROR_CODE;if(d)if(d.gateway)if(null==d.type||"undefined"==typeof d.type)a(new f(c.INVALID,"type is invalid"));else if("player"!=d.type||null!=d.pid&&"undefined"!=typeof d.pid)if("group"!=d.type||null!=d.gid&&"undefined"!=typeof d.gid){b=b.data.gateways;
var e,l;for(e=0;e<b.length;e++)if(b[e].index===d.gateway){l=b[e];break}l?a(null,d):a(new f(c.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else a(new f(c.INVALID,"gid is invalid"));else a(new f(c.INVALID,"pid is invalid"));else a(new f(c.INVALID,"gateway is invalid"));else a(new f(c.INVALID,"info is invalid"))},deleteDevice:function(d,b,a){a()},applyUIFilter:function(d,b){var a=this,c=function(a,b,d){var e=[];a.forEach(function(a){if("root"==a.type){a=JSON.parse(JSON.stringify(a));var f=
c(a.children,b,d);f&&0<f.length&&(a.children=f,e.push(a))}else{f=d.elems;if("*"==f)f=!0;else{for(var g=!1,h=0;h<f.length;h++)if(f[h]==a.type){g=!0;break}f=g}f&&(a=JSON.parse(JSON.stringify(a)),e.push(a))}});return e},e=function(b,d){var e=[],f=a.getCommandStatusMap(b);if(f){var g=[];switch(d.catagory){case "command":f.command&&(g=c(f.command,b,d));break;case "status":f.status&&(g=c(f.status,b,d))}e=e.concat(g)}return e};if(!d.sys)return null;var f=JSON.parse(JSON.stringify(d)),m=null;switch(b.catagory){case "command":m=
e(d,b);f.command=m;break;case "status":m=e(d,b);f.status=m;break;default:return null}return m&&0!=m.length?f:null},getCommandStatusMap:function(d){return d&&"undefined"!=typeof d.type&&null!=d.type?e:null}}}();
xnm.aio.heos.Handler=function(){var f=function(){this._getDeviceListTo=this._controller=null};f.prototype.Socket=xnm.aio.heos._Socket;f.prototype.Session=xnm.aio.heos._Session;f.prototype.Controller=xnm.aio.heos._Controller;f.prototype.HEOS=xnm.aio.heos.HEOS;f.prototype.devicemanager=xnm.aio.heos.DM;f.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"heos")};f.prototype.resolveGateway=function(e){return e?this.HEOS.parseJSON(e):null};f.prototype.getDeviceCommands=function(e,d){var b=
this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),b=b?b.command:[];d&&d(null,b)};f.prototype.getDeviceStatus=function(e,d){var b=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),b=b?b.status:[];d&&d(null,b)};f.prototype.doCommand=function(e,d,b,a){(e=this.resolveGateway(e))?e.executeCommandCreator(d,b,function(b){a&&a(b)}):a&&a(Error("gateway json format invalid"))};f.prototype.doStatus=function(e,d,b,a,c){(d=this.resolveGateway(d))?d.getStatesCreator(null,[{id:e,
device:b,status:a}],function(a,b){a?c&&c(a):c&&c(null,b[0])}):c&&c(Error("device json format invalid"))};f.prototype.getController=function(){this._controller||(this._controller=new this.Controller);return this._controller};f.prototype.discoverDevices=function(e){var d={};require("x.upnp.js").discoverTargetWithTimeout("urn:schemas-denon-com:device:ACT-Denon:1",5E3,function(b){b&&b.ip&&b.uuid&&(d[b.uuid]={sys:"heos",ip:b.ip,uuid:b.uuid})});setTimeout(function(){var b=null,a;for(a in d){var c=d[a];
if(c){b=c;break}}e&&e(null,b)},5E3)};f.prototype.getDeviceList=function(e,d){_getDeviceList=function(a,b){var c=[];a.getPlayers(function(d,e){d?b&&b(d):(e&&e.map(function(a){a.sys="heos";a.type="player";return a}),a.getGroups(function(a,d){a?b&&b(a):(d&&d.map(function(a){a.sys="heos";a.type="group";delete a.players;return a}),e&&(c=c.concat(e)),d&&(c=c.concat(d)),b&&b(null,c))}))})};var b=this.resolveGateway(e);if(b)if(this._getDeviceListTo)d&&d(Error("another get device list process running"));else{var a=
this.getController();if(a.isOpen())_getDeviceList(b,d);else{var c=this,f=function(){a.off("run",f);c._getDeviceListTo&&(clearTimeout(c._getDeviceListTo),c._getDeviceListTo=null);_getDeviceList(b,d)};a.on("open",f);this._getDeviceListTo=setTimeout(function(){a.off("run",f);c._getDeviceListTo=null;d&&d(Error("start heo controller timeout"))},5E3);a.open(b.toJSON())}}else d&&d(Error("gateway json format invalid"))};f.prototype.finalize=function(e){this._controller&&this._controller.close();setTimeout(function(){e&&
e()},1E3)};f.prototype.pause=function(e){this.finalize(e)};return f}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.heos.Handler);
