var commandman=require("x.hub.commandman.js"),x=x||{};x.hub=x.hub||{};x.hub.action=x.hub.action||{};
x.hub.action.ActionManager=function(){var f=function(a,b,c){this._id=a;this._number=b;this._logger=require("x.logger.js").getLogger("x.hub.action.Action.["+a+"#"+b+"]");this._actionPool=c;this._state=0;this._actions=[];this._nestedAction=this._delayTimeout=this._callback=null};f.prototype.getId=function(){return this._id};f.prototype.run=function(){var a=0,b=this;this._state=1;var c=function(d){b._logger.log("trace","finish item("+a+")"+(d?" failed:"+d.message:" success"));a++;if(2==b._state){if(b._state=
3,b._logger.log("trace","action canceled"),b._actionPool._onActionFinish(b),b._callback){try{b._callback(Error("action canceled"))}catch(g){}b._callback=null}}else if(3!=b._state)if(a==b._actions.length){if(b._state=3,b._actionPool._onActionFinish(b),b._callback){try{b._callback()}catch(g){}b._callback=null}}else b._logger.log("trace","do item("+a+")"),b._do(a,c)};this._logger.log("trace","do item("+a+")");this._do(a,c)};f.prototype.cancel=function(){this._logger.log("trace","cancel action");1==this._state&&
(this._state=2);this._nestedAction&&(this._nestedAction.cancel(),this._nestedAction=null);if(this._delayTimeout&&(clearTimeout(this._delayTimeout),this._delayTimeout=null,this._state=3,this._logger.log("trace","action canceled"),this._actionPool._onActionFinish(this),this._callback))try{this._callback(Error("action canceled"))}catch(a){}};f.prototype._do=function(a,b){var c=this._actions[a];if(c){var d=this;void 0!=c.delay&&null!=c.delay?this._delayTimeout=setTimeout(function(){d._delayTimeout=null;
b()},c.delay):c.if?this._doStatement(a,c,b):commandman.commandHandlerV6.executeCommandWithCommandInfo(c,function(a){b(a)})}else b()};f.prototype._doStatement=function(a,b,c){var d=this;this._logger.log("trace","do statement("+a+")");(function(a,b){var c=0,g=null;a.state?(d._logger.log("trace","check single state object"),d._checkState(a,function(a,c){b(a,c)})):a.and&&a.and.length?(g=function(e,k){d._logger.log("trace","check "+c+'th item in "and" array '+(e?"failed:"+e.message:"result:"+k));e?b(null,
!1):k?(c++,c<a.and.length?(d._logger.log("trace","check "+c+'th item in "and" array'),d._checkState(a.and[c],g)):b(null,!0)):b(null,!1)},d._logger.log("trace","check "+c+'th item in "and" array'),d._checkState(a.and[c],g)):a.or&&a.or.length&&(g=function(e,k){d._logger.log("trace","check "+c+'th item in "or" array '+(e?"failed:"+e.message:"result:"+k));!e&&k?b(null,!0):(c++,c<a.or.length?(d._logger.log("trace","check "+c+'th item in "or" array'),d._checkState(a.or[c],g)):b(null,!1))},d._logger.log("trace",
"check "+c+'th item in "or" array'),d._checkState(a.or[c],g))})(b.if,function(g,e){d._logger.log("trace","do statement("+a+'), check "if" '+(g?"faild:"+g.message:"result: "+e));g?c(g):e?(d._logger.log("trace","do statement("+a+') "then" actions'),(g=b.then)&&g.length?d._doNestedAction(d._id+"-if:"+a+"(then)",g,c):c()):(d._logger.log("trace","do statement("+a+') "else" actions'),(g=b.else)&&g.length?d._doNestedAction(d._id+"-if:"+a+"(else)",g,c):c())})};f.prototype._checkState=function(a,b){this._logger.log("trace",
"check state item: "+JSON.stringify(a));var c=this;if(a.state){var d=a.state;if(d.devices&&d.devices.length)if(d.data&&d.data.length){var g=0,e=function(a,f){c._logger.log("trace","check state of "+g+"th device "+(a?"failed:"+a.message:"result:"+JSON.stringify(f)));if(a)b(a);else if(f){a=!1;for(var h=0;h<d.data.length&&!(a=commandman.commandHandlerV6.matchDeviceState(f,d.data[h]));h++);a?(g++,g<d.devices.length?(c._logger.log("trace","check state of "+g+"th device: "+JSON.stringify(d.devices[g])),
commandman.commandHandlerV6.getDeviceStatesWithStateInfo(d.devices[g],e)):b(null,!0)):b(null,!1)}else b(null,!1)};this._logger.log("trace","check state of "+g+"th device: "+JSON.stringify(d.devices[g]));commandman.commandHandlerV6.getDeviceStatesWithStateInfo(d.devices[g],e)}else b(Error("invalid state item, no data"));else b(Error("invalid state item, no devices"))}else if(a.time){var f=require("x.hub.rule.js").RuleManager.Util,h=f.getMomentNow();if(f.matchDate(h,a.time)){var l=!0,k=null;k=null;
a.time.from&&(k=f.getAstro(h),(k="sun"==a.time.from.substr(0,3)?f.calculateAstroTarget(h,k[0],k[1],a.time.from):f.calculateTimeTarget(h,a.time.from))&&h.isBefore(k)&&(l=!1));l?(a.time.until&&(k=f.getAstro(h),(k="sun"==a.time.until.substr(0,3)?f.calculateAstroTarget(h,k[0],k[1],a.time.until):f.calculateTimeTarget(h,a.time.until))&&h.isAfter(k)&&(l=!1)),b(null,l)):b(null,!1)}else b(null,!1)}else b(Error("invalid state item"))};f.prototype._doNestedAction=function(a,b,c){this._nestedAction=new f(a,b,
{_onActionFinish:function(){}});this._nestedAction._actions=b;this._nestedAction._callback=c;this._nestedAction.run()};var h=function(){this._pool=[];this._count=0};h.prototype.runAction=function(a,b,c){b?(this._count++,65535<this._count&&(this._count=1),a=new f(a,this._count,this),Array.isArray(b)?a._actions=b:a._actions=[b],a._callback=c,this._pool.push(a),a.run()):c&&c()};h.prototype.cancelAction=function(a){this._pool=this._pool.filter(function(b){return b&&b.getId()==a?(b.cancel(),!1):!0})};
h.prototype.isActionRunning=function(a){for(var b=0;b<this._pool.length;b++){var c=this._pool[b];if(c&&c.getId()==a)return!0}return!1};h.prototype._onActionFinish=function(a){a=this._pool.indexOf(a);-1!=a&&this._pool.splice(a,1)};var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.action.ActionManager");this._actions=this._dataFolder=null;this._actionPool=new h(this);this._writing=!1;this._writeCallbacks=[]};e.FILE_NAME="action.json";e.prototype.init=function(a,b){this._logger.log("info",
"init action manager");this._dataFolder=a.getUserRootDataPath();this._loadActions(function(a){b&&b(a)})};e.prototype.getActions=function(){return this._actions};e.prototype.getAction=function(a){return this._actions?this._actions[a]:null};e.prototype.setAction=function(a,b,c){void 0==a||null==a?c&&c(Error("invalid action id")):(b?this._actions[a]=b:delete this._actions[a],this._writeActions(function(a){c&&c(a,b)}))};e.prototype.executeActionWithId=function(a,b){var c=this.getAction(a);c?this._actionPool.runAction("act:"+
a,c,b):b&&b(Error("no such action "+a))};e.prototype.executeAction=function(a,b,c){this._actionPool.isActionRunning(a)?(this._logger.log("trace","action ("+a+") is already running"),c&&c()):this._actionPool.runAction(a,b,c)};e.prototype.executeActionSingelton=function(a,b,c){this._actionPool.cancelAction(a);this._actionPool.runAction(a,b,c)};e.prototype._loadActions=function(a){var b=require("fs-extra"),c=this._getFile(),d=this;b.ensureFile(c,function(b){b?a(b):d._loadFile(function(b,c){b?a(b):(d._actions=
c?c:{},a())})})};e.prototype._writeActions=function(a){a&&-1==this._writeCallbacks.indexOf(a)&&this._writeCallbacks.push(a);if(!this._writing&&this._writeCallbacks.length){this._writing=!0;var b=this._writeCallbacks;this._writeCallbacks=[];var c=this;this._writeFile(this._actions,function(a){c._writing=!1;b.forEach(function(b){try{b&&b(a)}catch(m){}});c._writeActions()})}};e.prototype._getFile=function(){return require("path").resolve(this._dataFolder,e.FILE_NAME)};e.prototype._loadFile=function(a){var b=
require("fs"),c=this._getFile();b.readFile(c,"utf8",function(b,c){if(b)a(b);else if(c)try{var d=JSON.parse(c);a(null,d)}catch(n){a(null,{})}else a(null,{})})};e.prototype._writeFile=function(a,b){var c=require("fs"),d=this._getFile();c.writeFile(d,JSON.stringify(a,null,2),function(a){b&&b(a)})};e.Action=f;return e}();
x.hub.action.Handler=function(){var f=function(){this._logger=require("x.logger.js").getLogger("x.hub.action.Handler");this._actionManager=new x.hub.action.ActionManager};f.prototype.ActionManager=x.hub.action.ActionManager;f.prototype.init=function(f,e,a){"CA"==global.HARDWARE_VERSION&&this._initHttpApi(f);this._actionManager.init(e,function(b){b&&a(b)})};f.prototype.getActionManager=function(){return this._actionManager};f.prototype._initHttpApi=function(){var f=this,e=require("x.hub.js").getServer();
e.addRoute("/api/actions",{method:"GET"},function(a,b,c){a=f._actionManager.getActions();b.json({XC_SUC:a?a:{}})});e.addRoute("/api/action",{method:"GET"},function(a,b,c){var d=a.query?a.query.id:null;f._actionManager.executeActionWithId(d,function(a){a?b.json({XC_ERR:{code:"000101",msg:"failed to execute action "+d+":"+a.message}}):b.json({XC_SUC:{}})})});e.addRoute("/data/act/",{method:"GET"},function(a,b,c){a=a.path.substr(10);(a=f._actionManager.getAction(a))?b.json({XC_SUC:a}):b.json({XC_ERR:{code:"000101",
msg:"failed to open file"}})});e.addRoute("/data/act/",{method:"POST"},function(a,b){var c=a.path.substr(10);try{f._actionManager.setAction(c,a.json,function(c,e){c?b.json({XC_ERR:{code:"000101",msg:"failed to set action:"+c.message}}):e?b.json({XC_SUC:{bytes:a.size}}):b.json({XC_SUC:{bytes:0}})})}catch(d){b.json({XC_ERR:{code:"000101",msg:"failed to set action:"+d.message}})}})};return f}();module.exports=new x.hub.action.Handler;
