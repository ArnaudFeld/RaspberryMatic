var commandman=require("x.hub.commandman.js"),x=x||{};x.hub=x.hub||{},x.hub.action=x.hub.action||{},x.hub.action.ActionManager=function(){var t=function t(_t,e,i){this._id=_t,this._number=e,this._logger=require("x.logger.js").getLogger("x.hub.action.Action.["+_t+"#"+e+"]"),this._actionPool=i,this._state=0,this._actions=[],this._callback=null,this._delayTimeout=null,this._nestedAction=null;};t.prototype.getId=function(){return this._id;},t.prototype.run=function(){var t=0,e=this;this._state=1;var i=function i(n){if(n){var o=e._actions[t];try{o=JSON.stringify(o);}catch(t){}}var a=n?"error":"trace";if(e._logger.log(a,"finish item("+t+")"+(n?" failed:"+n.message+" action:"+o:" success")),t++,2!=e._state){if(3!=e._state)if(t!=e._actions.length)e._logger.log("trace","do item("+t+")"),e._do(t,i);else if(e._state=3,e._actionPool._onActionFinish(e),e._callback){try{e._callback(n);}catch(t){}e._callback=null;}}else if(e._state=3,e._logger.log("trace","action canceled "+o),e._actionPool._onActionFinish(e),e._callback){try{e._callback(new Error("action canceled"));}catch(t){}e._callback=null;}};this._logger.log("trace","do item("+t+")"),this._do(t,i);},t.prototype.cancel=function(){if(this._logger.log("trace","cancel action"),1==this._state&&(this._state=2),this._nestedAction&&(this._nestedAction.cancel(),this._nestedAction=null),this._delayTimeout&&(clearTimeout(this._delayTimeout),this._delayTimeout=null,this._state=3,this._logger.log("trace","action canceled"),this._actionPool._onActionFinish(this),this._callback))try{this._callback(new Error("action canceled"));}catch(t){}},t.prototype._do=function(t,e){var i=this._actions[t];if(i){var n=this;null==i.delay||null==i.delay?i["if"]?this._doStatement(t,i,e):i.action?require("x.hub.action.js").getActionManager().executeActionWithId(i.action,e):commandman.commandHandlerV6.executeCommandWithCommandInfo(i,function(t){e(t);}):this._delayTimeout=setTimeout(function(){n._delayTimeout=null,e();},i.delay);}else e();},t.prototype._doStatement=function(t,e,i){var n=this;this._logger.log("trace","do statement("+t+")"),function(t,e){var i=0,_o2=null;t.state?(n._logger.log("trace","check single state object"),n._checkState(t,function(t,i){e(t,i);})):t.and&&t.and.length?(_o2=function o(a,c){n._logger.log("trace","check "+i+'th item in "and" array '+(a?"failed:"+a.message:"result:"+c)),a?e(null,!1):c?++i<t.and.length?(n._logger.log("trace","check "+i+'th item in "and" array'),n._checkState(t.and[i],_o2)):e(null,!0):e(null,!1);},n._logger.log("trace","check "+i+'th item in "and" array'),n._checkState(t.and[i],_o2)):t.or&&t.or.length&&(_o2=function _o(a,c){n._logger.log("trace","check "+i+'th item in "or" array '+(a?"failed:"+a.message:"result:"+c)),a||!c?++i<t.or.length?(n._logger.log("trace","check "+i+'th item in "or" array'),n._checkState(t.or[i],_o2)):e(null,!1):e(null,!0);},n._logger.log("trace","check "+i+'th item in "or" array'),n._checkState(t.or[i],_o2));}(e["if"],function(o,a){n._logger.log("trace","do statement("+t+'), check "if" '+(o?"faild:"+o.message:"result: "+a)),o?i(o):a?(n._logger.log("trace","do statement("+t+') "then" actions'),function(e,i){if(e&&e.length){var o=n._id+"-if:"+t+"(then)";n._doNestedAction(o,e,i);}else i();}(e.then,i)):(n._logger.log("trace","do statement("+t+') "else" actions'),function(e,i){if(e&&e.length){var o=n._id+"-if:"+t+"(else)";n._doNestedAction(o,e,i);}else i();}(e["else"],i));});},t.prototype._checkState=function(t,e){this._logger.log("trace","check state item: "+JSON.stringify(t));var i=this;if(t.state){var n=t.state;if(!n.devices||!n.devices.length)return void e(new Error("invalid state item, no devices"));if(!n.data||!n.data.length)return void e(new Error("invalid state item, no data"));var o=0,a=function a(t,c){if(i._logger.log("trace","check state of "+o+"th device "+(t?"failed:"+t.message:"result:"+JSON.stringify(c))),t)e(t);else if(c){for(var r=!1,s=0;s<n.data.length;s++){var l=n.data[s];if(r=commandman.commandHandlerV6.matchDeviceState(c,l))break;}r?++o<n.devices.length?(i._logger.log("trace","check state of "+o+"th device: "+JSON.stringify(n.devices[o])),commandman.commandHandlerV6.getDeviceStatesWithStateInfo(n.devices[o],a)):e(null,!0):e(null,!1);}else e(null,!1);};this._logger.log("trace","check state of "+o+"th device: "+JSON.stringify(n.devices[o])),commandman.commandHandlerV6.getDeviceStatesWithStateInfo(n.devices[o],a);}else if(t.time){var c=require("x.hub.rule.js").RuleManager.Util,r=c.getMomentNow();if(!c.matchDate(r,t.time))return void e(null,!1);var s=!0,l=null,u=null;if(t.time.from&&(u=c.getAstro(r),(l="sun"==t.time.from.substr(0,3)?c.calculateAstroTarget(r,u[0],u[1],t.time.from):c.calculateTimeTarget(r,t.time.from))&&r.isBefore(l)&&(s=!1)),!s)return void e(null,!1);t.time.until&&(u=c.getAstro(r),(l="sun"==t.time.until.substr(0,3)?c.calculateAstroTarget(r,u[0],u[1],t.time.until):c.calculateTimeTarget(r,t.time.until))&&r.isAfter(l)&&(s=!1)),e(null,s);}else e(new Error("invalid state item"));},t.prototype._doNestedAction=function(e,i,n){this._nestedAction=new t(e,i,{_onActionFinish:function _onActionFinish(){}}),this._nestedAction._actions=i,this._nestedAction._callback=n,this._nestedAction.run();};var e=function e(){this._pool=[],this._count=0;};e.prototype.runAction=function(e,i,n){if(i){this._count++,this._count>65535&&(this._count=1);var o=new t(e,this._count,this);Array.isArray(i)?o._actions=i:o._actions=[i],o._callback=n,this._pool.push(o),o.run();}else n&&n();},e.prototype.cancelAction=function(t){this._pool=this._pool.filter(function(e){return!e||e.getId()!=t||(e.cancel(),!1);});},e.prototype.isActionRunning=function(t){for(var e=0;e<this._pool.length;e++){var i=this._pool[e];if(i&&i.getId()==t)return!0;}return!1;},e.prototype._onActionFinish=function(t){var e=this._pool.indexOf(t);-1!=e&&this._pool.splice(e,1);};var i=function i(){this._logger=require("x.logger.js").getLogger("x.hub.action.ActionManager"),this._dataFolder=null,this._actions=null,this._actionPool=new e(this),this._writing=!1,this._writeCallbacks=[];};return i.FILE_NAME="action.json",i.prototype.init=function(t,e){this._logger.log("info","init action manager"),this._dataFolder=t.getUserRootDataPath(),this._loadActions(function(t){e&&e(t);});},i.prototype.getActions=function(){return this._actions;},i.prototype.getAction=function(t){return this._actions?this._actions[t]:null;},i.prototype.setAction=function(t,e,i){null!=t&&null!=t?(e?this._actions[t]=e:delete this._actions[t],this._writeActions(function(t){i&&i(t,e);})):i&&i(new Error("invalid action id"));},i.prototype.executeActionWithId=function(t,e){var i=this.getAction(t);if(i){var n="act:"+t;this._actionPool.runAction(n,i,e);}else e&&e(new Error("no such action "+t));},i.prototype.executeAction=function(t,e,i){if(this._actionPool.isActionRunning(t))return this._logger.log("trace","action ("+t+") is already running"),void(i&&i());this._actionPool.runAction(t,e,i);},i.prototype.executeActionSingelton=function(t,e,i){this._actionPool.cancelAction(t),this._actionPool.runAction(t,e,i);},i.prototype._loadActions=function(t){var e=require("fs-extra"),i=this._getFile(),n=this;e.ensureFile(i,function(e){e?t(e):n._loadFile(function(e,i){e?t(e):(n._actions=i||{},t());});});},i.prototype._writeActions=function(t){if(t&&-1==this._writeCallbacks.indexOf(t)&&this._writeCallbacks.push(t),!this._writing&&this._writeCallbacks.length){this._writing=!0;var e=this._writeCallbacks;this._writeCallbacks=[];var i=this;this._writeFile(this._actions,function(t){i._writing=!1,e.forEach(function(e){try{e&&e(t);}catch(t){}}),i._writeActions();});}},i.prototype._getFile=function(){return require("path").resolve(this._dataFolder,i.FILE_NAME);},i.prototype._loadFile=function(t){var e=require("fs"),i=this._getFile();e.readFile(i,"utf8",function(e,i){if(e)t(e);else if(i)try{var n=JSON.parse(i);t(null,n);}catch(e){t(null,{});}else t(null,{});});},i.prototype._writeFile=function(t,e){var i=require("fs"),n=this._getFile();i.writeFile(n,JSON.stringify(t,null,2),function(t){e&&e(t);});},i.Action=t,i;}(),x.hub.action.Handler=function(){var t=function t(){this._logger=require("x.logger.js").getLogger("x.hub.action.Handler"),this._actionManager=new x.hub.action.ActionManager();};return t.prototype.ActionManager=x.hub.action.ActionManager,t.prototype.init=function(t,e,i){"CA"==global.HARDWARE_VERSION&&this._initHttpApi(t),this._actionManager.init(e,function(t){t&&i(t);});},t.prototype.getActionManager=function(){return this._actionManager;},t.prototype._initHttpApi=function(){var t=this,e=require("x.hub.js").getServer();e.addRoute("/api/actions",{method:"GET"},function(e,i,n){var o=t._actionManager.getActions();i.json({XC_SUC:o||{}});}),e.addRoute("/api/action",{method:"GET"},function(e,i,n){var o=e.query?e.query.id:null;t._actionManager.executeActionWithId(o,function(t){t?i.json({XC_ERR:{code:"000101",msg:"failed to execute action "+o+":"+t.message}}):i.json({XC_SUC:{}});});}),e.addRoute("/data/act/",{method:"GET"},function(e,i,n){var o=e.path.substr(10),a=t._actionManager.getAction(o);a?i.json({XC_SUC:a}):i.json({XC_ERR:{code:"000101",msg:"failed to open file"}});}),e.addRoute("/data/act/",{method:"POST"},function(e,i){var n=e.path.substr(10);try{var o=e.json;t._actionManager.setAction(n,o,function(t,n){t?i.json({XC_ERR:{code:"000101",msg:"failed to set action:"+t.message}}):n?i.json({XC_SUC:{bytes:e.size}}):i.json({XC_SUC:{bytes:0}});});}catch(t){i.json({XC_ERR:{code:"000101",msg:"failed to set action:"+t.message}});}});},t;}(),module.exports=new x.hub.action.Handler();