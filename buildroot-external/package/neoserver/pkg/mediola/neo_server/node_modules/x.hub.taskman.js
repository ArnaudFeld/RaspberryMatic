var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.checkStringArgs=function(d,b,c){if(null==d)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return d+""};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(d,b,c){d!=Array.prototype&&d!=Object.prototype&&(d[b]=c.value)};$jscomp.getGlobal=function(d){return"undefined"!=typeof window&&window===d?d:"undefined"!=typeof global&&null!=global?global:d};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(d,b,c,e){if(b){c=$jscomp.global;d=d.split(".");for(e=0;e<d.length-1;e++){var k=d[e];k in c||(c[k]={});c=c[k]}d=d[d.length-1];e=c[d];b=b(e);b!=e&&null!=b&&$jscomp.defineProperty(c,d,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("String.prototype.repeat",function(d){return d?d:function(b){var c=$jscomp.checkStringArgs(this,null,"repeat");if(0>b||1342177279<b)throw new RangeError("Invalid count value");b|=0;for(var e="";b;)if(b&1&&(e+=c),b>>>=1)c+=c;return e}},"es6","es3");var util=require("util"),EventEmitter=require("events"),path=require("path"),fs=require("fs"),fs_extra=require("fs-extra"),Logger=require("x.logger.js"),deviceman=require("x.hub.deviceman.js"),fileman=require("x.hub.fileman.js");
Logger.setLevel("debug","x.hub.taskman");var x=x||{};x.hub=x.hub||{};x.hub.taskman=x.hub.taskman||{};x.hub.taskman.ERROR_CODE={General_Error:"100000",Pin_Error:"100001"};
x.hub.taskman.Cloud=function(){var d=function(){};d.prototype.URL="https://webservice.mediola.com";d.prototype._doRequest=function(b,c,e,d,h,a,g){c=require("url").parse(this.URL+c);b={host:c.hostname,port:c.port,path:c.path,method:b,headers:d};if(h||a)b.auth=(h?h:"")+":"+(a?a:"");h=require("http");"https:"==c.protocol?(h=require("https"),process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),b.port||(b.port=443)):b.port||(b.port=80);var k=g;g=h.request(b,function(a){var c="";a.on("data",
function(a){c+=a});a.on("end",function(){var b=null;200!=a.statusCode&&(b=Error("http response error"));k&&k(b,c,a.statusCode,a.headers)})});g.setTimeout(5E3,function(){k&&k(Error("timeout"));k=null});g.on("error",function(a){k&&k(a);k=null});e&&g.write(e);g.end()};return d}();
x.hub.taskman._Util={TimeZone_MAP:[{utc:0,dst:!1,zone:"Etc/UTC"},{utc:0,dst:!0,zone:"CET"},{utc:1,dst:!1,zone:"Etc/GMT-1"},{utc:1,dst:!0,zone:"Europe/Berlin"},{utc:2,dst:!1,zone:"Etc/GMT-2"},{utc:2,dst:!0,zone:"EET"},{utc:3,dst:!1,zone:"Etc/GMT-3"},{utc:3,dst:!0,zone:"Asia/Tehran"},{utc:4,dst:!1,zone:"Etc/GMT-4"},{utc:4,dst:!0,zone:"Asia/Kabul"},{utc:5,dst:!1,zone:"Etc/GMT-5"},{utc:5,dst:!0,zone:"Etc/GMT-5"},{utc:6,dst:!1,zone:"Etc/GMT-6"},{utc:6,dst:!0,zone:"Etc/GMT-6"},{utc:7,dst:!1,zone:"Etc/GMT-7"},
{utc:7,dst:!0,zone:"Asia/Hovd"},{utc:8,dst:!1,zone:"Etc/GMT-8"},{utc:8,dst:!0,zone:"Asia/Ulaanbaatar"},{utc:9,dst:!1,zone:"Etc/GMT-9"},{utc:9,dst:!0,zone:"Australia/Adelaide"},{utc:10,dst:!1,zone:"Etc/GMT-10"},{utc:10,dst:!0,zone:"Australia/Sydney"},{utc:11,dst:!1,zone:"Etc/GMT-11"},{utc:11,dst:!0,zone:"Etc/GMT-11"},{utc:12,dst:!1,zone:"Etc/GMT-12"},{utc:12,dst:!0,zone:"Pacific/Auckland"},{utc:13,dst:!1,zone:"Etc/GMT-13"},{utc:13,dst:!0,zone:"Pacific/Apia"},{utc:14,dst:!1,zone:"Etc/GMT-14"},{utc:14,
dst:!0,zone:"Etc/GMT-14"},{utc:-1,dst:!1,zone:"Etc/GMT+1"},{utc:-1,dst:!0,zone:"Etc/GMT+1"},{utc:-2,dst:!1,zone:"Etc/GMT+2"},{utc:-2,dst:!0,zone:"Etc/GMT+2"},{utc:-3,dst:!1,zone:"Etc/GMT+3"},{utc:-3,dst:!0,zone:"America/Sao_Paulo"},{utc:-4,dst:!1,zone:"Etc/GMT+4"},{utc:-4,dst:!0,zone:"America/Santiago"},{utc:-5,dst:!1,zone:"Etc/GMT+5"},{utc:-5,dst:!0,zone:"America/New_York"},{utc:-6,dst:!1,zone:"Etc/GMT+6"},{utc:-6,dst:!0,zone:"CST6CDT"},{utc:-7,dst:!1,zone:"Etc/GMT+7"},{utc:-7,dst:!0,zone:"MST7MDT"},
{utc:-8,dst:!1,zone:"Etc/GMT+8"},{utc:-8,dst:!0,zone:"PST8PDT"},{utc:-9,dst:!1,zone:"Etc/GMT+9"},{utc:-9,dst:!0,zone:"America/Anchorage"},{utc:-10,dst:!1,zone:"Etc/GMT+10"},{utc:-10,dst:!0,zone:"America/Adak"},{utc:-11,dst:!1,zone:"Etc/GMT+11"},{utc:-11,dst:!0,zone:"Etc/GMT+11"}],_getTimeZone:function(){var d="8C";localStorage.getItem("x.hub.Server.timezone")&&(d=localStorage.getItem("x.hub.Server.timezone"));d=parseInt(d,16);var b=0!=(d&128),c=(d&31)-11,e=null;this.TimeZone_MAP.forEach(function(k){k.utc==
c&&k.dst==b&&(e=k.zone)});e||(e="Europe/Berlin");return e},_getlatlong:function(){var d="1392",b="035C";localStorage.getItem("x.hub.Server.geo.lat")&&(d=localStorage.getItem("x.hub.Server.geo.lat"));localStorage.getItem("x.hub.Server.geo.long")&&(b=localStorage.getItem("x.hub.Server.geo.long"));d=parseInt(d,16);32768<d&&(d=32768-d);d/=100;b=parseInt(b,16);32768<b&&(b=32768-b);return{lat:d,long:b/100}}};
x.hub.taskman._TimerManager=function(){var d=function(c,b){this._logger=require("x.logger.js").getLogger("x.hub.taskman._TimerManager.CronTimer");this.taskID=c;this.timer=b;this._cronJob=null};d.prototype.start=function(){if(this.timer.time){var c=[],b=this.timer.time.indexOf(":"),k=this.timer.time.substr(0,b);b=this.timer.time.substr(b+1);c.push("00");c.push(b);c.push(k);c.push("*");c.push("*");k="0-6";if(this.timer.week&&7==this.timer.week.length){k=[];"1"==this.timer.week.charAt(6)&&k.push(0);
for(b=0;6>b;b++)"1"==this.timer.week.charAt(b)&&k.push(b+1);k=k.join(",")}c.push(k);c=c.join(" ");k=x.hub.taskman._Util._getTimeZone();this._logger.log("debug","start timer:"+JSON.stringify(this.timer));this._logger.log("trace","start cron job:"+c+" tz:"+k);this._cronJob=new (require("cron").CronJob)(c,this.onTick.bind(this),null,!0,k)}};d.prototype.stop=function(){this._logger.log("debug","stop timer:"+JSON.stringify(this.timer));this._cronJob&&(this._cronJob.stop(),this._cronJob=null)};d.prototype.onTick=
function(){this._logger.log("debug","timer tick:"+JSON.stringify(this.timer));var c=require("moment-timezone"),b=x.hub.taskman._Util._getTimeZone(),k=(new Date).getTime();k=c.tz(k,b);var d=k.year(),a=this.timer.start;if(a&&("00"==a.substr(0,2)&&(a=d+a.substr(2)),a=c.tz(a,b),a.set({hour:0,minute:0,second:0,millisecond:0}),a.valueOf()>k.valueOf()))return;if(a=this.timer.end)if("00"==a.substr(0,2)&&(a=d+a.substr(2)),a=c.tz(a,b),a.set({hour:23,minute:59,second:59,millisecond:999}),a.valueOf()<k.valueOf())return;
require("x.hub.taskman.js").taskManager.onTimerTick(this.taskID)};d.prototype.onLocationChange=function(){this.stop();this.start()};d.prototype.onTimeChange=function(){this.stop();this.start()};var b=function(){this._timers=[]};b.prototype.startTimer=function(c,b){c=new d(c,b);this._timers.push(c);c.start()};b.prototype.stopTimer=function(c){var b=[];this._timers.forEach(function(e){e.taskID==c?e.stop():b.push(e)});this._timers=b};b.prototype.onLocationChange=function(){this._timers.forEach(function(c){c.onLocationChange()})};
b.prototype.onTimeChange=function(){this._timers.forEach(function(c){c.onTimeChange()})};b.prototype.clear=function(){var c=this._timers;this._timers=[];c.forEach(function(c){c.stop()})};return new b}();
x.hub.taskman._AstroManager=function(){var d=function(c,b){this._logger=require("x.logger.js").getLogger("x.hub.taskman._AstroManager.AstroTimer");this.taskID=c;this.astro=b;this._job=null};d.prototype.start=function(){this.astro.astro&&(this._logger.log("debug","start astro:"+JSON.stringify(this.astro)),this._startNextTick())};d.prototype.stop=function(){this._logger.log("debug","stop astro:"+JSON.stringify(this.astro));this._job&&(clearTimeout(this._job),this._job=null)};d.prototype._startNextTick=
function(){var c=this._getNextTickTime();this._logger.log("debug","next "+this.astro.astro+":"+new Date(c));var b=(new Date).getTime(),d=this;this._job=setTimeout(function(){d.onTick()},c-b)};d.prototype._getNextTickTime=function(){var c=x.hub.taskman._Util._getlatlong(),b=require("suncalc"),d=new Date,h=b.getTimes(d,c.lat,c.long);h="sunrise"==this.astro.astro?h.sunrise:h.sunset;h=h.getTime();this.astro.delay&&(h+=6E4*parseInt(this.astro.delay));h<=d.getTime()&&(d=new Date(d.getTime()+864E5),h=b.getTimes(d,
c.lat,c.long),h="sunrise"==this.astro.astro?h.sunrise:h.sunset,h=h.getTime(),this.astro.delay&&(h+=6E4*parseInt(this.astro.delay)));return h};d.prototype.onTick=function(){this._logger.log("debug","astro tick:"+JSON.stringify(this.astro));var b=require("moment-timezone"),e=x.hub.taskman._Util._getTimeZone(),d=(new Date).getTime();d=b.tz(d,e);var h=d.year();if(this.astro.offTime){var a=this.astro.offTime.indexOf(":"),g=this.astro.offTime.substr(0,a);a=this.astro.offTime.substr(a+1);g=parseInt(g);a=
parseInt(a);if(d.hour()<g||d.hour()==g&&d.minute()<=a)return}g=d.day();0==g&&(g=7);if(!this.astro.week||7!=this.astro.week.length||"0"!=this.astro.week.charAt(g-1)){if(g=this.astro.start)if("00"==g.substr(0,2)&&(g=h+g.substr(2)),g=b.tz(g,e),g.set({hour:0,minute:0,second:0,millisecond:0}),g.valueOf()>d.valueOf())return;if(g=this.astro.end)if("00"==g.substr(0,2)&&(g=h+g.substr(2)),g=b.tz(g,e),g.set({hour:23,minute:59,second:59,millisecond:999}),g.valueOf()<d.valueOf())return;this._startNextTick();require("x.hub.taskman.js").taskManager.onTimerTick(this.taskID)}};
d.prototype.onLocationChange=function(){this.stop();this.start()};d.prototype.onTimeChange=function(){this.stop();this.start()};var b=function(){this._timers=[]};b.prototype.startTimer=function(b,e){b=new d(b,e);this._timers.push(b);b.start()};b.prototype.stopTimer=function(b){var c=[];this._timers.forEach(function(e){e.taskID==b?e.stop():c.push(e)});this._timers=c};b.prototype.onLocationChange=function(){this._timers.forEach(function(b){b.onLocationChange()})};b.prototype.onTimeChange=function(){this._timers.forEach(function(b){b.onTimeChange()})};
b.prototype.clear=function(){var b=this._timers;this._timers=[];b.forEach(function(b){b.stop()})};b.prototype.getSunriseSunset=function(b){var c=require("moment-timezone"),d=x.hub.taskman._Util._getTimeZone();b=c.tz(b,d);b.set({hour:12,minute:0,second:0,millisecond:0});c=x.hub.taskman._Util._getlatlong();return require("suncalc").getTimes(b.toDate(),c.lat,c.long)};return new b}();
x.hub.taskman._PeriodicTimerManager=function(){var d=function(b,e){this._logger=require("x.logger.js").getLogger("x.hub.taskman._PeriodicTimerManager.CronTimer");this.taskID=b;this.timer=e;this._repeater=this._cronJob=this._starter=null};d.prototype.start=function(){if(this.timer.interval){var b=this.timer.startTime,e=this.timer.endTime;b||(b="00:00");e||(e="23:59");var d=[],h=b.indexOf(":"),a=b.substr(0,h);h=b.substr(h+1);d.push("00");d.push(h);d.push(a);d.push("*");d.push("*");var g="0-6";if(this.timer.week&&
7==this.timer.week.length){g=[];"1"==this.timer.week.charAt(6)&&g.push(0);for(var l=0;6>l;l++)"1"==this.timer.week.charAt(l)&&g.push(l+1);g=g.join(",")}d.push(g);d=d.join(" ");g=x.hub.taskman._Util._getTimeZone();this._logger.log("debug","start timer:"+JSON.stringify(this.timer));this._logger.log("trace","start cron job:"+d+" tz:"+g);this._cronJob=new (require("cron").CronJob)(d,this.onFirstTick.bind(this),null,!0,g);l=require("moment-timezone");var t=(new Date).getTime();d=l.tz(t,g);a=d.year();var n=
this.timer.start;if(n&&("00"==n.substr(0,2)&&(n+=n.substr(2)),n=l.tz(n,g),n.set({hour:0,minute:0,second:0,millisecond:0}),n.valueOf()>d.valueOf()))return;if(n=this.timer.end)if("00"==n.substr(0,2)&&(n=a+n.substr(2)),n=l.tz(n,g),n.set({hour:23,minute:59,second:59,millisecond:999}),n.valueOf()<d.valueOf())return;if(a=this.timer.week)if(n=d.isoWeekday(),"1"!=a.charAt(n-1))return;n=l.tz(t,g);h=b.indexOf(":");a=b.substr(0,h);h=b.substr(h+1);n.set({hour:parseInt(a),minute:parseInt(h),second:0,millisecond:0});
if(!(n.valueOf()>d.valueOf()||(b=l.tz(t,g),h=e.indexOf(":"),a=e.substr(0,h),h=e.substr(h+1),b.set({hour:parseInt(a),minute:parseInt(h),second:0,millisecond:0}),b.valueOf()<d.valueOf()||!(e=this.timer.interval)))){e=1E3*parseInt(e);e=Math.ceil((d.valueOf()-n.valueOf())/e)*e+n.valueOf()-d.valueOf();this._logger.log("trace","first tick in "+e/1E3+" seconds");var q=this;this._starter=setTimeout(function(){q.onFirstTick()},e)}}};d.prototype.stop=function(){this._logger.log("debug","stop timer:"+JSON.stringify(this.timer));
this._cronJob&&(this._cronJob.stop(),this._cronJob=null);this._repeater&&(clearInterval(this._repeater),this._repeater=null);this._starter&&(clearTimeout(this._starter),this._starter=null)};d.prototype.onFirstTick=function(){this._logger.log("debug","periodic timer first tick:"+JSON.stringify(this.timer));var b=this.timer.interval;if(b){b=1E3*parseInt(b);var d=this;this._starter&&(clearTimeout(this._starter),this._starter=null);this._repeater&&(clearInterval(this._repeater),this._repeater=null);this._repeater=
setInterval(function(){d.onTick()},b);this.onTick()}};d.prototype.onTick=function(){this._logger.log("debug","periodic timer tick:"+JSON.stringify(this.timer));var b=require("moment-timezone"),d=this.timer.interval;d=1E3*parseInt(d);var k=x.hub.taskman._Util._getTimeZone(),h=(new Date).getTime();d=h+d;var a=b.tz(h,k);h=b.tz(h,k);var g=h.year(),l=this.timer.start;if(l&&("00"==l.substr(0,2)&&(l=g+l.substr(2)),l=b.tz(l,k),l.set({hour:0,minute:0,second:0,millisecond:0}),l.valueOf()>h.valueOf()))return;
if(l=this.timer.end)if("00"==l.substr(0,2)&&(l=g+l.substr(2)),l=b.tz(l,k),l.set({hour:23,minute:59,second:59,millisecond:999}),l.valueOf()<h.valueOf())return;(k=this.timer.endTime)||(k="23:59");g=k.indexOf(":");b=k.substr(0,g);k=k.substr(g+1);a.set({hour:parseInt(b),minute:parseInt(k),second:59,millisecond:999});a.valueOf()<h.valueOf()?(this._logger.log("trace","repeater exceed end time:"+a.toString()),this._repeater&&(clearInterval(this._repeater),this._repeater=null)):(d>a.valueOf()&&(this._logger.log("trace",
"repeater next tick will exceed end time:"+a.toString()),this._repeater&&(clearInterval(this._repeater),this._repeater=null)),require("x.hub.taskman.js").taskManager.onTimerTick(this.taskID))};d.prototype.onLocationChange=function(){this.stop();this.start()};d.prototype.onTimerChange=function(){this.stop();this.start()};var b=function(){this._timers=[]};b.prototype.startTimer=function(b,e){b=new d(b,e);this._timers.push(b);b.start()};b.prototype.stopTimer=function(b){var c=[];this._timers.forEach(function(d){d.taskID==
b?d.stop():c.push(d)});this._timers=c};b.prototype.onLocationChange=function(){this._timers.forEach(function(b){b.onLocationChange()})};b.prototype.onTimeChange=function(){this._timers.forEach(function(b){b.onTimeChange()})};b.prototype.clear=function(){var b=this._timers;this._timers=[];b.forEach(function(b){b.stop()})};return new b}();
x.hub.taskman._Block=function(){var d=function(f){this.type=f;this._parent=null;this._canceling=this._running=!1;this._trace=null};d.prototype.isRunning=function(){return this._running};d.prototype.do=function(f){f&&f()};d.prototype.cancel=function(f){var a=this._running;this._canceling=this._running=!1;f&&f(null,a)};d.prototype.toJSON=function(){return{type:this.type}};d.prototype.fromJSON=function(){};d.prototype.setTrace=function(f){this._trace=f};var b=function(){d.call(this);this.type=b.TYPE;
this.subtype=null;this.flowIf=[];this.flowThen=[];this.flowElse=[]};util.inherits(b,d);b.TYPE="condition";b.prototype.isRunning=function(){var f=!1;this.flowIf&&this.flowIf.forEach(function(a){a&&a.isRunning&&(f|=a.isRunning())});this.flowThen&&this.flowThen.forEach(function(a){a&&a.isRunning&&(f|=a.isRunning())});this.flowElse&&this.flowElse.forEach(function(a){a&&a.isRunning&&(f|=a.isRunning())});return f?!0:!1};b.prototype.do=function(f,a){var b=this;this._trace&&this._trace.log('condition | check "if"');
this._checkIfBlocks(function(m,c){b._trace&&b._trace.log('condition | check "if" - '+(m?"error:"+m.message:c));m?f&&f(m):c?(b._trace&&b._trace.log('condition | do "then"'),b._doThenBlocks(f,a)):(b._trace&&b._trace.log('condition | do "else"'),b._doElseBlocks(f,a))},a)};b.prototype.cancel=function(f){var a=0;this.flowIf&&this.flowIf.forEach(function(f){f&&f.cancel?f.cancel():a++});this.flowThen&&this.flowThen.forEach(function(f){f&&f.cancel?f.cancel():a++});this.flowElse&&this.flowElse.forEach(function(f){f&&
f.cancel?f.cancel():a++})};b.prototype.toJSON=function(){var f={type:this.type,subtype:this.subtype,if:[],then:[],else:[]};this.flowIf&&this.flowIf.forEach(function(a){a&&f.if.push(a.toJSON())});this.flowThen&&this.flowThen.forEach(function(a){a&&f.then.push(a.toJSON())});this.flowElse&&this.flowElse.forEach(function(a){a&&f.else.push(a.toJSON())});return f};b.prototype.fromJSON=function(f){if(f){var a=this;this.subtype=f.subtype;f.if&&0<f.if.length&&f.if.forEach(function(f){f&&(f=d.parse(f))&&(f._parent=
a,a.flowIf.push(f))});f.then&&0<f.then.length&&f.then.forEach(function(f){f&&(f=d.parse(f))&&a.flowThen.push(f)});f.else&&0<f.else.length&&f.else.forEach(function(f){f&&(f=d.parse(f))&&a.flowElse.push(f)})}};b.prototype._checkIfBlocks=function(f,a){var b=[],c=0,g=this;if(this.flowIf&&0!=this.flowIf.length){var m=function(d,e){c++;d?b.push(!1):b.push(e);if(c<g.flowIf.length)g.flowIf[c].do(m,a);else if(0==b.length)f&&f(null,!0);else{d=1;for(e=b[0];d<b.length&&d+1!=b.length;)"AND"==b[d]?e&=b[d+1]:"OR"==
b[d]?e|=b[d+1]:"XOR"==b[d]&&(e=e!=b[d+1]),d+=2;f&&f(null,e)}};this.flowIf[c].do(m,a)}else f&&f(null,!0)};b.prototype._doThenBlocks=function(f,a){var b=0,c=this;if(this.flowThen&&0!=this.flowThen.length){var g=function(){b++;b<c.flowThen.length?c.flowThen[b].do(g,a):f&&f()};this.flowThen[b].do(g,a)}else f&&f()};b.prototype._doElseBlocks=function(f,a){var b=0,c=this;if(this.flowElse&&0!=this.flowElse.length){var g=function(){b++;b<c.flowElse.length?c.flowElse[b].do(g,a):f&&f()};this.flowElse[b].do(g,
a)}else f&&f()};b.prototype.setTrace=function(f){this._trace=f;this.flowIf&&this.flowIf.forEach(function(a){a&&a.setTrace&&a.setTrace(f)});this.flowThen&&this.flowThen.forEach(function(a){a&&a.setTrace&&a.setTrace(f)});this.flowElse&&this.flowElse.forEach(function(a){a&&a.setTrace&&a.setTrace(f)})};d.Condition=b;var c=function(){b.call(this);this.type=d.Root.TYPE;this._lastTiggerTime=this._taskID=null;this.singleton=!1;this.singletonMethod="ignore";this._task=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.Root")};
util.inherits(c,b);c.TYPE="root";c.prototype.init=function(f){this._taskID=f;this.flowIf.forEach(function(a){a&&a.init&&a.init(f)})};c.prototype.finalize=function(f){this.flowIf.forEach(function(a){a&&a.finalize&&a.finalize(f)})};c.prototype._onTriggered=function(f,a){var b=(new Date).getTime();if(!(this._lastTiggerTime&&400>b-this._lastTiggerTime)){if(this.singleton&&this._running){if("ignore"==this.singletonMethod){this._logger.log("debug","task "+this._taskID+" is running and ignore the new trigger");
f&&f();return}this._logger.log("debug","task "+this._taskID+" is running and cancel it");this.cancel()}this._logger.log("info","task "+this._taskID+" triggered");this._logger.log("trace","task "+this._taskID+" is "+(this._running?"running":"not running"));this._lastTiggerTime=b;this._trace&&this._trace.log("root | task:"+this._taskID+" triggered");this._running=!0;var c=this;this._doThenBlocks(function(){c._running=!1;f&&f()},{trigger:a,task:this._task})}};c.prototype.onStatusEvt=function(f){var a=
!1;this._logger.log("trace","check trigger for status event");for(var b=null,c=0;c<this.flowIf.length;c++){var g=this.flowIf[c];if((g.type==n.TYPE||g.type==q.TYPE)&&g.isMatch(f)){this._logger.log("debug","trigger hit:"+JSON.stringify(g.toJSON()));a=!0;b=g;break}}a&&this._onTriggered(null,b)};c.prototype.onDedicatedStatusEvt=function(f){var a=!1;this._logger.log("trace","check trigger for status event");for(var b=null,c=0;c<this.flowIf.length;c++){var g=this.flowIf[c];if(g.type==n.TYPE){if(g.isMatch(f)){this._logger.log("debug",
"trigger hit:"+JSON.stringify(g.toJSON()));a=!0;b=g;break}}else if(g.type==q.TYPE&&g.isMatch(f)){this._logger.log("debug","trigger hit:"+JSON.stringify(g.toJSON()));a=!0;b=g;break}}a&&this._onTriggered(null,b)};c.prototype.onIREvt=function(f){this._trace&&this._trace.log("root | receive ir event:"+JSON.stringify(f));var a=!1;this._logger.log("trace","check trigger for ir event");for(var b=0;b<this.flowIf.length;b++){var c=this.flowIf[b];if(c.type==t.TYPE&&c.isMatch(f)){this._logger.log("debug","trigger hit:"+
JSON.stringify(c.toJSON()));a=!0;break}}a&&this._onTriggered()};c.prototype.onTimerTick=function(){this._trace&&this._trace.log("root | timer tick");this._onTriggered()};c.prototype.onHttpEvt=function(a,b){this._trace&&this._trace.log("root | receive http event:"+JSON.stringify(a));for(var f=!1,c=0;c<this.flowIf.length;c++){var g=this.flowIf[c];if(g.type==h.TYPE&&g.isMatch(a)){this._logger.log("info","trigger hit:"+JSON.stringify(g.toJSON()));f=!0;break}}f&&this._onTriggered();b&&b(null,f)};c.prototype.setTrace=
function(a){this._trace=a;this.flowIf&&this.flowIf.forEach(function(f){f&&f.setTrace&&f.setTrace(a)});this.flowThen&&this.flowThen.forEach(function(f){f&&f.setTrace&&f.setTrace(a)})};d.Root=c;var e=function(a){d.call(this);this.type=e.TYPE;a&&(this.op=a.op)};util.inherits(e,d);e.TYPE="logic.operator";e.prototype.do=function(a){a&&a(null,this.op)};e.prototype.toJSON=function(){var a=d.prototype.toJSON.call(this);a.op=this.op;return a};e.prototype.fromJSON=function(a){a&&(this.op=a.op)};d.LogicOP=e;
var k=function(){d.call(this);this.type=k.TYPE;this.children=[]};util.inherits(k,d);k.TYPE="bracket";k.prototype.do=function(a){var f=[],b=0,c=this;if(this.children&&0!==this.children.length){var g=function(d,m){b++;d?f.push(!1):f.push(m);if(b<c.children.length)c.children[b].do(g);else if(0===f.length)a&&a(null,!0);else{d=1;for(m=f[0];d<f.length&&d+1!=f.length;)"AND"==f[d]?m&=f[d+1]:"OR"==f[d]?m|=f[d+1]:"XOR"==f[d]&&(m=m!=f[d+1]),d+=2;a&&a(null,m)}};this.children[b].do(g)}else a&&a(null,!0)};k.prototype.toJSON=
function(){var a=d.prototype.toJSON.call(this);a.children=[];this.children&&this.children.forEach(function(f){f&&a.children.push(f.toJSON())});return a};k.prototype.fromJSON=function(a){if(a){var f=this;a.children&&0<a.children.length&&a.children.forEach(function(a){a&&(a=d.parse(a))&&f.children.push(a)})}};d.Bracket=k;var h=function(){d.call(this);this.type=h.TYPE;this.params=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.HttpTrigger")};util.inherits(h,d);h.TYPE="http.trigger";
h.prototype.isMatch=function(a){if(!a||!this.params)return!1;for(var f in this.params)if(f&&this.params[f]!=a[f])return!1;this._logger.log("trace","trigger hit:"+JSON.stringify(this.toJSON()));return!0};h.prototype.toJSON=function(){var a=d.prototype.toJSON.call(this);a.params=this.params;return a};h.prototype.fromJSON=function(a){a&&(this.params=a.params)};d.HttpTrigger=h;var a=function(){d.call(this);this.type=a.TYPE;this.op=this.end=this.start=this.week=this.time=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.Timer")};
util.inherits(a,d);a.TYPE="timer";a.prototype.init=function(a){x.hub.taskman._TimerManager.startTimer(a,this)};a.prototype.do=function(a){this._trace&&this._trace.log("check time | "+this._getDescription());var f=require("moment-timezone"),b=x.hub.taskman._Util._getTimeZone(),c=(new Date).getTime();c=f.tz(c,b);var g=c.year(),d=this.start;if(d&&("00"==d.substr(0,2)&&(d=g+d.substr(2)),d=f.tz(d,b),d.set({hour:0,minute:0,second:0,millisecond:0}),d.valueOf()>c.valueOf())){this._logger.log("trace","condition mismatch:"+
JSON.stringify(this.toJSON()));a&&a(null,!1);return}if(d=this.end)if("00"==d.substr(0,2)&&(d=g+d.substr(2)),d=f.tz(d,b),d.set({hour:23,minute:59,second:59,millisecond:999}),d.valueOf()<c.valueOf()){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));a&&a(null,!1);return}if(f=this.week)if(b=c.day(),0==b&&(b=7),"1"!=f.charAt(b-1)){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));a&&a(null,!1);return}if(this.time&&this.op)if(b=this.time.indexOf(":"),
f=this.time.substr(0,b),b=this.time.substr(b+1),f=parseInt(f),b=parseInt(b),g=c.hour(),c=c.minute(),">="==this.op){if(g<f||g==f&&c<b){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));a&&a(null,!1);return}}else if(">"==this.op){if(g<f||g==f&&c<=b){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));a&&a(null,!1);return}}else if("<="==this.op){if(g>f||g==f&&c>b){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));a&&a(null,
!1);return}}else if("<"==this.op){if(g>f||g==f&&c>=b){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));a&&a(null,!1);return}}else if("="==this.op||"=="==this.op)if(g!=f||g==f&&c!=b){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));a&&a(null,!1);return}this._logger.log("trace","condition match:"+JSON.stringify(this.toJSON()));a&&a(null,!0)};a.prototype.finalize=function(a){x.hub.taskman._TimerManager.stopTimer(a)};a.prototype.toJSON=function(){var a=
d.prototype.toJSON.call(this);a.time=this.time;a.week=this.week;a.start=this.start;a.end=this.end;a.op=this.op;return a};a.prototype.fromJSON=function(a){a&&(this.time=a.time,this.week=a.week,this.start=a.start,this.end=a.end,this.op=a.op)};a.prototype._getDescription=function(){var a="time:"+this.time;a+=" week:"+this.week;a+=" start:"+this.start;a+=" end:"+this.end;return a+=" op:"+this.op};d.Timer=a;var g=function(){d.call(this);this.type=g.TYPE;this.op=this.end=this.start=this.week=this.delay=
this.offTime=this.astro=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.Astro")};util.inherits(g,d);g.TYPE="astro";g.prototype.init=function(a){x.hub.taskman._AstroManager.startTimer(a,this)};g.prototype.do=function(a){this._trace&&this._trace.log("check astro | "+this._getDescription());var f=require("moment-timezone"),b=x.hub.taskman._Util._getTimeZone(),c=(new Date).getTime();c=f.tz(c,b);var g=c.year(),d=this.start;if(d&&("00"==d.substr(0,2)&&(d=g+d.substr(2)),d=f.tz(d,
b),e.set({hour:0,minute:0,second:0,millisecond:0}),d.valueOf()>c.valueOf())){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));a&&a(null,!1);return}var e=this.end;if(e&&("00"==e.substr(0,2)&&(e=g+e.substr(2)),e=f.tz(e,b),e.set({hour:23,minute:59,second:59,millisecond:999}),e.valueOf()<c.valueOf())){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));a&&a(null,!1);return}if(f=this.week)if(b=c.day(),0==b&&(b=7),"1"!=f.charAt(b-1)){this._logger.log("trace",
"condition mismatch:"+JSON.stringify(this.toJSON()));a&&a(null,!1);return}f=!1;this.astro&&this.op&&(b=x.hub.taskman._AstroManager.getSunriseSunset(c.toDate()),b="sunrise"==this.astro?b.sunrise.getTime():b.sunset.getTime(),this.delay&&(b+=6E4*parseInt(this.delay)),">="==this.op&&c.valueOf()>=b?f=!0:">"==this.op&&c.valueOf()>b?f=!0:"<="==this.op&&c.valueOf()<=b?f=!0:"<"==this.op&&c.valueOf()<b?f=!0:("="==this.op||"=="==this.op)&&c.valueOf()==b&&(f=!0));this._logger.log("trace","condition "+(f?"match":
"mismatch")+":"+JSON.stringify(this.toJSON()));a&&a(null,f)};g.prototype.finalize=function(a){x.hub.taskman._AstroManager.stopTimer(a)};g.prototype.toJSON=function(){var a=d.prototype.toJSON.call(this);a.astro=this.astro;a.offTime=this.offTime;a.delay=this.delay;a.week=this.week;a.start=this.start;a.end=this.end;a.op=this.op;return a};g.prototype.fromJSON=function(a){a&&(this.astro=a.astro,this.offTime=a.offTime,this.delay=a.delay,this.week=a.week,this.start=a.start,this.end=a.end,this.op=a.op)};
g.prototype._getDescription=function(){var a="astro:"+this.astro;a+=" offTime:"+this.offTime;a+=" delay:"+this.delay;a+=" week:"+this.week;a+=" start:"+this.start;a+=" end:"+this.end;return a+=" op:"+this.op};d.Astro=g;var l=function(){d.call(this);this.type=l.TYPE;this.end=this.start=this.week=this.endTime=this.startTime=this.interval=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.Periodic")};util.inherits(l,d);l.TYPE="periodic";l.prototype.init=function(a){x.hub.taskman._PeriodicTimerManager.startTimer(a,
this)};l.prototype.finalize=function(a){x.hub.taskman._PeriodicTimerManager.stopTimer(a)};l.prototype.toJSON=function(){var a=d.prototype.toJSON.call(this);a.interval=this.interval;a.startTime=this.startTime;a.endTime=this.endTime;a.week=this.week;a.start=this.start;a.end=this.end;return a};l.prototype.fromJSON=function(a){a&&(this.interval=a.interval,this.startTime=a.startTime,this.endTime=a.endTime,this.week=a.week,this.start=a.start,this.end=a.end)};d.Periodic=l;var t=function(){d.call(this);this.type=
t.TYPE;this._lastTiggerTime=this.ir=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.IRTrigger")};util.inherits(t,d);t.TYPE="ir";t.prototype.isMatch=function(a){if(!(a&&a.code&&this.ir&&this.ir.code))return!1;var f=this._getDataCode(this.ir.code);a=this._getDataCode(a.code);if(f==a){f=(new Date).getTime();if(!this._lastTiggerTime)return this._lastTiggerTime=f,!0;if(1E3>f-this._lastTiggerTime)return!1;this._lastTiggerTime=f;return!0}return!1};t.prototype.toJSON=function(){var a=
d.prototype.toJSON.call(this);a.ir=this.ir;return a};t.prototype.fromJSON=function(a){a&&(this.ir=a.ir)};t.prototype._getDataCode=function(a){a=new Buffer(a,"hex");var f=a.readInt8(8);return a.slice(4*f+9).toString("hex")};d.IRTrigger=t;var n=function(){d.call(this);this.type=n.TYPE;this._cancelCB=this._lastTiggerTime=this.hysteresis=this.value=this.op=this.status=this.gateway=this.device=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.DeviceStatus");this._gatewayName=this._deviceName=
null};util.inherits(n,d);n.TYPE="device.status";n.prototype.init=function(a){if(this.device||this.gateway){var f=null;this.gateway&&this.gateway.sys&&(f=this.gateway.sys);!f&&this.device&&this.device.sys&&(f=this.device.sys);if(f&&("hm"!=f||this.gateway?"neoserver"==f&&(f="aio"):f="aio",(f=require("x.hub.moduleman.js").modulemanager.getModule(f))&&f.addStateDevice)){var b={},c=this._getDevice(),g=this._getGateway();c&&(b=c);delete b.gateway;g&&(b.gateway=g);c=this.status;c.ref&&c.ref.value?c=c.ref.value:
c.value&&(c=c.value);f.addStateDevice(b,null,{taskID:a,statusKey:c,src:"taskman",callback:this})}}};n.prototype.finalize=function(a){if(this.device||this.gateway){var f=null;this.gateway&&this.gateway.sys&&(f=this.gateway.sys);!f&&this.device&&this.device.sys&&(f=this.device.sys);if(f&&(f=require("x.hub.moduleman.js").modulemanager.getModule(f))&&f.removeStateDevice){var b={},c=this._getDevice(),g=this._getGateway();c&&(b=c);delete b.gateway;g&&(b.gateway=g);c=this.status;c.ref&&c.ref.value?c=c.ref.value:
c.value&&(c=c.value);f.removeStateDevice(b,null,{taskID:a,statusKey:c,src:"taskman",callback:this})}}};n.prototype.do=function(a){if(this.device||this.gateway)if(this.status&&this.op){var f=this.status;this.status.ref&&(f=this.status.ref);f.value&&(f=f.value);f={value:f};this.status&&this.status.value?f=this.status:this.status&&this.status.ref&&(f=this.status.ref);var b=this,c=this._getDevice(),g=this._getGateway();this._logger.log("trace","get states:"+JSON.stringify(this.toJSON()));this._trace&&
this._trace.log("get status | "+this._getDescription());this._running=!0;require("x.hub.commandman.js").commandHandler.getState(c,g,f,function(f){if(b._canceling){b._logger.log("trace","get states canceled:"+JSON.stringify(b.toJSON()));b._canceling=!1;f=b._running;b._running=!1;var c=b._cancelCB;b._cancelCB=null;c&&c(null,f)}else if(b._running=!1,!f||f.error?b._trace&&b._trace.log("get status | "+b._getDescription()+" | error:"+(f?f.error.message:"invalid response")):("undefined"==typeof f.data||
null==f.data)&&b._trace&&b._trace.log("get status | "+b._getDescription()+" | error:no status"),!f||f.error)a&&a(f?f.error:Error("get state error"));else if("undefined"==typeof f.data||null==f.data)a&&a(null,!1);else{c=f.data.value;var g=!1;"="==b.op||"=="==b.op?g="true"==b.value?"true"==String(c):"false"==b.value?"false"==String(c):c==b.value:"!="==b.op?g="true"==b.value?"true"!=String(c):"false"==b.value?"false"!=String(c):c!=b.value:">="==b.op?g=parseFloat(c)>=parseFloat(b.value):">"==b.op?g=parseFloat(c)>
parseFloat(b.value):"<="==b.op?g=parseFloat(c)<=parseFloat(b.value):"<"==b.op&&(g=parseFloat(c)<parseFloat(b.value));b._logger.log("trace","condition "+(g?"match":"mismatch")+":"+JSON.stringify(b.toJSON()));b._trace&&b._trace.log("get status | "+b._getDescription()+" | success:"+JSON.stringify(f.data)+" | match="+g);a&&a(null,g)}})}else a&&a(Error("no status point or operator"));else a&&a(Error("no device or gateway"))};n.prototype.cancel=function(a){this._running?(this._canceling=!0,this._cancelCB=
a):a&&a(null,this._running)};n.prototype.isMatch=function(a){if(!a||!a.device||!a.device.sys)return!1;var b=a.device.sys;"neoserver"==b&&(b="aio");b=require("x.hub.moduleman.js").modulemanager.getModule(b);if(!b||!b.checkDeviceMatch)return!1;var f=this._getDevice(),c=this._getGateway();if(!b.checkDeviceMatch({device:f,gateway:c},a))return!1;b=this.status;b.ref&&b.ref.value?b=b.ref.value:b.value&&(b=b.value);return b!=a.data.key?!1:this.isValueMatch(a)};n.prototype.isValueMatch=function(a){if(!a||
!a.data)return!1;var b=(new Date).getTime();var f="="==this.op?"true"==this.value?"true"==String(a.data.value):"false"==this.value?"false"==String(a.data.value):this.value==a.data.value:">="==this.op?parseFloat(a.data.value)>=parseFloat(this.value):">"==this.op?parseFloat(a.data.value)>parseFloat(this.value):"<="==this.op?parseFloat(a.data.value)<=parseFloat(this.value):"<"==this.op?parseFloat(a.data.value)<parseFloat(this.value):!1;var c=this.value;"undefined"!=typeof this.hysteresis&&null!=this.hysteresis&&
(c=this.hysteresis);var g=!1;if(">"==this.op)g=parseFloat(a.data.value)<=parseFloat(c);else if(">="==this.op)g=parseFloat(a.data.value)<parseFloat(c);else if("<"==this.op)g=parseFloat(a.data.value)>=parseFloat(c);else if("<="==this.op)g=parseFloat(a.data.value)>parseFloat(c);else if("="==this.op||"=="==this.op)g=a.data.value!=c;g&&(this._lastTiggerTime=null);this._trace&&(this._trace.log("trigger | "+this._getDescription()),this._trace.log("receive event | "+JSON.stringify(a.data)+" | hysteresis="+
this.hysteresis+" | hit="+f));if(f){if(!this._lastTiggerTime)return this._lastTiggerTime=b,!0;if(1E3>b-this._lastTiggerTime||"undefined"!=typeof this.hysteresis&&null!=this.hysteresis&&this._lastTiggerTime||(a=this._getDevice())&&"aio"==a.sys&&"ENOCEAN"==a.type&&"bb-aa-cc"==a.data&&this._lastTiggerTime)return!1;this._lastTiggerTime=b;return!0}return!1};n.prototype.onEvent=function(a){try{this.isValueMatch(a)&&this._parent&&this._parent._onTriggered&&this._parent._onTriggered(null,this)}catch(m){}};
n.prototype.toJSON=function(){var a=d.prototype.toJSON.call(this);a.device=this.device;a.gateway=this.gateway;a.status=this.status;a.op=this.op;a.value=this.value;a.hysteresis=this.hysteresis;return a};n.prototype.fromJSON=function(a){a&&(this.device=a.device,this.gateway=a.gateway,this.status=a.status,this.op=a.op,this.value=a.value,this.hysteresis=a.hysteresis)};n.prototype._getDevice=function(){if(!this.device)return null;var a=null;if(this.device.__neoIndex&&deviceman.deviceManager)try{var b=
deviceman.deviceManager.findDeviceWithIndex(this.device.__neoIndex);b&&b.info&&(this._deviceName=b.name,a=JSON.parse(JSON.stringify(b.info)))}catch(I){}a||(a=JSON.parse(JSON.stringify(this.device)));return a};n.prototype._getGateway=function(){if(!this.gateway)return null;var a=null;if(this.gateway.__neoIndex&&deviceman.deviceManager)try{var b=deviceman.deviceManager.findGatewayWithIndex(this.gateway.__neoIndex);b&&b.info&&(this._gatewayName=b.name,a=JSON.parse(JSON.stringify(b.info)))}catch(I){}a||
(a=JSON.parse(JSON.stringify(this.gateway)));return a};n.prototype._getDescription=function(){var a=null;this._deviceName||this._gatewayName?a=this._deviceName?this._deviceName:this._gatewayName:this.device?a=JSON.stringify(this.device):this.gateway&&(a=JSON.stringify(this.gateway));var b=this.status;this.status.ref&&(b=this.status.ref);b.value&&(b=b.value);return a+" | "+b+this.op+this.value};d.DeviceStatus=n;var q=function(){d.call(this);this.type=q.TYPE;this.gateway=this.device=null;this.upperThreshold=
{type:null,op:null,value:null,delay:null,repeat:null};this.lowerThreshold={type:null,op:null,value:null,delay:null,repeat:null};this._upper_threshold_state=0;this._upper_threshold_repeat_to=this._upper_threshold_deley_to=null;this._lower_threshold_state=0;this._lower_threshold_repeat_to=this._lower_threshold_deley_to=null;this._lastTigger={upperThreshold:!1,lowerThreshold:!1};this._upperMatchCount=0;this._cancelCB=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.DominoswissWS");
this._lastHit=null};util.inherits(q,n);q.TYPE="device.dominoswiss.weatherstation";q.prototype.init=function(a){if(this.device||this.gateway){var b=null;this.gateway&&this.gateway.sys&&(b=this.gateway.sys);!b&&this.device&&this.device.sys&&(b=this.device.sys);if(b&&(b=require("x.hub.moduleman.js").modulemanager.getModule(b))&&b.addStateDevice){var f={},c=this._getDevice(),g=this._getGateway();c&&(f=c);delete f.gateway;g&&(f.gateway=g);b.addStateDevice(f,null,{taskID:a,statusKey:"*",src:"taskman"})}}};
q.prototype.finalize=function(a){if(this.device||this.gateway){var b=null;this.gateway&&this.gateway.sys&&(b=this.gateway.sys);!b&&this.device&&this.device.sys&&(b=this.device.sys);if(b&&(b=require("x.hub.moduleman.js").modulemanager.getModule(b))&&b.removeStateDevice){var f={},c=this._getDevice(),g=this._getGateway();c&&(f=c);delete f.gateway;g&&(f.gateway=g);b.removeStateDevice(f,null,{taskID:a,statusKey:"*",src:"taskman"})}}};q.prototype.isMatch=function(a){if(!a||!a.device||!a.device.sys)return!1;
var b=require("x.hub.moduleman.js").modulemanager.getModule(a.device.sys);if(!b||!b.checkDeviceMatch)return!1;var f=this._getDevice(),c=this._getGateway();if(!b.checkDeviceMatch({device:f,gateway:c},a))return!1;this._logger.log("trace","receive event for device:"+JSON.stringify(a));f=b=!1;c=this._matchUpperThreshold(a);a=this._matchLowerThreshold(a);this._logger.log("trace","upperMatch:"+c+" - lowerMatch:"+a);if("upper"==this._lastHit&&!a)return this._logger.log("trace","lastHit:upper - lowerMatch:"+
a),!1;if("lower"==this._lastHit&&!c)return this._logger.log("trace","lastHit:lower - upperMatch:"+c),!1;"upper"==this._lastHit&&a&&(this._lastHit=null);"lower"==this._lastHit&&c&&(this._lastHit=null);1==c&&(this._upperMatchCount+=1,65535<this._upperMatchCount&&(this._upperMatchCount=1));switch(this._upper_threshold_state){case 0:1==c&&("undefined"!=typeof this.upperThreshold.delay&&null!=this.upperThreshold.delay&&0<parseInt(this.upperThreshold.delay)?this._handleUpperThresholdDelay():(b=!0,this.upperThreshold.repeat&&
this._handleUpperThresholdRepeat()));break;case 1:0==c&&(this._logger.log("trace","upper threshold not match, clear delay timeout"),this._upper_threshold_deley_to&&(clearTimeout(this._upper_threshold_deley_to),this._upper_threshold_deley_to=null),this._upper_threshold_state=0);break;case 2:0==c&&(this._logger.log("trace","upper threshold not match, clear repeat timeout"),this._upper_threshold_repeat_to&&(clearTimeout(this._upper_threshold_repeat_to),this._upper_threshold_repeat_to=null),this._upper_threshold_state=
0)}switch(this._lower_threshold_state){case 0:1==a&&0<this._upperMatchCount&&("undefined"!=typeof this.lowerThreshold.delay&&null!=this.lowerThreshold.delay&&0<parseInt(this.lowerThreshold.delay)?this._handleLowerThresholdDelay():(f=!0,this._upperMatchCount=0,this.lowerThreshold.repeat&&this._handleLowerThresholdRepeat()));break;case 1:0==a&&(this._logger.log("trace","lower threshold not match, clear delay timeout"),this._lower_threshold_deley_to&&(clearTimeout(this._lower_threshold_deley_to),this._lower_threshold_deley_to=
null),this._lower_threshold_state=0);break;case 2:0==a&&(this._logger.log("trace","lower threshold not match, clear repeat timeout"),this._lower_threshold_repeat_to&&(clearTimeout(this._lower_threshold_repeat_to),this._lower_threshold_repeat_to=null),this._lower_threshold_state=0)}this._lastTigger={upperThreshold:b,lowerThreshold:f};this._logger.log("trace","upperHit:"+b+" - lowerHit:"+f);b?this._lastHit="upper":f&&(this._lastHit="lower");return b|f};q.prototype._matchUpperThreshold=function(a){if(!(this.upperThreshold&&
this.upperThreshold.type&&a&&a.data&&a.data.key&&this.upperThreshold.type==a.data.key))return null;var b=this.upperThreshold.op;b||(b=">=");var f=this.upperThreshold.value;if("undefined"==typeof f||null==f)f=0;return this._matchThreshold(b,f,a.data.value)};q.prototype._matchLowerThreshold=function(a){if(!(this.lowerThreshold&&this.lowerThreshold.type&&a&&a.data&&a.data.key&&this.lowerThreshold.type==a.data.key))return null;var b=this.lowerThreshold.op;b||(b=">=");var f=this.lowerThreshold.value;if("undefined"==
typeof f||null==f)f=0;return this._matchThreshold(b,f,a.data.value)};q.prototype._matchThreshold=function(a,b,c){return"="==a||"=="==a?"true"==b?"true"==String(c):"false"==b?"false"==String(c):b==c:">="==a?parseFloat(c)>=parseFloat(b):">"==a?parseFloat(c)>parseFloat(b):"<="==a?parseFloat(c)<=parseFloat(b):"<"==a?parseFloat(c)<parseFloat(b):!1};q.prototype._handleUpperThresholdDelay=function(){var a=this;this._upper_threshold_state=1;this._logger.log("trace","start upper threshold hit delay timeout:"+
parseInt(this.upperThreshold.delay));this._upper_threshold_deley_to=setTimeout(function(){a._logger.log("trace","upper threshold delay timeout expired");a._lastTigger={upperThreshold:!0,lowerThreshold:!1};if(a._parent&&"root"==a._parent.type)try{a._lastHit="upper",a._parent._onTriggered(null,a)}catch(m){}a.upperThreshold.repeat?a._handleUpperThresholdRepeat():a._upper_threshold_state=0},1E3*parseInt(this.upperThreshold.delay))};q.prototype._handleLowerThresholdDelay=function(){var a=this;this._lower_threshold_state=
1;this._logger.log("trace","start lower threshold hit delay timeout:"+parseInt(this.lowerThreshold.delay));this._lower_threshold_delay_to=setTimeout(function(){a._lastTigger={upperThreshold:!1,lowerThreshold:!0};a._upperMatchCount=0;a._logger.log("trace","lower threshold delay timeout expired");if(a._parent&&"root"==a._parent.type)try{a._lastHit="lower",a._parent._onTriggered(null,a)}catch(m){}a.lowerThreshold.repeat?a._handleLowerThresholdRepeat():a._lower_threshold_state=0},1E3*parseInt(this.lowerThreshold.delay))};
q.prototype._handleUpperThresholdRepeat=function(){var a=this;this._upper_threshold_state=2;var b=this.upperThreshold.repeat,c=0;if(b&&"string"==typeof b&&b.match(/^([0-1]?[0-9]|2[0-3])(:[0-5][0-9])?$/g)){c=require("moment-timezone");var g=x.hub.taskman._Util._getTimeZone(),d=(new Date).getTime();d=c.tz(d,g);var e=parseInt(b.substr(0,b.indexOf(":")));b=parseInt(b.substr(b.indexOf(":")+1));var l=(new Date).getTime();l=c.tz(l,g);l.set({hour:e,minute:b,second:0,millisecond:0});c=l.valueOf()-d.valueOf();
if(0>c){this._upper_threshold_state=0;return}}else if(0<parseInt(b))c=1E3*parseInt(b);else{this._upper_threshold_state=0;return}this._logger.log("trace","start upper threshold hit repeat timeout:"+Math.round(c/1E3));this._upper_threshold_repeat_to=setTimeout(function(){a._logger.log("trace","upper threshold repeat timeout expired");a._upper_threshold_state=0;a._lastTigger={upperThreshold:!0,lowerThreshold:!1};if(a._parent&&"root"==a._parent.type)try{a._lastHit="upper",a._parent._onTriggered(null,
a)}catch(J){}},c)};q.prototype._handleLowerThresholdRepeat=function(){var a=this;this._lower_threshold_state=2;var b=this.lowerThreshold.repeat,c=0;if(b&&"string"==typeof b&&b.match(/^([0-1]?[0-9]|2[0-3])(:[0-5][0-9])?$/g)){c=require("moment-timezone");var g=x.hub.taskman._Util._getTimeZone(),d=(new Date).getTime();d=c.tz(d,g);var e=parseInt(b.substr(0,b.indexOf(":")));b=parseInt(b.substr(b.indexOf(":")+1));var l=(new Date).getTime();l=c.tz(l,g);l.set({hour:e,minute:b,second:0,millisecond:0});c=l.valueOf()-
d.valueOf();if(0>c){this._lower_threshold_state=0;return}}else if(0<parseInt(b))c=1E3*parseInt(b);else{this._lower_threshold_state=0;return}this._logger.log("trace","start lower threshold hit repeat timeout:"+Math.round(c/1E3));this._lower_threshold_repeat_to=setTimeout(function(){a._logger.log("trace","lower threshold repeat timeout expired");a._upperMatchCount=0;a._lower_threshold_state=0;a._lastTigger={upperThreshold:!1,lowerThreshold:!0};if(a._parent&&"root"==a._parent.type)try{a._lastHit="lower",
a._parent._onTriggered(null,a)}catch(J){}},c)};q.prototype.toJSON=function(){var a=d.prototype.toJSON.call(this);a.device=this.device;a.gateway=this.gateway;a.upperThreshold=this.upperThreshold;a.lowerThreshold=this.lowerThreshold;return a};q.prototype.fromJSON=function(a){a&&(this.device=a.device,this.gateway=a.gateway,this.upperThreshold=a.upperThreshold,this.lowerThreshold=a.lowerThreshold)};d.DominoswissWS=q;var p=function(){d.call(this);this.type=p.TYPE};util.inherits(p,d);p.TYPE="action";d.Action=
p;var B=function(){p.call(this);this.subtype=B.SUBTYPE;this.body=this.event=this.key=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.IFTTTMakerAction")};util.inherits(B,p);B.SUBTYPE="iftttmaker";B.prototype.do=function(a){if(this.key||this.event){var b=a;a={hostname:"maker.ifttt.com",port:443,path:"/trigger/"+this.event+"/with/key/"+this.key,method:"POST",headers:{"Content-Type":"application/json"}};this._logger.log("trace","send https:"+JSON.stringify(a));this._logger.log("trace",
"with data:"+JSON.stringify(this.body));var c=this;a=require("https").request(a,function(a){a.setEncoding("utf8");var f="";a.on("data",function(a){f+=a});a.on("end",function(){c._logger.log("trace","action response:"+a.statusCode);c._logger.log("trace","with data:"+f);b&&(b(null,a.statusCode,f),b=null)})});a.on("error",function(a){c._logger.log("debug","do action err:"+a.stack);b&&(b(a),b=null)});a.setTimeout(5E3,function(){c._logger.log("debug","do action timeout");b&&(b(Error("timeout")),b=null)});
if(this.body)try{var f=JSON.stringify(this.body);a.write(f)}catch(L){}a.end()}else a&&a(Error("no key or event"))};B.prototype.toJSON=function(){var a=p.prototype.toJSON.call(this);a.subtype=this.subtype;a.key=this.key;a.event=this.event;a.body=this.body;return a};B.prototype.fromJSON=function(a){a&&(this.key=a.key,this.event=a.event,this.body=a.body)};d.IFTTTMakerAction=B;var y=function(){p.call(this);this.subtype=y.SUBTYPE;this._cancelCB=this._doCB=this.body=this.headers=this.query=this.pathname=
this.port=this.hostname=this.auth=this.protocol=this.method=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.HttpAction")};util.inherits(y,p);y.SUBTYPE="http.action";y.prototype.do=function(a){var b=this.method;b||(b="GET");var c=this.protocol;c||(c="http");var f=this.port;if(!f||0>=parseInt(f))f="https"==c?443:80;var g=require("querystring"),d=this.pathname?this.pathname:"/";this.query&&(d+="?"+g.stringify(this.query));f={hostname:this.hostname,port:f,path:d,method:b,headers:this.headers};
this.auth&&(f.auth=this.auth);this._logger.log("trace","send "+c+" "+b+":"+JSON.stringify(f));this._logger.log("trace","with data:"+JSON.stringify(this.body));this._trace&&(this._trace.log("execute http | "+c+" "+b+":"+JSON.stringify(f)),this._trace.log("execute http | with data:"+JSON.stringify(this.body)));this._running=!0;this._doCB=a;var e=this;a=require(c).request(f,function(a){a.setEncoding("utf8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){e._logger.log("trace","action response:"+
a.statusCode);e._logger.log("trace","with data:"+b);e._trace&&(e._trace.log("execute http | response code:"+a.statusCode),e._trace.log("execute http | response data:"+b));e._doCB&&(e._running=!1,e._doCB(null,a.statusCode,b),e._doCB=null)})});a.on("error",function(a){e._trace&&e._trace.log("execute http | error:"+a.message);e._logger.log("debug","do action err:"+a.stack);e._doCB&&(e._running=!1,e._doCB(a),e._doCB=null)});a.setTimeout(5E3,function(){e._trace&&e._trace.log("execute http | error:timeout");
e._logger.log("debug","do action timeout");e._doCB&&(e._running=!1,e._doCB(Error("timeout")),e._doCB=null)});if(this.body&&"GET"!=b&&"DELETE"!=b)if("string"==typeof this.body)a.write(this.body);else try{var l=JSON.stringify(this.body);a.write(l)}catch(M){}a.end()};y.prototype.cancel=function(a){this._running?(this._logger.log("trace","http action canceled"),this._doCB=null,this._running=!1,a&&a(null,!0)):a&&a(null,this._running)};y.prototype.toJSON=function(){var a=p.prototype.toJSON.call(this);a.subtype=
this.subtype;a.method=this.method;a.protocol=this.protocol;a.auth=this.auth;a.hostname=this.hostname;a.port=this.port;a.pathname=this.pathname;a.query=this.query;a.headers=this.headers;a.body=this.body;return a};y.prototype.fromJSON=function(a){a&&(this.subtype=a.subtype,this.method=a.method,this.protocol=a.protocol,this.auth=a.auth,this.hostname=a.hostname,this.port=a.port,this.pathname=a.pathname,this.query=a.query,this.headers=a.headers,this.body=a.body)};d.HttpAction=y;var r=function(){p.call(this);
this.subtype=r.SUBTYPE;this._cancelCB=this.command=this.gateway=this.device=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.CommandAction");this._gatewayName=this._deviceName=null};util.inherits(r,p);r.SUBTYPE="command";r.prototype.do=function(a,b){if(this.device||this.gateway)if(this.command){b=this.command;b.ref&&(b=b.ref);var c=require("x.hub.commandman.js").commandHandler;this._logger.log("trace","do command:"+JSON.stringify(this.toJSON()));var g=this._getDevice(),f=this._getGateway();
if(g&&"sonos"==g.sys&&b&&"playAlarm"==b.value&&(b=this._buildSonosCommand(b.ext),!b))return;this._running=!0;this._trace&&this._trace.log("execute command | "+this._getDescription());var d=this;c.executeCommand(g,f,b,function(b){b&&b.error?d._trace&&d._trace.log("execute command | "+d._getDescription()+" | error:"+b.error.message):d._trace&&d._trace.log("execute command | "+d._getDescription()+" | success");if(d._canceling){d._logger.log("trace","command action canceled:"+JSON.stringify(d.toJSON()));
d._canceling=!1;b=d._running;d._running=!1;var c=d._cancelCB;d._cancelCB=null;c&&c(null,b)}else d._running=!1,a&&a()})}else a&&a(Error("no command"));else a&&a(Error("no device or gateway"))};r.prototype.cancel=function(a){this._running?(this._canceling=!0,this._cancelCB=a):a&&a(null,this._running)};r.prototype.toJSON=function(){var a=p.prototype.toJSON.call(this);a.subtype=this.subtype;a.device=this.device;a.gateway=this.gateway;a.command=this.command;return a};r.prototype.fromJSON=function(a){a&&
(this.device=a.device,this.gateway=a.gateway,this.command=a.command)};r.prototype._getDevice=function(){if(!this.device)return null;var a=null;if(this.device.__neoIndex&&deviceman.deviceManager)try{var b=deviceman.deviceManager.findDeviceWithIndex(this.device.__neoIndex);b&&b.info&&(this._deviceName=b.name,a=JSON.parse(JSON.stringify(b.info)))}catch(I){}a||(a=JSON.parse(JSON.stringify(this.device)));return a};r.prototype._getGateway=function(){if(!this.gateway)return null;var a=null;if(this.gateway.__neoIndex&&
deviceman.deviceManager)try{var b=deviceman.deviceManager.findGatewayWithIndex(this.gateway.__neoIndex);b&&b.info&&(this._gatewayName=b.name,a=JSON.parse(JSON.stringify(b.info)))}catch(I){}a||(a=JSON.parse(JSON.stringify(this.gateway)));a&&this.gateway.__neoIndex&&(a.__neoInfo={db:1,index:this.gateway.__neoIndex});return a};r.prototype._getDescription=function(){var a=null;this._deviceName||this._gatewayName?a=this._deviceName?this._deviceName:this._gatewayName:this.device?a=JSON.stringify(this.device):
this.gateway&&(a=JSON.stringify(this.gateway));var b=this.command;b.ref&&(b=b.ref);return a+" | "+JSON.stringify(b)};r.prototype._getLocalIP=function(){var a=require("os").networkInterfaces(),b;for(b in a)for(var c=a[b],g=0;g<c.length;g++){var d=c[g];if(d&&"IPv4"==d.family&&0==d.internal)return d.address}return null};r.prototype._getLocalPort=function(){var a=require("x.hub.js");return a.server?a.server._port:null};r.prototype._buildSonosCommand=function(a){var b=this._getLocalIP(),c=this._getLocalPort();
if(!b||!c)return null;switch(a){case "alarm_on":a="alarm_on.mp3";break;case "alarm_off":a="alarm_off.mp3";break;case "pre_alarm":a="pre_alarm.mp3";break;case "alarm":a="alarm.mp3";break;default:return null}return{value:"playUrl",ext:"http://"+b+":"+c+"/resources/rehau_alarm/"+a}};d.CommandAction=r;var G=function(){p.call(this);this.subtype=G.SUBTYPE;this._cancelCB=this.command=this.gateway=this.device=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.BrelagUpperThresholdAction")};
util.inherits(G,r);G.SUBTYPE="command.dominoswiss.upperthreshold";G.prototype.do=function(a,b){if(b&&b.trigger&&b.trigger.type==q.TYPE){var c=b.trigger._lastTigger;c&&c.upperThreshold?r.prototype.do.call(this,a,b):a&&a()}else a&&a()};d.BrelagUpperThresholdAction=G;var H=function(){p.call(this);this.subtype=H.SUBTYPE;this._cancelCB=this.command=this.gateway=this.device=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.BrelagLowerThresholdAction")};util.inherits(H,r);H.SUBTYPE=
"command.dominoswiss.lowerthreshold";H.prototype.do=function(a,b){if(b&&b.trigger&&b.trigger.type==q.TYPE){var c=b.trigger._lastTigger;c&&c.lowerThreshold?r.prototype.do.call(this,a,b):a&&a()}else a&&a()};d.BrelagUpperThresholdAction=H;var C=function(){p.call(this);this.subtype=C.SUBTYPE;this.actionID=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.CloudAction")};util.inherits(C,p);C.SUBTYPE="cloud_action";C.prototype.do=function(a){if(this.actionID){this._logger.log("trace",
"do cloud action:"+this.actionID);var b=require("x.hub.js").server;if(b)if(b=b._cloudConnect){var c=JSON.stringify({type:"ACTION",data:this.actionID});c=new Buffer("EVT:"+c,"utf8");b.sendMessageActive("0103"+c.toString("hex"),function(b){a&&a(b)})}else a&&a(Error("no cloud connect"));else a&&a(Error("no server in hub"))}else a&&a(Error("action id is empty"))};C.prototype.cancel=function(a){a&&a(null,!1)};C.prototype.toJSON=function(){var a=p.prototype.toJSON.call(this);a.subtype=this.subtype;a.actionID=
this.actionID;return a};C.prototype.fromJSON=function(a){a&&(this.actionID=a.actionID)};var u=function(){p.call(this);this.subtype=u.SUBTYPE;this.macroName=this.groupName=null;this._canceling=!1;this._macroExecutorID=this._cancelCB=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.MacroAction")};util.inherits(u,p);u.SUBTYPE="macro";u.prototype.do=function(a){if(this.groupName&&this.macroName){var b=require("x.hub.macroman.js");this._logger.log("trace","do macro:"+JSON.stringify(this.toJSON()));
var c=this;this._running=!0;this._trace&&this._trace.log("execute macro | "+this._getDescription());b.execute(this.groupName,this.macroName,function(b){c._trace&&c._trace.log("execute macro | "+c._getDescription()+" | return:"+JSON.stringify(b));c._canceling?(c._logger.log("trace","macro action canceled:"+JSON.stringify(c.toJSON())),c._canceling=!1,c._running=!1,b=c._cancelCB,c._cancelCB=null,b&&b()):(c._running=!1,a&&a(b))},function(a){a&&a.id&&(c._macroExecutorID=a.id)})}else a&&a(Error("no group or macro"))};
u.prototype.cancel=function(a){this._running?(this._canceling=!0,this._cancelCB=a,this._macroExecutorID&&require("x.hub.macroman.js").cancel(this._macroExecutorID)):a&&a(null,this._running)};u.prototype.toJSON=function(){var a=p.prototype.toJSON.call(this);a.subtype=this.subtype;a.groupName=this.groupName;a.macroName=this.macroName;return a};u.prototype.fromJSON=function(a){a&&(this.groupName=a.groupName,this.macroName=a.macroName)};u.prototype._getDescription=function(){return this.groupName+"."+
this.macroName};d.MacroAction=u;var z=function(){p.call(this);this._cancelCB=this.token=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.SnsAction")};util.inherits(z,p);z.prototype.do=function(a){if(this.token){var b=this;this._logger.log("trace","do sns:"+JSON.stringify(this.toJSON()));var c=new x.hub.taskman.Cloud;this._running=!0;this._trace&&this._trace.log("execute sns | "+this._getDescription());c._doRequest("GET","/xhub/sns/dosns?token="+this.token,null,null,null,null,
function(c,g){b._trace&&b._trace.log("execute sns | "+b._getDescription()+" | "+(c?"error:"+c.message:"response:"+g));b._canceling?(b._logger.log("trace","sns action canceled:"+JSON.stringify(b.toJSON())),b._canceling=!1,c=b._running,b._running=!1,g=b._cancelCB,b._cancelCB=null,g&&g(null,c)):(b._running=!1,c&&b._logger.log("warn","do sns error:"+c.stack),a&&a(c))})}else a&&a(Error("token is empty"))};z.prototype.cancel=function(a){this._running?(this._canceling=!0,this._cancelCB=a):a&&a(null,this._running)};
z.prototype._getDescription=function(){return this.subtype+"."+this.token};var D=function(){z.call(this);this.subtype=D.SUBTYPE;this.token=null};util.inherits(D,z);D.SUBTYPE="EMAIL";D.prototype.toJSON=function(){var a=p.prototype.toJSON.call(this);a.subtype=this.subtype;a.token=this.token;return a};D.prototype.fromJSON=function(a){a&&(this.token=a.token)};d.EmailAction=D;var E=function(){z.call(this);this.subtype=E.SUBTYPE;this.token=null};util.inherits(E,z);E.SUBTYPE="PUSH";E.prototype.toJSON=function(){var a=
p.prototype.toJSON.call(this);a.subtype=this.subtype;a.token=this.token;return a};E.prototype.fromJSON=function(a){a&&(this.token=a.token)};d.PushAction=E;var F=function(){z.call(this);this.subtype=F.SUBTYPE;this.token=null};util.inherits(F,z);F.SUBTYPE="SMS";F.prototype.toJSON=function(){var a=p.prototype.toJSON.call(this);a.subtype=this.subtype;a.token=this.token;return a};F.prototype.fromJSON=function(a){a&&(this.token=a.token)};d.SmsAction=F;var K=function(a,b){this._runCallback=b;this._finishCallback=
null;this._action=a;var c=this;this.runCallback=function(a){c._action.removeRunTask(c);c._runCallback&&c._runCallback(a)};this.finishCallback=function(){c._action.removeRunTask(c)}},v=function(){p.call(this);this.subtype=v.SUBTYPE;this.name=this.id=null;this._scriptRunTasks=[];this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.ScriptAction")};util.inherits(v,p);v.SUBTYPE="script";v.prototype.do=function(a){if(this.id){var b=require("x.hub.scriptman.js").scriptManager;this._logger.log("trace",
"do script:"+JSON.stringify(this.toJSON()));this._running=!0;a=new K(this,a);this._scriptRunTasks.push(a);this._trace&&this._trace.log("execute skript | "+this.id);b.runScript(this.id,a.runCallback,a.finishCallback)}else a&&a(Error("no script id"))};v.prototype.cancel=function(a){if(this._running){var b=require("x.hub.scriptman.js").scriptManager;this._scriptRunTasks=[];this._running=!1;this._logger.log("trace","script action canceled:"+JSON.stringify(this.toJSON()));b.stopScript(this.id,function(){a&&
a(null,!0)})}else a&&a(null,this._running)};v.prototype.removeRunTask=function(a){a=this._scriptRunTasks.indexOf(a);-1!=a&&this._scriptRunTasks.splice(a,1);0==this._scriptRunTasks.length&&(this._running=!1)};v.prototype.toJSON=function(){var a=p.prototype.toJSON.call(this);a.subtype=this.subtype;a.id=this.id;a.name=this.name;return a};v.prototype.fromJSON=function(a){a&&(this.id=a.id,this.name=a.name)};d.ScriptAction=v;var A=function(){p.call(this);this.subtype=A.SUBTYPE;this._to=this.value=null;
this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.WaitAction")};util.inherits(A,p);A.SUBTYPE="wait";A.prototype.do=function(a){if(this.value){this._running=!0;var b=this;this._trace&&this._trace.log("execute wait | wait "+this.value+" ms");this._to=setTimeout(function(){b._trace&&b._trace.log("execute wait | wait expired");b._running=!1;b._to=null;a&&a()},this.value)}else a&&a()};A.prototype.cancel=function(a){this._running?(this._to&&(this._logger.log("trace","wait action canceled:"+
JSON.stringify(this.toJSON())),clearTimeout(this._to),this._to=null),this._running=!1,a&&a(null,!0)):a&&a(null,this._running)};A.prototype.toJSON=function(){var a=p.prototype.toJSON.call(this);a.subtype=this.subtype;a.value=this.value;return a};A.prototype.fromJSON=function(a){a&&(this.value=a.value)};d.WaitAction=A;var w=function(){p.call(this);this.subtype=w.SUBTYPE;this.page=this.remote=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.ChangePageAction");this._cancelCB=null};
util.inherits(w,p);w.SUBTYPE="remote.changepage";w.prototype.do=function(a){this._trace&&this._trace.log("execute change page | "+this.remote+"."+this.page);this._running=!0;var b=[],c=require("os").networkInterfaces(),g;for(g in c)for(var d=c[g],e=0;e<d.length;e++){var f=d[e];"IPv4"==f.family&&0==f.internal&&b.push(f.address)}var l=this,k=0,h=function(){if(l._canceling){l._logger.log("trace","change page action canceled:"+JSON.stringify(l.toJSON()));l._canceling=!1;var c=l._running;l._running=!1;
var g=l._cancelCB;l._cancelCB=null;g&&g(null,c)}else k++,k>=b.length?(l._running=!1,a&&a()):l._sendEvent(b[k],h)};this._sendEvent(b[k],h)};w.prototype.cancel=function(a){this._running?(this._canceling=!0,this._cancelCB=a):a&&a(null,this._running)};w.prototype._sendEvent=function(a,b){var c=require("dgram"),g=require("unorm"),d={func:"changePage",remote:g.nfc(this.remote),page:g.nfc(this.page)};d=new Buffer("{XC_EVT}"+JSON.stringify(d),"utf8");var e=c.createSocket({type:"udp4",reuseAddr:!0});e.bind(a,
function(){e.setBroadcast(!0);e.send(d,0,d.length,1902,"255.255.255.255");e.send(d,0,d.length,1902,"255.255.255.255",function(a){e.close();b&&b(a)})})};w.prototype.toJSON=function(){var a=p.prototype.toJSON.call(this);a.subtype=this.subtype;a.remote=this.remote;a.page=this.page;return a};w.prototype.fromJSON=function(a){a&&(this.remote=a.remote,this.page=a.page)};d.ChangePageAction=w;d.parse=function(f){if(!f||!f.type)return null;switch(f.type){case c.TYPE:var m=d.Root;break;case b.TYPE:m=b;break;
case p.TYPE:switch(f.subtype){case r.SUBTYPE:m=r;break;case G.SUBTYPE:m=G;break;case H.SUBTYPE:m=H;break;case D.SUBTYPE:m=D;break;case E.SUBTYPE:m=E;break;case F.SUBTYPE:m=F;break;case v.SUBTYPE:m=v;break;case A.SUBTYPE:m=A;break;case u.SUBTYPE:m=u;break;case B.SUBTYPE:m=B;break;case y.SUBTYPE:m=y;break;case w.SUBTYPE:m=w;break;case C.SUBTYPE:m=C;break;default:return null}break;case n.TYPE:m=n;break;case q.TYPE:m=q;break;case a.TYPE:m=a;break;case g.TYPE:m=g;break;case l.TYPE:m=l;break;case e.TYPE:m=
e;break;case k.TYPE:m=k;break;case h.TYPE:m=h;break;case t.TYPE:m=t;break;default:return null}m=new m;m.fromJSON(f);return m};return d}();
x.hub.taskman.Task=function(){var d=function(b){this._logger=require("x.logger.js").getLogger("x.hub.taskman.Task");this.root=this.name=this.id=null;this.active=!0;this.singleton=this.rehauAlarmTask=this.isAlarmTask=!1;this.singletonMethod="ignore";this._trace=null;b&&(this.id=b.id,this.name=b.name,this.active=b.active,this.isAlarmTask=b.isAlarmTask,this.rehauAlarmTask=b.rehauAlarmTask,this.singleton=b.singleton,this.singletonMethod=b.singletonMethod);if("undefined"==typeof this.active||null==this.active)this.active=
!0;if("undefined"==typeof this.isAlarmTask||null==this.isAlarmTask)this.isAlarmTask=!1;if("undefined"==typeof this.rehauAlarmTask||null==this.rehauAlarmTask)this.rehauAlarmTask=!1};d.prototype.init=function(){this.root&&this.root.init(this.id)};d.prototype.finalize=function(){try{this.root&&this.root.finalize(this.id)}catch(b){this._logger.log("warn","finalize task "+this.id+" error:"+b.message)}};d.prototype.trigger=function(b){this.root?(this.root._onTriggered(),b&&b()):b&&b(Error("no content"))};
d.prototype.cancel=function(b){this.root?(this.root.cancel(),b&&b()):b&&b(Error("no content"))};d.prototype.isActive=function(){return this.active};d.prototype.setActive=function(b){if("undefined"==typeof b||null==b)b=!0;"string"==typeof b&&(b="false"==b?!1:!0);this.active=b};d.prototype.toggleActive=function(){this.active=!this.active};d.prototype.setRehauAlarmTask=function(b){this.rehauAlarmTask=b};d.prototype.isRehauAlarmTask=function(){return this.rehauAlarmTask};d.prototype.setAlarmTask=function(b){if("undefined"==
typeof b||null==b)b=!1;"string"==typeof b&&(b="false"==b?!1:!0);this.isAlarmTask=b};d.prototype.isRunning=function(){return this.root?this.root.isRunning():!1};d.prototype.onStatusEvt=function(b){this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+(this.root?!0:!1)+") receive status");if(this.active&&this.root&&(!this.isAlarmTask||require("x.hub.taskman.js").taskManager._alarmTask._active))this.root.onStatusEvt(b)};d.prototype.onStatusEvtForTask=function(b){this._logger.log("trace",
"task "+this.id+" (active:"+this.active+", root:"+(this.root?!0:!1)+") receive dedicated status");if(this.active&&this.root&&(!this.isAlarmTask||require("x.hub.taskman.js").taskManager._alarmTask._active))this.root.onDedicatedStatusEvt(b)};d.prototype.onIREvt=function(b){this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+(this.root?!0:!1)+") receive ir event");if(this.active&&this.root&&(!this.isAlarmTask||require("x.hub.taskman.js").taskManager._alarmTask._active))this.root.onIREvt(b)};
d.prototype.onTimerTick=function(){this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+(this.root?!0:!1)+") receive timer tick");if(this.active&&this.root&&(!this.isAlarmTask||require("x.hub.taskman.js").taskManager._alarmTask._active))this.root.onTimerTick()};d.prototype.onHttpEvt=function(b,c){this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+(this.root?!0:!1)+") receive http event");if(this.active&&this.root)if(this.isAlarmTask&&!require("x.hub.taskman.js").taskManager._alarmTask._active)c&&
c(null,!1);else this.root.onHttpEvt(b,c);else c&&c(null,!1)};d.prototype.toJSON=function(){var b={id:this.id,name:this.name,active:this.active,isAlarmTask:this.isAlarmTask,rehauAlarmTask:this.rehauAlarmTask,singleton:this.singleton,singletonMethod:this.singletonMethod,root:{}};this.root&&(b.root=this.root.toJSON());return b};d.prototype.startTaskTrace=function(b,c){this._trace||(this._trace=new x.hub.taskman.TaskTrace(this),this.root&&this.root.setTrace(this._trace));this._trace.addListener(b);c&&
c()};d.prototype.stopTaskTrace=function(b,c){this._trace&&(this._trace.removeListener(b),0==this._trace.getListeners().length&&(this.root&&this.root.setTrace(null),this._trace=null));c&&c()};d.parse=function(b){if(!b||!b.id||!b.name)return null;var c=new d(b);b.root&&(c.root=x.hub.taskman._Block.parse(b.root),c.root&&(c.root._task=c,c.root.singleton=c.singleton,c.root.singletonMethod=c.singletonMethod));return c};return d}();
x.hub.taskman.AlarmTask=function(){var d=function(){this._active=!1;this._delay=0;this._activateDelayTO=null};d.prototype.init=function(){this._active="true"==localStorage.getItem("x.hub.taskman.TaskManager.alarmActive");this._delay=parseInt(localStorage.getItem("x.hub.taskman.TaskManager.alarmDelay"))};d.prototype.setAlarmActive=function(b,c,d,k){var e=function(a,b,c){if("undefined"==typeof b||null==b)b=!0;"string"==typeof b&&(b="false"==b?!1:!0);a._tasks.forEach(function(a){a.isAlarmTask&&(a.active=
b)});a._writeData(c)};if(this._getAlarmPin()!=c)c=Error("pin error"),c.code=x.hub.taskman.ERROR_CODE.Pin_Error,k&&k(c);else if(this._activateDelayTO&&(clearTimeout(this._activateDelayTO),this._activateDelayTO=null),this._delay&&b){var a=this;this._activateDelayTO=setTimeout(function(){localStorage.setItem("x.hub.taskman.TaskManager.alarmActive",b);a._active=b;a._activateDelayTO=null;e(d,b)},1E3*this._delay);k&&k()}else localStorage.setItem("x.hub.taskman.TaskManager.alarmActive",b),this._active=b,
e(d,b,k)};d.prototype.setAlarmDelay=function(b,c,d){this._getAlarmPin()!=c?(b=Error("pin error"),b.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(b)):(localStorage.setItem("x.hub.taskman.TaskManager.alarmDelay",b),this._delay=b,d&&d())};d.prototype.getAlarmInfo=function(b){b&&b(null,{active:this._active,delay:this._delay?this._delay:0,pendingActive:null!=this._activateDelayTO})};d.prototype.selectAlarmTask=function(b,c,d,k,h){if(b){for(var a=null,g=0;g<k.length;g++){var e=k[g];if(e.id==b){a=e;break}}a?
(b=this._getAlarmPin(),d&&d==b?this._active?h&&h(Error("alarm task active")):(a.setAlarmTask(c),h&&h()):(c=Error("pin error"),c.code=x.hub.taskman.ERROR_CODE.Pin_Error,h&&h(c))):h&&h(Error("no such task:"+b))}else h&&h(Error("task id is null"))};d.prototype._getAlarmPin=function(){return localStorage.getItem("x.hub.taskman.TaskManager.alarmPin")?localStorage.getItem("x.hub.taskman.TaskManager.alarmPin"):d.DEFAULT_PIN};d.prototype.setAlarmPin=function(b,c,d){var e=this._getAlarmPin();b?c!=e?(b=Error("pin error"),
b.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(b)):(localStorage.setItem("x.hub.taskman.TaskManager.alarmPin",b),d&&d()):d&&d(Error("new pin invalid"))};d.DEFAULT_PIN="0000";return d}();
x.hub.taskman.TaskTrace=function(){var d=function(b){this._logger=require("x.logger.js").getLogger("x.hub.taskman.TaskTrace");this._task=b;this._listeners=[]};d.prototype.addListener=function(b){b&&-1==this._listeners.indexOf(b)&&this._listeners.push(b)};d.prototype.removeListener=function(b){b&&(b=this._listeners.indexOf(b),-1!=b&&this._listeners.splice(b,1))};d.prototype.getListeners=function(b){return this._listeners};d.prototype.log=function(b){this._logger.log("trace","[Task "+this._task.id+
"]:"+b);b="["+this._getTimestamp()+"] "+b;this._listeners.forEach(function(c){c&&c(b)})};d.prototype._getTimestamp=function(){return(new Date).toTimeString()};return d}();x.hub.taskman.rehau={};
x.hub.taskman.rehau.AlarmTaskManager=function(){var d=function(){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTask.AlarmDoor");this._alarmTask=this._activateEvent=this._device=this._id=null};d.prototype.init=function(){if(this._device){var a=require("x.hub.moduleman.js").modulemanager.getModule("aio");a&&a.addStateDevice&&this._activateEvent&&this._activateEvent.status&&a.addStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._activateEvent.status,src:"rehau:alarmTask"})}};
d.prototype.finalize=function(){if(this._device){var a=require("x.hub.moduleman.js").modulemanager.getModule("aio");a&&a.removeStateDevice&&this._activateEvent&&this._activateEvent.status&&a.removeStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._activateEvent.status,src:"rehau:alarmTask"})}};d.prototype.setAlarmTask=function(a){this._alarmTask=a};d.prototype.getID=function(){return this._id};d.prototype.setID=function(a){this._id=a};d.prototype.setDevice=function(a){this._device=
a};d.prototype.setActivateEvent=function(a){this._activateEvent=a};d.prototype.toJSON=function(){return{id:this._id,device:this._device,activateEvent:this._activateEvent}};d.prototype.matchDevice=function(a){return this._device&&a?this._device.type==a.type&&this._device.address==a.address:!1};d.prototype.onStatusEvt=function(a){a&&a.data&&this._activateEvent&&this._activateEvent.status==a.data.key&&this._activateEvent.value==a.data.value&&(this._logger.log("trace","alarm door:"+this._device.address+
" receive event:"+a.data.value+" and trigger door alarm"),this._alarmTask&&this._alarmTask.triggerDoorAlarm())};d.buildDoorfromJSON=function(a){if(!a||!a.device)return null;var b=new d;b.setID(a.id);b.setDevice(a.device);b.setActivateEvent(a.activateEvent);return b};var b=function(){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTask.AlarmKey");this._alarmTask=this._deactivateEvent=this._activateEvent=this._device=this._id=null};b.prototype.init=function(){if(this._device){var a=require("x.hub.moduleman.js").modulemanager.getModule("aio");
a&&a.addStateDevice&&(this._activateEvent&&this._activateEvent.status&&a.addStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._activateEvent.status,src:"rehau:alarmTask"}),this._deactivateEvent&&this._deactivateEvent.status&&a.addStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._deactivateEvent.status,src:"rehau:alarmTask"}))}};b.prototype.finalize=function(){if(this._device){var a=require("x.hub.moduleman.js").modulemanager.getModule("aio");
a&&a.removeStateDevice&&(this._activateEvent&&this._activateEvent.status&&a.removeStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._activateEvent.status,src:"rehau:alarmTask"}),this._deactivateEvent&&this._deactivateEvent.status&&a.removeStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._deactivateEvent.status,src:"rehau:alarmTask"}))}};b.prototype.setAlarmTask=function(a){this._alarmTask=a};b.prototype.getID=function(){return this._id};
b.prototype.setID=function(a){this._id=a};b.prototype.setDevice=function(a){this._device=a};b.prototype.setActivateEvent=function(a){this._activateEvent=a};b.prototype.setDeactivateEvent=function(a){this._deactivateEvent=a};b.prototype.toJSON=function(){return{id:this._id,device:this._device,activateEvent:this._activateEvent,deactivateEvent:this._deactivateEvent}};b.prototype.matchDevice=function(a){return this._device&&a?this._device.type==a.type&&this._device.address==a.address:!1};b.prototype.onStatusEvt=
function(a){if(a&&a.data){var b=this;if(this._activateEvent&&this._activateEvent.status==a.data.key&&this._activateEvent.value==a.data.value){if(this._logger.log("trace","alarm key:"+this._device.address+" receive event:"+a.data.key+" and activate alarm task"),this._alarmTask){a=this._alarmTask.getManager();var c=this._alarmTask.getID();a._setAlarmActive(c,!0,function(a){a&&"200002"==a.code&&b._alarmTask.activationBlockedForAlarmKey()})}}else this._deactivateEvent&&this._deactivateEvent.status==a.data.key&&
this._deactivateEvent.value==a.data.value&&(this._logger.log("trace","alarm key:"+this._device.address+" receive event:"+a.data.key+" and deactivate alarm task"),this._alarmTask&&this._alarmTask.deactivate())}};b.buildKeyfromJSON=function(a){if(!a||!a.device)return null;var c=new b;c.setID(a.id);c.setDevice(a.device);c.setActivateEvent(a.activateEvent);c.setDeactivateEvent(a.deactivateEvent);return c};var c=function(){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTask.AlarmConfirmation");
this._alarmTask=this._preAlarmNotificationInterval=this._deactivateAction=this._activateAction=this._device=this._id=null};c.prototype.setAlarmTask=function(a){this._alarmTask=a};c.prototype.getID=function(){return this._id};c.prototype.setID=function(a){this._id=a};c.prototype.setDevice=function(a){this._device=a};c.prototype.setActivateAction=function(a){this._activateAction=a};c.prototype.setDeactivateAction=function(a){this._deactivateAction=a};c.prototype.toJSON=function(){return{id:this._id,
device:this._device,activateAction:this._activateAction,deactivateAction:this._deactivateAction}};c.prototype.activationBlockedForAlarmKey=function(){if(this._device&&this._activateAction&&"aio"==this._device.sys&&"HM"==this._device.type&&"ip_siren"==this._device.data){var a=require("x.hub.commandman.js").commandHandler;this._logger.log("trace","do activate confirmation:"+JSON.stringify(this.toJSON()));var b=this;a.executeCommand(this._device,null,{value:"triggerAlarm12,6,2,0",ext:[{value:"alarmAudio",
ext:"FREQUENCY_FALLING"},{value:"alarmVisual",ext:"BLINKING_ALTERNATELY_REPEATING"},{value:"alarmDur",ext:1},{value:"alarmDurUnit",ext:"S"}]},function(a){a&&a.error&&b._logger.log("trace","do activate confirmation error:"+a.error.message)})}};c.prototype.onActivated=function(){if(this._device&&this._activateAction){var a=this._activateAction;a.ref&&(a=a.ref);if("sonos"==this._device.sys&&(a=this._buildSonosCommand(this._activateAction.ext),!a))return;var b=require("x.hub.commandman.js").commandHandler;
this._logger.log("trace","do activate confirmation:"+JSON.stringify(this.toJSON()));var c=this;b.executeCommand(this._device,null,a,function(a){a&&a.error&&c._logger.log("trace","do activate confirmation error:"+a.error.message)})}};c.prototype.onDeactivated=function(){this._preAlarmNotificationInterval&&(clearInterval(this._preAlarmNotificationInterval),this._preAlarmNotificationInterval=null);if(this._device&&this._deactivateAction){var a=this._deactivateAction;a.ref&&(a=a.ref);if("sonos"==this._device.sys&&
(a=this._buildSonosCommand(this._deactivateAction.ext),!a))return;var b=require("x.hub.commandman.js").commandHandler;this._logger.log("trace","do deactivate confirmation:"+JSON.stringify(this.toJSON()));var c=this;b.executeCommand(this._device,null,a,function(a){a&&c._logger.log("trace","do deactivate confirmation error:"+a.message)})}};c.prototype.startPreAlarmNotification=function(){if(!this._preAlarmNotificationInterval){var a=this;this._doPreAlarmNotification();this._preAlarmNotificationInterval=
setInterval(function(){a._doPreAlarmNotification()},7E3)}};c.prototype.stopPreAlarmNotification=function(){this._preAlarmNotificationInterval&&(clearInterval(this._preAlarmNotificationInterval),this._preAlarmNotificationInterval=null)};c.prototype._doPreAlarmNotification=function(){if(this._device&&this._activateAction){var a=this._activateAction;a.ref&&(a=a.ref);if("sonos"==this._device.sys&&(a=this._buildSonosCommand("pre_alarm"),!a))return;var b=require("x.hub.commandman.js").commandHandler;this._logger.log("trace",
"do pre alarm notification:"+JSON.stringify(this.toJSON()));var c=this;b.executeCommand(this._device,null,a,function(a){a&&a.error&&c._logger.log("trace","do pre alarm notification error:"+a.error.message)})}};c.prototype._getLocalIP=function(){var a=require("os").networkInterfaces(),b;for(b in a)for(var c=a[b],d=0;d<c.length;d++){var e=c[d];if(e&&"IPv4"==e.family&&0==e.internal)return e.address}return null};c.prototype._getLocalPort=function(){var a=require("x.hub.js");return a.server?a.server._port:
null};c.prototype._buildSonosCommand=function(a){var b=this._getLocalIP(),c=this._getLocalPort();if(!b||!c)return null;switch(a){case "alarm_on":a="alarm_on.mp3";break;case "alarm_off":a="alarm_off.mp3";break;case "pre_alarm":a="pre_alarm.mp3";break;case "alarm":a="alarm.mp3";break;default:return null}return{value:"playUrl",ext:"http://"+b+":"+c+"/resources/rehau_alarm/"+a,timeout:15}};c.buildConfirmationfromJSON=function(a){if(!a||!a.device)return null;var b=new c;b.setID(a.id);b.setDevice(a.device);
b.setActivateAction(a.activateAction);b.setDeactivateAction(a.deactivateAction);return b};var e=function(a){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTask");this._id=a;this._pin=null;this._active=!1;this._delay=0;this._doorAlarmDelay=5;this._alarmKeys=[];this._alarmDoors=[];this._manager=this._doorAlarmDelayTimer=this._activateDelayTimer=this._associateTaskId_prealarm=this._associateTaskId_alarm=this._alarmConfirmation=null};e.DEFAULT_PIN="0000";e.prototype.init=function(a){this._logger.log("trace",
"init rehau alarm task");this._initAllAlarmKeys();this._initAllAlarmDoors();this._initAllAlarmWindowsSensors();a&&a()};e.prototype._initAllAlarmKeys=function(){for(var a=0;a<this._alarmKeys.length;a++){var b=this._alarmKeys[a];b&&b.init()}};e.prototype._initAllAlarmDoors=function(){for(var a=0;a<this._alarmDoors.length;a++){var b=this._alarmDoors[a];b&&b.init()}};e.prototype._initAllAlarmWindowsSensors=function(){this._active&&require("x.hub.m.enocean.js").setRehauAlarm(this._active)};e.prototype.setManager=
function(a){this._manager=a};e.prototype.getManager=function(){return this._manager};e.prototype.getID=function(){return this._id};e.prototype.getDelay=function(){return this._delay};e.prototype.setDelay=function(a){this._delay=a};e.prototype.getAssociateTaskIdAlarm=function(){return this._associateTaskId_alarm};e.prototype.setAssociateTaskIdAlarm=function(a){this._associateTaskId_alarm=a};e.prototype.getAssociateTaskIdPreAlarm=function(){return this._associateTaskId_prealarm};e.prototype.setAssociateTaskIdPreAlarm=
function(a){this._associateTaskId_prealarm=a};e.prototype.getPin=function(){return this._pin?this._pin:e.DEFAULT_PIN};e.prototype.setPin=function(a){this._pin=a};e.prototype.getDoorAlarmDelay=function(){return this._doorAlarmDelay};e.prototype.setDoorAlarmDelay=function(a){this._doorAlarmDelay=a};e.prototype.isActive=function(){return this._active};e.prototype.isWaitForActive=function(){return this._activateDelayTimer&&!this._active?!0:!1};e.prototype.cancelDelayActive=function(){this._activateDelayTimer&&
clearTimeout(this._activateDelayTimer);this._activateDelayTimer=null;this._doorAlarmDelayTimer&&clearTimeout(this._doorAlarmDelayTimer);this._doorAlarmDelayTimer=null};e.prototype.activate=function(){var a=require("x.hub.m.enocean.js");if(a.isRehauWindowOpen()||require("x.hub.m.hm.js").isWindowOpen())return!0;var b=this;if(this._delay)this._logger.log("trace","activate alarm task:"+this._id+" after "+this._delay+" seconds"),this._activateDelayTimer=setTimeout(function(){b._logger.log("trace","activate alarm task:"+
this._id);b._active=!0;b._setAssociateTaskActive(!0);b._manager&&b._manager.save();a.setRehauAlarm(!0);b._activateDelayTimer=null;if(b._alarmConfirmation)b._alarmConfirmation.onActivated()},1E3*this._delay);else if(this._logger.log("trace","activate alarm task:"+this._id),this._active=!0,this._setAssociateTaskActive(!0),this._manager&&this._manager.save(),a.setRehauAlarm(!0),this._alarmConfirmation)this._alarmConfirmation.onActivated();return!1};e.prototype.deactivate=function(){this._active=!1;this._activateDelayTimer&&
clearTimeout(this._activateDelayTimer);this._activateDelayTimer=null;this._doorAlarmDelayTimer&&clearTimeout(this._doorAlarmDelayTimer);this._doorAlarmDelayTimer=null;this._logger.log("trace","deactivate alarm task:"+this._id);this._setAssociateTaskActive(!1);this._manager&&this._manager.save();require("x.hub.m.enocean.js").setRehauAlarm(!1);if(this._alarmConfirmation)this._alarmConfirmation.onDeactivated()};e.prototype._setAssociateTaskActive=function(a,b){if(this._manager){var c=0;this._associateTaskId_alarm&&
(c+=1);this._associateTaskId_prealarm&&(c+=1);var d=function(){c--;0==c&&b&&b()};this._associateTaskId_alarm&&this._manager.setAssociateTaskActive(this._associateTaskId_alarm,a,d);this._associateTaskId_prealarm&&this._manager.setAssociateTaskActive(this._associateTaskId_prealarm,a,d)}else b&&b(Error("manager is null"))};e.prototype.activationBlockedForAlarmKey=function(){this._alarmConfirmation&&this._alarmConfirmation.activationBlockedForAlarmKey()};e.prototype.addAlarmKey=function(a,c){if(a)if(a=
b.buildKeyfromJSON(a))if(a.getID())c&&c(Error("id for new alarm key is not null "));else{a.setID(this._generateAlarmKeyID());this._addAlarmKeySync(a);var d=this;this._manager.save(function(a){c&&c(a,d.toJSON())})}else c&&c(Error("alarm key json invalid"));else c&&c(Error("alarm key json is null"))};e.prototype.updateAlarmKey=function(a,c){if(a)if(a=b.buildKeyfromJSON(a)){var d=a.getID();if(d){var g=this._getAlarmKeySync(d);if(g){this._deleteAlarmKeySync(g);this._addAlarmKeySync(a);var e=this;this._manager.save(function(a){c&&
c(a,e.toJSON())})}else c&&c(Error("no such alarm key with id:"+d))}else c&&c(Error("id for alarm key is null"))}else c&&c(Error("alarm key json invalid"));else c&&c(Error("alarm key json is null"))};e.prototype.deleteAlarmKey=function(a,b){if(a){var c=this._getAlarmKeySync(a.id);if(c){this._deleteAlarmKeySync(c);var d=this;this._manager.save(function(a){b&&b(a,d.toJSON())})}else b&&b(Error("no such alarm key with id:"+a.id))}else b&&b(Error("alarm key is null"))};e.prototype.addAlarmDoor=function(a,
b){if(a)if(a=d.buildDoorfromJSON(a))if(a.getID())b&&b(Error("id for new alarm door is not null "));else{a.setID(this._generateAlarmDoorID());this._addAlarmDoorSync(a);var c=this;this._manager.save(function(a){b&&b(a,c.toJSON())})}else b&&b(Error("alarm door json invalid"));else b&&b(Error("alarm door json is null"))};e.prototype.updateAlarmDoor=function(a,b){if(a)if(a=d.buildDoorfromJSON(a)){var c=a.getID();if(c){var g=this._getAlarmDoorSync(c);if(g){this._deleteAlarmDoorSync(g);this._addAlarmDoorSync(a);
var e=this;this._manager.save(function(a){b&&b(a,e.toJSON())})}else b&&b(Error("no such alarm door with id:"+c))}else b&&b(Error("id for alarm door is null"))}else b&&b(Error("alarm door json invalid"));else b&&b(Error("alarm door json is null"))};e.prototype.deleteAlarmDoor=function(a,b){if(a){var c=this._getAlarmDoorSync(a.id);if(c){this._deleteAlarmDoorSync(c);var d=this;this._manager.save(function(a){b&&b(a,d.toJSON())})}else b&&b(Error("no such alarm door with id:"+a.id))}else b&&b(Error("alarm door is null"))};
e.prototype.setAlarmConfirmation=function(a,b){if(a)if(a=c.buildConfirmationfromJSON(a)){a.setAlarmTask(this);var d=this;this._alarmConfirmation=a;this._manager.save(function(a){b&&b(a,d.toJSON())})}else b&&b(Error("alarm confirmation json invalid"));else b&&b(Error("alarm confirmation json is null"))};e.prototype.getAlarmTaskSync=function(a){return this._taskmanager.readTaskSync(a)};e.prototype.triggerDoorAlarm=function(){if(this._active)if(!this._doorAlarmDelay)this._logger.log("trace","no door alarm delay, execute associated task:"+
this._associateTaskId_alarm),this._associateTaskId_alarm&&this._manager&&this._manager.executeAssociateTask(this._associateTaskId_alarm);else if(!this._doorAlarmDelayTimer){this._alarmConfirmation&&(this._logger.log("trace","door alarm start pre-alarm notification"),this._alarmConfirmation.startPreAlarmNotification());this._logger.log("trace","door alarm execute associated task:"+this._associateTaskId_alarm+" after "+this._doorAlarmDelay+" seconds");var a=this;this._doorAlarmDelayTimer=setTimeout(function(){a._doorAlarmDelayTimer=
null;a._alarmConfirmation&&(a._logger.log("trace","door alarm stop pre-alarm notification"),a._alarmConfirmation.stopPreAlarmNotification());a._associateTaskId_alarm&&(a._logger.log("trace","door alarm execute associated task:"+a._associateTaskId_alarm),a._manager&&a._manager.executeAssociateTask(a._associateTaskId_alarm))},1E3*this._doorAlarmDelay)}};e.prototype.triggerWindowSensorAlarm=function(a){this._active&&(a&&this._associateTaskId_prealarm?this._manager&&this._manager.executeAssociateTask(this._associateTaskId_prealarm):
!a&&this._associateTaskId_alarm&&this._manager&&this._manager.executeAssociateTask(this._associateTaskId_alarm))};e.prototype.onStatusEvt=function(a){if(a){for(var b=0;b<this._alarmKeys.length;b++){var c=this._alarmKeys[b];if(c&&c.matchDevice(a.device))c.onStatusEvt(a)}for(b=0;b<this._alarmDoors.length;b++)if((c=this._alarmDoors[b])&&c.matchDevice(a.device))c.onStatusEvt(a)}};e.prototype._getAlarmKeySync=function(a){if(!a)return null;var b=this._alarmKeys.length;if(!b)return null;for(;b--;){var c=
this._alarmKeys[b];if(c&&c.getID()==a)return c}return null};e.prototype._addAlarmKeySync=function(a){a.setAlarmTask(this);this._alarmKeys.push(a);a.init()};e.prototype._deleteAlarmKeySync=function(a){a.finalize();a=this._alarmKeys.indexOf(a);-1!=a&&this._alarmKeys.splice(a,1)};e.prototype._getAlarmDoorSync=function(a){if(!a)return null;var b=this._alarmDoors.length;if(!b)return null;for(;b--;){var c=this._alarmDoors[b];if(c&&c.getID()==a)return c}return null};e.prototype._addAlarmDoorSync=function(a){a.setAlarmTask(this);
this._alarmDoors.push(a);a.init()};e.prototype._deleteAlarmDoorSync=function(a){a.finalize();a=this._alarmDoors.indexOf(a);-1!=a&&this._alarmDoors.splice(a,1)};e.prototype._generateAlarmKeyID=function(){var a=[],b=this._alarmKeys.length;if(0==b)return 1;for(;b--;){var c=this._alarmKeys[b];c&&(a[c.getID()]=!0)}for(b=1;a[b];)b++;return b};e.prototype._generateAlarmDoorID=function(){var a=[],b=this._alarmDoors.length;if(0==b)return 1;for(;b--;){var c=this._alarmDoors[b];c&&(a[c.getID()]=!0)}for(b=1;a[b];)b++;
return b};e.prototype._getActivationDelayTimer=function(a){return this._activateDelayTimer[a]};e.prototype._clearActivationDelayTimer=function(a){var b=this._activateDelayTimer[a];b&&clearTimeout(b);delete this._activateDelayTimer[a]};e.prototype.toJSON=function(){for(var a={id:this._id,active:this._active,delay:this._delay,doorAlarmDelay:this._doorAlarmDelay,alarmKeys:[],alarmDoors:[],alarmConfirmation:null,associateTaskId_alarm:this._associateTaskId_alarm,associateTaskId_prealarm:this._associateTaskId_prealarm},
b=0;b<this._alarmKeys.length;b++){var c=this._alarmKeys[b];c&&(c=c.toJSON())&&a.alarmKeys.push(c)}for(b=0;b<this._alarmDoors.length;b++)(c=this._alarmDoors[b])&&(c=c.toJSON())&&a.alarmDoors.push(c);this._alarmConfirmation&&(a.alarmConfirmation=this._alarmConfirmation.toJSON());return a};e.buldTaskFromJSON=function(a){if(!a||!a.id)return null;var g=new e(a.id);g._pin=a.pin;g._active=a.active;g._delay=a.delay;g._doorAlarmDelay=a.doorAlarmDelay;g._associateTaskId_alarm=a.associateTaskId_alarm;g._associateTaskId_prealarm=
a.associateTaskId_prealarm;if(a.alarmKeys)for(var k=0;k<a.alarmKeys.length;k++){var h=a.alarmKeys[k];h&&(h=b.buildKeyfromJSON(h))&&(h.setAlarmTask(g),g._alarmKeys.push(h))}if(a.alarmDoors)for(k=0;k<a.alarmDoors.length;k++)if(h=a.alarmDoors[k])if(h=d.buildDoorfromJSON(h))h.setAlarmTask(g),g._alarmDoors.push(h);a.alarmConfirmation&&(a=c.buildConfirmationfromJSON(a.alarmConfirmation))&&(a.setAlarmTask(g),g._alarmConfirmation=a);return g};var k=function(a){this._alarmTaskTokenPoll=[];this._manager=a};
k.prototype.generateToken=function(a){var b=this._manager._getAlarmTask(a);if(null==b||100<this._alarmTaskTokenPoll.length)return null;for(var c=this._generateNonce();this._nonceExist(c);)c=this._generateNonce();b=b.getPin();b=this._hashPin(c,b);var d=this,e={nonce:c,hash:b,taskID:a,timeout:null,failedCount:0};this._alarmTaskTokenPoll.push(e);e.timeout=setTimeout(function(){d._tokenExpired(e)},3E4);return c};k.prototype.authenticate=function(a,b){if(null==this._manager._getAlarmTask(a)||20>=b.length)return!1;
var c=b.substr(0,20);b=b.substr(20);for(var d=null,e=0;e<this._alarmTaskTokenPoll.length;e++){var g=this._alarmTaskTokenPoll[e];if(g&&g.nonce==c&&g.hash==b&&g.taskID==a)return this._tokenExpired(g),!0;g&&g.nonce==c&&(d=g)}d&&(d.failedCount+=1,3<=d.failedCount&&this._tokenExpired(d));return!1};k.prototype.expireAllToken=function(a){var b=[],c,d;for(c=0;c<this._alarmTaskTokenPoll.length;c++)(d=this._alarmTaskTokenPoll[c])&&d.taskID==a&&b.push(d);if(b&&0<b.length)for(c=0;c<this._alarmTaskTokenPoll.length;c++)d=
this._alarmTaskTokenPoll[c],this._tokenExpired(d);return!1};k.prototype._tokenExpired=function(a){a.timeout&&(clearTimeout(a.timeout),a.timeout=null);a=this._alarmTaskTokenPoll.indexOf(a);-1!=a&&this._alarmTaskTokenPoll.splice(a,1)};k.prototype._nonceExist=function(a){for(var b=0;b<this._alarmTaskTokenPoll.length;b++){var c=this._alarmTaskTokenPoll[b];if(c&&c.nonce==a)return!0}return!1};k.prototype._generateNonce=function(){return require("crypto").randomBytes(10).toString("hex")};k.prototype._hashPin=
function(a,b){a=a.substr(5,4);var c=require("crypto").createHash("sha1");c.update(a+b);return c.digest("hex")};var h=function(a){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTaskManager");this._taskmanager=a;this._alarmTasks=[];this._auth=new k(this)};h.FILE_NAME="alarm_rehau.json";h.prototype.init=function(a){this._logger.log("trace","init rehau alarm task manager");var b=this;this._loadSettings(function(c){c&&b._logger.log("warn","init rehau alarm task manager error:"+c.message);b._setupDefaultAlarmTask();
b._initAllAlarmTasks();a&&a()})};h.prototype.save=function(a){this._saveSettings(a)};h.prototype.challenge=function(a,b){this._getAlarmTask(a)?(a=this._auth.generateToken(a),b&&b(a?null:Error("generate token failed"),{token:a})):b&&b(Error("no such alarm task with id:"+a))};h.prototype.getAlarmInfo=function(a){var b=this._toSettingsJSON();a&&a(null,b)};h.prototype.setAlarmDelay=function(a,b,c,d){var e=this._getAlarmTask(a);e?e.isActive()?d&&d(Error("alarm task is active")):this._auth.authenticate(a,
c)?(e.setDelay(b),this._saveSettings(function(a){d&&d(a,e.toJSON())})):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(a)):d&&d(Error("no such alarm task with id:"+a))};h.prototype.selectAssociateTaskAlarm=function(a,b,c,d){var e=this._getAlarmTask(a);if(e){var g=null;if(b&&(g=this._taskmanager.readTaskSync(b),!g)){d&&d(Error("no such task with id:"+b));return}if(e.isActive())d&&d(Error("alarm task is active"));else if(this._auth.authenticate(a,c)){a=e.getAssociateTaskIdPreAlarm();
(c=e.getAssociateTaskIdAlarm())&&c!=b&&c!=a&&(a=this._taskmanager.readTaskSync(c))&&a.setRehauAlarmTask(!1);e.setAssociateTaskIdAlarm(b);g&&(g.setRehauAlarmTask(!0),g.setActive(!1));var k=this;this._saveSettings(function(a){a?d&&d(a):k._taskmanager.save(function(a){d&&d(a,e.toJSON())})})}else b=Error("pin error"),b.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(b)}else d&&d(Error("no such alarm task with id:"+a))};h.prototype.selectAssociateTaskPreAlarm=function(a,b,c,d){var e=this._getAlarmTask(a);
if(e){var g=null;if(b&&(g=this._taskmanager.readTaskSync(b),!g)){d&&d(Error("no such task with id:"+b));return}if(e.isActive())d&&d(Error("alarm task is active"));else if(this._auth.authenticate(a,c)){a=e.getAssociateTaskIdAlarm();(c=e.getAssociateTaskIdPreAlarm())&&c!=b&&c!=a&&(a=this._taskmanager.readTaskSync(c))&&a.setRehauAlarmTask(!1);e.setAssociateTaskIdPreAlarm(b);g&&(g.setRehauAlarmTask(!0),g.setActive(!1));var k=this;this._saveSettings(function(a){a?d&&d(a):k._taskmanager.save(function(a){d&&
d(a,e.toJSON())})})}else b=Error("pin error"),b.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(b)}else d&&d(Error("no such alarm task with id:"+a))};h.prototype.setAlarmActive=function(a,b,c,d){b||this._auth.authenticate(a,c)?this._setAlarmActive(a,b,d):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(a))};h.prototype._setAlarmActive=function(a,b,c){for(var d=null,e=0;e<this._alarmTasks.length;e++)if(this._alarmTasks[e])if(this._alarmTasks[e].getID()==a)d=this._alarmTasks[e];else{if(this._alarmTasks[e].isActive()){c&&
c(Error("another alarm task with id:"+this._alarmTasks[e].getID()+" is active"));return}this._alarmTasks[e].isWaitForActive()&&this._alarmTasks[e].cancelDelayActive()}d?b&&d.isActive()?c&&c(null,d.toJSON()):b&&!d.isActive()?d.activate()?(a=Error("rehau window is open"),a.code="200002",c&&c(a)):c&&c(null,d.toJSON()):(d.deactivate(),c&&c(null,d.toJSON())):c&&c(Error("no such alarm task with id:"+a))};h.prototype.setNewPin=function(a,b,c,d){var e=this._getAlarmTask(a);e?e.isActive()?d&&d(Error("alarm task is active")):
this._auth.authenticate(a,c)?e.getPin()==b?d&&d():(e.setPin(b),this._auth.expireAllToken(a),this._saveSettings(function(a){d&&d(a)})):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(a)):d&&d(Error("no such alarm task with id:"+a))};h.prototype.setDoorAlarmDelay=function(a,b,c,d){var e=this._getAlarmTask(a);e?e.isActive()?d&&d(Error("alarm task is active")):this._auth.authenticate(a,c)?(e.setDoorAlarmDelay(b),this._saveSettings(function(a){d&&d(a,e.toJSON())})):(a=Error("pin error"),
a.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(a)):d&&d(Error("no such alarm task with id:"+a))};h.prototype.addAlarmKey=function(a,b,c,d){var e=this._getAlarmTask(a);e?e.isActive()?d&&d(Error("alarm task is active")):this._auth.authenticate(a,c)?e.addAlarmKey(b,d):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(a)):d&&d(Error("no such alarm task with id:"+a))};h.prototype.updateAlarmKey=function(a,b,c,d){var e=this._getAlarmTask(a);e?e.isActive()?d&&d(Error("alarm task is active")):
this._auth.authenticate(a,c)?e.updateAlarmKey(b,d):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(a)):d&&d(Error("no such alarm task with id:"+a))};h.prototype.deleteAlarmKey=function(a,b,c,d){var e=this._getAlarmTask(a);e?e.isActive()?d&&d(Error("alarm task is active")):this._auth.authenticate(a,c)?e.deleteAlarmKey(b,d):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(a)):d&&d(Error("no such alarm task with id:"+a))};h.prototype.addAlarmDoor=function(a,b,
c,d){var e=this._getAlarmTask(a);e?e.isActive()?d&&d(Error("alarm task is active")):this._auth.authenticate(a,c)?e.addAlarmDoor(b,d):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(a)):d&&d(Error("no such alarm task with id:"+a))};h.prototype.updateAlarmDoor=function(a,b,c,d){var e=this._getAlarmTask(a);e?e.isActive()?d&&d(Error("alarm task is active")):this._auth.authenticate(a,c)?e.updateAlarmDoor(b,d):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(a)):
d&&d(Error("no such alarm task with id:"+a))};h.prototype.deleteAlarmDoor=function(a,b,c,d){var e=this._getAlarmTask(a);e?e.isActive()?d&&d(Error("alarm task is active")):this._auth.authenticate(a,c)?e.deleteAlarmDoor(b,d):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(a)):d&&d(Error("no such alarm task with id:"+a))};h.prototype.setAlarmConfirmation=function(a,b,c,d){var e=this._getAlarmTask(a);e?e.isActive()?d&&d(Error("alarm task is active")):this._auth.authenticate(a,c)?
e.setAlarmConfirmation(b,d):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,d&&d(a)):d&&d(Error("no such alarm task with id:"+a))};h.prototype.setAssociateTaskActive=function(a,b,c){var d=this._taskmanager.readTaskSync(a);d?(d.setActive(b),this._taskmanager.save(c)):c&&c(Error("no such task with id:"+a))};h.prototype.executeAssociateTask=function(a,b){var c=this._taskmanager.readTaskSync(a);c?c.trigger(b):b&&b(Error("no such task with id:"+a))};h.prototype.onStatusEvtForTask=function(a,
b){this._logger.log("debug","for task:"+b+" receive status event:"+JSON.stringify(a));if(b=this._getAlarmTask(b))b.onStatusEvt(a)};h.prototype.onWindowSensorAlarmTriggered=function(a){for(var b=0;b<this._alarmTasks.length;b++){var c=this._alarmTasks[b];c&&c.isActive()&&c.triggerWindowSensorAlarm(a)}};h.prototype._getAlarmTask=function(a){for(var b=0;b<this._alarmTasks.length;b++){var c=this._alarmTasks[b];if(c&&c.getID()==a)return c}return null};h.prototype._isAlarmTaskActive=function(a){};h.prototype._setupDefaultAlarmTask=
function(){if(0==this._alarmTasks.length){var a=new e(1);a.setManager(this);this._alarmTasks.push(a)}1==this._alarmTasks.length&&(a=this._alarmTasks[0],a=1==a.getID()?2:1,a=new e(a),a.setManager(this),this._alarmTasks.push(a))};h.prototype._initAllAlarmTasks=function(){for(var a=0;a<this._alarmTasks.length;a++){var b=this._alarmTasks[a];b&&b.init()}};h.prototype._loadSettings=function(a){var b=this,c=this._getFile();fs_extra.ensureFile(c,function(d){d?a&&a(d):b._loadFile(c,function(c,d){c?a&&a(c):
(b._fromSettingsJSON(d),a&&a())})})};h.prototype._saveSettings=function(a){var b=this._getFile(),c=this._toSettingsJSON();this._saveFile(b,c,function(b){a&&a(b)})};h.prototype._fromSettingsJSON=function(a){if(a&&Array.isArray(a))for(var b=0;b<a.length;b++){var c=e.buldTaskFromJSON(a[b]);c&&(c.setManager(this),this._alarmTasks.push(c))}};h.prototype._toSettingsJSON=function(){for(var a=[],b=0;b<this._alarmTasks.length;b++){var c=this._alarmTasks[b];c&&a.push(c.toJSON())}return a};h.prototype._loadFile=
function(a,b){fs.readFile(a,"utf8",function(a,c){if(a)b&&b(a);else if(c)try{var d=JSON.parse(c);b&&b(null,d)}catch(q){b&&b(q)}else b&&b(null,null)})};h.prototype._saveFile=function(a,b,c){fs.writeFile(a,JSON.stringify(b,null,2),function(a){c&&c(a)})};h.prototype._getFile=function(){var a=fileman.fileManager.getUserRootDataPath();return path.resolve(a,h.FILE_NAME)};return h}();
x.hub.taskman.TaskManager=function(){var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.taskman.TaskManager");this.version=d.TMP_VERSION;this._tasks=[];this._alarmTask=new x.hub.taskman.AlarmTask;this._mode=31;this._lock=!1};d.TMP_VERSION="1.0.0";d.NS_VERSION="2.2.2";d.FILE_NAME="tm.json";d.prototype.init=function(b){this._alarmTask.init();this._load(b)};d.prototype.clear=function(){for(var b=0;b<this._tasks.length;b++)try{this._tasks[b].finalize()}catch(c){}x.hub.taskman._TimerManager.clear();
x.hub.taskman._AstroManager.clear();x.hub.taskman._PeriodicTimerManager.clear();this._tasks=[]};d.prototype.save=function(b){this._writeData(b)};d.prototype.reload=function(b){this.clear();this._load(b)};d.prototype._load=function(b){var c=this,d=require("fs-extra"),k=this._getFile();d.ensureFile(k,function(d){d?b&&b(d):c._loadData(function(a,d){a?b&&b(a):(c._tasks=d,c._sort(),d.forEach(function(a){a.init()}),b&&b())})})};d.prototype.lock=function(){this._lock=!0};d.prototype.unlock=function(){this._lock=
!1};d.prototype.createTask=function(b,c){if(b){for(var d=1,k=-1,h=0;h<this._tasks.length;h++)if(this._tasks[h].id>d){b.id=d;k=h;break}else d++;-1==k&&(b.id=d,k=this._tasks.length);this._tasks.splice(k,0,b);b.init();this._writeData(c)}else c&&c(Error("task is null"))};d.prototype.readTask=function(b,c){if(b){for(var d=null,k=0;k<this._tasks.length;k++){var h=this._tasks[k];if(h.id==b){d=h;break}}d?c&&c(null,d):c&&c(Error("no such task with id:"+b))}else c&&c(Error("task id is null"))};d.prototype.readAllTasks=
function(b){b&&b(null,this._tasks)};d.prototype.updateTask=function(b,c,d){for(var e=null,h=-1,a=0;a<this._tasks.length;a++){var g=this._tasks[a];if(g.id==b.id){e=g;h=a;break}}if(e){if(e.isAlarmTask){if(this._alarmTask._active){d&&d(Error("alarm task active"));return}a=this._alarmTask._getAlarmPin();if(!c||c!=a){b=Error("pin error");b.code=x.hub.taskman.ERROR_CODE.Pin_Error;d&&d(b);return}}e.isRehauAlarmTask()&&e.isActive()?d&&d(Error("rehau alarm task active")):(e.finalize(),this._tasks.splice(h,
1,b),b.init(),this._writeData(d))}else d&&d(Error("no such task with id:"+b.id))};d.prototype.deleteTask=function(b,c,d){if(b){for(var e=-1,h=null,a=0;a<this._tasks.length;a++){var g=this._tasks[a];if(g.id==b){e=a;h=g;break}}if(h.isAlarmTask){if(this._alarmTask._active){d&&d(Error("alarm task active"));return}b=this._alarmTask._getAlarmPin();if(!c||c!=b){c=Error("pin error");c.code=x.hub.taskman.ERROR_CODE.Pin_Error;d&&d(c);return}}h.isRehauAlarmTask()&&h.isActive()?d&&d(Error("rehau alarm task active")):
(h.finalize(),-1!=e&&this._tasks.splice(e,1),this._writeData(d))}else d&&d(Error("task id is null"))};d.prototype.setTaskActive=function(b,c,d,k){if(b){for(var e=null,a=0;a<this._tasks.length;a++){var g=this._tasks[a];if(g.id==b){e=g;break}}if(e){if(e.isAlarmTask){if(this._alarmTask._active){k&&k(Error("alarm task active"));return}b=this._alarmTask._getAlarmPin();if(!d||d!=b){c=Error("pin error");c.code=x.hub.taskman.ERROR_CODE.Pin_Error;k&&k(c);return}}e.isRehauAlarmTask()?k&&k(Error("do not allow to set active state for rehau alarm task")):
(e.setActive(c),this._writeData(k))}else k&&k(Error("no such task:"+b))}else k&&k(Error("task id is null"))};d.prototype.doTask=function(b,c,d){if(b){for(var e=null,h=0;h<this._tasks.length;h++){var a=this._tasks[h];if(a.id==b){e=a;break}}if(e.isAlarmTask){if(this._alarmTask._active){d&&d(Error("alarm task active"));return}b=this._alarmTask._getAlarmPin();if(!c||c!=b){c=Error("pin error");c.code=x.hub.taskman.ERROR_CODE.Pin_Error;d&&d(c);return}}e.trigger(d)}else d&&d(Error("task id is null"))};d.prototype.cancelTask=
function(b,c,d){if(b){for(var e=null,h=0;h<this._tasks.length;h++){var a=this._tasks[h];if(a.id==b){e=a;break}}if(e){if(e.isAlarmTask){if(this._alarmTask._active){d&&d(Error("alarm task active"));return}b=this._alarmTask._getAlarmPin();if(!c||c!=b){c=Error("pin error");c.code=x.hub.taskman.ERROR_CODE.Pin_Error;d&&d(c);return}}e.cancel(d)}else d&&d(Error("no such task"))}else d&&d(Error("task id is null"))};d.prototype.toggleTaskActive=function(b,c,d){if(b){for(var e=null,h=0;h<this._tasks.length;h++){var a=
this._tasks[h];if(a.id==b){e=a;break}}if(e){if(e.isAlarmTask&&(b=this._alarmTask._getAlarmPin(),!c||c!=b)){c=Error("pin error");c.code=x.hub.taskman.ERROR_CODE.Pin_Error;d&&d(c);return}e.toggleActive();this._writeData(d)}else d&&d(Error("no such task:"+b))}else d&&d(Error("task id is null"))};d.prototype.isTaskRunning=function(b,c){if(b){for(var d=null,k=0;k<this._tasks.length;k++){var h=this._tasks[k];if(h.id==b){d=h;break}}d?c&&c(null,d.isRunning()):c&&c(Error("no such task"))}else c&&c(Error("task id is null"))};
d.prototype.readTaskSync=function(b){if(!b)return null;for(var c=null,d=0;d<this._tasks.length;d++){var k=this._tasks[d];if(k.id==b){c=k;break}}return c};d.prototype.startTaskTrace=function(b,c,d){this.readTask(b,function(b,e){b?d&&d(b):e.startTaskTrace(c,function(a){d&&d(a)})})};d.prototype.stopTaskTrace=function(b,c,d){this.readTask(b,function(b,e){b?d&&d(b):e.stopTaskTrace(c,function(a){d&&d(a)})})};d.prototype.setAlarmActive=function(b,c,d){this._alarmTask.setAlarmActive(b,c,this,d)};d.prototype.setAlarmDelay=
function(b,c,d){this._alarmTask.setAlarmDelay(b,c,d)};d.prototype.getAlarmInfo=function(b){this._alarmTask.getAlarmInfo(b)};d.prototype.selectAlarmTask=function(b,c,d,k){var e=this;this._alarmTask.selectAlarmTask(b,c,d,this._tasks,function(a){a?k&&k(a):e._writeData(k)})};d.prototype._getAlarmPin=function(){return this._alarmTask._getAlarmPin()};d.prototype.setAlarmPin=function(b,c,d){this._alarmTask.setAlarmPin(b,c,d)};d.prototype.onStatusEvt=function(b){if(this._lock)this._logger.log("debug","task manager locked");
else{this._logger.log("debug","receive status event:"+JSON.stringify(b));for(var c=0;c<this._tasks.length&&!(2<=c&&0!=this._mode%31);c++)this._tasks[c].onStatusEvt(b)}};d.prototype.onStatusEvtForTask=function(b,c){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("debug","for task:"+c+" receive status event:"+JSON.stringify(b));for(var d=0;d<this._tasks.length&&!(2<=d&&0!=this._mode%31);d++){var k=this._tasks[d];if(k.id==c)k.onStatusEvtForTask(b)}}};d.prototype.onIREvt=
function(b){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("info","receive ir event:"+JSON.stringify(b));for(var c=0;c<this._tasks.length&&!(2<=c&&0!=this._mode%31);c++)this._tasks[c].onIREvt(b)}};d.prototype.onLocationChange=function(b){this._lock?this._logger.log("debug","task manager locked"):(x.hub.taskman._TimerManager.onLocationChange(b),x.hub.taskman._AstroManager.onLocationChange(b),x.hub.taskman._PeriodicTimerManager.onLocationChange(b))};d.prototype.onTimeChange=
function(b){this._lock?this._logger.log("debug","task manager locked"):(x.hub.taskman._TimerManager.onTimeChange(b),x.hub.taskman._AstroManager.onTimeChange(b),x.hub.taskman._PeriodicTimerManager.onTimeChange(b))};d.prototype.onTimerTick=function(b){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("info","receive time tick for task:"+b);for(var c=0;c<this._tasks.length&&!(2<=c&&0!=this._mode%31);c++){var d=this._tasks[c];if(d.id==b)d.onTimerTick()}}};d.prototype.onHttpEvt=
function(b,c){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("info","receive http event"+JSON.stringify(b));var d=!1,k=0;k=this._tasks.length;0!=this._mode%31&&2<k&&(k=2);for(var h=0;h<this._tasks.length&&!(2<=h&&0!=this._mode%31);h++)this._tasks[h].onHttpEvt(b,function(a,b){b&&(d=!0);k--;0==k&&c&&c(null,d)})}};d.prototype.onActivation=function(b){this.version=b?d.NS_VERSION:d.TMP_VERSION};d.prototype._writeData=function(b){var c=[];this._tasks.forEach(function(b){b&&
c.push(b.toJSON())});var d=require("fs"),k=this._getFile();d.writeFile(k,JSON.stringify(c,null,2),function(c){b&&b(c)})};d.prototype._loadData=function(b){var c=require("fs"),d=this._getFile();c.readFile(d,"utf8",function(c,d){if(c)b&&b(c);else if(d)try{var a=JSON.parse(d),e=[];Array.isArray(a)&&a.forEach(function(a){(a=x.hub.taskman.Task.parse(a))&&e.push(a)});b&&b(null,e?e:[])}catch(l){b&&b(l)}else b&&b(null,[])})};d.prototype._getFile=function(){var b=require("x.hub.fileman.js").fileManager,c=
require("path");require("fs");b=b.getUserRootDataPath();return c.resolve(b,d.FILE_NAME)};d.prototype._sort=function(){var b=this._tasks.length-1;do{var c=!1;for(var d=0;d<b;++d)this._tasks[d].id>this._tasks[d+1].id&&(c=this._tasks[d],this._tasks[d]=this._tasks[d+1],this._tasks[d+1]=c,c=!0)}while(c)};return d}();
x.hub.taskman.Handler=function(){var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.taskman.Handler");this.taskManager=new x.hub.taskman.TaskManager;this._rehauAlarmTaskManager=new x.hub.taskman.rehau.AlarmTaskManager(this.taskManager);var b=require("x.hub.eventbus.js");b.on("status",this.onStatusEvt.bind(this));b.on("irevt",this.onIREvt.bind(this));b.on("locationchange",this.onLocationChange.bind(this));b.on("timechange",this.onTimeChange.bind(this));b.on("neoserver_activation",
this.onActivation.bind(this))};d.prototype.TaskManager=x.hub.taskman.TaskManager;d.prototype.Cloud=x.hub.taskman.Cloud;d.prototype.init=function(b){this._logger.log("info","init task manager");if(localStorage){"true"==localStorage.getItem("x.hub.taskman.NEO_SERVER")&&(this.taskManager.version=x.hub.taskman.TaskManager.NS_VERSION);var c=localStorage.getItem("x.hub.taskman.CLOUD_SERVER");c&&(x.hub.taskman.Cloud.prototype.URL=c)}var d=this;this.taskManager.init(function(){d._rehauAlarmTaskManager.init(b)})};
d.prototype.getRehauAlarmTaskManager=function(){return this._rehauAlarmTaskManager};d.prototype.lock=function(){this.taskManager.lock()};d.prototype.unlock=function(){this.taskManager.unlock()};d.prototype.doWebRequest=function(b,c,d){var e=function(b){if(b.error){var a=x.hub.taskman.ERROR_CODE.General_Error;b.error.code&&(a=b.error.code);d(JSON.stringify({XC_ERR:{code:a,msg:b.error.message}}))}else d(JSON.stringify({XC_SUC:"undefined"!=typeof b.data&&null!=b.data?b.data:""}))};switch(b){case "Read":b=
c.query.id;"undefined"==typeof b?this.readAllTasks(e):this.readTask(b,e);break;case "Create":this.createTask(c.query.data,e);break;case "Update":this.updateTask(c.query.data,c.query.pin,e);break;case "Delete":this.deleteTask(c.query.id,c.query.pin,e);break;case "Do":this.doTask(c.query.id,c.query.pin,e);break;case "Cancel":this.cancelTask(c.query.id,c.query.pin,e);break;case "isRunning":this.isTaskRunning(c.query.id,e);break;case "SetTaskActive":this.setTaskActive(c.query.id,c.query.active,c.query.pin,
e);break;case "ToggleTaskActive":this.toggleTaskActive(c.query.id,c.query.pin,e);break;case "SetAlarmActive":this.setAlarmActive(c.query.active,c.query.pin,e);break;case "SetAlarmDelay":this.setAlarmDelay(c.query.delay,c.query.pin,e);break;case "GetAlarmInfo":this.getAlarmInfo(e);break;case "SelectAlarmTask":this.selectAlarmTask(c.query.id,c.query.isAlarmTask,c.query.pin,e);break;case "SetAlarmPin":this.setAlarmPin(c.query.newPin,c.query.pin,e);break;case "GetCloudServer":e({data:x.hub.taskman.Cloud.prototype.URL});
break;case "SetCloudServer":if(!c.query.url){e({error:Error("url invalid")});break}"http"!=c.query.url.substr(0,4)&&(c.query.url="https://"+c.query.url);localStorage.setItem("x.hub.taskman.CLOUD_SERVER",c.query.url);x.hub.taskman.Cloud.prototype.URL=c.query.url;e({data:"success"});break;default:b&&0==b.indexOf("Rehau")&&this.doRehauWebRequest(b,c,d)}};d.prototype.doRehauWebRequest=function(b,c,d){var e=function(b){if(b.error){var a=x.hub.taskman.ERROR_CODE.General_Error;b.error.code&&(a=b.error.code);
d(JSON.stringify({XC_ERR:{code:a,msg:b.error.message}}))}else d(JSON.stringify({XC_SUC:"undefined"!=typeof b.data&&null!=b.data?b.data:""}))};switch(b){case "RehauPinChallenge":this._rehauAlarmTaskManager.challenge(c.query.id,function(b,a){e({error:b,data:a})});break;case "RehauGetAlarmInfo":this._rehauAlarmTaskManager.getAlarmInfo(function(b,a){e({error:b,data:a})});break;case "RehauSetAlarmDelay":this._rehauAlarmTaskManager.setAlarmDelay(c.query.id,c.query.delay,c.query.token,function(b,a){e({error:b,
data:a})});break;case "RehauSetDoorAlarmDelay":this._rehauAlarmTaskManager.setDoorAlarmDelay(c.query.id,c.query.delay,c.query.token,function(b,a){e({error:b,data:a})});break;case "RehauSetAlarmActive":this._rehauAlarmTaskManager.setAlarmActive(c.query.id,c.query.active,c.query.token,function(b,a){e({error:b,data:a})});break;case "RehauSelectAssociateTaskAlarm":this._rehauAlarmTaskManager.selectAssociateTaskAlarm(c.query.id,c.query.associateTaskId,c.query.token,function(b,a){e({error:b,data:a})});
break;case "RehauSelectAssociateTaskPreAlarm":this._rehauAlarmTaskManager.selectAssociateTaskPreAlarm(c.query.id,c.query.associateTaskId,c.query.token,function(b,a){e({error:b,data:a})});break;case "RehauSetNewPin":this._rehauAlarmTaskManager.setNewPin(c.query.id,c.query.pin,c.query.token,function(b,a){e({error:b,data:a})});break;case "RehauAddAlarmKey":this._rehauAlarmTaskManager.addAlarmKey(c.query.id,c.query.data,c.query.token,function(b,a){e({error:b,data:a})});break;case "RehauUpdateAlarmKey":this._rehauAlarmTaskManager.updateAlarmKey(c.query.id,
c.query.data,c.query.token,function(b,a){e({error:b,data:a})});break;case "RehauDeleteAlarmKey":this._rehauAlarmTaskManager.deleteAlarmKey(c.query.id,c.query.data,c.query.token,function(b,a){e({error:b,data:a})});break;case "RehauAddAlarmDoor":this._rehauAlarmTaskManager.addAlarmDoor(c.query.id,c.query.data,c.query.token,function(b,a){e({error:b,data:a})});break;case "RehauUpdateAlarmDoor":this._rehauAlarmTaskManager.updateAlarmDoor(c.query.id,c.query.data,c.query.token,function(b,a){e({error:b,data:a})});
break;case "RehauDeleteAlarmDoor":this._rehauAlarmTaskManager.deleteAlarmDoor(c.query.id,c.query.data,c.query.token,function(b,a){e({error:b,data:a})});break;case "RehauSetAlarmConfirmation":this._rehauAlarmTaskManager.setAlarmConfirmation(c.query.id,c.query.data,c.query.token,function(b,a){e({error:b,data:a})})}};d.prototype.readAllTasks=function(b){this.taskManager.readAllTasks(function(c,d){if(c)b&&b({error:c});else{var e=[];d.forEach(function(b){e.push(b.toJSON())});b&&b({data:e})}})};d.prototype.createTask=
function(b,c){b?(b.id||(b.id=-1),(b=x.hub.taskman.Task.parse(b))?this.taskManager.createTask(b,function(b){c&&c({error:b})}):c&&c({error:Error("task json invalid")})):c&&c({error:Error("task json is null")})};d.prototype.readTask=function(b,c){this.taskManager.readTask(b,function(b,d){c&&c({error:b,data:d?d.toJSON():null})})};d.prototype.updateTask=function(b,c,d){b?(b=x.hub.taskman.Task.parse(b))?this.taskManager.updateTask(b,c,function(b){d&&d({error:b})}):d&&d({error:Error("task json invalid")}):
d&&d({error:Error("task json is null")})};d.prototype.deleteTask=function(b,c,d){this.taskManager.deleteTask(b,c,function(b){d&&d({error:b})})};d.prototype.setTaskActive=function(b,c,d,k){this.taskManager.setTaskActive(b,c,d,function(b){k&&k({error:b})})};d.prototype.doTask=function(b,c,d){this.taskManager.doTask(b,c,function(b){d&&d({error:b})})};d.prototype.cancelTask=function(b,c,d){this.taskManager.cancelTask(b,c,function(b){d&&d({error:b})})};d.prototype.toggleTaskActive=function(b,c,d){this.taskManager.toggleTaskActive(b,
c,function(b){d&&d({error:b})})};d.prototype.isTaskRunning=function(b,c){this.taskManager.isTaskRunning(b,function(b,d){c&&c({error:b,data:d})})};d.prototype.startTaskTrace=function(b,c,d){this.taskManager.startTaskTrace(b,c,function(b){d&&d({error:b})})};d.prototype.stopTaskTrace=function(b,c,d){this.taskManager.stopTaskTrace(b,c,function(b){d&&d({error:b})})};d.prototype.setAlarmActive=function(b,c,d){this.taskManager.setAlarmActive(b,c,function(b){d&&d({error:b})})};d.prototype.setAlarmDelay=function(b,
c,d){this.taskManager.setAlarmDelay(b,c,function(b){d&&d({error:b})})};d.prototype.getAlarmInfo=function(b){this.taskManager.getAlarmInfo(function(c,d){b&&b({error:c,data:d})})};d.prototype.selectAlarmTask=function(b,c,d,k){this.taskManager.selectAlarmTask(b,c,d,function(b){k&&k({error:b})})};d.prototype.setAlarmPin=function(b,c,d){this.taskManager.setAlarmPin(b,c,function(b){d&&d({error:b})})};d.prototype._getAlarmPin=function(){return this.taskManager._getAlarmPin()};d.prototype.onStatusEvt=function(b,
c){c&&"taskman"==c.src&&c.taskID?(this._logger.log("trace","receive for task: "+c.taskID+" status event:"+JSON.stringify(b)),this.taskManager.onStatusEvtForTask(b,c.taskID)):c&&"rehau:alarmTask"==c.src&&c.alarmTaskID?(this._logger.log("trace","receive for rehau alarm task: "+c.alarmTaskID+" status event:"+JSON.stringify(b)),this._rehauAlarmTaskManager.onStatusEvtForTask(b,c.alarmTaskID)):(this._logger.log("trace","receive status event:"+JSON.stringify(b)),this.taskManager.onStatusEvt(b))};d.prototype.onIREvt=
function(b){this._logger.log("trace","receive ir event:"+JSON.stringify(b));this.taskManager.onIREvt(b)};d.prototype.onLocationChange=function(b){this._logger.log("trace","receive location change event:"+JSON.stringify(b));this.taskManager.onLocationChange(b)};d.prototype.onTimeChange=function(b){this._logger.log("trace","receive time change event:"+JSON.stringify(b));this.taskManager.onTimeChange(b)};d.prototype.onActivation=function(b){this._logger.log("trace","receive activation change event:"+
b);var c=!1;"true"==b&&(c=!0);this.taskManager.onActivation(c)};return d}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.taskman.Handler);
