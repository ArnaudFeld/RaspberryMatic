var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,d,f){a!=Array.prototype&&a!=Object.prototype&&(a[d]=f.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var a=0;return function(d){return $jscomp.SYMBOL_PREFIX+(d||"")+a++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var d=0;return $jscomp.iteratorPrototype(function(){return d<a.length?{done:!1,value:a[d++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.iteratorFromArray=function(a,d){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var f=0,b={next:function(){if(f<a.length){var c=f++;return{value:d(c,a[c]),done:!1}}b.next=function(){return{done:!0,value:void 0}};return b.next()}};b[Symbol.iterator]=function(){return b};return b};
$jscomp.polyfill=function(a,d,f,b){if(d){f=$jscomp.global;a=a.split(".");for(b=0;b<a.length-1;b++){var c=a[b];c in f||(f[c]={});f=f[c]}a=a[a.length-1];b=f[a];d=d(b);d!=b&&null!=d&&$jscomp.defineProperty(f,a,{configurable:!0,writable:!0,value:d})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");var x=x||{};x.hub=x.hub||{};x.hub.resource=x.hub.resource||{};
x.hub.resource.ResourceManager=function(){var a=function(b){this._name=b?b.name:null;this._path=b?b.path:null};a.prototype.getName=function(){return this._name};a.prototype.getPath=function(){return this._path};a.prototype.getURL=function(){};a.prototype.toJSON=function(){return{name:this._name,path:this._path}};a.parseJSON=function(b){return b&&b.name&&b.path?new a(b):null};var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.resource.ResourceContainer");this._rootDataFolder=null;
this._resourceFolderName="resources";this._metaFile="resource.json";this._resources=[]};d.prototype.getResourceFolder=function(){return require("path").join(this._rootDataFolder,this._resourceFolderName)};d.prototype.getMetaFilePath=function(){return require("path").join(this.getResourceFolder(),this._metaFile)};d.prototype.init=function(b,c){this._logger.log("info","init resource folder:"+b);this._rootDataFolder=b;var e=this;this._init(function(h){h&&e._logger.log("warn","init resource folder:"+
b+" faild:"+h.message);c&&c(h)})};d.prototype.listFiles=function(b){if(!b)return this._resources;for(var c=[],e=0,h=this._resources.length;e<h;e++){var a=this._resources[e];if(a){var g=a.getName();g&&g.substr(0,b.length)==b&&c.push(a)}}return c};d.prototype.getFilePath=function(b){for(var c=0,e=this._resources.length;c<e;c++){var h=this._resources[c];if(h){var a=h.getName();if(a&&a==b&&(h=h.getPath()))return require("path").join(this.getResourceFolder(),h)}}};d.prototype.getFileURL=function(b,c){for(var e=
null,h=0,a=this._resources.length;h<a;h++){var g=this._resources[h];if(g&&(g=g.getName())&&g==b){e="http://";c=this._getLocalIP(c);h=this._getLocalPort();e+=c;h&&(e+=":"+h);e+="/file/"+b;break}}return e};d.prototype.createFile=function(b,c,e){var h=b.split("/");h=this._genFilePath(h[h.length-1]);var d=require("path").relative(this.getResourceFolder(),h),g=this;this._createFile(h,c,function(c,h){c?e&&e(c):(c=a.parseJSON({name:b,path:d}),g._resources.push(c),c=g._resources2meta(g._resources),g._saveMetaFile(c,
function(b){e&&e(b,h)}))})};d.prototype.deleteFile=function(b,c){var e=this.getFilePath(b);if(e){for(var h=-1,a=0,g=this._resources.length;a<g;a++){var d=this._resources[a];if(d&&d.getName()==b){h=a;break}}var f=this;this._deleteFile(e,function(b){b?c&&c(b):(f._resources.splice(h,1),b=f._resources2meta(f._resources),f._saveMetaFile(b,function(b){c&&c(b)}))})}else c&&c()};d.prototype._init=function(b){var c=this;this._loadMetaFile(function(e,a){e?b&&b(e):(c._resources=c._meta2resources(a),b&&b(null))})};
d.prototype._loadMetaFile=function(b){var c=require("fs-extra"),e=this.getMetaFilePath();c.ensureFile(e,function(a){a?b&&b(a):c.readFile(e,{encoding:"utf8"},function(c,e){if(c)b&&b(c);else try{var a=[];e&&(a=JSON.parse(e));b&&b(null,a)}catch(l){b&&b(c)}})})};d.prototype._meta2resources=function(b){var c=[];if(b)for(var e=0,h=b.length;e<h;e++)if(b[e]){var d=a.parseJSON(b[e]);d&&c.push(d)}return c};d.prototype._resources2meta=function(b){for(var c=[],e=0,a=b.length;e<a;e++){var d=b[e];d&&c.push(d.toJSON())}return c};
d.prototype._saveMetaFile=function(b,c){var e=require("fs-extra"),a=this.getMetaFilePath();e.ensureFile(a,function(d){d?c&&c(d):e.writeFile(a,JSON.stringify(b),function(b){c&&c(b)})})};d.prototype._genFilePath=function(b){var c=require("path");b=c.extname(b);for(var e={},a=0,d=this._resources.length;a<d;a++){var g=this._resources[a];g&&(g=g.getPath(),e[g]=!0)}for(a=1;;)if(e[a+b])a++;else break;return c.join(this.getResourceFolder(),a+b)};d.prototype._createFile=function(b,c,e){var a=require("fs-extra");
a.exists(b,function(d){if(d)try{a.removeSync(b)}catch(l){e&&e(l);return}var g=e,h=0;d=a.createWriteStream(b);d.on("error",function(b){g&&(g(b),g=null)});c.on("data",function(b){h+=b.length});c.on("end",function(){g&&(g(null,h),g=null)});c.on("error",function(b){g&&(g(b),g=null)});c.pipe(d)})};d.prototype._deleteFile=function(b,c){var a=require("fs-extra");a.exists(b,function(e){e?a.remove(b,function(b){c&&c(b)}):c&&c()})};d.prototype._getLocalIP=function(b){var c=null,a=require("os").networkInterfaces(),
d;for(d in a)for(var f=a[d],g=0;g<f.length;g++){var k=f[g];if(k&&"IPv4"==k.family&&0==k.internal)if(b){if(this._matchSubnetMask(k.address,b,k.netmask))return k.address;c=k.address}else return k.address}return c};d.prototype._getLocalPort=function(){var b=require("x.hub.js");return b.server?b.server._port:null};d.prototype._matchSubnetMask=function(b,c,a){b=this._ip2int(b);c=this._ip2int(c);a=this._ip2int(a);return(b&a)==(c&a)};d.prototype._ip2int=function(b){return b.split(".").reduce(function(b,
a){return(b<<8)+parseInt(a,10)},0)>>>0};var f=function(){this._logger=require("x.logger.js").getLogger("x.hub.resource.ResourceManager");this._userResourceContainer=this._sysResourceContainer=this._userDataFolder=this._systemDataFolder=null};f.prototype.init=function(b,c){this._logger.log("info","init resource manager");this._systemDataFolder=b.getCWD();this._userDataFolder=b.getUserRootDataPath();this._init(c)};f.prototype.listFiles=function(b){var c={},a=this._sysResourceContainer.listFiles(b);
if(a)for(var d=0,f=a.length;d<f;d++){var g=a[d];g=g.getName();c[g]=!0}if(a=this._userResourceContainer.listFiles(b))for(d=0,f=a.length;d<f;d++)g=a[d],g=g.getName(),c[g]=!0;return Object.keys(c)};f.prototype.getFilePath=function(b){var a=this._userResourceContainer.getFilePath(b);a||(a=this._sysResourceContainer.getFilePath(b));return a};f.prototype.createFile=function(b,a,d){"public/system/"==b.substr(0,14)?d&&d(Error("not allow to upload file to public/system/")):this.getFilePath(b)?d&&d(Error("file:"+
b+" exists")):this._userResourceContainer.createFile(b,a,d)};f.prototype.deleteFile=function(b,a){this._sysResourceContainer.getFilePath(b)?a&&a(Error("not allow to delete file from system folder")):this._userResourceContainer.deleteFile(b,a)};f.prototype.getFileURL=function(b,a){var c=this._userResourceContainer.getFileURL(b,a);c||(c=this._sysResourceContainer.getFileURL(b,a));return c};f.prototype._init=function(b){var a=this;this._initSystemResourceContainer(function(c){c?b&&b(c):a._initUserResourceContainer(function(a){b&&
b(a)})})};f.prototype._initSystemResourceContainer=function(b){this._sysResourceContainer=new d;this._sysResourceContainer.init(this._systemDataFolder,b)};f.prototype._initUserResourceContainer=function(b){this._userResourceContainer=new d;this._userResourceContainer.init(this._userDataFolder,b)};return f}();
x.hub.resource.Handler=function(){var a=function(){this._logger=require("x.logger.js").getLogger("x.hub.resource.Handler");this.resourceManager=new x.hub.resource.ResourceManager};a.prototype.init=function(a,f,b){this._initHttpApi(a);this.resourceManager.init(f,function(a){a&&b(a)})};a.prototype._initHttpApi=function(a){var d=this,b=require("x.hub.js").getServer();a.get("/file/*",function(a,e,f){var c=a.path.substr(6),g=!1;g=c&&"public/"==c.substr(0,7)?!0:b.auth(a);if("/"==a.path.charAt(a.path.length-
1)){a=null;if(!c&&!g)c="public/";else if(c&&"public/"!=c.substr(0,7)&&!g){e.json({XC_ERR:{code:"000007",msg:"access denied"}});return}a=d.listFiles(c);e.json({XC_SUC:a?a:[]})}else if(c&&"public/"!=c.substr(0,7)&&!g)e.status(403).json({XC_ERR:{code:"000007",msg:"access denied"}});else{var h=d.getFilePath(c);h?require("fs").exists(h,function(a){a?e.sendFile(h,null,function(a){a&&f(a)}):e.status(404).json({XC_ERR:{code:"000404",msg:"not found"}})}):e.status(404).json({XC_ERR:{code:"000404",msg:"not found"}})}});
a.post("/file/*",function(a,e){if(b.auth(a))if("/"==a.path.charAt(a.path.length-1))e.json({XC_ERR:{code:"000101",msg:"no file name"}});else{var c=a.path.substr(6),f=a.headers["content-length"];f&&parseInt(f)?d.createFile(c,a,function(a,b){a?e.json({XC_ERR:{code:"000101",msg:a.message}}):e.json({XC_SUC:{bytes:b}})}):d.deleteFile(c,function(a){a?e.json({XC_ERR:{code:"000101",msg:a.message}}):e.json({XC_SUC:{}})})}else e.json({XC_ERR:{code:"000007",msg:"access denied"}})})};a.prototype.listFiles=function(a){return this.resourceManager.listFiles(a)};
a.prototype.getFilePath=function(a){return this.resourceManager.getFilePath(a)};a.prototype.createFile=function(a,f,b){this.resourceManager.createFile(a,f,b)};a.prototype.deleteFile=function(a,f){this.resourceManager.deleteFile(a,f)};a.prototype.getFileURL=function(a,f){return this.resourceManager.getFileURL(a,f)};return a}();module.exports=new x.hub.resource.Handler;
