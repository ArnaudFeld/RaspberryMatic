var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var c=0;return function(){return c<a.length?{done:!1,value:a[c++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,e){a!=Array.prototype&&a!=Object.prototype&&(a[c]=e.value)};$jscomp.getGlobal=function(a){a=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,a];for(var c=0;c<a.length;++c){var e=a[c];if(e&&e.Math==Math)return e}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(a,c){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:c})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function a(e){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(e||"")+"_"+c++,e)}var c=0;return a}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.asyncIterator;a||(a=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};
$jscomp.iteratorFromArray=function(a,c){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var e=0,b={next:function(){if(e<a.length){var d=e++;return{value:c(d,a[d]),done:!1}}b.next=function(){return{done:!0,value:void 0}};return b.next()}};b[Symbol.iterator]=function(){return b};return b};
$jscomp.polyfill=function(a,c,e,b){if(c){e=$jscomp.global;a=a.split(".");for(b=0;b<a.length-1;b++){var d=a[b];d in e||(e[d]={});e=e[d]}a=a[a.length-1];b=e[a];c=c(b);c!=b&&null!=c&&$jscomp.defineProperty(e,a,{configurable:!0,writable:!0,value:c})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");var x=x||{};x.hub=x.hub||{};x.hub.resource=x.hub.resource||{};
x.hub.resource.ResourceManager=function(){var a=function(b){this._name=b?b.name:null;this._path=b?b.path:null};a.prototype.getName=function(){return this._name};a.prototype.getPath=function(){return this._path};a.prototype.getURL=function(){};a.prototype.toJSON=function(){return{name:this._name,path:this._path}};a.parseJSON=function(b){return b&&b.name&&b.path?new a(b):null};var c=function(){this._logger=require("x.logger.js").getLogger("x.hub.resource.ResourceContainer");this._rootDataFolder=null;
this._resourceFolderName="resources";this._metaFile="resource.json";this._resources=[]};c.prototype.getResourceFolder=function(){return require("path").join(this._rootDataFolder,this._resourceFolderName)};c.prototype.getMetaFilePath=function(){return require("path").join(this.getResourceFolder(),this._metaFile)};c.prototype.init=function(b,d){this._logger.log("info","init resource folder:"+b);this._rootDataFolder=b;var f=this;this._init(function(k){k&&f._logger.log("warn","init resource folder:"+
b+" faild:"+k.message);d&&d(k)})};c.prototype.listFiles=function(b){if(!b)return this._resources;for(var d=[],f=0,k=this._resources.length;f<k;f++){var a=this._resources[f];if(a){var c=a.getName();c&&c.substr(0,b.length)==b&&d.push(a)}}return d};c.prototype.getFilePath=function(b){for(var d=0,f=this._resources.length;d<f;d++){var a=this._resources[d];if(a){var c=a.getName();if(c&&c==b&&(a=a.getPath()))return require("path").join(this.getResourceFolder(),a)}}};c.prototype.getFileURL=function(b,d){for(var f=
null,a=0,c=this._resources.length;a<c;a++){var g=this._resources[a];if(g&&(g=g.getName())&&g==b){f="http://";d=this._getLocalIP(d);a=this._getLocalPort();f+=d;a&&(f+=":"+a);f+="/file/"+b;break}}return f};c.prototype.createFile=function(b,d,f){var c=b.split("/");c=this._genFilePath(c[c.length-1]);var m=require("path").relative(this.getResourceFolder(),c),g=this;this._createFile(c,d,function(d,c){d?f&&f(d):(d=a.parseJSON({name:b,path:m}),g._resources.push(d),d=g._resources2meta(g._resources),g._saveMetaFile(d,
function(b){f&&f(b,c)}))})};c.prototype.deleteFile=function(b,d){var f=this.getFilePath(b);if(f){for(var a=-1,c=0,g=this._resources.length;c<g;c++){var e=this._resources[c];if(e&&e.getName()==b){a=c;break}}var l=this;this._deleteFile(f,function(b){b?d&&d(b):(l._resources.splice(a,1),b=l._resources2meta(l._resources),l._saveMetaFile(b,function(b){d&&d(b)}))})}else d&&d()};c.prototype._init=function(b){var d=this;this._loadMetaFile(function(f,a){f?b&&b(f):(d._resources=d._meta2resources(a),b&&b(null))})};
c.prototype._loadMetaFile=function(b){var d=require("fs-extra"),f=this.getMetaFilePath();d.ensureFile(f,function(a){a?b&&b(a):d.readFile(f,{encoding:"utf8"},function(d,a){if(d)b&&b(d);else try{var f=[];a&&(f=JSON.parse(a));b&&b(null,f)}catch(l){b&&b(d)}})})};c.prototype._meta2resources=function(b){var d=[];if(b)for(var f=0,c=b.length;f<c;f++)if(b[f]){var e=a.parseJSON(b[f]);e&&d.push(e)}return d};c.prototype._resources2meta=function(b){for(var d=[],a=0,c=b.length;a<c;a++){var e=b[a];e&&d.push(e.toJSON())}return d};
c.prototype._saveMetaFile=function(b,d){var a=require("fs-extra"),c=this.getMetaFilePath();a.ensureFile(c,function(f){f?d&&d(f):a.writeFile(c,JSON.stringify(b),function(b){d&&d(b)})})};c.prototype._genFilePath=function(b){var d=require("path");b=d.extname(b);for(var a={},c=0,e=this._resources.length;c<e;c++){var g=this._resources[c];g&&(g=g.getPath(),a[g]=!0)}for(c=1;;)if(a[c+b])c++;else break;return d.join(this.getResourceFolder(),c+b)};c.prototype._createFile=function(b,d,a){var c=require("fs-extra");
c.exists(b,function(f){if(f)try{c.removeSync(b)}catch(l){a&&a(l);return}var e=a,k=0;f=c.createWriteStream(b);f.on("error",function(b){e&&(e(b),e=null)});d.on("data",function(b){k+=b.length});d.on("end",function(){e&&(e(null,k),e=null)});d.on("error",function(b){e&&(e(b),e=null)});d.pipe(f)})};c.prototype._deleteFile=function(b,d){var a=require("fs-extra");a.exists(b,function(c){c?a.remove(b,function(b){d&&d(b)}):d&&d()})};c.prototype._getLocalIP=function(b){var d=null,a=require("os").networkInterfaces(),
c;for(c in a)for(var e=a[c],g=0;g<e.length;g++){var h=e[g];if(h&&"IPv4"==h.family&&0==h.internal)if(b){if(this._matchSubnetMask(h.address,b,h.netmask))return h.address;d=h.address}else return h.address}return d};c.prototype._getLocalPort=function(){var b=require("x.hub.js");return b.server?b.server._port:null};c.prototype._matchSubnetMask=function(b,d,a){b=this._ip2int(b);d=this._ip2int(d);a=this._ip2int(a);return(b&a)==(d&a)};c.prototype._ip2int=function(b){return b.split(".").reduce(function(b,
a){return(b<<8)+parseInt(a,10)},0)>>>0};var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.resource.ResourceManager");this._userResourceContainer=this._sysResourceContainer=this._userDataFolder=this._systemDataFolder=null};e.prototype.init=function(b,a){this._logger.log("info","init resource manager");this._systemDataFolder=b.getCWD();this._userDataFolder=b.getUserRootDataPath();this._init(a)};e.prototype.listFiles=function(b){var a={},c=this._sysResourceContainer.listFiles(b);
if(c)for(var e=0,m=c.length;e<m;e++){var g=c[e];g=g.getName();a[g]=!0}if(c=this._userResourceContainer.listFiles(b))for(e=0,m=c.length;e<m;e++)g=c[e],g=g.getName(),a[g]=!0;return Object.keys(a)};e.prototype.getFilePath=function(b){var a=this._userResourceContainer.getFilePath(b);a||(a=this._sysResourceContainer.getFilePath(b));return a};e.prototype.createFile=function(b,a,c){"public/system/"==b.substr(0,14)?c&&c(Error("not allow to upload file to public/system/")):this.getFilePath(b)?c&&c(Error("file:"+
b+" exists")):this._userResourceContainer.createFile(b,a,c)};e.prototype.deleteFile=function(b,a){this._sysResourceContainer.getFilePath(b)?a&&a(Error("not allow to delete file from system folder")):this._userResourceContainer.deleteFile(b,a)};e.prototype.getFileURL=function(b,a){var c=this._userResourceContainer.getFileURL(b,a);c||(c=this._sysResourceContainer.getFileURL(b,a));return c};e.prototype._init=function(b){var a=this;this._initSystemResourceContainer(function(c){c?b&&b(c):a._initUserResourceContainer(function(a){b&&
b(a)})})};e.prototype._initSystemResourceContainer=function(a){this._sysResourceContainer=new c;this._sysResourceContainer.init(this._systemDataFolder,a)};e.prototype._initUserResourceContainer=function(a){this._userResourceContainer=new c;this._userResourceContainer.init(this._userDataFolder,a)};return e}();
x.hub.resource.Handler=function(){var a=function(){this._logger=require("x.logger.js").getLogger("x.hub.resource.Handler");this.resourceManager=new x.hub.resource.ResourceManager};a.prototype.init=function(a,e,b){this._initHttpApi(a);this.resourceManager.init(e,function(a){a&&b(a)})};a.prototype._initHttpApi=function(a){var c=this,b=require("x.hub.js").getServer();a.get("/file/*",function(a,e,k){var d=a.path.substr(6),f=!1;f=d&&"public/"==d.substr(0,7)?!0:b.auth(a);if("/"==a.path.charAt(a.path.length-
1)){a=null;if(!d&&!f)d="public/";else if(d&&"public/"!=d.substr(0,7)&&!f){e.json({XC_ERR:{code:"000007",msg:"access denied"}});return}a=c.listFiles(d);e.json({XC_SUC:a?a:[]})}else if(d&&"public/"!=d.substr(0,7)&&!f)e.status(403).json({XC_ERR:{code:"000007",msg:"access denied"}});else{var h=c.getFilePath(d);h?require("fs").exists(h,function(a){a?e.sendFile(h,null,function(a){a&&k(a)}):e.status(404).json({XC_ERR:{code:"000404",msg:"not found"}})}):e.status(404).json({XC_ERR:{code:"000404",msg:"not found"}})}});
a.post("/file/*",function(a,e){if(b.auth(a))if("/"==a.path.charAt(a.path.length-1))e.json({XC_ERR:{code:"000101",msg:"no file name"}});else{var d=a.path.substr(6),f=a.headers["content-length"];f&&parseInt(f)?c.createFile(d,a,function(a,b){a?e.json({XC_ERR:{code:"000101",msg:a.message}}):e.json({XC_SUC:{bytes:b}})}):c.deleteFile(d,function(a){a?e.json({XC_ERR:{code:"000101",msg:a.message}}):e.json({XC_SUC:{}})})}else e.json({XC_ERR:{code:"000007",msg:"access denied"}})})};a.prototype.listFiles=function(a){return this.resourceManager.listFiles(a)};
a.prototype.getFilePath=function(a){return this.resourceManager.getFilePath(a)};a.prototype.createFile=function(a,e,b){this.resourceManager.createFile(a,e,b)};a.prototype.deleteFile=function(a,e){this.resourceManager.deleteFile(a,e)};a.prototype.getFileURL=function(a,e){return this.resourceManager.getFileURL(a,e)};return a}();module.exports=new x.hub.resource.Handler;
