var x=x||{};x.mjpeg=x.mjpeg||{},x.mjpeg.Client=function(){var e=function e(_e,t){this._mjpegUrl=_e,this._options=t,this._mjpegClientID=null;};e.prototype.getFile=function(e,t,n){this._getFile(e,t,n);},e.prototype._getFile=function(e,t,n){var i=t;i.url=e;var r=this;this._mjpegClientID?(i.clientID=this._mjpegClientID,XC.callHost("mjpeg","getMjpegFile",i,function(e){e&&!e.error&&e.file?(e.clientID&&(r._mjpegClientID=e.clientID),n&&n(e.file)):n&&n();})):XC.callHost("mjpeg","buildSocket",i,function(i){!i||i.error?n&&n():i.clientID&&(r._mjpegClientID=i.clientID,r._getFile(e,t,n));});};var t=function t(e,_t){this._mjpegUrl=e,this._options=_t,this._stream=null,this._currentImage=null,this._timeout=null;};t.prototype.getFile=function(e,t,n){var i=this;null!=this._timeout&&(clearTimeout(this._timeout),this._timeout=setTimeout(function(){i._timeout=null,i._close();},1e4)),this._stream?i._writeImage2File(i._currentImage,n):this._connect(e,t,function(e,t){e?(i._stream=e,i._currentImage=t,null!=i._timeout&&clearTimeout(i._timeout),i._timeout=setTimeout(function(){i._timeout=null,i._close();},1e4),i._writeImage2File(i._currentImage,n)):n&&n(null);});},t.prototype._writeImage2File=function(e,t){if(null!=e){var n=require("fs"),i=require("os").tmpdir();i.charAt(i.length-1)!=require("path").sep&&(i+=require("path").sep);var r=i+"xcdl"+require("path").sep,l=r+Math.random().toString(36).substring(2);try{n.existsSync(r)||n.mkdirSync(r);}catch(e){return void(t&&t(null));}n.writeFile(l,e,function(e){t&&t(e?null:l);});}else t&&t(null);},t.prototype._connect=function(e,t,n,i){var r=this,l=require("url").parse(e),o=80;if(!l.port||(0==(o=parseInt(l.port))&&(o=80),o>0&&o<65536)){var u={host:l.hostname,port:o,path:l.path,method:"GET"};t&&t.user&&(u.auth=t.user+":"+t.password),i&&(u.headers=u.headers||{},u.headers.Authorization=i);var s=require("http");"https"==e.substring(0,5).toLowerCase()&&(s=require("https"));var a=n,c=s.request(u,function(l){if(200==l.statusCode){var o;a&&(a(c),a=null);var s=-1,h=-1,p=new Buffer([]);l.on("end",function(){a&&(a(null),a=null),r._stream=null,r._close();}),l.on("data",function(e){if(e&&(p=Buffer.concat([p,e])),-1==s)for(o=0;o<p.length;o++)if(255==p[o]&&216==p[o+1]){s=o;break;}if(s>=0&&-1==h)for(o=p.length-2;o>s;o--)if(255==p[o]&&217==p[o+1]){h=o+1;break;}s>=0&&h>0?(r._currentImage=p.slice(s,h),p=h==p.length-1?new Buffer([]):p.slice(h+1),s=-1,h=-1):p.length>204800&&r._close();});}else if(302==l.statusCode)l.headers.location?(r._connect(l.headers.location,t,n),l.destroy()):a&&(a(null),a=null);else if(401!=l.statusCode||i)a&&(a(null),a=null);else if(i=null,l.headers&&l.headers["www-authenticate"]&&"Digest "==l.headers["www-authenticate"].substr(0,7)){var m=require("x.crypt.js");(i=m.DigestAuth(l.headers["www-authenticate"],u.path,t.user,t.password))?r._connect(e,t,n,i):a&&(a(null),a=null);}else a&&(a(null),a=null);});c.setTimeout(3e4,function(){c.abort();}),c.on("error",function(e){a?(a(null),a=null):(r._stream=null,r._close());}),c.end();}else n&&n(null);},t.prototype._close=function(){this._stream&&this._stream.abort(),this._timeout&&clearTimeout(this._timeout),this._stream=null,this._currentImage=null,this._timeout=null;};var n=function n(){};return n.getClient=function(n,i){var r=null;if(window&&!window.XCHost&&(r="node-webkit"),window&&window.XCHost&&window.XCHost.getType&&(r=window.XCHost.getType()),"Android"==r)return new e(n,i);if("node-webkit"==r||process&&"node"==process.title)return new t(n,i);throw new Error("iOS should not use mjpeg client");},n;}(),x.mjpeg.Handler=function(){var e=function e(){};return e.prototype.getClient=function(e,t){if(!e)throw new Error("mjpeg url invalid");return x.mjpeg.Client.getClient(e,t);},e;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new x.mjpeg.Handler());