var x=x||{};x.mjpeg=x.mjpeg||{};
x.mjpeg.Client=function(){var e=function(f,a){this._mjpegUrl=f;this._options=a;this._mjpegClientID=null};e.prototype.getFile=function(f,a,d){this._getFile(f,a,d)};e.prototype._getFile=function(f,a,d){a.url=f;var b=this;this._mjpegClientID?(a.clientID=this._mjpegClientID,XC.callHost("mjpeg","getMjpegFile",a,function(a){a&&!a.error&&a.file?(a.clientID&&(b._mjpegClientID=a.clientID),d&&d(a.file)):d&&d()})):XC.callHost("mjpeg","buildSocket",a,function(h){!h||h.error?d&&d():h.clientID&&(b._mjpegClientID=
h.clientID,b._getFile(f,a,d))})};var c=function(f,a){this._mjpegUrl=f;this._options=a;this._timeout=this._currentImage=this._stream=null};c.prototype.getFile=function(f,a,d){var b=this;null!=this._timeout&&(clearTimeout(this._timeout),this._timeout=setTimeout(function(){b._timeout=null;b._close()},1E4));this._stream?b._writeImage2File(b._currentImage,d):this._connect(f,a,function(a,f){a?(b._stream=a,b._currentImage=f,null!=b._timeout&&clearTimeout(b._timeout),b._timeout=setTimeout(function(){b._timeout=
null;b._close()},1E4),b._writeImage2File(b._currentImage,d)):d&&d(null)})};c.prototype._writeImage2File=function(f,a){if(null==f)a&&a(null);else{var d=require("fs"),b=require("os").tmpdir();b.charAt(b.length-1)!=require("path").sep&&(b+=require("path").sep);var b=b+"xcdl"+require("path").sep,h=b+Math.random().toString(36).substring(2);try{d.existsSync(b)||d.mkdirSync(b)}catch(c){a&&a(null);return}d.writeFile(h,f,function(b){a&&a(b?null:h)})}};c.prototype._connect=function(f,a,d,b){var h=this,c=require("url").parse(f),
e=80;if(c.port&&(e=parseInt(c.port),0==e&&(e=80),!(0<e&&65536>e))){d&&d(null);return}var n={host:c.hostname,port:e,path:c.path,method:"GET"};a&&a.user&&(n.auth=a.user+":"+a.password);b&&(n.headers.Authorization=b);c=require("http");"https"==f.substring(0,5).toLowerCase()&&(c=require("https"));var g=d,p=c.request(n,function(c){if(200==c.statusCode){g&&(g(p),g=null);var e,l=-1,m=-1,k=new Buffer([]);c.on("end",function(){g&&(g(null),g=null);h._stream=null;h._close()});c.on("data",function(a){a&&(k=Buffer.concat([k,
a]));if(-1==l)for(e=0;e<k.length;e++)if(255==k[e]&&216==k[e+1]){l=e;break}if(0<=l&&-1==m)for(e=k.length-2;e>l;e--)if(255==k[e]&&217==k[e+1]){m=e+1;break}0<=l&&0<m?(h._currentImage=k.slice(l,m),k=m==k.length-1?new Buffer([]):k.slice(m+1),m=l=-1):204800<k.length&&h._close()})}else 302==c.statusCode?c.headers.location?(h._connect(c.headers.location,a,d),c.destroy()):g&&(g(null),g=null):401!=c.statusCode||b?g&&(g(null),g=null):(b=null,c.headers&&c.headers["www-authenticate"]&&"Digest "==c.headers["www-authenticate"].substr(0,
7)?(b=require("x.crypt.js").DigestAuth(c.headers["www-authenticate"],n.path,a.user,a.password))?h._connect(f,a,d,b):g&&(g(null),g=null):g&&(g(null),g=null))});p.setTimeout(3E4,function(){p.abort()});p.on("error",function(a){g?(g(null),g=null):(h._stream=null,h._close())});p.end()};c.prototype._close=function(){this._stream&&this._stream.abort();this._timeout&&clearTimeout(this._timeout);this._timeout=this._currentImage=this._stream=null};var n=function(){};n.getClient=function(f,a){var d=null;window&&
!window.XCHost&&(d="node-webkit");window&&window.XCHost&&window.XCHost.getType&&(d=window.XCHost.getType());if("Android"==d)return new e(f,a);if("node-webkit"==d||process&&"node"==process.title)return new c(f,a);throw Error("iOS should not use mjpeg client");};return n}();x.mjpeg.Handler=function(){var e=function(){};e.prototype.getClient=function(c,e){if(!c)throw Error("mjpeg url invalid");return x.mjpeg.Client.getClient(c,e)};return e}();
"undefined"!=typeof module&&null!=module&&(module.exports=new x.mjpeg.Handler);
