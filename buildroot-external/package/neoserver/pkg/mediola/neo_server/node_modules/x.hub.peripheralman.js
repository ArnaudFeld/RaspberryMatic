var util=require("util"),EventEmitter=require("events");require("x.logger.js").setLevel("debug","x.hub.peripheralman");var x=x||{};x.hub=x.hub||{};x.hub.peripheralman=x.hub.peripheralman||{};
x.hub.peripheralman.PeripheralManager=function(){var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.peripheralman.PeripheralManager");this._peripherals=[]};d.FILE_NAME="pm.json";d.prototype.init=function(a){var b=this;this._load(function(c){c?a&&a(c):(global&&"A20"!=global.PLATFORM&&"PI2"!=global.PLATFORM&&"MAC"!=global.PLATFORM||"MAC"!=global.PLATFORM&&b._initUdevMonitor(),a&&a())})};d.prototype.getUSBDevices=function(){return this._peripherals};d.prototype._load=function(a){var b=
this,c=require("fs-extra"),e=require("x.hub.fileman.js").fileManager,g=require("path");e=e.getUserRootDataPath();var f=g.resolve(e,d.FILE_NAME);c.ensureFile(f,function(c){c?a&&a(c):b._loadData(f,function(c,e){c?a&&a(c):(b._peripherals=e,a&&a())})})};d.prototype._loadData=function(a,b){require("fs").readFile(a,"utf8",function(a,e){if(a)b&&b(a);else if(e)try{var c=JSON.parse(e);b&&b(null,c)}catch(f){b&&b(f)}else b&&b(null,[])})};d.prototype._initUdevMonitor=function(){var a=require("udev").monitor();
a.on("add",this._onAdd.bind(this));a.on("remove",this._onRemove.bind(this));a.on("change",this._onChange.bind(this));a=this._listSerialDev();var b=this;a&&a.forEach(function(a){if(a=b._udev2dev(a))console.log("find dev",a),b._onFindUsbDevice(a)})};d.prototype._listSerialDev=function(){return global&&"A20"!=global.PLATFORM&&"PI2"!=global.PLATFORM&&"MAC"!=global.PLATFORM?null:require("udev").list("tty")};d.prototype._isSameDev=function(a,b){for(var c in a)if(a.hasOwnProperty(c)&&a[c]!=b[c])return!1;
for(c in b)if(b.hasOwnProperty(c)&&a[c]!=b[c])return!1;return!0};d.prototype._onAdd=function(a){this._logger.log("trace","add: "+JSON.stringify(a));(a=this._udev2dev(a))&&this._onFindUsbDevice(a)};d.prototype._onRemove=function(a){this._logger.log("trace","remove: "+JSON.stringify(a));(a=this._udev2dev(a))&&this._onRemoveUsbDevice(a)};d.prototype._onChange=function(a){this._logger.log("trace","changed: "+JSON.stringify(a))};d.prototype._udev2dev=function(a){if(!a||"usb"!=a.ID_BUS||!a.DEVNAME)return null;
var b={},c;for(c in a)a.hasOwnProperty(c)&&"ID"==c.substr(0,2)&&(b[c]=a[c]);a={port:a.DEVNAME,info:b};"EnOcean_GmbH"==b.ID_VENDOR&&b.ID_USB_DRIVER?a.type="enocean":"0658"==b.ID_VENDOR&&b.ID_USB_DRIVER?a.type="zwave":"mediola_IopOS"==b.ID_VENDOR&&"IopZigbee_USB_CDC"==b.ID_MODEL&&(a.type="zigbee");return a};d.prototype._onFindUsbDevice=function(a){for(var b=this._peripherals.length,c=!1,e=null;b;)if(b--,e=this._peripherals[b],this._isSameDev(e.info,a.info)){c=!0;e.port=a.port;break}c||(e=a,this._peripherals.push(e));
a=require("x.hub.eventbus.js");switch(e.type){case "enocean":a.emit("x.hub.peripheralman.ADD_ENOCEAN",e);break;case "zwave":a.emit("x.hub.peripheralman.ADD_ZWAVE",e);break;case "zigbee":a.emit("x.hub.peripheralman.ADD_ZIGBEE",e)}};d.prototype._onRemoveUsbDevice=function(a){for(var b=this._peripherals.length,c=!1,e=null;b;)if(b--,e=this._peripherals[b],this._isSameDev(e.info,a.info)){c=!0;break}c&&this._peripherals.splice(b,1);a=require("x.hub.eventbus.js");switch(e.type){case "enocean":a.emit("x.hub.peripheralman.REMOVE_ENOCEAN",
e);break;case "zwave":a.emit("x.hub.peripheralman.REMOVE_ZWAVE",e);break;case "zigbee":a.emit("x.hub.peripheralman.REMOVE_ZIGBEE",e)}};return d}();
x.hub.peripheralman.Handler=function(){var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.peripheralman.Handler");this.peripheralManager=new x.hub.peripheralman.PeripheralManager};d.prototype.PeripheralManager=x.hub.peripheralman.PeripheralManager;d.prototype.init=function(a,b,c){this.peripheralManager.init(c)};d.prototype.getUSBDevices=function(a){var b=this.peripheralManager.getUSBDevices();a&&a({data:b})};d.prototype.getUSBDevicesShortInfo=function(a){for(var b=this.peripheralManager.getUSBDevices(),
c=[],e=0;e<b.length;e++){var d=b[e];d.type&&c.push({port:d.port,type:d.type,model:d.info?d.info.ID_MODEL:null,serial:d.info?d.info.ID_SERIAL:null,vendor:d.info?d.info.ID_VENDOR:null})}a&&a({data:c})};return d}();module.exports=new x.hub.peripheralman.Handler;
