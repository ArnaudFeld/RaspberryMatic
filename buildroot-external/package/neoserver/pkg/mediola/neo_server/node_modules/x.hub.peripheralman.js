var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.peripheralman=x.hub.peripheralman||{};
x.hub.peripheralman.PeripheralManager=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.peripheralman.PeripheralManager");this._peripherals=[]};e.FILE_NAME="pm.json";e.prototype.init=function(a){var b=this;this._load(function(c){c?a&&a(c):(global&&"A20"!=global.PLATFORM&&"PI2"!=global.PLATFORM&&"MAC"!=global.PLATFORM||"MAC"!=global.PLATFORM&&b._initUdevMonitor(),a&&a())})};e.prototype.getUSBDevices=function(){return this._peripherals};e.prototype._load=function(a){var b=
this,c=require("fs-extra"),d=require("x.hub.fileman.js").fileManager,g=require("path");d=d.getUserRootDataPath();var f=g.resolve(d,e.FILE_NAME);c.ensureFile(f,function(c){c?a&&a(c):b._loadData(f,function(c,d){c?a&&a(c):(b._peripherals=d,a&&a())})})};e.prototype._loadData=function(a,b){require("fs").readFile(a,"utf8",function(a,d){if(a)b&&b(a);else if(d)try{var c=JSON.parse(d);b&&b(null,c)}catch(f){b&&b(f)}else b&&b(null,[])})};e.prototype._initUdevMonitor=function(){var a=require("udev").monitor();
a.on("add",this._onAdd.bind(this));a.on("remove",this._onRemove.bind(this));a.on("change",this._onChange.bind(this));a=this._listSerialDev();var b=this;a&&a.forEach(function(a){if(a=b._udev2dev(a))console.log("find dev",a),b._onFindUsbDevice(a)})};e.prototype._listSerialDev=function(){return global&&"A20"!=global.PLATFORM&&"PI2"!=global.PLATFORM&&"MAC"!=global.PLATFORM?null:require("udev").list("tty")};e.prototype._isSameDev=function(a,b){for(var c in a)if(a.hasOwnProperty(c)&&a[c]!=b[c])return!1;
for(c in b)if(b.hasOwnProperty(c)&&a[c]!=b[c])return!1;return!0};e.prototype._onAdd=function(a){this._logger.log("trace","add: "+JSON.stringify(a));(a=this._udev2dev(a))&&this._onFindUsbDevice(a)};e.prototype._onRemove=function(a){this._logger.log("trace","remove: "+JSON.stringify(a));(a=this._udev2dev(a))&&this._onRemoveUsbDevice(a)};e.prototype._onChange=function(a){this._logger.log("trace","changed: "+JSON.stringify(a))};e.prototype._udev2dev=function(a){if(!a||"usb"!=a.ID_BUS||!a.DEVNAME)return null;
var b={},c;for(c in a)a.hasOwnProperty(c)&&"ID"==c.substr(0,2)&&(b[c]=a[c]);a={port:a.DEVNAME,info:b};"EnOcean_GmbH"==b.ID_VENDOR&&b.ID_USB_DRIVER?a.type="enocean":"0658"==b.ID_VENDOR&&b.ID_USB_DRIVER?a.type="zwave":"mediola_IopOS"==b.ID_VENDOR&&"IopZigbee_USB_CDC"==b.ID_MODEL&&(a.type="zigbee");return a};e.prototype._onFindUsbDevice=function(a){for(var b=this._peripherals.length,c=!1,d=null;b;)if(b--,d=this._peripherals[b],this._isSameDev(d.info,a.info)){c=!0;d.port=a.port;break}c||(d=a,this._peripherals.push(d));
a=require("x.hub.eventbus.js");switch(d.type){case "enocean":a.emit("x.hub.peripheralman.ADD_ENOCEAN",d);break;case "zwave":a.emit("x.hub.peripheralman.ADD_ZWAVE",d);break;case "zigbee":a.emit("x.hub.peripheralman.ADD_ZIGBEE",d)}d&&d.info&&d.info.ID_USB_DRIVER&&a.emit("x.hub.peripheralman.ADD_SEIRAL",d)};e.prototype._onRemoveUsbDevice=function(a){for(var b=this._peripherals.length,c=!1,d=null;b;)if(b--,d=this._peripherals[b],this._isSameDev(d.info,a.info)){c=!0;break}c&&this._peripherals.splice(b,
1);a=require("x.hub.eventbus.js");switch(d.type){case "enocean":a.emit("x.hub.peripheralman.REMOVE_ENOCEAN",d);break;case "zwave":a.emit("x.hub.peripheralman.REMOVE_ZWAVE",d);break;case "zigbee":a.emit("x.hub.peripheralman.REMOVE_ZIGBEE",d)}d&&d.info&&d.info.ID_USB_DRIVER&&a.emit("x.hub.peripheralman.REMOVE_SEIRAL",d)};return e}();
x.hub.peripheralman.Handler=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.peripheralman.Handler");this.peripheralManager=new x.hub.peripheralman.PeripheralManager};e.prototype.PeripheralManager=x.hub.peripheralman.PeripheralManager;e.prototype.init=function(a,b,c){this.peripheralManager.init(c)};e.prototype.getUSBDevices=function(a){var b=this.peripheralManager.getUSBDevices();a&&a({data:b})};e.prototype.getUSBDevicesShortInfo=function(a){for(var b=this.peripheralManager.getUSBDevices(),
c=[],d=0;d<b.length;d++){var e=b[d];e.type&&c.push({port:e.port,type:e.type,model:e.info?e.info.ID_MODEL:null,serial:e.info?e.info.ID_SERIAL:null,vendor:e.info?e.info.ID_VENDOR:null})}a&&a({data:c})};return e}();module.exports=new x.hub.peripheralman.Handler;
