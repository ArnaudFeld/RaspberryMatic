var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.systemdata=xnm.aio.systemdata||{};
xnm.aio.systemdata.SystemData=function(){this._sysData=null;this._dataKey="system";this._init=function(){this._sysData=this._load();this._sysData||(this._sysData=this.getEmptyDeviceJson(),this._save())};this.getEmptyDeviceJson=function(){return{rooms:[],devices:[],gateways:[]}};this._save=function(){XC.localStorage.setJson(this._dataKey,this._sysData)};this._load=function(){return XC.localStorage.getJson(this._dataKey)};this._getNextIndex=function(a){if(0===a.length)return 1;for(var b=0,c=0;c<a.length;c++)b<
a[c].index&&(b=a[c].index);return b+1};this.addGateway=function(a,b){this._sysData.gateways.push({name:a,index:this._getNextIndex(this._sysData.gateways),info:b});this._save()};this.saveGateway=function(a){for(var b=0;b<this._sysData.gateways.length;b++){var c=this._sysData.gateways[b];if(c.index===a.index){c.name=a.name;c.info.ip=a.info.ip;this._save();XC.debugf("gateway changed saved");break}}};this.getGateways=function(a){var b=this._sysData.gateways.slice(0);if(!a)return b;for(var c=[],d=0;d<
b.length;d++)a(b[d])&&c.push(b[d]);return c};this.deleteGateways=function(a){for(var b=this._sysData.gateways.length;b--;)a(this._sysData.gateways[b])&&this._sysData.gateways.splice(b,1);this._save()};this.addRoom=function(a){a.index=this._getNextIndex(this._sysData.rooms);this._sysData.rooms.push(a);this._save()};this.saveRoom=function(a){for(var b=0;b<this._sysData.rooms.length;b++){var c=this._sysData.rooms[b];if(c.index===a.index){c.name=a.name;c.type=a.type;this._save();break}}};this.getRooms=
function(a){var b=this._sysData.rooms.slice(0);if(!a)return b;filtered=[];for(var c=0;c<b.length;c++)a(b[c])&&filtered.push(b[c]);return filtered};this.deleteRooms=function(a){for(var b=this._sysData.rooms.length;b--;)a(this._sysData.rooms[b])&&(this.deleteDevices(function(a){return a.room===this._sysData.rooms[b].index}.bind(this)),this._sysData.rooms.splice(b,1));this._save()};this.addDevice=function(a){a.index=this._getNextIndex(this._sysData.devices);XC.debugf(a.index);this._sysData.devices.push(a);
this._save()};this.saveDevice=function(a){for(var b=0;b<this._sysData.devices.length;b++){var c=this._sysData.devices[b];if(c.index===a.index){c.name=a.name;c.order=a.order;c.info._target=a.info._target;this._save();break}}};this.getDevices=function(a){var b=this._sysData.devices.slice(0);if(!a)return b;filtered=[];for(var c=0;c<b.length;c++)a(b[c])&&filtered.push(b[c]);return filtered};this.deleteDevices=function(a){for(var b=this._sysData.devices.length;b--;)a(this._sysData.devices[b])&&(this._unlearnDevice(this._sysData.devices[b]),
this._sysData.devices.splice(b,1));this._save()};this.getHueGatewayInfo=function(a){return{ip:a.ip,sys:"hue",port:a.port,uuid:a.uuid,username:a._USER,password:""}};this.getV5PlusInfo=function(a){return{ip:a.ip,tz:a.TZ,mac:a.mac,ntp:a.ntp,sys:"aio",lat:a.LAT,port:80,long:a.LONG,name:a.name,server:a.server,rfmode:a.RFM,version:a.hwv,username:"user",password:"",firmware:a.msv,gateway_vendor:"mediola"}};this._unlearnDevice=function(a){var b=this._getGatewayByDevice(a);b=new (require("xnm.aio.gateway.js").Gateway)(b.info.ip);
switch(a.info.sys){case "hm":require("xnm.aio.gateway").Systems.HM_X.delSensor(b,a.info.address)}};this._getGatewayByDevice=function(a){return this.getGateways(function(b){return b.index===a.info.gateway})[0]};this._init()};xnm.aio.systemdata.Handler=function(){};xnm.aio.systemdata.Handler.prototype.SystemData=xnm.aio.systemdata.SystemData;"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.systemdata.Handler);
