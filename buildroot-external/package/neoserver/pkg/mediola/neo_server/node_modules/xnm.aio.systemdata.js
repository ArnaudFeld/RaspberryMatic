var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,b,d){a instanceof String&&(a=String(a));for(var c=a.length,e=0;e<c;e++){var f=a[e];if(b.call(d,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,d){a!=Array.prototype&&a!=Object.prototype&&(a[b]=d.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,d,c){if(b){d=$jscomp.global;a=a.split(".");for(c=0;c<a.length-1;c++){var e=a[c];e in d||(d[e]={});d=d[e]}a=a[a.length-1];c=d[a];b=b(c);b!=c&&null!=b&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,d){return $jscomp.findInternal(this,a,d).v}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.systemdata=xnm.aio.systemdata||{};
xnm.aio.systemdata.SystemData=function(){this._path="./";this.$ircodesXML=this.$macrosXML=this.$devicesXML=null;this._gateways={};this._cams={};this._locations={};this._macros={};this._ircodes={};this._programs={};this._loadedCallback=null;this._demoMode=!0;this.exportMacros=!1;this.load=function(a,b,d){this._demoMode=b;this._path=a;this._loadedCallback=d;this._loadXMLFile("devices.xml",this._parseDevicesXML)};this._getEmptyXML=function(a){var b=null;"devices.xml"==a?b='<?xml version="1.0" encoding="UTF-8" ?>\r\n<devices><gateways/><cams/><groups/><locations/><sysvars/></devices>':
"macros.xml"==a?b='<?xml version="1.0" encoding="UTF-8" ?>\r\n<locations><location id="default"></location></locations>':"ircodes.xml"==a&&(b='<?xml version="1.0" encoding="UTF-8" ?>\r\n<ircodes></ircodes>');return $.parseXML(b)};this._loadXMLFile=function(a,b){var d;!this._demoMode&&window.localStorage&&(d=XC.localStorage.getItem(this._path+a));if(d){try{var c=$.parseXML(d)}catch(h){c=this._getEmptyXML(a)}b.call(this,c)}else if(this._demoMode){var e=this._path+a,f=this;$.ajax({type:"GET",url:e,dataType:"xml",
context:this,isLocal:!0,success:b,error:function(a,c,d){require("fs").readFile(e,"utf8",function(a,c){!a&&c&&b.call(f,$.parseXML(c))})}})}else b.call(this,this._getEmptyXML(a))};this.getXMLString=function(a){var b='<?xml version="1.0" encoding="UTF-8" ?>\r\n';"devices"==a?b=this.$devicesXML.getXMLString():"macros"==a?b=this.$macrosXML.getXMLString():"ircodes"==a&&(b=this.$ircodesXML.getXMLString());return b};this.saveData=function(a){if(!this._demoMode)if("devices"==a)XC.debugf("save devices.xml"),
window.localStorage&&XC.localStorage.setItem(this._path+"devices.xml",this.getXMLString(a));else if("macros"==a){if(XC.debugf("save macros.xml"),window.localStorage&&XC.localStorage.setItem(this._path+"macros.xml",this.getXMLString(a)),this.exportMacros){a=require("fs");var b=a.dataPath()+"/";a.mkdirRecursiveSync(b);var d=[],c=this;this.$macrosXML.find("locations location").each(function(){var a=$(this).attr("id");c.$macrosXML.find("locations location[id='"+a+"'] macro").each(function(){d.push({scene:$(this).attr("id"),
room:a})})});a.writeFile(b+"macros.json",JSON.stringify(d),function(a){window.XC&&window.XC.callHost&&window.XC.callHost("SYSTEM","sendExtensionMessage",{msg:"UPDATE_SCENES_NOTIFICATION"})})}}else"ircodes"==a&&(XC.debugf("save ircodes.xml"),window.localStorage&&XC.localStorage.setItem(this._path+"ircodes.xml",this.getXMLString(a)))};this.getGateway=function(a){return(a=this.$devicesXML.find("gateways gateway[id='"+a+"']"))&&0<a.length?$(a[0]):null};this.getDeviceName=function(a,b){var d=null;this.$devicesXML.find("locations location device[type='"+
a+"']").each(function(){var a=$(this);a.attr("address")&&a.attr("address").toLowerCase()==b.toLowerCase()&&(d=a.parent().attr("id")+"."+a.attr("id"))});return d};this.getValidDeviceString=function(a){a=$.trim(a);a=a.replace(/\./g,"-");return a=a.replace(/:/g,"-")};this.createCodeSet=function(){var a="01",b=[];this.$ircodesXML.find("ircodes device").each(function(){b.push($(this).attr("id"))});for(var d=1;100>d;d++){var c=""+d;10>d&&(c="0"+d);if(-1==$.inArray(c,b)){a=c;d=$(this.$ircodesXML.get(0).createElement("device"));
d.attr("id",a);d.appendTo(this.$ircodesXML.find("ircodes"));this.saveData("ircodes");break}}return a};this.setCode=function(a,b,d){a||(a=this.createCodeSet());var c=this.$ircodesXML.find("ircodes device[id='"+a+"']");if(c&&0<c.length){var e=c[0];(c=$(e).find("ircodes device key[id='"+b+"']"))&&0<c.length?c[0].attr("code",d):(c=$(this.$ircodesXML.get(0).createElement("key")),c.attr("id",b),c.attr("code",d),c.appendTo(e))}this.saveData("ircodes");return a};this.deleteCode=function(a,b){var d=b.attr("id"),
c=a.parent().attr("id"),e=a.attr("id");this.$macrosXML.find("locations location macro command").each(function(){var a=$(this),b=a.attr("action");b&&(b=b.split("."),3==b.length&&b[0]==c&&b[1]==e&&b[2]==d&&a.remove())});b.remove();this.saveData("ircodes");this.saveData("macros")};this.changeCodeName=function(a,b,d){var c=b.attr("id"),e=a.parent().attr("id"),f=a.attr("id");this.$macrosXML.find("locations location macro command").each(function(){var a=$(this),b=a.attr("action");b&&(b=b.split("."),3==
b.length&&b[0]==e&&b[1]==f&&b[2]==c&&a.attr("action",e+"."+f+"."+d))});b.attr("id",d);this.saveData("ircodes");this.saveData("macros")};this.getDeviceData=function(a){a=a.split(".");if(2==a.length){var b=null,d=a[1].split(":");2==d.length&&(a[1]=d[0],b=d[1]);d=null;var c=this.$devicesXML.find("locations location[id='"+a[0]+"'] device[id='"+a[1]+"']");c&&0<c.length?(c=$(c[0]),d={},d.location=a[0],d.id=c.attr("id"),d.type=c.attr("type"),d.gateway=c.attr("gateway"),d.address=c.attr("address"),d.pwd=
c.attr("pwd"),d.data=c.attr("data"),c.attr("subtype")&&(d.subtype=c.attr("subtype"))):(c=this.$devicesXML.find("groups device[id='"+a[1]+"']"))&&0<c.length&&(c=$(c[0]),d={},d.location=a[0],d.id=c.attr("id"),d.type=c.attr("type"),d.data=c.attr("data"));if(d)return b&&(d.channel=b),d}return null};this.changeGatewayName=function(a,b){var d=a.attr("id");a.attr("id",b);this.$devicesXML.find("locations location device[gateway='"+d+"']").each(function(){$(this).attr("gateway",b)});this.saveData("devices")};
this.deleteGateway=function(a){var b=this;this.$devicesXML.find("locations location device[gateway='"+a.attr("id")+"']").each(function(){var a=$(this);a.parent().attr("id");a.attr("id");b.deleteDevice(a)});a.remove();this.saveData("devices")};this.changeLocationName=function(a,b){var d=a.attr("id");a.attr("id",b);this.$macrosXML.find("locations location[id='"+d+"']").each(function(){$(this).attr("id",b)});this.$macrosXML.find("locations location macro command").each(function(){var a=$(this),e=a.attr("action");
e&&(e=e.split("."),3==e.length&&e[0]==d&&a.attr("action",b+"."+e[1]+"."+e[2]))});this.$devicesXML.find("groups device ref").each(function(){var a=$(this),e=a.text().split(".");2==e.length&&e[0]==d&&a.text(b+"."+e[1])});this.saveData("devices");this.saveData("macros")};this.changeDeviceName=function(a,b){var d=a.attr("id"),c=a.parent().attr("id");a.attr("id",b);this.$macrosXML.find("locations location macro command").each(function(){var a=$(this),f=a.attr("action");f&&(f=f.split("."),3==f.length&&
f[0]==c&&f[1]==d&&a.attr("action",c+"."+b+"."+f[2]))});this.$devicesXML.find("groups device ref").each(function(){var a=$(this),f=a.text().split(".");2==f.length&&f[0]==c&&f[1]==d&&a.text(c+"."+b)});this.saveData("devices");this.saveData("macros")};this.moveDevice=function(a,b){for(var d=a.attr("id"),c=a.parent().attr("id"),e=d,f=2;10>f&&(!(l=this.$devicesXML.find("locations location[id='"+b+"'] device[id='"+e+"']"))||0!=l.length);f++)e=d+" "+f;a.attr("id",e);this.$devicesXML.find("locations location[id='"+
b+"']").each(function(){a.appendTo($(this))});this.$macrosXML.find("locations location macro command").each(function(){var a=$(this),f=a.attr("action");f&&(f=f.split("."),3==f.length&&f[0]==c&&f[1]==d&&a.attr("action",b+"."+e+"."+f[2]))});this.$devicesXML.find("groups device ref").each(function(){var a=$(this),f=a.text().split(".");2==f.length&&f[0]==c&&f[1]==d&&a.text(b+"."+e)});this.saveData("devices");this.saveData("macros")};this.deleteDevice=function(a){var b=a.attr("id"),d=a.parent().attr("id");
if(a&&"IN"==a.attr("type")){var c=this.getGateway(a.attr("gateway"));if(c){var e="65";"fan"==a.attr("data")&&(e="66");c=new (require("xnm.aio.gateway.js").Gateway)(c.attr("ip"));c.executeRequest("inLogout",{adr:a.attr("native")+a.attr("address")+e})}}else if(a&&"SIAU"==a.attr("type")){if(c=this.getGateway(a.attr("gateway")))c=new (require("xnm.aio.gateway.js").Gateway)(c.attr("ip")),e="SIAU","smoke"==a.attr("data")?e="SIAUR":"glass"==a.attr("data")&&(e="SIAUG"),c.executeRequest("Del"+e,{adr:a.attr("address")})}else if(!a||
"HM"!=a.attr("type")&&"PE"!=a.attr("type")&&"R2"!=a.attr("type")&&"HE"!=a.attr("type")&&"IT"!=a.attr("type")&&"RC"!=a.attr("type")&&"KOPP"!=a.attr("type")&&"IW"!=a.attr("type"))a&&"FHT80B"==a.attr("type")&&(e=a.attr("address").split("."),2==e.length&&(c=this.getGateway(a.attr("gateway"))))&&(c=new (require("xnm.aio.gateway.js").Gateway)(c.attr("ip")),c.executeRequest("DelFHT80b",{hc1:e[0],hc2:e[1]}));else if(c=this.getGateway(a.attr("gateway")))e=a.attr("address"),"R2"==a.attr("type")?e=e.substr(0,
4):"IT"==a.attr("type")?e=e.replace(/\./g,""):"KOPP"==a.attr("type")&&(e=e.substr(0,4)),c=new (require("xnm.aio.gateway.js").Gateway)(c.attr("ip")),c.executeRequest("delSensor",{type:a.attr("type"),adr:e});this.$macrosXML.find("locations location macro command").each(function(){var a=$(this),c=a.attr("action");c&&(c=c.split("."),3==c.length&&c[0]==d&&c[1]==b&&a.remove())});this.$devicesXML.find("groups device ref").each(function(){var a=$(this),c=a.text().split(".");2==c.length&&c[0]==d&&c[1]==b&&
a.remove()});a.remove();this.saveData("devices");this.saveData("macros")};this._parseDevicesXML=function(a){this.$devicesXML=$(a);this._loadXMLFile("ircodes.xml",this._parseIRCodesXML);this._gateways={};this._cams={};this._locations={};var b=this;this.$devicesXML.find("devices gateways gateway").each(function(){var a={},c=$(this);b._parseDeviceData(c,a);c.attr2("id")&&(b._gateways[c.attr2("id")]=a)});this.$devicesXML.find("devices cams cam").each(function(){var a={},c=$(this);b._parseDeviceData(c,
a);c.attr2("id")&&(b._cams[c.attr2("id")]=a)});this.$devicesXML.find("devices locations location").each(function(){var a={},c=$(this);b._parseLocationData(c,a);c.attr2("id")&&(b._locations[c.attr2("id")]=a)})};this._parseIRCodesXML=function(a){this.$ircodesXML=$(a);this._loadXMLFile("macros.xml",this._parseMacrosXML);this._ircodes={};this._programs={};var b=this;this.$ircodesXML.find("ircodes device").each(function(){var a=$(this),c={};a.find("key").each(function(){var a=$(this);a.attr2("id")&&a.attr2("code")&&
(c[a.attr2("id")]=a.attr2("code"))});a.attr2("id")&&(b._ircodes[a.attr2("id")]=c)})};this._parseMacrosXML=function(a){this.$macrosXML=$(a);this._loadedCallback&&this._loadedCallback()};this._parseDeviceData=function(a,b){b.type=a.attr2("type");b.address=a.attr2("address");b.version=a.attr2("version");b.data=a.attr2("data");b.gateway=a.attr2("gateway");b.ip=a.attr2("ip");b.port=a.attr2("port");b.user=a.attr2("user");b.pwd=a.attr2("pwd");b.udn=a.attr2("udn");b.mac=a.attr2("mac")};this._parseLocationData=
function(a,b){b.devices={};var d=this;a.find("device").each(function(){var a={},e=$(this);d._parseDeviceData(e,a);e.attr2("id")&&(b.devices[e.attr2("id")]=a)})};this.getLocations=function(){return this._locations};this.getDevice=function(a,b){return this._locations[a]?this._locations[a].devices[b]:null};this.getCam=function(a){return this._cams[a]};this.getGatewayObj=function(a){return this._gateways[a]};this.getIRCode=function(a,b){return this._ircodes[a]?this._ircodes[a][b]:null};this.getMacro=
function(a,b){return this._macros[a]?this._macros[a][b]:null}};
xnm.aio.systemdata.DeviceInfo=function(){this._loadedCallback=this.$XML=null;this.initFromXML=function(a,b){this._loadedCallback=b;var d=this;$.ajax({type:"GET",url:a,dataType:"xml",context:this,isLocal:!0,success:this._initWithXML,error:function(b,e,f){XC.debugf("Exception: "+f);require("fs").readFile(a,"utf8",function(a,b){!a&&b&&d._initWithXML($.parseXML(b))})}})};this._initWithXML=function(a){this.$XML=$(a);this._loadedCallback&&this._loadedCallback()};this._parseDeviceData=function(a,b){};this.getDevice=
function(a){};this.getCam=function(a,b,d){var c=null,e=!1;"tfcam"==a&&(a="telefunken");var f=this;this.$XML&&this.$XML.find("cam[id='"+a+"']").each(function(){$(this).children().each(function(){var d=$(this);if(null==b||b==d.attr("id")){var g=d.attr("link");g&&g!=a+"."+b?g&&(g=g.split("."),c=f.getCam(g[0],g[1],!0),void 0!=d.attr("pantilt")?e=d.attr("pantilt"):void 0!=c.attr("pantilt")&&(e=c.attr("pantilt"))):(c=d,e=d.attr("pantilt"))}})});return d?c:{$cam:c,pantilt:e}};this.findCams=function(a){var b=
[];this.$XML&&this.$XML.find("cam[id='"+a+"']").each(function(){$(this).children().each(function(){var d=$(this),c={};d.attr("link")?c.link=d.attr("link"):c.link=a+"."+d.attr("id");c.name=d.attr("name");c.id=a+"."+d.attr("id");b.push(c)})});return b}};xnm.aio.systemdata.Handler=function(){};xnm.aio.systemdata.Handler.prototype.SystemData=xnm.aio.systemdata.SystemData;xnm.aio.systemdata.Handler.prototype.DeviceInfo=xnm.aio.systemdata.DeviceInfo;
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.systemdata.Handler);
