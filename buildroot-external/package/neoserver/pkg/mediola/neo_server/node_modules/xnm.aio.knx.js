function _typeof(o){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o;}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o;},_typeof(o);}var dgram=require("dgram"),os=require("os"),EventEmitter=require("x.events.js").EventEmitter,Logger=require("x.logger.js"),xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.knx=xnm.aio.knx||{},xnm.aio.knx.KNXGateway=function(){var e,t=function t(e){var t=e.split(".");return 4294967295&(parseInt(t[0])<<24)+(parseInt(t[1])<<16)+(parseInt(t[2])<<8)+parseInt(t[3]);},n=function n(e){return(e>>24&255)+"."+(e>>16&255)+"."+(e>>8&255)+"."+(255&e);},r=((e=function e(_e){this._loggger=require("x.logger.js").getLogger("xnm.aio.knx.KNXGateway.RawStateBuffer"),this._stateBuffer={},this._stateReqTime={},this._knx=_e;}).prototype.setState=function(e,t){void 0!==e&&null!=e&&(this._stateBuffer[e]||(this._stateBuffer[e]={}),this._stateBuffer[e].value=t,this._stateBuffer[e].timestamp=new Date());},e.prototype.getState=function(e){if(void 0!==e&&null!=e){var t=this._stateBuffer[e];return t?t.value:null;}return null;},e.prototype.setStateReqTime=function(e,t){this._stateReqTime[e]=t;},e.prototype.getStateReqTime=function(e){return this._stateReqTime[e];},e),a=function a(e,t,n){this._logger=Logger.getLogger("xnm.aio.knx.KNXGateway ("+e+")"),this.ip=e,this.localIp=t,this.uuid=n,this._stateBuffer=new r(),this._stateMachine={state:a._FSM.IDLE},this._eventEmitter=new EventEmitter(),this._dataLink=null,this._dataLinkRetryCount=0,this._dataLinkTimer=null;};a.STATES_REQ_EXPIRED=18e4,a.MAX_DL_RETRY_COUNT=3,a._FSM={IDLE:1,MONITORING:2,START_MONITOR:3,STOP_MONITOR:4},a._ipv4ToLong=t,a._longToIpv4=n,a._adr2long=function(e){var t=e.split("/"),n=0;switch(t.length){case 3:n+=parseInt(t[0])<<11,n+=parseInt(t[1])<<8,n+=parseInt(t[2]);break;case 2:n+=parseInt(t[0])<<11,n+=parseInt(t[1]);break;case 1:n+=parseInt(t[0]);}return n;},a.prototype={getStateBuffer:function getStateBuffer(){return this._stateBuffer;},on:function on(e,t){this._eventEmitter.on(e,t);},removeAllListeners:function removeAllListeners(){this._eventEmitter.removeAllListeners();},removeListener:function removeListener(e,t){this._eventEmitter.removeListener(e,t);},startMonitor:function startMonitor(e){e&&this.on("open",e),this._fsmStartMonitor();},stopMonitor:function stopMonitor(e){e&&this.on("close",e),this._fsmStopMonitor();},_fsmStartMonitor:function _fsmStartMonitor(){switch(this._stateMachine.state){case a._FSM.IDLE:this._stateMachine.state=a._FSM.START_MONITOR,this._startDataLink();break;case a._FSM.START_MONITOR:break;case a._FSM.MONITORING:this._eventEmitter.emit("open");break;case a._FSM.STOP_MONITOR:return void this._logger.log("warn","can not start the monitor again while stopping it");}},_fsmStopMonitor:function _fsmStopMonitor(){switch(this._stateMachine.state){case a._FSM.IDLE:this._onClose();break;case a._FSM.START_MONITOR:case a._FSM.MONITORING:this._stateMachine.state=a._FSM.STOP_MONITOR,this._stopDataLink();break;case a._FSM.STOP_MONITOR:return;}},_fsmDatalinkOpen:function _fsmDatalinkOpen(){this._stateMachine.state===a._FSM.START_MONITOR&&(this._stateMachine.state=a._FSM.MONITORING,this._onOpen(),this._dataLinkRetryCount=0);},_fsmDatalinkClosed:function _fsmDatalinkClosed(e,t){switch(e?this._logger.log("trace","data link stopped due to error"):this._logger.log("trace","data link stopped"),this._stateMachine.state){case a._FSM.START_MONITOR:this._dataLink.removeAllListeners(),this._dataLink=null,++this._dataLinkRetryCount<a.MAX_DL_RETRY_COUNT?(this._logger.log("trace","auto restart monitor tunnel"),this._stateMachine.state=a._FSM.START_MONITOR,this._startDataLink(t)):(this._stateMachine.state=a._FSM.IDLE,t&&t.forEach(function(e){e&&e.callback&&e.callback(new Error("monitor closed due to error"));}),this._onClose(!0));break;case a._FSM.MONITORING:this._dataLink.removeAllListeners(),this._dataLink=null,++this._dataLinkRetryCount<a.MAX_DL_RETRY_COUNT?(this._logger.log("trace","auto restart monitor tunnel"),this._stateMachine.state=a._FSM.START_MONITOR,this._startDataLink(t)):(this._onError(new Error("can not connect monitor tunnel to knx gateway")),this._stateMachine.state=a._FSM.IDLE,t&&t.forEach(function(e){e&&e.callback&&e.callback(new Error("monitor closed due to error"));}),this._onClose(!0));break;case a._FSM.STOP_MONITOR:this._dataLink.removeAllListeners(),this._dataLink=null,this._stateMachine.state=a._FSM.IDLE,t&&t.forEach(function(e){e&&e.callback&&e.callback(new Error("monitor closed due to error"));}),this._onClose(!1);}},_fsmDataLinkMessage:function _fsmDataLinkMessage(e,t){if(this._stateMachine.state===a._FSM.MONITORING)return t.getAPCI(),this._stateBuffer.setState(e,t.getData()),void this._eventEmitter.emit("message",this.uuid,e,t);},_fsmDatalinkError:function _fsmDatalinkError(e){this._stateMachine.state,a._FSM.START_MONITOR,this._onError(e);},_onOpen:function _onOpen(){0==this._dataLinkRetryCount&&this._eventEmitter.emit("open");},_onError:function _onError(e){this._eventEmitter.emit("error",e);},_onClose:function _onClose(e){this._eventEmitter.emit("close",e);},_sendCommand:function _sendCommand(e,t,n){this._dataLink?this._sendCommandWithDL(this._dataLink,e,t,n):n&&n(new Error("knx gateway not connected"));},_getState:function _getState(e,t){this._dataLink?this._getStateWithDL(this._dataLink,e,t):t&&t(new Error("knx gateway not connected"));},_sendCommandWithDL:function _sendCommandWithDL(e,t,n,r){var o=a._adr2long(t),i=new a.APDU(null,2,n),s=this;e.send(o,i,function(e){e||s._stateBuffer.setState(o,i.getData()),r&&"function"==typeof r&&r(e);});},_getStateWithDL:function _getStateWithDL(e,t,n){var r=a._adr2long(t),o=new a.APDU(null,0,new Buffer([0]));e.send(r,o,n);},_startDataLink:function _startDataLink(e){var t=this;this._dataLink=new a._DataLink(this.ip,this.localIp),this._dataLink.on("connect",function(){t._fsmDatalinkOpen();}),this._dataLink.on("close",function(e,n){t._fsmDatalinkClosed(e,n);}),this._dataLink.on("error",function(e){t._logger.log("warn","monitor tunnel error:"+e.message),t._fsmDatalinkError(e);}),this._dataLink.on("message",function(e,n){t._fsmDataLinkMessage(e,n);}),this._dataLink.connect(e);},_stopDataLink:function _stopDataLink(){this._dataLink&&this._dataLink.close();}};var o,_i,s,c=(o=function o(e,t){this._logger=Logger.getLogger("xnm.aio.knx.KNXGateway._DataLink ("+e+")");var n=this;this._tunnel=new u(e,null,t,null),this._tunnel.on("connect",function(){n._onTunnelConnect();}),this._tunnel.on("end",function(){n._onTunnelEnd();}),this._tunnel.on("close",function(e,t){n._onTunnelClose(e,t);}),this._tunnel.on("message",function(e){n._onTunnelMessage(e);}),this._tunnel.on("error",function(e){n._onTunnelError(e);}),this._eventEmitter=new EventEmitter();},o.prototype={on:function on(e,t){this._eventEmitter.on(e,t);},removeAllListeners:function removeAllListeners(){this._eventEmitter.removeAllListeners();},removeListener:function removeListener(e,t){this._eventEmitter.removeListener(e,t);},connect:function connect(e){this._tunnel.connect(e);},close:function close(){this._tunnel.close();},send:function send(e,t,n){this._logger.log("debug","send l_data.req "+t.toBuffer().toString("hex")+"@"+e);var r=new d.L_Data_Req(e,t);this._tunnel.send(r,function(e){n&&n(e);});},_onTunnelConnect:function _onTunnelConnect(){this._eventEmitter.emit("connect");},_onTunnelClose:function _onTunnelClose(e,t){this._eventEmitter.emit("close",e,t);},_onTunnelEnd:function _onTunnelEnd(){this._eventEmitter.emit("end");},_onTunnelMessage:function _onTunnelMessage(e){var t="unknown";e&&e instanceof d.L_Data_Con?t="l_data.con":e&&e instanceof d.L_Data_Ind&&(t="l_data.ind");var n=e.getDstAddr(),r=e.getAPDU();this._logger.log("debug","recive "+t+" "+r.toBuffer().toString("hex")+"@"+n),this._eventEmitter.emit("message",n,r);},_onTunnelError:function _onTunnelError(e){this._eventEmitter.emit("error",e);}},o),u=((_i=function i(e,t,n,r){this._eventEmitter=new EventEmitter(),this._ip=e,this._port=t,(!this._port||this._port<=0)&&(this._port=_i.DEFAULT_REMOTE_PORT),this._logger=require("x.logger.js").getLogger("xnm.aio.knx.KNXGateway._Tunnel ("+this._ip+":"+this._port+")"),this._localIp=n,this._localPort=r,this._localPort<=0&&(this._localPort=null),this._socket=null,this._requestBuffer=[],this._stateMachine={state:_i._STATE.IDLE,stateTimer:null,connectionStateTimer:null,connectionStateAckTimer:null,connection:{id:0,seqNo:0,recvSeqNo:0,hpai:{ip:null,port:0}},close_with_error:null},this._connectStateNackCount=0;}).TUNNEL_ACK_TIMEOUT=1e3,_i.CONNECT_REQUEST_TIMEOUT=1e4,_i.CONNECTIONSTATE_REQUEST_INTERVAL=6e4,_i.CONNECTIONSTATE_REQUEST_TIMEOUT=1e4,_i.MAX_CONNECTIONSTATE_NACK_COUNT=3,_i.DEFAULT_REMOTE_PORT=3671,_i._STATE={IDLE:0,BINDUDP:1,CONNECT:2,TUNNELLING:3,DISCONNECT:4,CLOSEUDP:5},_i.prototype={on:function on(e,t){this._eventEmitter.on(e,t);},removeAllListeners:function removeAllListeners(){this._eventEmitter.removeAllListeners();},connect:function connect(e){e&&(this._requestBuffer=e),this._fsmConnect();},close:function close(){this._fsmClose(!1);},send:function send(e,t){if(e){var n={cEMI:e,callback:t,retry:!1,timer:null,seqNo:-1},r=this._requestBuffer.length;this._requestBuffer.push(n),0==r&&this._stateMachine.state==_i._STATE.TUNNELLING&&this._sendNextReq();}else t&&t(new Error("cEMI is null"));},_sendNextReq:function _sendNextReq(){if(0!=this._requestBuffer.length){var e=this._requestBuffer[0],t=this._stateMachine.connection.seqNo;-1!=e.seqNo?t=e.seqNo:e.seqNo=t;var n=this;this._send(t,e.cEMI,function(t){if(t)return e.callback&&e.callback(t),n._requestBuffer.splice(0,1),void n._sendNextReq();e.timer=setTimeout(function(){e.retry?(n._logger.log("warn","TUNNELLING_ACK ("+e.seqNo+") timeout after "+_i.TUNNEL_ACK_TIMEOUT+" seconds"),n._fsmClose(!0)):(n._logger.log("warn","TUNNELLING_ACK ("+e.seqNo+") timeout after "+_i.TUNNEL_ACK_TIMEOUT+" seconds, retry"),e.retry=!0,n._sendNextReq());},_i.TUNNEL_ACK_TIMEOUT);});}},_send:function _send(e,t,n){var r=this;if(this._stateMachine.state===_i._STATE.TUNNELLING){this._logger.log("debug","send cEMI "+t.toBuffer().toString("hex"));var a=new l.TunnellingRequest(this._stateMachine.connection.id,e,t).toBuffer();this._logger.log("debug","send TUNNELLING_REQUEST ("+e+") "+a.toString("hex")),this._socket.send(a,0,a.length,this._port,this._ip,function(t){t?r._logger.log("debug","send TUNNELLING_REQUEST ("+e+") "+a.toString("hex")+" error:"+t.message):r._logger.log("debug","send TUNNELLING_REQUEST ("+e+") "+a.toString("hex")+" finish"),n&&n(null);});}else n&&n(new Error("Tunnel is not connected"));},_fsmConnect:function _fsmConnect(){this._logger.log("debug","connect to knx"),this._stateMachine.state===_i._STATE.IDLE&&(this._stateMachine.state=_i._STATE.BINDUDP,this._startListenerSocket());},_fsmClose:function _fsmClose(e){switch(this._stateMachine.close_with_error=e,this._stateMachine.state){case _i._STATE.IDLE:this._fsmClosed();break;case _i._STATE.BINDUDP:this._stateMachine.state=_i._STATE.CLOSEUDP,this._stopListenerSocket();break;case _i._STATE.CONNECT:this._clearStateMachineGuard(),this._stateMachine.state=_i._STATE.CLOSEUDP,this._stopListenerSocket();break;case _i._STATE.TUNNELLING:var t=new l.DisconnectRequest(this._stateMachine.connection.id,this._stateMachine.connection.hpai).toBuffer();this._logger.log("debug","send DISCONNECT_REQUEST "+t.toString("hex")),this._socket.send(t,0,t.length,this._port,this._ip),this._stateMachine.state=_i._STATE.DISCONNECT,this._clearStateMachineGuard(),this._setStateMachineGuard(1e3,_i._STATE.CLOSEUDP);case _i._STATE.DISCONNECT:case _i._STATE.CLOSEUDP:}},_fsmError:function _fsmError(e){this._eventEmitter.emit("error",e),this._fsmClose(!0);},_fsmUdpListening:function _fsmUdpListening(){if(this._logger.log("debug","udp socket established"),this._stateMachine.state===_i._STATE.BINDUDP){this._stateMachine.state=_i._STATE.CONNECT,this._clearStateMachineGuard();var e=this._socket.address(),t={ip:e.address,port:e.port},n=new l.ConnectionRequest(t,t).toBuffer();this._logger.log("debug","send CONNECTION_REQUEST "+n.toString("hex")),this._socket.send(n,0,n.length,this._port,this._ip),this._setStateMachineGuard(_i.CONNECT_REQUEST_TIMEOUT,_i._STATE.TUNNELLING);}},_fsmUdpMessage:function _fsmUdpMessage(e){var t,n,r,a,o=this,s=this._socket.address(),c=l.parseFrame(e);if(c)switch(this._stateMachine.state){case _i._STATE.CONNECT:if(518===c.getType())if(c.isConnectionStatusOK())this._clearStateMachineGuard(),t=c.getConnectionID(),this._logger.log("debug","receive CONNECTION_RESPONSE with connection id "+t),this._stateMachine.connection={},this._stateMachine.connection.id=t,n={ip:s.address,port:s.port},this._stateMachine.connection.hpai=n,this._stateMachine.connection.seqNo=0,this._stateMachine.connection.recvSeqNo=0,this._stateMachine.state=_i._STATE.TUNNELLING,this._sendConnectionStateRequest(),this._sendNextReq(),this._onConnected();else{var u=c.getConnectionStatus(),f=new Error("tunnel connection fail with error:"+u.toString(16));f.code=u,this._fsmError(f);}break;case _i._STATE.TUNNELLING:switch(c.getType()){case 1056:if((t=c.getConnectionID())===this._stateMachine.connection.id){var h=c.getcEMI(),_=c.getSeqNo(),p=!1;_==this._stateMachine.connection.recvSeqNo&&(p=!0),_!=this._stateMachine.connection.recvSeqNo&&_!=this._stateMachine.connection.recvSeqNo-1||(r=(c=new l.TunnellingACK(t,_)).toBuffer(),this._logger.log("trace","send TUNNELLING_ACK ("+_+") "+r.toString("hex")),this._socket.send(r,0,r.length,this._port,this._ip,function(e){try{p&&(h&&h instanceof d.L_Data_Con?(o._logger.log("debug","receive TUNNELLING_REQUEST ("+_+") l_data.con "+h.toBuffer().toString("hex")),o._onMessage(h)):h&&h instanceof d.L_Data_Ind&&(o._logger.log("debug","receive TUNNELLING_REQUEST ("+_+") l_data.ind "+h.toBuffer().toString("hex")),o._onMessage(h)));}catch(e){}})),_!=this._stateMachine.connection.recvSeqNo&&_!=this._stateMachine.connection.recvSeqNo-1||_==this._stateMachine.connection.recvSeqNo&&(this._stateMachine.connection.recvSeqNo++,this._stateMachine.connection.recvSeqNo>255&&(this._stateMachine.connection.recvSeqNo=0));}break;case 1057:(t=c.getConnectionID())===this._stateMachine.connection.id&&this._onTunnelAck(c);break;case 521:t=c.getConnectionID(),n=c.getCtrlEndpointHPAI(),t===this._stateMachine.connection.id&&(this._logger.log("debug","receive DISCONNECT_REQUEST"),r=(c=new l.DisconnectResponse(t)).toBuffer(),this._logger.log("debug","send DISCONNECT_RESPONSE "+r.toString("hex")),this._socket.send(r,0,r.length,this._port,this._ip,function(){o._fsmEnd();}));break;case 520:t=c.getConnectionID(),this._logger.log("debug","receive CONNECTIONSTATE_RESPONSE with connection id "+t),this._connectStateNackCount=0,this._stateMachine.connectionStateAckTimer&&(clearTimeout(this._stateMachine.connectionStateAckTimer),this._stateMachine.connectionStateAckTimer=null,this._stateMachine.connectionStateTimer||(this._stateMachine.connectionStateTimer=setTimeout(function(){o._stateMachine.connectionStateTimer=null,o._sendConnectionStateRequest();},_i.CONNECTIONSTATE_REQUEST_INTERVAL)));}break;case _i._STATE.DISCONNECT:522===c.getType()&&(t=c.getConnectionID())===this._stateMachine.connection.id&&(a=c.isDisconnectOK(),this._logger.log("debug","receive DISCONNECT_RESPONSE with status "+(a?"OK":"NOK")),this._clearStateMachineGuard(),this._stateMachine.state=_i._STATE.CLOSEUDP,o._stopListenerSocket());}},_fsmEnd:function _fsmEnd(){this._stateMachine.state=_i._STATE.CLOSEUDP,this._eventEmitter.emit("end"),this._stateMachine.close_with_error=!1,this._stopListenerSocket();},_fsmClosed:function _fsmClosed(){this._stateMachine.state=_i._STATE.IDLE;var e=this._stateMachine.close_with_error;this._socket&&this._socket.removeAllListeners(),this._socket=null;var t=null;if(e){t=this._requestBuffer;for(var n=0;n<t.length;n++){var r=t[n];r&&(r.timer&&clearTimeout(r.timer),r.seqNo=-1);}this._requestBuffer=[];}else this._clearRequestBuffer();this._resetStateMachine(),this._eventEmitter.emit("close",e,t);},_onConnected:function _onConnected(){this._eventEmitter.emit("connect");},_onMessage:function _onMessage(e){this._eventEmitter.emit("message",e);},_onTunnelAck:function _onTunnelAck(e){var t=e.getSeqNo(),n=e.isOK();if(this._logger.log("debug","receive TUNNELLING_ACK ("+t+") with status "+(n?"OK":"NOK")),t==this._stateMachine.connection.seqNo){var r=this._requestBuffer[0];r.timer&&clearTimeout(r.timer),r.callback&&r.callback(n?null:new Error("NACK")),this._stateMachine.connection.seqNo+=1,this._stateMachine.connection.seqNo>255&&(this._stateMachine.connection.seqNo=0),this._requestBuffer.splice(0,1),this._sendNextReq();}},_clearRequestBuffer:function _clearRequestBuffer(){for(var e=0;e<this._requestBuffer.length;e++){var t=this._requestBuffer[e];t&&(t.timer&&clearTimeout(t.timer),t.callback&&t.callback(new Error("NACK due to tunnel closed")));}this._requestBuffer=[];},_setStateMachineGuard:function _setStateMachineGuard(e,t){var n=this;this._stateMachine.stateTimer=setTimeout(function(){var e=n._stateMachine.state;if(e===_i._STATE.DISCONNECT&&t===_i._STATE.CLOSEUDP)n._stateMachine.state=_i._STATE.CLOSEUDP,n._stopListenerSocket();else if(e!==t){var r;r=3==t?"receive CONNECTION_RESPONSE timeout":"knx tunnel receive data timeout in "+e,n._logger.log("warn",r),n._fsmError(new Error(r));}},e);},_clearStateMachineGuard:function _clearStateMachineGuard(){this._stateMachine.stateTimer&&clearTimeout(this._stateMachine.stateTimer);},_sendConnectionStateRequest:function _sendConnectionStateRequest(){var e=this,t=new l.ConnectionStateRequest(this._stateMachine.connection.id,this._stateMachine.connection.hpai).toBuffer();this._logger.log("debug","send CONNECTIONSTATE_REQUEST "+t.toString("hex")+" with connection id "+this._stateMachine.connection.id),this._socket.send(t,0,t.length,this._port,this._ip),this._stateMachine.connectionStateAckTimer&&(clearTimeout(this._stateMachine.connectionStateAckTimer),this._stateMachine.connectionStateAckTimer=null),this._stateMachine.connectionStateAckTimer=setTimeout(function(){e._connectStateNackCount++,e._connectStateNackCount<_i.MAX_CONNECTIONSTATE_NACK_COUNT&&e._stateMachine.state===_i._STATE.TUNNELLING?(e._logger.log("warn","receive CONNECTIONSTATE_RESPONSE timeout"),e._sendConnectionStateRequest()):(e._logger.log("warn","tunnel break due to CONNECTIONSTATE_RESPONSE timeout"),e._fsmError(new Error("tunnel break")));},_i.CONNECTIONSTATE_REQUEST_TIMEOUT);},_resetStateMachine:function _resetStateMachine(){this._stateMachine.stateTimer&&clearTimeout(this._stateMachine.stateTimer),this._stateMachine.connectionStateTimer&&clearTimeout(this._stateMachine.connectionStateTimer),this._stateMachine.connectionStateAckTimer&&clearTimeout(this._stateMachine.connectionStateAckTimer),this._stateMachine={state:_i._STATE.IDLE,stateTimer:null,connectionStateTimer:null,connectionStateAckTimer:null,socket:null,connection:{id:0,seqNo:0,hpai:{ip:null,port:0}},close_with_error:null};},_startListenerSocket:function _startListenerSocket(){this._logger.log("trace","{UDP Socket} start knx upd listener on "+this._localIp);var e=this;this._socket=dgram.createSocket("udp4"),this._socket.on("listening",function(){try{e._socket.addMembership("224.0.23.12");var t=e._socket.address();e._logger.log("trace","{UDP Socket} knx listening "+t.address+":"+t.port),e._fsmUdpListening();}catch(t){e._logger.log("trace","{UDP Socket} knx listening bind multicast failed:"+t.message),e._socket.close(),e._fsmClosed();}}),this._socket.on("close",function(){e._logger.log("trace","{UDP Socket} control socket closed"),e._fsmClosed();}),this._socket.on("error",function(t){e._logger.log("trace","{UDP Socket} control socket error: "+t.stack),e._fsmError(t);}),this._socket.on("message",function(t,n){var r=e._socket.address();e._logger.log("trace","{UDP Socket} receive data "+t.toString("hex")+" from "+n.address+":"+n.port+" @local "+r.address+":"+r.port),e._fsmUdpMessage(t);}),this._socket.bind(null,this._localIp);},_stopListenerSocket:function _stopListenerSocket(){this._logger.log("trace","{UDP Socket} stop knx upd listener"),this._socket.close();}},_i),l=function(){var e=function e(_e2,t){_e2&&t&&(this._logger=Logger.getLogger("xnm.aio.KNXGateway.IPFrame"),this._buffer=new Buffer(6+t.length),this._buffer.writeUInt16BE(1552,0),this._buffer.writeUInt16BE(_e2,2),this._buffer.writeUInt16BE(6+t.length,4),t.copy(this._buffer,6));};e._logger=Logger.getLogger("xnm.aio.KNXGateway.IPFrame"),e.parseFrame=function(t){var n=null;if(t.length<6)return e._logger.log("debug","data is too short"),null;var r=t.readUInt16BE(0);if(1552!==r)return e._logger.log("debug","data header&version is invalid:"+r),null;var o=t.readUInt16BE(4);if(o>t.length)return e._logger.log("debug","data length in header is larger than actual size:"+o),null;var s=t.readUInt16BE(2);switch(s){case 514:o>=14&&(n=new a());break;case 518:o>=8&&(n=new i());break;case 520:o>=8&&(n=new c());break;case 1057:o>=10&&(n=new l());break;case 1056:o>=6&&(n=new u());break;case 521:o>=16&&(n=new f());break;case 522:o>=8&&(n=new h());break;default:e._logger.log("debug","data type is unknow:"+s);}return n&&(n._buffer=t),n;},e.prototype.getType=function(){return this._buffer.readUInt16BE(2);},e.prototype.getSize=function(){return this._buffer.readUInt16BE(4);},e.prototype.toBuffer=function(){return this._buffer;};var r=function r(n){var r=new Buffer(8);r.writeUInt16BE(2049,0),r.writeInt32BE(t(n.ip),2),r.writeUInt16BE(n.port,6),e.call(this,513,r);};(r.prototype=new e()).constructor=r;var a=function a(){e.call(this);};a.prototype=new e(),a.prototype.constructor=a,a.prototype.getCtrlEndpointHPAI=function(){var e=this._buffer.readUInt32BE(8),t=n(e),r=this._buffer.readUInt16BE(12),a={};return a.ip=t,a.port=r,a;},a.prototype.getSerialNumber=function(){return(this._buffer.readUInt8(22)<<16)+(this._buffer.readUInt8(23)<<8)+this._buffer.readUInt8(24)+""+((this._buffer.readUInt8(25)<<16)+(this._buffer.readUInt8(26)<<8)+this._buffer.readUInt8(27));},a.prototype.getRoutingMulticastAddress=function(){return this._buffer.readUInt8(28)+"."+this._buffer.readUInt8(29)+"."+this._buffer.readUInt8(30)+"."+this._buffer.readUInt8(31);},a.prototype.getMAC=function(){return this._buffer.toString("hex",32,38);},a.prototype.getName=function(){return this._buffer.toString("utf8",38,68);},a.prototype.toJSON=function(){return{hapi:this.getCtrlEndpointHPAI(),structure_length:this._buffer.readUInt8(14),desciprtion_type_code:this._buffer.readUInt8(15),knx_medium:this._buffer.readUInt8(16),device_status:this._buffer.readUInt8(17),physical_address:this._buffer.readUInt16BE(18),project_installation_id:this._buffer.readUInt16BE(20),serial_number:this.getSerialNumber(),routing_multicast_address:this.getRoutingMulticastAddress(),mac:this.getMAC(),name:this.getName()};};var o=function o(n,r){var a=new Buffer(20);a.writeUInt16BE(2049,0),a.writeInt32BE(t(n.ip),2),a.writeUInt16BE(n.port,6),a.writeUInt16BE(2049,8),a.writeInt32BE(t(r.ip),10),a.writeUInt16BE(r.port,14),a.writeUInt8(4,16),a.writeUInt8(4,17),a.writeUInt8(2,18),a.writeUInt8(0,19),e.call(this,517,a);};(o.prototype=new e()).constructor=o;var i=function i(){e.call(this);};i.prototype=new e(),i.prototype.constructor=i,i.prototype.getConnectionID=function(){return this._buffer.readUInt8(6);},i.prototype.isConnectionStatusOK=function(){return 0===this._buffer.readUInt8(7);},i.prototype.getCtrlEndpointHPAI=function(){var e=this._buffer.readUInt32BE(10),t=n(e),r=this._buffer.readUInt16BE(14),a={};return a.ip=t,a.port=r,a;},i.prototype.getCRD=function(){return this._buffer.readUInt32BE(16);},i.prototype.getConnectionStatus=function(){return this._buffer.readUInt8(7);};var s=function s(n,r){var a=new Buffer(10);a.writeUInt8(n,0),a.writeUInt8(0,1),a.writeUInt16BE(2049,2),a.writeInt32BE(t(r.ip),4),a.writeUInt16BE(r.port,8),e.call(this,519,a);};(s.prototype=new e()).constructor=s;var c=function c(){e.call(this);};c.prototype=new e(),c.prototype.constructor=c,c.prototype.getConnectionID=function(){return this._buffer.readUInt8(6);},c.prototype.isConnectionStatusOK=function(){return 0===this._buffer.readUInt8(7);};var u=function u(t,n,r){if(null!=t&&null!=n&&r){var a=new Buffer(4+r.getLength());a.writeUInt8(4,0),a.writeUInt8(t,1),a.writeUInt8(n,2),a.writeUInt8(0,3),r.toBuffer().copy(a,4),e.call(this,1056,a);}else e.call(this);};u.prototype=new e(),u.prototype.constructor=u,u.prototype.getConnectionID=function(){return this._buffer.readUInt8(7);},u.prototype.getSeqNo=function(){return this._buffer.readUInt8(8);},u.prototype.getcEMI=function(){var e=this._buffer.readUInt16BE(4),t=new Buffer(e-6-4);return this._buffer.copy(t,0,10),d.parseFrame(t);};var l=function l(t,n){if(t){var r=new Buffer(4);r.writeUInt8(4,0),r.writeUInt8(t,1),r.writeUInt8(n,2),r.writeUInt8(0,3),e.call(this,1057,r);}else e.call(this);};l.prototype=new e(),l.prototype.constructor=l,l.prototype.getConnectionID=function(){return this._buffer.readUInt8(7);},l.prototype.getSeqNo=function(){return this._buffer.readUInt8(8);},l.prototype.isOK=function(){return 0===this._buffer.readUInt8(9);};var f=function f(n,r){if(n&&null!==r){var a=new Buffer(10);a.writeUInt8(n,0),a.writeUInt8(0,1),a.writeUInt8(8,2),a.writeUInt8(1,3),a.writeInt32BE(t(r.ip),4),a.writeUInt16BE(r.port,8),e.call(this,521,a);}else e.call(this);};f.prototype=new e(),f.prototype.constructor=f,f.prototype.getConnectionID=function(){return this._buffer.readUInt8(6);},f.prototype.getCtrlEndpointHPAI=function(){var e=this._buffer.readUInt32BE(10),t=n(e),r=this._buffer.readUInt16BE(14),a={};return a.ip=t,a.port=r,a;};var h=function h(t){if(t){var n=new Buffer(2);n.writeUInt8(t,0),n.writeUInt8(0,1),e.call(this,1057,n);}else e.call(this);};return h.prototype=new e(),h.prototype.constructor=h,h.prototype.getConnectionID=function(){return this._buffer.readUInt8(6);},h.prototype.isDisconnectOK=function(){return 0===this._buffer.readUInt8(7);},e.SearchRequest=r,e.SearchResponse=a,e.ConnectionRequest=o,e.ConnectionResponse=i,e.ConnectionStateRequest=s,e.ConnectionStateResponse=c,e.TunnellingRequest=u,e.TunnellingACK=l,e.DisconnectRequest=f,e.DisconnectResponse=h,e;}(),d=function(){var e=function e(_e3){this._buffer=_e3;};e.parseFrame=function(e){var t=null;switch(e.readUInt8(0)){case n.MSG_CODE:t=new n();break;case r.MSG_CODE:t=new r();}return t&&(t._buffer=e),t;},e.prototype={getLength:function getLength(){return this._buffer.length;},getSrcAddr:function getSrcAddr(){return this._buffer.readUInt16BE(4);},getDstAddr:function getDstAddr(){return this._buffer.readUInt16BE(6);},getDataLength:function getDataLength(){return this._buffer.readUInt8(8);},getAPDU:function getAPDU(){var e=this.getDataLength()+1,t=new Buffer(e);return this._buffer.copy(t,0,9,9+t.length),f.parse(t);},toBuffer:function toBuffer(){return this._buffer;}};var t=function t(_t,n){var r=new Buffer(9+n.getLength());r.writeUInt8(17,0),r.writeUInt8(0,1),r.writeUInt8(188,2),r.writeUInt8(224,3),r.writeUInt8(0,4),r.writeUInt8(0,5),r.writeUInt8(_t>>8&255,6),r.writeUInt8(255&_t,7),r.writeUInt8(n.getLength()-1,8),n.toBuffer().copy(r,9),e.call(this,r);};t.MSG_CODE=17,(t.prototype=new e()).constructor=t;var n=function n(){e.call(this);};n.MSG_CODE=46,n.prototype=new e(),n.prototype.constructor=n;var r=function r(){e.call(this);};return r.MSG_CODE=41,r.prototype=new e(),r.prototype.constructor=r,e.L_Data_Req=t,e.L_Data_Con=n,e.L_Data_Ind=r,e;}(),f=(s=function s(e,t,n){t||(t=0),e||(e=0);var r=1;n&&n.length>1&&(r=n.length),this._buffer=new Buffer(1+r),e|=t>>2,this._buffer.writeUInt8(e,0),t=t<<6|(n&&n.length>0?n.readUInt8(0):0),this._buffer.writeUInt8(t,1),n&&n.length>1&&n.copy(this._buffer,2,1);},s.parse=function(e){var t=new s();return t._buffer=e,t;},s.prototype={getLength:function getLength(){return this._buffer.length;},getAPCI:function getAPCI(){return(3&this._buffer.readUInt8(0))<<2|(192&this._buffer.readUInt8(1))>>6&3;},getData:function getData(){var e=this._buffer.length-1,t=this._buffer.readUInt8(1),n=new Buffer(e);return n.writeUInt8(63&t,0),e>1&&this._buffer.copy(n,1,2),n;},toBuffer:function toBuffer(){return this._buffer;}},s);return a._DataLink=c,a._Tunnel=u,a.IPFrame=l,a.cEMI=d,a.APDU=f,a;}(),xnm.aio.knx.KNXGateway._DPT=function(){var e=function e(_e4){this.type=_e4;};e.resolve=function(e){if(!e)return null;if(e.length<=3)return null;var u=e.indexOf("-");if(u<=0)return null;var l=e.substring(0,u);if("DPT"==l){if(e.length<5)return null;l=e;}else{if("DPST"!=l)return null;if((u=e.indexOf("-",u+1))<0)return null;l=e.substring(0,u);}switch(l){case"DPT-1":case"DPST-1":return new t(e);case"DPT-2":case"DPST-2":return new n(e);case"DPT-3":case"DPST-3":return new r(e);case"DPT-5":case"DPST-5":return new a(e);case"DPT-6":case"DPST-6":return new o(e);case"DPT-9":case"DPST-9":return new i(e);case"DPT-14":case"DPST-14":return new s(e);case"DPT-20":case"DPST-20":return new c(e);}return null;},e.prototype.doCommand=function(e,t,n,r){r&&r();},e.prototype.setValue=function(e,t,n,r){e&&e instanceof Buffer?t._sendCommand(n,e,function(e){r&&r(e);}.bind(this)):r&&r(new Error("invalid value"));},e.prototype.getValue=function(e,t,n){e._getState(t,function(e,t){e?n&&n(e):n&&n(null,this._resolveData(t));}.bind(this));},e.prototype._resolveDataRaw=function(e){return e.toString("hex");},e.prototype._resolveData=function(e){return e.toString("hex");};var t=function t(_t2){e.call(this,_t2);};t.prototype=new e(),t.prototype.constructor=t,t.prototype.doCommand=function(e,t,n,r){if(e){var a=0;if(0==e.indexOf("setValue"))return(a=parseInt(e.substr(8)))&&!isNaN(a)||(a=0),void this.setValue(a,t,n,r);switch(e){case"on":case"true":case"enable":case"ramp":case"alarm":case"high":case"increase":case"down":case"close":case"start":case"active":case"inverted":a=1;break;case"off":case"false":case"disable":case"no_ramp":case"no_alarm":case"low":case"decrease":case"up":case"open":case"stop":case"inactive":case"not_inverted":a=0;break;default:return void(r&&r(new Error("unknown command:"+e)));}this.setValue(a,t,n,r);}else r&&r(new Error("unknown command:"+e));},t.prototype.setValue=function(t,n,r,a){var o;o=0==t||1==t?new Buffer([t]):t,e.prototype.setValue.call(this,o,n,r,function(e){a&&a(e);}.bind(this));},t.prototype._resolveDataRaw=function(e){return e.readUInt8(0);},t.prototype._resolveData=function(e){var t=e.readUInt8(0);return this._resolveValue(t);},t.prototype._resolveValue=function(e){switch(this.type){case"DPT-1":case"DPST-1-1":return e?"on":"off";case"DPST-1-2":return e?"true":"false";case"DPST-1-3":return e?"enable":"disable";case"DPST-1-4":return e?"ramp":"no_ramp";case"DPST-1-5":return e?"alarm":"no alarm";case"DPST-1-6":return e?"high":"low";case"DPST-1-7":return e?"increase":"decrease";case"DPST-1-8":return e?"down":"up";case"DPST-1-9":return e?"close":"open";case"DPST-1-10":return e?"start":"stop";case"DPST-1-11":return e?"active":"inactive";case"DPST-1-12":return e?"inverted":"not_inverted";case"DPST-1-13":return e?"cyclically":"start/stop";case"DPST-1-14":return e?"calculated":"fixed";case"DPST-1-15":return e?"reset command":"no action";case"DPST-1-16":return e?"acknowledge command":"no action";case"DPST-1-18":return e?"occupied":"not occupied";case"DPST-1-19":return e?"open":"closed";case"DPST-1-21":return e?"logical function AND":"logical function OR";case"DPST-1-22":return e?"scene B":"scene A";case"DPST-1-23":return e?"move Up/Down +StepStop mode (blind)":"only move Up/Down mode (shutter)";default:return null;}};var n=function n(t){e.call(this,t);};n.prototype=new e(),n.prototype.constructor=n,n.prototype.doCommand=function(e,t,n,r){if(e){var a=0;if(0==e.indexOf("setValue"))return i=e.substr(0,8),(a=parseInt(e.substr(8)))&&!isNaN(a)||(a=0),void this.setValue(a,t,n,r);var o=e.split(".");if(o.length<2)r&&r(new Error("unknown command:"+e));else{a="prio"==o[0]?1:0;var i=o[1];switch(i){case"on":case"true":case"enable":case"ramp":case"alarm":case"high":case"increase":case"down":case"close":case"start":case"active":case"inverted":a=a<<1|1;break;case"off":case"false":case"disable":case"no_ramp":case"no_alarm":case"low":case"decrease":case"up":case"open":case"stop":case"inactive":case"not_inverted":a=a<<1|0;break;default:return void(r&&r(new Error("unknown command:"+e)));}this.setValue(a,t,n,r);}}else r&&r(new Error("unknown command:"+e));},n.prototype.setValue=function(t,n,r,a){var o;o=0==t||1==t||2==t||3==t?new Buffer([t]):t,e.prototype.setValue.call(this,o,n,r,function(e){a&&a(e);}.bind(this));},n.prototype._resolveDataRaw=function(e){return e.readUInt8(0);},n.prototype._resolveData=function(e){var t=e.readUInt8(0);return this._resolveValue(t);},n.prototype._resolveValue=function(e){var t="";switch(t=e>>1==1?"prio.":"no_prio.",this.type){case"DPT-2":t=e;break;case"DPST-2-1":t+=1&e?"on":"off";break;case"DPST-2-2":t+=1&e?"true":"false";break;case"DPST-2-3":t+=1&e?"enable":"disable";break;case"DPST-2-4":t+=1&e?"ramp":"no_ramp";break;case"DPST-2-5":t+=1&e?"alarm":"no alarm";break;case"DPST-2-6":t+=1&e?"high":"low";break;case"DPST-2-7":t+=1&e?"increase":"decrease";break;case"DPST-2-8":t+=1&e?"down":"up";break;case"DPST-2-9":t+=1&e?"close":"open";break;case"DPST-2-10":t+=1&e?"start":"stop";break;case"DPST-2-11":t+=1&e?"active":"inactive";break;case"DPST-2-12":t+=1&e?"inverted":"not_inverted";break;default:return null;}return t;};var r=function r(t){e.call(this,t);};r.prototype=new e(),r.prototype.constructor=r,r.prototype.doCommand=function(e,t,n,r){if(e){var a=null,o=0;if(0==e.indexOf("setValue"))return a=e.substr(0,8),(o=parseInt(e.substr(8)))&&!isNaN(o)||(o=0),void this.setValue(o,t,n,r);"stepUpStop"==e||"stepDownStop"==e?(a=e,o=0):0==e.indexOf("stepUp")?(a=e.substr(0,6),(o=parseInt(e.substr(6)))&&!isNaN(o)||(o=1)):0==e.indexOf("stepDown")&&(a=e.substr(0,8),(o=parseInt(e.substr(8)))&&!isNaN(o)||(o=1));var i=0,s=this._getStepcode(o);if(-1!=s){switch(a){case"stepUp":if(i=1,s<=0)return void(r&&r(new Error("stepUp command value invalid")));break;case"stepDown":if(i=0,s<=0)return void(r&&r(new Error("stepDown command value invalid")));break;case"stepUpStop":i=1;break;case"stepDownStop":i=0;break;default:return void(r&&r(new Error("unknown command:"+a)));}var c=i<<3|s;this.setValue(c,t,n,r);}else r&&r(new Error("invalid step precent:"+o));}else r&&r(new Error("unknown command:"+e));},r.prototype.setValue=function(t,n,r,a){t<0&&(t=0),t>15&&(t=15);var o=new Buffer([t]);e.prototype.setValue.call(this,o,n,r,function(e){a&&a(e);}.bind(this));},r.prototype._resolveDataRaw=function(e){return e.readUInt8(0);},r.prototype._resolveData=function(e){var t=e.readUInt8(0);return this._resolveValue(t);},r.prototype._resolveValue=function(e){var t=7&e,n=0;return 0==t?n=0:1==t?n=100:2==t?n=50:3==t?n=25:4==t?n=12:5==t?n=6:6==t?n=3:7==t&&(n=1),{direction:8&e?"up":"down",precent:n,stepcode:t};},r.prototype._getStepcode=function(e){switch(e){case 0:return 0;case 1:return 7;case 3:return 6;case 6:return 5;case 12:return 4;case 25:return 3;case 50:return 2;case 100:return 1;default:return-1;}};var a=function a(t){e.call(this,t);};a.prototype=new e(),a.prototype.constructor=a,a.prototype.doCommand=function(t,n,r,a){if(t){var o=t,i=0;switch(0==t.indexOf("setValue")&&(o=t.substr(0,8),(i=parseInt(t.substr(8)))&&!isNaN(i)||(i=0)),o){case"setValue":break;case"up":case"down":var s;return(s="up"==o?this._getBuffer(255):this._getBuffer(0))?void e.prototype.setValue.call(this,s,n,r,function(e){a&&a(e);}.bind(this)):void(a&&a(new Error("invalid value")));default:return void(a&&a(new Error("unknown command:"+o)));}this.setValue(i,n,r,a);}else a&&a(new Error("unknown command:"+t));},a.prototype.setValue=function(t,n,r,a){switch(this.type){case"DPST-5-1":t<0&&(t=0),t>100&&(t=100),t=Math.round(t/100*255);break;case"DPST-5-3":t<0&&(t=0),t>360&&(t=360),t=Math.round(t/360*255);break;case"DPST-5-6":t<0&&(t=0),t>254&&(t=254),t=Math.round(t/360*255);break;default:t<0&&(t=0),t>255&&(t=255);}var o=this._getBuffer(t);o?e.prototype.setValue.call(this,o,n,r,function(e){a&&a(e);}.bind(this)):a&&a(new Error("invalid value"));},a.prototype.incValue=function(e,t,n,r,a){var o=this._resolveValue(t);o+=e,this.setValue(o,n,r,a);},a.prototype.decValue=function(e,t,n,r,a){var o=this._resolveValue(t);o-=e,this.setValue(o,n,r,a);},a.prototype._resolveDataRaw=function(e){return!e||e.length<2?null:e.readUInt8(1);},a.prototype._resolveData=function(e){if(!e||e.length<2)return null;var t=e.readUInt8(1);return this._resolveValue(t);},a.prototype._resolveValue=function(e){switch(this.type){case"DPST-5-1":return Math.round(e/255*100);case"DPST-5-3":return Math.round(e/255*360);default:return e;}},a.prototype._getBuffer=function(e){var t=new Buffer(2);return t.writeUInt8(0,0),t.writeUInt8(e,1),t;};var o=function o(t){e.call(this,t);};o.prototype=new e(),o.prototype.constructor=o,o.prototype.doCommand=function(e,t,n,r){if(e){var a=e,o=0;0==e.indexOf("setValue")&&(a=e.substr(0,8),(o=parseInt(e.substr(8)))&&!isNaN(o)||(o=0)),"setValue"===a?this.setValue(o,t,n,r):r&&r(new Error("unknown command:"+a));}else r&&r(new Error("unknown command:"+e));},o.prototype.setValue=function(t,n,r,a){this.type,t<-128&&(t=-128),t>127&&(t=127),t<0&&(t+=256);var o=this._getBuffer(t);o?e.prototype.setValue.call(this,o,n,r,function(e){a&&a(e);}.bind(this)):a&&a(new Error("invalid value"));},o.prototype.incValue=function(e,t,n,r,a){var o=this._resolveValue(t);o+=e,this.setValue(o,n,r,a);},o.prototype.decValue=function(e,t,n,r,a){var o=this._resolveValue(t);o-=e,this.setValue(o,n,r,a);},o.prototype._resolveDataRaw=function(e){return!e||e.length<2?null:e.readUInt8(1);},o.prototype._resolveData=function(e){if(!e||e.length<2)return null;var t=e.readUInt8(1);return this._resolveValue(t);},o.prototype._resolveValue=function(e){return this.type,e>127&&(e-=256),e;},o.prototype._getBuffer=function(e){var t=new Buffer(2);return t.writeUInt8(0,0),t.writeUInt8(e,1),t;};var i=function i(t){e.call(this,t);};i.prototype=new e(),i.prototype.constructor=i,i.prototype.doCommand=function(e,t,n,r){if(e){var a=null,o=0;0==e.indexOf("setValue")&&(a=e.substr(0,8),(o=parseFloat(e.substr(8)))&&!isNaN(o)||(o=0)),"setValue"===a?this.setValue(o,t,n,r):r&&r(new Error("unknown command:"+a));}else r&&r(new Error("unknown command:"+e));},i.prototype.setValue=function(t,n,r,a){switch(this.type){case"DPT-9":t<-671088.64&&(t=-671088.64),t>670760.96&&(t=670760.96),t=this._float2short(t);break;case"DPST-9-1":t<-273&&(t=-273),t>670760&&(t=670760),t=this._float2short(t);break;case"DPST-9-4":t<0?t=0:t>670433.28&&(t=670433.28),t=this._float2short(t);break;default:t=this._float2short(t);}var o=this._getBuffer(t);o?e.prototype.setValue.call(this,o,n,r,function(e){a&&a(e);}.bind(this)):a&&a(new Error("invalid value"));},i.prototype.incValue=function(e,t,n,r,a){var o=this._resolveValue(t);o+=e,this.setValue(o,n,r,a);},i.prototype.decValue=function(e,t,n,r,a){var o=this._resolveValue(t);o-=e,this.setValue(o,n,r,a);},i.prototype._resolveDataRaw=function(e){return!e||e.length<3?0:e.readUInt16BE(1);},i.prototype._resolveData=function(e){if(!e||e.length<3)return 0;var t=e.readUInt16BE(1);return this._resolveValue(t);},i.prototype._resolveValue=function(e){return this.type,parseFloat(this._short2float(e).toFixed(2));},i.prototype._getBuffer=function(e){var t=new Buffer(3);return t.writeUInt8(0,0),t.writeUInt16BE(e,1),t;},i.prototype._float2short=function(e){for(var t=100*e,n=0;t<-2048;t/=2)n++;for(;t>2047;t/=2)n++;var r=2047&Math.round(t),a=n<<3|r>>8;return e<0&&(a|=128),a<<8|r;},i.prototype._short2float=function(e){var t=e>>15&1,n=e>>11&15,r=2047&e|t<<11;return 1==t&&(r-=4096),.01*r*Math.pow(2,n);};var s=function s(t){e.call(this,t);};s.prototype=new e(),s.prototype.constructor=s,s.prototype.doCommand=function(e,t,n,r){if(e){var a=null,o=0;0==e.indexOf("setValue")&&(a=e.substr(0,8),(o=parseFloat(e.substr(8)))&&!isNaN(o)||(o=0)),"setValue"===a?this.setValue(o,t,n,r):r&&r(new Error("unknown command:"+a));}else r&&r(new Error("unknown command:"+e));},s.prototype.setValue=function(t,n,r,a){var o;this.type,t<-340282347e30&&(t=-340282347e30),t>340282347e30&&(t=340282347e30),o=this._float2bytes(t);var i=this._getBuffer(o);i?e.prototype.setValue.call(this,i,n,r,function(e){a&&a(e);}.bind(this)):a&&a(new Error("invalid value"));},s.prototype.incValue=function(e,t,n,r,a){var o=this._resolveValue(t);o+=e,this.setValue(o,n,r,a);},s.prototype.decValue=function(e,t,n,r,a){var o=this._resolveValue(t);o-=e,this.setValue(o,n,r,a);},s.prototype._resolveDataRaw=function(e){return!e||e.length<5?0:e.readUInt32BE(1);},s.prototype._resolveData=function(e){if(!e||e.length<5)return 0;var t=e.readUInt32BE(1);return this._resolveValue(t);},s.prototype._resolveValue=function(e){return this.type,parseFloat(this._long2float(e).toFixed(2));},s.prototype._getBuffer=function(e){if(!e||e.length<4)return null;var t=new Buffer(5);t.writeUInt8(0,0);for(var n=0;n<4;n++)t.writeUInt8(e[n],n+1);return t;},s.prototype._float2bytes=function(e){return this._toIEEE754Single(e);},s.prototype._long2float=function(e){var t=new Buffer(4);t.writeUInt32BE(e);var n=Array.prototype.slice.call(t);return this._fromIEEE754Single(n);},s.prototype._toIEEE754=function(e,t,n){var r,a,o,i=(1<<t-1)-1;if(isNaN(e))a=(1<<i)-1,o=1,r=0;else if(e===1/0||e===-1/0)a=(1<<i)-1,o=0,r=e<0?1:0;else if(0===e)a=0,o=0,r=1/e==-1/0?1:0;else if(r=e<0,(e=Math.abs(e))>=Math.pow(2,1-i)){var s=Math.min(Math.floor(Math.log(e)/Math.LN2),i);a=s+i,o=e*Math.pow(2,n-s)-Math.pow(2,n);}else a=0,o=e/Math.pow(2,1-i-n);var c,u=[];for(c=n;c;c-=1)u.push(o%2?1:0),o=Math.floor(o/2);for(c=t;c;c-=1)u.push(a%2?1:0),a=Math.floor(a/2);u.push(r?1:0),u.reverse();for(var l=u.join(""),d=[];l.length;)d.push(parseInt(l.substring(0,8),2)),l=l.substring(8);return d;},s.prototype._fromIEEE754=function(e,t,n){for(var r=[],a=e.length;a;a-=1)for(var o=e[a-1],i=8;i;i-=1)r.push(o%2?1:0),o>>=1;r.reverse();var s=r.join(""),c=(1<<t-1)-1,u=parseInt(s.substring(0,1),2)?-1:1,l=parseInt(s.substring(1,1+t),2),d=parseInt(s.substring(1+t),2);return l===(1<<t)-1?0!==d?NaN:u*(1/0):l>0?u*Math.pow(2,l-c)*(1+d/Math.pow(2,n)):0!==d?u*Math.pow(2,-(c-1))*(d/Math.pow(2,n)):0*u;},s.prototype._fromIEEE754Single=function(e){return this._fromIEEE754(e,8,23);},s.prototype._toIEEE754Single=function(e){return this._toIEEE754(e,8,23);};var c=function c(t){e.call(this,t);};return c.prototype=new e(),c.prototype.constructor=c,c.prototype.doCommand=function(e,t,n,r){if(e){var a=e,o=0;switch(0==e.indexOf("setValue")&&(a=e.substr(0,8),(o=parseInt(e.substr(8)))&&!isNaN(o)||(o=0)),a){case"auto":o=0;break;case"comfort":o=1;break;case"standby":o=2;break;case"economy":o=3;break;case"protection":o=4;break;case"setValue":break;default:return void(r&&r(new Error("unknown command:"+a)));}this.setValue(o,t,n,r);}else r&&r(new Error("unknown command:"+e));},c.prototype.setValue=function(t,n,r,a){var o=this._getBuffer(t);o?e.prototype.setValue.call(this,o,n,r,function(e){a&&a(e);}.bind(this)):a&&a(new Error("invalid value"));},c.prototype.incValue=function(e,t,n,r,a){var o=this._resolveValue(t);o=o.value+e,this.setValue(o,n,r,a);},c.prototype.decValue=function(e,t,n,r,a){var o=this._resolveValue(t);o=o.value-e,this.setValue(o,n,r,a);},c.prototype._resolveDataRaw=function(e){return!e||e.length<2?null:e.readUInt8(1);},c.prototype._resolveData=function(e){if(!e||e.length<2)return null;var t=e.readUInt8(1);return this._resolveValue(t);},c.prototype._resolveValue=function(e){var t;switch(this.type){case"DPT-20":t=e;break;case"DPST-20-1":switch(e){case 0:t="autonomous";break;case 1:t="slave";break;case 2:t="master";break;default:t="unknow";}break;case"DPST-20-102":switch(e){case 0:t="auto";break;case 1:t="comfort";break;case 2:t="standby";break;case 3:t="economy";break;case 4:t="protection";break;default:t="unknow";}break;default:return null;}return t;},c.prototype._getBuffer=function(e){var t=new Buffer(2);return t.writeUInt8(0,0),t.writeUInt8(e,1),t;},e.DPT1=t,e.DPT2=n,e.DPT3=r,e.DPT5=a,e.DPT6=o,e.DPT9=i,e.DPT14=s,e.DPT20=c,e;}(),xnm.aio.knx.KNXGateway._Device=function(){var e=function e(_e5){this._device=_e5;};e.resolve=function(e){if(!e)return null;var u=null;switch(e.data){case"outlet":u=new n(e);break;case"lighting":u=new r(e);break;case"blind":u=new a(e);break;case"shutter":u=new o(e);break;case"heater":u=new i(e);break;case"1bit":u=new s(e);break;case"1byte":u=new c(e);break;case"general":u=new t(e);}return u;},e.prototype={getDefaultChannel:function getDefaultChannel(){return null;},executeCommand:function executeCommand(e,t,n){this._parseCommand(e,function(e,r,a,o){if(e)n&&n(e);else{var i=o.ga,s=xnm.aio.knx.KNXGateway._DPT.resolve(o.type);s?s.doCommand(a,t,i,function(e){n&&n(e);}.bind(this)):n&&n(new Error("unknown actuator type:"+o.type));}});},_parseCommand:function _parseCommand(e,t){if(this._device){if(e){var n=e.indexOf("@");if(-1!=n){var r=e.substr(0,n),a=e.substr(n+1);if(r||(r=this.getDefaultChannel()),this._device.channels&&this._device.channels[r]){var o=this._device.channels[r];o.actuator&&o.actuator.ga&&o.actuator.type?xnm.aio.knx.KNXGateway._DPT.resolve(o.actuator.type)?t&&t(null,r,a,o.actuator):t&&t(new Error("unknown actuator type:"+o.actuator.type)):t&&t(new Error("device has no actuator for channel:"+r));}else t&&t(new Error("device has no channel with id:"+r));}else t&&t(new Error("command format invalid"));}else t&&t(new Error("command is null"));}else t&&t(new Error("device is null"));},getStates:function getStates(e){if(!this._device||!this._device.channels)return null;var t=null;for(var n in this._device.channels)if(this._device.channels.hasOwnProperty(n)){var r=this.getState(n,e);r&&!r.error&&(t||(t={}),null==r.resolvedValue?t[n]={state:r.resolvedValue,raw:r.resolvedRawValue}:"object"==_typeof(r.resolvedValue)?(t[n]=JSON.parse(JSON.stringify(r.resolvedValue)),t[n].raw=r.resolvedRawValue):t[n]={state:r.resolvedValue,raw:r.resolvedRawValue});}return t;},getState:function getState(e,t){return this._getBufferedState(e,t);},_getBufferedState:function _getBufferedState(e,t){var n={error:null,bufferedValue:null,resolvedRawValue:null,resovledValue:null};if(!this._device)return n.error=new Error("device is null"),n;if(e||(e=this.getDefaultChannel()),!this._device.channels||!this._device.channels[e])return n.error=new Error("device has no channel with id:"+e),n;var r,a=this._device.channels[e],o=null,i=null,s=null,c=t.getStateBuffer();if(a.event&&a.event.ga&&(o=c.getState(xnm.aio.knx.KNXGateway._adr2long(a.event.ga)))&&(r=xnm.aio.knx.KNXGateway._DPT.resolve(a.event.type))&&(s=r._resolveDataRaw(o),i=r._resolveData(o)),void 0!==o&&null!=o||a.status&&a.status.ga&&(o=c.getState(xnm.aio.knx.KNXGateway._adr2long(a.status.ga)))&&(r=xnm.aio.knx.KNXGateway._DPT.resolve(a.status.type))&&(s=r._resolveDataRaw(o),i=r._resolveData(o)),(void 0===o||null==o)&&a.status&&a.status.ga){var u=c.getStateReqTime(xnm.aio.knx.KNXGateway._adr2long(a.status.ga)),l=new Date();(!u||l.getTime()-u.getTime()>xnm.aio.knx.KNXGateway.STATES_REQ_EXPIRED)&&(c.setStateReqTime(xnm.aio.knx.KNXGateway._adr2long(a.status.ga),l),(r=xnm.aio.knx.KNXGateway._DPT.resolve(a.status.type))&&r.getValue(t,a.status.ga));}return n.bufferedValue=o,n.resolvedRawValue=s,n.resolvedValue=i,n;},refreshStates:function refreshStates(e){if(!this._device||!this._device.channels)return null;var t=e.getStateBuffer();for(var n in this._device.channels)if(this._device.channels.hasOwnProperty(n)){var r=this._device.channels[n];if(r.status&&r.status.ga&&r.status.type){var a=xnm.aio.knx.KNXGateway._DPT.resolve(r.status.type);if(a){var o=new Date();t.setStateReqTime(xnm.aio.knx.KNXGateway._adr2long(r.status.ga),o),a.getValue(e,r.status.ga);}}}return null;}};var t=function t(_t3){e.call(this,_t3);};t.prototype=new e(),t.prototype.constructor=t,t.prototype.executeCommand=function(e,t,n){if("refreshStates"==e)return this.refreshStates(t),void(n&&n());var r=this;this._parseCommand(e,function(e,a,o,i){if(e)n&&n(e);else{var s,c,u,l,d=i.ga,f=xnm.aio.knx.KNXGateway._DPT.resolve(i.type);if(f instanceof xnm.aio.knx.KNXGateway._DPT.DPT1){if("toggle"===o){if((u=r.getState(a,t)).err||!u.bufferedValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.bufferedValue.readUInt8(0),f.setValue(l?0:1,t,d,function(e){n&&n(e);}.bind(this));}else f.doCommand(o,t,d,n);}else if(f instanceof xnm.aio.knx.KNXGateway._DPT.DPT2)f.doCommand(o,t,d,n);else if(f instanceof xnm.aio.knx.KNXGateway._DPT.DPT3)f.doCommand(o,t,d,n);else if(f instanceof xnm.aio.knx.KNXGateway._DPT.DPT5)switch(s=o,(0==o.indexOf("inc")||0==o.indexOf("dec"))&&(s=o.substr(0,3),(c=parseInt(o.substr(3)))&&!isNaN(c)||(c=1)),s){case"inc":if((u=r.getState(a,t)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.incValue(c,l,t,d,function(e){n&&n(e);}.bind(this));break;case"dec":if((u=r.getState(a,t)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.decValue(c,l,t,d,function(e){n&&n(e);}.bind(this));break;default:f.doCommand(o,t,d,n);}else if(f instanceof xnm.aio.knx.KNXGateway._DPT.DPT6)switch(s=o,(0==o.indexOf("inc")||0==o.indexOf("dec"))&&(s=o.substr(0,3),(c=parseInt(o.substr(3)))&&!isNaN(c)||(c=1)),s){case"inc":if((u=r.getState(a,t)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.incValue(c,l,t,d,function(e){n&&n(e);}.bind(this));break;case"dec":if((u=r.getState(a,t)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.decValue(c,l,t,d,function(e){n&&n(e);}.bind(this));break;default:f.doCommand(o,t,d,n);}else if(f instanceof xnm.aio.knx.KNXGateway._DPT.DPT9)switch(s=o,(0==o.indexOf("inc")||0==o.indexOf("dec"))&&(s=o.substr(0,3),(c=parseFloat(o.substr(3)))&&!isNaN(c)||(c=1)),s){case"inc":if((u=r.getState(a,t)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.incValue(c,l,t,d,function(e){n&&n(e);}.bind(this));break;case"dec":if((u=r.getState(a,t)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.decValue(c,l,t,d,function(e){n&&n(e);}.bind(this));break;default:f.doCommand(o,t,d,n);}else if(f instanceof xnm.aio.knx.KNXGateway._DPT.DPT14)switch(s=o,(0==o.indexOf("inc")||0==o.indexOf("dec"))&&(s=o.substr(0,3),(c=parseFloat(o.substr(3)))&&!isNaN(c)||(c=1)),s){case"inc":if((u=r.getState(a,t)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.incValue(c,l,t,d,function(e){n&&n(e);}.bind(this));break;case"dec":if((u=r.getState(a,t)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.decValue(c,l,t,d,function(e){n&&n(e);}.bind(this));break;default:f.doCommand(o,t,d,n);}else if(f instanceof xnm.aio.knx.KNXGateway._DPT.DPT20)switch(s=o,(0==o.indexOf("inc")||0==o.indexOf("dec"))&&(s=o.substr(0,3),(c=parseInt(o.substr(3)))&&!isNaN(c)||(c=1)),s){case"inc":if((u=r.getState(a,t)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.incValue(c,l,t,d,function(e){n&&n(e);}.bind(this));break;case"dec":if((u=r.getState(a,t)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.decValue(c,l,t,d,function(e){n&&n(e);}.bind(this));break;default:f.doCommand(o,t,d,n);}else n&&n(new Error("unknown data point type"));}});};var n=function n(t){e.call(this,t);};n.prototype=new e(),n.prototype.constructor=n,n.prototype.executeCommand=function(e,n,r){if("refreshStates"==e)return this.refreshStates(n),void(r&&r());var a=this;this._parseCommand(e,function(o,i,s,c){if(o)r&&r(o);else{var u=c.ga,l=xnm.aio.knx.KNXGateway._DPT.resolve(c.type);if("switch"===i)switch(s){case"on":case"off":l.doCommand(s,n,u,r);break;case"toggle":var d=a.getState(i,n);if(d.err||!d.bufferedValue)return void(r&&r(new Error("device (buffered) Status unknow")));var f=d.bufferedValue.readUInt8(0);l.setValue(f?0:1,n,u,function(e){r&&r(e);}.bind(this));break;default:r&&r(new Error("invalid device command"));}else t.prototype.executeCommand.call(a,e,n,r);}});},n.prototype.getDefaultChannel=function(){return"switch";};var r=function r(t){e.call(this,t);};r.prototype=new e(),r.prototype.constructor=r,r.prototype.executeCommand=function(e,n,r){if("refreshStates"==e)return this.refreshStates(n),void(r&&r());var a=this;this._parseCommand(e,function(o,i,s,c){if(o)r&&r(o);else{var u,l,d=c.ga,f=xnm.aio.knx.KNXGateway._DPT.resolve(c.type),h=s,_=null;switch(i){case"switch":switch(s){case"on":case"off":f.doCommand(s,n,d,r);break;case"toggle":if((u=a.getState(i,n)).err||!u.bufferedValue)return void(r&&r(new Error("device (buffered) Status unknow")));l=u.bufferedValue.readUInt8(0),f.setValue(l?0:1,n,d,function(e){r&&r(e);}.bind(this));break;default:r&&r(new Error("invalid device command"));}break;case"step":0==s.indexOf("stepUp")||0==s.indexOf("stepDown")?f.doCommand(s,n,d,r):r&&r(new Error("invalid device command"));break;case"value":switch(0==s.indexOf("inc")||0==s.indexOf("dec")?(h=s.substr(0,3),(_=parseInt(s.substr(3)))&&!isNaN(_)||(_=1)):0==s.indexOf("dimTo")&&(h="dimTo",(_=parseInt(s.substr(5)))&&!isNaN(_)||(_=0)),h){case"dimUp":f.doCommand("up",n,d,r);break;case"dimDown":f.doCommand("down",n,d,r);break;case"inc":if((u=a.getState(i,n)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(r&&r(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.incValue(_,l,n,d,function(e){r&&r(e);}.bind(this));break;case"dec":if((u=a.getState(i,n)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(r&&r(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.decValue(_,l,n,d,function(e){r&&r(e);}.bind(this));break;case"dimTo":f.doCommand("setValue"+_,n,d,r);break;default:r&&r(new Error("invalid device command"));}break;default:return void t.prototype.executeCommand.call(a,e,n,r);}}});},r.prototype.getDefaultChannel=function(){return"value";};var a=function a(t){e.call(this,t);};a.prototype=new e(),a.prototype.constructor=a,a.prototype.executeCommand=function(e,n,r){if("refreshStates"==e)return this.refreshStates(n),void(r&&r());var a=this;this._parseCommand(e,function(o,i,s,c){if(o)r&&r(o);else{var u,l,d=c.ga,f=xnm.aio.knx.KNXGateway._DPT.resolve(c.type),h=s,_=null;switch(i){case"blind_step":switch(s){case"blindStepUp":f.doCommand("up",n,d,r);break;case"blindStepDown":f.doCommand("down",n,d,r);break;default:r&&r(new Error("invalid device command"));}break;case"blind_move":switch(s){case"blindMoveUp":f.doCommand("up",n,d,r);break;case"blindMoveDown":f.doCommand("down",n,d,r);break;default:r&&r(new Error("invalid device command"));}break;case"blind_stop":"blindStop"===s?f.doCommand("stop",n,d,r):r&&r(new Error("invalid device command"));break;case"blind_position":switch(0==s.indexOf("inc")||0==s.indexOf("dec")?(h=s.substr(0,3),(_=parseInt(s.substr(3)))&&!isNaN(_)||(_=1)):0==s.indexOf("moveTo")&&(h="moveTo",(_=parseInt(s.substr(6)))&&!isNaN(_)||(_=0)),h){case"moveUp":f.doCommand("down",n,d,r);break;case"moveDown":f.doCommand("up",n,d,r);break;case"inc":if((u=a.getState(i,n)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(r&&r(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.incValue(_,l,n,d,function(e){r&&r(e);}.bind(this));break;case"dec":if((u=a.getState(i,n)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(r&&r(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.decValue(_,l,n,d,function(e){r&&r(e);}.bind(this));break;case"moveTo":f.doCommand("setValue"+_,n,d,r);break;default:r&&r(new Error("invalid device command"));}break;case"lamella_position":switch(0==s.indexOf("incL")||0==s.indexOf("decL")?(h=s.substr(0,4),(_=parseInt(s.substr(4)))&&!isNaN(_)||(_=1)):0==s.indexOf("lamellaTo")&&(h="lamellaTo",(_=parseInt(s.substr(9)))&&!isNaN(_)||(_=0)),h){case"lamellaUp":f.doCommand("down",n,d,r);break;case"lamellaDown":f.doCommand("up",n,d,r);break;case"incL":if((u=a.getState(i,n)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(r&&r(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.incValue(_,l,n,d,function(e){r&&r(e);}.bind(this));break;case"decL":if((u=a.getState(i,n)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(r&&r(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.decValue(_,l,n,d,function(e){r&&r(e);}.bind(this));break;case"lamellaTo":f.doCommand("setValue"+_,n,d,r);break;default:r&&r(new Error("invalid device command"));}break;default:return void t.prototype.executeCommand.call(a,e,n,r);}}});},a.prototype.getDefaultChannel=function(){return"blind_position";};var o=function o(t){e.call(this,t);};o.prototype=new e(),o.prototype.constructor=o,o.prototype.executeCommand=function(e,n,r){if("refreshStates"==e)return this.refreshStates(n),void(r&&r());var a=this;this._parseCommand(e,function(o,i,s,c){if(o)r&&r(o);else{var u,l,d=c.ga,f=xnm.aio.knx.KNXGateway._DPT.resolve(c.type),h=s,_=null;switch(i){case"shutter_step":switch(s){case"shutterStepUp":f.doCommand("up",n,d,r);break;case"shutterStepDown":f.doCommand("down",n,d,r);break;default:r&&r(new Error("invalid device command"));}break;case"shutter_move":switch(s){case"shutterMoveUp":f.doCommand("up",n,d,r);break;case"shutterMoveDown":f.doCommand("down",n,d,r);break;default:r&&r(new Error("invalid device command"));}break;case"shutter_stop":"shutterStop"===s?f.doCommand("stop",n,d,r):r&&r(new Error("invalid device command"));break;case"shutter_position":switch(0==s.indexOf("inc")||0==s.indexOf("dec")?(h=s.substr(0,3),(_=parseInt(s.substr(3)))&&!isNaN(_)||(_=1)):0==s.indexOf("moveTo")&&(h="moveTo",(_=parseInt(s.substr(6)))&&!isNaN(_)||(_=0)),h){case"moveUp":f.doCommand("down",n,d,r);break;case"moveDown":f.doCommand("up",n,d,r);break;case"inc":if((u=a.getState(i,n)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(r&&r(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.incValue(_,l,n,d,function(e){r&&r(e);}.bind(this));break;case"dec":if((u=a.getState(i,n)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(r&&r(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.decValue(_,l,n,d,function(e){r&&r(e);}.bind(this));break;case"moveTo":f.doCommand("setValue"+_,n,d,r);break;default:r&&r(new Error("invalid device command"));}break;default:return void t.prototype.executeCommand.call(a,e,n,r);}}});},o.prototype.getDefaultChannel=function(){return"shutter_position";};var i=function i(t){e.call(this,t);};i.prototype=new e(),i.prototype.constructor=i,i.prototype.executeCommand=function(e,n,r){if("refreshStates"==e)return this.refreshStates(n),void(r&&r());var a=this;this._parseCommand(e,function(o,i,s,c){if(o)r&&r(o);else{var u,l,d=c.ga,f=xnm.aio.knx.KNXGateway._DPT.resolve(c.type),h=s,_=null;switch(i){case"setpoint_basic":switch(0==s.indexOf("tempUp")?(h=s.substr(0,6),(_=parseFloat(s.substr(6)))&&!isNaN(_)||(_=.5)):0==s.indexOf("tempDown")?(h=s.substr(0,8),(_=parseFloat(s.substr(8)))&&!isNaN(_)||(_=.5)):0==s.indexOf("tempTo")&&(h="tempTo",(_=parseFloat(s.substr(6)))&&!isNaN(_)||(_=0)),h){case"tempUp":if((u=a.getState(i,n)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(r&&r(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.incValue(_,l,n,d,function(e){r&&r(e);}.bind(this));break;case"tempDown":if((u=a.getState(i,n)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(r&&r(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.decValue(_,l,n,d,function(e){r&&r(e);}.bind(this));break;case"tempTo":f.doCommand("setValue"+_,n,d,r);break;default:r&&r(new Error("invalid device command"));}break;case"setpoint_shift":switch(0==s.indexOf("tempShiftUp")?(h=s.substr(0,11),(_=parseInt(s.substr(11)))&&!isNaN(_)||(_=1)):0==s.indexOf("tempShiftDown")?(h=s.substr(0,13),(_=parseInt(s.substr(13)))&&!isNaN(_)||(_=1)):0==s.indexOf("tempShiftTo")&&(h="tempShiftTo",(_=parseInt(s.substr(11)))&&!isNaN(_)||(_=0)),h){case"tempShiftUp":if((u=a.getState(i,n)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(r&&r(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.incValue(_,l,n,d,function(e){r&&r(e);}.bind(this));break;case"tempShiftDown":if((u=a.getState(i,n)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(r&&r(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.decValue(_,l,n,d,function(e){r&&r(e);}.bind(this));break;case"tempShiftTo":f.doCommand("setValue"+_,n,d,r);break;default:r&&r(new Error("invalid device command"));}break;case"mode":f.doCommand(s,n,d,r);break;default:return void t.prototype.executeCommand.call(a,e,n,r);}}});},i.prototype.getDefaultChannel=function(){return"set_temperature";};var s=function s(t){e.call(this,t);};s.prototype=new e(),s.prototype.constructor=s,s.prototype.doCommand=function(e,t,n){var r,a={},o=e.command,i=e.channel;if(i||(i=this.getDefaultChannel()),this._device[i]){var s=this._getWriteableGa(this._device[i]);if(s){if(s instanceof Error)n&&n(s);else switch(o){case"on":xnm.aio.knx.KNXGateway._DPT.resolve(this._device[i].actuator.type).setValue(1,t,s,function(e,t){e||(a.channel=i,a.state=t),n&&n(e,e?null:a);}.bind(this));break;case"off":xnm.aio.knx.KNXGateway._DPT.resolve(this._device[i].actuator.type).setValue(0,t,s,function(e,t){e||(a.channel=i,a.state=t),n&&n(e,e?null:a);}.bind(this));break;case"toggle":if(!(r=this._getReadableGa(this._device[i])))return void(n&&n(new Error("invalid device has no readable address")));if(r instanceof Error)return void(n&&n(s));xnm.aio.knx.KNXGateway._DPT.resolve(this._device[i].actuator.type).invValue(t,s,r,function(e,t){e||(a.channel=i,a.state=t),n&&n(e,e?null:a);}.bind(this));break;default:n&&n(new Error("invalid device command"));}}else n&&n(new Error("invalid device has no writeable address"));}else n&&n(new Error("invalid device"));},s.prototype.evalGroupCommand=function(e,t,n){var r={},a=e.command,o=e.channel;if(o||(o=this.getDefaultChannel()),this._device[o]){var i=this._getWriteableGa(this._device[o]);if(i){if(i instanceof Error)n&&n(i);else switch(a){case"on":xnm.aio.knx.KNXGateway._DPT.resolve(this._device[o].actuator.type).evalValue(1,t,i,function(e,t){e||(r.channel=o,r.state=t),n&&n(e,e?null:r);}.bind(this));break;case"off":xnm.aio.knx.KNXGateway._DPT.resolve(this._device[o].actuator.type).evalValue(0,t,i,function(e,t){e||(r.channel=o,r.state=t),n&&n(e,e?null:r);}.bind(this));break;default:n&&n(new Error("invalid device group command"));}}else n&&n(new Error("invalid device has no writeable address"));}else n&&n(new Error("invalid device"));},s.prototype.getState=function(e,t,n){var r;e&&e.channel&&(r=e.channel),r||(r=this.getDefaultChannel()),this._getState(r,t,n);},s.prototype.getDefaultChannel=function(){return"channel";};var c=function c(t){e.call(this,t);};return c.prototype=new e(),c.prototype.constructor=c,c.prototype.doCommand=function(e,t,n){var r,a={},o=e.command,i=e.channel;if(i||(i=this.getDefaultChannel()),this._device[i]){var s=this._getWriteableGa(this._device[i]);if(s){if(s instanceof Error)n&&n(s);else{if(o.length>=3&&("inc"===o.substr(0,3).toLowerCase()||"dec"===o.substr(0,3).toLowerCase())){var c=o.substr(0,3);return""==(o=o.substr(3))&&(o="10"),o.match(/^\d+$/)?(o=parseInt(o),(r=this._getReadableGa(this._device[i]))?r instanceof Error?void(n&&n(r)):void xnm.aio.knx.KNXGateway._DPT.resolve(this._device[i].actuator.type)["inc"==c?"incValue":"decValue"](o,t,s,r,function(e,t){e||null==t||(a.channel=i,a.state=t),n&&n(e,e?null:a);}):void(n&&n(new Error("invalid device has no readable address")))):void(n&&n(new Error("invalid device command")));}o.length>6&&"moveto"===o.substr(0,6).toLowerCase()&&(o=o.substr(6)),o.match(/^\d+$/)?(o=parseInt(o),xnm.aio.knx.KNXGateway._DPT.resolve(this._device[i].actuator.type).setValue(o,t,s,function(e,t){e||null==t||(a.channel=i,a.state=t),n&&n(e,e?null:a);})):n&&n(new Error("invalid device command"));}}else n&&n(new Error("invalid device has no writeable address"));}else n&&n(new Error("invalid device"));},c.prototype.evalGroupCommand=function(e,t,n){var r={},a=e.command,o=e.channel;if(o||(o=this.getDefaultChannel()),this._device[o]){var i=this._getWriteableGa(this._device[o]);i?i instanceof Error?n&&n(i):a.length>=3&&("inc"===a.substr(0,3).toLowerCase()||"dec"===a.substr(0,3).toLowerCase())?n&&n(new Error("invalid device group command")):(a.length>6&&"moveto"===a.substr(0,6).toLowerCase()&&(a=a.substr(6)),a.match(/^\d+$/)?(a=parseInt(a),xnm.aio.knx.KNXGateway._DPT.resolve(this._device[o].actuator.type).evalValue(a,t,i,function(e,t){e||null==t||(r.channel=o,r.state=t),n&&n(e,e?null:r);})):n&&n(new Error("invalid device command"))):n&&n(new Error("invalid device has no writeable address"));}else n&&n(new Error("invalid device"));},c.prototype.getState=function(e,t,n){var r;e&&e.channel&&(r=e.channel),r||(r=this.getDefaultChannel()),this._getState(r,t,n);},c.prototype.getDefaultChannel=function(){return"channel";},e.General=t,e.Outlet=n,e.Lighting=r,e.Blind=a,e.Shutter=o,e.Heater=i,e.BIT_1=s,e.Byte_1=c,e;}(),xnm.aio.knx.Discovery={_eventEmitter:new EventEmitter(),_logger:Logger.getLogger("xnm.aio.knx.Discovery"),_listenerSockets:[],_closedSockets:[],on:function on(e,t){this._eventEmitter.on(e,t);},removeAllListeners:function removeAllListeners(){this._eventEmitter.removeAllListeners();},startSearchKNX:function startSearchKNX(){if(os&&os.networkInterfaces){var e=os.networkInterfaces();for(var t in e)for(var n=e[t],r=0;r<n.length;r++){var a=n[r];if(!1===a.internal&&"IPv4"===a.family){var o=a.address;this._createSocket(o);}}}else this._createSocket(null);this._closedSockets=[];},stopSearchKNX:function stopSearchKNX(){for(var e=0;e<this._listenerSockets.length;e++)this._listenerSockets[e].close();},_createSocket:function _createSocket(e){var t=this,n=dgram.createSocket("udp4");n.on("listening",function(){n.addMembership("224.0.23.12"),n.setBroadcast(!0);var e=n.address();t._logger.log("debug","knx discovery socket listening "+e.address+":"+e.port),t._listenerSockets.push(n);var r={ip:e.address,port:e.port},a=new xnm.aio.knx.KNXGateway.IPFrame.SearchRequest(r).toBuffer();t._logger.log("debug","send knx search request: "+a.toString("hex")+" from "+e.address+":"+e.port),n.send(a,0,a.length,3671,"224.0.23.12");}),n.on("message",function(e,r){var a=n.address();t._logger.log("trace","receive data "+e.toString("hex")+" from "+r.address+":"+r.port+" @local "+a.address+":"+a.port);var o=xnm.aio.knx.KNXGateway.IPFrame.parseFrame(e);if(o instanceof xnm.aio.knx.KNXGateway.IPFrame.SearchResponse){var i=o.getCtrlEndpointHPAI();t._logger.log("debug","find knx "+i.ip+":"+i.port),t._eventEmitter.emit("found",o,a),t._eventEmitter.emit("device",o.toJSON(),a);}}),n.on("error",function(e){t._logger.log("debug","discovery socket error: "+e.stack),t._eventEmitter.emit("error",e);}),n.on("close",function(){t._logger.log("debug","discovery socket closed"),t._closedSockets.push(n),t._listenerSockets.length===t._closedSockets.length&&(t._listenerSockets=[],t._closedSockets=[],t._eventEmitter.emit("close"));}),n.bind(null,e);}},xnm.aio.knx.Handler=function(){var e=function e(){this._listenerSockets=[];};return e.prototype={KNXGateway:xnm.aio.knx.KNXGateway,Finder:xnm.aio.knx.Discovery},e;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.knx.Handler());