var dgram=require("dgram"),os=require("os"),EventEmitter=require("x.events.js").EventEmitter,Logger=require("x.logger.js"),xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.knx=xnm.aio.knx||{};
xnm.aio.knx.KNXGateway=function(){var n=function(d){d=d.split(".");d=(parseInt(d[0])<<24)+(parseInt(d[1])<<16)+(parseInt(d[2])<<8)+parseInt(d[3]);return d&4294967295},p=function(d){return(d>>24&255)+"."+(d>>16&255)+"."+(d>>8&255)+"."+(d&255)},r=function(){var d=function(c){this._loggger=require("x.logger.js").getLogger("xnm.aio.knx.KNXGateway.RawStateBuffer");this._stateBuffer={};this._stateReqTime={};this._knx=c};d.prototype.setState=function(c,b){"undefined"!=typeof c&&null!=c&&(this._stateBuffer[c]||
(this._stateBuffer[c]={}),this._stateBuffer[c].value=b,this._stateBuffer[c].timestamp=new Date)};d.prototype.getState=function(c){return"undefined"!=typeof c&&null!=c?(c=this._stateBuffer[c])?c.value:null:null};d.prototype.setStateReqTime=function(c,b){this._stateReqTime[c]=b};d.prototype.getStateReqTime=function(c){return this._stateReqTime[c]};return d}(),l=function(d,c,b){this._logger=Logger.getLogger("xnm.aio.knx.KNXGateway ("+d+")");this.ip=d;this.localIp=c;this.uuid=b;this._stateBuffer=new r;
this._stateMachine={state:l._FSM.IDLE};this._eventEmitter=new EventEmitter;this._dataLink=null;this._dataLinkRetryCount=0;this._dataLinkTimer=null};l.STATES_REQ_EXPIRED=18E4;l.MAX_DL_RETRY_COUNT=3;l._FSM={IDLE:1,MONITORING:2,START_MONITOR:3,STOP_MONITOR:4};l._ipv4ToLong=n;l._longToIpv4=p;l._adr2long=function(d){d=d.split("/");var c=0;switch(d.length){case 3:c+=parseInt(d[0])<<11;c+=parseInt(d[1])<<8;c+=parseInt(d[2]);break;case 2:c+=parseInt(d[0])<<11;c+=parseInt(d[1]);break;case 1:c+=parseInt(d[0])}return c};
l.prototype={getStateBuffer:function(){return this._stateBuffer},on:function(d,c){this._eventEmitter.on(d,c)},removeAllListeners:function(){this._eventEmitter.removeAllListeners()},removeListener:function(d,c){this._eventEmitter.removeListener(d,c)},startMonitor:function(d){if(d)this.on("open",d);this._fsmStartMonitor()},stopMonitor:function(d){if(d)this.on("close",d);this._fsmStopMonitor()},_fsmStartMonitor:function(){switch(this._stateMachine.state){case l._FSM.IDLE:this._stateMachine.state=l._FSM.START_MONITOR;
this._startDataLink();break;case l._FSM.MONITORING:this._eventEmitter.emit("open");break;case l._FSM.STOP_MONITOR:this._logger.log("warn","can not start the monitor again while stopping it")}},_fsmStopMonitor:function(){switch(this._stateMachine.state){case l._FSM.IDLE:this._onClose();break;case l._FSM.START_MONITOR:case l._FSM.MONITORING:this._stateMachine.state=l._FSM.STOP_MONITOR,this._stopDataLink()}},_fsmDatalinkOpen:function(){switch(this._stateMachine.state){case l._FSM.START_MONITOR:this._stateMachine.state=
l._FSM.MONITORING,this._onOpen(),this._dataLinkRetryCount=0}},_fsmDatalinkClosed:function(d){d?this._logger.log("trace","data link stopped due to error"):this._logger.log("trace","data link stopped");switch(this._stateMachine.state){case l._FSM.START_MONITOR:this._dataLink.removeAllListeners();this._dataLink=null;++this._dataLinkRetryCount<l.MAX_DL_RETRY_COUNT?(this._logger.log("trace","auto restart monitor tunnel"),this._stateMachine.state=l._FSM.START_MONITOR,this._startDataLink()):(this._stateMachine.state=
l._FSM.IDLE,this._onClose(!0));break;case l._FSM.MONITORING:this._dataLink.removeAllListeners();this._dataLink=null;++this._dataLinkRetryCount<l.MAX_DL_RETRY_COUNT?(this._logger.log("trace","auto restart monitor tunnel"),this._stateMachine.state=l._FSM.START_MONITOR,this._startDataLink()):(this._onError(Error("can not connect monitor tunnel to knx gateway")),this._stateMachine.state=l._FSM.IDLE,this._onClose(!0));break;case l._FSM.STOP_MONITOR:this._dataLink.removeAllListeners(),this._dataLink=null,
this._stateMachine.state=l._FSM.IDLE,this._onClose(!1)}},_fsmDataLinkMessage:function(d,c){switch(this._stateMachine.state){case l._FSM.MONITORING:c.getAPCI(),this._stateBuffer.setState(d,c.getData()),this._eventEmitter.emit("message",this.uuid,d,c)}},_fsmDatalinkError:function(d){this._onError(d)},_onOpen:function(){this._eventEmitter.emit("open")},_onError:function(d){this._eventEmitter.emit("error",d)},_onClose:function(d){this._eventEmitter.emit("close",d)},_sendCommand:function(d,c,b){this._dataLink?
this._sendCommandWithDL(this._dataLink,d,c,b):b&&b(Error("knx gateway not connected"))},_getState:function(d,c){this._dataLink?this._getStateWithDL(this._dataLink,d,c):c&&c(Error("knx gateway not connected"))},_sendCommandWithDL:function(d,c,b,a){var f=l._adr2long(c),e=new l.APDU(null,2,b),h=this;d.send(f,e,function(b){b||h._stateBuffer.setState(f,e.getData());a&&"function"===typeof a&&a(b)})},_getStateWithDL:function(d,c,b){c=l._adr2long(c);var a=new l.APDU(null,0,new Buffer([0]));d.send(c,a,b)},
_startDataLink:function(){var d=this;this._dataLink=new l._DataLink(this.ip,this.localIp);this._dataLink.on("connect",function(){d._fsmDatalinkOpen()});this._dataLink.on("close",function(c){d._fsmDatalinkClosed(c)});this._dataLink.on("error",function(c){d._logger.log("warn","monitor tunnel error:"+c.message);d._fsmDatalinkError(c)});this._dataLink.on("message",function(c,b){d._fsmDataLinkMessage(c,b)});this._dataLink.connect()},_stopDataLink:function(){this._dataLink&&this._dataLink.close()}};var v=
function(){var d=function(c,b){this._logger=Logger.getLogger("xnm.aio.knx.KNXGateway._DataLink ("+c+")");var d=this;this._tunnel=new u(c,null,b,null);this._tunnel.on("connect",function(){d._onTunnelConnect()});this._tunnel.on("end",function(){d._onTunnelEnd()});this._tunnel.on("close",function(b){d._onTunnelClose(b)});this._tunnel.on("message",function(b){d._onTunnelMessage(b)});this._tunnel.on("error",function(b){d._onTunnelError(b)});this._eventEmitter=new EventEmitter};d.prototype={on:function(c,
b){this._eventEmitter.on(c,b)},removeAllListeners:function(){this._eventEmitter.removeAllListeners()},removeListener:function(c,b){this._eventEmitter.removeListener(c,b)},connect:function(){this._tunnel.connect()},close:function(){this._tunnel.close()},send:function(c,b,d){this._logger.log("debug","send l_data.req "+b.toBuffer().toString("hex")+"@"+c);c=new t.L_Data_Req(c,b);this._tunnel.send(c,function(b){d&&d(b)})},_onTunnelConnect:function(){this._eventEmitter.emit("connect")},_onTunnelClose:function(c){this._eventEmitter.emit("close",
c)},_onTunnelEnd:function(){this._eventEmitter.emit("end")},_onTunnelMessage:function(c){var b="unknown";c&&c instanceof t.L_Data_Con?b="l_data.con":c&&c instanceof t.L_Data_Ind&&(b="l_data.ind");var d=c.getDstAddr();c=c.getAPDU();this._logger.log("debug","recive "+b+" "+c.toBuffer().toString("hex")+"@"+d);this._eventEmitter.emit("message",d,c)},_onTunnelError:function(c){this._eventEmitter.emit("error",c)}};return d}(),u=function(){var d=function(c,b,a,f){this._eventEmitter=new EventEmitter;this._ip=
c;this._port=b;if(!this._port||0>=this._port)this._port=d.DEFAULT_REMOTE_PORT;this._logger=require("x.logger.js").getLogger("xnm.aio.knx.KNXGateway._Tunnel ("+this._ip+":"+this._port+")");this._localIp=a;this._localPort=f;0>=this._localPort&&(this._localPort=null);this._socket=null;this._requestBuffer=[];this._stateMachine={state:d._STATE.IDLE,stateTimer:null,connectionStateTimer:null,connectionStateAckTimer:null,connection:{id:0,seqNo:0,recvSeqNo:0,hpai:{ip:null,port:0}},close_with_error:null};this._connectStateNackCount=
0};d.TUNNEL_ACK_TIMEOUT=1E3;d.CONNECT_REQUEST_TIMEOUT=1E4;d.CONNECTIONSTATE_REQUEST_INTERVAL=6E4;d.CONNECTIONSTATE_REQUEST_TIMEOUT=1E4;d.MAX_CONNECTIONSTATE_NACK_COUNT=3;d.DEFAULT_REMOTE_PORT=3671;d._STATE={IDLE:0,BINDUDP:1,CONNECT:2,TUNNELLING:3,DISCONNECT:4,CLOSEUDP:5};d.prototype={on:function(c,b){this._eventEmitter.on(c,b)},removeAllListeners:function(){this._eventEmitter.removeAllListeners()},connect:function(){this._fsmConnect()},close:function(){this._fsmClose(!1)},send:function(c,b){if(c){var d=
this._requestBuffer.length;this._requestBuffer.push({cEMI:c,callback:b,retry:!1,timer:null,seqNo:-1});0==d&&this._sendNextReq()}else b&&b(Error("cEMI is null"))},_sendNextReq:function(){if(0!=this._requestBuffer.length){var c=this._requestBuffer[0],b=this._stateMachine.connection.seqNo;-1!=c.seqNo?b=c.seqNo:c.seqNo=b;var a=this;this._send(b,c.cEMI,function(b){b?(c.callback&&c.callback(b),a._requestBuffer.splice(0,1),a._sendNextReq()):c.timer=setTimeout(function(){c.retry?(c.callback&&c.callback(Error("NACK due to timeout")),
a._requestBuffer.splice(0,1),a._fsmClose(!0)):(c.retry=!0,a._sendNextReq())},d.TUNNEL_ACK_TIMEOUT)})}},_send:function(c,b,a){var f=this;switch(this._stateMachine.state){case d._STATE.TUNNELLING:this._logger.log("debug","send cEMI "+b.toBuffer().toString("hex"));var e=(new q.TunnellingRequest(this._stateMachine.connection.id,c,b)).toBuffer();this._logger.log("debug","send TUNNELLING_REQUEST ("+c+") "+e.toString("hex"));this._socket.send(e,0,e.length,this._port,this._ip,function(b){b?f._logger.log("debug",
"send TUNNELLING_REQUEST ("+c+") "+e.toString("hex")+" error:"+b.message):f._logger.log("debug","send TUNNELLING_REQUEST ("+c+") "+e.toString("hex")+" finish");a&&a(null)});break;default:a&&a(Error("Tunnel is not connected"))}},_fsmConnect:function(){this._logger.log("debug","connect to knx");switch(this._stateMachine.state){case d._STATE.IDLE:this._stateMachine.state=d._STATE.BINDUDP,this._startListenerSocket()}},_fsmClose:function(c){this._stateMachine.close_with_error=c;switch(this._stateMachine.state){case d._STATE.IDLE:this._fsmClosed();
break;case d._STATE.BINDUDP:this._stateMachine.state=d._STATE.CLOSEUDP;this._stopListenerSocket();break;case d._STATE.CONNECT:this._clearStateMachineGuard();this._stateMachine.state=d._STATE.CLOSEUDP;this._stopListenerSocket();break;case d._STATE.TUNNELLING:c=(new q.DisconnectRequest(this._stateMachine.connection.id,this._stateMachine.connection.hpai)).toBuffer(),this._logger.log("debug","send DISCONNECT_REQUEST "+c.toString("hex")),this._socket.send(c,0,c.length,this._port,this._ip),this._stateMachine.state=
d._STATE.DISCONNECT,this._clearStateMachineGuard(),this._setStateMachineGuard(1E3,d._STATE.CLOSEUDP)}},_fsmError:function(c){this._eventEmitter.emit("error",c);this._fsmClose(!0)},_fsmUdpListening:function(){this._logger.log("debug","udp socket established");switch(this._stateMachine.state){case d._STATE.BINDUDP:this._stateMachine.state=d._STATE.CONNECT;this._clearStateMachineGuard();var c=this._socket.address(),c={ip:c.address,port:c.port};this._logger.log("debug","send CONNECTION_REQUEST");c=(new q.ConnectionRequest(c,
c)).toBuffer();this._socket.send(c,0,c.length,this._port,this._ip);this._setStateMachineGuard(d.CONNECT_REQUEST_TIMEOUT,d._STATE.TUNNELLING)}},_fsmUdpMessage:function(c){var b=this,a=this._socket.address(),f=q.parseFrame(c);if(f)switch(this._stateMachine.state){case d._STATE.CONNECT:518===f.getType()&&(f.isConnectionStatusOK()?(this._clearStateMachineGuard(),c=f.getConnectionID(),this._logger.log("debug","receive CONNECTION_RESPONSE with connection id "+c),this._stateMachine.connection={},this._stateMachine.connection.id=
c,a={ip:a.address,port:a.port},this._stateMachine.connection.hpai=a,this._stateMachine.connection.seqNo=0,this._stateMachine.connection.recvSeqNo=0,this._stateMachine.state=d._STATE.TUNNELLING,this._sendConnectionStateRequest(),this._onConnected()):(a=f.getConnectionStatus(),c=Error("tunnel connection fail with error:"+a.toString(16)),c.code=a,this._fsmError(c)));break;case d._STATE.TUNNELLING:switch(f.getType()){case 1056:c=f.getConnectionID();if(c===this._stateMachine.connection.id){var e=f.getcEMI(),
h=f.getSeqNo(),m=!1;h==this._stateMachine.connection.recvSeqNo&&(m=!0);if(h==this._stateMachine.connection.recvSeqNo||h==this._stateMachine.connection.recvSeqNo-1)f=new q.TunnellingACK(c,h),a=f.toBuffer(),this._logger.log("trace","send TUNNELLING_ACK ("+h+") "+a.toString("hex")),this._socket.send(a,0,a.length,this._port,this._ip,function(c){try{m&&(e&&e instanceof t.L_Data_Con?(b._logger.log("debug","receive TUNNELLING_REQUEST ("+h+") l_data.con "+e.toBuffer().toString("hex")),b._onMessage(e)):e&&
e instanceof t.L_Data_Ind&&(b._logger.log("debug","receive TUNNELLING_REQUEST ("+h+") l_data.ind "+e.toBuffer().toString("hex")),b._onMessage(e)))}catch(d){}});h!=this._stateMachine.connection.recvSeqNo&&h!=this._stateMachine.connection.recvSeqNo-1||h!=this._stateMachine.connection.recvSeqNo||(this._stateMachine.connection.recvSeqNo++,255<this._stateMachine.connection.recvSeqNo&&(this._stateMachine.connection.recvSeqNo=0))}break;case 1057:c=f.getConnectionID();c===this._stateMachine.connection.id&&
this._onTunnelAck(f);break;case 521:c=f.getConnectionID();a=f.getCtrlEndpointHPAI();c===this._stateMachine.connection.id&&(this._logger.log("debug","receive DISCONNECT_REQUEST"),f=new q.DisconnectResponse(c),a=f.toBuffer(),this._logger.log("debug","send DISCONNECT_RESPONSE "+a.toString("hex")),this._socket.send(a,0,a.length,this._port,this._ip,function(){b._fsmEnd()}));break;case 520:c=f.getConnectionID(),this._logger.log("debug","receive CONNECTIONSTATE_RESPONSE with connection id "+c),this._connectStateNackCount=
0,this._stateMachine.connectionStateAckTimer&&(clearTimeout(this._stateMachine.connectionStateAckTimer),this._stateMachine.connectionStateAckTimer=null,this._stateMachine.connectionStateTimer||(this._stateMachine.connectionStateTimer=setTimeout(function(){b._stateMachine.connectionStateTimer=null;b._sendConnectionStateRequest()},d.CONNECTIONSTATE_REQUEST_INTERVAL)))}break;case d._STATE.DISCONNECT:522===f.getType()&&(c=f.getConnectionID(),c===this._stateMachine.connection.id&&(a=f.isDisconnectOK(),
this._logger.log("debug","receive DISCONNECT_RESPONSE with status "+(a?"OK":"NOK")),this._clearStateMachineGuard(),this._stateMachine.state=d._STATE.CLOSEUDP,b._stopListenerSocket()))}},_fsmEnd:function(){this._stateMachine.state=d._STATE.CLOSEUDP;this._eventEmitter.emit("end");this._stateMachine.close_with_error=!1;this._stopListenerSocket()},_fsmClosed:function(){this._stateMachine.state=d._STATE.IDLE;var c=this._stateMachine.close_with_error;this._socket&&this._socket.removeAllListeners();this._socket=
null;this._clearRequestBuffer();this._resetStateMachine();this._eventEmitter.emit("close",c)},_onConnected:function(){this._eventEmitter.emit("connect")},_onMessage:function(c){this._eventEmitter.emit("message",c)},_onTunnelAck:function(c){var b=c.getSeqNo();c=c.isOK();this._logger.log("debug","receive TUNNELLING_ACK ("+b+") with status "+(c?"OK":"NOK"));b==this._stateMachine.connection.seqNo&&(b=this._requestBuffer[0],b.timer&&clearTimeout(b.timer),b.callback&&b.callback(c?null:Error("NACK")),this._stateMachine.connection.seqNo+=
1,255<this._stateMachine.connection.seqNo&&(this._stateMachine.connection.seqNo=0),this._requestBuffer.splice(0,1),this._sendNextReq())},_clearRequestBuffer:function(){for(var c=0;c<this._requestBuffer.length;c++){var b=this._requestBuffer[c];b&&(b.timer&&clearTimeout(b.timer),b.callback&&b.callback(Error("NACK due to tunnel closed")))}this._requestBuffer=[]},_setStateMachineGuard:function(c,b){var a=this;this._stateMachine.stateTimer=setTimeout(function(){var c=a._stateMachine.state;if(c===d._STATE.DISCONNECT&&
b===d._STATE.CLOSEUDP)a._stateMachine.state=d._STATE.CLOSEUDP,a._stopListenerSocket();else if(c!==b){var e="",e=3==b?"receive CONNECTION_RESPONSE timeout":"knx tunnel receive data timeout in "+c;a._logger.log("warn",e);a._fsmError(Error(e))}},c)},_clearStateMachineGuard:function(){this._stateMachine.stateTimer&&clearTimeout(this._stateMachine.stateTimer)},_sendConnectionStateRequest:function(){var c=this,b=(new q.ConnectionStateRequest(this._stateMachine.connection.id,this._stateMachine.connection.hpai)).toBuffer();
this._logger.log("debug","send CONNECTIONSTATE_REQUEST "+b.toString("hex")+" with connection id "+this._stateMachine.connection.id);this._socket.send(b,0,b.length,this._port,this._ip);this._stateMachine.connectionStateAckTimer&&(clearTimeout(this._stateMachine.connectionStateAckTimer),this._stateMachine.connectionStateAckTimer=null);this._stateMachine.connectionStateAckTimer=setTimeout(function(){c._connectStateNackCount++;c._connectStateNackCount<d.MAX_CONNECTIONSTATE_NACK_COUNT&&c._stateMachine.state===
d._STATE.TUNNELLING?(c._logger.log("warn","receive CONNECTIONSTATE_RESPONSE timeout"),c._sendConnectionStateRequest()):(c._logger.log("warn","tunnel break due to CONNECTIONSTATE_RESPONSE timeout"),c._fsmError(Error("tunnel break")))},d.CONNECTIONSTATE_REQUEST_TIMEOUT)},_resetStateMachine:function(){this._stateMachine.stateTimer&&clearTimeout(this._stateMachine.stateTimer);this._stateMachine.connectionStateTimer&&clearTimeout(this._stateMachine.connectionStateTimer);this._stateMachine.connectionStateAckTimer&&
clearTimeout(this._stateMachine.connectionStateAckTimer);this._stateMachine={state:d._STATE.IDLE,stateTimer:null,connectionStateTimer:null,connectionStateAckTimer:null,socket:null,connection:{id:0,seqNo:0,hpai:{ip:null,port:0}},close_with_error:null}},_startListenerSocket:function(){this._logger.log("trace","{UDP Socket} start knx upd listener on "+this._localIp);var c=this;this._socket=dgram.createSocket("udp4");this._socket.on("listening",function(){c._socket.addMembership("224.0.23.12");var b=
c._socket.address();c._logger.log("trace","{UDP Socket} knx listening "+b.address+":"+b.port);c._fsmUdpListening()});this._socket.on("close",function(){c._logger.log("trace","{UDP Socket} control socket closed");c._fsmClosed()});this._socket.on("error",function(b){c._logger.log("trace","{UDP Socket} control socket error: "+b.stack);c._fsmError(b)});this._socket.on("message",function(b,d){var a=c._socket.address();c._logger.log("trace","{UDP Socket} receive data "+b.toString("hex")+" from "+d.address+
":"+d.port+" @local "+a.address+":"+a.port);c._fsmUdpMessage(b)});this._socket.bind(null,this._localIp)},_stopListenerSocket:function(){this._logger.log("trace","{UDP Socket} stop knx upd listener");this._socket.close()}};return d}(),q=function(){var d=function(b,c){b&&c&&(this._logger=Logger.getLogger("xnm.aio.KNXGateway.IPFrame"),this._buffer=new Buffer(6+c.length),this._buffer.writeUInt16BE(1552,0),this._buffer.writeUInt16BE(b,2),this._buffer.writeUInt16BE(6+c.length,4),c.copy(this._buffer,6))};
d._logger=Logger.getLogger("xnm.aio.KNXGateway.IPFrame");d.parseFrame=function(c){var a=null;if(6>c.length)return d._logger.log("debug","data is too short"),null;var e=c.readUInt16BE(0);if(1552!==e)return d._logger.log("debug","data header&version is invalid:"+e),null;e=c.readUInt16BE(4);if(e>c.length)return d._logger.log("debug","data length in header is larger than actual size:"+e),null;var g=c.readUInt16BE(2);switch(g){case 514:14<=e&&(a=new b);break;case 518:8<=e&&(a=new f);break;case 520:8<=
e&&(a=new h);break;case 1057:10<=e&&(a=new l);break;case 1056:6<=e&&(a=new m);break;case 521:16<=e&&(a=new k);break;case 522:8<=e&&(a=new w);break;default:d._logger.log("debug","data type is unknow:"+g)}a&&(a._buffer=c);return a};d.prototype.getType=function(){return this._buffer.readUInt16BE(2)};d.prototype.getSize=function(){return this._buffer.readUInt16BE(4)};d.prototype.toBuffer=function(){return this._buffer};var c=function(b){var c=new Buffer(8);c.writeUInt16BE(2049,0);c.writeInt32BE(n(b.ip),
2);c.writeUInt16BE(b.port,6);d.call(this,513,c)};c.prototype=new d;c.prototype.constructor=c;var b=function(){d.call(this)};b.prototype=new d;b.prototype.constructor=b;b.prototype.getCtrlEndpointHPAI=function(){var b=this._buffer.readUInt32BE(8),b=p(b),c=this._buffer.readUInt16BE(12),d={};d.ip=b;d.port=c;return d};b.prototype.getSerialNumber=function(){var b=(this._buffer.readUInt8(22)<<16)+(this._buffer.readUInt8(23)<<8)+this._buffer.readUInt8(24),c=(this._buffer.readUInt8(25)<<16)+(this._buffer.readUInt8(26)<<
8)+this._buffer.readUInt8(27);return b+""+c};b.prototype.getRoutingMulticastAddress=function(){return this._buffer.readUInt8(28)+"."+this._buffer.readUInt8(29)+"."+this._buffer.readUInt8(30)+"."+this._buffer.readUInt8(31)};b.prototype.getMAC=function(){return this._buffer.toString("hex",32,38)};b.prototype.getName=function(){return this._buffer.toString("utf8",38,68)};b.prototype.toJSON=function(){return{hapi:this.getCtrlEndpointHPAI(),structure_length:this._buffer.readUInt8(14),desciprtion_type_code:this._buffer.readUInt8(15),
knx_medium:this._buffer.readUInt8(16),device_status:this._buffer.readUInt8(17),physical_address:this._buffer.readUInt16BE(18),project_installation_id:this._buffer.readUInt16BE(20),serial_number:this.getSerialNumber(),routing_multicast_address:this.getRoutingMulticastAddress(),mac:this.getMAC(),name:this.getName()}};var a=function(b,c){var a=new Buffer(20);a.writeUInt16BE(2049,0);a.writeInt32BE(n(b.ip),2);a.writeUInt16BE(b.port,6);a.writeUInt16BE(2049,8);a.writeInt32BE(n(c.ip),10);a.writeUInt16BE(c.port,
14);a.writeUInt8(4,16);a.writeUInt8(4,17);a.writeUInt8(2,18);a.writeUInt8(0,19);d.call(this,517,a)};a.prototype=new d;a.prototype.constructor=a;var f=function(){d.call(this)};f.prototype=new d;f.prototype.constructor=f;f.prototype.getConnectionID=function(){return this._buffer.readUInt8(6)};f.prototype.isConnectionStatusOK=function(){return 0===this._buffer.readUInt8(7)};f.prototype.getCtrlEndpointHPAI=function(){var b=this._buffer.readUInt32BE(10),b=p(b),c=this._buffer.readUInt16BE(14),d={};d.ip=
b;d.port=c;return d};f.prototype.getCRD=function(){return this._buffer.readUInt32BE(16)};f.prototype.getConnectionStatus=function(){return this._buffer.readUInt8(7)};var e=function(b,c){var a=new Buffer(10);a.writeUInt8(b,0);a.writeUInt8(0,1);a.writeUInt16BE(2049,2);a.writeInt32BE(n(c.ip),4);a.writeUInt16BE(c.port,8);d.call(this,519,a)};e.prototype=new d;e.prototype.constructor=e;var h=function(){d.call(this)};h.prototype=new d;h.prototype.constructor=h;h.prototype.getConnectionID=function(){return this._buffer.readUInt8(6)};
h.prototype.isConnectionStatusOK=function(){return 0===this._buffer.readUInt8(7)};var m=function(b,c,a){if(null!==b&&void 0!==b&&null!==c&&void 0!==c&&a){var e=new Buffer(4+a.getLength());e.writeUInt8(4,0);e.writeUInt8(b,1);e.writeUInt8(c,2);e.writeUInt8(0,3);a.toBuffer().copy(e,4);d.call(this,1056,e)}else d.call(this)};m.prototype=new d;m.prototype.constructor=m;m.prototype.getConnectionID=function(){return this._buffer.readUInt8(7)};m.prototype.getSeqNo=function(){return this._buffer.readUInt8(8)};
m.prototype.getcEMI=function(){var b=this._buffer.readUInt16BE(4)-6-4,b=new Buffer(b);this._buffer.copy(b,0,10);return t.parseFrame(b)};var l=function(b,c){if(b){var a=new Buffer(4);a.writeUInt8(4,0);a.writeUInt8(b,1);a.writeUInt8(c,2);a.writeUInt8(0,3);d.call(this,1057,a)}else d.call(this)};l.prototype=new d;l.prototype.constructor=l;l.prototype.getConnectionID=function(){return this._buffer.readUInt8(7)};l.prototype.getSeqNo=function(){return this._buffer.readUInt8(8)};l.prototype.isOK=function(){return 0===
this._buffer.readUInt8(9)};var k=function(b,c){if(b&&null!==c){var a=new Buffer(10);a.writeUInt8(b,0);a.writeUInt8(0,1);a.writeUInt8(8,2);a.writeUInt8(1,3);a.writeInt32BE(n(c.ip),4);a.writeUInt16BE(c.port,8);d.call(this,521,a)}else d.call(this)};k.prototype=new d;k.prototype.constructor=k;k.prototype.getConnectionID=function(){return this._buffer.readUInt8(6)};k.prototype.getCtrlEndpointHPAI=function(){var b=this._buffer.readUInt32BE(10),b=p(b),c=this._buffer.readUInt16BE(14),a={};a.ip=b;a.port=c;
return a};var w=function(b){if(b){var c=new Buffer(2);c.writeUInt8(b,0);c.writeUInt8(0,1);d.call(this,1057,c)}else d.call(this)};w.prototype=new d;w.prototype.constructor=w;w.prototype.getConnectionID=function(){return this._buffer.readUInt8(6)};w.prototype.isDisconnectOK=function(){return 0===this._buffer.readUInt8(7)};d.SearchRequest=c;d.SearchResponse=b;d.ConnectionRequest=a;d.ConnectionResponse=f;d.ConnectionStateRequest=e;d.ConnectionStateResponse=h;d.TunnellingRequest=m;d.TunnellingACK=l;d.DisconnectRequest=
k;d.DisconnectResponse=w;return d}(),t=function(){var d=function(b){this._buffer=b};d.parseFrame=function(c){var a=null;switch(c.readUInt8(0)){case b.MSG_CODE:a=new b;break;case g.MSG_CODE:a=new g}a&&(a._buffer=c);return a};d.prototype={getLength:function(){return this._buffer.length},getSrcAddr:function(){return this._buffer.readUInt16BE(4)},getDstAddr:function(){return this._buffer.readUInt16BE(6)},getDataLength:function(){return this._buffer.readUInt8(8)},getAPDU:function(){var b=this.getDataLength()+
1,b=new Buffer(b);this._buffer.copy(b,0,9,9+b.length);return a.parse(b)},toBuffer:function(){return this._buffer}};var c=function(b,c){var a=new Buffer(9+c.getLength());a.writeUInt8(17,0);a.writeUInt8(0,1);a.writeUInt8(188,2);a.writeUInt8(224,3);a.writeUInt8(0,4);a.writeUInt8(0,5);a.writeInt16BE(b,6);a.writeUInt8(c.getLength()-1,8);c.toBuffer().copy(a,9);this._buffer=a};c.MSG_CODE=17;c.prototype=new d;c.prototype.constructor=c;var b=function(){this._buffer=void 0};b.MSG_CODE=46;b.prototype=new d;
b.prototype.constructor=b;var g=function(){this._buffer=void 0};g.MSG_CODE=41;g.prototype=new d;g.prototype.constructor=g;d.L_Data_Req=c;d.L_Data_Con=b;d.L_Data_Ind=g;return d}(),a=function(){var a=function(c,b,a){b||(b=0);c||(c=0);var d=1;a&&1<a.length&&(d=a.length);this._buffer=new Buffer(1+d);this._buffer.writeUInt8(c|b>>2,0);c=a&&0<a.length?a.readUInt8(0):0;this._buffer.writeUInt8(b<<6|c,1);a&&1<a.length&&a.copy(this._buffer,2,1)};a.parse=function(c){var b=new a;b._buffer=c;return b};a.prototype=
{getLength:function(){return this._buffer.length},getAPCI:function(){var a=this._buffer.readUInt8(0),b=this._buffer.readUInt8(1);return(a&3)<<2|(b&192)>>6&3},getData:function(){var a=this._buffer.length-1,b=this._buffer.readUInt8(1),d=new Buffer(a);d.writeUInt8(b&63,0);1<a&&this._buffer.copy(d,1,2);return d},toBuffer:function(){return this._buffer}};return a}();l._DataLink=v;l._Tunnel=u;l.IPFrame=q;l.cEMI=t;l.APDU=a;return l}();
xnm.aio.knx.KNXGateway._DPT=function(){var n=function(a){this.type=a};n.resolve=function(a){if(!a||3>=a.length)return null;var d=a.indexOf("-");if(0>=d)return null;var c=a.substring(0,d);if("DPT"==c){if(5>a.length)return null;c=a}else if("DPST"==c){d=a.indexOf("-",d+1);if(0>d)return null;c=a.substring(0,d)}else return null;switch(c){case "DPT-1":case "DPST-1":return new p(a);case "DPT-2":case "DPST-2":return new r(a);case "DPT-3":case "DPST-3":return new l(a);case "DPT-5":case "DPST-5":return new v(a);
case "DPT-6":case "DPST-6":return new u(a);case "DPT-9":case "DPST-9":return new q(a);case "DPT-20":case "DPST-20":return new t(a)}return null};n.prototype.doCommand=function(a,d,c,b){b&&b()};n.prototype.setValue=function(a,d,c,b){a&&a instanceof Buffer?d._sendCommand(c,a,function(a){b&&b(a)}.bind(this)):b&&b(Error("invalid value"))};n.prototype.getValue=function(a,d,c){a._getState(d,function(b,a){b?c&&c(b):c&&c(null,this._resolveData(a))}.bind(this))};n.prototype._resolveDataRaw=function(a){return a.toString("hex")};
n.prototype._resolveData=function(a){return a.toString("hex")};var p=function(a){this.type=a};p.prototype=new n;p.prototype.constructor=p;p.prototype.doCommand=function(a,d,c,b){if(a){var g=0;if(0==a.indexOf("setValue")){if(g=parseInt(a.substr(8)),!g||isNaN(g))g=0}else switch(a){case "on":case "true":case "enable":case "ramp":case "alarm":case "high":case "increase":case "down":case "close":case "start":case "active":case "inverted":g=1;break;case "off":case "false":case "disable":case "no_ramp":case "no_alarm":case "low":case "decrease":case "up":case "open":case "stop":case "inactive":case "not_inverted":g=
0;break;default:b&&b(Error("unknown command:"+a));return}this.setValue(g,d,c,b)}else b&&b(Error("unknown command:"+a))};p.prototype.setValue=function(a,d,c,b){var g=null,g=0==a||1==a?new Buffer([a]):a;n.prototype.setValue.call(this,g,d,c,function(a){b&&b(a)}.bind(this))};p.prototype._resolveDataRaw=function(a){return a.readUInt8(0)};p.prototype._resolveData=function(a){a=a.readUInt8(0);return this._resolveValue(a)};p.prototype._resolveValue=function(a){switch(this.type){case "DPT-1":case "DPST-1-1":return a?
"on":"off";case "DPST-1-2":return a?"true":"false";case "DPST-1-3":return a?"enable":"disable";case "DPST-1-4":return a?"ramp":"no_ramp";case "DPST-1-5":return a?"alarm":"no alarm";case "DPST-1-6":return a?"high":"low";case "DPST-1-7":return a?"increase":"decrease";case "DPST-1-8":return a?"down":"up";case "DPST-1-9":return a?"close":"open";case "DPST-1-10":return a?"start":"stop";case "DPST-1-11":return a?"active":"inactive";case "DPST-1-12":return a?"inverted":"not_inverted";case "DPST-1-13":return a?
"cyclically":"start/stop";case "DPST-1-14":return a?"calculated":"fixed";case "DPST-1-15":return a?"reset command":"no action";case "DPST-1-16":return a?"acknowledge command":"no action";case "DPST-1-18":return a?"occupied":"not occupied";case "DPST-1-19":return a?"open":"closed";case "DPST-1-21":return a?"logical function AND":"logical function OR";case "DPST-1-22":return a?"scene B":"scene A";case "DPST-1-23":return a?"move Up/Down +StepStop mode (blind)":"only move Up/Down mode (shutter)";default:return null}};
var r=function(a){this.type=a};r.prototype=new n;r.prototype.constructor=r;r.prototype.doCommand=function(a,d,c,b){if(a){var g=0;if(0==a.indexOf("setValue")){a.substr(0,8);g=parseInt(a.substr(8));if(!g||isNaN(g))g=0;this.setValue(g,d,c,b)}else{var f=a.split(".");if(2>f.length)b&&b(Error("unknown command:"+a));else{g="prio"==f[0]?1:0;switch(f[1]){case "on":case "true":case "enable":case "ramp":case "alarm":case "high":case "increase":case "down":case "close":case "start":case "active":case "inverted":g=
g<<1|1;break;case "off":case "false":case "disable":case "no_ramp":case "no_alarm":case "low":case "decrease":case "up":case "open":case "stop":case "inactive":case "not_inverted":g=g<<1|0;break;default:b&&b(Error("unknown command:"+a));return}this.setValue(g,d,c,b)}}}else b&&b(Error("unknown command:"+a))};r.prototype.setValue=function(a,d,c,b){var g=null,g=0==a||1==a||2==a||3==a?new Buffer([a]):a;n.prototype.setValue.call(this,g,d,c,function(a){b&&b(a)}.bind(this))};r.prototype._resolveDataRaw=
function(a){return a.readUInt8(0)};r.prototype._resolveData=function(a){a=a.readUInt8(0);return this._resolveValue(a)};r.prototype._resolveValue=function(a){var d="",d=1==a>>1?"prio.":"no_prio.";switch(this.type){case "DPT-2":d=a;break;case "DPST-2-1":d+=a&1?"on":"off";break;case "DPST-2-2":d+=a&1?"true":"false";break;case "DPST-2-3":d+=a&1?"enable":"disable";break;case "DPST-2-4":d+=a&1?"ramp":"no_ramp";break;case "DPST-2-5":d+=a&1?"alarm":"no alarm";break;case "DPST-2-6":d+=a&1?"high":"low";break;
case "DPST-2-7":d+=a&1?"increase":"decrease";break;case "DPST-2-8":d+=a&1?"down":"up";break;case "DPST-2-9":d+=a&1?"close":"open";break;case "DPST-2-10":d+=a&1?"start":"stop";break;case "DPST-2-11":d+=a&1?"active":"inactive";break;case "DPST-2-12":d+=a&1?"inverted":"not_inverted";break;default:return null}return d};var l=function(a){this.type=a};l.prototype=new n;l.prototype.constructor=l;l.prototype.doCommand=function(a,d,c,b){if(a){var g=null,f=0;if(0==a.indexOf("setValue")){a.substr(0,8);f=parseInt(a.substr(8));
if(!f||isNaN(f))f=0;this.setValue(f,d,c,b)}else{if("stepUpStop"==a||"stepDownStop"==a)g=a,f=0;else if(0==a.indexOf("stepUp")){if(g=a.substr(0,6),f=parseInt(a.substr(6)),!f||isNaN(f))f=1}else 0==a.indexOf("stepDown")&&(g=a.substr(0,8),f=parseInt(a.substr(8)),!f||isNaN(f))&&(f=1);a=0;var e=this._getStepcode(f);if(-1==e)b&&b(Error("invalid step precent:"+f));else{switch(g){case "stepUp":a=1;if(0>=e){b&&b(Error("stepUp command value invalid"));return}break;case "stepDown":a=0;if(0>=e){b&&b(Error("stepDown command value invalid"));
return}break;case "stepUpStop":a=1;break;case "stepDownStop":a=0;break;default:b&&b(Error("unknown command:"+g));return}this.setValue(a<<3|e,d,c,b)}}}else b&&b(Error("unknown command:"+a))};l.prototype.setValue=function(a,d,c,b){0>a&&(a=0);15<a&&(a=15);a=new Buffer([a]);n.prototype.setValue.call(this,a,d,c,function(a){b&&b(a)}.bind(this))};l.prototype._resolveDataRaw=function(a){return a.readUInt8(0)};l.prototype._resolveData=function(a){a=a.readUInt8(0);return this._resolveValue(a)};l.prototype._resolveValue=
function(a){var d=a&7,c=0;0==d?c=0:1==d?c=100:2==d?c=50:3==d?c=25:4==d?c=12:5==d?c=6:6==d?c=3:7==d&&(c=1);return{direction:a&8?"up":"down",precent:c,stepcode:d}};l.prototype._getStepcode=function(a){switch(a){case 0:return 0;case 1:return 7;case 3:return 6;case 6:return 5;case 12:return 4;case 25:return 3;case 50:return 2;case 100:return 1;default:return-1}};var v=function(a){this.type=a};v.prototype=new n;v.prototype.constructor=v;v.prototype.doCommand=function(a,d,c,b){if(a){var g=a,f=0;0==a.indexOf("setValue")&&
(g=a.substr(0,8),f=parseInt(a.substr(8)),!f||isNaN(f))&&(f=0);switch(g){case "setValue":break;case "up":case "down":a=null;a="up"==g?this._getBuffer(255):this._getBuffer(0);if(!a){b&&b(Error("invalid value"));return}n.prototype.setValue.call(this,a,d,c,function(a){b&&b(a)}.bind(this));return;default:b&&b(Error("unknown command:"+g));return}this.setValue(f,d,c,b)}else b&&b(Error("unknown command:"+a))};v.prototype.setValue=function(a,d,c,b){switch(this.type){case "DPST-5-1":0>a&&(a=0);100<a&&(a=100);
a=Math.round(a/100*255);break;case "DPST-5-3":0>a&&(a=0);360<a&&(a=360);a=Math.round(a/360*255);break;case "DPST-5-6":0>a&&(a=0);254<a&&(a=254);a=Math.round(a/360*255);break;default:0>a&&(a=0),255<a&&(a=255)}(a=this._getBuffer(a))?n.prototype.setValue.call(this,a,d,c,function(a){b&&b(a)}.bind(this)):b&&b(Error("invalid value"))};v.prototype.incValue=function(a,d,c,b,g){d=this._resolveValue(d);this.setValue(d+a,c,b,g)};v.prototype.decValue=function(a,d,c,b,g){d=this._resolveValue(d);this.setValue(d-
a,c,b,g)};v.prototype._resolveDataRaw=function(a){return!a||2>a.length?null:a.readUInt8(1)};v.prototype._resolveData=function(a){if(!a||2>a.length)return null;a=a.readUInt8(1);return this._resolveValue(a)};v.prototype._resolveValue=function(a){switch(this.type){case "DPST-5-1":return Math.round(a/255*100);case "DPST-5-3":return Math.round(a/255*360);default:return a}};v.prototype._getBuffer=function(a){var d=new Buffer(2);d.writeUInt8(0,0);d.writeUInt8(a,1);return d};var u=function(a){this.type=a};
u.prototype=new n;u.prototype.constructor=u;u.prototype.doCommand=function(a,d,c,b){if(a){var g=a,f=0;0==a.indexOf("setValue")&&(g=a.substr(0,8),f=parseInt(a.substr(8)),!f||isNaN(f))&&(f=0);switch(g){case "setValue":break;default:b&&b(Error("unknown command:"+g));return}this.setValue(f,d,c,b)}else b&&b(Error("unknown command:"+a))};u.prototype.setValue=function(a,d,c,b){switch(this.type){default:-128>a&&(a=-128),127<a&&(a=127),0>a&&(a+=256)}(a=this._getBuffer(a))?n.prototype.setValue.call(this,a,
d,c,function(a){b&&b(a)}.bind(this)):b&&b(Error("invalid value"))};u.prototype.incValue=function(a,d,c,b,g){d=this._resolveValue(d);this.setValue(d+a,c,b,g)};u.prototype.decValue=function(a,d,c,b,g){d=this._resolveValue(d);this.setValue(d-a,c,b,g)};u.prototype._resolveDataRaw=function(a){return!a||2>a.length?null:a.readUInt8(1)};u.prototype._resolveData=function(a){if(!a||2>a.length)return null;a=a.readUInt8(1);return this._resolveValue(a)};u.prototype._resolveValue=function(a){switch(this.type){default:return 127<
a&&(a-=256),a}};u.prototype._getBuffer=function(a){var d=new Buffer(2);d.writeUInt8(0,0);d.writeUInt8(a,1);return d};var q=function(a){this.type=a};q.prototype=new n;q.prototype.constructor=q;q.prototype.doCommand=function(a,d,c,b){if(a){var g=null,f=0;0==a.indexOf("setValue")&&(g=a.substr(0,8),f=parseFloat(a.substr(8)),!f||isNaN(f))&&(f=0);switch(g){case "setValue":break;default:b&&b(Error("unknown command:"+g));return}this.setValue(f,d,c,b)}else b&&b(Error("unknown command:"+a))};q.prototype.setValue=
function(a,d,c,b){switch(this.type){case "DPT-9":-671088.64>a&&(a=-671088.64);670760.96<a&&(a=670760.96);a=this._float2short(a);break;case "DPST-9-1":-273>a&&(a=-273);670760<a&&(a=670760);a=this._float2short(a);break;default:a=this._float2short(a)}(a=this._getBuffer(a))?n.prototype.setValue.call(this,a,d,c,function(a){b&&b(a)}.bind(this)):b&&b(Error("invalid value"))};q.prototype.incValue=function(a,d,c,b,g){d=this._resolveValue(d);this.setValue(d+a,c,b,g)};q.prototype.decValue=function(a,d,c,b,g){d=
this._resolveValue(d);this.setValue(d-a,c,b,g)};q.prototype._resolveDataRaw=function(a){return!a||3>a.length?0:a.readUInt16BE(1)};q.prototype._resolveData=function(a){if(!a||3>a.length)return 0;a=a.readUInt16BE(1);return this._resolveValue(a)};q.prototype._resolveValue=function(a){switch(this.type){case "DPT-9":case "DPST-9-1":return parseFloat(this._short2float(a).toFixed(2));default:return parseFloat(this._short2float(a).toFixed(2))}};q.prototype._getBuffer=function(a){var d=new Buffer(3);d.writeUInt8(0,
0);d.writeUInt16BE(a,1);return d};q.prototype._float2short=function(a){var d=0<=a?0:1;1==d&&(a=0-a);var c=Math.floor(Math.log(a)/Math.LN2);a=Math.round(a/Math.pow(2,c)*100);1==d&&(a=0-a);0>a&&(a+=4096);return a&2047|c<<11|d<<15};q.prototype._short2float=function(a){var d=a>>15&1,c=a&2047|d<<11;1==d&&(c-=4096);return.01*c*Math.pow(2,a>>11&15)};var t=function(a){this.type=a};t.prototype=new n;t.prototype.constructor=t;t.prototype.doCommand=function(a,d,c,b){if(a){var g=a,f=0;0==a.indexOf("setValue")&&
(g=a.substr(0,8),f=parseInt(a.substr(8)),!f||isNaN(f))&&(f=0);switch(g){case "auto":f=0;break;case "comfort":f=1;break;case "standby":f=2;break;case "economy":f=3;break;case "protection":f=4;break;case "setValue":break;default:b&&b(Error("unknown command:"+g));return}this.setValue(f,d,c,b)}else b&&b(Error("unknown command:"+a))};t.prototype.setValue=function(a,d,c,b){(a=this._getBuffer(a))?n.prototype.setValue.call(this,a,d,c,function(a){b&&b(a)}.bind(this)):b&&b(Error("invalid value"))};t.prototype.incValue=
function(a,d,c,b,g){d=this._resolveValue(d);d=d.value+a;this.setValue(d,c,b,g)};t.prototype.decValue=function(a,d,c,b,g){d=this._resolveValue(d);d=d.value-a;this.setValue(d,c,b,g)};t.prototype._resolveDataRaw=function(a){return!a||2>a.length?null:a.readUInt8(1)};t.prototype._resolveData=function(a){if(!a||2>a.length)return null;a=a.readUInt8(1);return this._resolveValue(a)};t.prototype._resolveValue=function(a){switch(this.type){case "DPT-20":break;case "DPST-20-1":switch(a){case 0:a="autonomous";
break;case 1:a="slave";break;case 2:a="master";break;default:a="unknow"}break;case "DPST-20-102":switch(a){case 0:a="auto";break;case 1:a="comfort";break;case 2:a="standby";break;case 3:a="economy";break;case 4:a="protection";break;default:a="unknow"}break;default:return null}return a};t.prototype._getBuffer=function(a){var d=new Buffer(2);d.writeUInt8(0,0);d.writeUInt8(a,1);return d};n.DPT1=p;n.DPT2=r;n.DPT3=l;n.DPT5=v;n.DPT6=u;n.DPT9=q;n.DPT20=t;return n}();
xnm.aio.knx.KNXGateway._Device=function(){var n=function(a){this._device=a};n.resolve=function(d){if(!d)return null;var c=null;switch(d.data){case "outlet":c=new r(d);break;case "lighting":c=new l(d);break;case "blind":c=new v(d);break;case "shutter":c=new u(d);break;case "heater":c=new q(d);break;case "1bit":c=new t(d);break;case "1byte":c=new a(d);break;case "general":c=new p(d)}return c};n.prototype={getDefaultChannel:function(){return null},executeCommand:function(a,c,b){this._parseCommand(a,
function(a,d,e,h){a?b&&b(a):(a=h.ga,(d=xnm.aio.knx.KNXGateway._DPT.resolve(h.type))?d.doCommand(e,c,a,function(a){b&&b(a)}.bind(this)):b&&b(Error("unknown actuator type:"+h.type)))})},_parseCommand:function(a,c){if(this._device)if(a){var b=a.indexOf("@");if(-1==b)c&&c(Error("command format invalid"));else{var g=a.substr(0,b),b=a.substr(b+1);g||(g=this.getDefaultChannel());if(this._device.channels&&this._device.channels[g]){var f=this._device.channels[g];f.actuator&&f.actuator.ga&&f.actuator.type?
xnm.aio.knx.KNXGateway._DPT.resolve(f.actuator.type)?c&&c(null,g,b,f.actuator):c&&c(Error("unknown actuator type:"+f.actuator.type)):c&&c(Error("device has no actuator for channel:"+g))}else c&&c(Error("device has no channel with id:"+g))}}else c&&c(Error("command is null"));else c&&c(Error("device is null"))},getStates:function(a){if(!this._device||!this._device.channels)return null;var c=null,b;for(b in this._device.channels)if(this._device.channels.hasOwnProperty(b)){var g=this.getState(b,a);g&&
!g.error&&(c||(c={}),null==g.resolvedValue?c[b]={state:g.resolvedValue,raw:g.resolvedRawValue}:"object"==typeof g.resolvedValue?(c[b]=JSON.parse(JSON.stringify(g.resolvedValue)),c[b].raw=g.resolvedRawValue):c[b]={state:g.resolvedValue,raw:g.resolvedRawValue})}return c},getState:function(a,c){return this._getBufferedState(a,c)},_getBufferedState:function(a,c){var b={error:null,bufferedValue:null,resolvedRawValue:null,resovledValue:null};if(!this._device)return b.error=Error("device is null"),b;a||
(a=this.getDefaultChannel());if(!this._device.channels||!this._device.channels[a])return b.error=Error("device has no channel with id:"+a),b;var g=this._device.channels[a],f,e=null,h=null,m=null,l=c.getStateBuffer();g.event&&g.event.ga&&(e=l.getState(xnm.aio.knx.KNXGateway._adr2long(g.event.ga)))&&(f=xnm.aio.knx.KNXGateway._DPT.resolve(g.event.type))&&(m=f._resolveDataRaw(e),h=f._resolveData(e));("undefined"==typeof e||null==e)&&g.status&&g.status.ga&&(e=l.getState(xnm.aio.knx.KNXGateway._adr2long(g.status.ga)))&&
(f=xnm.aio.knx.KNXGateway._DPT.resolve(g.status.type))&&(m=f._resolveDataRaw(e),h=f._resolveData(e));if(("undefined"==typeof e||null==e)&&g.status&&g.status.ga){f=l.getStateReqTime(xnm.aio.knx.KNXGateway._adr2long(g.status.ga));var k=new Date;if(!f||k.getTime()-f.getTime()>xnm.aio.knx.KNXGateway.STATES_REQ_EXPIRED)l.setStateReqTime(xnm.aio.knx.KNXGateway._adr2long(g.status.ga),k),(f=xnm.aio.knx.KNXGateway._DPT.resolve(g.status.type))&&f.getValue(c,g.status.ga)}b.bufferedValue=e;b.resolvedRawValue=
m;b.resolvedValue=h;return b},refreshStates:function(a){if(!this._device||!this._device.channels)return null;var c=a.getStateBuffer(),b;for(b in this._device.channels)if(this._device.channels.hasOwnProperty(b)){var g=this._device.channels[b];if(g.status&&g.status.ga&&g.status.type){var f=xnm.aio.knx.KNXGateway._DPT.resolve(g.status.type);if(f){var e=new Date;c.setStateReqTime(xnm.aio.knx.KNXGateway._adr2long(g.status.ga),e);f.getValue(a,g.status.ga)}}}return null}};var p=function(a){this._device=
a};p.prototype=new n;p.prototype.constructor=p;p.prototype.executeCommand=function(a,c,b){if("refreshStates"==a)this.refreshStates(c),b&&b();else{var g=this;this._parseCommand(a,function(a,d,h,m){if(a)b&&b(a);else{a=m.ga;var l,k;m=xnm.aio.knx.KNXGateway._DPT.resolve(m.type);if(m instanceof xnm.aio.knx.KNXGateway._DPT.DPT1)switch(h){case "toggle":d=g.getState(d,c);if(d.err||!d.bufferedValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.bufferedValue.readUInt8(0);m.setValue(d?0:1,c,a,function(a){b&&
b(a)}.bind(this));break;default:m.doCommand(h,c,a,b)}else if(m instanceof xnm.aio.knx.KNXGateway._DPT.DPT2)m.doCommand(h,c,a,b);else if(m instanceof xnm.aio.knx.KNXGateway._DPT.DPT3)m.doCommand(h,c,a,b);else if(m instanceof xnm.aio.knx.KNXGateway._DPT.DPT5){l=h;if(0==h.indexOf("inc")){if(l=h.substr(0,3),k=parseInt(h.substr(3)),!k||isNaN(k))k=1}else 0==h.indexOf("dec")&&(l=h.substr(0,3),k=parseInt(h.substr(3)),!k||isNaN(k))&&(k=1);switch(l){case "inc":d=g.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||
null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;m.incValue(k,d,c,a,function(a){b&&b(a)}.bind(this));break;case "dec":d=g.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;m.decValue(k,d,c,a,function(a){b&&b(a)}.bind(this));break;default:m.doCommand(h,c,a,b)}}else if(m instanceof xnm.aio.knx.KNXGateway._DPT.DPT6){l=h;if(0==h.indexOf("inc")){if(l=
h.substr(0,3),k=parseInt(h.substr(3)),!k||isNaN(k))k=1}else 0==h.indexOf("dec")&&(l=h.substr(0,3),k=parseInt(h.substr(3)),!k||isNaN(k))&&(k=1);switch(l){case "inc":d=g.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;m.incValue(k,d,c,a,function(a){b&&b(a)}.bind(this));break;case "dec":d=g.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));
break}d=d.resolvedRawValue;m.decValue(k,d,c,a,function(a){b&&b(a)}.bind(this));break;default:m.doCommand(h,c,a,b)}}else if(m instanceof xnm.aio.knx.KNXGateway._DPT.DPT9){l=h;if(0==h.indexOf("inc")){if(l=h.substr(0,3),k=parseFloat(h.substr(4)),!k||isNaN(k))k=1}else 0==h.indexOf("dec")&&(l=h.substr(0,3),k=parseFloat(h.substr(4)),!k||isNaN(k))&&(k=1);switch(l){case "inc":d=g.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));
break}d=d.resolvedRawValue;m.incValue(k,d,c,a,function(a){b&&b(a)}.bind(this));break;case "dec":d=g.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;m.decValue(k,d,c,a,function(a){b&&b(a)}.bind(this));break;default:m.doCommand(h,c,a,b)}}else if(m instanceof xnm.aio.knx.KNXGateway._DPT.DPT20){l=h;if(0==h.indexOf("inc")){if(l=h.substr(0,3),k=parseInt(h.substr(4)),!k||isNaN(k))k=1}else 0==
h.indexOf("dec")&&(l=h.substr(0,3),k=parseInt(h.substr(4)),!k||isNaN(k))&&(k=1);switch(l){case "inc":d=g.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;m.incValue(k,d,c,a,function(a){b&&b(a)}.bind(this));break;case "dec":d=g.getState(d,c);if(d.err||"undefined"==typeof d.resolvedRawValue||null==d.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}d=d.resolvedRawValue;
m.decValue(k,d,c,a,function(a){b&&b(a)}.bind(this));break;default:m.doCommand(h,c,a,b)}}else b&&b(Error("unknown data point type"))}})}};var r=function(a){this._device=a};r.prototype=new n;r.prototype.constructor=r;r.prototype.executeCommand=function(a,c,b){if("refreshStates"==a)this.refreshStates(c),b&&b();else{var g=this;this._parseCommand(a,function(f,e,h,m){if(f)b&&b(f);else switch(f=m.ga,m=xnm.aio.knx.KNXGateway._DPT.resolve(m.type),e){case "switch":switch(h){case "on":case "off":m.doCommand(h,
c,f,b);break;case "toggle":e=g.getState(e,c);if(e.err||!e.bufferedValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.bufferedValue.readUInt8(0);m.setValue(e?0:1,c,f,function(a){b&&b(a)}.bind(this));break;default:b&&b(Error("invalid device command"))}break;default:p.prototype.executeCommand.call(g,a,c,b)}})}};r.prototype.getDefaultChannel=function(){return"switch"};var l=function(a){this._device=a};l.prototype=new n;l.prototype.constructor=l;l.prototype.executeCommand=function(a,c,b){if("refreshStates"==
a)this.refreshStates(c),b&&b();else{var g=this;this._parseCommand(a,function(f,e,h,m){if(f)b&&b(f);else{f=m.ga;m=xnm.aio.knx.KNXGateway._DPT.resolve(m.type);var l=h,k=null;switch(e){case "switch":switch(h){case "on":case "off":m.doCommand(h,c,f,b);break;case "toggle":e=g.getState(e,c);if(e.err||!e.bufferedValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.bufferedValue.readUInt8(0);m.setValue(e?0:1,c,f,function(a){b&&b(a)}.bind(this));break;default:b&&b(Error("invalid device command"))}break;
case "step":0==h.indexOf("stepUp")||0==h.indexOf("stepDown")?m.doCommand(h,c,f,b):b&&b(Error("invalid device command"));break;case "value":if(0==h.indexOf("inc")){if(l=h.substr(0,3),k=parseInt(h.substr(3)),!k||isNaN(k))k=1}else if(0==h.indexOf("dec")){if(l=h.substr(0,3),k=parseInt(h.substr(3)),!k||isNaN(k))k=1}else 0==h.indexOf("dimTo")&&(l="dimTo",k=parseInt(h.substr(5)),!k||isNaN(k))&&(k=0);switch(l){case "dimUp":m.doCommand("up",c,f,b);break;case "dimDown":m.doCommand("down",c,f,b);break;case "inc":e=
g.getState(e,c);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;m.incValue(k,e,c,f,function(a){b&&b(a)}.bind(this));break;case "dec":e=g.getState(e,c);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;m.decValue(k,e,c,f,function(a){b&&b(a)}.bind(this));break;case "dimTo":m.doCommand("setValue"+k,
c,f,b);break;default:b&&b(Error("invalid device command"))}break;default:p.prototype.executeCommand.call(g,a,c,b)}}})}};l.prototype.getDefaultChannel=function(){return"value"};var v=function(a){this._device=a};v.prototype=new n;v.prototype.constructor=v;v.prototype.executeCommand=function(a,c,b){if("refreshStates"==a)this.refreshStates(c),b&&b();else{var g=this;this._parseCommand(a,function(f,e,h,m){if(f)b&&b(f);else{f=m.ga;m=xnm.aio.knx.KNXGateway._DPT.resolve(m.type);var l=h,k=null;switch(e){case "blind_step":switch(h){case "blindStepUp":m.doCommand("up",
c,f,b);break;case "blindStepDown":m.doCommand("down",c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "blind_move":switch(h){case "blindMoveUp":m.doCommand("up",c,f,b);break;case "blindMoveDown":m.doCommand("down",c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "blind_stop":switch(h){case "blindStop":m.doCommand("stop",c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "blind_position":if(0==h.indexOf("inc")){if(l=h.substr(0,3),k=parseInt(h.substr(3)),
!k||isNaN(k))k=1}else if(0==h.indexOf("dec")){if(l=h.substr(0,3),k=parseInt(h.substr(3)),!k||isNaN(k))k=1}else 0==h.indexOf("moveTo")&&(l="moveTo",k=parseInt(h.substr(6)),!k||isNaN(k))&&(k=0);switch(l){case "moveUp":m.doCommand("down",c,f,b);break;case "moveDown":m.doCommand("up",c,f,b);break;case "inc":e=g.getState(e,c);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;m.incValue(k,e,c,f,function(a){b&&
b(a)}.bind(this));break;case "dec":e=g.getState(e,c);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;m.decValue(k,e,c,f,function(a){b&&b(a)}.bind(this));break;case "moveTo":m.doCommand("setValue"+k,c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "lamella_position":if(0==h.indexOf("incL")){if(l=h.substr(0,4),k=parseInt(h.substr(4)),!k||isNaN(k))k=1}else if(0==h.indexOf("decL")){if(l=
h.substr(0,4),k=parseInt(h.substr(4)),!k||isNaN(k))k=1}else 0==h.indexOf("lamellaTo")&&(l="lamellaTo",k=parseInt(h.substr(9)),!k||isNaN(k))&&(k=0);switch(l){case "lamellaUp":m.doCommand("down",c,f,b);break;case "lamellaDown":m.doCommand("up",c,f,b);break;case "incL":e=g.getState(e,c);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;m.incValue(k,e,c,f,function(a){b&&b(a)}.bind(this));break;case "decL":e=
g.getState(e,c);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;m.decValue(k,e,c,f,function(a){b&&b(a)}.bind(this));break;case "lamellaTo":m.doCommand("setValue"+k,c,f,b);break;default:b&&b(Error("invalid device command"))}break;default:p.prototype.executeCommand.call(g,a,c,b)}}})}};v.prototype.getDefaultChannel=function(){return"blind_position"};var u=function(a){this._device=a};u.prototype=new n;
u.prototype.constructor=u;u.prototype.executeCommand=function(a,c,b){if("refreshStates"==a)this.refreshStates(c),b&&b();else{var g=this;this._parseCommand(a,function(f,e,h,m){if(f)b&&b(f);else{f=m.ga;m=xnm.aio.knx.KNXGateway._DPT.resolve(m.type);var l=h,k=null;switch(e){case "shutter_step":switch(h){case "shutterStepUp":m.doCommand("up",c,f,b);break;case "shutterStepDown":m.doCommand("down",c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "shutter_move":switch(h){case "shutterMoveUp":m.doCommand("up",
c,f,b);break;case "shutterMoveDown":m.doCommand("down",c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "shutter_stop":switch(h){case "shutterStop":m.doCommand("stop",c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "shutter_position":if(0==h.indexOf("inc")){if(l=h.substr(0,3),k=parseInt(h.substr(3)),!k||isNaN(k))k=1}else if(0==h.indexOf("dec")){if(l=h.substr(0,3),k=parseInt(h.substr(3)),!k||isNaN(k))k=1}else 0==h.indexOf("moveTo")&&(l="moveTo",k=parseInt(h.substr(6)),
!k||isNaN(k))&&(k=0);switch(l){case "moveUp":m.doCommand("down",c,f,b);break;case "moveDown":m.doCommand("up",c,f,b);break;case "inc":e=g.getState(e,c);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;m.incValue(k,e,c,f,function(a){b&&b(a)}.bind(this));break;case "dec":e=g.getState(e,c);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));
return}e=e.resolvedRawValue;m.decValue(k,e,c,f,function(a){b&&b(a)}.bind(this));break;case "moveTo":m.doCommand("setValue"+k,c,f,b);break;default:b&&b(Error("invalid device command"))}break;default:p.prototype.executeCommand.call(g,a,c,b)}}})}};u.prototype.getDefaultChannel=function(){return"shutter_position"};var q=function(a){this._device=a};q.prototype=new n;q.prototype.constructor=q;q.prototype.executeCommand=function(a,c,b){if("refreshStates"==a)this.refreshStates(c),b&&b();else{var g=this;this._parseCommand(a,
function(f,e,h,m){if(f)b&&b(f);else{f=m.ga;m=xnm.aio.knx.KNXGateway._DPT.resolve(m.type);var l=h,k=null;switch(e){case "setpoint_basic":if(0==h.indexOf("tempUp")){if(l=h.substr(0,6),k=parseFloat(h.substr(6)),!k||isNaN(k))k=.5}else if(0==h.indexOf("tempDown")){if(l=h.substr(0,8),k=parseFloat(h.substr(8)),!k||isNaN(k))k=.5}else 0==h.indexOf("tempTo")&&(l="tempTo",k=parseFloat(h.substr(6)),!k||isNaN(k))&&(k=0);switch(l){case "tempUp":e=g.getState(e,c);if(e.err||"undefined"==typeof e.resolvedRawValue||
null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;m.incValue(k,e,c,f,function(a){b&&b(a)}.bind(this));break;case "tempDown":e=g.getState(e,c);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;m.decValue(k,e,c,f,function(a){b&&b(a)}.bind(this));break;case "tempTo":m.doCommand("setValue"+k,c,f,b);break;default:b&&b(Error("invalid device command"))}break;
case "setpoint_shift":if(0==h.indexOf("tempShiftUp")){if(l=h.substr(0,11),k=parseInt(h.substr(11)),!k||isNaN(k))k=1}else if(0==h.indexOf("tempShiftDown")){if(l=h.substr(0,13),k=parseInt(h.substr(13)),!k||isNaN(k))k=1}else 0==h.indexOf("tempShiftTo")&&(l="tempShiftTo",k=parseInt(h.substr(11)),!k||isNaN(k))&&(k=0);switch(l){case "tempShiftUp":e=g.getState(e,c);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;
m.incValue(k,e,c,f,function(a){b&&b(a)}.bind(this));break;case "tempShiftDown":e=g.getState(e,c);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;m.decValue(k,e,c,f,function(a){b&&b(a)}.bind(this));break;case "tempShiftTo":m.doCommand("setValue"+k,c,f,b);break;default:b&&b(Error("invalid device command"))}break;case "mode":m.doCommand(h,c,f,b);break;default:p.prototype.executeCommand.call(g,a,c,b)}}})}};
q.prototype.getDefaultChannel=function(){return"set_temperature"};var t=function(a){this._device=a};t.prototype=new n;t.prototype.constructor=t;t.prototype.doCommand=function(a,c,b){var g,f,e={};g=a.command;var h=a.channel;h||(h=this.getDefaultChannel());if(this._device[h])if(a=this._getWriteableGa(this._device[h]))if(a instanceof Error)b&&b(a);else switch(g){case "on":f=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[h].actuator.type);f.setValue(1,c,a,function(a,c){a||(e.channel=h,e.state=c);b&&
b(a,a?null:e)}.bind(this));break;case "off":f=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[h].actuator.type);f.setValue(0,c,a,function(a,c){a||(e.channel=h,e.state=c);b&&b(a,a?null:e)}.bind(this));break;case "toggle":g=this._getReadableGa(this._device[h]);if(!g){b&&b(Error("invalid device has no readable address"));break}if(g instanceof Error){b&&b(a);break}f=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[h].actuator.type);f.invValue(c,a,g,function(a,c){a||(e.channel=h,e.state=c);b&&b(a,a?null:
e)}.bind(this));break;default:b&&b(Error("invalid device command"))}else b&&b(Error("invalid device has no writeable address"));else b&&b(Error("invalid device"))};t.prototype.evalGroupCommand=function(a,c,b){var g,f={};g=a.command;var e=a.channel;e||(e=this.getDefaultChannel());if(this._device[e])if(a=this._getWriteableGa(this._device[e]))if(a instanceof Error)b&&b(a);else switch(g){case "on":g=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[e].actuator.type);g.evalValue(1,c,a,function(a,c){a||
(f.channel=e,f.state=c);b&&b(a,a?null:f)}.bind(this));break;case "off":g=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[e].actuator.type);g.evalValue(0,c,a,function(a,c){a||(f.channel=e,f.state=c);b&&b(a,a?null:f)}.bind(this));break;default:b&&b(Error("invalid device group command"))}else b&&b(Error("invalid device has no writeable address"));else b&&b(Error("invalid device"))};t.prototype.getState=function(a,c,b){var g;a&&a.channel&&(g=a.channel);g||(g=this.getDefaultChannel());this._getState(g,
c,b)};t.prototype.getDefaultChannel=function(){return"channel"};var a=function(a){this._device=a};a.prototype=new n;a.prototype.constructor=a;a.prototype.doCommand=function(a,c,b){var g,f={},e=a.command,h=a.channel;h||(h=this.getDefaultChannel());if(this._device[h]){var l=this._getWriteableGa(this._device[h]);if(l)if(l instanceof Error)b&&b(l);else if(3<=e.length&&("inc"===e.substr(0,3).toLowerCase()||"dec"===e.substr(0,3).toLowerCase())){var n=e.substr(0,3),e=e.substr(3);""==e&&(e="10");e.match(/^\d+$/)?
(e=parseInt(e),(g=this._getReadableGa(this._device[h]))?g instanceof Error?b&&b(g):(a=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[h].actuator.type),a["inc"==n?"incValue":"decValue"](e,c,l,g,function(a,c){a||null==c||(f.channel=h,f.state=c);b&&b(a,a?null:f)})):b&&b(Error("invalid device has no readable address"))):b&&b(Error("invalid device command"))}else 6<e.length&&"moveto"===e.substr(0,6).toLowerCase()&&(e=e.substr(6)),e.match(/^\d+$/)?(e=parseInt(e),a=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[h].actuator.type),
a.setValue(e,c,l,function(a,c){a||null==c||(f.channel=h,f.state=c);b&&b(a,a?null:f)})):b&&b(Error("invalid device command"));else b&&b(Error("invalid device has no writeable address"))}else b&&b(Error("invalid device"))};a.prototype.evalGroupCommand=function(a,c,b){var g={},f=a.command,e=a.channel;e||(e=this.getDefaultChannel());if(this._device[e]){var h=this._getWriteableGa(this._device[e]);h?h instanceof Error?b&&b(h):3<=f.length&&("inc"===f.substr(0,3).toLowerCase()||"dec"===f.substr(0,3).toLowerCase())?
b&&b(Error("invalid device group command")):(6<f.length&&"moveto"===f.substr(0,6).toLowerCase()&&(f=f.substr(6)),f.match(/^\d+$/)?(f=parseInt(f),a=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[e].actuator.type),a.evalValue(f,c,h,function(a,c){a||null==c||(g.channel=e,g.state=c);b&&b(a,a?null:g)})):b&&b(Error("invalid device command"))):b&&b(Error("invalid device has no writeable address"))}else b&&b(Error("invalid device"))};a.prototype.getState=function(a,c,b){var g;a&&a.channel&&(g=a.channel);
g||(g=this.getDefaultChannel());this._getState(g,c,b)};a.prototype.getDefaultChannel=function(){return"channel"};n.General=p;n.Outlet=r;n.Lighting=l;n.Blind=v;n.Shutter=u;n.Heater=q;n.BIT_1=t;n.Byte_1=a;return n}();
xnm.aio.knx.Discovery={_eventEmitter:new EventEmitter,_logger:Logger.getLogger("xnm.aio.knx.Discovery"),_listenerSockets:[],_closedSockets:[],on:function(n,p){this._eventEmitter.on(n,p)},removeAllListeners:function(){this._eventEmitter.removeAllListeners()},startSearchKNX:function(){if(os&&os.networkInterfaces){var n=os.networkInterfaces(),p;for(p in n)for(var r=n[p],l=0;l<r.length;l++){var v=r[l];!1===v.internal&&"IPv4"===v.family&&this._createSocket(v.address)}}else this._createSocket(null);this._closedSockets=
[]},stopSearchKNX:function(){for(var n=0;n<this._listenerSockets.length;n++)this._listenerSockets[n].close()},_createSocket:function(n){var p=this,r=dgram.createSocket("udp4");r.on("listening",function(){r.addMembership("224.0.23.12");r.setBroadcast(!0);var l=r.address();p._logger.log("debug","knx discovery socket listening "+l.address+":"+l.port);p._listenerSockets.push(r);var n=(new xnm.aio.knx.KNXGateway.IPFrame.SearchRequest({ip:l.address,port:l.port})).toBuffer();p._logger.log("debug","send knx search request: "+
n.toString("hex")+" from "+l.address+":"+l.port);r.send(n,0,n.length,3671,"224.0.23.12")});r.on("message",function(l,n){var u=r.address();p._logger.log("trace","receive data "+l.toString("hex")+" from "+n.address+":"+n.port+" @local "+u.address+":"+u.port);var q=xnm.aio.knx.KNXGateway.IPFrame.parseFrame(l);if(q instanceof xnm.aio.knx.KNXGateway.IPFrame.SearchResponse){var t=q.getCtrlEndpointHPAI();p._logger.log("debug","find knx "+t.ip+":"+t.port);p._eventEmitter.emit("found",q,u);p._eventEmitter.emit("device",
q.toJSON(),u)}});r.on("error",function(l){p._logger.log("debug","discovery socket error: "+l.stack);p._eventEmitter.emit("error",l)});r.on("close",function(){p._logger.log("debug","discovery socket closed");p._closedSockets.push(r);p._listenerSockets.length===p._closedSockets.length&&(p._listenerSockets=[],p._closedSockets=[],p._eventEmitter.emit("close"))});r.bind(null,n)}};
xnm.aio.knx.Handler=function(){var n=function(){this._listenerSockets=[]};n.prototype={KNXGateway:xnm.aio.knx.KNXGateway,Finder:xnm.aio.knx.Discovery};return n}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.knx.Handler);
