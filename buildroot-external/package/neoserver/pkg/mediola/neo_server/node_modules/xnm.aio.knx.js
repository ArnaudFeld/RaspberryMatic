var dgram=require("dgram"),os=require("os"),EventEmitter=require("x.events.js").EventEmitter,Logger=require("x.logger.js"),xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.knx=xnm.aio.knx||{};
xnm.aio.knx.KNXGateway=function(){var m=function(c){c=c.split(".");return(parseInt(c[0])<<24)+(parseInt(c[1])<<16)+(parseInt(c[2])<<8)+parseInt(c[3])&4294967295},p=function(c){return(c>>24&255)+"."+(c>>16&255)+"."+(c>>8&255)+"."+(c&255)},q=function(){var c=function(d){this._loggger=require("x.logger.js").getLogger("xnm.aio.knx.KNXGateway.RawStateBuffer");this._stateBuffer={};this._stateReqTime={};this._knx=d};c.prototype.setState=function(d,b){"undefined"!=typeof d&&null!=d&&(this._stateBuffer[d]||
(this._stateBuffer[d]={}),this._stateBuffer[d].value=b,this._stateBuffer[d].timestamp=new Date)};c.prototype.getState=function(d){return"undefined"!=typeof d&&null!=d?(d=this._stateBuffer[d])?d.value:null:null};c.prototype.setStateReqTime=function(d,b){this._stateReqTime[d]=b};c.prototype.getStateReqTime=function(d){return this._stateReqTime[d]};return c}(),l=function(c,d,b){this._logger=Logger.getLogger("xnm.aio.knx.KNXGateway ("+c+")");this.ip=c;this.localIp=d;this.uuid=b;this._stateBuffer=new q;
this._stateMachine={state:l._FSM.IDLE};this._eventEmitter=new EventEmitter;this._dataLink=null;this._dataLinkRetryCount=0;this._dataLinkTimer=null};l.STATES_REQ_EXPIRED=18E4;l.MAX_DL_RETRY_COUNT=3;l._FSM={IDLE:1,MONITORING:2,START_MONITOR:3,STOP_MONITOR:4};l._ipv4ToLong=m;l._longToIpv4=p;l._adr2long=function(c){c=c.split("/");var d=0;switch(c.length){case 3:d+=parseInt(c[0])<<11;d+=parseInt(c[1])<<8;d+=parseInt(c[2]);break;case 2:d+=parseInt(c[0])<<11;d+=parseInt(c[1]);break;case 1:d+=parseInt(c[0])}return d};
l.prototype={getStateBuffer:function(){return this._stateBuffer},on:function(c,d){this._eventEmitter.on(c,d)},removeAllListeners:function(){this._eventEmitter.removeAllListeners()},removeListener:function(c,d){this._eventEmitter.removeListener(c,d)},startMonitor:function(c){if(c)this.on("open",c);this._fsmStartMonitor()},stopMonitor:function(c){if(c)this.on("close",c);this._fsmStopMonitor()},_fsmStartMonitor:function(){switch(this._stateMachine.state){case l._FSM.IDLE:this._stateMachine.state=l._FSM.START_MONITOR;
this._startDataLink();break;case l._FSM.MONITORING:this._eventEmitter.emit("open");break;case l._FSM.STOP_MONITOR:this._logger.log("warn","can not start the monitor again while stopping it")}},_fsmStopMonitor:function(){switch(this._stateMachine.state){case l._FSM.IDLE:this._onClose();break;case l._FSM.START_MONITOR:case l._FSM.MONITORING:this._stateMachine.state=l._FSM.STOP_MONITOR,this._stopDataLink()}},_fsmDatalinkOpen:function(){switch(this._stateMachine.state){case l._FSM.START_MONITOR:this._stateMachine.state=
l._FSM.MONITORING,this._onOpen(),this._dataLinkRetryCount=0}},_fsmDatalinkClosed:function(c){c?this._logger.log("trace","data link stopped due to error"):this._logger.log("trace","data link stopped");switch(this._stateMachine.state){case l._FSM.START_MONITOR:this._dataLink.removeAllListeners();this._dataLink=null;++this._dataLinkRetryCount<l.MAX_DL_RETRY_COUNT?(this._logger.log("trace","auto restart monitor tunnel"),this._stateMachine.state=l._FSM.START_MONITOR,this._startDataLink()):(this._stateMachine.state=
l._FSM.IDLE,this._onClose(!0));break;case l._FSM.MONITORING:this._dataLink.removeAllListeners();this._dataLink=null;++this._dataLinkRetryCount<l.MAX_DL_RETRY_COUNT?(this._logger.log("trace","auto restart monitor tunnel"),this._stateMachine.state=l._FSM.START_MONITOR,this._startDataLink()):(this._onError(Error("can not connect monitor tunnel to knx gateway")),this._stateMachine.state=l._FSM.IDLE,this._onClose(!0));break;case l._FSM.STOP_MONITOR:this._dataLink.removeAllListeners(),this._dataLink=null,
this._stateMachine.state=l._FSM.IDLE,this._onClose(!1)}},_fsmDataLinkMessage:function(c,d){switch(this._stateMachine.state){case l._FSM.MONITORING:d.getAPCI(),this._stateBuffer.setState(c,d.getData()),this._eventEmitter.emit("message",this.uuid,c,d)}},_fsmDatalinkError:function(c){this._onError(c)},_onOpen:function(){this._eventEmitter.emit("open")},_onError:function(c){this._eventEmitter.emit("error",c)},_onClose:function(c){this._eventEmitter.emit("close",c)},_sendCommand:function(c,d,b){this._dataLink?
this._sendCommandWithDL(this._dataLink,c,d,b):b&&b(Error("knx gateway not connected"))},_getState:function(c,d){this._dataLink?this._getStateWithDL(this._dataLink,c,d):d&&d(Error("knx gateway not connected"))},_sendCommandWithDL:function(c,d,b,a){var g=l._adr2long(d),e=new l.APDU(null,2,b),k=this;c.send(g,e,function(b){b||k._stateBuffer.setState(g,e.getData());a&&"function"===typeof a&&a(b)})},_getStateWithDL:function(c,d,b){d=l._adr2long(d);var a=new l.APDU(null,0,new Buffer([0]));c.send(d,a,b)},
_startDataLink:function(){var c=this;this._dataLink=new l._DataLink(this.ip,this.localIp);this._dataLink.on("connect",function(){c._fsmDatalinkOpen()});this._dataLink.on("close",function(d){c._fsmDatalinkClosed(d)});this._dataLink.on("error",function(d){c._logger.log("warn","monitor tunnel error:"+d.message);c._fsmDatalinkError(d)});this._dataLink.on("message",function(d,b){c._fsmDataLinkMessage(d,b)});this._dataLink.connect()},_stopDataLink:function(){this._dataLink&&this._dataLink.close()}};var v=
function(){var c=function(d,b){this._logger=Logger.getLogger("xnm.aio.knx.KNXGateway._DataLink ("+d+")");var c=this;this._tunnel=new u(d,null,b,null);this._tunnel.on("connect",function(){c._onTunnelConnect()});this._tunnel.on("end",function(){c._onTunnelEnd()});this._tunnel.on("close",function(b){c._onTunnelClose(b)});this._tunnel.on("message",function(b){c._onTunnelMessage(b)});this._tunnel.on("error",function(b){c._onTunnelError(b)});this._eventEmitter=new EventEmitter};c.prototype={on:function(d,
b){this._eventEmitter.on(d,b)},removeAllListeners:function(){this._eventEmitter.removeAllListeners()},removeListener:function(d,b){this._eventEmitter.removeListener(d,b)},connect:function(){this._tunnel.connect()},close:function(){this._tunnel.close()},send:function(d,b,c){this._logger.log("debug","send l_data.req "+b.toBuffer().toString("hex")+"@"+d);d=new t.L_Data_Req(d,b);this._tunnel.send(d,function(b){c&&c(b)})},_onTunnelConnect:function(){this._eventEmitter.emit("connect")},_onTunnelClose:function(c){this._eventEmitter.emit("close",
c)},_onTunnelEnd:function(){this._eventEmitter.emit("end")},_onTunnelMessage:function(c){var b="unknown";c&&c instanceof t.L_Data_Con?b="l_data.con":c&&c instanceof t.L_Data_Ind&&(b="l_data.ind");var d=c.getDstAddr();c=c.getAPDU();this._logger.log("debug","recive "+b+" "+c.toBuffer().toString("hex")+"@"+d);this._eventEmitter.emit("message",d,c)},_onTunnelError:function(c){this._eventEmitter.emit("error",c)}};return c}(),u=function(){var c=function(d,b,a,f){this._eventEmitter=new EventEmitter;this._ip=
d;this._port=b;if(!this._port||0>=this._port)this._port=c.DEFAULT_REMOTE_PORT;this._logger=require("x.logger.js").getLogger("xnm.aio.knx.KNXGateway._Tunnel ("+this._ip+":"+this._port+")");this._localIp=a;this._localPort=f;0>=this._localPort&&(this._localPort=null);this._socket=null;this._requestBuffer=[];this._stateMachine={state:c._STATE.IDLE,stateTimer:null,connectionStateTimer:null,connectionStateAckTimer:null,connection:{id:0,seqNo:0,recvSeqNo:0,hpai:{ip:null,port:0}},close_with_error:null};this._connectStateNackCount=
0};c.TUNNEL_ACK_TIMEOUT=1E3;c.CONNECT_REQUEST_TIMEOUT=1E4;c.CONNECTIONSTATE_REQUEST_INTERVAL=6E4;c.CONNECTIONSTATE_REQUEST_TIMEOUT=1E4;c.MAX_CONNECTIONSTATE_NACK_COUNT=3;c.DEFAULT_REMOTE_PORT=3671;c._STATE={IDLE:0,BINDUDP:1,CONNECT:2,TUNNELLING:3,DISCONNECT:4,CLOSEUDP:5};c.prototype={on:function(c,b){this._eventEmitter.on(c,b)},removeAllListeners:function(){this._eventEmitter.removeAllListeners()},connect:function(){this._fsmConnect()},close:function(){this._fsmClose(!1)},send:function(c,b){if(c){var d=
this._requestBuffer.length;this._requestBuffer.push({cEMI:c,callback:b,retry:!1,timer:null,seqNo:-1});0==d&&this._sendNextReq()}else b&&b(Error("cEMI is null"))},_sendNextReq:function(){if(0!=this._requestBuffer.length){var d=this._requestBuffer[0],b=this._stateMachine.connection.seqNo;-1!=d.seqNo?b=d.seqNo:d.seqNo=b;var a=this;this._send(b,d.cEMI,function(b){b?(d.callback&&d.callback(b),a._requestBuffer.splice(0,1),a._sendNextReq()):d.timer=setTimeout(function(){d.retry?(d.callback&&d.callback(Error("NACK due to timeout")),
a._requestBuffer.splice(0,1),a._fsmClose(!0)):(d.retry=!0,a._sendNextReq())},c.TUNNEL_ACK_TIMEOUT)})}},_send:function(d,b,a){var f=this;switch(this._stateMachine.state){case c._STATE.TUNNELLING:this._logger.log("debug","send cEMI "+b.toBuffer().toString("hex"));var e=(new r.TunnellingRequest(this._stateMachine.connection.id,d,b)).toBuffer();this._logger.log("debug","send TUNNELLING_REQUEST ("+d+") "+e.toString("hex"));this._socket.send(e,0,e.length,this._port,this._ip,function(b){b?f._logger.log("debug",
"send TUNNELLING_REQUEST ("+d+") "+e.toString("hex")+" error:"+b.message):f._logger.log("debug","send TUNNELLING_REQUEST ("+d+") "+e.toString("hex")+" finish");a&&a(null)});break;default:a&&a(Error("Tunnel is not connected"))}},_fsmConnect:function(){this._logger.log("debug","connect to knx");switch(this._stateMachine.state){case c._STATE.IDLE:this._stateMachine.state=c._STATE.BINDUDP,this._startListenerSocket()}},_fsmClose:function(d){this._stateMachine.close_with_error=d;switch(this._stateMachine.state){case c._STATE.IDLE:this._fsmClosed();
break;case c._STATE.BINDUDP:this._stateMachine.state=c._STATE.CLOSEUDP;this._stopListenerSocket();break;case c._STATE.CONNECT:this._clearStateMachineGuard();this._stateMachine.state=c._STATE.CLOSEUDP;this._stopListenerSocket();break;case c._STATE.TUNNELLING:d=(new r.DisconnectRequest(this._stateMachine.connection.id,this._stateMachine.connection.hpai)).toBuffer(),this._logger.log("debug","send DISCONNECT_REQUEST "+d.toString("hex")),this._socket.send(d,0,d.length,this._port,this._ip),this._stateMachine.state=
c._STATE.DISCONNECT,this._clearStateMachineGuard(),this._setStateMachineGuard(1E3,c._STATE.CLOSEUDP)}},_fsmError:function(c){this._eventEmitter.emit("error",c);this._fsmClose(!0)},_fsmUdpListening:function(){this._logger.log("debug","udp socket established");switch(this._stateMachine.state){case c._STATE.BINDUDP:this._stateMachine.state=c._STATE.CONNECT;this._clearStateMachineGuard();var d=this._socket.address();d={ip:d.address,port:d.port};this._logger.log("debug","send CONNECTION_REQUEST");d=(new r.ConnectionRequest(d,
d)).toBuffer();this._socket.send(d,0,d.length,this._port,this._ip);this._setStateMachineGuard(c.CONNECT_REQUEST_TIMEOUT,c._STATE.TUNNELLING)}},_fsmUdpMessage:function(d){var b=this,a=this._socket.address(),f=r.parseFrame(d);if(f)switch(this._stateMachine.state){case c._STATE.CONNECT:518===f.getType()&&(f.isConnectionStatusOK()?(this._clearStateMachineGuard(),d=f.getConnectionID(),this._logger.log("debug","receive CONNECTION_RESPONSE with connection id "+d),this._stateMachine.connection={},this._stateMachine.connection.id=
d,a={ip:a.address,port:a.port},this._stateMachine.connection.hpai=a,this._stateMachine.connection.seqNo=0,this._stateMachine.connection.recvSeqNo=0,this._stateMachine.state=c._STATE.TUNNELLING,this._sendConnectionStateRequest(),this._onConnected()):(a=f.getConnectionStatus(),d=Error("tunnel connection fail with error:"+a.toString(16)),d.code=a,this._fsmError(d)));break;case c._STATE.TUNNELLING:switch(f.getType()){case 1056:d=f.getConnectionID();if(d===this._stateMachine.connection.id){var e=f.getcEMI(),
k=f.getSeqNo(),n=!1;k==this._stateMachine.connection.recvSeqNo&&(n=!0);if(k==this._stateMachine.connection.recvSeqNo||k==this._stateMachine.connection.recvSeqNo-1)f=new r.TunnellingACK(d,k),a=f.toBuffer(),this._logger.log("trace","send TUNNELLING_ACK ("+k+") "+a.toString("hex")),this._socket.send(a,0,a.length,this._port,this._ip,function(c){try{n&&(e&&e instanceof t.L_Data_Con?(b._logger.log("debug","receive TUNNELLING_REQUEST ("+k+") l_data.con "+e.toBuffer().toString("hex")),b._onMessage(e)):e&&
e instanceof t.L_Data_Ind&&(b._logger.log("debug","receive TUNNELLING_REQUEST ("+k+") l_data.ind "+e.toBuffer().toString("hex")),b._onMessage(e)))}catch(h){}});k!=this._stateMachine.connection.recvSeqNo&&k!=this._stateMachine.connection.recvSeqNo-1||k!=this._stateMachine.connection.recvSeqNo||(this._stateMachine.connection.recvSeqNo++,255<this._stateMachine.connection.recvSeqNo&&(this._stateMachine.connection.recvSeqNo=0))}break;case 1057:d=f.getConnectionID();d===this._stateMachine.connection.id&&
this._onTunnelAck(f);break;case 521:d=f.getConnectionID();a=f.getCtrlEndpointHPAI();d===this._stateMachine.connection.id&&(this._logger.log("debug","receive DISCONNECT_REQUEST"),f=new r.DisconnectResponse(d),a=f.toBuffer(),this._logger.log("debug","send DISCONNECT_RESPONSE "+a.toString("hex")),this._socket.send(a,0,a.length,this._port,this._ip,function(){b._fsmEnd()}));break;case 520:d=f.getConnectionID(),this._logger.log("debug","receive CONNECTIONSTATE_RESPONSE with connection id "+d),this._connectStateNackCount=
0,this._stateMachine.connectionStateAckTimer&&(clearTimeout(this._stateMachine.connectionStateAckTimer),this._stateMachine.connectionStateAckTimer=null,this._stateMachine.connectionStateTimer||(this._stateMachine.connectionStateTimer=setTimeout(function(){b._stateMachine.connectionStateTimer=null;b._sendConnectionStateRequest()},c.CONNECTIONSTATE_REQUEST_INTERVAL)))}break;case c._STATE.DISCONNECT:522===f.getType()&&(d=f.getConnectionID(),d===this._stateMachine.connection.id&&(a=f.isDisconnectOK(),
this._logger.log("debug","receive DISCONNECT_RESPONSE with status "+(a?"OK":"NOK")),this._clearStateMachineGuard(),this._stateMachine.state=c._STATE.CLOSEUDP,b._stopListenerSocket()))}},_fsmEnd:function(){this._stateMachine.state=c._STATE.CLOSEUDP;this._eventEmitter.emit("end");this._stateMachine.close_with_error=!1;this._stopListenerSocket()},_fsmClosed:function(){this._stateMachine.state=c._STATE.IDLE;var d=this._stateMachine.close_with_error;this._socket&&this._socket.removeAllListeners();this._socket=
null;this._clearRequestBuffer();this._resetStateMachine();this._eventEmitter.emit("close",d)},_onConnected:function(){this._eventEmitter.emit("connect")},_onMessage:function(c){this._eventEmitter.emit("message",c)},_onTunnelAck:function(c){var b=c.getSeqNo();c=c.isOK();this._logger.log("debug","receive TUNNELLING_ACK ("+b+") with status "+(c?"OK":"NOK"));b==this._stateMachine.connection.seqNo&&(b=this._requestBuffer[0],b.timer&&clearTimeout(b.timer),b.callback&&b.callback(c?null:Error("NACK")),this._stateMachine.connection.seqNo+=
1,255<this._stateMachine.connection.seqNo&&(this._stateMachine.connection.seqNo=0),this._requestBuffer.splice(0,1),this._sendNextReq())},_clearRequestBuffer:function(){for(var c=0;c<this._requestBuffer.length;c++){var b=this._requestBuffer[c];b&&(b.timer&&clearTimeout(b.timer),b.callback&&b.callback(Error("NACK due to tunnel closed")))}this._requestBuffer=[]},_setStateMachineGuard:function(a,b){var d=this;this._stateMachine.stateTimer=setTimeout(function(){var a=d._stateMachine.state;a===c._STATE.DISCONNECT&&
b===c._STATE.CLOSEUDP?(d._stateMachine.state=c._STATE.CLOSEUDP,d._stopListenerSocket()):a!==b&&(a=3==b?"receive CONNECTION_RESPONSE timeout":"knx tunnel receive data timeout in "+a,d._logger.log("warn",a),d._fsmError(Error(a)))},a)},_clearStateMachineGuard:function(){this._stateMachine.stateTimer&&clearTimeout(this._stateMachine.stateTimer)},_sendConnectionStateRequest:function(){var a=this,b=(new r.ConnectionStateRequest(this._stateMachine.connection.id,this._stateMachine.connection.hpai)).toBuffer();
this._logger.log("debug","send CONNECTIONSTATE_REQUEST "+b.toString("hex")+" with connection id "+this._stateMachine.connection.id);this._socket.send(b,0,b.length,this._port,this._ip);this._stateMachine.connectionStateAckTimer&&(clearTimeout(this._stateMachine.connectionStateAckTimer),this._stateMachine.connectionStateAckTimer=null);this._stateMachine.connectionStateAckTimer=setTimeout(function(){a._connectStateNackCount++;a._connectStateNackCount<c.MAX_CONNECTIONSTATE_NACK_COUNT&&a._stateMachine.state===
c._STATE.TUNNELLING?(a._logger.log("warn","receive CONNECTIONSTATE_RESPONSE timeout"),a._sendConnectionStateRequest()):(a._logger.log("warn","tunnel break due to CONNECTIONSTATE_RESPONSE timeout"),a._fsmError(Error("tunnel break")))},c.CONNECTIONSTATE_REQUEST_TIMEOUT)},_resetStateMachine:function(){this._stateMachine.stateTimer&&clearTimeout(this._stateMachine.stateTimer);this._stateMachine.connectionStateTimer&&clearTimeout(this._stateMachine.connectionStateTimer);this._stateMachine.connectionStateAckTimer&&
clearTimeout(this._stateMachine.connectionStateAckTimer);this._stateMachine={state:c._STATE.IDLE,stateTimer:null,connectionStateTimer:null,connectionStateAckTimer:null,socket:null,connection:{id:0,seqNo:0,hpai:{ip:null,port:0}},close_with_error:null}},_startListenerSocket:function(){this._logger.log("trace","{UDP Socket} start knx upd listener on "+this._localIp);var c=this;this._socket=dgram.createSocket("udp4");this._socket.on("listening",function(){c._socket.addMembership("224.0.23.12");var b=
c._socket.address();c._logger.log("trace","{UDP Socket} knx listening "+b.address+":"+b.port);c._fsmUdpListening()});this._socket.on("close",function(){c._logger.log("trace","{UDP Socket} control socket closed");c._fsmClosed()});this._socket.on("error",function(b){c._logger.log("trace","{UDP Socket} control socket error: "+b.stack);c._fsmError(b)});this._socket.on("message",function(b,a){var d=c._socket.address();c._logger.log("trace","{UDP Socket} receive data "+b.toString("hex")+" from "+a.address+
":"+a.port+" @local "+d.address+":"+d.port);c._fsmUdpMessage(b)});this._socket.bind(null,this._localIp)},_stopListenerSocket:function(){this._logger.log("trace","{UDP Socket} stop knx upd listener");this._socket.close()}};return c}(),r=function(){var c=function(b,c){b&&c&&(this._logger=Logger.getLogger("xnm.aio.KNXGateway.IPFrame"),this._buffer=new Buffer(6+c.length),this._buffer.writeUInt16BE(1552,0),this._buffer.writeUInt16BE(b,2),this._buffer.writeUInt16BE(6+c.length,4),c.copy(this._buffer,6))};
c._logger=Logger.getLogger("xnm.aio.KNXGateway.IPFrame");c.parseFrame=function(a){var d=null;if(6>a.length)return c._logger.log("debug","data is too short"),null;var e=a.readUInt16BE(0);if(1552!==e)return c._logger.log("debug","data header&version is invalid:"+e),null;e=a.readUInt16BE(4);if(e>a.length)return c._logger.log("debug","data length in header is larger than actual size:"+e),null;var g=a.readUInt16BE(2);switch(g){case 514:14<=e&&(d=new b);break;case 518:8<=e&&(d=new f);break;case 520:8<=
e&&(d=new k);break;case 1057:10<=e&&(d=new l);break;case 1056:6<=e&&(d=new n);break;case 521:16<=e&&(d=new h);break;case 522:8<=e&&(d=new w);break;default:c._logger.log("debug","data type is unknow:"+g)}d&&(d._buffer=a);return d};c.prototype.getType=function(){return this._buffer.readUInt16BE(2)};c.prototype.getSize=function(){return this._buffer.readUInt16BE(4)};c.prototype.toBuffer=function(){return this._buffer};var a=function(b){var a=new Buffer(8);a.writeUInt16BE(2049,0);a.writeInt32BE(m(b.ip),
2);a.writeUInt16BE(b.port,6);c.call(this,513,a)};a.prototype=new c;a.prototype.constructor=a;var b=function(){c.call(this)};b.prototype=new c;b.prototype.constructor=b;b.prototype.getCtrlEndpointHPAI=function(){var b=this._buffer.readUInt32BE(8);b=p(b);var c=this._buffer.readUInt16BE(12),a={};a.ip=b;a.port=c;return a};b.prototype.getSerialNumber=function(){var b=(this._buffer.readUInt8(22)<<16)+(this._buffer.readUInt8(23)<<8)+this._buffer.readUInt8(24),c=(this._buffer.readUInt8(25)<<16)+(this._buffer.readUInt8(26)<<
8)+this._buffer.readUInt8(27);return b+""+c};b.prototype.getRoutingMulticastAddress=function(){return this._buffer.readUInt8(28)+"."+this._buffer.readUInt8(29)+"."+this._buffer.readUInt8(30)+"."+this._buffer.readUInt8(31)};b.prototype.getMAC=function(){return this._buffer.toString("hex",32,38)};b.prototype.getName=function(){return this._buffer.toString("utf8",38,68)};b.prototype.toJSON=function(){return{hapi:this.getCtrlEndpointHPAI(),structure_length:this._buffer.readUInt8(14),desciprtion_type_code:this._buffer.readUInt8(15),
knx_medium:this._buffer.readUInt8(16),device_status:this._buffer.readUInt8(17),physical_address:this._buffer.readUInt16BE(18),project_installation_id:this._buffer.readUInt16BE(20),serial_number:this.getSerialNumber(),routing_multicast_address:this.getRoutingMulticastAddress(),mac:this.getMAC(),name:this.getName()}};var g=function(b,a){var d=new Buffer(20);d.writeUInt16BE(2049,0);d.writeInt32BE(m(b.ip),2);d.writeUInt16BE(b.port,6);d.writeUInt16BE(2049,8);d.writeInt32BE(m(a.ip),10);d.writeUInt16BE(a.port,
14);d.writeUInt8(4,16);d.writeUInt8(4,17);d.writeUInt8(2,18);d.writeUInt8(0,19);c.call(this,517,d)};g.prototype=new c;g.prototype.constructor=g;var f=function(){c.call(this)};f.prototype=new c;f.prototype.constructor=f;f.prototype.getConnectionID=function(){return this._buffer.readUInt8(6)};f.prototype.isConnectionStatusOK=function(){return 0===this._buffer.readUInt8(7)};f.prototype.getCtrlEndpointHPAI=function(){var b=this._buffer.readUInt32BE(10);b=p(b);var c=this._buffer.readUInt16BE(14),a={};
a.ip=b;a.port=c;return a};f.prototype.getCRD=function(){return this._buffer.readUInt32BE(16)};f.prototype.getConnectionStatus=function(){return this._buffer.readUInt8(7)};var e=function(b,a){var d=new Buffer(10);d.writeUInt8(b,0);d.writeUInt8(0,1);d.writeUInt16BE(2049,2);d.writeInt32BE(m(a.ip),4);d.writeUInt16BE(a.port,8);c.call(this,519,d)};e.prototype=new c;e.prototype.constructor=e;var k=function(){c.call(this)};k.prototype=new c;k.prototype.constructor=k;k.prototype.getConnectionID=function(){return this._buffer.readUInt8(6)};
k.prototype.isConnectionStatusOK=function(){return 0===this._buffer.readUInt8(7)};var n=function(b,a,d){if(null!==b&&void 0!==b&&null!==a&&void 0!==a&&d){var e=new Buffer(4+d.getLength());e.writeUInt8(4,0);e.writeUInt8(b,1);e.writeUInt8(a,2);e.writeUInt8(0,3);d.toBuffer().copy(e,4);c.call(this,1056,e)}else c.call(this)};n.prototype=new c;n.prototype.constructor=n;n.prototype.getConnectionID=function(){return this._buffer.readUInt8(7)};n.prototype.getSeqNo=function(){return this._buffer.readUInt8(8)};
n.prototype.getcEMI=function(){var b=this._buffer.readUInt16BE(4);b=new Buffer(b-6-4);this._buffer.copy(b,0,10);return t.parseFrame(b)};var l=function(b,a){if(b){var d=new Buffer(4);d.writeUInt8(4,0);d.writeUInt8(b,1);d.writeUInt8(a,2);d.writeUInt8(0,3);c.call(this,1057,d)}else c.call(this)};l.prototype=new c;l.prototype.constructor=l;l.prototype.getConnectionID=function(){return this._buffer.readUInt8(7)};l.prototype.getSeqNo=function(){return this._buffer.readUInt8(8)};l.prototype.isOK=function(){return 0===
this._buffer.readUInt8(9)};var h=function(b,a){if(b&&null!==a){var d=new Buffer(10);d.writeUInt8(b,0);d.writeUInt8(0,1);d.writeUInt8(8,2);d.writeUInt8(1,3);d.writeInt32BE(m(a.ip),4);d.writeUInt16BE(a.port,8);c.call(this,521,d)}else c.call(this)};h.prototype=new c;h.prototype.constructor=h;h.prototype.getConnectionID=function(){return this._buffer.readUInt8(6)};h.prototype.getCtrlEndpointHPAI=function(){var b=this._buffer.readUInt32BE(10);b=p(b);var c=this._buffer.readUInt16BE(14),a={};a.ip=b;a.port=
c;return a};var w=function(b){if(b){var a=new Buffer(2);a.writeUInt8(b,0);a.writeUInt8(0,1);c.call(this,1057,a)}else c.call(this)};w.prototype=new c;w.prototype.constructor=w;w.prototype.getConnectionID=function(){return this._buffer.readUInt8(6)};w.prototype.isDisconnectOK=function(){return 0===this._buffer.readUInt8(7)};c.SearchRequest=a;c.SearchResponse=b;c.ConnectionRequest=g;c.ConnectionResponse=f;c.ConnectionStateRequest=e;c.ConnectionStateResponse=k;c.TunnellingRequest=n;c.TunnellingACK=l;
c.DisconnectRequest=h;c.DisconnectResponse=w;return c}(),t=function(){var c=function(b){this._buffer=b};c.parseFrame=function(c){var a=null;switch(c.readUInt8(0)){case b.MSG_CODE:a=new b;break;case g.MSG_CODE:a=new g}a&&(a._buffer=c);return a};c.prototype={getLength:function(){return this._buffer.length},getSrcAddr:function(){return this._buffer.readUInt16BE(4)},getDstAddr:function(){return this._buffer.readUInt16BE(6)},getDataLength:function(){return this._buffer.readUInt8(8)},getAPDU:function(){var b=
this.getDataLength()+1;b=new Buffer(b);this._buffer.copy(b,0,9,9+b.length);return a.parse(b)},toBuffer:function(){return this._buffer}};var d=function(b,c){var a=new Buffer(9+c.getLength());a.writeUInt8(17,0);a.writeUInt8(0,1);a.writeUInt8(188,2);a.writeUInt8(224,3);a.writeUInt8(0,4);a.writeUInt8(0,5);a.writeInt16BE(b,6);a.writeUInt8(c.getLength()-1,8);c.toBuffer().copy(a,9);this._buffer=a};d.MSG_CODE=17;d.prototype=new c;d.prototype.constructor=d;var b=function(){this._buffer=void 0};b.MSG_CODE=
46;b.prototype=new c;b.prototype.constructor=b;var g=function(){this._buffer=void 0};g.MSG_CODE=41;g.prototype=new c;g.prototype.constructor=g;c.L_Data_Req=d;c.L_Data_Con=b;c.L_Data_Ind=g;return c}(),a=function(){var c=function(c,b,a){b||(b=0);c||(c=0);var d=1;a&&1<a.length&&(d=a.length);this._buffer=new Buffer(1+d);this._buffer.writeUInt8(c|b>>2,0);c=a&&0<a.length?a.readUInt8(0):0;this._buffer.writeUInt8(b<<6|c,1);a&&1<a.length&&a.copy(this._buffer,2,1)};c.parse=function(a){var b=new c;b._buffer=
a;return b};c.prototype={getLength:function(){return this._buffer.length},getAPCI:function(){var c=this._buffer.readUInt8(0),b=this._buffer.readUInt8(1);return(c&3)<<2|(b&192)>>6&3},getData:function(){var c=this._buffer.length-1,b=this._buffer.readUInt8(1),a=new Buffer(c);a.writeUInt8(b&63,0);1<c&&this._buffer.copy(a,1,2);return a},toBuffer:function(){return this._buffer}};return c}();l._DataLink=v;l._Tunnel=u;l.IPFrame=r;l.cEMI=t;l.APDU=a;return l}();
xnm.aio.knx.KNXGateway._DPT=function(){var m=function(a){this.type=a};m.resolve=function(a){if(!a||3>=a.length)return null;var c=a.indexOf("-");if(0>=c)return null;var d=a.substring(0,c);if("DPT"==d){if(5>a.length)return null;d=a}else if("DPST"==d){c=a.indexOf("-",c+1);if(0>c)return null;d=a.substring(0,c)}else return null;switch(d){case "DPT-1":case "DPST-1":return new p(a);case "DPT-2":case "DPST-2":return new q(a);case "DPT-3":case "DPST-3":return new l(a);case "DPT-5":case "DPST-5":return new v(a);
case "DPT-6":case "DPST-6":return new u(a);case "DPT-9":case "DPST-9":return new r(a);case "DPT-20":case "DPST-20":return new t(a)}return null};m.prototype.doCommand=function(a,c,d,b){b&&b()};m.prototype.setValue=function(a,c,d,b){a&&a instanceof Buffer?c._sendCommand(d,a,function(c){b&&b(c)}.bind(this)):b&&b(Error("invalid value"))};m.prototype.getValue=function(a,c,d){a._getState(c,function(b,c){b?d&&d(b):d&&d(null,this._resolveData(c))}.bind(this))};m.prototype._resolveDataRaw=function(a){return a.toString("hex")};
m.prototype._resolveData=function(a){return a.toString("hex")};var p=function(a){this.type=a};p.prototype=new m;p.prototype.constructor=p;p.prototype.doCommand=function(a,c,d,b){if(a){if(0==a.indexOf("setValue")){if(a=parseInt(a.substr(8)),!a||isNaN(a))a=0}else switch(a){case "on":case "true":case "enable":case "ramp":case "alarm":case "high":case "increase":case "down":case "close":case "start":case "active":case "inverted":a=1;break;case "off":case "false":case "disable":case "no_ramp":case "no_alarm":case "low":case "decrease":case "up":case "open":case "stop":case "inactive":case "not_inverted":a=
0;break;default:b&&b(Error("unknown command:"+a));return}this.setValue(a,c,d,b)}else b&&b(Error("unknown command:"+a))};p.prototype.setValue=function(a,c,d,b){var g=null;g=0==a||1==a?new Buffer([a]):a;m.prototype.setValue.call(this,g,c,d,function(c){b&&b(c)}.bind(this))};p.prototype._resolveDataRaw=function(a){return a.readUInt8(0)};p.prototype._resolveData=function(a){a=a.readUInt8(0);return this._resolveValue(a)};p.prototype._resolveValue=function(a){switch(this.type){case "DPT-1":case "DPST-1-1":return a?
"on":"off";case "DPST-1-2":return a?"true":"false";case "DPST-1-3":return a?"enable":"disable";case "DPST-1-4":return a?"ramp":"no_ramp";case "DPST-1-5":return a?"alarm":"no alarm";case "DPST-1-6":return a?"high":"low";case "DPST-1-7":return a?"increase":"decrease";case "DPST-1-8":return a?"down":"up";case "DPST-1-9":return a?"close":"open";case "DPST-1-10":return a?"start":"stop";case "DPST-1-11":return a?"active":"inactive";case "DPST-1-12":return a?"inverted":"not_inverted";case "DPST-1-13":return a?
"cyclically":"start/stop";case "DPST-1-14":return a?"calculated":"fixed";case "DPST-1-15":return a?"reset command":"no action";case "DPST-1-16":return a?"acknowledge command":"no action";case "DPST-1-18":return a?"occupied":"not occupied";case "DPST-1-19":return a?"open":"closed";case "DPST-1-21":return a?"logical function AND":"logical function OR";case "DPST-1-22":return a?"scene B":"scene A";case "DPST-1-23":return a?"move Up/Down +StepStop mode (blind)":"only move Up/Down mode (shutter)";default:return null}};
var q=function(a){this.type=a};q.prototype=new m;q.prototype.constructor=q;q.prototype.doCommand=function(a,c,d,b){if(a)if(0==a.indexOf("setValue")){a.substr(0,8);var g=parseInt(a.substr(8));if(!g||isNaN(g))g=0;this.setValue(g,c,d,b)}else{var f=a.split(".");if(2>f.length)b&&b(Error("unknown command:"+a));else{g="prio"==f[0]?1:0;switch(f[1]){case "on":case "true":case "enable":case "ramp":case "alarm":case "high":case "increase":case "down":case "close":case "start":case "active":case "inverted":g=
g<<1|1;break;case "off":case "false":case "disable":case "no_ramp":case "no_alarm":case "low":case "decrease":case "up":case "open":case "stop":case "inactive":case "not_inverted":g=g<<1|0;break;default:b&&b(Error("unknown command:"+a));return}this.setValue(g,c,d,b)}}else b&&b(Error("unknown command:"+a))};q.prototype.setValue=function(a,c,d,b){var g=null;g=0==a||1==a||2==a||3==a?new Buffer([a]):a;m.prototype.setValue.call(this,g,c,d,function(c){b&&b(c)}.bind(this))};q.prototype._resolveDataRaw=function(a){return a.readUInt8(0)};
q.prototype._resolveData=function(a){a=a.readUInt8(0);return this._resolveValue(a)};q.prototype._resolveValue=function(a){var c=1==a>>1?"prio.":"no_prio.";switch(this.type){case "DPT-2":c=a;break;case "DPST-2-1":c+=a&1?"on":"off";break;case "DPST-2-2":c+=a&1?"true":"false";break;case "DPST-2-3":c+=a&1?"enable":"disable";break;case "DPST-2-4":c+=a&1?"ramp":"no_ramp";break;case "DPST-2-5":c+=a&1?"alarm":"no alarm";break;case "DPST-2-6":c+=a&1?"high":"low";break;case "DPST-2-7":c+=a&1?"increase":"decrease";
break;case "DPST-2-8":c+=a&1?"down":"up";break;case "DPST-2-9":c+=a&1?"close":"open";break;case "DPST-2-10":c+=a&1?"start":"stop";break;case "DPST-2-11":c+=a&1?"active":"inactive";break;case "DPST-2-12":c+=a&1?"inverted":"not_inverted";break;default:return null}return c};var l=function(a){this.type=a};l.prototype=new m;l.prototype.constructor=l;l.prototype.doCommand=function(a,c,d,b){if(a){var g=null,f=0;if(0==a.indexOf("setValue")){a.substr(0,8);f=parseInt(a.substr(8));if(!f||isNaN(f))f=0;this.setValue(f,
c,d,b)}else{if("stepUpStop"==a||"stepDownStop"==a)g=a,f=0;else if(0==a.indexOf("stepUp")){if(g=a.substr(0,6),f=parseInt(a.substr(6)),!f||isNaN(f))f=1}else 0==a.indexOf("stepDown")&&(g=a.substr(0,8),f=parseInt(a.substr(8)),!f||isNaN(f))&&(f=1);a=this._getStepcode(f);if(-1==a)b&&b(Error("invalid step precent:"+f));else{switch(g){case "stepUp":g=1;if(0>=a){b&&b(Error("stepUp command value invalid"));return}break;case "stepDown":g=0;if(0>=a){b&&b(Error("stepDown command value invalid"));return}break;
case "stepUpStop":g=1;break;case "stepDownStop":g=0;break;default:b&&b(Error("unknown command:"+g));return}this.setValue(g<<3|a,c,d,b)}}}else b&&b(Error("unknown command:"+a))};l.prototype.setValue=function(a,c,d,b){0>a&&(a=0);15<a&&(a=15);a=new Buffer([a]);m.prototype.setValue.call(this,a,c,d,function(c){b&&b(c)}.bind(this))};l.prototype._resolveDataRaw=function(a){return a.readUInt8(0)};l.prototype._resolveData=function(a){a=a.readUInt8(0);return this._resolveValue(a)};l.prototype._resolveValue=
function(a){var c=a&7,d=0;0==c?d=0:1==c?d=100:2==c?d=50:3==c?d=25:4==c?d=12:5==c?d=6:6==c?d=3:7==c&&(d=1);return{direction:a&8?"up":"down",precent:d,stepcode:c}};l.prototype._getStepcode=function(a){switch(a){case 0:return 0;case 1:return 7;case 3:return 6;case 6:return 5;case 12:return 4;case 25:return 3;case 50:return 2;case 100:return 1;default:return-1}};var v=function(a){this.type=a};v.prototype=new m;v.prototype.constructor=v;v.prototype.doCommand=function(a,c,d,b){if(a){var g=a,f=0;0==a.indexOf("setValue")&&
(g=a.substr(0,8),f=parseInt(a.substr(8)),!f||isNaN(f))&&(f=0);switch(g){case "setValue":break;case "up":case "down":a=null;a="up"==g?this._getBuffer(255):this._getBuffer(0);if(!a){b&&b(Error("invalid value"));return}m.prototype.setValue.call(this,a,c,d,function(c){b&&b(c)}.bind(this));return;default:b&&b(Error("unknown command:"+g));return}this.setValue(f,c,d,b)}else b&&b(Error("unknown command:"+a))};v.prototype.setValue=function(a,c,d,b){switch(this.type){case "DPST-5-1":0>a&&(a=0);100<a&&(a=100);
a=Math.round(a/100*255);break;case "DPST-5-3":0>a&&(a=0);360<a&&(a=360);a=Math.round(a/360*255);break;case "DPST-5-6":0>a&&(a=0);254<a&&(a=254);a=Math.round(a/360*255);break;default:0>a&&(a=0),255<a&&(a=255)}(a=this._getBuffer(a))?m.prototype.setValue.call(this,a,c,d,function(c){b&&b(c)}.bind(this)):b&&b(Error("invalid value"))};v.prototype.incValue=function(a,c,d,b,g){c=this._resolveValue(c);this.setValue(c+a,d,b,g)};v.prototype.decValue=function(a,c,d,b,g){c=this._resolveValue(c);this.setValue(c-
a,d,b,g)};v.prototype._resolveDataRaw=function(a){return!a||2>a.length?null:a.readUInt8(1)};v.prototype._resolveData=function(a){if(!a||2>a.length)return null;a=a.readUInt8(1);return this._resolveValue(a)};v.prototype._resolveValue=function(a){switch(this.type){case "DPST-5-1":return Math.round(a/255*100);case "DPST-5-3":return Math.round(a/255*360);default:return a}};v.prototype._getBuffer=function(a){var c=new Buffer(2);c.writeUInt8(0,0);c.writeUInt8(a,1);return c};var u=function(a){this.type=a};
u.prototype=new m;u.prototype.constructor=u;u.prototype.doCommand=function(a,c,d,b){if(a){var g=a,f=0;0==a.indexOf("setValue")&&(g=a.substr(0,8),f=parseInt(a.substr(8)),!f||isNaN(f))&&(f=0);switch(g){case "setValue":break;default:b&&b(Error("unknown command:"+g));return}this.setValue(f,c,d,b)}else b&&b(Error("unknown command:"+a))};u.prototype.setValue=function(a,c,d,b){-128>a&&(a=-128);127<a&&(a=127);0>a&&(a+=256);(a=this._getBuffer(a))?m.prototype.setValue.call(this,a,c,d,function(c){b&&b(c)}.bind(this)):
b&&b(Error("invalid value"))};u.prototype.incValue=function(a,c,d,b,g){c=this._resolveValue(c);this.setValue(c+a,d,b,g)};u.prototype.decValue=function(a,c,d,b,g){c=this._resolveValue(c);this.setValue(c-a,d,b,g)};u.prototype._resolveDataRaw=function(a){return!a||2>a.length?null:a.readUInt8(1)};u.prototype._resolveData=function(a){if(!a||2>a.length)return null;a=a.readUInt8(1);return this._resolveValue(a)};u.prototype._resolveValue=function(a){127<a&&(a-=256);return a};u.prototype._getBuffer=function(a){var c=
new Buffer(2);c.writeUInt8(0,0);c.writeUInt8(a,1);return c};var r=function(a){this.type=a};r.prototype=new m;r.prototype.constructor=r;r.prototype.doCommand=function(a,c,d,b){if(a){var g=null,f=0;0==a.indexOf("setValue")&&(g=a.substr(0,8),f=parseFloat(a.substr(8)),!f||isNaN(f))&&(f=0);switch(g){case "setValue":break;default:b&&b(Error("unknown command:"+g));return}this.setValue(f,c,d,b)}else b&&b(Error("unknown command:"+a))};r.prototype.setValue=function(a,c,d,b){switch(this.type){case "DPT-9":-671088.64>
a&&(a=-671088.64);670760.96<a&&(a=670760.96);a=this._float2short(a);break;case "DPST-9-1":-273>a&&(a=-273);670760<a&&(a=670760);a=this._float2short(a);break;default:a=this._float2short(a)}(a=this._getBuffer(a))?m.prototype.setValue.call(this,a,c,d,function(c){b&&b(c)}.bind(this)):b&&b(Error("invalid value"))};r.prototype.incValue=function(a,c,d,b,g){c=this._resolveValue(c);this.setValue(c+a,d,b,g)};r.prototype.decValue=function(a,c,d,b,g){c=this._resolveValue(c);this.setValue(c-a,d,b,g)};r.prototype._resolveDataRaw=
function(a){return!a||3>a.length?0:a.readUInt16BE(1)};r.prototype._resolveData=function(a){if(!a||3>a.length)return 0;a=a.readUInt16BE(1);return this._resolveValue(a)};r.prototype._resolveValue=function(a){switch(this.type){case "DPT-9":case "DPST-9-1":return parseFloat(this._short2float(a).toFixed(2));default:return parseFloat(this._short2float(a).toFixed(2))}};r.prototype._getBuffer=function(a){var c=new Buffer(3);c.writeUInt8(0,0);c.writeUInt16BE(a,1);return c};r.prototype._float2short=function(a){var c=
0<=a?0:1;1==c&&(a=0-a);var d=Math.floor(Math.log(a)/Math.LN2);a=Math.round(a/Math.pow(2,d)*100);1==c&&(a=0-a);0>a&&(a+=4096);return a&2047|d<<11|c<<15};r.prototype._short2float=function(a){var c=a>>15&1,d=a&2047|c<<11;1==c&&(d-=4096);return.01*d*Math.pow(2,a>>11&15)};var t=function(a){this.type=a};t.prototype=new m;t.prototype.constructor=t;t.prototype.doCommand=function(a,c,d,b){if(a){var g=a,f=0;0==a.indexOf("setValue")&&(g=a.substr(0,8),f=parseInt(a.substr(8)),!f||isNaN(f))&&(f=0);switch(g){case "auto":f=
0;break;case "comfort":f=1;break;case "standby":f=2;break;case "economy":f=3;break;case "protection":f=4;break;case "setValue":break;default:b&&b(Error("unknown command:"+g));return}this.setValue(f,c,d,b)}else b&&b(Error("unknown command:"+a))};t.prototype.setValue=function(a,c,d,b){(a=this._getBuffer(a))?m.prototype.setValue.call(this,a,c,d,function(c){b&&b(c)}.bind(this)):b&&b(Error("invalid value"))};t.prototype.incValue=function(a,c,d,b,g){c=this._resolveValue(c);c=c.value+a;this.setValue(c,d,
b,g)};t.prototype.decValue=function(a,c,d,b,g){c=this._resolveValue(c);c=c.value-a;this.setValue(c,d,b,g)};t.prototype._resolveDataRaw=function(a){return!a||2>a.length?null:a.readUInt8(1)};t.prototype._resolveData=function(a){if(!a||2>a.length)return null;a=a.readUInt8(1);return this._resolveValue(a)};t.prototype._resolveValue=function(a){switch(this.type){case "DPT-20":break;case "DPST-20-1":switch(a){case 0:a="autonomous";break;case 1:a="slave";break;case 2:a="master";break;default:a="unknow"}break;
case "DPST-20-102":switch(a){case 0:a="auto";break;case 1:a="comfort";break;case 2:a="standby";break;case 3:a="economy";break;case 4:a="protection";break;default:a="unknow"}break;default:return null}return a};t.prototype._getBuffer=function(a){var c=new Buffer(2);c.writeUInt8(0,0);c.writeUInt8(a,1);return c};m.DPT1=p;m.DPT2=q;m.DPT3=l;m.DPT5=v;m.DPT6=u;m.DPT9=r;m.DPT20=t;return m}();
xnm.aio.knx.KNXGateway._Device=function(){var m=function(c){this._device=c};m.resolve=function(c){if(!c)return null;var d=null;switch(c.data){case "outlet":d=new q(c);break;case "lighting":d=new l(c);break;case "blind":d=new v(c);break;case "shutter":d=new u(c);break;case "heater":d=new r(c);break;case "1bit":d=new t(c);break;case "1byte":d=new a(c);break;case "general":d=new p(c)}return d};m.prototype={getDefaultChannel:function(){return null},executeCommand:function(c,a,b){this._parseCommand(c,
function(c,d,e,k){c?b&&b(c):(c=k.ga,(d=xnm.aio.knx.KNXGateway._DPT.resolve(k.type))?d.doCommand(e,a,c,function(c){b&&b(c)}.bind(this)):b&&b(Error("unknown actuator type:"+k.type)))})},_parseCommand:function(c,a){if(this._device)if(c){var b=c.indexOf("@");if(-1==b)a&&a(Error("command format invalid"));else{var d=c.substr(0,b);c=c.substr(b+1);d||(d=this.getDefaultChannel());this._device.channels&&this._device.channels[d]?(b=this._device.channels[d],b.actuator&&b.actuator.ga&&b.actuator.type?xnm.aio.knx.KNXGateway._DPT.resolve(b.actuator.type)?
a&&a(null,d,c,b.actuator):a&&a(Error("unknown actuator type:"+b.actuator.type)):a&&a(Error("device has no actuator for channel:"+d))):a&&a(Error("device has no channel with id:"+d))}}else a&&a(Error("command is null"));else a&&a(Error("device is null"))},getStates:function(c){if(!this._device||!this._device.channels)return null;var a=null,b;for(b in this._device.channels)if(this._device.channels.hasOwnProperty(b)){var g=this.getState(b,c);g&&!g.error&&(a||(a={}),null==g.resolvedValue?a[b]={state:g.resolvedValue,
raw:g.resolvedRawValue}:"object"==typeof g.resolvedValue?(a[b]=JSON.parse(JSON.stringify(g.resolvedValue)),a[b].raw=g.resolvedRawValue):a[b]={state:g.resolvedValue,raw:g.resolvedRawValue})}return a},getState:function(c,a){return this._getBufferedState(c,a)},_getBufferedState:function(c,a){var b={error:null,bufferedValue:null,resolvedRawValue:null,resovledValue:null};if(!this._device)return b.error=Error("device is null"),b;c||(c=this.getDefaultChannel());if(!this._device.channels||!this._device.channels[c])return b.error=
Error("device has no channel with id:"+c),b;c=this._device.channels[c];var d,f=null,e=null,k=null,n=a.getStateBuffer();c.event&&c.event.ga&&(f=n.getState(xnm.aio.knx.KNXGateway._adr2long(c.event.ga)))&&(d=xnm.aio.knx.KNXGateway._DPT.resolve(c.event.type))&&(k=d._resolveDataRaw(f),e=d._resolveData(f));("undefined"==typeof f||null==f)&&c.status&&c.status.ga&&(f=n.getState(xnm.aio.knx.KNXGateway._adr2long(c.status.ga)))&&(d=xnm.aio.knx.KNXGateway._DPT.resolve(c.status.type))&&(k=d._resolveDataRaw(f),
e=d._resolveData(f));if(("undefined"==typeof f||null==f)&&c.status&&c.status.ga){d=n.getStateReqTime(xnm.aio.knx.KNXGateway._adr2long(c.status.ga));var l=new Date;if(!d||l.getTime()-d.getTime()>xnm.aio.knx.KNXGateway.STATES_REQ_EXPIRED)n.setStateReqTime(xnm.aio.knx.KNXGateway._adr2long(c.status.ga),l),(d=xnm.aio.knx.KNXGateway._DPT.resolve(c.status.type))&&d.getValue(a,c.status.ga)}b.bufferedValue=f;b.resolvedRawValue=k;b.resolvedValue=e;return b},refreshStates:function(a){if(!this._device||!this._device.channels)return null;
var c=a.getStateBuffer(),b;for(b in this._device.channels)if(this._device.channels.hasOwnProperty(b)){var g=this._device.channels[b];if(g.status&&g.status.ga&&g.status.type){var f=xnm.aio.knx.KNXGateway._DPT.resolve(g.status.type);if(f){var e=new Date;c.setStateReqTime(xnm.aio.knx.KNXGateway._adr2long(g.status.ga),e);f.getValue(a,g.status.ga)}}}return null}};var p=function(a){this._device=a};p.prototype=new m;p.prototype.constructor=p;p.prototype.executeCommand=function(a,d,b){if("refreshStates"==
a)this.refreshStates(d),b&&b();else{var c=this;this._parseCommand(a,function(a,e,k,g){if(a)b&&b(a);else if(a=g.ga,g=xnm.aio.knx.KNXGateway._DPT.resolve(g.type),g instanceof xnm.aio.knx.KNXGateway._DPT.DPT1)switch(k){case "toggle":e=c.getState(e,d);if(e.err||!e.bufferedValue){b&&b(Error("device (buffered) Status unknow"));break}e=e.bufferedValue.readUInt8(0);g.setValue(e?0:1,d,a,function(a){b&&b(a)}.bind(this));break;default:g.doCommand(k,d,a,b)}else if(g instanceof xnm.aio.knx.KNXGateway._DPT.DPT2)g.doCommand(k,
d,a,b);else if(g instanceof xnm.aio.knx.KNXGateway._DPT.DPT3)g.doCommand(k,d,a,b);else if(g instanceof xnm.aio.knx.KNXGateway._DPT.DPT5){var f=k;if(0==k.indexOf("inc")){f=k.substr(0,3);var h=parseInt(k.substr(3));if(!h||isNaN(h))h=1}else 0==k.indexOf("dec")&&(f=k.substr(0,3),h=parseInt(k.substr(3)),!h||isNaN(h))&&(h=1);switch(f){case "inc":e=c.getState(e,d);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}e=e.resolvedRawValue;
g.incValue(h,e,d,a,function(a){b&&b(a)}.bind(this));break;case "dec":e=c.getState(e,d);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}e=e.resolvedRawValue;g.decValue(h,e,d,a,function(a){b&&b(a)}.bind(this));break;default:g.doCommand(k,d,a,b)}}else if(g instanceof xnm.aio.knx.KNXGateway._DPT.DPT6){f=k;if(0==k.indexOf("inc")){if(f=k.substr(0,3),h=parseInt(k.substr(3)),!h||isNaN(h))h=1}else 0==k.indexOf("dec")&&(f=k.substr(0,
3),h=parseInt(k.substr(3)),!h||isNaN(h))&&(h=1);switch(f){case "inc":e=c.getState(e,d);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}e=e.resolvedRawValue;g.incValue(h,e,d,a,function(a){b&&b(a)}.bind(this));break;case "dec":e=c.getState(e,d);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}e=e.resolvedRawValue;g.decValue(h,e,d,a,function(a){b&&
b(a)}.bind(this));break;default:g.doCommand(k,d,a,b)}}else if(g instanceof xnm.aio.knx.KNXGateway._DPT.DPT9){f=k;if(0==k.indexOf("inc")){if(f=k.substr(0,3),h=parseFloat(k.substr(4)),!h||isNaN(h))h=1}else 0==k.indexOf("dec")&&(f=k.substr(0,3),h=parseFloat(k.substr(4)),!h||isNaN(h))&&(h=1);switch(f){case "inc":e=c.getState(e,d);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}e=e.resolvedRawValue;g.incValue(h,e,d,a,function(a){b&&
b(a)}.bind(this));break;case "dec":e=c.getState(e,d);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}e=e.resolvedRawValue;g.decValue(h,e,d,a,function(a){b&&b(a)}.bind(this));break;default:g.doCommand(k,d,a,b)}}else if(g instanceof xnm.aio.knx.KNXGateway._DPT.DPT20){f=k;if(0==k.indexOf("inc")){if(f=k.substr(0,3),h=parseInt(k.substr(4)),!h||isNaN(h))h=1}else 0==k.indexOf("dec")&&(f=k.substr(0,3),h=parseInt(k.substr(4)),
!h||isNaN(h))&&(h=1);switch(f){case "inc":e=c.getState(e,d);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}e=e.resolvedRawValue;g.incValue(h,e,d,a,function(a){b&&b(a)}.bind(this));break;case "dec":e=c.getState(e,d);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));break}e=e.resolvedRawValue;g.decValue(h,e,d,a,function(a){b&&b(a)}.bind(this));break;
default:g.doCommand(k,d,a,b)}}else b&&b(Error("unknown data point type"))})}};var q=function(a){this._device=a};q.prototype=new m;q.prototype.constructor=q;q.prototype.executeCommand=function(a,d,b){if("refreshStates"==a)this.refreshStates(d),b&&b();else{var c=this;this._parseCommand(a,function(f,e,g,n){if(f)b&&b(f);else switch(f=n.ga,n=xnm.aio.knx.KNXGateway._DPT.resolve(n.type),e){case "switch":switch(g){case "on":case "off":n.doCommand(g,d,f,b);break;case "toggle":e=c.getState(e,d);if(e.err||!e.bufferedValue){b&&
b(Error("device (buffered) Status unknow"));return}e=e.bufferedValue.readUInt8(0);n.setValue(e?0:1,d,f,function(a){b&&b(a)}.bind(this));break;default:b&&b(Error("invalid device command"))}break;default:p.prototype.executeCommand.call(c,a,d,b)}})}};q.prototype.getDefaultChannel=function(){return"switch"};var l=function(a){this._device=a};l.prototype=new m;l.prototype.constructor=l;l.prototype.executeCommand=function(a,d,b){if("refreshStates"==a)this.refreshStates(d),b&&b();else{var c=this;this._parseCommand(a,
function(f,e,g,n){if(f)b&&b(f);else{f=n.ga;n=xnm.aio.knx.KNXGateway._DPT.resolve(n.type);var k=g,h=null;switch(e){case "switch":switch(g){case "on":case "off":n.doCommand(g,d,f,b);break;case "toggle":e=c.getState(e,d);if(e.err||!e.bufferedValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.bufferedValue.readUInt8(0);n.setValue(e?0:1,d,f,function(a){b&&b(a)}.bind(this));break;default:b&&b(Error("invalid device command"))}break;case "step":0==g.indexOf("stepUp")||0==g.indexOf("stepDown")?
n.doCommand(g,d,f,b):b&&b(Error("invalid device command"));break;case "value":if(0==g.indexOf("inc")){if(k=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))h=1}else if(0==g.indexOf("dec")){if(k=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))h=1}else 0==g.indexOf("dimTo")&&(k="dimTo",h=parseInt(g.substr(5)),!h||isNaN(h))&&(h=0);switch(k){case "dimUp":n.doCommand("up",d,f,b);break;case "dimDown":n.doCommand("down",d,f,b);break;case "inc":e=c.getState(e,d);if(e.err||"undefined"==typeof e.resolvedRawValue||
null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;n.incValue(h,e,d,f,function(a){b&&b(a)}.bind(this));break;case "dec":e=c.getState(e,d);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;n.decValue(h,e,d,f,function(a){b&&b(a)}.bind(this));break;case "dimTo":n.doCommand("setValue"+h,d,f,b);break;default:b&&b(Error("invalid device command"))}break;default:p.prototype.executeCommand.call(c,
a,d,b)}}})}};l.prototype.getDefaultChannel=function(){return"value"};var v=function(a){this._device=a};v.prototype=new m;v.prototype.constructor=v;v.prototype.executeCommand=function(a,d,b){if("refreshStates"==a)this.refreshStates(d),b&&b();else{var c=this;this._parseCommand(a,function(f,e,g,n){if(f)b&&b(f);else{f=n.ga;n=xnm.aio.knx.KNXGateway._DPT.resolve(n.type);var k=g,h=null;switch(e){case "blind_step":switch(g){case "blindStepUp":n.doCommand("up",d,f,b);break;case "blindStepDown":n.doCommand("down",
d,f,b);break;default:b&&b(Error("invalid device command"))}break;case "blind_move":switch(g){case "blindMoveUp":n.doCommand("up",d,f,b);break;case "blindMoveDown":n.doCommand("down",d,f,b);break;default:b&&b(Error("invalid device command"))}break;case "blind_stop":switch(g){case "blindStop":n.doCommand("stop",d,f,b);break;default:b&&b(Error("invalid device command"))}break;case "blind_position":if(0==g.indexOf("inc")){if(k=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))h=1}else if(0==g.indexOf("dec")){if(k=
g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))h=1}else 0==g.indexOf("moveTo")&&(k="moveTo",h=parseInt(g.substr(6)),!h||isNaN(h))&&(h=0);switch(k){case "moveUp":n.doCommand("down",d,f,b);break;case "moveDown":n.doCommand("up",d,f,b);break;case "inc":e=c.getState(e,d);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;n.incValue(h,e,d,f,function(a){b&&b(a)}.bind(this));break;case "dec":e=c.getState(e,
d);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;n.decValue(h,e,d,f,function(a){b&&b(a)}.bind(this));break;case "moveTo":n.doCommand("setValue"+h,d,f,b);break;default:b&&b(Error("invalid device command"))}break;case "lamella_position":if(0==g.indexOf("incL")){if(k=g.substr(0,4),h=parseInt(g.substr(4)),!h||isNaN(h))h=1}else if(0==g.indexOf("decL")){if(k=g.substr(0,4),h=parseInt(g.substr(4)),!h||
isNaN(h))h=1}else 0==g.indexOf("lamellaTo")&&(k="lamellaTo",h=parseInt(g.substr(9)),!h||isNaN(h))&&(h=0);switch(k){case "lamellaUp":n.doCommand("down",d,f,b);break;case "lamellaDown":n.doCommand("up",d,f,b);break;case "incL":e=c.getState(e,d);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;n.incValue(h,e,d,f,function(a){b&&b(a)}.bind(this));break;case "decL":e=c.getState(e,d);if(e.err||"undefined"==
typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;n.decValue(h,e,d,f,function(a){b&&b(a)}.bind(this));break;case "lamellaTo":n.doCommand("setValue"+h,d,f,b);break;default:b&&b(Error("invalid device command"))}break;default:p.prototype.executeCommand.call(c,a,d,b)}}})}};v.prototype.getDefaultChannel=function(){return"blind_position"};var u=function(a){this._device=a};u.prototype=new m;u.prototype.constructor=u;u.prototype.executeCommand=
function(a,d,b){if("refreshStates"==a)this.refreshStates(d),b&&b();else{var c=this;this._parseCommand(a,function(f,e,g,n){if(f)b&&b(f);else{f=n.ga;n=xnm.aio.knx.KNXGateway._DPT.resolve(n.type);var k=g,h=null;switch(e){case "shutter_step":switch(g){case "shutterStepUp":n.doCommand("up",d,f,b);break;case "shutterStepDown":n.doCommand("down",d,f,b);break;default:b&&b(Error("invalid device command"))}break;case "shutter_move":switch(g){case "shutterMoveUp":n.doCommand("up",d,f,b);break;case "shutterMoveDown":n.doCommand("down",
d,f,b);break;default:b&&b(Error("invalid device command"))}break;case "shutter_stop":switch(g){case "shutterStop":n.doCommand("stop",d,f,b);break;default:b&&b(Error("invalid device command"))}break;case "shutter_position":if(0==g.indexOf("inc")){if(k=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))h=1}else if(0==g.indexOf("dec")){if(k=g.substr(0,3),h=parseInt(g.substr(3)),!h||isNaN(h))h=1}else 0==g.indexOf("moveTo")&&(k="moveTo",h=parseInt(g.substr(6)),!h||isNaN(h))&&(h=0);switch(k){case "moveUp":n.doCommand("down",
d,f,b);break;case "moveDown":n.doCommand("up",d,f,b);break;case "inc":e=c.getState(e,d);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;n.incValue(h,e,d,f,function(a){b&&b(a)}.bind(this));break;case "dec":e=c.getState(e,d);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;n.decValue(h,e,d,f,function(a){b&&
b(a)}.bind(this));break;case "moveTo":n.doCommand("setValue"+h,d,f,b);break;default:b&&b(Error("invalid device command"))}break;default:p.prototype.executeCommand.call(c,a,d,b)}}})}};u.prototype.getDefaultChannel=function(){return"shutter_position"};var r=function(a){this._device=a};r.prototype=new m;r.prototype.constructor=r;r.prototype.executeCommand=function(a,d,b){if("refreshStates"==a)this.refreshStates(d),b&&b();else{var c=this;this._parseCommand(a,function(f,e,g,n){if(f)b&&b(f);else{f=n.ga;
n=xnm.aio.knx.KNXGateway._DPT.resolve(n.type);var k=g,h=null;switch(e){case "setpoint_basic":if(0==g.indexOf("tempUp")){if(k=g.substr(0,6),h=parseFloat(g.substr(6)),!h||isNaN(h))h=.5}else if(0==g.indexOf("tempDown")){if(k=g.substr(0,8),h=parseFloat(g.substr(8)),!h||isNaN(h))h=.5}else 0==g.indexOf("tempTo")&&(k="tempTo",h=parseFloat(g.substr(6)),!h||isNaN(h))&&(h=0);switch(k){case "tempUp":e=c.getState(e,d);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));
return}e=e.resolvedRawValue;n.incValue(h,e,d,f,function(a){b&&b(a)}.bind(this));break;case "tempDown":e=c.getState(e,d);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;n.decValue(h,e,d,f,function(a){b&&b(a)}.bind(this));break;case "tempTo":n.doCommand("setValue"+h,d,f,b);break;default:b&&b(Error("invalid device command"))}break;case "setpoint_shift":if(0==g.indexOf("tempShiftUp")){if(k=g.substr(0,
11),h=parseInt(g.substr(11)),!h||isNaN(h))h=1}else if(0==g.indexOf("tempShiftDown")){if(k=g.substr(0,13),h=parseInt(g.substr(13)),!h||isNaN(h))h=1}else 0==g.indexOf("tempShiftTo")&&(k="tempShiftTo",h=parseInt(g.substr(11)),!h||isNaN(h))&&(h=0);switch(k){case "tempShiftUp":e=c.getState(e,d);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;n.incValue(h,e,d,f,function(a){b&&b(a)}.bind(this));break;case "tempShiftDown":e=
c.getState(e,d);if(e.err||"undefined"==typeof e.resolvedRawValue||null==e.resolvedRawValue){b&&b(Error("device (buffered) Status unknow"));return}e=e.resolvedRawValue;n.decValue(h,e,d,f,function(a){b&&b(a)}.bind(this));break;case "tempShiftTo":n.doCommand("setValue"+h,d,f,b);break;default:b&&b(Error("invalid device command"))}break;case "mode":n.doCommand(g,d,f,b);break;default:p.prototype.executeCommand.call(c,a,d,b)}}})}};r.prototype.getDefaultChannel=function(){return"set_temperature"};var t=function(a){this._device=
a};t.prototype=new m;t.prototype.constructor=t;t.prototype.doCommand=function(a,d,b){var c={};var f=a.command;var e=a.channel;e||(e=this.getDefaultChannel());if(this._device[e])if(a=this._getWriteableGa(this._device[e]))if(a instanceof Error)b&&b(a);else switch(f){case "on":var k=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[e].actuator.type);k.setValue(1,d,a,function(a,d){a||(c.channel=e,c.state=d);b&&b(a,a?null:c)}.bind(this));break;case "off":k=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[e].actuator.type);
k.setValue(0,d,a,function(a,d){a||(c.channel=e,c.state=d);b&&b(a,a?null:c)}.bind(this));break;case "toggle":f=this._getReadableGa(this._device[e]);if(!f){b&&b(Error("invalid device has no readable address"));break}if(f instanceof Error){b&&b(a);break}k=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[e].actuator.type);k.invValue(d,a,f,function(a,d){a||(c.channel=e,c.state=d);b&&b(a,a?null:c)}.bind(this));break;default:b&&b(Error("invalid device command"))}else b&&b(Error("invalid device has no writeable address"));
else b&&b(Error("invalid device"))};t.prototype.evalGroupCommand=function(a,d,b){var c={};var f=a.command;var e=a.channel;e||(e=this.getDefaultChannel());if(this._device[e])if(a=this._getWriteableGa(this._device[e]))if(a instanceof Error)b&&b(a);else switch(f){case "on":f=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[e].actuator.type);f.evalValue(1,d,a,function(a,d){a||(c.channel=e,c.state=d);b&&b(a,a?null:c)}.bind(this));break;case "off":f=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[e].actuator.type);
f.evalValue(0,d,a,function(a,d){a||(c.channel=e,c.state=d);b&&b(a,a?null:c)}.bind(this));break;default:b&&b(Error("invalid device group command"))}else b&&b(Error("invalid device has no writeable address"));else b&&b(Error("invalid device"))};t.prototype.getState=function(a,d,b){if(a&&a.channel)var c=a.channel;c||(c=this.getDefaultChannel());this._getState(c,d,b)};t.prototype.getDefaultChannel=function(){return"channel"};var a=function(a){this._device=a};a.prototype=new m;a.prototype.constructor=
a;a.prototype.doCommand=function(a,d,b){var c,f={},e=a.command,k=a.channel;k||(k=this.getDefaultChannel());if(this._device[k]){var l=this._getWriteableGa(this._device[k]);if(l)if(l instanceof Error)b&&b(l);else if(3<=e.length&&("inc"===e.substr(0,3).toLowerCase()||"dec"===e.substr(0,3).toLowerCase())){var m=e.substr(0,3);e=e.substr(3);""==e&&(e="10");e.match(/^\d+$/)?(e=parseInt(e),(c=this._getReadableGa(this._device[k]))?c instanceof Error?b&&b(c):(a=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[k].actuator.type),
a["inc"==m?"incValue":"decValue"](e,d,l,c,function(a,c){a||null==c||(f.channel=k,f.state=c);b&&b(a,a?null:f)})):b&&b(Error("invalid device has no readable address"))):b&&b(Error("invalid device command"))}else 6<e.length&&"moveto"===e.substr(0,6).toLowerCase()&&(e=e.substr(6)),e.match(/^\d+$/)?(e=parseInt(e),a=xnm.aio.knx.KNXGateway._DPT.resolve(this._device[k].actuator.type),a.setValue(e,d,l,function(a,c){a||null==c||(f.channel=k,f.state=c);b&&b(a,a?null:f)})):b&&b(Error("invalid device command"));
else b&&b(Error("invalid device has no writeable address"))}else b&&b(Error("invalid device"))};a.prototype.evalGroupCommand=function(a,d,b){var c={},f=a.command,e=a.channel;e||(e=this.getDefaultChannel());this._device[e]?(a=this._getWriteableGa(this._device[e]))?a instanceof Error?b&&b(a):3<=f.length&&("inc"===f.substr(0,3).toLowerCase()||"dec"===f.substr(0,3).toLowerCase())?b&&b(Error("invalid device group command")):(6<f.length&&"moveto"===f.substr(0,6).toLowerCase()&&(f=f.substr(6)),f.match(/^\d+$/)?
(f=parseInt(f),xnm.aio.knx.KNXGateway._DPT.resolve(this._device[e].actuator.type).evalValue(f,d,a,function(a,d){a||null==d||(c.channel=e,c.state=d);b&&b(a,a?null:c)})):b&&b(Error("invalid device command"))):b&&b(Error("invalid device has no writeable address")):b&&b(Error("invalid device"))};a.prototype.getState=function(a,d,b){if(a&&a.channel)var c=a.channel;c||(c=this.getDefaultChannel());this._getState(c,d,b)};a.prototype.getDefaultChannel=function(){return"channel"};m.General=p;m.Outlet=q;m.Lighting=
l;m.Blind=v;m.Shutter=u;m.Heater=r;m.BIT_1=t;m.Byte_1=a;return m}();
xnm.aio.knx.Discovery={_eventEmitter:new EventEmitter,_logger:Logger.getLogger("xnm.aio.knx.Discovery"),_listenerSockets:[],_closedSockets:[],on:function(m,p){this._eventEmitter.on(m,p)},removeAllListeners:function(){this._eventEmitter.removeAllListeners()},startSearchKNX:function(){if(os&&os.networkInterfaces){var m=os.networkInterfaces(),p;for(p in m)for(var q=m[p],l=0;l<q.length;l++){var v=q[l];!1===v.internal&&"IPv4"===v.family&&this._createSocket(v.address)}}else this._createSocket(null);this._closedSockets=
[]},stopSearchKNX:function(){for(var m=0;m<this._listenerSockets.length;m++)this._listenerSockets[m].close()},_createSocket:function(m){var p=this,q=dgram.createSocket("udp4");q.on("listening",function(){q.addMembership("224.0.23.12");q.setBroadcast(!0);var l=q.address();p._logger.log("debug","knx discovery socket listening "+l.address+":"+l.port);p._listenerSockets.push(q);var m=(new xnm.aio.knx.KNXGateway.IPFrame.SearchRequest({ip:l.address,port:l.port})).toBuffer();p._logger.log("debug","send knx search request: "+
m.toString("hex")+" from "+l.address+":"+l.port);q.send(m,0,m.length,3671,"224.0.23.12")});q.on("message",function(l,m){var u=q.address();p._logger.log("trace","receive data "+l.toString("hex")+" from "+m.address+":"+m.port+" @local "+u.address+":"+u.port);l=xnm.aio.knx.KNXGateway.IPFrame.parseFrame(l);l instanceof xnm.aio.knx.KNXGateway.IPFrame.SearchResponse&&(m=l.getCtrlEndpointHPAI(),p._logger.log("debug","find knx "+m.ip+":"+m.port),p._eventEmitter.emit("found",l,u),p._eventEmitter.emit("device",
l.toJSON(),u))});q.on("error",function(l){p._logger.log("debug","discovery socket error: "+l.stack);p._eventEmitter.emit("error",l)});q.on("close",function(){p._logger.log("debug","discovery socket closed");p._closedSockets.push(q);p._listenerSockets.length===p._closedSockets.length&&(p._listenerSockets=[],p._closedSockets=[],p._eventEmitter.emit("close"))});q.bind(null,m)}};
xnm.aio.knx.Handler=function(){var m=function(){this._listenerSockets=[]};m.prototype={KNXGateway:xnm.aio.knx.KNXGateway,Finder:xnm.aio.knx.Discovery};return m}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.knx.Handler);
