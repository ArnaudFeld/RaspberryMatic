var util=require("util"),commandman=require("x.hub.commandman.js"),x=x||{};x.hub=x.hub||{};x.hub.group=x.hub.group||{};
x.hub.group.GroupManager=function(){var g=function(b,a,c){this._id=b;this._type=a;this._logger=require("x.logger.js").getLogger("x.hub.group.Group.["+b+"]");this._devices=c};g.prototype.getId=function(){return this._id};g.prototype.executeCommand=function(b,a){if(this._devices&&this._devices.length)for(var c=this._devices.length,e=function(){c--;0==c&&a&&a()},d=0;d<this._devices.length;d++)this._doDeviceCommand(this._devices[d],b,e);else a&&a()};g.prototype._doDeviceCommand=function(b,a,c){this._logger.log("trace",
"execute command:"+JSON.stringify(a)+" for device:"+JSON.stringify(b));if(b){var e=JSON.parse(JSON.stringify(b)),d;for(d in a)"group"!=d&&(e[d]=a[d]);var h=this;commandman.commandHandlerV6.executeCommandWithCommandInfo(e,function(k){h._logger.log("trace","execute command finish:"+JSON.stringify(a)+" for device:"+JSON.stringify(b)+(k?" failed:"+k.message:" success"));c&&c(k)})}else c&&c()};g.parse=function(b,a){return b&&a&&a.type?new g(b,a.type,a.devices):null};var f=function(){this._logger=require("x.logger.js").getLogger("x.hub.group.GroupManager");
this._groups=this._dataFolder=null;this._writing=!1;this._writeCallbacks=[]};f.FILE_NAME="group.json";f.prototype.init=function(b,a){this._logger.log("info","init group manager");this._dataFolder=b.getUserRootDataPath();this._loadGroups(function(c){a&&a(c)})};f.prototype.getGroups=function(){return this._groups};f.prototype.getGroup=function(b){return this._groups?this._groups[b]:null};f.prototype.setGroup=function(b,a,c){void 0==b||null==b?c&&c(Error("invalid group id")):(a?this._groups[b]=a:delete this._groups[b],
this._writeGroups(function(e){c&&c(e,a)}))};f.prototype.executeGroupCommand=function(b,a,c){if(void 0!=b&&null!=b&&this._groups[b])if(a){var e=g.parse(b,this._groups[b]);e?(this._logger.log("trace","execute group#"+b+" command:"+JSON.stringify(a)),e.executeCommand(a,c)):c&&c(Error("invalid group"))}else c&&c(Error("invalid command"));else c&&c(Error("invalid group id"))};f.prototype._loadGroups=function(b){var a=require("fs-extra"),c=this._getFile(),e=this;a.ensureFile(c,function(d){d?b(d):e._loadFile(function(h,
k){h?b(h):(e._groups=k?k:{},b())})})};f.prototype._writeGroups=function(b){b&&-1==this._writeCallbacks.indexOf(b)&&this._writeCallbacks.push(b);if(!this._writing&&this._writeCallbacks.length){this._writing=!0;var a=this._writeCallbacks;this._writeCallbacks=[];var c=this;this._writeFile(this._groups,function(e){c._writing=!1;a.forEach(function(d){try{d&&d(e)}catch(h){}});c._writeGroups()})}};f.prototype._getFile=function(){return require("path").resolve(this._dataFolder,f.FILE_NAME)};f.prototype._loadFile=
function(b){var a=require("fs"),c=this._getFile();a.readFile(c,"utf8",function(e,d){if(e)b(e);else if(d)try{var h=JSON.parse(d);b(null,h)}catch(k){b(null,{})}else b(null,{})})};f.prototype._writeFile=function(b,a){var c=require("fs"),e=this._getFile();c.writeFile(e,JSON.stringify(b,null,2),function(d){a&&a(d)})};return f}();
x.hub.group.Handler=function(){var g=function(){this._logger=require("x.logger.js").getLogger("x.hub.group.Handler");this._groupManager=new x.hub.group.GroupManager};g.prototype.init=function(f,b,a){"CA"==global.HARDWARE_VERSION&&this._initHttpApi(f);this._groupManager.init(b,function(c){c&&a(c)})};g.prototype.getGroupManager=function(){return this._groupManager};g.prototype._initHttpApi=function(){var f=this,b=require("x.hub.js").getServer();b.addRoute("/api/groups",{method:"GET"},function(a,c,e){a=
f._groupManager.getGroups();c.json({XC_SUC:a?a:{}})});b.addRoute("/data/grp/",{method:"GET"},function(a,c,e){a=a.path.substr(10);(a=f._groupManager.getGroup(a))?c.json({XC_SUC:a}):c.json({XC_ERR:{code:"000101",msg:"failed to open file"}})});b.addRoute("/data/grp/",{method:"POST"},function(a,c){var e=a.path.substr(10);try{f._groupManager.setGroup(e,a.json,function(d,h){d?c.json({XC_ERR:{code:"000101",msg:"failed to set group:"+d.message}}):h?c.json({XC_SUC:{bytes:a.size}}):c.json({XC_SUC:{bytes:0}})})}catch(d){c.json({XC_ERR:{code:"000101",
msg:"failed to set group:"+d.message}})}})};return g}();module.exports=new x.hub.group.Handler;
