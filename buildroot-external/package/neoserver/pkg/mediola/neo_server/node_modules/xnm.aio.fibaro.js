var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.fibaro=xnm.aio.fibaro||{};
xnm.aio.fibaro.HomeCenter=function(){var e=function(b,a,c,d,g){var f=require("x.logger.js");this._logger=f?f.getLogger("xnm.aio.fibaro.HomeCenter"):{log:function(){}};this.ip=b;this.uuid=d;this.user=a;this.password=c;this.name=g;this.CommandHandler=null;this._getStatesCBs=[]};e.ACTION_LIST="turnOn turnOff setValue startLevelIncrease startLevelDecrease stopLevelChange close open stop pressButton setArmed setSetpointMode setThermostatSetpoint setMode setFanMode setTargetLevel setTime setColor startProgram".split(" ");e.PROPERTY_LIST=
"value state batteryLevel power energy armed tamper on mute volume mode targetLevel wakeUpTime Humidity Pressure Temperature WeatherCondition Wind".split(" ");e.SET_POINT_MODES=["OFF","HEAT","COOL","AUTO","AUXILIARY_HEAT","RESUME","FAN_ONLY","FURNACE","DRY_AIR","MOIST","AUTO_CHANGEOVER","ENERGY_SAVE_HEAT","ENERGY_SAVE_COOL","AWAY",null,"FULL_POWER"];e.OP_MODES="OFF HEATING COOLING AUTO PENDING_HEAT PENDING_COOL VENT_ECONOMIZER AUX_HEATING 2ND_STAGE_HEATING 2ND_STAGE_COOLING 2ND_STAGE_AUX_HEAT 3RD_STAGE_AUX_HEAT".split(" ");
e.FAN_MODES="AUTO_LOW LOW AUTO_HIGH HIGH AUTO_MEDIUM MEDIUM CIRCULATION HUMIDITY LEFT_RIGHT UP_DOWN QUIET 3RD_STAGE_AUX_HEAT".split(" ");e.prototype._callAction=function(b,a,c,d){b="/api/callAction?deviceID="+b+"&name="+a;for(a=0;a<c.length;a++)b+="&arg"+(a+1)+"="+encodeURIComponent(c[a]);this._doRestApi("GET",b,null,function(a,c){d&&d(a,c)})};e.prototype._getRooms=function(b){this._doRestApi("GET","/api/rooms",null,function(a,c){b&&b(a,c)})};e.prototype._getDevices=function(b){this._doRestApi("GET",
"/api/devices",null,function(a,c){b&&b(a,c)})};e.prototype._getGlobalVariables=function(b){this._doRestApi("GET","/api/globalVariables",null,function(a,c){b&&b(a,c)})};e.prototype._setGlobalVariableValue=function(b,a,c){this._doRestApi("PUT","/api/globalVariables/"+b,JSON.stringify({name:b,value:a+""}),function(a,b){c&&c(a,b)})};e.prototype._doRestApi=function(b,a,c,d){this._doRequest(b,a,c,function(a,c,b){if(a)a.code="timeout"==a.reason?2:1,d&&d(a);else if(200!=b&&202!=b)a=Error("http result status code:"+
b),a.code=b,d&&d(a);else try{var e=JSON.parse(c);d&&d(null,e)}catch(n){n.code=3,d&&d(n)}})};e.prototype._doRequest=function(b,a,c,d){b={host:this.ip,path:a,method:b,headers:{Authorization:"Basic "+(new Buffer(this.user+":"+this.password)).toString("base64"),Connection:"close","Content-Type":"text/plain"}};c&&(b.headers["Content-Length"]=c.length);var g=this;a=require("http");this._logger.log("trace","do http request:"+JSON.stringify(b));b=a.request(b,function(a){a.setEncoding("utf-8");var c="";a.on("data",
function(a){c+=a});a.on("end",function(){g._logger.log("trace","receive http response:"+c+" with code:"+a.statusCode);d&&d(null,c,a.statusCode);d=null})});b.on("error",function(a){g._logger.log("warn","do http request error:"+a.message);d&&d(a);d=null});b.setTimeout(4E3,function(){g._logger.log("warn","do http request timeout");var a=Error("timeout");a.reason="timeout";d&&d(a);d=null});c&&b.write(c);b.end()};e.prototype.executeCommandCreator=function(b,a,c){if(b&&b.address)if(a&&a.value){var d=a.value;
if("global_variable"==b.type)d=a.ext;else if("setSetpointMode"==d){if(!a.ext){c&&c(Error("setSetpointMode invalid"));return}a=e.SET_POINT_MODES.indexOf(a.ext);if(-1==a){c&&c(Error("unknown setSetpointMode mode"));return}d+=a}else if(0==d.indexOf("setThermostatSetpoint")){if(!a.ext){c&&c(Error("setThermostatSetpoint invalid"));return}d+=":"+a.ext}else if("setMode"==d){if(!a.ext){c&&c(Error("setMode invalid"));return}a=e.OP_MODES.indexOf(a.ext);if(-1==a){c&&c(Error("unknown setMode mode"));return}d+=
a}else if("setFanMode"==d){if(!a.ext){c&&c(Error("setFanMode invalid"));return}a=e.FAN_MODES.indexOf(a.ext);if(-1==a){c&&c(Error("unknown setFanMode mode"));return}d+=a}else if(0==d.indexOf("setTargetLevel")){if(!a.ext){c&&c(Error("setTargetLevel invalid"));return}d+=a.ext}else if(0==d.indexOf("setTime")){if("undefined"==typeof a.ext||null==a.ext){c&&c(Error("setTime invalid"));return}d+=a.ext}else if("rgbw"==d){if("undefined"==typeof a.ext||null==a.ext){c&&c(Error("rgbw invalid"));return}d="setColor"+
a.ext}else if("startProgram"==d){if("undefined"==typeof a.ext||null==a.ext){c&&c(Error("startProgram invalid"));return}d+=a.ext}else"undefined"!=typeof a.ext&&null!=a.ext&&("setValue"==d&&(d+=a.ext),"disarm"==d&&(d+=a.ext));this.executeCommand(b,d,function(a,d){c&&c(a,d)})}else c&&c(Error("command invalid"));else c&&c(Error("device invalid"))};e.prototype.getStatesCreator=function(b,a,c){if(a)if(0==a.length)c&&c(null,[]);else if(a){for(var d=[],g=0;g<a.length;g++){var f=a[g];f&&f.device&&f.device.address&&
d.push(f.device.address)}this.getStates(b,d,function(d,b,g){if(d)c&&c(d);else{d=[];if(b)for(var f=0;f<a.length;f++)if(a[f]){var r=a[f].id,m=a[f].device,q=a[f].status;if(r&&q&&q.value&&m&&m.address){var k="?";if("global_variable"==m.type)m=g[m.address],k=parseInt(m);else if(m=b[m.address])switch(q.value){case "onoffValue":k=m.value;k="true"==k?"on":"off";break;case "intValue":k=m.value;k=parseInt(k);break;case "boolValue":k=m.value;break;case "floatValue":k=m.value;k=parseFloat(k);break;case "setpointMode":k=
m.mode;k=e.SET_POINT_MODES[parseInt(k)];break;case "opMode":k=m.mode;k=e.OP_MODES[parseInt(k)];break;case "fanMode":k=m.mode;k=e.FAN_MODES[parseInt(k)];break;default:k=m[q.value]}if("undefined"==typeof k||null==k)k="?";d.push({id:r,status:k})}}c&&c(null,d)}})}else c&&c(Error("deviceList is null"));else c&&c(Error("deviceList is null"))};e.prototype.getDevices=function(b){var a={},c={};a[0]={name:"Unassigned"};var d=this;this._getRooms(function(g,f){if(g)b&&b(g);else{if(f)for(var e=0;e<f.length;e++)a[f[e].id]=
{name:f[e].name,section:f[e].sectionID};d._getDevices(function(g,e){if(g)b&&b(g);else{if(e)for(var f=0;f<e.length;f++){var h=e[f];h.visible&&"HC_user"!=h.type&&(c[h.id]={sys:"fibaro",name:h.name,address:h.id,room:h.roomID,type:h.type,baseType:h.baseType,actions:h.actions,states:h.properties})}d._getGlobalVariables(function(d,g){if(d)b&&b(d);else{for(var e={},f=0;f<g.length;f++){var h=g[f];h&&h.name&&(e[h.name]={sys:"fibaro",name:h.name,address:h.name,readOnly:h.readOnly,isEnum:h.isEnum,type:"global_variable"})}b&&
b(null,{rooms:a,devices:c,variables:e})}})}})}})};e.prototype.executeCommand=function(b,a,c){if("global_variable"==b.type)"undefined"==typeof a&&null==a?c&&c(Error("command ext invalid")):this._setGlobalVariableValue(b.address,a,function(a){c&&c(a)});else{var d=a,g=[];if("number"==typeof a)d="setValue",g.push(a);else if("string"==typeof a)if("on"==a)d="turnOn";else if("off"==a)d="turnOff";else{if("toggle"==a){var e=this;this._getDevices(function(a,d){if(a)c&&c(a);else{for(var g=null,h=0;h<d.length;h++){var m=
d[h];if(m.id&&m.properties&&m.id==b.address){"false"==m.properties.value?g="on":"true"==m.properties.value&&(g="off");break}}g?e.executeCommand(b,g,c):c&&c(Error("device has no on/off state"))}});return}if("arm"==a)d="setArmed",g=[1];else if(0==a.indexOf("disarm"))g=[0],g.push(a.replace(/disarm/g,"")),d="setArmed";else if(0==a.indexOf("dimTo"))g.push(parseInt(a.replace(/dimTo/g,""))),d="setValue";else if(0==a.indexOf("moveTo"))g.push(parseInt(a.replace(/moveTo/g,""))),d="setValue";else if(0==a.indexOf("setTo"))g.push(parseInt(a.replace(/setTo/g,
""))),d="setValue";else if(0==a.indexOf("setValue"))g.push(parseInt(a.replace(/setValue/g,""))),d="setValue";else if(0==a.indexOf("setSetpointMode"))g.push(parseInt(a.replace(/setSetpointMode/g,""))),d="setSetpointMode";else if(0==a.indexOf("setThermostatSetpoint"))a=a.replace(/setThermostatSetpoint/g,""),a=a.split(":"),g.push(parseInt(a[0]),parseFloat(a[1])),d="setThermostatSetpoint";else if(0==a.indexOf("setMode"))g.push(parseInt(a.replace(/setMode/g,""))),d="setMode";else if(0==a.indexOf("setFanMode"))g.push(parseInt(a.replace(/setFanMode/g,
""))),d="setFanMode";else if(0==a.indexOf("setTargetLevel"))g.push(parseFloat(a.replace(/setTargetLevel/g,""))),d="setTargetLevel";else if(0==a.indexOf("setTime"))g.push(parseInt(a.replace(/setTime/g,""))),d="setTime";else if(0==a.indexOf("setColor")){var h=a.replace(/setColor/g,""),g=h.substr(0,2);a=h.substr(2,2);d=h.substr(4,2);h=h.substr(6,2);g=[parseInt(g,16),parseInt(a,16),parseInt(d,16),parseInt(h,16)];d="setColor"}else 0==a.indexOf("startProgram")?(g.push(parseInt(a.replace(/startProgram/g,
""))),d="startProgram"):d=a}this._callAction(b.address,d,g,function(a,d){c&&c(a,d)})}};e.prototype.getStates=function(b,a,c){c||(c=function(){});var d=this._getStatesCBs.length;-1==this._getStatesCBs.indexOf(c)&&this._getStatesCBs.push(c);if(!(0<d)){var g=this;this.CommandHandler=b;this._getGlobalVariables(function(c,d){if(c){var b=g._getStatesCBs;g._getStatesCBs=[];for(var n=0;n<b.length;n++)b[n](c)}else{for(var p={},n=0;n<d.length;n++)(b=d[n])&&b.name&&(p[b.name]=b.value);g._getDevices(function(c,
d){if(c){var b=g._getStatesCBs;g._getStatesCBs=[];for(var f=0;f<b.length;f++)b[f](c)}else{for(var h={},f=0;f<d.length;f++)if(b=d[f],b.id&&b.properties&&(null==a||-1!=a.indexOf(b.id))){h[b.id]={};for(var n in b.properties)-1!=e.PROPERTY_LIST.indexOf(n)&&(h[b.id][n]=b.properties[n])}b=g._getStatesCBs;g._getStatesCBs=[];for(f=0;f<b.length;f++)b[f](null,h,p)}})}})}};e.prototype.getStateValues=function(b,a){return a};e.prototype.toJSON=function(){return{sys:"fibaro",ip:this.ip,username:this.user,password:this.password,
uuid:this.uuid,name:this.name}};e.prototype.equalsTo=function(b){return b&&b instanceof e?this.ip==b.ip&&this.user==b.user&&this.password==b.password:!1};e.Discovery=function(){this._homeCenters=[];this._sockets=[];this._searchTimeout=null;this._running=!1;this._listeners=[];this._callbacks=[];var b=require("x.logger.js");this._logger=b?b.getLogger("xnm.aio.fibaro.HomeCenter.Discovery"):{log:function(){}};this.discoverHomeCenters=function(a,c,d){c&&-1==this._listeners.indexOf(c)&&this._listeners.push(c);
d&&-1==this._callbacks.indexOf(d)&&this._callbacks.push(d);a||(a=5E3);if(!this._running){this._logger.log("debug","start search home center");var b=this;this._running=!0;this._createSockets(function(c){c?b._finishDiscover(c):(b._sendDiscoveryMessages(),b._searchTimeout=setTimeout(function(){b._finishDiscover(null,b._homeCenters)},a))})}};this._createSockets=function(a){var c=require("os");require("dgram");var d=this;if(c&&c.networkInterfaces){var c=c.networkInterfaces(),b=[],e;for(e in c)if(c.hasOwnProperty(e))for(var h=
c[e],l=0;l<h.length;l++)"IPv4"==h[l].family&&0==h[l].internal&&b.push(h[l]);var n=0,p=0;e=function(c,e){n++;if(c&&(p++,e)){var f=d._sockets.indexOf(e);-1!=f&&d._sockets.splice(f,1)}n==b.length&&(p==n?a&&a(c):a&&a())};for(c=0;c<b.length;c++)this._addDiscoverSocket(44444,b[c],e)}else this._addDiscoverSocket(44444,null,function(c,b){if(c&&b){var g=d._sockets.indexOf(b);-1!=g&&d._sockets.splice(g,1)}a&&a(c)})};this._closeSockets=function(){for(var a=0;a<this._sockets.length;a++)this._sockets[a].close()};
this._addDiscoverSocket=function(a,c,d){var b=this,e=require("dgram"),h;try{h=e.createSocket({reuseAddr:!0,type:"udp4"})}catch(l){h=e.createSocket("udp4")}h.on("listening",function(){h.setBroadcast(!0);h._listening=!0;b._logger.log("trace","success to bind on port:"+a+(c?" with interface:"+c.address:""));d&&d(null,h)});h.on("message",function(a,c){b._receivedData(c.address,a)});h.on("error",function(e){h._listening||(b._logger.log("trace","failed to bind on port:"+a+(c?" with interface:"+c.address:
"")),d&&d(e,h))});try{c?(b._logger.log("trace","try to bind on port:"+a+" with interface:"+c.address),h.bind(a,c.address)):(b._logger.log("trace","try to bind on port:"+a),h.bind(a)),this._sockets.push(h)}catch(n){d&&d(n)}};this._sendDiscoveryMessages=function(){for(var a=new Buffer([70,73,66,65,82,79]),c=0;c<this._sockets.length;c++)this._sockets[c].send(a,0,a.length,44444,"255.255.255.255")};this._receivedData=function(a,c){c=c.toString("hex");c=new Buffer(c,"hex");if(3<=c.length){var b=c.toString();
this._logger.log("trace","receive packet:"+b+" from:"+a);var g=b.split(" ");if(3==g.length&&"ACK"==g[0]){b=new e(a,null,null,g[2]);b.name=g[1];for(var f=!1,g=0;g<this._homeCenters.length;g++){var h=this._homeCenters[g];if(h&&h.uuid==b.uuid){f=!0;break}}if(!f)for(this._homeCenters.push(b),f=0;g<this._listeners.length;f++)this._listeners[f](b)}}};this._finishDiscover=function(a,c){var b=this._callbacks;this._closeSockets();this._sockets=[];this._homeCenters=[];this._running=!1;this._listeners=[];this._callbacks=
[];for(var e=0;e<b.length;e++){var f=b[e];f&&f(a,c)}}};return e}();
xnm.aio.fibaro.DM=function(){var e=function(b,a){this.code=b;this.message=a;this.stack=Error().stack};e.prototype=Error();e.prototype.name="FibaroDMError";e.prototype.code=0;e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"fibaro",getGatewayType:function(){return[{sys:this.SYS,name:"FIBARO Home Center 2"}]},getGatewayDeviceType:function(){return[]},createGateway:function(b,a,c){a=e.ERROR_CODE;b?b.ip?b.username?b.password?c(null,b):c(new e(a.INVALID,
"password is invalid")):c(new e(a.INVALID,"username is invalid")):c(new e(a.INVALID,"ip is invalid")):c(new e(a.INVALID,"info is invalid"))},updateGateway:function(b,a,c,d){b=e.ERROR_CODE;a?a.ip?a.username?a.password?d(null,a):d(new e(b.INVALID,"password is invalid")):d(new e(b.INVALID,"username is invalid")):d(new e(b.INVALID,"ip is invalid")):d(new e(b.INVALID,"update is invalid"))},deleteGateway:function(b,a,c){c()},createDevice:function(b,a,c){var d=e.ERROR_CODE;if(b)if(b.gateway)if(b.address)if(b.type)if(a.data&&
a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var g,f;for(g=0;g<a.length;g++)if(a[g].index===b.gateway){f=a[g];break}f?c(null,b):c(new e(d.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else c(new e(d.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));else c(new e(d.INVALID,"type is invalid"));else c(new e(d.INVALID,"address is invalid"));else c(new e(d.INVALID,"gateway is invalid"));else c(new e(d.INVALID,"info is invalid"))},updateDevice:function(b,a,c){var d=
e.ERROR_CODE;if(b)if(b.gateway)if(b.address)if(b.type)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var g,f;for(g=0;g<a.length;g++)if(a[g].index===b.gateway){f=a[g];break}f?c(null,b):c(new e(d.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else c(new e(d.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));else c(new e(d.INVALID,"type is invalid"));else c(new e(d.INVALID,"address is invalid"));else c(new e(d.INVALID,"gateway is invalid"));else c(new e(d.INVALID,
"info is invalid"))},deleteDevice:function(b,a,c){c()},applyUIFilter:function(b,a){var c=this,d=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},e=function(a,b,c){var e=[];switch(c.catagory){case "command":a.command&&a.command.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},f=function(a,
b){var d=[],f=null;if(f=c.getCommandStatusMap(a))f=e(f,a,b),d=d.concat(f);return d};if(!b||null==b.type||"undefined"==typeof b.type)return null;var h=JSON.parse(JSON.stringify(b)),l=null;switch(a.catagory){case "command":l=f(b,a);h.command=l;break;case "status":l=f(b,a);h.status=l;break;default:return null}return l&&0!=l.length?h:null},getCommandStatusMap:function(b){if(!b)return null;var a={command:[],status:[]};if("global_variable"==b.type)return b.readOnly||a.command.push({type:"int",name:"set value",
ref:{value:"setValue",ext:"%d"}}),a.status.push({type:"int",name:"value",ref:{value:"value"}}),a;var c=b.actions,d=b.states;if(c)for(var e in c)if(e&&-1!=xnm.aio.fibaro.HomeCenter.ACTION_LIST.indexOf(e))switch(e){case "turnOn":a.command.push({type:"enum",name:"on",ref:{value:"on"}});break;case "turnOff":a.command.push({type:"enum",name:"off",ref:{value:"off"}});break;case "setValue":a.command.push({type:"int",name:"set value",ref:{value:"setValue",ext:"%d",extMeta:"0-100"}});break;case "startLevelIncrease":a.command.push({type:"enum",
name:"up",ref:{value:"startLevelIncrease"}});break;case "startLevelDecrease":a.command.push({type:"enum",name:"down",ref:{value:"startLevelDecrease"}});break;case "stopLevelChange":a.command.push({type:"enum",name:"stop level change",ref:{value:"stopLevelChange"}});break;case "setArmed":a.command.push({type:"enum",name:"arm",ref:{value:"arm"}});a.command.push({type:"string",name:"disarm",ref:{value:"disarm",ext:"%s",unit:"(pin)"}});break;case "setTargetLevel":b&&"com.fibaro.hvac"==b.baseType?a.command.push({type:"float",
name:"set point",ref:{value:"setTargetLevel",ext:"%f",extMeta:"4.0-30.0",scale:"0.5"}}):a.command.push({type:"float",name:"set target level",ref:{value:"setTargetLevel",ext:"%f"}});break;case "setTime":a.command.push({type:"int",name:"set time",ref:{value:"setTime",ext:"%d",extMeta:"0-21600",unit:"s"}});break;case "setSetpointMode":if(d&&d.supportedModes){var f=d.supportedModes.split(",");if(0<f.length){var h={type:"enum",name:"set point mode",ref:{value:"setSetpointMode",ext:"%e",extMeta:[]}};f.forEach(function(a){(a=
xnm.aio.fibaro.HomeCenter.SET_POINT_MODES[parseInt(a)])&&h.ref.extMeta.push(a)});a.command.push(h)}}break;case "setThermostatSetpoint":d&&d.supportedModes&&(f=d.supportedModes.split(","),0<f.length&&f.forEach(function(c){var b=xnm.aio.fibaro.HomeCenter.SET_POINT_MODES[parseInt(c)];b&&a.command.push({type:"float",name:"set point ("+b+")",ref:{value:"setThermostatSetpoint"+c,ext:"%f",extMeta:"4.0-30.0",scale:"0.5"}})}));break;case "setMode":d&&d.supportedModes&&(f=d.supportedModes.split(","),0<f.length&&
(h={type:"enum",name:"set op mode",ref:{value:"setMode",ext:"%e",extMeta:[]}},f.forEach(function(a){(a=xnm.aio.fibaro.HomeCenter.OP_MODES[parseInt(a)])&&h.ref.extMeta.push(a)}),a.command.push(h)));break;case "setFanMode":d&&d.supportedModes&&(f=d.supportedModes.split(","),0<f.length&&(h={type:"enum",name:"set fan mode",ref:{value:"setFanMode",ext:"%e",extMeta:[]}},f.forEach(function(a){(a=xnm.aio.fibaro.HomeCenter.FAN_MODES[parseInt(a)])&&h.ref.extMeta.push(a)}),a.command.push(h)));break;case "setColor":a.command.push({type:"rgbw",
name:"rgb+white color",ref:{value:"rgbw",ext:"%s"}});break;case "startProgram":a.command.push({type:"int",name:"start program",ref:{value:"startProgram",ext:"%d"}});break;default:a.command.push({type:"enum",name:e,ref:{value:e}})}if(d)for(var l in d)if(l&&-1!=xnm.aio.fibaro.HomeCenter.PROPERTY_LIST.indexOf(l))switch(l){case "value":c&&c.setValue?a.status.push({type:"int",name:"value",ref:{value:"intValue",ext:"%d"}}):c&&c.setThermostatSetpoint?a.status.push({type:"float",name:"set point value",ref:{value:"floatValue",
ext:"%f"}}):b&&"com.fibaro.hvac"==b.baseType?a.status.push({type:"float",name:"set point value",ref:{value:"floatValue",ext:"%f"}}):c&&"undefined"!=typeof c.turnOn&&null!=c.turnOn?(a.command.push({type:"enum",name:"toggle",ref:{value:"toggle"}}),a.status.push({type:"enum",name:"value",ref:{value:"onoffValue",options:["on","off"]}})):"true"==d.value||"false"==d.value?a.status.push({type:"enum",name:"value",ref:{value:"boolValue",options:["true","false"]}}):a.status.push({type:"float",name:"value",
ref:{value:"floatValue",ext:"%f"}});break;case "targetLevel":c&&c.setThermostatSetpoint?a.status.push({type:"float",name:"set point target",ref:{value:"targetLevel",ext:"%f"}}):b&&"com.fibaro.hvac"==b.baseType?a.status.push({type:"float",name:"set point target",ref:{value:"targetLevel",ext:"%f"}}):a.status.push({type:"float",name:"target level",ref:{value:"targetLevel",ext:"%f"}});break;case "mode":c&&c.setSetpointMode?d.supportedModes&&(f=d.supportedModes.split(","),0<f.length&&(h={type:"enum",name:"set point mode",
ref:{value:"setpointMode",options:[]}},f.forEach(function(a){(a=xnm.aio.fibaro.HomeCenter.SET_POINT_MODES[parseInt(a)])&&h.ref.options.push(a)}),a.status.push(h))):c&&c.setMode?d.supportedModes&&(f=d.supportedModes.split(","),0<f.length&&(h={type:"enum",name:"op mode",ref:{value:"opMode",options:[]}},f.forEach(function(a){(a=xnm.aio.fibaro.HomeCenter.OP_MODES[parseInt(a)])&&h.ref.options.push(a)}),a.status.push(h))):c&&c.setFanMode?d.supportedModes&&(f=d.supportedModes.split(","),0<f.length&&(h={type:"enum",
name:"fan mode",ref:{value:"fanMode",options:[]}},f.forEach(function(a){(a=xnm.aio.fibaro.HomeCenter.FAN_MODES[parseInt(a)])&&h.ref.options.push(a)}),a.status.push(h))):"true"==d.value||"false"==d.value?a.status.push({type:"enum",name:"state",ref:{value:"boolValue",options:["true","false"]}}):a.status.push({type:"float",name:"state",ref:{value:"floatValue",ext:"%f"}});break;case "armed":case "tamper":a.status.push({type:"enum",name:l,ref:{value:l,options:["true","false"]}});break;case "WeatherCondition":a.status.push({type:"string",
name:l,ref:{value:l}});break;default:a.status.push({type:"float",name:l,ref:{value:l,ext:"%f"}})}return a}}}();
xnm.aio.fibaro.Handler=function(){var e=function(){this.detectedHomecenters={};this.discovery=new this.HomeCenter.Discovery};e.prototype.HomeCenter=xnm.aio.fibaro.HomeCenter;e.prototype.devicemanager=xnm.aio.fibaro.DM;e.prototype.registModule=function(b){b.register(this.devicemanager.SYS,"fibaro")};e.prototype.discoverHomeCenters=function(b,a){this.discovery.discoverHomeCenters(b,null,function(c,b){a&&a(c,b)})};e.prototype.resolveGateway=function(b){return b&&b.ip&&b.username?new this.HomeCenter(b.ip,
b.username,b.password,b.uuid,b.name):null};e.prototype.getDeviceCommands=function(b,a){var c=this.devicemanager.applyUIFilter(b,{catagory:"command",elems:"*"}),c=c?c.command:[];a&&a(null,c)};e.prototype.getDeviceStatus=function(b,a){var c=this.devicemanager.applyUIFilter(b,{catagory:"status",elems:"*"}),c=c?c.status:[];a&&a(null,c)};e.prototype.doCommand=function(b,a,c,d){(b=this.resolveGateway(b))?b.executeCommandCreator(a,c,function(a){d&&d(a)}):d&&d(Error("gateway json format invalid"))};e.prototype.doStatus=
function(b,a,c,d,e){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:b,device:c,status:d}],function(a,b){a?e&&e(a):e&&e(null,b[0])}):e&&e(Error("gateway json format invalid"))};e.prototype.getDeviceList=function(b,a){var c=this.resolveGateway(b);c?c.getDevices(function(b,c){a&&a(b,c)}):a&&a(Error("gateway json format invalid"))};e.prototype.getStateValues=function(b,a){return(new xnm.aio.fibaro.HomeCenter).getStateValues(b.type,a)};e.prototype.getDeviceCommandList=function(b,a,c){a=[];if(b.actions)for(var d in b.actions)switch(d){case "setVolume":a.push({id:d,
cmd:"setTo",step:"1",min:"0",max:"100"});break;default:a.push({id:d,cmd:d})}return a};return e}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.fibaro.Handler);
