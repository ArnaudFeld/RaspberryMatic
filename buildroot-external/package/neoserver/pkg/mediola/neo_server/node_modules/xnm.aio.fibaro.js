function _typeof(o){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o;}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o;},_typeof(o);}var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.fibaro=xnm.aio.fibaro||{},xnm.aio.fibaro.Util={clearHttpOptionForLog:function clearHttpOptionForLog(e){try{var t=JSON.parse(JSON.stringify(e));if(t.auth&&(t.auth="xxxxxx:xxxxxx"),t.headers)for(var a in headers)if(a&&"authorization"==a.toLocaleLowerCase()){var s=headers[a];if(s){var r=s.indexOf(" ");headers[a]=-1==r?"xxxxxx":s.substr(0,r)+" xxxxxx";}}return t;}catch(t){return e;}}},xnm.aio.fibaro.HomeCenter=function(){var e=function e(_e,t,a,s,r){var n=require("x.logger.js");this._logger=n?n.getLogger("xnm.aio.fibaro.HomeCenter"):{log:function log(){}},this.ip=_e,this.uuid=s,this.user=t,this.password=a,this.name=r,this.CommandHandler=null,this._getStatesCBs=[];};return e.ACTION_LIST=["turnOn","turnOff","setValue","startLevelIncrease","startLevelDecrease","stopLevelChange","close","open","stop","pressButton","setArmed","setSetpointMode","setThermostatSetpoint","setMode","setFanMode","setTargetLevel","setTime","setColor","startProgram","setSlider"],e.PROPERTY_LIST=["value","state","batteryLevel","power"," energy","armed"," tamper","on"," mute"," volume","mode","targetLevel","wakeUpTime","Humidity"," Pressure"," Temperature"," WeatherCondition"," Wind"],e.SET_POINT_MODES=["OFF","HEAT","COOL","AUTO","AUXILIARY_HEAT","RESUME","FAN_ONLY","FURNACE","DRY_AIR","MOIST","AUTO_CHANGEOVER","ENERGY_SAVE_HEAT","ENERGY_SAVE_COOL","AWAY",null,"FULL_POWER"],e.OP_MODES=["OFF","HEATING","COOLING","AUTO","PENDING_HEAT","PENDING_COOL","VENT_ECONOMIZER","AUX_HEATING","2ND_STAGE_HEATING","2ND_STAGE_COOLING","2ND_STAGE_AUX_HEAT","3RD_STAGE_AUX_HEAT"],e.FAN_MODES=["AUTO_LOW","LOW","AUTO_HIGH","HIGH","AUTO_MEDIUM","MEDIUM","CIRCULATION","HUMIDITY","LEFT_RIGHT","UP_DOWN","QUIET","3RD_STAGE_AUX_HEAT"],e.prototype._callAction=function(e,t,a,s){for(var r="/api/callAction?deviceID="+e+"&name="+t,n=0;n<a.length;n++)r+="&arg"+(n+1)+"="+encodeURIComponent(a[n]);this._doRestApi("GET",r,null,function(e,t){s&&s(e,t);});},e.prototype._getRooms=function(e){this._doRestApi("GET","/api/rooms",null,function(t,a){e&&e(t,a);});},e.prototype._getDevices=function(e){this._doRestApi("GET","/api/devices",null,function(t,a){e&&e(t,a);});},e.prototype._getGlobalVariables=function(e){this._doRestApi("GET","/api/globalVariables",null,function(t,a){e&&e(t,a);});},e.prototype._setGlobalVariableValue=function(e,t,a){var s={name:e,value:t+""};this._doRestApi("PUT","/api/globalVariables/"+e,JSON.stringify(s),function(e,t){a&&a(e,t);});},e.prototype._doRestApi=function(e,t,a,s){this._doRequest(e,t,a,function(e,t,a){if(e)return"timeout"==e.reason?e.code=2:e.code=1,void(s&&s(e));if(200!=a&&202!=a)return(e=new Error("http result status code:"+a)).code=a,void(s&&s(e));try{var r=JSON.parse(t);s&&s(null,r);}catch(e){e.code=3,s&&s(e);}});},e.prototype._doRequest=function(e,t,a,s){var r={host:this.ip,path:t,method:e,headers:{Authorization:"Basic "+new Buffer(this.user+":"+this.password).toString("base64"),Connection:"close","Content-Type":"text/plain"}};a&&(r.headers["Content-Length"]=a.length);var n=this,o=require("http");this._logger.log("trace","do http request:"+JSON.stringify(xnm.aio.fibaro.Util.clearHttpOptionForLog(r)));var i=o.request(r,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){n._logger.log("trace","receive http response:"+t+" with code:"+e.statusCode),s&&s(null,t,e.statusCode),s=null;});});i.on("error",function(e){n._logger.log("warn","do http request error:"+e.message),s&&s(e),s=null;}),i.setTimeout(4e3,function(){n._logger.log("warn","do http request timeout");var e=new Error("timeout");e.reason="timeout",s&&s(e),s=null;}),a&&i.write(a),i.end();},e.prototype.executeCommandCreator=function(t,a,s){if(t&&t.address){if(a&&a.value){var r=a.value;if("global_variable"==t.type)r=a.ext;else if("setSetpointMode"==r){if(!a.ext)return void(s&&s(new Error("setSetpointMode invalid")));var _t=e.SET_POINT_MODES.indexOf(a.ext);if(-1==_t)return void(s&&s(new Error("unknown setSetpointMode mode")));r+=_t;}else if(0==r.indexOf("setThermostatSetpoint")){if(!a.ext)return void(s&&s(new Error("setThermostatSetpoint invalid")));r+=":"+a.ext;}else if("setMode"==r){if(!a.ext)return void(s&&s(new Error("setMode invalid")));var _t2=e.OP_MODES.indexOf(a.ext);if(-1==_t2)return void(s&&s(new Error("unknown setMode mode")));r+=_t2;}else if("setFanMode"==r){if(!a.ext)return void(s&&s(new Error("setFanMode invalid")));var _t3=e.FAN_MODES.indexOf(a.ext);if(-1==_t3)return void(s&&s(new Error("unknown setFanMode mode")));r+=_t3;}else if(0==r.indexOf("setTargetLevel")){if(!a.ext)return void(s&&s(new Error("setTargetLevel invalid")));r+=a.ext;}else if(0==r.indexOf("setTime")){if(void 0===a.ext||null==a.ext)return void(s&&s(new Error("setTime invalid")));r+=a.ext;}else if("rgbw"==r){if(void 0===a.ext||null==a.ext)return void(s&&s(new Error("rgbw invalid")));r="setColor"+a.ext;}else if("startProgram"==r){if(void 0===a.ext||null==a.ext)return void(s&&s(new Error("startProgram invalid")));r+=a.ext;}else"pressButton"===r||r.startsWith("setSlider")?r=a:void 0!==a.ext&&null!=a.ext&&("setValue"==r&&(r+=a.ext),"disarm"==r&&(r+=a.ext));this.executeCommand(t,r,function(e,t){s&&s(e,t);});}else s&&s(new Error("command invalid"));}else s&&s(new Error("device invalid"));},e.prototype.getStatesCreator=function(t,a,s){if(a){if(0!=a.length){if(a){for(var r=[],n=0;n<a.length;n++){var o=a[n];o&&o.device&&o.device.address&&r.push(o.device.address);}this.getStates(t,r,function(t,r,n){if(t)s&&s(t);else{var o=[];if(r)for(var i=0;i<a.length;i++)if(a[i]){var l=a[i].id,u=a[i].device,f=a[i].status;if(l&&f&&f.value&&u&&u.address){var d,p="?";if("global_variable"==u.type)d=n[u.address],p=parseInt(d);else if(d=r[u.address])switch(f.value){case"onoffValue":p="true"==(p=d.value)?"on":"off";break;case"intValue":p=d.value,p=parseInt(p);break;case"boolValue":p=d.value;break;case"floatValue":p=d.value,p=parseFloat(p);break;case"setpointMode":p=d.mode,p=e.SET_POINT_MODES[parseInt(p)];break;case"opMode":p=d.mode,p=e.OP_MODES[parseInt(p)];break;case"fanMode":p=d.mode,p=e.FAN_MODES[parseInt(p)];break;default:p=d[f.value];}void 0!==p&&null!=p||(p="?"),o.push({id:l,status:p});}}s&&s(null,o);}});}else s&&s(new Error("deviceList is null"));}else s&&s(null,[]);}else s&&s(new Error("deviceList is null"));},e.prototype.getDevices=function(e){var t={},a={};t[0]={name:"Unassigned"};var s=this;this._getRooms(function(r,n){if(r)e&&e(r);else{if(n)for(var o=0;o<n.length;o++)t[n[o].id]={name:n[o].name,section:n[o].sectionID};s._getDevices(function(r,n){if(r)e&&e(r);else{if(n)for(var o=0;o<n.length;o++){var i=n[o];i.visible&&"HC_user"!=i.type&&(a[i.id]={sys:"fibaro",name:i.name,address:i.id,room:i.roomID,type:i.type,baseType:i.baseType,actions:i.actions,states:i.properties});}s._getGlobalVariables(function(s,r){if(s)e&&e(s);else{for(var n={},o=0;o<r.length;o++){var i=r[o];i&&i.name&&(n[i.name]={sys:"fibaro",name:i.name,address:i.name,readOnly:i.readOnly,isEnum:i.isEnum,type:"global_variable"});}e&&e(null,{rooms:t,devices:a,variables:n});}});}});}});},e.prototype.executeCommand=function(e,t,a){if("global_variable"==e.type)return void 0===t&&null==t?void(a&&a(new Error("command ext invalid"))):void this._setGlobalVariableValue(e.address,t,function(e){a&&a(e);});var s=t,r=[];if("number"==typeof t)s="setValue",r.push(t);else if("string"==typeof t){if("on"==t)s="turnOn";else if("off"==t)s="turnOff";else{if("toggle"==t){var n=this;return void this._getDevices(function(t,s){if(t)a&&a(t);else{for(var r=null,o=0;o<s.length;o++){var i=s[o];if(i.id&&i.properties&&i.id==e.address){"false"==i.properties.value?r="on":"true"==i.properties.value&&(r="off");break;}}r?n.executeCommand(e,r,a):a&&a(new Error("device has no on/off state"));}});}if("arm"==t)s="setArmed",r=[1];else if(0==t.indexOf("disarm"))(r=[0]).push(t.replace(/disarm/g,"")),s="setArmed";else if(0==t.indexOf("dimTo"))r.push(parseInt(t.replace(/dimTo/g,""))),s="setValue";else if(0==t.indexOf("moveTo"))r.push(parseInt(t.replace(/moveTo/g,""))),s="setValue";else if(0==t.indexOf("setTo"))r.push(parseInt(t.replace(/setTo/g,""))),s="setValue";else if(0==t.indexOf("setValue"))r.push(parseInt(t.replace(/setValue/g,""))),s="setValue";else if(0==t.indexOf("setSetpointMode"))r.push(parseInt(t.replace(/setSetpointMode/g,""))),s="setSetpointMode";else if(0==t.indexOf("setThermostatSetpoint")){var o=t.replace(/setThermostatSetpoint/g,"");o=o.split(":"),r.push(parseInt(o[0]),parseFloat(o[1])),s="setThermostatSetpoint";}else if(0==t.indexOf("setMode"))r.push(parseInt(t.replace(/setMode/g,""))),s="setMode";else if(0==t.indexOf("setFanMode"))r.push(parseInt(t.replace(/setFanMode/g,""))),s="setFanMode";else if(0==t.indexOf("setTargetLevel"))r.push(parseFloat(t.replace(/setTargetLevel/g,""))),s="setTargetLevel";else if(0==t.indexOf("setTime"))r.push(parseInt(t.replace(/setTime/g,""))),s="setTime";else if(0==t.indexOf("setColor")){var i=t.replace(/setColor/g,""),l=i.substr(0,2),u=i.substr(2,2),f=i.substr(4,2),d=i.substr(6,2);r=[parseInt(l,16),parseInt(u,16),parseInt(f,16),parseInt(d,16)],s="setColor";}else 0==t.indexOf("startProgram")?(r.push(parseInt(t.replace(/startProgram/g,""))),s="startProgram"):s=t;}}else if(t&&"object"==_typeof(t))if(s=t.value,"pressButton"===t.value){var _e2=t.ext.split(": ");r=[Number(_e2[0])];}else t.value.startsWith("setSlider")&&(s="setSlider",r=[Number(t.value.substring(9)),Number(t.ext)]);this._callAction(e.address,s,r,function(e,t){a&&a(e,t);});},e.prototype.getStates=function(t,a,s){s||(s=function s(){});var r=this._getStatesCBs.length;if(-1==this._getStatesCBs.indexOf(s)&&this._getStatesCBs.push(s),!(r>0)){var n=this;this.CommandHandler=t,this._getGlobalVariables(function(t,s){if(t){var _e3=n._getStatesCBs;n._getStatesCBs=[];for(var _a=0;_a<_e3.length;_a++)_e3[_a](t);}else{var r={};for(var _e4=0;_e4<s.length;_e4++){var o=s[_e4];o&&o.name&&(r[o.name]=o.value);}n._getDevices(function(t,s){if(t){var _e5=n._getStatesCBs;n._getStatesCBs=[];for(var _a2=0;_a2<_e5.length;_a2++)_e5[_a2](t);return;}var o={};for(var _t4=0;_t4<s.length;_t4++){var i=s[_t4];if(i.id&&i.properties&&(null==a||-1!=a.indexOf(i.id))){o[i.id]={};for(var _t5 in i.properties)-1!=e.PROPERTY_LIST.indexOf(_t5)&&(o[i.id][_t5]=i.properties[_t5]);Array.isArray(i.properties.rows)&&i.properties.rows.forEach(function(e){e&&Array.isArray(e.elements)&&"slider"===e.type&&e.elements.forEach(function(e){o[i.id]["sliderValue"+e.id]=e.value;});});}}var l=n._getStatesCBs;n._getStatesCBs=[];for(var _e6=0;_e6<l.length;_e6++)l[_e6](null,o,r);});}});}},e.prototype.getStateValues=function(e,t){return t;},e.prototype.toJSON=function(){return{sys:"fibaro",ip:this.ip,username:this.user,password:this.password,uuid:this.uuid,name:this.name};},e.prototype.equalsTo=function(t){return!!t&&t instanceof e&&this.ip==t.ip&&this.user==t.user&&this.password==t.password;},e.Discovery=function(){this._homeCenters=[],this._sockets=[],this._searchTimeout=null,this._running=!1,this._listeners=[],this._callbacks=[];var t=require("x.logger.js");this._logger=t?t.getLogger("xnm.aio.fibaro.HomeCenter.Discovery"):{log:function log(){}},this.discoverHomeCenters=function(e,t,a){if(t&&-1==this._listeners.indexOf(t)&&this._listeners.push(t),a&&-1==this._callbacks.indexOf(a)&&this._callbacks.push(a),e||(e=5e3),!this._running){this._logger.log("debug","start search home center");var s=this;this._running=!0,this._createSockets(function(t){t?s._finishDiscover(t):(s._sendDiscoveryMessages(),s._searchTimeout=setTimeout(function(){s._finishDiscover(null,s._homeCenters);},e));});}},this._createSockets=function(e){var t=require("os"),a=(require("dgram"),this);if(t&&t.networkInterfaces){var s=t.networkInterfaces(),r=[];for(var n in s)if(s.hasOwnProperty(n))for(var o=s[n],i=0;i<o.length;i++)"IPv4"==o[i].family&&0==o[i].internal&&r.push(o[i]);for(var l=0,u=0,f=function f(t,s){if(l++,t&&(u++,s)){var n=a._sockets.indexOf(s);-1!=n&&a._sockets.splice(n,1);}l==r.length&&(u==l?e&&e(t):e&&e());},d=0;d<r.length;d++)this._addDiscoverSocket(44444,r[d],f);}else this._addDiscoverSocket(44444,null,function(t,s){if(t&&s){var r=a._sockets.indexOf(s);-1!=r&&a._sockets.splice(r,1);}e&&e(t);});},this._closeSockets=function(){for(var e=0;e<this._sockets.length;e++)this._sockets[e].close();},this._addDiscoverSocket=function(e,t,a){var s,r=this,n=require("dgram");try{s=n.createSocket({reuseAddr:!0,type:"udp4"});}catch(e){s=n.createSocket("udp4");}s.on("listening",function(){s.setBroadcast(!0),s._listening=!0,r._logger.log("trace","success to bind on port:"+e+(t?" with interface:"+t.address:"")),a&&a(null,s);}),s.on("message",function(e,t){r._receivedData(t.address,e);}),s.on("error",function(n){s._listening||(r._logger.log("trace","failed to bind on port:"+e+(t?" with interface:"+t.address:"")),a&&a(n,s));});try{t?(r._logger.log("trace","try to bind on port:"+e+" with interface:"+t.address),s.bind(e,t.address),this._sockets.push(s)):(r._logger.log("trace","try to bind on port:"+e),s.bind(e),this._sockets.push(s));}catch(e){a&&a(e);}},this._sendDiscoveryMessages=function(){for(var e=new Buffer([70,73,66,65,82,79]),t=0;t<this._sockets.length;t++)this._sockets[t].send(e,0,e.length,44444,"255.255.255.255");},this._receivedData=function(t,a){if(a=a.toString("hex"),(a=new Buffer(a,"hex")).length>=3){var s=a.toString();this._logger.log("trace","receive packet:"+s+" from:"+t);var r=s.split(" ");if(3==r.length&&"ACK"==r[0]){var n=new e(t,null,null,r[2]);n.name=r[1];for(var o=!1,i=0;i<this._homeCenters.length;i++){var l=this._homeCenters[i];if(l&&l.uuid==n.uuid){o=!0;break;}}if(!o){this._homeCenters.push(n);for(var u=0;i<this._listeners.length;u++)this._listeners[u](n);}}}},this._finishDiscover=function(e,t){var a=this._callbacks;this._closeSockets(),this._sockets=[],this._homeCenters=[],this._running=!1,this._listeners=[],this._callbacks=[];for(var s=0;s<a.length;s++){var r=a[s];r&&r(e,t);}};},e;}(),xnm.aio.fibaro.DM=function(){var e=function e(_e7,t){this.code=_e7,this.message=t,this.stack=new Error().stack;};return(e.prototype=new Error()).name="FibaroDMError",e.prototype.code=0,e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"fibaro",getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"FIBARO Home Center 2"}];},getGatewayDeviceType:function getGatewayDeviceType(){return[];},createGateway:function createGateway(t,a,s){var r=e,n=e.ERROR_CODE;t?t.ip?t.username?t.password?s(null,t):s(new r(n.INVALID,"password is invalid")):s(new r(n.INVALID,"username is invalid")):s(new r(n.INVALID,"ip is invalid")):s(new r(n.INVALID,"info is invalid"));},updateGateway:function updateGateway(t,a,s,r){var n=e,o=e.ERROR_CODE;a?a.ip?a.username?a.password?r(null,a):r(new n(o.INVALID,"password is invalid")):r(new n(o.INVALID,"username is invalid")):r(new n(o.INVALID,"ip is invalid")):r(new n(o.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,a){a();},createDevice:function createDevice(t,a,s){var r=e,n=e.ERROR_CODE;if(t){if(t.gateway){if(t.address){if(t.type){if(a.data&&a.data.gateways&&0!==a.data.gateways.length){var o,i,l=a.data.gateways;for(o=0;o<l.length;o++)if(l[o].index===t.gateway){i=l[o];break;}i?s(null,t):s(new r(n.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else s(new r(n.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else s(new r(n.INVALID,"type is invalid"));}else s(new r(n.INVALID,"address is invalid"));}else s(new r(n.INVALID,"gateway is invalid"));}else s(new r(n.INVALID,"info is invalid"));},updateDevice:function updateDevice(t,a,s){var r=e,n=e.ERROR_CODE;if(t){if(t.gateway){if(t.address){if(t.type){if(a.data&&a.data.gateways&&0!==a.data.gateways.length){var o,i,l=a.data.gateways;for(o=0;o<l.length;o++)if(l[o].index===t.gateway){i=l[o];break;}i?s(null,t):s(new r(n.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else s(new r(n.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else s(new r(n.INVALID,"type is invalid"));}else s(new r(n.INVALID,"address is invalid"));}else s(new r(n.INVALID,"gateway is invalid"));}else s(new r(n.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,a){a();},applyUIFilter:function applyUIFilter(e,t){var a=this,s=function s(e,t){if("*"==e)return!0;for(var a=!1,s=0;s<e.length;s++)if(e[s]==t){a=!0;break;}return a;},r=function r(e,t){var r=[],n=null,o=a.getCommandStatusMap(e);return o&&(n=function(e,t,a){var r=[];switch(a.catagory){case"command":e.command&&e.command.forEach(function(e){if(s(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(s(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}});}return r;}(o,0,t),r=r.concat(n)),r;};if(!e||null==e.type||void 0===e.type)return null;var n=JSON.parse(JSON.stringify(e)),o=null;switch(t.catagory){case"command":o=r(e,t),n.command=o;break;case"status":o=r(e,t),n.status=o;break;default:return null;}return o&&0!=o.length?n:null;},getCommandStatusMap:function getCommandStatusMap(e){if(!e)return null;var t={command:[],status:[]};if("global_variable"==e.type)return e.readOnly||t.command.push({type:"int",name:"set value",ref:{value:"setValue",ext:"%d"}}),t.status.push({type:"int",name:"value",ref:{value:"value"}}),t;var a=e.actions,s=e.states;if(a)for(var r in a)if(r&&-1!=xnm.aio.fibaro.HomeCenter.ACTION_LIST.indexOf(r))switch(r){case"turnOn":t.command.push({type:"enum",name:"on",ref:{value:"on"}});break;case"turnOff":t.command.push({type:"enum",name:"off",ref:{value:"off"}});break;case"setValue":t.command.push({type:"int",name:"set value",ref:{value:"setValue",ext:"%d",extMeta:"0-100"}});break;case"startLevelIncrease":t.command.push({type:"enum",name:"up",ref:{value:"startLevelIncrease"}});break;case"startLevelDecrease":t.command.push({type:"enum",name:"down",ref:{value:"startLevelDecrease"}});break;case"stopLevelChange":t.command.push({type:"enum",name:"stop level change",ref:{value:"stopLevelChange"}});break;case"setArmed":t.command.push({type:"enum",name:"arm",ref:{value:"arm"}}),t.command.push({type:"string",name:"disarm",ref:{value:"disarm",ext:"%s",unit:"(pin)"}});break;case"setTargetLevel":e&&"com.fibaro.hvac"==e.baseType?t.command.push({type:"float",name:"set point",ref:{value:"setTargetLevel",ext:"%f",extMeta:"4.0-30.0",scale:"0.5"}}):t.command.push({type:"float",name:"set target level",ref:{value:"setTargetLevel",ext:"%f"}});break;case"setTime":t.command.push({type:"int",name:"set time",ref:{value:"setTime",ext:"%d",extMeta:"0-21600",unit:"s"}});break;case"setSetpointMode":if(s&&s.supportedModes){var _e8=s.supportedModes.split(",");if(_e8.length>0){var n={type:"enum",name:"set point mode",ref:{value:"setSetpointMode",ext:"%e",extMeta:[]}};_e8.forEach(function(e){var t=xnm.aio.fibaro.HomeCenter.SET_POINT_MODES[parseInt(e)];t&&n.ref.extMeta.push(t);}),t.command.push(n);}}break;case"setThermostatSetpoint":if(s&&s.supportedModes){var _e9=s.supportedModes.split(",");_e9.length>0&&_e9.forEach(function(e){var a=xnm.aio.fibaro.HomeCenter.SET_POINT_MODES[parseInt(e)];a&&t.command.push({type:"float",name:"set point ("+a+")",ref:{value:"setThermostatSetpoint"+e,ext:"%f",extMeta:"4.0-30.0",scale:"0.5"}});});}break;case"setMode":if(s&&s.supportedModes){var _e10=s.supportedModes.split(",");if(_e10.length>0){var _a3={type:"enum",name:"set op mode",ref:{value:"setMode",ext:"%e",extMeta:[]}};_e10.forEach(function(e){var t=xnm.aio.fibaro.HomeCenter.OP_MODES[parseInt(e)];t&&_a3.ref.extMeta.push(t);}),t.command.push(_a3);}}break;case"setFanMode":if(s&&s.supportedModes){var _e11=s.supportedModes.split(",");if(_e11.length>0){var _a4={type:"enum",name:"set fan mode",ref:{value:"setFanMode",ext:"%e",extMeta:[]}};_e11.forEach(function(e){var t=xnm.aio.fibaro.HomeCenter.FAN_MODES[parseInt(e)];t&&_a4.ref.extMeta.push(t);}),t.command.push(_a4);}}break;case"setColor":t.command.push({type:"rgbw",name:"rgb+white color",ref:{value:"rgbw",ext:"%s"}});break;case"startProgram":t.command.push({type:"int",name:"start program",ref:{value:"startProgram",ext:"%d"}});break;case"pressButton":if(s&&Array.isArray(s.rows)){var _e12={type:"enum",name:"press button",ref:{value:"pressButton",ext:"%e",extMeta:[]}};s.rows.filter(function(e){return"button"===e.type&&Array.isArray(e.elements);}).forEach(function(t){t.elements.forEach(function(t){_e12.ref.extMeta.push(t.id+": "+(t.caption||t.name));});}),_e12.ref.extMeta.length>0&&t.command.push(_e12);}break;case"setSlider":s&&Array.isArray(s.rows)&&s.rows.filter(function(e){return"slider"===e.type&&Array.isArray(e.elements);}).forEach(function(e){e.elements.forEach(function(e){var a={type:"int",name:"slider ".concat(e.id,": ")+(e.caption||e.name),ref:{value:"setSlider"+e.id,ext:"%d",extMeta:"0-100"}};t.command.push(a);});});break;default:t.command.push({type:"enum",name:r,ref:{value:r}});}if(s){for(var o in s)if(o&&-1!=xnm.aio.fibaro.HomeCenter.PROPERTY_LIST.indexOf(o))switch(o){case"value":a&&a.setValue?t.status.push({type:"int",name:"value",ref:{value:"intValue",ext:"%d"}}):a&&a.setThermostatSetpoint||e&&"com.fibaro.hvac"==e.baseType?t.status.push({type:"float",name:"set point value",ref:{value:"floatValue",ext:"%f"}}):a&&void 0!==a.turnOn&&null!=a.turnOn?(t.command.push({type:"enum",name:"toggle",ref:{value:"toggle"}}),t.status.push({type:"enum",name:"value",ref:{value:"onoffValue",options:["on","off"]}})):"true"==s.value||"false"==s.value?t.status.push({type:"enum",name:"value",ref:{value:"boolValue",options:["true","false"]}}):t.status.push({type:"float",name:"value",ref:{value:"floatValue",ext:"%f"}});break;case"targetLevel":a&&a.setThermostatSetpoint||e&&"com.fibaro.hvac"==e.baseType?t.status.push({type:"float",name:"set point target",ref:{value:"targetLevel",ext:"%f"}}):t.status.push({type:"float",name:"target level",ref:{value:"targetLevel",ext:"%f"}});break;case"mode":if(a&&a.setSetpointMode){if(s.supportedModes){var _e13=s.supportedModes.split(",");if(_e13.length>0){var _a5={type:"enum",name:"set point mode",ref:{value:"setpointMode",options:[]}};_e13.forEach(function(e){var t=xnm.aio.fibaro.HomeCenter.SET_POINT_MODES[parseInt(e)];t&&_a5.ref.options.push(t);}),t.status.push(_a5);}}}else if(a&&a.setMode){if(s.supportedModes){var _e14=s.supportedModes.split(",");if(_e14.length>0){var _a6={type:"enum",name:"op mode",ref:{value:"opMode",options:[]}};_e14.forEach(function(e){var t=xnm.aio.fibaro.HomeCenter.OP_MODES[parseInt(e)];t&&_a6.ref.options.push(t);}),t.status.push(_a6);}}}else if(a&&a.setFanMode){if(s.supportedModes){var _e15=s.supportedModes.split(",");if(_e15.length>0){var _a7={type:"enum",name:"fan mode",ref:{value:"fanMode",options:[]}};_e15.forEach(function(e){var t=xnm.aio.fibaro.HomeCenter.FAN_MODES[parseInt(e)];t&&_a7.ref.options.push(t);}),t.status.push(_a7);}}}else"true"==s.value||"false"==s.value?t.status.push({type:"enum",name:"state",ref:{value:"boolValue",options:["true","false"]}}):t.status.push({type:"float",name:"state",ref:{value:"floatValue",ext:"%f"}});break;case"armed":case"tamper":t.status.push({type:"enum",name:o,ref:{value:o,options:["true","false"]}});break;case"WeatherCondition":t.status.push({type:"string",name:o,ref:{value:o}});break;default:t.status.push({type:"float",name:o,ref:{value:o,ext:"%f"}});}Array.isArray(s.rows)&&s.rows.forEach(function(e){e&&Array.isArray(e.elements)&&"slider"===e.type&&e.elements.forEach(function(e){t.status.push({type:"int",name:"slider ".concat(e.id,": ")+(e.caption||e.name),ref:{value:"sliderValue"+e.id,ext:"%d",extMeta:"0-100"}});});});}return t;}};}(),xnm.aio.fibaro.Handler=function(){var e=function e(){this.detectedHomecenters={},this.discovery=new this.HomeCenter.Discovery();};return e.prototype.HomeCenter=xnm.aio.fibaro.HomeCenter,e.prototype.devicemanager=xnm.aio.fibaro.DM,e.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"fibaro");},e.prototype.discoverHomeCenters=function(e,t){this.discovery.discoverHomeCenters(e,null,function(e,a){t&&t(e,a);});},e.prototype.resolveGateway=function(e){return e&&e.ip&&e.username?new this.HomeCenter(e.ip,e.username,e.password,e.uuid,e.name):null;},e.prototype.getDeviceCommands=function(e,t){var a=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),s=a?a.command:[];t&&t(null,s);},e.prototype.getDeviceStatus=function(e,t){var a=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),s=a?a.status:[];t&&t(null,s);},e.prototype.doCommand=function(e,t,a,s){var r=this.resolveGateway(e);r?r.executeCommandCreator(t,a,function(e){s&&s(e);}):s&&s(new Error("gateway json format invalid"));},e.prototype.doStatus=function(e,t,a,s,r){var n=this.resolveGateway(t);if(n){var o=[{id:e,device:a,status:s}];n.getStatesCreator(null,o,function(e,t){e?r&&r(e):r&&r(null,t[0]);});}else r&&r(new Error("gateway json format invalid"));},e.prototype.getDeviceList=function(e,t){var a=this.resolveGateway(e);a?a.getDevices(function(e,a){t&&t(e,a);}):t&&t(new Error("gateway json format invalid"));},e.prototype.getStateValues=function(e,t){return new xnm.aio.fibaro.HomeCenter().getStateValues(e.type,t);},e.prototype.getDeviceCommandList=function(e,t,a){var s=[];if(e.actions)for(var r in e.actions)"setVolume"===r?s.push({id:r,cmd:"setTo",step:"1",min:"0",max:"100"}):s.push({id:r,cmd:r});return s;},e;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.fibaro.Handler());