"use strict";function _typeof(o){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o;}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o;},_typeof(o);}function _createForOfIteratorHelper(o,allowArrayLike){var it=typeof Symbol!=="undefined"&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length==="number"){if(it)o=it;var i=0;var F=function F(){};return{s:F,n:function n(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]};},e:function e(_e61){throw _e61;},f:F};}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}var normalCompletion=true,didErr=false,err;return{s:function s(){it=it.call(o);},n:function n(){var step=it.next();normalCompletion=step.done;return step;},e:function e(_e62){didErr=true;err=_e62;},f:function f(){try{if(!normalCompletion&&it["return"]!=null)it["return"]();}finally{if(didErr)throw err;}}};}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen);}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2;}function _regeneratorRuntime(){"use strict";/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */_regeneratorRuntime=function _regeneratorRuntime(){return e;};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value;},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",c=i.asyncIterator||"@@asyncIterator",u=i.toStringTag||"@@toStringTag";function define(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e];}try{define({},"");}catch(t){define=function define(t,e,r){return t[e]=r;};}function wrap(t,e,r,n){var i=e&&e.prototype instanceof Generator?e:Generator,a=Object.create(i.prototype),c=new Context(n||[]);return o(a,"_invoke",{value:makeInvokeMethod(t,r,c)}),a;}function tryCatch(t,e,r){try{return{type:"normal",arg:t.call(e,r)};}catch(t){return{type:"throw",arg:t};}}e.wrap=wrap;var h="suspendedStart",l="suspendedYield",f="executing",s="completed",y={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,a,function(){return this;});var d=Object.getPrototypeOf,v=d&&d(d(values([])));v&&v!==r&&n.call(v,a)&&(p=v);var g=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach(function(e){define(t,e,function(t){return this._invoke(e,t);});});}function AsyncIterator(t,e){function invoke(r,o,i,a){var c=tryCatch(t[r],t,o);if("throw"!==c.type){var u=c.arg,h=u.value;return h&&"object"==_typeof(h)&&n.call(h,"__await")?e.resolve(h.__await).then(function(t){invoke("next",t,i,a);},function(t){invoke("throw",t,i,a);}):e.resolve(h).then(function(t){u.value=t,i(u);},function(t){return invoke("throw",t,i,a);});}a(c.arg);}var r;o(this,"_invoke",{value:function value(t,n){function callInvokeWithMethodAndArg(){return new e(function(e,r){invoke(t,n,e,r);});}return r=r?r.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg();}});}function makeInvokeMethod(e,r,n){var o=h;return function(i,a){if(o===f)throw new Error("Generator is already running");if(o===s){if("throw"===i)throw a;return{value:t,done:!0};}for(n.method=i,n.arg=a;;){var c=n.delegate;if(c){var u=maybeInvokeDelegate(c,n);if(u){if(u===y)continue;return u;}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===h)throw o=s,n.arg;n.dispatchException(n.arg);}else"return"===n.method&&n.abrupt("return",n.arg);o=f;var p=tryCatch(e,r,n);if("normal"===p.type){if(o=n.done?s:l,p.arg===y)continue;return{value:p.arg,done:n.done};}"throw"===p.type&&(o=s,n.method="throw",n.arg=p.arg);}};}function maybeInvokeDelegate(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator["return"]&&(r.method="return",r.arg=t,maybeInvokeDelegate(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),y;var i=tryCatch(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,y;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,y):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,y);}function pushTryEntry(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e);}function resetTryEntry(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e;}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0);}function values(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function next(){for(;++o<e.length;)if(n.call(e,o))return next.value=e[o],next.done=!1,next;return next.value=t,next.done=!0,next;};return i.next=i;}}throw new TypeError(_typeof(e)+" is not iterable");}return GeneratorFunction.prototype=GeneratorFunctionPrototype,o(g,"constructor",{value:GeneratorFunctionPrototype,configurable:!0}),o(GeneratorFunctionPrototype,"constructor",{value:GeneratorFunction,configurable:!0}),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===GeneratorFunction||"GeneratorFunction"===(e.displayName||e.name));},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(g),t;},e.awrap=function(t){return{__await:t};},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,function(){return this;}),e.AsyncIterator=AsyncIterator,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new AsyncIterator(wrap(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then(function(t){return t.done?t.value:a.next();});},defineIteratorMethods(g),define(g,u,"Generator"),define(g,a,function(){return this;}),define(g,"toString",function(){return"[object Generator]";}),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function next(){for(;r.length;){var t=r.pop();if(t in e)return next.value=t,next.done=!1,next;}return next.done=!0,next;};},e.values=values,Context.prototype={constructor:Context,reset:function reset(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(resetTryEntry),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t);},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval;},dispatchException:function dispatchException(e){if(this.done)throw e;var r=this;function handle(n,o){return a.type="throw",a.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o;}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],a=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var c=n.call(i,"catchLoc"),u=n.call(i,"finallyLoc");if(c&&u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc);}else if(c){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc);}}}},abrupt:function abrupt(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break;}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,y):this.complete(a);},complete:function complete(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),y;},finish:function finish(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),resetTryEntry(r),y;}},"catch":function _catch(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;resetTryEntry(r);}return o;}}throw new Error("illegal catch attempt");},delegateYield:function delegateYield(e,r,n){return this.delegate={iterator:values(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),y;}},e;}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value;}catch(error){reject(error);return;}if(info.done){resolve(value);}else{Promise.resolve(value).then(_next,_throw);}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value);}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err);}_next(undefined);});};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,_toPropertyKey(descriptor.key),descriptor);}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);Object.defineProperty(Constructor,"prototype",{writable:false});return Constructor;}function _toPropertyKey(arg){var key=_toPrimitive(arg,"string");return _typeof(key)==="symbol"?key:String(key);}function _toPrimitive(input,hint){if(_typeof(input)!=="object"||input===null)return input;var prim=input[Symbol.toPrimitive];if(prim!==undefined){var res=prim.call(input,hint||"default");if(_typeof(res)!=="object")return res;throw new TypeError("@@toPrimitive must return a primitive value.");}return(hint==="string"?String:Number)(input);}var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.gira=xnm.aio.gira||{},xnm.aio.gira={_logger:{log:function log(){}},parseJSON:function parseJSON(e){return new xnm.aio.gira.GiraServer(e);}},xnm.aio.gira.GiraServer=function(){var e=/*#__PURE__*/function(){function e(_e,t){_classCallCheck(this,e);if("undefined"==typeof require||null==require)this._logger={log:function log(e,t){console&&console.log&&(e&&"error"!=e?console.log(e,t):console.log("error",t,t.stack));}};else{var _e2="xnm.aio.gira.GiraServer";this._logger=require("x.logger.js").getLogger(_e2),require("x.logger.js").setLogToConsole(!0,_e2);}this.REQUESTS_TIMEOUT_MS=t||1e4,this.gwInfo=_e,this.CommandHandler=null,this.cachedConfiguration=null;}_createClass(e,[{key:"_doRequest",value:function _doRequest(_e3,t,a,r,n){var i={host:this.gwInfo.ip,port:this.gwInfo.port,path:t,method:String(_e3).toUpperCase(),timeout:this.REQUESTS_TIMEOUT_MS,headers:{Connection:"close","Content-Type":"application/json"},rejectUnauthorized:!1};if(a)for(var o in a)a.hasOwnProperty(o)&&(i.headers[o]=a[o]);r&&(i.headers["Content-Length"]=r.length),this._logger.log("debug","call gira server on ".concat(t," with ").concat(JSON.stringify(i)));var s=require("https"),u=this,l=n,c=s.request(i,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){if(u._logger.log("debug","receive code:"+e.statusCode+" response:"+t),l){if(e.statusCode&&(e.statusCode<200||e.statusCode>399)){var _e57=new Error("request error");try{_e57.message=JSON.stringify(t);}catch(e){}return void l(_e57);}l(null,t,e),l=null;}});});c.on&&c.on("error",function(e){u._logger.log("error","do request error:"+e.message),l&&(l(e),l=null);}),c.setTimeout&&c.setTimeout(this.REQUESTS_TIMEOUT_MS,function(){u._logger.log("error","do request timeout"),c.abort(),l&&(l(new Error("timeout")),l=null);}),r&&(this._logger.log("debug","do request send body:"+r),c.write(r)),c.end();}},{key:"get",value:function(){var _get=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(_e4,t,a){var _this=this;return _regeneratorRuntime().wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:return _context.abrupt("return",new Promise(function(r,n){return _this._doRequest("get",_e4,t,a,function(_e5,t){return _e5?n(_e5):r(t);});}));case 1:case"end":return _context.stop();}},_callee);}));function get(_x,_x2,_x3){return _get.apply(this,arguments);}return get;}()},{key:"post",value:function(){var _post=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(_e6,t,a){var _this2=this;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1)switch(_context2.prev=_context2.next){case 0:return _context2.abrupt("return",new Promise(function(r,n){return _this2._doRequest("post",_e6,t,a,function(_e7,t){return _e7?n(_e7):r(t);});}));case 1:case"end":return _context2.stop();}},_callee2);}));function post(_x4,_x5,_x6){return _post.apply(this,arguments);}return post;}()},{key:"put",value:function(){var _put=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee3(_e8,t,a){var _this3=this;return _regeneratorRuntime().wrap(function _callee3$(_context3){while(1)switch(_context3.prev=_context3.next){case 0:return _context3.abrupt("return",new Promise(function(r,n){return _this3._doRequest("put",_e8,t,a,function(_e9,t){return _e9?n(_e9):r(t);});}));case 1:case"end":return _context3.stop();}},_callee3);}));function put(_x7,_x8,_x9){return _put.apply(this,arguments);}return put;}()},{key:"delete",value:function(){var _delete2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee4(_e10,t,a){var _this4=this;return _regeneratorRuntime().wrap(function _callee4$(_context4){while(1)switch(_context4.prev=_context4.next){case 0:return _context4.abrupt("return",new Promise(function(r,n){return _this4._doRequest("delete",_e10,t,a,function(_e11,t){return _e11?n(_e11):r(t);});}));case 1:case"end":return _context4.stop();}},_callee4);}));function _delete(_x10,_x11,_x12){return _delete2.apply(this,arguments);}return _delete;}()},{key:"isGiraServer",value:function(){var _isGiraServer=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee5(){var _t,t;return _regeneratorRuntime().wrap(function _callee5$(_context5){while(1)switch(_context5.prev=_context5.next){case 0:if(!e.serversCache[this.gwInfo.ip]){_context5.next=4;break;}_t=e.serversCache[this.gwInfo.ip];if(!(Date.now()-_t.time<e.cacheTime&&_t.serverInfo)){_context5.next=4;break;}return _context5.abrupt("return",(this._logger.log("debug","is gira server based on cached data"),_t.serverInfo));case 4:_context5.next=6;return this.get("/api/").then(function(_e12){var t=JSON.parse(_e12);return!(!_e12||!t.info)&&t;})["catch"](function(_e13){return!1;});case 6:t=_context5.sent;return _context5.abrupt("return",(e.serversCache[this.gwInfo.ip]={time:Date.now(),serverInfo:t},t));case 8:case"end":return _context5.stop();}},_callee5,this);}));function isGiraServer(){return _isGiraServer.apply(this,arguments);}return isGiraServer;}()},{key:"getToken",value:function(){var _getToken=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee6(_e14,t,a){var r,n,i,o,s;return _regeneratorRuntime().wrap(function _callee6$(_context6){while(1)switch(_context6.prev=_context6.next){case 0:r={client:"com.mediola.creator".concat(a||"")};n="".concat(_e14,":").concat(t);i={Authorization:"Basic ".concat(Buffer.from(n).toString("base64"))};_context6.next=5;return this.post("/api/clients",i,JSON.stringify(r));case 5:o=_context6.sent;if(o){_context6.next=8;break;}throw this.generateGiraError("can not get token, no result",3);case 8:s=JSON.parse(o);if(s.token){_context6.next=11;break;}throw this.generateGiraError("no token : ".concat(o),3);case 11:return _context6.abrupt("return",(this.gwInfo.token=s.token,s.token));case 12:case"end":return _context6.stop();}},_callee6,this);}));function getToken(_x13,_x14,_x15){return _getToken.apply(this,arguments);}return getToken;}()},{key:"registerCallbackUrls",value:function(){var _registerCallbackUrls=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee7(){var _e15,t,a;return _regeneratorRuntime().wrap(function _callee7$(_context7){while(1)switch(_context7.prev=_context7.next){case 0:_e15="".concat(this.gwInfo.eventsCallbackUrl,"/gira/events/value");_e15.startsWith("https://")||(_e15="https://".concat(_e15));t={valueCallback:_e15,testCallbacks:!0},a="/api/clients/".concat(this.gwInfo.token,"/callbacks");return _context7.abrupt("return",this.post(a,null,JSON.stringify(t)).then(function(_e16){return _e16.body;}));case 4:case"end":return _context7.stop();}},_callee7,this);}));function registerCallbackUrls(){return _registerCallbackUrls.apply(this,arguments);}return registerCallbackUrls;}()},{key:"unregisterClient",value:function(){var _unregisterClient=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee8(){var _e17;return _regeneratorRuntime().wrap(function _callee8$(_context8){while(1)switch(_context8.prev=_context8.next){case 0:_e17="/api/clients/".concat(this.gwInfo.token);return _context8.abrupt("return",this["delete"](_e17).then(function(_e18){return _e18.body;}));case 2:case"end":return _context8.stop();}},_callee8,this);}));function unregisterClient(){return _unregisterClient.apply(this,arguments);}return unregisterClient;}()},{key:"getDevices",value:function(){var _getDevices=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee9(_e19){var t;return _regeneratorRuntime().wrap(function _callee9$(_context9){while(1)switch(_context9.prev=_context9.next){case 0:_context9.next=2;return this.isGiraServer();case 2:if(_context9.sent){_context9.next=4;break;}return _context9.abrupt("return",void _e19(new Error("server is unreachable")));case 4:_context9.next=6;return this._getServerConfiguration();case 6:t=_context9.sent;t&&t.functions&&t.locations?_e19(null,this._convertConfigurationToMediolaDevices(t)):_e19(new Error("ui configuration is invalid"));case 8:case"end":return _context9.stop();}},_callee9,this);}));function getDevices(_x16){return _getDevices.apply(this,arguments);}return getDevices;}()},{key:"_convertConfigurationToMediolaDevices",value:function _convertConfigurationToMediolaDevices(_e20){var _this5=this;var t=[];var _iterator=_createForOfIteratorHelper(_e20.functions),_step;try{var _loop=function _loop(){var a=_step.value;var r={name:void 0,room:void 0,sys:"gira",address:void 0,type:void 0,supportedDataPoints:void 0};a.displayName&&(r.name=a.displayName),a.uid&&(r.address=a.uid),a.dataPoints&&(r.supportedDataPoints=[],a.dataPoints.forEach(function(_e21){r.supportedDataPoints.push({dataPointUid:_e21.uid,dataPointName:_e21.name});})),r.room=_this5._findDeviceRoom(_e20.locations,a.uid,""),r.type=_this5._findDeviceType(a.channelType),r.type&&"undefined"!==r.type&&t.push(r);};for(_iterator.s();!(_step=_iterator.n()).done;){_loop();}}catch(err){_iterator.e(err);}finally{_iterator.f();}return t;}},{key:"_findDeviceRoom",value:function _findDeviceRoom(_e22,t,a){var r=!1,n=a;var _iterator2=_createForOfIteratorHelper(_e22),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var i=_step2.value;if(i.functions&&i.functions.includes(t)){r=!0,n=a&&a.length>0?"".concat(a,"::"):"",n+=i.displayName,r=!0;break;}if(i.locations&&!r&&(n=this._findDeviceRoom(i.locations,t,i.displayName),n)){r=!0;break;}}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}return r?n:null;}},{key:"_findDeviceType",value:function _findDeviceType(_e23){var t="undefined";switch(_e23){case"de.gira.schema.channels.Switch":t="switch";break;case"de.gira.schema.channels.KNX.Dimmer":t="dimmer";break;case"de.gira.schema.channels.BlindWithPos":t="blind";break;case"de.gira.schema.channels.KNX.HeatingCoolingSwitchable":case"de.gira.schema.channels.RoomTemperatureSwitchable":t="heater";break;case"de.gira.schema.channels.DimmerRGBW":t="dimmerrgbw";break;case"de.gira.schema.channels.SceneControl":t="scene";}return this._logger.log("debug","[GiraServer._findDeviceType] Assigned channel type \"".concat(_e23,"\" as device type \"").concat(t,"\".")),t;}},{key:"executeCommandCreator",value:function(){var _executeCommandCreator=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee10(_e24,t,a){var r,_e25,n,_e26,_n,i,o,s,u,l,c,_e27;return _regeneratorRuntime().wrap(function _callee10$(_context10){while(1)switch(_context10.prev=_context10.next){case 0:this._logger.log("debug","executing ".concat(JSON.stringify(t)," on ").concat(JSON.stringify(_e24)));_context10.prev=1;_context10.next=4;return this.isGiraServer();case 4:if(_context10.sent){_context10.next=6;break;}return _context10.abrupt("return",void a(this.generateGiraError("server is unreachable",5)));case 6:_context10.t0=this.cachedConfiguration;if(_context10.t0){_context10.next=10;break;}_context10.next=10;return this._getServerConfiguration();case 10:r=this.cachedConfiguration.functions.find(function(t){return t.uid==_e24.address;}).dataPoints;if(!(!t||"color"!==t.value&&"color_white"!==t.value)){_context10.next=27;break;}_e25=this._whichDataPoint(t,r);if(_e25){_context10.next=15;break;}return _context10.abrupt("return",void a(this.generateGiraError("Unsupported command",5)));case 15:_context10.next=17;return this._getDesiredValue(t,_e25);case 17:n=_context10.sent;if(!(void 0===n||null==n)){_context10.next=20;break;}return _context10.abrupt("return",void a(this.generateGiraError("Invalid value command",3)));case 20:_context10.t1=a;_context10.next=23;return this.setDataPointValue(_e25.uid,n);case 23:_context10.t2=_context10.sent;(0,_context10.t1)(null,_context10.t2);_context10.next=55;break;case 27:_e26="color_white"===t.value,_n=this._whichDataPoint({value:"Red"},r),i=this._whichDataPoint({value:"Green"},r),o=this._whichDataPoint({value:"Blue"},r);if(!(!_n||!i||!o)){_context10.next=30;break;}return _context10.abrupt("return",void a(this.generateGiraError("Unsupported command",5)));case 30:s=null;if(!(_e26&&(s=this._whichDataPoint({value:"White"},r),!s))){_context10.next=33;break;}return _context10.abrupt("return",void a(this.generateGiraError("Unsupported command",5)));case 33:_context10.next=35;return this._getDesiredValue(t,{});case 35:u=_context10.sent;if(!(!Array.isArray(u)||u.length<3)){_context10.next=38;break;}return _context10.abrupt("return",void a(this.generateGiraError("Invalid value command",3)));case 38:_context10.next=40;return this.setDataPointValue(_n.uid,u[0]);case 40:l=_context10.sent;_context10.t3=l;_context10.next=44;return this.setDataPointValue(i.uid,u[1]);case 44:_context10.t4=_context10.sent;_context10.next=47;return this.setDataPointValue(o.uid,u[2]);case 47:_context10.t5=_context10.sent;c={red:_context10.t3,green:_context10.t4,blue:_context10.t5};if(!_e26){_context10.next=54;break;}_context10.next=52;return this.setDataPointValue(s.uid,u[3]);case 52:_e27=_context10.sent;c.white=_e27;case 54:a(null,c);case 55:_context10.next=60;break;case 57:_context10.prev=57;_context10.t6=_context10["catch"](1);this._logger.log("error",_context10.t6),a(_context10.t6);case 60:case"end":return _context10.stop();}},_callee10,this,[[1,57]]);}));function executeCommandCreator(_x17,_x18,_x19){return _executeCommandCreator.apply(this,arguments);}return executeCommandCreator;}()},{key:"_getDesiredValue",value:function(){var _getDesiredValue2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee11(_e29,t){var a,_e30;return _regeneratorRuntime().wrap(function _callee11$(_context11){while(1)switch(_context11.prev=_context11.next){case 0:a=_e29.ext;_context11.t0=e.value;_context11.next=_context11.t0==="on"?4:_context11.t0==="StepUp"?4:_context11.t0==="Up"?4:_context11.t0==="off"?6:_context11.t0==="StepDown"?6:_context11.t0==="Down"?6:_context11.t0==="color"?8:_context11.t0==="color_white"?10:_context11.t0==="toggle"?12:16;break;case 4:a=1;return _context11.abrupt("break",16);case 6:a=0;return _context11.abrupt("break",16);case 8:a=String(a).replace("#","").trim(),6===a.length||8===a.length?(a=[a.substring(0,2),a.substring(2,4),a.substring(4,6)],a.forEach(function(_e31,t){a[t]=Math.round(parseInt(_e31,16)/2.55);}),(isNaN(a[0])||isNaN(a[1])||isNaN(a[2]))&&(a=null)):a=null;return _context11.abrupt("break",16);case 10:a=String(a).replace("#","").trim(),8===a.length?(a=[a.substring(0,2),a.substring(2,4),a.substring(4,6),a.substring(6,8)],a.forEach(function(_e32,t){a[t]=Math.round(parseInt(_e32,16)/2.55);}),(isNaN(a[0])||isNaN(a[1])||isNaN(a[2])||isNaN(a[3]))&&(a=null)):a=null;return _context11.abrupt("break",16);case 12:_context11.next=14;return this._getCurrentValueOfDataPoint(t.uid);case 14:_e30=_context11.sent;a=_e30>0?0:1;case 16:return _context11.abrupt("return",a);case 17:case"end":return _context11.stop();}},_callee11,this);}));function _getDesiredValue(_x20,_x21){return _getDesiredValue2.apply(this,arguments);}return _getDesiredValue;}()},{key:"_getCurrentValueOfDataPoint",value:function(){var _getCurrentValueOfDataPoint2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee12(_e33){var t;return _regeneratorRuntime().wrap(function _callee12$(_context12){while(1)switch(_context12.prev=_context12.next){case 0:t="/api/values/".concat(_e33,"?token=").concat(this.gwInfo.token);return _context12.abrupt("return",this.get(t).then(function(_e34){return JSON.parse(_e34).values[0].value;}));case 2:case"end":return _context12.stop();}},_callee12,this);}));function _getCurrentValueOfDataPoint(_x22){return _getCurrentValueOfDataPoint2.apply(this,arguments);}return _getCurrentValueOfDataPoint;}()},{key:"_whichDataPoint",value:function _whichDataPoint(_e35,t){var a=_e35.value;return a=this._nameOfCommandInKnx(a),t.find(function(_e36){return _e36.name==a;});}},{key:"_nameOfCommandInKnx",value:function _nameOfCommandInKnx(_e37){switch(_e37){case"on":case"off":case"toggle":_e37="OnOff";break;case"StepUp":case"StepDown":_e37="Step-Up-Down";break;case"Up":case"Down":_e37="Up-Down";}return _e37;}},{key:"setDataPointValue",value:function(){var _setDataPointValue=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee13(_e38,t){var _this6=this;var a,r;return _regeneratorRuntime().wrap(function _callee13$(_context13){while(1)switch(_context13.prev=_context13.next){case 0:a="/api/values/".concat(_e38,"?token=").concat(this.gwInfo.token),r={value:t};return _context13.abrupt("return",this.put(a,null,JSON.stringify(r))["catch"](function(_e39){return _this6._logger.log("error",_e39),!1;}));case 2:case"end":return _context13.stop();}},_callee13,this);}));function setDataPointValue(_x23,_x24){return _setDataPointValue.apply(this,arguments);}return setDataPointValue;}()},{key:"getStatesCreator",value:function(){var _getStatesCreator=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee14(_e40,t,a){var _this7=this;var _e41,r,n,i,_iterator3,_step3,_loop2;return _regeneratorRuntime().wrap(function _callee14$(_context15){while(1)switch(_context15.prev=_context15.next){case 0:_context15.prev=0;_e41=[];_context15.next=4;return this.isGiraServer();case 4:if(_context15.sent){_context15.next=6;break;}return _context15.abrupt("return",(t.forEach(function(t){_e41.push({id:t.id,status:"server unreachable"});}),void a(null,_e41)));case 6:_context15.t0=this.cachedConfiguration;if(_context15.t0){_context15.next=10;break;}_context15.next=10;return this._getServerConfiguration();case 10:r=[];t.forEach(function(_e42){var t=_e42.device;r.includes(t.address)||r.push(t.address);});n=[];r.forEach(function(_e43){n.push(_this7._getFunctionDataPointsValues(_e43));});_context15.next=16;return Promise.all(n);case 16:i=_context15.sent;_iterator3=_createForOfIteratorHelper(t);_context15.prev=18;_loop2=/*#__PURE__*/_regeneratorRuntime().mark(function _loop2(){var a,t,r,n,o,s,_t2;return _regeneratorRuntime().wrap(function _loop2$(_context14){while(1)switch(_context14.prev=_context14.next){case 0:a=_step3.value;t=a.status,r=a.device,n=i.find(function(_e44){return _e44[r.address];})[r.address];o=r.supportedDataPoints.find(function(_e45){return(_e45.dataPointName||_e45.dataPontName)==t.value;});if(o){_context14.next=6;break;}_e41.push({id:a.id,status:"undefined"});return _context14.abrupt("return",1);case 6:s=n.find(function(_e46){return _e46.uid==o.dataPointUid;});if(!s){_context14.next=18;break;}_t2=s.value;_context14.t0=o.dataPointName;_context14.next=_context14.t0==="OnOff"?12:_context14.t0==="Movement"?14:15;break;case 12:_t2=s.value?"on":"off";return _context14.abrupt("break",15);case 14:_t2=s.value?"moving":"idle";case 15:_e41.push({id:a.id,status:_t2});_context14.next=19;break;case 18:_this7._logger.log("error","No datapoint \"".concat(o.dataPointUid,"\" found in result for \"").concat(a.id,"\"."));case 19:case"end":return _context14.stop();}},_loop2);});_iterator3.s();case 21:if((_step3=_iterator3.n()).done){_context15.next=27;break;}return _context15.delegateYield(_loop2(),"t1",23);case 23:if(!_context15.t1){_context15.next=25;break;}return _context15.abrupt("continue",25);case 25:_context15.next=21;break;case 27:_context15.next=32;break;case 29:_context15.prev=29;_context15.t2=_context15["catch"](18);_iterator3.e(_context15.t2);case 32:_context15.prev=32;_iterator3.f();return _context15.finish(32);case 35:a(null,_e41);_context15.next=41;break;case 38:_context15.prev=38;_context15.t3=_context15["catch"](0);this._logger.log("error",_context15.t3),a(_context15.t3);case 41:case"end":return _context15.stop();}},_callee14,this,[[0,38],[18,29,32,35]]);}));function getStatesCreator(_x25,_x26,_x27){return _getStatesCreator.apply(this,arguments);}return getStatesCreator;}()},{key:"_getFunctionDataPointsValues",value:function(){var _getFunctionDataPointsValues2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee15(_e48){var t,a,r;return _regeneratorRuntime().wrap(function _callee15$(_context16){while(1)switch(_context16.prev=_context16.next){case 0:t={};t[_e48]=[];_context16.prev=2;_context16.next=5;return this._prepareToken();case 5:a=_context16.sent;_context16.next=8;return this.get("/api/values/".concat(_e48,"?token=").concat(a));case 8:r=_context16.sent;if(!(r=JSON.parse(r),!r||!r.values)){_context16.next=11;break;}throw Error("server response is not valid");case 11:return _context16.abrupt("return",(t[_e48]=r.values,t));case 14:_context16.prev=14;_context16.t0=_context16["catch"](2);return _context16.abrupt("return",(this._logger.log("error","error in getting data points values of ".concat(_e48)),this._logger.log("error",_context16.t0),t));case 17:case"end":return _context16.stop();}},_callee15,this,[[2,14]]);}));function _getFunctionDataPointsValues(_x28){return _getFunctionDataPointsValues2.apply(this,arguments);}return _getFunctionDataPointsValues;}()},{key:"_getDataPointUid",value:function _getDataPointUid(_e49,t){var _iterator4=_createForOfIteratorHelper(t.dataPoints),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var a=_step4.value;if(a.name==_e49)return a.uid;}}catch(err){_iterator4.e(err);}finally{_iterator4.f();}return null;}},{key:"_getServerConfiguration",value:function(){var _getServerConfiguration2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee16(){var _e50,t,a;return _regeneratorRuntime().wrap(function _callee16$(_context17){while(1)switch(_context17.prev=_context17.next){case 0:_context17.prev=0;_context17.t0="/api/uiconfig?token=";_context17.next=4;return this._prepareToken();case 4:_context17.t1=_context17.sent;_e50=_context17.t0.concat.call(_context17.t0,_context17.t1,"&expand=dataPointFlags,parameters,locations,trades");_context17.next=8;return this.get(_e50);case 8:t=_context17.sent;a=JSON.parse(t);if(!(a.error&&"invalidAuth"==a.error.code)){_context17.next=16;break;}_context17.next=13;return this._patchForCachedInvalidTokens();case 13:_context17.t2=_context17.sent;_context17.next=17;break;case 16:_context17.t2=(this.cachedConfiguration=a,this.cachedConfiguration);case 17:return _context17.abrupt("return",_context17.t2);case 20:_context17.prev=20;_context17.t3=_context17["catch"](0);return _context17.abrupt("return",(this._logger.log("error","can not get configuration",_context17.t3),this.cachedConfiguration));case 23:case"end":return _context17.stop();}},_callee16,this,[[0,20]]);}));function _getServerConfiguration(){return _getServerConfiguration2.apply(this,arguments);}return _getServerConfiguration;}()},{key:"_prepareToken",value:function(){var _prepareToken2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee17(){var _e52;return _regeneratorRuntime().wrap(function _callee17$(_context18){while(1)switch(_context18.prev=_context18.next){case 0:if(!this.gwInfo.token){_context18.next=2;break;}return _context18.abrupt("return",this.gwInfo.token);case 2:_context18.next=4;return this.getToken(this.gwInfo.username,this.gwInfo.password);case 4:_e52=_context18.sent;return _context18.abrupt("return",(this.gwInfo.token=_e52,_e52));case 6:case"end":return _context18.stop();}},_callee17,this);}));function _prepareToken(){return _prepareToken2.apply(this,arguments);}return _prepareToken;}()},{key:"_patchForCachedInvalidTokens",value:function(){var _patchForCachedInvalidTokens2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee18(){var _e53,t,a,r,n;return _regeneratorRuntime().wrap(function _callee18$(_context19){while(1)switch(_context19.prev=_context19.next){case 0:_e53=this._getRandomIntInclusive(1,5);_context19.next=3;return this.getToken(this.gwInfo.username,this.gwInfo.password,_e53);case 3:t=_context19.sent;a="/api/uiconfig?token=".concat(t,"&expand=dataPointFlags,parameters,locations,trades");_context19.next=7;return this.get(a);case 7:r=_context19.sent;n=JSON.parse(r);if(!(n.error&&"invalidAuth"==n.error.code)){_context19.next=11;break;}throw Error("we can not get configuration in second try!");case 11:return _context19.abrupt("return",(this.gwInfo.token=t,n));case 12:case"end":return _context19.stop();}},_callee18,this);}));function _patchForCachedInvalidTokens(){return _patchForCachedInvalidTokens2.apply(this,arguments);}return _patchForCachedInvalidTokens;}()},{key:"_getRandomIntInclusive",value:function _getRandomIntInclusive(_e54,t){return _e54=Math.ceil(_e54),t=Math.floor(t),Math.floor(Math.random()*(t-_e54+1)+_e54);}},{key:"toJSON",value:function toJSON(){return{sys:"gira",ip:this.gwInfo.ip,port:this.gwInfo.port};}},{key:"equalsTo",value:function equalsTo(_e55){return!!_e55&&_e55 instanceof xnm.aio.gira.GiraServer&&this.gwInfo.ip==_e55.gwInfo.ip;}},{key:"generateGiraError",value:function generateGiraError(_e56,t){var a=xnm.aio.gira.DM;return a||a.Error?new a.Error(t,_e56):Error(_e56);}}],[{key:"parseJSON",value:function parseJSON(t){return t.ip?new e(t.ip,t.port):null;}}]);return e;}();return e.serversCache={},e.cacheTime=3e5,e;}(),xnm.aio.gira.DM={MAP:{"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"switch status",ref:{value:"OnOff",options:["off","on"]}}]},dimmer:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"brightness",ref:{value:"Brightness",value_t:"brightness",ext:"%d",extMeta:"0-100"}},{type:"int",name:"shift",ref:{value:"Shift",ext:"%d",extMeta:"0-100"}}],status:[{type:"enum",name:"switch status",ref:{value:"OnOff",options:["off","on"]}},{type:"int",name:"brightness",ref:{value:"Brightness",value_t:"brightness"}}]},blind:{command:[{type:"enum",name:"step up",ref:{value:"StepUp"}},{type:"enum",name:"step down",ref:{value:"StepDown"}},{type:"enum",name:"move up",ref:{value:"Up"}},{type:"enum",name:"move down",ref:{value:"Down"}},{type:"int",name:"position",ref:{value:"Position",ext:"%d",extMeta:"0-100"}},{type:"int",name:"slat position",ref:{value:"Slat-Position",ext:"%d",extMeta:"0-100"}}],status:[{type:"int",name:"position",ref:{value:"Position"}},{type:"int",name:"slat position",ref:{value:"Slat-Position"}},{type:"enum",name:"movement status",ref:{value:"Movement",options:["idle","moving"]}}]},heater:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"float",name:"set point",ref:{value:"Set-Point",value_t:"setpointTemp",ext:"%f",scale:.5}}],status:[{type:"float",name:"current temperature",ref:{value:"Current",value_t:"currentTemperature"}},{type:"float",name:"set temperature",ref:{value:"Set-Point",value_t:"setTemperature"}}]},dimmerrgbw:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"brightness",ref:{value:"Brightness",value_t:"brightness",ext:"%d",extMeta:"0-100"}},{type:"int",name:"red",ref:{value:"Red",value_t:"red",ext:"%d",extMeta:"0-100"}},{type:"int",name:"blue",ref:{value:"Blue",value_t:"blue",ext:"%d",extMeta:"0-100"}},{type:"int",name:"green",ref:{value:"Green",value_t:"green",ext:"%d",extMeta:"0-100"}},{type:"int",name:"White",ref:{value:"White",value_t:"white",ext:"%d",extMeta:"0-100"}},{type:"rgb",name:"color",ref:{value:"color",ext:"%rgb"}},{type:"rgbw",name:"color_white",ref:{value:"color_white",ext:"%rgbw"}}],status:[{type:"enum",name:"switch status",ref:{value:"OnOff",options:["off","on"]}},{type:"int",name:"brightness",ref:{value:"Brightness",value_t:"brightness"}},{type:"int",name:"red",ref:{value:"Red",value_t:"red"}},{type:"int",name:"blue",ref:{value:"Blue",value_t:"blue"}},{type:"int",name:"green",ref:{value:"Green",value_t:"green"}},{type:"int",name:"white",ref:{value:"White",value_t:"white"}}]},scene:{command:[{type:"int",name:"scene",ref:{value:"Scene",value_t:"scene",ext:"%d",extMeta:"1-64"}}]}},SYS:"gira",applyIPEventFilter:function applyIPEventFilter(e,t,a,r,n){if(!e||!e.type)return null;var i=xnm.aio.gira.DM.getIPevtMap(e);return i&&n!==null&&n!==void 0&&n.eventsCallbackUrl?{ipevt:i}:null;},applyUIFilter:function applyUIFilter(e,t,a){if(!e.sys)return null;var r=function r(e,t){if("*"===e||"*"===e[0])return!0;for(var a=0;a<e.length;a++)if(e[a]==t)return!0;return!1;},n=function n(e,t){var n=[],i=null,o=xnm.aio.gira.DM.getCommandStatusMap(e,a);return o&&(i=function(e,t,a){var n=[];switch(a.catagory){case"command":e.command&&e.command.forEach(function(e){if(r(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(r(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});}return n;}(o,0,t),n=n.concat(i)),n;},i=JSON.parse(JSON.stringify(e)),o=null;switch(t.catagory){case"command":o=n(e,t),i.command=o;break;case"status":o=n(e,t),i.status=o;break;default:return null;}return o&&0!=o.length?i:null;},supportSmartWidget:function supportSmartWidget(e,t){return!(!e||!e.type)&&"undefined"!==e.type;},applySmartWidgetFilter:function applySmartWidgetFilter(e,t,a,r,n){if(!t||!t.type)return null;var i=function(e){var t=[];switch(e.type){case"blind":t.push("blind");break;case"dimmer":case"dimmerrgbw":t.push("dimmer","switch"),"dimmerrgbw"===e.type&&t.push("rgb");break;case"switch":t.push("switch");break;case"heater":t.push("thermostat");}return t;}(t),o=function(e){var t={};switch(e.type){case"blind":t["%moveTo%"]={value:"Position",ext:"%d",extMeta:"0-100"},t["%moveDown%"]={value:"Down"},t["%moveUp%"]={value:"Up"},t["%lamellaTo%"]={value:"Slat-Position",ext:"%d",extMeta:"0-100"};break;case"dimmer":case"dimmerrgbw":case"switch":t["%dimOn%"]={value:"on"},t["%on%"]={value:"on"},t["%dimOff%"]={value:"off"},t["%off%"]={value:"off"},t["%toggle%"]={value:"toggle"},"dimmer"===e.type?t["%dimTo%"]={value:"Brightness",ext:"%d",extMeta:"0-100"}:"dimmerrgbw"===e.type&&(t["%dimTo%"]={value:"Brightness",ext:"%d",extMeta:"0-100"},t["%red%"]={value:"Red",ext:"%d",extMeta:"0-100"},t["%green%"]={value:"Green",ext:"%d",extMeta:"0-100"},t["%blue%"]={value:"Blue",ext:"%d",extMeta:"0-100"},t["%white%"]={value:"White",ext:"%d",extMeta:"0-100"});break;case"heater":t["%thermoOff%"]={value:"off"},t["%thermoOn%"]={value:"off"},t["%thermoTempTo%"]={value:"Set-Point",ext:"%d"};}return t;}(t),s=function(e){var t={};switch(e.type){case"blind":t["%blindState%"]={value:"Position",extMeta:"0-100"},t["%lamellaState%"]={value:"Slat-Position",extMeta:"0-100"};break;case"dimmer":case"dimmerrgbw":case"switch":t["%switchState%"]={value:"OnOff"},"dimmer"===e.type?t["%dimmerState%"]={value:"Brightness",extMeta:"0-100"}:"dimmerrgbw"===e.type&&(t["%dimmerState%"]={value:"Brightness",extMeta:"0-100"},t["%red%"]={value:"Red",extMeta:"0-100"},t["%green%"]={value:"Green",extMeta:"0-100"},t["%blue%"]={value:"Blue",extMeta:"0-100"},t["%white%"]={value:"White",extMeta:"0-100"});break;case"heater":t["%thermoCurrentTemp%"]={value:"Current"},t["%thermoSetTemp%"]={value:"Set-Point"};}return t;}(t);return e._injectToSmartWidgetTemplate(r,i,n,o,s);},createDevice:function createDevice(e,t,a){var r=xnm.aio.gira.DM;e?a(null,e):a(new r.Error(r.Error.ERROR_CODE.INVALID,"info is missing"));},createGateway:function createGateway(e,t,a){var _this8=this;return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee19(){var _t3,_a;return _regeneratorRuntime().wrap(function _callee19$(_context20){while(1)switch(_context20.prev=_context20.next){case 0:_context20.prev=0;_this8._checkGwInfo(e);_t3=new xnm.aio.gira.GiraServer(e);_context20.next=5;return _t3.isGiraServer();case 5:if(_context20.sent){_context20.next=7;break;}throw new _this8.Error(_this8.Error.ERROR_CODE.NOT_FOUND,"no gira server");case 7:if(!(e.username&&e.password)){_context20.next=12;break;}_context20.next=10;return _t3.getToken(e.username,e.password);case 10:_a=_context20.sent;e.token=_a;case 12:_context20.t0=e.eventsCallbackUrl;if(!_context20.t0){_context20.next=16;break;}_context20.next=16;return _t3.registerCallbackUrls();case 16:a(null,e);_context20.next=22;break;case 19:_context20.prev=19;_context20.t1=_context20["catch"](0);_this8._handleError(_context20.t1,a);case 22:case"end":return _context20.stop();}},_callee19,null,[[0,19]]);}))();},deleteDevice:function deleteDevice(e,t,a){a();},deleteGateway:function deleteGateway(e,t,a){new xnm.aio.gira.GiraServer(e).unregisterClient().then(function(t){console.log("".concat(e.name," is deleted"),t);})["catch"](function(e){console.log(e);}),a();},getCommandStatusMap:function getCommandStatusMap(e,t){if(!e.type)return null;if(!xnm.aio.gira.DM.MAP[e.type])return null;var a=JSON.parse(JSON.stringify(xnm.aio.gira.DM.MAP[e.type])),r=e.supportedDataPoints;return a.command&&(a.command=this._filterCommandsOrStatuses(a.command,r)),a.status&&(a.status=this._filterCommandsOrStatuses(a.status,r)),a;},_filterCommandsOrStatuses:function _filterCommandsOrStatuses(e,t){var _this9=this;return e.filter(function(e){var a=e.ref.value;return a=_this9._fixNameOfCommand(a),t.find(function(e){return(e.dataPointName||e.dataPontName)==a;});});},_fixNameOfCommand:function _fixNameOfCommand(e){switch(e){case"on":case"off":case"toggle":e="OnOff";break;case"StepUp":case"StepDown":e="Step-Up-Down";break;case"Up":case"Down":e="Up-Down";break;case"color":e="Red";break;case"color_white":e="White";}return e;},getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"Gira"}];},getIPDeviceType:function getIPDeviceType(){return[{sys:xnm.aio.gira.DM.SYS,name:"Gira"}];},getIPevtMap:function getIPevtMap(e){return e.type&&xnm.aio.gira.DM.MAP[e.type]&&xnm.aio.gira.DM.MAP[e.type].status||null;},toGeneralDevice:function toGeneralDevice(e){return e?"blind"===e.type?{type:"blind",commands:{position:{value:{type:"INT",min:0,max:100}},rotation:{value:{type:"INT",min:0,max:100}},up:{},down:{}},states:{position:{type:"INT",min:0,max:100},rotation:{type:"INT",min:0,max:100}},details:{commands:{position:{value:"Position",ext:"%d",extMeta:"0-100"},rotation:{value:"Slat-Position",ext:"%d",extMeta:"0-100"},up:{value:"Up"},down:{value:"Down"}},states:{position:{value:"Position",ext:"%d",extMeta:"0-100"},rotation:{value:"Slat-Position",ext:"%d",extMeta:"0-100"}}}}:"dimmer"===e.type?{type:"dimmer",commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100}}},states:{brightness:{type:"INT",min:0,max:100},state:{values:["on","off"]}},details:{commands:{on:{value:"on"},off:{value:"off"},toggle:{value:"toggle"},brightness:{value:"Brightness",ext:"%d",extMeta:"0-100"}},states:{brightness:{value:"Brightness",ext:"%d",extMeta:"0-100"},state:{value:"OnOff"}}}}:"dimmerrgbw"===e.type?{type:"dimmer",commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100}},red:{value:{type:"INT",min:0,max:100}},green:{value:{type:"INT",min:0,max:100}},blue:{value:{type:"INT",min:0,max:100}},white:{value:{type:"INT",min:0,max:100}}},states:{brightness:{type:"INT",min:0,max:100},state:{values:["on","off"]},red:{type:"INT",min:0,max:100},green:{type:"INT",min:0,max:100},blue:{type:"INT",min:0,max:100},white:{type:"INT",min:0,max:100}},details:{commands:{on:{value:"on"},off:{value:"off"},toggle:{value:"toggle"},brightness:{value:"Brightness",ext:"%d",extMeta:"0-100"},red:{value:"Red",extMeta:"0-100"},green:{value:"Green",extMeta:"0-100"},blue:{value:"Blue",extMeta:"0-100"},white:{value:"White",extMeta:"0-100"}},states:{state:{value:"OnOff"},brightness:{value:"Brightness",ext:"%d",extMeta:"0-100"},red:{value:"Red",extMeta:"0-100"},green:{value:"Green",extMeta:"0-100"},blue:{value:"Blue",extMeta:"0-100"},white:{value:"White",extMeta:"0-100"}}}}:"heater"===e.type?{type:"heater",commands:{on:{},off:{},tempTo:{value:{type:"FLOAT",step:.5}}},states:{setpoint:{value:{type:"FLOAT",step:.5}},temperature:{value:{type:"FLOAT",step:.5}}},details:{commands:{on:{value:"on"},off:{value:"off"},tempTo:{value:"Set-Point",ext:"%f"}},states:{setpoint:{value:"Set-Point"},temperature:{value:"Current"}}}}:"switch"===e.type?{type:"switch",commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]}},details:{commands:{on:{value:"on"},off:{value:"off"},toggle:{value:"toggle"}},states:{state:{value:"OnOff"}}}}:null:null;},updateDevice:function updateDevice(e,t,a){var r=xnm.aio.gira.DM;e?a(null,e):a(new r.Error(r.Error.ERROR_CODE.INVALID,"info is missing"));},updateGateway:function(){var _updateGateway=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee20(e,t,a,r){return _regeneratorRuntime().wrap(function _callee20$(_context21){while(1)switch(_context21.prev=_context21.next){case 0:t?this.createGateway(t,a,r):r(new this.Error(this.Error.ERROR_CODE.INVALID,"no new info"));case 1:case"end":return _context21.stop();}},_callee20,this);}));function updateGateway(_x29,_x30,_x31,_x32){return _updateGateway.apply(this,arguments);}return updateGateway;}(),_checkGwInfo:function _checkGwInfo(e){if(!e)throw new this.Error(this.Error.ERROR_CODE.INVALID,"info is invalid");if(!e.ip)throw new this.Error(this.Error.ERROR_CODE.INVALID,"ip is invalid");},_handleError:function _handleError(e,t){console.log(e),e.code?t(e,null):t(new this.Error(this.Error.ERROR_CODE.UNKNOWN,e.message?e.message:"unknown error"),null);}},xnm.aio.gira.DM.Error=function(e,t){this.code=e,this.message=t,this.stack=new Error().stack;},xnm.aio.gira.DM.Error.prototype=new Error(),xnm.aio.gira.DM.Error.prototype.name="GiraDMError",xnm.aio.gira.DM.Error.prototype.code=0,xnm.aio.gira.DM.Error.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOWN:4,NOT_FOUND:5,IP_EXISTS:6},xnm.aio.gira.Handler=function(){var e=require("x.logger.js");if(e){var t="xnm.aio.gira.Handler";this._logger=e.getLogger(t),require("x.logger.js").setLogToConsole(!0,t);}},xnm.aio.gira.Handler.prototype={devicemanager:xnm.aio.gira.DM,discoverWithTimeout:function(){var _discoverWithTimeout=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee21(e,t){return _regeneratorRuntime().wrap(function _callee21$(_context22){while(1)switch(_context22.prev=_context22.next){case 0:_context22.prev=0;_context22.t0=t;_context22.next=4;return this._findServersLocatedInNetwork();case 4:_context22.t1=_context22.sent;(0,_context22.t0)(null,_context22.t1);_context22.next=11;break;case 8:_context22.prev=8;_context22.t2=_context22["catch"](0);this._logger.log("error","discoverWithTimeout"),this._logger.log("error",_context22.t2),t(_context22.t2,null);case 11:case"end":return _context22.stop();}},_callee21,this,[[0,8]]);}));function discoverWithTimeout(_x33,_x34){return _discoverWithTimeout.apply(this,arguments);}return discoverWithTimeout;}(),doCommand:function doCommand(e,t,a){var r=this.resolveGateway(e.gateway);r?r.executeCommandCreator(e,t,function(e){a&&a(e);}):a&&a(new Error("device format invalid"));},doStatus:function doStatus(e,t,a,r){var n=this.resolveGateway(t);if(!n)return void(r&&r(new Error("device format invalid")));var i=[{id:e,status:a}];n.getStatesCreator(null,i,function(e,t){e?r&&r(e):r&&r(null,t[0]);});},getDeviceCommands:function getDeviceCommands(e,t){console.log("getDeviceCommands","deviceData",e);var a=xnm.aio.gira.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),r=a?a.command:[];t&&t(null,r);},getDeviceList:function(){var _getDeviceList=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee22(e,t){var a;return _regeneratorRuntime().wrap(function _callee22$(_context23){while(1)switch(_context23.prev=_context23.next){case 0:_context23.prev=0;if(e.username){_context23.next=3;break;}return _context23.abrupt("return",void t(new Error("gateway does not have username")));case 3:if(e.password){_context23.next=5;break;}return _context23.abrupt("return",void t(new Error("gateway does not have password")));case 5:if(e.token){_context23.next=7;break;}return _context23.abrupt("return",void t(new Error("gateway does not have any token, try to connect to server again")));case 7:a=new xnm.aio.gira.GiraServer(e);if(a.isGiraServer()){_context23.next=10;break;}return _context23.abrupt("return",void t(new Error("server is not reachable")));case 10:_context23.next=12;return a.getDevices(t);case 12:_context23.next=17;break;case 14:_context23.prev=14;_context23.t0=_context23["catch"](0);t(_context23.t0);case 17:case"end":return _context23.stop();}},_callee22,null,[[0,14]]);}));function getDeviceList(_x35,_x36){return _getDeviceList.apply(this,arguments);}return getDeviceList;}(),getDeviceStatus:function getDeviceStatus(e,t){t&&t(new Error("not implemented"),null);},registModule:function registModule(e){e.register(xnm.aio.gira.DM.SYS,"gira");},resolveGateway:function resolveGateway(e){return e?xnm.aio.gira.parseJSON(e):null;},_findServersLocatedInNetwork:function _findServersLocatedInNetwork(){return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee23(){var e,t,a,r,n,_i,_r,_e58,_t4,_iterator5,_step5,_e59,_loop3,_i2,_n2;return _regeneratorRuntime().wrap(function _callee23$(_context25){while(1)switch(_context25.prev=_context25.next){case 0:e=[],t=require("os");if(t){_context25.next=3;break;}throw Error("it is not node environment");case 3:a=t.networkInterfaces(),r=Object.keys(a);if(!(!a||0==r.length)){_context25.next=6;break;}throw Error("msg:no_interfaces");case 6:n=[];for(_i=0,_r=r;_i<_r.length;_i++){_e58=_r[_i];_t4=a[_e58];_iterator5=_createForOfIteratorHelper(_t4);try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){_e59=_step5.value;"IPv4"==_e59.family&&1!=_e59.internal&&n.push(_e59);}}catch(err){_iterator5.e(err);}finally{_iterator5.f();}}if(!(n.length>5)){_context25.next=10;break;}throw Error("msg:max_interfaces|5");case 10:_loop3=/*#__PURE__*/_regeneratorRuntime().mark(function _loop3(){var t,a,r,_e60,_t5,_n3;return _regeneratorRuntime().wrap(function _loop3$(_context24){while(1)switch(_context24.prev=_context24.next){case 0:t=_n2[_i2];a=/(\d{1,3}\.\d{1,3}\.\d{1,3})/gm.exec(t.address)[0],r=[];for(_e60=1;_e60<253;_e60++){_t5="".concat(a,".").concat(_e60),_n3=new xnm.aio.gira.GiraServer({sys:"gira",ip:_t5,port:443},5e3);r.push(_n3.isGiraServer());}_context24.next=5;return Promise.all(r);case 5:_context24.sent.forEach(function(t,r){t&&e.push({sys:"gira",deviceType:t.deviceType,deviceVersion:t.deviceVersion,ip:"".concat(a,".").concat(r+1),port:443,name:t.deviceName});});case 6:case"end":return _context24.stop();}},_loop3);});_i2=0,_n2=n;case 12:if(!(_i2<_n2.length)){_context25.next=17;break;}return _context25.delegateYield(_loop3(),"t0",14);case 14:_i2++;_context25.next=12;break;case 17:return _context25.abrupt("return",e);case 18:case"end":return _context25.stop();}},_callee23);}))();}},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.gira.Handler());