var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.tado=xnm.aio.tado||{},xnm.aio.tado.OAuth2={_cache:{},_logger:require("x.logger.js").getLogger("xnm.aio.tado.OAuth2"),urlOAuth:{host:"auth.tado.com",path:"/oauth/token"},clientId:"dGFkby13ZWItYXBw",clientSecret:"d1phUk43cnBqbjNGb055RjVJRnV4Zzl1TXpZSmN2T29ROFFXaUlxUzNoZms2Z0xoVmxHNTdqNVlOb1pMMlJ0Yw",scopes:["identity:read","home.details:read","home.operation:read","home.operation.overlay:write"],_getCacheKey:function _getCacheKey(e){return"".concat(e.user,":").concat(e.password);},_removeCacheEntry:function _removeCacheEntry(e){var t=this._getCacheKey(e);delete this._cache[t];},getTokens:function getTokens(e,t){var _this=this;this._logger.log("debug","[getTokens] ...");var n=e.bridge;if(!n.user||!n.password){var _e=new Error("No username and/or password provided.");return this._logger.log("error","[getTokens] "+_e.message),void(t&&t(_e));}var o=this._getCacheKey(n);if(!0===e.allowCache){var _e2=this._cache[o];if(_e2&&_e2.expires>Date.now())return this._logger.log("debug","[getTokens] Tokens returned from cache."),void(t&&t(null,_e2.response));}var r=require("https"),a={host:this.urlOAuth.host,path:this.urlOAuth.path,method:"POST"},s={client_id:atob(this.clientId),client_secret:atob(this.clientSecret+"=="),grant_type:"password",scope:this.scopes.join(" "),username:n.user,password:n.password};var i="";for(var _e3 in s)i+=(0===i.length?"?":"&")+_e3+"="+encodeURIComponent(s[_e3]);a.path+=i;var u=r.request(a,function(e){var n="";e.on("data",function(e){n+=e;}),e.on("end",function(){var r=null,a=null;try{a=JSON.parse(n);}catch(e){r=e;}a&&(a.access_token?a.refresh_token||(r=new Error("No refresh_token received. Data was: "+n)):r=new Error("No access_token received. Data was: "+n)),r?_this._logger.log("error","[getTokens] "+r.message):(_this._logger.log("debug","[getTokens] Success."),_this._cache[o]={expires:Date.now()+1e3*a.expires_in,response:a}),t&&t(r,a,e.statusCode),t=null;});});"function"==typeof u.setTimeout&&u.setTimeout(1e4,function(){return u.abort();}),"function"==typeof u.on&&u.on("error",function(e){e=e||new Error("Unknown error"),_this._logger.log("error","[getTokens] Error: "+e.message),t&&t(e),t=null;}),u.end();},refreshAccessToken:function refreshAccessToken(e,t){var _this2=this;if(this._logger.log("debug","[refreshAccessToken] ..."),!e.refreshToken){var _e4=new Error("No refresh token provided.");return this._logger.log("error","[refreshAccessToken] "+_e4.message),void(t&&t(_e4));}var n=require("https"),o={host:this.urlOAuth.host,path:this.urlOAuth.path,method:"POST"},r={client_id:atob(this.clientId),client_secret:atob(this.clientSecret+"=="),grant_type:"refresh_token",scope:this.scopes.join(" "),refresh_token:e.refreshToken};var a="";for(var _e5 in r)a+=(0===a.length?"?":"&")+_e5+"="+encodeURIComponent(r[_e5]);o.path+=a;var s=n.request(o,function(n){var o="";n.on("data",function(e){o+=e;}),n.on("end",function(){var r=null,a=null;try{a=JSON.parse(o);}catch(e){r=e;}if(a&&(a.access_token?a.refresh_token||(r=new Error("No refresh_token received. Data was: "+o)):r=new Error("No access_token received. Data was: "+o),"invalid_grant"===a.error))return _this2._logger.log("error","[refreshAccessToken] "+r.message),_this2._logger.log("debug","[refreshAccessToken] Trying to get new refresh token."),_this2._removeCacheEntry(e),void setTimeout(function(){_this2.getTokens({bridge:e,allowCache:!1},function(e,n,o){t&&t(e,n,o);});},500);r?_this2._logger.log("error","[refreshAccessToken] "+r.message):_this2._logger.log("debug","[refreshAccessToken] Success."),t&&t(r,a,n.statusCode),t=null;});});"function"==typeof s.setTimeout&&s.setTimeout(1e4,function(){return s.abort();}),"function"==typeof s.on&&s.on("error",function(e){e=e||new Error("Unknown error"),_this2._logger.log("error","[refreshAccessToken] Error: "+e.message),t&&t(e),t=null;}),s.end();}},xnm.aio.tado.Bridge=function(){var e=function e(_e6,t,n,o){this._logger=require("x.logger.js").getLogger("xnm.aio.tado.Bridge"),this.user=_e6,this.password=t,this.refreshToken=n,this.accessToken=o;};return e.prototype.executeCommandCreator=function(e,t,n){if(t&&t.value){var o=t.value;if("setTo"==t.value){if(null==t.ext||void 0===t.ext)return void(n&&n(new Error("command ext format invalid")));o=t.value+t.ext;}this.executeCommand(o,function(e){n&&n(e);});}else n&&n(new Error("command format invalid"));},e.prototype.getStatesCreator=function(e,t,n){t?this.getState(function(e,o){for(var r=[],a=0;a<t.length;a++){var s=t[a],i="?";if(s.id&&s.status&&s.status.value&&o){var u=o[s.status.value];null!=u&&void 0!==u&&(i=u);}r.push({id:s.id,status:i});}n&&n(null,r);}):n&&n(new Error("deviceList is null"));},e.prototype._doRequest=function(e,t,n){var _this3=this;if(this._tokenRequestFailed){var _e7=new Error("Failing to get refresh and access token. Cannot handle requests.");return this._logger.log("error","[_doRequest] "+_e7.message),void n(_e7);}if(this._waitingForToken)return void this._logger.log("debug","[_doRequest] Ignoring request, still waiting for token refresh.");var o=!this.accessToken||this._accessTokenExpires<=Date.now();if(!o||this.refreshToken){if(o&&this.refreshToken)return this._waitingForToken=!0,void xnm.aio.tado.OAuth2.refreshAccessToken(this,function(o,r){if(o||r!==null&&r!==void 0&&r.access_token||(o=new Error("No access token could be received.")),o)return _this3._waitingForToken=!1,void n(o);_this3.refreshToken=r.refresh_token,_this3.accessToken=r.access_token,_this3._accessTokenExpires=Date.now()+1e3*r.expires_in,setTimeout(function(){_this3._waitingForToken=!1,_this3._logger.log("debug","[_doRequest] Repeating request with new access token."),_this3._doRequest(e,t,n);},1e3);});var r=e+"?",a=null;if(t)for(var s in t)t.hasOwnProperty(s)&&(r+=s+"="+encodeURIComponent(t[s])+"&");a=r;var i={host:"my.tado.com",path:r,method:"GET",headers:{Connection:"close","Content-Type":'application/json; charset="UTF-8"'}};this.accessToken?i.headers.Authorization="Bearer "+this.accessToken:(i.path+="?username=".concat(encodeURIComponent(this.user),"&password=").concat(encodeURIComponent(this.password)),a+="?username=xxxxxx&password=xxxxxx"),this._logger.log("trace","send https request to:"+a);var u=require("https").request(i,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){if(_this3._logger.log("trace","receive https response code:"+e.statusCode+" body:"+t),401==e.statusCode&&_this3.accessToken&&(_this3.accessToken=null,_this3.refreshToken=null),200==e.statusCode){var o=null;try{o=JSON.parse(t),n&&(n(null,o),n=null);}catch(e){n&&(n(new Error("https response invalid json")),n=null);}}else n&&(n(new Error("https response code:"+e.statusCode),t),n=null);});});u.on("error",function(e){_this3._logger.log("trace","send https request err:"+e.message),n&&(n(e),n=null);}),u.setTimeout(2e3,function(){_this3._logger.log("trace","send https request timeout"),u.abort(),n&&(n(new Error("https request timeout")),n=null);}),u.end();}else{this._waitingForToken=!0;var _e8={bridge:this,allowCache:!0};xnm.aio.tado.OAuth2.getTokens(_e8,function(e,t){if(e||t!==null&&t!==void 0&&t.refresh_token||(e=new Error("No refresh token could be received.")),e)return _this3._waitingForToken=!1,_this3._tokenRequestFailed=!0,void n(e);_this3._tokenRequestFailed=!1,_this3.refreshToken=t.refresh_token,_this3.accessToken=t.access_token,_this3._accessTokenExpires=Date.now()+1e3*t.expires_in,setTimeout(function(){_this3._waitingForToken=!1,_this3._logger.log("debug","[_doRequest] Repeating request with new tokens."),_this3._doRequest(method,r,data,n);},1e3);});}},e.prototype.executeCommand=function(e,t){var n=!0,o=null,r=null,a=this;if("auto"==e)o="/mobile/1.9/updateThermostatSettings",r={setMode:"AUTO"};else if("up"==e||"down"==e)this.getState(function(n,o){if(n)t&&t(n);else if(o&&o.mode&&o.temp){var s=parseFloat(o.temp);"up"==e?s+=.5:s-=.5,s<5?s=5:s>25&&(s=25),s=s.toFixed(1),r={setMode:"MANUAL",manualTemp:s},a._doRequest("/mobile/1.9/updateThermostatSettings",r,function(e){t&&t(e);});}else t&&t(n,o);}),n=!1;else if(0==e.indexOf("setTo")){e=(e=e.replace(/setTo/g,"")).replace(/%/g,"");var s=parseFloat(e);s<5?s=5:s>25&&(s=25),s=s.toFixed(1),o="/mobile/1.9/updateThermostatSettings",r={setMode:"MANUAL",manualTemp:s};}o?this._doRequest(o,r,function(e){t&&t(e);}):n&&t&&t();},e.prototype.getState=function(e){var t={},n=this;this._doRequest("/mobile/1.9/getCurrentState",null,function(o,r){o?e(o):(r&&(t.heatingOn=r.heatingOn,t.temp=parseFloat(r.setPointTemp).toFixed(1),t.insideTemp=parseFloat(r.insideTemp).toFixed(1),t.mode=r.operation),r.homeId?n._doRequest("/api/v1/home/"+r.homeId+"/hvacState",null,function(n,o){o&&o.humidity&&(t.humidity=o.humidity.percentage),e&&e(n,t);}):e&&e(o,t));});},e.prototype.getStateValues=function(e,t){return t;},e.prototype.toJSON=function(){return{sys:xnm.aio.tado.DM.SYS,username:this.user,password:this.password,refreshToken:this.refreshToken,accessToken:this.accessToken};},e.prototype.equalsTo=function(t){return!!t&&t instanceof e&&this.user==t.user&&this.password==t.password;},e.parseJSON=function(t){return t.username&&t.password?new e(t.username,t.password,t.refreshToken,t.accessToken):null;},e;}(),xnm.aio.tado.BridgeV2=function(){var e={},t=function t(_t,n){var o={temp:20,type:"MANUAL",durationInSeconds:60};return e[_t+"_"+n]=o,o;},n=function n(e,t,_n,o){this._logger=require("x.logger.js").getLogger("xnm.aio.tado.BridgeV2"),this.user=e,this.password=t,this.refreshToken=_n,this.accessToken=o,this._zoneStateCBS={};};return n.prototype.getZones=function(e){var t=this;this._getMe(function(n,o){if(n)e&&e(n);else{var r=[],a=o.homes,s=0,i=function i(n,o){if(!n&&o)for(var u=a[s].id,d=0;d<o.length;d++){var l=o[d];if("AIR_CONDITIONING"!==l.type){var m={name:l.name,type:"zone",homeID:u,zoneID:l.id,zoneType:l.type};r.push(m);}}++s<a.length?t._getZones(a[s].id,i):e&&e(null,r);};t._getZones(a[s].id,i);}});},n.prototype.executeCommandCreator=function(e,t,n){t&&t.value?e&&"thermo"==e.type?new xnm.aio.tado.Bridge(this.user,this.password,this.refreshToken,this.accessToken).executeCommandCreator(e,t,n):this.executeCommand(e,t,function(e){n&&n(e);}):n&&n(new Error("command format invalid"));},n.prototype.getStatesCreator=function(e,t,n){if(t){for(var o=[],r=[],a=[],s=0;s<t.length;s++){var i=t[s];i&&i.device&&"thermo"===i.device.type&&a.push(i);var _e9=i.device;if(_e9&&void 0!==_e9.homeID&&null!==_e9.homeID&&void 0!==_e9.zoneID&&null!==_e9.zoneID){var u=_e9.homeID+"_"+_e9.zoneID;-1==o.indexOf(u)&&r.push(i.device);}}var d=1,l=[];a.length>0&&(d=2,new xnm.aio.tado.Bridge(this.user,this.password,this.refreshToken).getStatesCreator(e,a,function(e,t){d--,!e&&t&&(l=l.concat(t)),0==d&&n&&n(null,l);})),this.getState(r,function(e,o){for(var r=0;r<t.length;r++){var a=t[r];if(a&&a.id){var s="?",i=a.device;if(!e&&o&&i&&void 0!==i.homeID&&null!==i.homeID&&void 0!==i.zoneID&&null!==i.zoneID){var u=o[i.homeID+"_"+i.zoneID];if(u&&a.status&&a.status.value){var m=u[a.status.value];null!=m&&(s=m);}}l.push({id:a.id,status:s});}}0==--d&&n&&n(null,l);});}else n&&n(new Error("deviceList is null"));},n.prototype.executeCommand=function(n,o,r){if(n&&"zone"===n.type&&void 0!==n.homeID&&null!==n.homeID&&void 0!==n.zoneID&&null!==n.zoneID){if(o&&o.value){var a,s,i="GET",u="/api/v2/homes/"+n.homeID+"/zones/"+n.zoneID+"/overlay",d=null;switch(o.value){case"auto":i="DELETE";break;case"off":"HOT_WATER"===n.zoneType?(i="PUT",d={setting:{type:n.zoneType,power:"OFF"},termination:{type:"MANUAL"}}):(a=n.homeID+"_"+n.zoneID,(s=e[a])||(s=t(n.homeID,n.zoneID)),i="PUT",d={setting:{type:n.zoneType||"HEATING",power:"OFF"},termination:{type:s.type}},"TIMER"===s.type&&(d.termination.durationInSeconds=s.durationInSeconds));break;case"on":i="PUT",d={setting:{type:n.zoneType,power:"ON"},termination:{type:"MANUAL"}};break;case"start":a=n.homeID+"_"+n.zoneID,(s=e[a])||(s=t(n.homeID,n.zoneID)),i="PUT",d={setting:{type:"HEATING",power:"ON",temperature:{celsius:s.temp}},termination:{type:s.type}},"TIMER"==s.type&&(d.termination.durationInSeconds=s.durationInSeconds);break;case"setManuEndMode":switch(o.ext){case"MANUAL":case"TIMER":case"TADO_MODE":a=n.homeID+"_"+n.zoneID,(s=e[a])||(s=t(n.homeID,n.zoneID)),s.type=o.ext,r&&r();break;default:return void(r&&r(new Error("setManuEndMode ext invalid")));}return;case"setManuEndTimer":if(!o.ext)return void(r&&r(new Error("setManuEndTimer ext invalid")));var l=parseInt(o.ext);return isNaN(l)&&(l=1),l<1&&(l=1),a=n.homeID+"_"+n.zoneID,(s=e[a])||(s=t(n.homeID,n.zoneID)),s.durationInSeconds=60*l,void(r&&r());case"setTo":if(!o.ext)return void(r&&r(new Error("setTo ext invalid")));var m=parseFloat(o.ext);m<5?m=5:m>25&&(m=25),m=m.toFixed(1),m=parseFloat(m),a=n.homeID+"_"+n.zoneID,(s=e[a])||(s=t(n.homeID,n.zoneID)),s.temp=m,r&&r();break;case"up":case"down":var c=parseFloat(o.ext);return c&&!isNaN(c)||(c=1),a=n.homeID+"_"+n.zoneID,(s=e[a])||(s=t(n.homeID,n.zoneID)),m=s.temp,"up"==o.value?m+=c:m-=c,m<5?m=5:m>25&&(m=25),m=m.toFixed(1),m=parseFloat(m),s.temp=m,void(r&&r());default:return void(r&&r(new Error("unknown command")));}this._doRequest(i,u,JSON.stringify(d),function(e){r&&r(e);});}else r&&r(new Error("command json invalid"));}else r&&r(new Error("device json invalid"));},n.prototype.getState=function(e,t){for(var n={},o=e.length,r=o,a=function a(){0==--o&&t&&t(null,n);};r--;){var s=e[r];s&&void 0!==s.homeID&&null!==s.homeID&&void 0!==s.zoneID&&null!==s.zoneID?this.getZoneState(s.homeID,s.zoneID,function(e,t,o,r){!e&&t&&(n[o+"_"+r]=t),a();}):a();}},n.prototype.getZoneState=function(e,t,n){var o=e+"_"+t,r=this._zoneStateCBS[o];r||(r=[],this._zoneStateCBS[o]=r);var a=r.length;if(n||(n=function n(){}),-1==r.indexOf(n)&&r.push(n),0==a){var s=this;this._getZoneState(e,t,function(n,a){delete s._zoneStateCBS[o];var i=r.length;if(n)for(;i--;)r[i]&&r[i](n);else{var u=s._resolveZoneState(a),d=s._getZoneManuTermination(e,t);for(u||(u={}),u.setManutemp=d.setManutemp,u.setManuEndMode=d.setManuEndMode,u.setManuEndTimer=d.setManuEndTimer,i=r.length;i--;)r[i]&&r[i](null,u,e,t);}});}},n.prototype._getZoneManuTermination=function(n,o){var r=e[n+"_"+o];r||(r=t(n,o));var a={};return a.setManutemp=r.temp,a.setManuEndMode=r.type,a.setManuEndTimer=r.durationInSeconds,a.setManuEndTimer&&(a.setManuEndTimer=a.setManuEndTimer/60),a;},n.prototype._resolveZoneState=function(e){var t={manuEndTimer:0,manuEndTimerRemainS:0,manuEndTimerRemain:0,manuEndTimerRemainTxt:"",manuEndAutoExpire:null};e.tadoMode&&(t.mode=e.tadoMode),e.overlayType&&(t.mode=e.overlayType);var n,o=e.setting;o&&((n=o.temperature)&&void 0!==n.celsius&&null!=n.celsius&&(t.temp=n.celsius),o.power&&(t.power=o.power,"OFF"==o.power&&(t.temp=0,t.mode="FROZEN_PROTECTION")));var r=e.activityDataPoints;if(r){var a=r.heatingPower;a&&void 0!==a.percentage&&null!=a.percentage&&(t.heatingPower=a.percentage);}var s=e.sensorDataPoints;if(s){var i=s.insideTemperature;i&&void 0!==i.celsius&&null!=i.celsius&&(t.insideTemp=i.celsius);var u=s.humidity;u&&void 0!==u.percentage&&null!=u.percentage&&(t.humidity=u.percentage);}var d=e.overlay;if(d){(o=d.setting)&&((n=o.temperature)&&void 0!==n.celsius&&null!=n.celsius&&(t.temp=n.celsius),o.power&&(t.power=o.power,"OFF"==o.power&&(t.temp=0,t.mode="FROZEN_PROTECTION")));var l=d.termination;if(l)if(l.type&&(t.manuEndMode=l.type),"TIMER"==l.type){t.manuEndTimer=Math.round(l.durationInSeconds/60),t.manuEndTimerRemainS=l.remainingTimeInSeconds,t.manuEndTimerRemain=Math.round(l.remainingTimeInSeconds/60);var m=Math.floor(l.remainingTimeInSeconds/3600),c=Math.floor(l.remainingTimeInSeconds%3600/60),h=l.remainingTimeInSeconds%60;(m=""+m).length<2&&(m="0"+m),(c=""+c).length<2&&(c="0"+c),(h=""+h).length<2&&(h="0"+h),t.manuEndTimerRemainTxt=m+":"+c+":"+h,t.manuEndAutoExpire=null;}else"TADO_MODE"==l.type?(t.manuEndTimer=0,t.manuEndTimerRemainS=0,t.manuEndTimerRemain=0,t.manuEndTimerRemainTxt="",t.manuEndAutoExpire=new Date(l.projectedExpiry).toTimeString()):(t.manuEndTimer=0,t.manuEndTimerRemainS=0,t.manuEndTimerRemain=0,t.manuEndTimerRemainTxt="",t.manuEndAutoExpire=null);}return t;},n.prototype._getMe=function(e){this._doRequest("GET","/api/v2/me",null,function(t,n){e&&e(t,n);});},n.prototype._getZones=function(e,t){var n="/api/v2/homes/"+e+"/zones";this._doRequest("GET",n,null,function(e,n){t&&t(e,n);});},n.prototype._getZoneState=function(e,t,n){var o="/api/v2/homes/"+e+"/zones/"+t+"/state";this._doRequest("GET",o,null,function(e,t){n&&n(e,t);});},n.prototype._doRequest=function(e,t,n,o){var _this4=this;if(this._tokenRequestFailed){var _e10=new Error("Failing to get refresh and access token. Cannot handle requests.");return this._logger.log("error","[_doRequest] "+_e10.message),void o(_e10);}if(this._waitingForToken)return void this._logger.log("debug","[_doRequest] Ignoring request, still waiting for token refresh.");var r=!this.accessToken||this._accessTokenExpires<=Date.now();if(!r||this.refreshToken){if(r&&this.refreshToken)return this._waitingForToken=!0,void xnm.aio.tado.OAuth2.refreshAccessToken(this,function(r,a){if(r||a!==null&&a!==void 0&&a.access_token||(r=new Error("No access token could be received.")),r)return _this4._waitingForToken=!1,void o(r);_this4.refreshToken=a.refresh_token,_this4.accessToken=a.access_token,_this4._accessTokenExpires=Date.now()+1e3*a.expires_in,setTimeout(function(){_this4._waitingForToken=!1,_this4._logger.log("debug","[_doRequest] Repeating request with new access token."),_this4._doRequest(e,t,n,o);},1e3);});var a=t,s={host:"my.tado.com",path:t,method:e,headers:{Connection:"close","Content-Type":'application/json; charset="UTF-8"'}};this.accessToken?s.headers.Authorization="Bearer "+this.accessToken:(s.path+="?username=".concat(encodeURIComponent(this.user),"&password=").concat(encodeURIComponent(this.password)),a+="?username=xxxxxx&password=xxxxxx"),this._logger.log("trace","do https "+e+" request:"+a),n&&this._logger.log("trace","https body:"+n);var i=require("https").request(s,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){if(_this4._logger.log("trace","receive https response code:"+e.statusCode+" body:"+t),401==e.statusCode&&_this4.accessToken&&(_this4.accessToken=null,_this4.refreshToken=null),200==e.statusCode||204==e.statusCode){var n=null;try{(204!=e.statusCode||t)&&(n=JSON.parse(t)),o&&(o(null,n),o=null);}catch(e){o&&(o(new Error("https response invalid json")),o=null);}}else o&&(o(new Error("https response code:"+e.statusCode),t),o=null);});});i.on("error",function(e){_this4._logger.log("trace","send https request err:"+e.message),o&&(o(e),o=null);}),i.setTimeout(2e3,function(){_this4._logger.log("trace","send https request timeout"),i.abort(),o&&(o(new Error("https request timeout")),o=null);}),n&&i.write(n),i.end();}else{this._waitingForToken=!0;var _r={bridge:this,allowCache:!0};xnm.aio.tado.OAuth2.getTokens(_r,function(r,a){if(r||a!==null&&a!==void 0&&a.refresh_token||(r=new Error("No refresh token could be received.")),r)return _this4._waitingForToken=!1,_this4._tokenRequestFailed=!0,void o(r);_this4._tokenRequestFailed=!1,_this4.refreshToken=a.refresh_token,_this4.accessToken=a.access_token,_this4._accessTokenExpires=Date.now()+1e3*a.expires_in,setTimeout(function(){_this4._waitingForToken=!1,_this4._logger.log("debug","[_doRequest] Repeating request with new tokens."),_this4._doRequest(e,t,n,o);},1e3);});}},n.prototype.toJSON=function(){return{sys:xnm.aio.tado.DM.SYS,username:this.user,password:this.password,refreshToken:this.refreshToken,accessToken:this.accessToken};},n.prototype.equalsTo=function(e){return!!e&&e instanceof n&&this.user==e.user&&this.password==e.password;},n.parseJSON=function(e){return e.username&&e.password?new n(e.username,e.password,e.refreshToken,e.accessToken):null;},n;}(),xnm.aio.tado.DM=function(){var e=function e(_e11,t){this.code=_e11,this.message=t,this.stack=new Error().stack;};(e.prototype=new Error()).name="TadoDMError",e.prototype.code=0,e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var t={thermo:{command:[{type:"enum",name:"auto",ref:{value:"auto"}},{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"float",name:"manu",ref:{value:"setTo",ext:"%f",extMeta:"5.0-25.0",scale:"0.1"}}],status:[{type:"enum",name:"mode",ref:{value:"mode",options:["HOME","SLEEP","AWAY","MANUAL","NO_FREEZE"]}},{type:"float",name:"set temperature",ref:{value:"temp",extMeta:"5.0-25.0",scale:"0.1"}},{type:"float",name:"current temperature",ref:{value:"insideTemp"}},{type:"int",name:"humidity",ref:{value:"humidity"}}]},HOT_WATER:{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}}],status:[{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"float",name:"set temperature",ref:{value:"temp"}}]},zone:{command:[{type:"enum",name:"auto",ref:{value:"auto"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"start",ref:{value:"start"}},{type:"float",name:"set manu temperature",ref:{value:"setTo",value_t:"temperature",ext:"%f",extMeta:"5.0-25.0",scale:"0.1"}},{type:"enum",name:"set manu termination mode",ref:{value:"setManuEndMode",ext:"%e",extMeta:["MANUAL","TIMER","TADO_MODE"]}},{type:"int",name:"set manu termination timer",ref:{value:"setManuEndTimer",ext:"%d",extMeta:"1-720",unit:"min"}},{type:"float",name:"up",ref:{value:"up",ext:"%f",extMeta:"0.1-5.0",scale:"0.1"}},{type:"float",name:"down",ref:{value:"down",ext:"%f",extMeta:"0.1-5.0",scale:"0.1"}}],status:[{type:"enum",name:"mode",ref:{value:"mode",options:["HOME","SLEEP","AWAY","MANUAL","NO_FREEZE","FROZEN_PROTECTION"]}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"float",name:"current temperature",ref:{value:"insideTemp"}},{type:"int",name:"humidity",ref:{value:"humidity"}},{type:"int",name:"heating power",ref:{value:"heatingPower"}},{type:"float",name:"set temperature",ref:{value:"temp",extMeta:"5.0-25.0",scale:"0.1"}},{type:"enum",name:"current manu termination mode",ref:{value:"manuEndMode",ext:"%e",options:["MANUAL","TIMER","TADO_MODE"]}},{type:"int",name:"current manu termination timer",ref:{value:"manuEndTimer",ext:"%d",extMeta:"1-720",unit:"min"}},{type:"string",name:"current manu termination auto expire time",ref:{value:"manuEndAutoExpire",ext:"%s"}},{type:"int",name:"current manu termination timer remain (min)",ref:{value:"manuEndTimerRemain",unit:"min"}},{type:"int",name:"current manu termination timer remain (s)",ref:{value:"manuEndTimerRemainS",unit:"s"}},{type:"string",name:"current manu termination timer remain (text)",ref:{value:"manuEndTimerRemainTxt"}},{type:"float",name:"set manu temperature",ref:{value:"setManutemp",extMeta:"5.0-25.0",scale:"0.1"}},{type:"enum",name:"set manu termination mode",ref:{value:"setManuEndMode",ext:"%e",options:["MANUAL","TIMER","TADO_MODE"]}},{type:"int",name:"set manu termination timer",ref:{value:"setManuEndTimer",ext:"%d",extMeta:"1-720",unit:"min"}}]}};return{SYS:"tado",getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"tado°"}];},getGatewayDeviceType:function getGatewayDeviceType(e,t){return[{type:"thermo",name:"Smart Thermostat",sys:this.SYS}];},createGateway:function createGateway(t,n,o){var r=e,a=e.ERROR_CODE;t?o(null,t):o(new r(a.INVALID,"info is invalid"));},updateGateway:function updateGateway(t,n,o,r){var a=e,s=e.ERROR_CODE;n?r(null,n):r(new a(s.INVALID,"info is invalid"));},deleteGateway:function deleteGateway(e,t,n){n();},createDevice:function createDevice(t,n,o){var r=e,a=e.ERROR_CODE;if(t){if(t.gateway){if(t.type){if(n.data&&n.data.gateways&&0!==n.data.gateways.length){var s,i,u=n.data.gateways;for(s=0;s<u.length;s++)if(u[s].index===t.gateway){i=u[s];break;}i?o(null,t):o(new r(a.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else o(new r(a.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else o(new r(a.INVALID,"type is invalid"));}else o(new r(a.INVALID,"gateway is invalid"));}else o(new r(a.INVALID,"info is invalid"));},updateDevice:function updateDevice(t,n,o){var r=e,a=e.ERROR_CODE;if(t){if(t.gateway){if(t.type){if(n.data&&n.data.gateways&&0!==n.data.gateways.length){var s,i,u=n.data.gateways;for(s=0;s<u.length;s++)if(u[s].index===t.gateway){i=u[s];break;}i?o(null,t):o(new r(a.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else o(new r(a.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else o(new r(a.INVALID,"type is invalid"));}else o(new r(a.INVALID,"gateway is invalid"));}else o(new r(a.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,n){n();},applyUIFilter:function applyUIFilter(e,t,n){var o=this,r=function r(e,t,n){var o=[];return e.forEach(function(e){if("root"==e.type){var a=JSON.parse(JSON.stringify(e)),s=r(a.children,t,n);s&&s.length>0&&(a.children=s,o.push(a));}else if(function(e,t){if("*"==e)return!0;for(var n=!1,o=0;o<e.length;o++)if(e[o]==t){n=!0;break;}return n;}(n.elems,e.type)){var i=JSON.parse(JSON.stringify(e));o.push(i);}}),o;},a=function a(e,t){var a=[],s=null,i=o.getCommandStatusMap(e,n);return i&&(s=function(e,t,n){var o=[];switch(n.catagory){case"command":e.command&&(o=r(e.command,t,n));break;case"status":e.status&&(o=r(e.status,t,n));}return o;}(i,e,t),a=a.concat(s)),a;};if(!e.sys)return null;var s=JSON.parse(JSON.stringify(e)),i=null;switch(t.catagory){case"command":i=a(e,t),s.command=i;break;case"status":i=a(e,t),s.status=i;break;default:return null;}return i&&0!=i.length?s:null;},getCommandStatusMap:function getCommandStatusMap(e){return e&&e.type?t[e.zoneType]||t[e.type]:null;}};}(),xnm.aio.tado.Handler=function(){var e=function e(){};return e.prototype.OAuth2=xnm.aio.tado.OAuth2,e.prototype.Bridge=xnm.aio.tado.Bridge,e.prototype.BridgeV2=xnm.aio.tado.BridgeV2,e.prototype.devicemanager=xnm.aio.tado.DM,e.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"tado");},e.prototype.resolveGateway=function(e){return e?this.BridgeV2.parseJSON(e):null;},e.prototype.getDeviceCommands=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),o=n?n.command:[];t&&t(null,o);},e.prototype.getDeviceStatus=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),o=n?n.status:[];t&&t(null,o);},e.prototype.doCommand=function(e,t,n,o){var r=this.resolveGateway(e);r?r.executeCommandCreator(t,n,function(e){o&&o(e);}):o&&o(new Error("gateway json format invalid"));},e.prototype.doStatus=function(e,t,n,o,r){var a=this.resolveGateway(t);if(a){var s=[{id:e,device:n,status:o}];a.getStatesCreator(null,s,function(e,t){e?r&&r(e):r&&r(null,t[0]);});}else r&&r(new Error("gateway json format invalid"));},e.prototype.getDeviceList=function(e,t){var n=this.resolveGateway(e);n?n.getZones(function(e,n){t&&t(e,n);}):t&&t(new Error("gateway json format invalid"));},e.prototype.getStateValues=function(e,t){},e.prototype.getDeviceCommandList=function(e,t,n){var o=[];return t&&(o.push({id:window.XC_Text.on,cmd:"on"}),o.push({id:window.XC_Text.off,cmd:"off"})),o;},e;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.tado.Handler());