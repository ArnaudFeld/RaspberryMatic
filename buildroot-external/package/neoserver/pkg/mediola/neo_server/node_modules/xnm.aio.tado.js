var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.tado=xnm.aio.tado||{};
xnm.aio.tado.Bridge=function(){var c=function(e,a){this._logger=require("x.logger.js").getLogger("xnm.aio.tado.Bridge");this.user=e;this.password=a};c.prototype.executeCommandCreator=function(e,a,b){if(a&&a.value){e=a.value;if("setTo"==a.value){if(null==a.ext||"undefined"==typeof a.ext){b&&b(Error("command ext format invalid"));return}e=a.value+a.ext}this.executeCommand(e,function(f){b&&b(f)})}else b&&b(Error("command format invalid"))};c.prototype.getStatesCreator=function(e,a,b){a?this.getState(function(f,
d){for(var k=[],e=0;e<a.length;e++){var c=a[e],g="?";if(c.id&&c.status&&c.status.value&&d){var h=d[c.status.value];null!=h&&"undefined"!=typeof h&&(g=h)}k.push({id:c.id,status:g})}b&&b(null,k)}):b&&b(Error("deviceList is null"))};c.prototype._doRequest=function(e,a,b){e+="?";if(a)for(var f in a)a.hasOwnProperty(f)&&(e+=f+"="+encodeURIComponent(a[f])+"&");e+="username="+encodeURIComponent(this.user)+"&password="+encodeURIComponent(this.password);a={host:"my.tado.com",path:e,method:"GET",headers:{Connection:"close",
"Content-Type":'application/json; charset="UTF-8"'}};this._logger.log("trace","send https request to:"+e);var d=this,k=require("https").request(a,function(f){f.setEncoding("utf-8");var a="";f.on("data",function(b){a+=b});f.on("end",function(){d._logger.log("trace","receive https response code:"+f.statusCode+" body:"+a);if(200==f.statusCode){var k=null;try{k=JSON.parse(a),b&&(b(null,k),b=null)}catch(e){b&&(b(Error("https response invalid json")),b=null)}}else b&&(b(Error("https response code:"+f.statusCode),
a),b=null)})});k.on("error",function(f){d._logger.log("trace","send https request err:"+f.message);b&&(b(f),b=null)});k.setTimeout(2E3,function(){d._logger.log("trace","send https request timeout");k.abort();b&&(b(Error("https request timeout")),b=null)});k.end()};c.prototype.executeCommand=function(e,a){var b=!0,f=null,d=null,k=this;if("auto"==e)f="/mobile/1.9/updateThermostatSettings",d={setMode:"AUTO"};else if("up"==e||"down"==e)this.getState(function(b,f){if(b)a&&a(b);else if(f&&f.mode&&f.temp){var c=
parseFloat(f.temp),c="up"==e?c+.5:c-.5;5>c?c=5:25<c&&(c=25);c=c.toFixed(1);d={setMode:"MANUAL",manualTemp:c};k._doRequest("/mobile/1.9/updateThermostatSettings",d,function(b){a&&a(b)})}else a&&a(b,f)}),b=!1;else if(0==e.indexOf("setTo")){e=e.replace(/setTo/g,"");e=e.replace(/%/g,"");var c=parseFloat(e);5>c?c=5:25<c&&(c=25);c=c.toFixed(1);f="/mobile/1.9/updateThermostatSettings";d={setMode:"MANUAL",manualTemp:c}}f?this._doRequest(f,d,function(b){a&&a(b)}):b&&a&&a()};c.prototype.getState=function(c){var a=
{},b=this;this._doRequest("/mobile/1.9/getCurrentState",null,function(f,d){f?c(f):(d&&(a.heatingOn=d.heatingOn,a.temp=parseFloat(d.setPointTemp).toFixed(1),a.insideTemp=parseFloat(d.insideTemp).toFixed(1),a.mode=d.operation),d.homeId?b._doRequest("/api/v1/home/"+d.homeId+"/hvacState",null,function(b,f){f&&f.humidity&&(a.humidity=f.humidity.percentage);c&&c(b,a)}):c&&c(f,a))})};c.prototype.getStateValues=function(c,a){return a};c.prototype.toJSON=function(){return{sys:xnm.aio.tado.DM.SYS,username:this.user,
password:this.password}};c.prototype.equalsTo=function(e){return e&&e instanceof c?this.user==e.user&&this.password==e.password:!1};c.parseJSON=function(e){return e.username&&e.password?new c(e.username,e.password):null};return c}();
xnm.aio.tado.BridgeV2=function(){var c={},e=function(b,f){var d={temp:20,type:"MANUAL",durationInSeconds:60};return c[b+"_"+f]=d},a=function(b,f){this._logger=require("x.logger.js").getLogger("xnm.aio.tado.BridgeV2");this.user=b;this.password=f;this._zoneStateCBS={}};a.prototype.getZones=function(b){var f=this;this._getMe(function(d,a){if(d)b&&b(d);else{var c=[],e=a.homes,g=0,h=function(d,a){if(!d&&a)for(var k=e[g].id,q=0;q<a.length;q++){var r=a[q];c.push({name:r.name,type:"zone",homeID:k,zoneID:r.id})}g++;
g<e.length?f._getZones(e[g].id,h):b&&b(null,c)};f._getZones(e[g].id,h)}})};a.prototype.executeCommandCreator=function(b,f,d){f&&f.value?b&&"thermo"==b.type?(new xnm.aio.tado.Bridge(this.user,this.password)).executeCommandCreator(b,f,d):this.executeCommand(b,f,function(b){d&&d(b)}):d&&d(Error("command format invalid"))};a.prototype.getStatesCreator=function(b,f,d){if(f){for(var a=[],c=[],e=[],g=0;g<f.length;g++){var h=f[g];h&&h.device&&"thermo"==h.device.type&&e.push(h);h.device&&h.device.homeID&&
h.device.zoneID&&-1==a.indexOf(h.device.homeID+"_"+h.device.zoneID)&&c.push(h.device)}var p=1,n=[];0<e.length&&(p=2,(new xnm.aio.tado.Bridge(this.user,this.password)).getStatesCreator(b,e,function(b,f){p--;!b&&f&&(n=n.concat(f));0==p&&d&&d(null,n)}));this.getState(c,function(b,a){for(var k=0;k<f.length;k++){var c=f[k];if(c&&c.id){var e="?";if(!b&&a&&c.device&&c.device.homeID&&c.device.zoneID){var g=a[c.device.homeID+"_"+c.device.zoneID];g&&c.status&&c.status.value&&(g=g[c.status.value],null!=g&&"undefined"!=
typeof g&&(e=g))}n.push({id:c.id,status:e})}}p--;0==p&&d&&d(null,n)})}else d&&d(Error("deviceList is null"))};a.prototype.executeCommand=function(b,f,d){if(b&&"zone"==b.type&&b.homeID&&b.zoneID)if(f&&f.value){var a="GET",m="/api/v2/homes/"+b.homeID+"/zones/"+b.zoneID+"/overlay",l=null,g;switch(f.value){case "auto":a="DELETE";break;case "off":g=b.homeID+"_"+b.zoneID;(g=c[g])||(g=e(b.homeID,b.zoneID));a="PUT";l={setting:{type:"HEATING",power:"OFF"},termination:{type:g.type}};"TIMER"==g.type&&(l.termination.durationInSeconds=
g.durationInSeconds);break;case "start":g=b.homeID+"_"+b.zoneID;(g=c[g])||(g=e(b.homeID,b.zoneID));a="PUT";l={setting:{type:"HEATING",power:"ON",temperature:{celsius:g.temp}},termination:{type:g.type}};"TIMER"==g.type&&(l.termination.durationInSeconds=g.durationInSeconds);break;case "setManuEndMode":switch(f.ext){case "MANUAL":case "TIMER":case "TADO_MODE":g=b.homeID+"_"+b.zoneID;(g=c[g])||(g=e(b.homeID,b.zoneID));g.type=f.ext;d&&d();break;default:d&&d(Error("setManuEndMode ext invalid"))}return;
case "setManuEndTimer":if(!f.ext){d&&d(Error("setManuEndTimer ext invalid"));return}f=parseInt(f.ext);isNaN(f)&&(f=1);1>f&&(f=1);g=b.homeID+"_"+b.zoneID;(g=c[g])||(g=e(b.homeID,b.zoneID));g.durationInSeconds=60*f;d&&d();return;case "setTo":if(!f.ext){d&&d(Error("setTo ext invalid"));return}var h=parseFloat(f.ext);5>h?h=5:25<h&&(h=25);h=h.toFixed(1);h=parseFloat(h);g=b.homeID+"_"+b.zoneID;(g=c[g])||(g=e(b.homeID,b.zoneID));g.temp=h;d&&d();break;case "up":case "down":a=parseFloat(f.ext);if(!a||isNaN(a))a=
1;g=b.homeID+"_"+b.zoneID;(g=c[g])||(g=e(b.homeID,b.zoneID));h=g.temp;h="up"==f.value?h+a:h-a;5>h?h=5:25<h&&(h=25);h=h.toFixed(1);h=parseFloat(h);g.temp=h;d&&d();return;default:d&&d(Error("unknown command"));return}this._doRequest(a,m,JSON.stringify(l),function(b){d&&d(b)})}else d&&d(Error("command json invalid"));else d&&d(Error("device json invalid"))};a.prototype.getState=function(b,f){for(var d={},a=b.length,c=a,e=function(){a--;0==a&&f&&f(null,d)};c--;){var g=b[c];g&&g.homeID&&g.zoneID?this.getZoneState(g.homeID,
g.zoneID,function(b,f,a,c){!b&&f&&(d[a+"_"+c]=f);e()}):e()}};a.prototype.getZoneState=function(b,f,a){var c=b+"_"+f,e=this._zoneStateCBS[c];e||(e=[],this._zoneStateCBS[c]=e);var l=e.length;a||(a=function(){});-1==e.indexOf(a)&&e.push(a);if(0==l){var g=this;this._getZoneState(b,f,function(a,d){delete g._zoneStateCBS[c];var n=e.length;if(a)for(;n--;)e[n]&&e[n](a);else{var l=g._resolveZoneState(d),n=g._getZoneManuTermination(b,f);l||(l={});l.setManutemp=n.setManutemp;l.setManuEndMode=n.setManuEndMode;
l.setManuEndTimer=n.setManuEndTimer;for(n=e.length;n--;)e[n]&&e[n](null,l,b,f)}})}};a.prototype._getZoneManuTermination=function(b,f){var a=c[b+"_"+f];a||(a=e(b,f));var k={};k.setManutemp=a.temp;k.setManuEndMode=a.type;k.setManuEndTimer=a.durationInSeconds;k.setManuEndTimer&&(k.setManuEndTimer/=60);return k};a.prototype._resolveZoneState=function(b){var a={manuEndTimer:0,manuEndTimerRemainS:0,manuEndTimerRemain:0,manuEndTimerRemainTxt:"",manuEndAutoExpire:null};b.tadoMode&&(a.mode=b.tadoMode);b.overlayType&&
(a.mode=b.overlayType);var d=b.setting;if(d){var c=d.temperature;c&&"undefined"!=typeof c.celsius&&null!=c.celsius&&(a.temp=c.celsius);d.power&&(a.power=d.power,"OFF"==d.power&&(a.temp=0,a.mode="FROZEN_PROTECTION"))}(d=b.activityDataPoints)&&(d=d.heatingPower)&&"undefined"!=typeof d.percentage&&null!=d.percentage&&(a.heatingPower=d.percentage);if(d=b.sensorDataPoints)(c=d.insideTemperature)&&"undefined"!=typeof c.celsius&&null!=c.celsius&&(a.insideTemp=c.celsius),(d=d.humidity)&&"undefined"!=typeof d.percentage&&
null!=d.percentage&&(a.humidity=d.percentage);if(b=b.overlay){if(d=b.setting)(c=d.temperature)&&"undefined"!=typeof c.celsius&&null!=c.celsius&&(a.temp=c.celsius),d.power&&(a.power=d.power,"OFF"==d.power&&(a.temp=0,a.mode="FROZEN_PROTECTION"));if(c=b.termination)c.type&&(a.manuEndMode=c.type),"TIMER"==c.type?(a.manuEndTimer=Math.round(c.durationInSeconds/60),a.manuEndTimerRemainS=c.remainingTimeInSeconds,a.manuEndTimerRemain=Math.round(c.remainingTimeInSeconds/60),b=Math.floor(c.remainingTimeInSeconds/
3600),d=Math.floor(c.remainingTimeInSeconds%3600/60),c=c.remainingTimeInSeconds%60,b=""+b,2>b.length&&(b="0"+b),d=""+d,2>d.length&&(d="0"+d),c=""+c,2>c.length&&(c="0"+c),a.manuEndTimerRemainTxt=b+":"+d+":"+c,a.manuEndAutoExpire=null):"TADO_MODE"==c.type?(a.manuEndTimer=0,a.manuEndTimerRemainS=0,a.manuEndTimerRemain=0,a.manuEndTimerRemainTxt="",a.manuEndAutoExpire=(new Date(c.projectedExpiry)).toTimeString()):(a.manuEndTimer=0,a.manuEndTimerRemainS=0,a.manuEndTimerRemain=0,a.manuEndTimerRemainTxt=
"",a.manuEndAutoExpire=null)}return a};a.prototype._getMe=function(b){this._doRequest("GET","/api/v2/me",null,function(a,c){b&&b(a,c)})};a.prototype._getZones=function(b,a){this._doRequest("GET","/api/v2/homes/"+b+"/zones",null,function(b,c){a&&a(b,c)})};a.prototype._getZoneState=function(b,a,c){this._doRequest("GET","/api/v2/homes/"+b+"/zones/"+a+"/state",null,function(b,a){c&&c(b,a)})};a.prototype._doRequest=function(b,a,c,e){a+="?username="+encodeURIComponent(this.user)+"&password="+encodeURIComponent(this.password);
b={host:"my.tado.com",path:a,method:b,headers:{Connection:"close","Content-Type":'application/json; charset="UTF-8"'}};this._logger.log("trace","do https request:"+JSON.stringify(b));c&&this._logger.log("trace","https body:"+c);var m=this,l=require("https").request(b,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){m._logger.log("trace","receive https response code:"+a.statusCode+" body:"+b);if(200==a.statusCode||204==a.statusCode){var c=null;try{c=
JSON.parse(b),e&&(e(null,c),e=null)}catch(d){e&&(e(Error("https response invalid json")),e=null)}}else e&&(e(Error("https response code:"+a.statusCode),b),e=null)})});l.on("error",function(a){m._logger.log("trace","send https request err:"+a.message);e&&(e(a),e=null)});l.setTimeout(2E3,function(){m._logger.log("trace","send https request timeout");l.abort();e&&(e(Error("https request timeout")),e=null)});c&&l.write(c);l.end()};a.prototype.toJSON=function(){return{sys:xnm.aio.tado.DM.SYS,username:this.user,
password:this.password}};a.prototype.equalsTo=function(b){return b&&b instanceof a?this.user==b.user&&this.password==b.password:!1};a.parseJSON=function(b){return b.username&&b.password?new a(b.username,b.password):null};return a}();
xnm.aio.tado.DM=function(){var c=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};c.prototype=Error();c.prototype.name="TadoDMError";c.prototype.code=0;c.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var e={thermo:{command:[{type:"enum",name:"auto",ref:{value:"auto"}},{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"float",name:"manu",ref:{value:"setTo",ext:"%f",extMeta:"5.0-25.0",scale:"0.1"}}],
status:[{type:"enum",name:"mode",ref:{value:"mode",options:["HOME","SLEEP","AWAY","MANUAL","NO_FREEZE"]}},{type:"float",name:"set temperature",ref:{value:"temp",extMeta:"5.0-25.0",scale:"0.1"}},{type:"float",name:"current temperature",ref:{value:"insideTemp"}},{type:"int",name:"humidity",ref:{value:"humidity"}}]},zone:{command:[{type:"enum",name:"auto",ref:{value:"auto"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"start",ref:{value:"start"}},{type:"float",name:"set manu temperature",
ref:{value:"setTo",ext:"%f",extMeta:"5.0-25.0",scale:"0.1"}},{type:"enum",name:"set manu termination mode",ref:{value:"setManuEndMode",ext:"%e",extMeta:["MANUAL","TIMER","TADO_MODE"]}},{type:"int",name:"set manu termination timer",ref:{value:"setManuEndTimer",ext:"%d",extMeta:"1-720",unit:"min"}},{type:"float",name:"up",ref:{value:"up",ext:"%f",extMeta:"0.1-5.0",scale:"0.1"}},{type:"float",name:"down",ref:{value:"down",ext:"%f",extMeta:"0.1-5.0",scale:"0.1"}}],status:[{type:"enum",name:"mode",ref:{value:"mode",
options:"HOME SLEEP AWAY MANUAL NO_FREEZE FROZEN_PROTECTION".split(" ")}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"float",name:"current temperature",ref:{value:"insideTemp"}},{type:"int",name:"humidity",ref:{value:"humidity"}},{type:"int",name:"heating power",ref:{value:"heatingPower"}},{type:"float",name:"set temperature",ref:{value:"temp",extMeta:"5.0-25.0",scale:"0.1"}},{type:"enum",name:"current manu termination mode",ref:{value:"manuEndMode",ext:"%e",options:["MANUAL",
"TIMER","TADO_MODE"]}},{type:"int",name:"current manu termination timer",ref:{value:"manuEndTimer",ext:"%d",extMeta:"1-720",unit:"min"}},{type:"string",name:"current manu termination auto expire time",ref:{value:"manuEndAutoExpire",ext:"%s"}},{type:"int",name:"current manu termination timer remain (min)",ref:{value:"manuEndTimerRemain",unit:"min"}},{type:"int",name:"current manu termination timer remain (s)",ref:{value:"manuEndTimerRemainS",unit:"s"}},{type:"string",name:"current manu termination timer remain (text)",
ref:{value:"manuEndTimerRemainTxt"}},{type:"float",name:"set manu temperature",ref:{value:"setManutemp",extMeta:"5.0-25.0",scale:"0.1"}},{type:"enum",name:"set manu termination mode",ref:{value:"setManuEndMode",ext:"%e",options:["MANUAL","TIMER","TADO_MODE"]}},{type:"int",name:"set manu termination timer",ref:{value:"setManuEndTimer",ext:"%d",extMeta:"1-720",unit:"min"}}]}};return{SYS:"tado",getGatewayType:function(){return[{sys:this.SYS,name:"tado\u00b0"}]},getGatewayDeviceType:function(a,b){return[{type:"thermo",
name:"Smart Thermostat",sys:this.SYS}]},createGateway:function(a,b,f){b=c.ERROR_CODE;a?a.username?a.password?f(null,a):f(new c(b.INVALID,"password is invalid")):f(new c(b.INVALID,"username is invalid")):f(new c(b.INVALID,"info is invalid"))},updateGateway:function(a,b,f,d){a=c.ERROR_CODE;b?b.username?b.password?d(null,b):d(new c(a.INVALID,"password is invalid")):d(new c(a.INVALID,"username is invalid")):d(new c(a.INVALID,"info is invalid"))},deleteGateway:function(a,b,c){c()},createDevice:function(a,
b,f){var d=c.ERROR_CODE;if(a)if(a.gateway)if(a.type)if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var e,m;for(e=0;e<b.length;e++)if(b[e].index===a.gateway){m=b[e];break}m?f(null,a):f(new c(d.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else f(new c(d.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else f(new c(d.INVALID,"type is invalid"));else f(new c(d.INVALID,"gateway is invalid"));else f(new c(d.INVALID,"info is invalid"))},updateDevice:function(a,
b,e){var d=c.ERROR_CODE;if(a)if(a.gateway)if(a.type)if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var k,m;for(k=0;k<b.length;k++)if(b[k].index===a.gateway){m=b[k];break}m?e(null,a):e(new c(d.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else e(new c(d.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else e(new c(d.INVALID,"type is invalid"));else e(new c(d.INVALID,"gateway is invalid"));else e(new c(d.INVALID,"info is invalid"))},deleteDevice:function(a,
b,c){c()},applyUIFilter:function(a,b,c){var e=this,k=function(a,b,c){var e=[];a.forEach(function(a){if("root"==a.type){a=JSON.parse(JSON.stringify(a));var d=k(a.children,b,c);d&&0<d.length&&(a.children=d,e.push(a))}else{d=c.elems;if("*"==d)d=!0;else{for(var f=!1,g=0;g<d.length;g++)if(d[g]==a.type){f=!0;break}d=f}d&&(a=JSON.parse(JSON.stringify(a)),e.push(a))}});return e},m=function(a,b){var g=[],l=e.getCommandStatusMap(a,c);if(l){var m=[];switch(b.catagory){case "command":l.command&&(m=k(l.command,
a,b));break;case "status":l.status&&(m=k(l.status,a,b))}g=g.concat(m)}return g};if(!a.sys)return null;var l=JSON.parse(JSON.stringify(a)),g=null;switch(b.catagory){case "command":g=m(a,b);l.command=g;break;case "status":g=m(a,b);l.status=g;break;default:return null}return g&&0!=g.length?l:null},getCommandStatusMap:function(a){return a&&a.type?e[a.type]:null}}}();
xnm.aio.tado.Handler=function(){var c=function(){};c.prototype.Bridge=xnm.aio.tado.Bridge;c.prototype.BridgeV2=xnm.aio.tado.BridgeV2;c.prototype.devicemanager=xnm.aio.tado.DM;c.prototype.registModule=function(c){c.register(this.devicemanager.SYS,"tado")};c.prototype.resolveGateway=function(c){return c?this.BridgeV2.parseJSON(c):null};c.prototype.getDeviceCommands=function(c,a){var b=this.devicemanager.applyUIFilter(c,{catagory:"command",elems:"*"}),b=b?b.command:[];a&&a(null,b)};c.prototype.getDeviceStatus=
function(c,a){var b=this.devicemanager.applyUIFilter(c,{catagory:"status",elems:"*"}),b=b?b.status:[];a&&a(null,b)};c.prototype.doCommand=function(c,a,b,f){(c=this.resolveGateway(c))?c.executeCommandCreator(a,b,function(a){f&&f(a)}):f&&f(Error("gateway json format invalid"))};c.prototype.doStatus=function(c,a,b,f,d){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:c,device:b,status:f}],function(a,b){a?d&&d(a):d&&d(null,b[0])}):d&&d(Error("gateway json format invalid"))};c.prototype.getDeviceList=
function(c,a){var b=this.resolveGateway(c);b?b.getZones(function(b,c){a&&a(b,c)}):a&&a(Error("gateway json format invalid"))};c.prototype.getStateValues=function(c,a){};c.prototype.getDeviceCommandList=function(c,a,b){c=[];a&&(c.push({id:window.XC_Text.on,cmd:"on"}),c.push({id:window.XC_Text.off,cmd:"off"}));return c};return c}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.tado.Handler);
