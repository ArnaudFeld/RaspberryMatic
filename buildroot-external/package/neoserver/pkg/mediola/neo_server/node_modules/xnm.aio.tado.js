var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.tado=xnm.aio.tado||{};
xnm.aio.tado.Bridge=function(){var d=function(c,b){this._logger=require("x.logger.js").getLogger("xnm.aio.tado.Bridge");this.user=c;this.password=b};d.prototype.executeCommandCreator=function(c,b,a){if(b&&b.value){c=b.value;if("setTo"==b.value){if(null==b.ext||"undefined"==typeof b.ext){a&&a(Error("command ext format invalid"));return}c=b.value+b.ext}this.executeCommand(c,function(f){a&&a(f)})}else a&&a(Error("command format invalid"))};d.prototype.getStatesCreator=function(c,b,a){b?this.getState(function(f,
e){f=[];for(var k=0;k<b.length;k++){var c=b[k],d="?";if(c.id&&c.status&&c.status.value&&e){var g=e[c.status.value];null!=g&&"undefined"!=typeof g&&(d=g)}f.push({id:c.id,status:d})}a&&a(null,f)}):a&&a(Error("deviceList is null"))};d.prototype._doRequest=function(c,b,a){c+="?";if(b)for(var f in b)b.hasOwnProperty(f)&&(c+=f+"="+encodeURIComponent(b[f])+"&");c+="username="+encodeURIComponent(this.user)+"&password="+encodeURIComponent(this.password);b={host:"my.tado.com",path:c,method:"GET",headers:{Connection:"close",
"Content-Type":'application/json; charset="UTF-8"'}};this._logger.log("trace","send https request to:"+c);var e=this,k=require("https").request(b,function(f){f.setEncoding("utf-8");var b="";f.on("data",function(a){b+=a});f.on("end",function(){e._logger.log("trace","receive https response code:"+f.statusCode+" body:"+b);if(200==f.statusCode){var k=null;try{k=JSON.parse(b),a&&(a(null,k),a=null)}catch(h){a&&(a(Error("https response invalid json")),a=null)}}else a&&(a(Error("https response code:"+f.statusCode),
b),a=null)})});k.on("error",function(f){e._logger.log("trace","send https request err:"+f.message);a&&(a(f),a=null)});k.setTimeout(2E3,function(){e._logger.log("trace","send https request timeout");k.abort();a&&(a(Error("https request timeout")),a=null)});k.end()};d.prototype.executeCommand=function(c,b){var a=!0,f=null,e=null,k=this;if("auto"==c)f="/mobile/1.9/updateThermostatSettings",e={setMode:"AUTO"};else if("up"==c||"down"==c)this.getState(function(a,f){a?b&&b(a):f&&f.mode&&f.temp?(a=parseFloat(f.temp),
a="up"==c?a+.5:a-.5,5>a?a=5:25<a&&(a=25),a=a.toFixed(1),e={setMode:"MANUAL",manualTemp:a},k._doRequest("/mobile/1.9/updateThermostatSettings",e,function(a){b&&b(a)})):b&&b(a,f)}),a=!1;else if(0==c.indexOf("setTo")){c=c.replace(/setTo/g,"");c=c.replace(/%/g,"");var d=parseFloat(c);5>d?d=5:25<d&&(d=25);d=d.toFixed(1);f="/mobile/1.9/updateThermostatSettings";e={setMode:"MANUAL",manualTemp:d}}f?this._doRequest(f,e,function(a){b&&b(a)}):a&&b&&b()};d.prototype.getState=function(c){var b={},a=this;this._doRequest("/mobile/1.9/getCurrentState",
null,function(f,e){f?c(f):(e&&(b.heatingOn=e.heatingOn,b.temp=parseFloat(e.setPointTemp).toFixed(1),b.insideTemp=parseFloat(e.insideTemp).toFixed(1),b.mode=e.operation),e.homeId?a._doRequest("/api/v1/home/"+e.homeId+"/hvacState",null,function(a,f){f&&f.humidity&&(b.humidity=f.humidity.percentage);c&&c(a,b)}):c&&c(f,b))})};d.prototype.getStateValues=function(c,b){return b};d.prototype.toJSON=function(){return{sys:xnm.aio.tado.DM.SYS,username:this.user,password:this.password}};d.prototype.equalsTo=
function(c){return c&&c instanceof d?this.user==c.user&&this.password==c.password:!1};d.parseJSON=function(c){return c.username&&c.password?new d(c.username,c.password):null};return d}();
xnm.aio.tado.BridgeV2=function(){var d={},c=function(a,f){var e={temp:20,type:"MANUAL",durationInSeconds:60};return d[a+"_"+f]=e},b=function(a,f){this._logger=require("x.logger.js").getLogger("xnm.aio.tado.BridgeV2");this.user=a;this.password=f;this._zoneStateCBS={}};b.prototype.getZones=function(a){var f=this;this._getMe(function(e,b){if(e)a&&a(e);else{var k=[],c=b.homes,g=0,d=function(e,b){if(!e&&b){e=c[g].id;for(var h=0;h<b.length;h++){var m=b[h];k.push({name:m.name,type:"zone",homeID:e,zoneID:m.id})}}g++;
g<c.length?f._getZones(c[g].id,d):a&&a(null,k)};f._getZones(c[g].id,d)}})};b.prototype.executeCommandCreator=function(a,f,e){f&&f.value?a&&"thermo"==a.type?(new xnm.aio.tado.Bridge(this.user,this.password)).executeCommandCreator(a,f,e):this.executeCommand(a,f,function(a){e&&e(a)}):e&&e(Error("command format invalid"))};b.prototype.getStatesCreator=function(a,f,e){if(f){for(var b=[],c=[],d=[],g=0;g<f.length;g++){var h=f[g];h&&h.device&&"thermo"==h.device.type&&d.push(h);h.device&&h.device.homeID&&
h.device.zoneID&&-1==b.indexOf(h.device.homeID+"_"+h.device.zoneID)&&c.push(h.device)}var p=1,n=[];0<d.length&&(p=2,(new xnm.aio.tado.Bridge(this.user,this.password)).getStatesCreator(a,d,function(a,f){p--;!a&&f&&(n=n.concat(f));0==p&&e&&e(null,n)}));this.getState(c,function(a,b){for(var k=0;k<f.length;k++){var c=f[k];if(c&&c.id){var d="?";if(!a&&b&&c.device&&c.device.homeID&&c.device.zoneID){var g=b[c.device.homeID+"_"+c.device.zoneID];g&&c.status&&c.status.value&&(g=g[c.status.value],null!=g&&"undefined"!=
typeof g&&(d=g))}n.push({id:c.id,status:d})}}p--;0==p&&e&&e(null,n)})}else e&&e(Error("deviceList is null"))};b.prototype.executeCommand=function(a,f,e){if(a&&"zone"==a.type&&a.homeID&&a.zoneID)if(f&&f.value){var b="GET",m="/api/v2/homes/"+a.homeID+"/zones/"+a.zoneID+"/overlay",l=null;switch(f.value){case "auto":b="DELETE";break;case "off":var g=a.homeID+"_"+a.zoneID;(g=d[g])||c(a.homeID,a.zoneID);b="PUT";l={setting:{type:"HEATING",power:"OFF"},termination:{type:g.type}};"TIMER"==g.type&&(l.termination.durationInSeconds=
g.durationInSeconds);break;case "start":g=a.homeID+"_"+a.zoneID;(g=d[g])||(g=c(a.homeID,a.zoneID));b="PUT";l={setting:{type:"HEATING",power:"ON",temperature:{celsius:g.temp}},termination:{type:g.type}};"TIMER"==g.type&&(l.termination.durationInSeconds=g.durationInSeconds);break;case "setManuEndMode":switch(f.ext){case "MANUAL":case "TIMER":case "TADO_MODE":g=a.homeID+"_"+a.zoneID;(g=d[g])||(g=c(a.homeID,a.zoneID));g.type=f.ext;e&&e();break;default:e&&e(Error("setManuEndMode ext invalid"))}return;
case "setManuEndTimer":if(!f.ext){e&&e(Error("setManuEndTimer ext invalid"));return}f=parseInt(f.ext);isNaN(f)&&(f=1);1>f&&(f=1);g=a.homeID+"_"+a.zoneID;(g=d[g])||(g=c(a.homeID,a.zoneID));g.durationInSeconds=60*f;e&&e();return;case "setTo":if(!f.ext){e&&e(Error("setTo ext invalid"));return}var h=parseFloat(f.ext);5>h?h=5:25<h&&(h=25);h=h.toFixed(1);h=parseFloat(h);g=a.homeID+"_"+a.zoneID;(g=d[g])||(g=c(a.homeID,a.zoneID));g.temp=h;e&&e();break;case "up":case "down":b=parseFloat(f.ext);if(!b||isNaN(b))b=
1;g=a.homeID+"_"+a.zoneID;(g=d[g])||(g=c(a.homeID,a.zoneID));h=g.temp;h="up"==f.value?h+b:h-b;5>h?h=5:25<h&&(h=25);h=h.toFixed(1);h=parseFloat(h);g.temp=h;e&&e();return;default:e&&e(Error("unknown command"));return}this._doRequest(b,m,JSON.stringify(l),function(a){e&&e(a)})}else e&&e(Error("command json invalid"));else e&&e(Error("device json invalid"))};b.prototype.getState=function(a,f){for(var e={},b=a.length,c=b,d=function(){b--;0==b&&f&&f(null,e)};c--;){var g=a[c];g&&g.homeID&&g.zoneID?this.getZoneState(g.homeID,
g.zoneID,function(a,f,b,c){!a&&f&&(e[b+"_"+c]=f);d()}):d()}};b.prototype.getZoneState=function(a,f,b){var e=a+"_"+f,c=this._zoneStateCBS[e];c||(c=[],this._zoneStateCBS[e]=c);var d=c.length;b||(b=function(){});-1==c.indexOf(b)&&c.push(b);if(0==d){var g=this;this._getZoneState(a,f,function(b,k){delete g._zoneStateCBS[e];var d=c.length;if(b)for(;d--;)c[d]&&c[d](b);else for(b=g._resolveZoneState(k),d=g._getZoneManuTermination(a,f),b||(b={}),b.setManutemp=d.setManutemp,b.setManuEndMode=d.setManuEndMode,
b.setManuEndTimer=d.setManuEndTimer,d=c.length;d--;)c[d]&&c[d](null,b,a,f)})}};b.prototype._getZoneManuTermination=function(a,b){var f=d[a+"_"+b];f||(f=c(a,b));a={};a.setManutemp=f.temp;a.setManuEndMode=f.type;a.setManuEndTimer=f.durationInSeconds;a.setManuEndTimer&&(a.setManuEndTimer/=60);return a};b.prototype._resolveZoneState=function(a){var b={manuEndTimer:0,manuEndTimerRemainS:0,manuEndTimerRemain:0,manuEndTimerRemainTxt:"",manuEndAutoExpire:null};a.tadoMode&&(b.mode=a.tadoMode);a.overlayType&&
(b.mode=a.overlayType);var e=a.setting;if(e){var c=e.temperature;c&&"undefined"!=typeof c.celsius&&null!=c.celsius&&(b.temp=c.celsius);e.power&&(b.power=e.power,"OFF"==e.power&&(b.temp=0,b.mode="FROZEN_PROTECTION"))}(e=a.activityDataPoints)&&(e=e.heatingPower)&&"undefined"!=typeof e.percentage&&null!=e.percentage&&(b.heatingPower=e.percentage);if(e=a.sensorDataPoints)(c=e.insideTemperature)&&"undefined"!=typeof c.celsius&&null!=c.celsius&&(b.insideTemp=c.celsius),(e=e.humidity)&&"undefined"!=typeof e.percentage&&
null!=e.percentage&&(b.humidity=e.percentage);if(a=a.overlay){if(e=a.setting)(c=e.temperature)&&"undefined"!=typeof c.celsius&&null!=c.celsius&&(b.temp=c.celsius),e.power&&(b.power=e.power,"OFF"==e.power&&(b.temp=0,b.mode="FROZEN_PROTECTION"));if(c=a.termination)c.type&&(b.manuEndMode=c.type),"TIMER"==c.type?(b.manuEndTimer=Math.round(c.durationInSeconds/60),b.manuEndTimerRemainS=c.remainingTimeInSeconds,b.manuEndTimerRemain=Math.round(c.remainingTimeInSeconds/60),a=Math.floor(c.remainingTimeInSeconds/
3600),e=Math.floor(c.remainingTimeInSeconds%3600/60),c=c.remainingTimeInSeconds%60,a=""+a,2>a.length&&(a="0"+a),e=""+e,2>e.length&&(e="0"+e),c=""+c,2>c.length&&(c="0"+c),b.manuEndTimerRemainTxt=a+":"+e+":"+c,b.manuEndAutoExpire=null):"TADO_MODE"==c.type?(b.manuEndTimer=0,b.manuEndTimerRemainS=0,b.manuEndTimerRemain=0,b.manuEndTimerRemainTxt="",b.manuEndAutoExpire=(new Date(c.projectedExpiry)).toTimeString()):(b.manuEndTimer=0,b.manuEndTimerRemainS=0,b.manuEndTimerRemain=0,b.manuEndTimerRemainTxt=
"",b.manuEndAutoExpire=null)}return b};b.prototype._getMe=function(a){this._doRequest("GET","/api/v2/me",null,function(b,c){a&&a(b,c)})};b.prototype._getZones=function(a,b){this._doRequest("GET","/api/v2/homes/"+a+"/zones",null,function(a,c){b&&b(a,c)})};b.prototype._getZoneState=function(a,b,c){this._doRequest("GET","/api/v2/homes/"+a+"/zones/"+b+"/state",null,function(a,b){c&&c(a,b)})};b.prototype._doRequest=function(a,b,c,d){b+="?username="+encodeURIComponent(this.user)+"&password="+encodeURIComponent(this.password);
a={host:"my.tado.com",path:b,method:a,headers:{Connection:"close","Content-Type":'application/json; charset="UTF-8"'}};this._logger.log("trace","do https request:"+JSON.stringify(a));c&&this._logger.log("trace","https body:"+c);var e=this,f=require("https").request(a,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){e._logger.log("trace","receive https response code:"+a.statusCode+" body:"+b);if(200==a.statusCode||204==a.statusCode){var c=null;try{c=
JSON.parse(b),d&&(d(null,c),d=null)}catch(n){d&&(d(Error("https response invalid json")),d=null)}}else d&&(d(Error("https response code:"+a.statusCode),b),d=null)})});f.on("error",function(a){e._logger.log("trace","send https request err:"+a.message);d&&(d(a),d=null)});f.setTimeout(2E3,function(){e._logger.log("trace","send https request timeout");f.abort();d&&(d(Error("https request timeout")),d=null)});c&&f.write(c);f.end()};b.prototype.toJSON=function(){return{sys:xnm.aio.tado.DM.SYS,username:this.user,
password:this.password}};b.prototype.equalsTo=function(a){return a&&a instanceof b?this.user==a.user&&this.password==a.password:!1};b.parseJSON=function(a){return a.username&&a.password?new b(a.username,a.password):null};return b}();
xnm.aio.tado.DM=function(){var d=function(b,a){this.code=b;this.message=a;this.stack=Error().stack};d.prototype=Error();d.prototype.name="TadoDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var c={thermo:{command:[{type:"enum",name:"auto",ref:{value:"auto"}},{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"float",name:"manu",ref:{value:"setTo",ext:"%f",extMeta:"5.0-25.0",scale:"0.1"}}],
status:[{type:"enum",name:"mode",ref:{value:"mode",options:["HOME","SLEEP","AWAY","MANUAL","NO_FREEZE"]}},{type:"float",name:"set temperature",ref:{value:"temp",extMeta:"5.0-25.0",scale:"0.1"}},{type:"float",name:"current temperature",ref:{value:"insideTemp"}},{type:"int",name:"humidity",ref:{value:"humidity"}}]},zone:{command:[{type:"enum",name:"auto",ref:{value:"auto"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"start",ref:{value:"start"}},{type:"float",name:"set manu temperature",
ref:{value:"setTo",ext:"%f",extMeta:"5.0-25.0",scale:"0.1"}},{type:"enum",name:"set manu termination mode",ref:{value:"setManuEndMode",ext:"%e",extMeta:["MANUAL","TIMER","TADO_MODE"]}},{type:"int",name:"set manu termination timer",ref:{value:"setManuEndTimer",ext:"%d",extMeta:"1-720",unit:"min"}},{type:"float",name:"up",ref:{value:"up",ext:"%f",extMeta:"0.1-5.0",scale:"0.1"}},{type:"float",name:"down",ref:{value:"down",ext:"%f",extMeta:"0.1-5.0",scale:"0.1"}}],status:[{type:"enum",name:"mode",ref:{value:"mode",
options:"HOME SLEEP AWAY MANUAL NO_FREEZE FROZEN_PROTECTION".split(" ")}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"float",name:"current temperature",ref:{value:"insideTemp"}},{type:"int",name:"humidity",ref:{value:"humidity"}},{type:"int",name:"heating power",ref:{value:"heatingPower"}},{type:"float",name:"set temperature",ref:{value:"temp",extMeta:"5.0-25.0",scale:"0.1"}},{type:"enum",name:"current manu termination mode",ref:{value:"manuEndMode",ext:"%e",options:["MANUAL",
"TIMER","TADO_MODE"]}},{type:"int",name:"current manu termination timer",ref:{value:"manuEndTimer",ext:"%d",extMeta:"1-720",unit:"min"}},{type:"string",name:"current manu termination auto expire time",ref:{value:"manuEndAutoExpire",ext:"%s"}},{type:"int",name:"current manu termination timer remain (min)",ref:{value:"manuEndTimerRemain",unit:"min"}},{type:"int",name:"current manu termination timer remain (s)",ref:{value:"manuEndTimerRemainS",unit:"s"}},{type:"string",name:"current manu termination timer remain (text)",
ref:{value:"manuEndTimerRemainTxt"}},{type:"float",name:"set manu temperature",ref:{value:"setManutemp",extMeta:"5.0-25.0",scale:"0.1"}},{type:"enum",name:"set manu termination mode",ref:{value:"setManuEndMode",ext:"%e",options:["MANUAL","TIMER","TADO_MODE"]}},{type:"int",name:"set manu termination timer",ref:{value:"setManuEndTimer",ext:"%d",extMeta:"1-720",unit:"min"}}]}};return{SYS:"tado",getGatewayType:function(){return[{sys:this.SYS,name:"tado\u00b0"}]},getGatewayDeviceType:function(b,a){return[{type:"thermo",
name:"Smart Thermostat",sys:this.SYS}]},createGateway:function(b,a,c){a=d.ERROR_CODE;b?b.username?b.password?c(null,b):c(new d(a.INVALID,"password is invalid")):c(new d(a.INVALID,"username is invalid")):c(new d(a.INVALID,"info is invalid"))},updateGateway:function(b,a,c,e){b=d.ERROR_CODE;a?a.username?a.password?e(null,a):e(new d(b.INVALID,"password is invalid")):e(new d(b.INVALID,"username is invalid")):e(new d(b.INVALID,"info is invalid"))},deleteGateway:function(b,a,c){c()},createDevice:function(b,
a,c){var e=d.ERROR_CODE;if(b)if(b.gateway)if(b.type)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===b.gateway){var m=a[f];break}m?c(null,b):c(new d(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else c(new d(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));else c(new d(e.INVALID,"type is invalid"));else c(new d(e.INVALID,"gateway is invalid"));else c(new d(e.INVALID,"info is invalid"))},updateDevice:function(b,
a,c){var e=d.ERROR_CODE;if(b)if(b.gateway)if(b.type)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===b.gateway){var m=a[f];break}m?c(null,b):c(new d(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else c(new d(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));else c(new d(e.INVALID,"type is invalid"));else c(new d(e.INVALID,"gateway is invalid"));else c(new d(e.INVALID,"info is invalid"))},deleteDevice:function(b,
a,c){c()},applyUIFilter:function(b,a,c){var e=this,f=function(a,b,c){var e=[];a.forEach(function(a){if("root"==a.type){a=JSON.parse(JSON.stringify(a));var d=f(a.children,b,c);d&&0<d.length&&(a.children=d,e.push(a))}else{d=c.elems;if("*"==d)d=!0;else{for(var g=!1,h=0;h<d.length;h++)if(d[h]==a.type){g=!0;break}d=g}d&&(a=JSON.parse(JSON.stringify(a)),e.push(a))}});return e},d=function(a,b){var d=[],g=e.getCommandStatusMap(a,c);if(g){var h=[];switch(b.catagory){case "command":g.command&&(h=f(g.command,
a,b));break;case "status":g.status&&(h=f(g.status,a,b))}d=d.concat(h)}return d};if(!b.sys)return null;var l=JSON.parse(JSON.stringify(b)),g=null;switch(a.catagory){case "command":g=d(b,a);l.command=g;break;case "status":g=d(b,a);l.status=g;break;default:return null}return g&&0!=g.length?l:null},getCommandStatusMap:function(b){return b&&b.type?c[b.type]:null}}}();
xnm.aio.tado.Handler=function(){var d=function(){};d.prototype.Bridge=xnm.aio.tado.Bridge;d.prototype.BridgeV2=xnm.aio.tado.BridgeV2;d.prototype.devicemanager=xnm.aio.tado.DM;d.prototype.registModule=function(c){c.register(this.devicemanager.SYS,"tado")};d.prototype.resolveGateway=function(c){return c?this.BridgeV2.parseJSON(c):null};d.prototype.getDeviceCommands=function(c,b){c=(c=this.devicemanager.applyUIFilter(c,{catagory:"command",elems:"*"}))?c.command:[];b&&b(null,c)};d.prototype.getDeviceStatus=
function(c,b){c=(c=this.devicemanager.applyUIFilter(c,{catagory:"status",elems:"*"}))?c.status:[];b&&b(null,c)};d.prototype.doCommand=function(c,b,a,d){(c=this.resolveGateway(c))?c.executeCommandCreator(b,a,function(a){d&&d(a)}):d&&d(Error("gateway json format invalid"))};d.prototype.doStatus=function(c,b,a,d,e){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:c,device:a,status:d}],function(a,b){a?e&&e(a):e&&e(null,b[0])}):e&&e(Error("gateway json format invalid"))};d.prototype.getDeviceList=
function(c,b){(c=this.resolveGateway(c))?c.getZones(function(a,c){b&&b(a,c)}):b&&b(Error("gateway json format invalid"))};d.prototype.getStateValues=function(c,b){};d.prototype.getDeviceCommandList=function(c,b,a){c=[];b&&(c.push({id:window.XC_Text.on,cmd:"on"}),c.push({id:window.XC_Text.off,cmd:"off"}));return c};return d}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.tado.Handler);
