var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.tahoma=xnm.aio.tahoma||{};
xnm.aio.tahoma.Box=function(){var d={_cache:{},getCookie:function(a,c){return a||c?this._cache[(a?a:"")+":"+(c?c:"")]:null},setCookie:function(a,c,e){if(!a&&!c)return null;this._cache[(a?a:"")+":"+(c?c:"")]=e}},b=function(a,c,e){this._logger=require("x.logger.js").getLogger("xnm.aio.tahoma.Box");this.username=a;this.password=c};b.prototype.executeCommandCreator=function(a,c,e){this.executeCommand(a,c,function(a){e&&e(a)})};b.prototype.getStatesCreator=function(a,c,e){if(c)if(0==c.length)e&&e(null,
[]);else{for(var b=[],f=0;f<c.length;f++)if(c[f]&&c[f].device&&c[f].device.address&&c[f].status&&c[f].status.value){for(var d=c[f].device.address,h=!1,g=0;g<b.length;g++)if(b[g].address==d){var h=!0,m=b[g].states;-1==m.indexOf(c[f].status.value)&&m.push(c[f].status.value)}h||b.push({address:d,states:[c[f].status.value]})}this.getStates(a,b,function(a,b){var l=[];if(!a&&b)for(var f=0;f<c.length;f++)if(c[f]&&c[f].id){var g="?";if(c[f].device&&c[f].device.address&&c[f].status&&c[f].status.value)for(var d=
0;d<b.length;d++)b[d].address==c[f].device.address&&(g=b[d].states[c[f].status.value]);g||(g="?");l.push({id:c[f].id,status:g})}e&&e(null,l)})}else e&&e(Error("deviceList is null"))};b.prototype.executeCommand=function(a,c,e){if(a&&a.address)if(c&&c.value){var b={actions:[]},f,d={deviceURL:a.address,commands:[]};b.actions.push(d);switch(c.value){case "on":case "off":case "close":case "down":case "my":case "open":case "reset":case "stop":case "up":d.commands.push({name:c.value});break;case "setOnOff":if(!c.ext||
"on"!=c.ext&&"off"!=c.ext){e&&e(Error("command ext invalid"));return}d.commands.push({name:c.value,parameters:[c.ext]});break;case "onWithTimer":if("undefined"==typeof c.ext||null==c.ext){e&&e(Error("command ext invalid"));return}f=parseInt(c.ext);5>f&&(f=5);14400<f&&(f=14400);d.commands.push({name:c.value,parameters:[f]});break;case "setIntensity":if("undefined"==typeof c.ext||null==c.ext){e&&e(Error("command ext invalid"));return}f=parseInt(c.ext);0>f&&(f=0);100<f&&(f=100);d.commands.push({name:c.value,
parameters:[f]});break;default:e&&e(Error("command unknonwn"));return}var h=this;this.getExecutionID(a.address,function(a,f){a?e&&e(a):f?"stop"==c.value||"my"==c.value?h._cancelExecution(f,e):e&&e(Error("device running")):h._apply(b,e)})}else e&&e(Error("command invaild"));else e&&e(Error("device invaild"))};b.prototype.getStates=function(a,c,e){if(c&&0!=c.length){a=[];for(var b=0;b<c.length;b++)if(c[b]&&c[b].address&&c[b].states&&0<c[b].states.length){for(var f={deviceURL:c[b].address,states:[]},
d=0;d<c[b].states.length;d++)f.states.push({name:c[b].states[d]});a.push(f)}this._getStates(a,function(a,c){if(a)e&&e(a);else if(c&&c.devices){for(var b=[],f=0;f<c.devices.length;f++){var d=c.devices[f];if(d&&d.deviceURL&&d.states&&0<d.states.length){for(var l={address:d.deviceURL,states:{}},k=0;k<d.states.length;k++)l.states[d.states[k].name]=d.states[k].value;b.push(l)}}e&&e(null,b)}else e&&e(Error("get states return invalid response"))})}else e&&e(null,[])};b.prototype.listDevices=function(a){this._getSetup(function(c,
e){if(c)a&&a(c);else if(e&&e.setup){var b={places:{},devices:[]};b.places=e.setup.rootPlace;for(var f=e.setup.devices,d=0;d<f.length;d++){var h=f[d];b.devices.push({sys:"tahoma",name:h.label,address:h.deviceURL,placeOID:h.placeOID,type:h.uiClass,definition:h.definition})}a&&a(null,b)}else a&&a(Error("get setup return format invalid"))})};b.prototype.getExecutionID=function(a,c){this._getCurrentExecutions(function(e,b){if(e)c&&c(e);else if(b&&b.executions){for(var f=!1,d=null,h=0;h<b.executions.length;h++){var g=
b.executions[h];if(g&&g.actionGroup&&g.actionGroup.actions){for(var m=g.actionGroup.actions,n=0;n<m.length;n++){var p=m[n];if(p&&p.deviceURL==a){f=!0;break}}if(f){d=g.id;break}}}c&&c(null,d)}else c&&c(null,null)})};b.prototype._cancelExecution=function(a,c){this._doExecRequest("DELETE","/current/setup/"+a,null,function(a){c&&c(a)})};b.prototype._getCurrentExecutions=function(a){this._doJsonRequest("/getCurrentExecutions",null,function(c,e){a&&a(c,e)})};b.prototype._apply=function(a,c){this._doJsonRequest("/apply",
JSON.stringify(a),function(a,b){c&&c(a,b)})};b.prototype._getStates=function(a,c){this._doJsonRequest("/getStates",JSON.stringify(a),function(a,b){c&&c(a,b)})};b.prototype._getSetup=function(a){this._doJsonRequest("/getSetup",null,function(c,e){a&&a(c,e)})};b.prototype._login=function(a){var c="userId="+encodeURIComponent(this.username)+"&userPassword="+encodeURIComponent(this.password),e=this;this._logger.log("debug","do login request with data:"+c);this._doRequest("POST","/externalAPI/json/login",
{"Content-Type":"application/x-www-form-urlencoded"},c,function(c,b,k){if(c)e._logger.log("warn","login failed with error:"+c.message),a&&a(c);else if(k&&200==k.statusCode)try{var h=JSON.parse(b);if(h.success){if(k.headers&&k.headers["set-cookie"]){var g=k.headers["set-cookie"];g.constructor===Array&&(g=g.join(";"));e._logger.log("debug","login success with cookie:"+g);d.setCookie(e.username,e.password,g)}a&&a(null,h)}else e._logger.log("warn","login failed with success not true:"+b),a&&a(Error("login fail"),
h)}catch(m){e._logger.log("warn","login error with invalid json response:"+b),a&&a(Error("login error with invalid json response"))}else e._logger.log("warn","login error with status code:"+(k?k.statusCode:-1)+" data:"+b),a&&a(Error("login error with status code:"+(k?k.statusCode:-1)))})};b.prototype._doJsonRequest=function(a,c,b){var d=this;this._logger.log("debug","do json request "+a+" data:"+JSON.stringify(c));this._doRequest("POST","/externalAPI/json"+a,{"Content-Type":"application/json"},c,
function(f,k,h){if(f)b&&b(f);else if(h&&401==h.statusCode)d._logger.log("warn","do json request return 401, try to login again"),d._login(function(f){f?b&&b(f):d._doJsonRequest(a,c,b)});else if(d._logger.log("debug","do json request return status code "+(h?h.statusCode:-1)),f=!h||200!=h.statusCode&&204!=h.statusCode?Error("http error with status code "+(h?h.statusCode:-1)):null)d._logger.log("warn","do json request return "+h.statusCode+" data:"+k),b&&b(f,k);else try{var g=JSON.parse(k);b&&b(null,
g)}catch(m){d._logger.log("warn","do json request return invalid json: "+k),b&&b(m)}})};b.prototype._doExecRequest=function(a,c,b,d){var f=this;this._logger.log("debug","do exec request "+c+" data:"+JSON.stringify(b));this._doRequest(a,"/enduserAPI/exec"+c,null,b,function(k,h,g){k?d&&d(k):g&&401==g.statusCode?(f._logger.log("warn","do exec request return 401, try to login again"),f._login(function(g){g?d&&d(g):f._doExecRequest(a,c,b,d)})):(f._logger.log("debug","do exec request return status code "+
(g?g.statusCode:-1)),(k=!g||200!=g.statusCode&&204!=g.statusCode?Error("http error with status code "+(g?g.statusCode:-1)):null)?(f._logger.log("warn","do exec request return "+g.statusCode+" data:"+h),d&&d(k,h)):d&&d(null,h))})};b.prototype._doRequest=function(a,c,b,l,f){a={host:"www.tahomalink.com",port:443,path:"/enduser-mobile-web"+c,method:a,headers:{Connection:"close","Content-Type":"application/x-www-form-urlencoded"}};if(b)for(var k in b)b.hasOwnProperty(k)&&(a.headers[k]=b[k]);l&&(a.headers["Content-Length"]=
l.length);(b=d.getCookie(this.username,this.password))&&(a.headers.Cookie=b);b=require("https");"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");this._logger.log("trace","do request:"+JSON.stringify(a));var h=this,g=f,m=b.request(a,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){h._logger.log("trace","receive code:"+a.statusCode+" headers:"+JSON.stringify(a.headers)+" response:"+b);g&&(g(null,b,
a),g=null)})});if(m.on)m.on("error",function(a){h._logger.log("trace","do request error:"+a.message);g&&(g(a),g=null)});m.setTimeout&&m.setTimeout(2E3,function(){h._logger.log("trace","do request timeout");m.abort();g&&(g(Error("timeout")),g=null)});m.setAllowRedirect&&m.setAllowRedirect(!1);l&&(this._logger.log("trace","do request send body:"+l),m.write(l));m.end()};b.prototype.toJSON=function(){return{sys:"tahoma",username:this.username,password:this.password}};b.prototype.equalsTo=function(a){return a&&
a instanceof b?this.username==a.username&&this.password==a.password:!1};return b}();
xnm.aio.tahoma.DM=function(){var d=function(b,a){this.code=b;this.message=a;this.stack=Error().stack};d.prototype=Error();d.prototype.name="TahomaDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"tahoma",getGatewayType:function(){return[{sys:this.SYS,name:"TaHoma Box"}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"Light",name:"Light"},{sys:this.SYS,type:"OnOff",name:"Switch"},{sys:this.SYS,type:"RollerShutter",
name:"Blind"}]},createGateway:function(b,a,c){a=d.ERROR_CODE;b?b.username?b.password?c(null,b):c(new d(a.INVALID,"password is invalid")):c(new d(a.INVALID,"username is invalid")):c(new d(a.INVALID,"info is invalid"))},updateGateway:function(b,a,c,e){b=d.ERROR_CODE;a?a.username?a.password?e(null,a):e(new d(b.INVALID,"password is invalid")):e(new d(b.INVALID,"username is invalid")):e(new d(b.INVALID,"update is invalid"))},deleteGateway:function(b,a,c){c()},createDevice:function(b,a,c){var e=d.ERROR_CODE;
if(b)if(b.gateway)if(b.address)if(b.type)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var l,f;for(l=0;l<a.length;l++)if(a[l].index===b.gateway){f=a[l];break}f?c(null,b):c(new d(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else c(new d(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));else c(new d(e.INVALID,"type is invalid"));else c(new d(e.INVALID,"address is invalid"));else c(new d(e.INVALID,"gateway is invalid"));else c(new d(e.INVALID,"info is invalid"))},
updateDevice:function(b,a,c){var e=d.ERROR_CODE;if(b)if(b.gateway)if(b.address)if(b.type)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var l,f;for(l=0;l<a.length;l++)if(a[l].index===b.gateway){f=a[l];break}f?c(null,b):c(new d(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else c(new d(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));else c(new d(e.INVALID,"type is invalid"));else c(new d(e.INVALID,"address is invalid"));else c(new d(e.INVALID,"gateway is invalid"));
else c(new d(e.INVALID,"info is invalid"))},deleteDevice:function(b,a,c){c()},applyUIFilter:function(b,a){var c=this,d=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},l=function(a,b,c){var f=[];switch(c.catagory){case "command":a.command&&a.command.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),f.push(a))});break;case "status":a.status&&a.status.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),f.push(a))})}return f},
f=function(a,b){var d=[],e=null;if(e=c.getCommandStatusMap(a))e=l(e,a,b),d=d.concat(e);return d};if(!b||null==b.type||"undefined"==typeof b.type)return null;var k=JSON.parse(JSON.stringify(b)),h=null;switch(a.catagory){case "command":h=f(b,a);k.command=h;break;case "status":h=f(b,a);k.status=h;break;default:return null}return h&&0!=h.length?k:null},getCommandStatusMap:function(b){if(!b||!b.definition)return null;var a={command:[],status:[]},c=b.definition.commands;c&&c.forEach(function(b){if(b)switch(b.commandName){case "on":a.command.push({type:"enum",
name:"on",ref:{value:"on"}});break;case "off":a.command.push({type:"enum",name:"off",ref:{value:"off"}});break;case "setOnOff":a.command.push({type:"enum",name:"set on/off",ref:{value:"setOnOff",ext:"%e",extMeta:["on","off"]}});break;case "onWithTimer":a.command.push({type:"int",name:"on for",ref:{value:"onWithTimer",ext:"%d",extMeta:"5-14400"}});break;case "close":a.command.push({type:"enum",name:"close",ref:{value:"close"}});break;case "down":a.command.push({type:"enum",name:"down",ref:{value:"down"}});
break;case "my":a.command.push({type:"enum",name:"my",ref:{value:"my"}});break;case "open":a.command.push({type:"enum",name:"open",ref:{value:"open"}});break;case "reset":a.command.push({type:"enum",name:"reset",ref:{value:"reset"}});break;case "stop":a.command.push({type:"enum",name:"stop",ref:{value:"stop"}});break;case "up":a.command.push({type:"enum",name:"up",ref:{value:"up"}});break;case "setIntensity":a.command.push({type:"int",name:"dim to",ref:{value:"setIntensity",ext:"%d"}})}});(b=b.definition.states)&&
b.forEach(function(b){if(b)switch(b.qualifiedName){case "core:OnOffState":a.status.push({type:"enum",name:"on/off state",ref:{value:"core:OnOffState",options:["on","off"]}});break;case "core:LightIntensityState":a.status.push({type:"int",name:"dimmer level",ref:{value:"core:LightIntensityState",ext:"%d"}})}});return a}}}();xnm.aio.tahoma.Handler=function(){this.detectedHomebases={}};xnm.aio.tahoma.Handler.prototype.Box=xnm.aio.tahoma.Box;xnm.aio.tahoma.Handler.prototype.devicemanager=xnm.aio.tahoma.DM;
xnm.aio.tahoma.Handler.prototype.registModule=function(d){d.register(this.devicemanager.SYS,"tahoma")};xnm.aio.tahoma.Handler.prototype.resolveGateway=function(d){return d&&d.username?new this.Box(d.username,d.password):null};xnm.aio.tahoma.Handler.prototype.getDeviceCommands=function(d,b){var a=this.devicemanager.applyUIFilter(d,{catagory:"command",elems:"*"}),a=a?a.command:[];b&&b(null,a)};
xnm.aio.tahoma.Handler.prototype.getDeviceStatus=function(d,b){var a=this.devicemanager.applyUIFilter(d,{catagory:"status",elems:"*"}),a=a?a.status:[];b&&b(null,a)};xnm.aio.tahoma.Handler.prototype.doCommand=function(d,b,a,c){(d=this.resolveGateway(d))?d.executeCommandCreator(b,a,function(a){c&&c(a)}):c&&c(Error("gateway json format invalid"))};
xnm.aio.tahoma.Handler.prototype.doStatus=function(d,b,a,c,e){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:d,device:a,status:c}],function(a,b){a?e&&e(a):e&&e(null,b[0])}):e&&e(Error("gateway json format invalid"))};xnm.aio.tahoma.Handler.prototype.getDeviceList=function(d,b){var a=this.resolveGateway(d);a?a.listDevices(function(a,d){b&&b(a,d)}):b&&b(Error("gateway json format invalid"))};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.tahoma.Handler);
