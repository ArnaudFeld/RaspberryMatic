var m=m||{};m.aio=m.aio||{};m.aio.voicemanager=m.aio.voicemanager||{};
m.aio.voicemanager.AlexaHandler=function(){var g=function(){this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.Cloud");this._customMap=null};g.LANG=["en","de"];g.MAP={on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],up:["up","up"],down:["down","down"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],dimup:["up","up"],dimdown:["down","down"],dimto:["value","value"],"move up":["up","up"],"move down":["down","down"],"move to":["value","value"],moveup:["up",
"up"],movedown:["down","down"],moveto:["value","value"],stop:["off","off"],brightness:["value","value"],"brightness up":["up","up"],"brightness down":["down","down"],"temperature up":["up","up"],"temperature down":["down","down"],"temperature to":["value","value"],"set temperature":["value","value"],temperature:["value","value"],"mode auto":["auto","auto"],"set auto mode":["auto","auto"],"auto mode":["auto","auto"],auto:["auto","auto"],"mode manu":["manu","manu"],"set manual mode":["manu","manu"],
"manu mode":["manu","manu"],manu:["manu","manu"],"mode boost":["boost","boost"],"set boost mode":["boost","boost"],"boost mode":["boost","boost"],"boost on":["boost","boost"],boost:["boost","boost"],white:["white","wei\u00df"],red:["red","rot"],purple:["purple","violett"],blue:["blue","blau"],cyan:["cyan","cyan"],green:["green","gr\u00fcn"],yellow:["yellow","gelb"],orange:["orange","orange"],mode:["mode","mode"],"power on":["on","on"],"power off":["off","off"],poweron:["on","on"],poweroff:["off",
"off"],volumeup:["up","up"],volumedown:["down","down"],"volume up":["up","up"],"volume down":["down","down"],"volume to":["value","value"]};g.HM_MAP={"short press":["short press","kurz dr\u00fccken"],"long press":["long press","lange dr\u00fccken"],"set value":["value","value"],red:["red","rot"],green:["green","gr\u00fcn"],orange:["orange","orange"],on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],"move up":["up",
"up"],"move down":["down","down"],"step up":["step up","step up"],"step down":["step down","step down"],"move to":["value","value"],stop:["off","off"],open:["open","\u00f6ffnen"],lock:["lock","abschlie\u00dfen"],unlock:["unlock","aufschlie\u00dfen"],"temperature up":["up","up"],"temperature down":["down","down"],"temperature to":["value","value"],"set auto mode":["auto","auto"],"set manual mode":["manu","manu"],"set boost mode":["boost","boost"],"set comfort mode":["comfort","komfort"],"lamella up":["lamella up",
"lamella up"],"lamella down":["lamella down","lamella down"],"lamella to":["lamella to","lamella to"]};g.AIO_MAP={on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],"mode auto":["auto","auto"],"mode manu":["manu","manu"],"mode toggle":["toggle","toggle"],up:["up","up"],down:["down","down"],"up step bit":["step up","step up"],"down step bit":["step down","step down"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],"dim off":["off","off"],Auf:["up","up"],Ab:["down",
"down"],Stop:["off","off"],"move up":["up","up"],"move down":["down","down"],"move in":["up","up"],"move out":["down","down"],"level up":["up","up"],"level down":["down","down"],"start dim":["up","up"],"stop dim":["down","down"],"step up":["step up","step up"],"step down":["step down","step down"],"move to":["value","value"],stop:["off","off"],open:["open","\u00f6ffnen"],close:["close","schlie\u00dfen"],lock:["lock","abschlie\u00dfen"],unlock:["unlock","aufschlie\u00dfen"],"temperature up":["up",
"up"],"temperature down":["down","down"],"set temperature":["value","value"],"temperature to":["value","value"],"set auto mode":["auto","auto"],"auto mode":["auto","auto"],"set manual mode":["manu","manu"],"manu mode":["manu","manu"],"set boost mode":["boost","boost"],"boost mode":["boost","boost"],"boost on":["boost","boost"],"boost off":["boost off","boost aus"],"heater on":["heater on","heizung an"],"heater off":["heater off","heizung aus"],"led on":["led on","led an"],"led off":["led off","led aus"],
"chime on":["chime on","chime an"],"chime off":["chime off","chime aus"],"panic alarm on":["panic on","panic an"],"panic alarm off":["panic off","panic aus"],disarmed:["disarm","entsch\u00e4rfen"],"all armed":["arm","scharf schalten"],"lamella up":["lamella up","lamella hoch"],"lamella down":["lamella down","lamella runter"],"lamella step up":["lamella step up","lamella step up"],"lamella step down":["lamella step down","lamella step down"],"lamella to":["lamella to","lamella to"],lamella:["lamella to",
"lamella to"],"tilt to":["lamella to","lamella to"],"preset position":["position to","position to"],activate:["on","on"],deactivate:["off","off"],A:["off","off"],B:["off","off"],C:["off","off"],"do scene":["do scene","scene starten"],brightness:["value","value"],color:["color","farblich"],white:["white","wei\u00df"],red:["red","rot"],purple:["purple","violett"],blue:["blue","blau"],cyan:["cyan","cyan"],green:["green","gr\u00fcn"],yellow:["yellow","gelb"],orange:["orange","orange"],position:["value",
"value"],"position 1":["position 1","position 1"],"position 2":["position 2","position 2"],"brightness up":["up","up"],"brightness down":["down","down"],"set value":["value","value"]};g.SONOS_MAP={play:["play","play"],pause:["pause","pause"],stop:["off","off"],previous:["previous","previous"],next:["next","next"],"shuffle on":["shuffle on","shuffle on"],"shuffle off":["shuffle off","shuffle off"],"repeat off":["repeat off","repeat off"],"repeat all":["repeat all","repeat all"],"repeat one":["repeat one",
"repeat one"],"group volume":["value","value"],"group volume up":["up","up"],"group volume down":["down","down"],"group mute":["mute","mute"],"group unmute":["unmute","unmute"],volume:["value","value"],"volume up":["up","up"],"volume down":["down","down"],mute:["mute","mute"],unmute:["unmute","unmute"]};g.HUE_MAP={"color temperature":["color temperature","color temperatur"]};g.MILIGHT_MAP={"disco speed up":["faster","schneller"],"disco speed down":["slower","langsamer"],"speed up":["faster","schneller"],
"speed down":["slower","langsamer"],"mode up":["next mode","n\u00e4chste mode"],"mode down":["previous mode","vorherige mode"],"full brightness":["max","max"],"warm white up":["warmer","w\u00e4rmer"],"cool white up":["cooler","k\u00e4lter"],"max brightness":["max","max"],"night mode":["night mode","nacht mode"],"night light on":["night mode","nacht mode"],warmer:["warmer","w\u00e4rmer"],cooler:["cooler","k\u00e4lter"]};g.OSRAM_MAP={"color temperature":["color temperature","color temperatur"],"do scene":["scene",
"szene"]};g.HARMONY_MAP={"power on":["on","on"],"power off":["off","off"],poweron:["on","on"],poweroff:["off","off"],stop:["stop","stop"],volumeup:["up","up"],volumedown:["down","down"],"volume up":["up","up"],"volume down":["down","down"]};g.AV_MAP={stop:["stop","stop"]};g.TADO_MAP={"set manu temperature":["value","value"],manu:["value","value"]};g.NETATMO_MAP={manu:["value","value"]};g.FIBAROHC_MAP={"set value":["value","value"]};g.REMOTE_SERVER="https://cloud.mediola.com";g.prototype._getAccessToken=
function(a,d,b,c){a={host:require("url").parse(g.REMOTE_SERVER).host,port:443,path:"/getAccessToken?sid="+a,method:"GET",timeout:3E4,auth:"user:"+d,user:"user",password:d,headers:{Authorization:"Basic "+(new Buffer("user:"+d)).toString("base64")}};b&&(a.path+="&force=1");this._logger.log("trace","send get access token to:"+JSON.stringify(a));var f=this,h=require("https").request(a,function(a){a.setEncoding("utf8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){if(200==a.statusCode){f._logger.log("trace",
"get access token reponse:"+b);try{var e=JSON.parse(b);e.XC_ERR?c&&c(Error(e.XC_ERR.msg)):e.XC_SUC?c&&c(null,e.XC_SUC.at):c&&c(Error("invalid response"))}catch(d){c&&c(d)}}else f._logger.log("warn","get access token error +"+a.statusCode+":"+b),c&&c(Error("http response:"+a.statusCode))})});if(h.on)h.on("error",function(a){f._logger.log("warn","get access token error:"+a.message);c&&c(a);c=null});h.setTimeout&&h.setTimeout(5E3,function(){h.abort();f._logger.log("warn","get access token timeout");
c&&c(Error("http timeout"));c=null});h.end()};g.prototype._processHMCommands=function(a,d,b){return this._processCommandsFromMap(g.HM_MAP,a,d,b)};g.prototype._processAIOCommands=function(a,d,b){return this._processCommandsFromMap(g.AIO_MAP,a,d,b)};g.prototype._processSonosCommands=function(a,d,b){return this._processCommandsFromMap(g.SONOS_MAP,a,d,b)};g.prototype._processHueCommands=function(a,d,b){return this._processCommandsFromMap(g.HUE_MAP,a,d,b)};g.prototype._processMilightCommands=function(a,
d,b,c){return this._processCommandsFromMap(g.MILIGHT_MAP,a,d,b,c)};g.prototype._processOsramCommands=function(a,d,b){return this._processCommandsFromMap(g.OSRAM_MAP,a,d,b)};g.prototype._processHarmonyCommands=function(a,d,b,c){return this._processCommandsFromMap(g.HARMONY_MAP,a,d,b,c)};g.prototype._processMcontrolCommands=function(a,d,b){if(a&&a.info&&a.info.command){var c=JSON.parse(JSON.stringify(a.info.command));a.info.command=c;a.info.command.push({type:"enum",name:"on",ref:{value:"do",ext:"on"}});
a.info.command.push({type:"enum",name:"off",ref:{value:"do",ext:"off"}});a.info.command.push({type:"enum",name:"up",ref:{value:"do",ext:"up"}});a.info.command.push({type:"enum",name:"down",ref:{value:"do",ext:"down"}});a.info.command.push({type:"int",name:"move to",ref:{value:"setInt",ext:"%d"}})}return this._processCommandsFromMap(null,a,d,b)};g.prototype._processFibaroHCCommands=function(a,d,b){if(b&&"blind"==b.type&&a&&a.info&&a.info.command){for(var c=JSON.parse(JSON.stringify(a.info.command)),
f=0;f<c.length;f++){var h=c[f];switch(h.name){case "open":h.name="up";break;case "close":h.name="down";break;case "up":h.name="step up";break;case "down":h.name="step down";break;case "stop":h.name="off"}}a.info.command=c}return this._processCommandsFromMap(g.FIBAROHC_MAP,a,d,b)};g.prototype._processAVCommands=function(a,d,b,c){return this._processCommandsFromMap(g.AV_MAP,a,d,b,c)};g.prototype._processTadoCommands=function(a,d,b){return this._processCommandsFromMap(g.TADO_MAP,a,d,b)};g.prototype._processNetatmoCommands=
function(a,d,b){return this._processCommandsFromMap(g.NETATMO_MAP,a,d,b)};g.prototype._processCommandsFromMap=function(a,d,b,c,f){b||(b="de");b=b.toLowerCase();for(var h={},r=g.LANG.indexOf(b),l=0;l<d.info.command.length;l++){var e=d.info.command[l];if("string"!=e.type||"aio"==d.info.sys&&"STRING"==d.info.type)if("root"==e.type)this._processRootCommandsFromMap(h,e,a,d,b,c,f);else{var k={type:"POST",url:"/cmd",original:e.name,data:{XC_FNC:"SendRM",device:d.index,command:JSON.parse(JSON.stringify(e.ref))}},
p=e.name.toLowerCase(),q=g.MAP[p]?g.MAP[p][r]:null;(p=a&&a[p]?a[p][r]:null)&&(q=p);var t=null,p=d.info.sys;if(this._customMap&&p&&this._customMap[p])var n=this._customMap[p],t=n[e.name]?n[e.name][r]:null;t&&(q=t);if("%d"==e.ref.ext||"%f"==e.ref.ext||"%s"==e.ref.ext)k.data.command.ext="{val}","%f"==e.ref.ext&&(k["float"]=1),e.ref.extMeta&&(t=e.ref.extMeta.indexOf("-",1),-1!=t&&(p=parseFloat(e.ref.extMeta.substr(0,t)),t=parseFloat(e.ref.extMeta.substr(t+1)),k.min=p,k.max=t)),e.ref.scale&&(k.step=parseFloat(e.ref.scale)),
q||(q=e.name),"value"==q?h[q]=k:(c&&!c.values&&(c.values={}),c&&c.values&&(c.values[q]=k));else if("%e"==e.ref.ext){if(q||(q=e.name),e.ref.extMeta&&0<e.ref.extMeta.length)for(t=0;t<e.ref.extMeta.length;t++){var u=JSON.parse(JSON.stringify(k));u.data.command.ext=e.ref.extMeta[t];u.original+=" "+e.ref.extMeta[t];var v=q+" "+e.ref.extMeta[t];this._customMap&&p&&this._customMap[p]&&(n=this._customMap[p],(n=n[u.original]?n[u.original][r]:null)&&(v=n));h[v]=u}}else"rgb"==e.type||"rgbw"==e.type?(k=JSON.parse(JSON.stringify(k)),
k.data.command.ext="FF0000",h[g.MAP.red[r]]=k,k=JSON.parse(JSON.stringify(k)),k.data.command.ext="FF00FF",h[g.MAP.purple[r]]=k,k=JSON.parse(JSON.stringify(k)),k.data.command.ext="0000FF",h[g.MAP.blue[r]]=k,k=JSON.parse(JSON.stringify(k)),k.data.command.ext="00FFFF",h[g.MAP.cyan[r]]=k,k=JSON.parse(JSON.stringify(k)),k.data.command.ext="00FF00",h[g.MAP.green[r]]=k,k=JSON.parse(JSON.stringify(k)),k.data.command.ext="FFFF00",h[g.MAP.yellow[r]]=k,k=JSON.parse(JSON.stringify(k)),k.data.command.ext="FF8C00",
h[g.MAP.orange[r]]=k,"rgbw"==e.type&&(k=JSON.parse(JSON.stringify(k)),k.data.command.ext="FFFFFF",h[g.MAP.white[r]]=k)):(q||(q=e.name),h[q]=k,t&&(k.mappedCustom=!0))}}return h};g.prototype._processRootCommandsFromMap=function(a,d,b,c,f,h,r){f||(f="de");f=f.toLowerCase();f=g.LANG.indexOf(f);if(d&&d.value&&d.children&&0!=d.children.length){if("mainzone"!=d.value&&"global"!=d.value){a=h.name+" "+d.name;var l={name:a,sys:h.sys,type:h.type,baseurl:h.baseurl,commands:{}};r[a]=l;a=l.commands}for(r=0;r<d.children.length;r++)if(l=
d.children[r],("string"!=l.type||"aio"==c.info.sys&&"STRING"==c.info.type)&&"root"!=l.type){var e={type:"POST",url:"/cmd",original:l.name,data:{XC_FNC:"SendRM",device:c.index,command:JSON.parse(JSON.stringify(l.ref))}};e.data.command.path=[d.value];var k=l.name.toLowerCase(),p=g.MAP[k]?g.MAP[k][f]:null;(k=b&&b[k]?b[k][f]:null)&&(p=k);var q=null,k=c.info.sys;if(this._customMap&&k&&this._customMap[k])var t=this._customMap[k],q=t[l.name]?t[l.name][f]:null;q&&(p=q);if("%d"==l.ref.ext||"%f"==l.ref.ext||
"%s"==l.ref.ext)e.data.command.ext="{val}","%f"==l.ref.ext&&(e["float"]=1),l.ref.extMeta&&(q=l.ref.extMeta.indexOf("-",1),-1!=q&&(k=parseFloat(l.ref.extMeta.substr(0,q)),q=parseFloat(l.ref.extMeta.substr(q+1)),e.min=k,e.max=q)),l.ref.scale&&(e.step=parseFloat(l.ref.scale)),p||(p=l.name),"value"!=p&&(h&&!h.values&&(h.values={}),h&&h.values&&(h.values[p]=e));else if("%e"==l.ref.ext){if(p||(p=l.name),l.ref.extMeta&&0<l.ref.extMeta.length)for(q=0;q<l.ref.extMeta.length;q++){var n=JSON.parse(JSON.stringify(e));
n.data.command.ext=l.ref.extMeta[q];n.original+=" "+l.ref.extMeta[q];var u=p+" "+l.ref.extMeta[q];this._customMap&&k&&this._customMap[k]&&(t=this._customMap[k],(t=t[n.original]?t[n.original][f]:null)&&(u=t));a[u]=n}}else"rgb"==l.type||"rgbw"==l.type?(e=JSON.parse(JSON.stringify(e)),e.data.command.ext="FF0000",a[g.MAP.red[f]]=e,e=JSON.parse(JSON.stringify(e)),e.data.command.ext="FF00FF",a[g.MAP.purple[f]]=e,e=JSON.parse(JSON.stringify(e)),e.data.command.ext="0000FF",a[g.MAP.blue[f]]=e,e=JSON.parse(JSON.stringify(e)),
e.data.command.ext="00FFFF",a[g.MAP.cyan[f]]=e,e=JSON.parse(JSON.stringify(e)),e.data.command.ext="00FF00",a[g.MAP.green[f]]=e,e=JSON.parse(JSON.stringify(e)),e.data.command.ext="FFFF00",a[g.MAP.yellow[f]]=e,e=JSON.parse(JSON.stringify(e)),e.data.command.ext="FF8C00",a[g.MAP.orange[f]]=e,"rgbw"==l.type&&(e=JSON.parse(JSON.stringify(e)),e.data.command.ext="FFFFFF",a[g.MAP.white[f]]=e)):(p||(p=l.name),a[p]=e,q&&(e.mappedCustom=!0))}return a}};g.prototype._isDeviceHeater=function(a){var d="HM-CC-RT-DN;HM-CC-RT-DN-BoM;HM-CC-TC;ZEL STG RM FWT;HM-TC-IT-WM-W-EU;HMIP-WTH;HmIP-WTH-2;HMIP-eTRV;HMIP-eTRV-2;HmIP-STHD;HmIP-STH;HmIP-BWTH;HmIP-BWTH24".split(";"),
b="heater thermostat wallthermo wallthermostat ip_heater ip_wallthermo ip_wallthermo2".split(" ");if(!a||!a.info)return!1;a=a.info;if("hm"==a.sys){if(-1!=d.indexOf(a.type))return!0}else if("aio"==a.sys)if("HM"==a.type){if(-1!=b.indexOf(a.data))return!0}else{if("FHT80b"==a.type)return!0}else if("max"==a.sys){if(1==a.type||2==a.type||3==a.type)return!0}else if("tado"==a.sys||"netatmo"==a.sys&&"NATherm1"==a.type)return!0;return!1};g.prototype._getDeviceCatagory=function(a){if(!a||!a.info)return null;
if(this._isDeviceHeater(a))return"heater";if(!a.info.command)return null;if("fibaro"==a.info.sys)return this._getFibaroHCDeviceCatagory(a);for(var d=a.info.command,b=!1,c=0;c<d.length;c++){var f=d[c];if(f&&f.name){f=f.name.toLowerCase();if(("hue"==a.info.sys||"osram"==a.info.sys)&&"brightness"==f)return"light";if("moveto"==f||"move to"==f||"position to"==f||"positionto"==f)return"blind";if("dimto"==f||"dim to"==f||"levelto"==f||"level to"==f)return"light";"on"==f&&(b=!0)}}return b||b?"switch":null};
g.prototype._getFibaroHCDeviceCatagory=function(a){a=a.info.command;for(var d=[],b=0;b<a.length;b++){var c=a[b];c&&c.name&&(c=c.name.toLowerCase(),-1==d.indexOf(c)&&d.push(c))}return-1!=d.indexOf("open")&&-1!=d.indexOf("close")?"blind":-1!=d.indexOf("up")&&-1!=d.indexOf("down")&&-1!=d.indexOf("set value")?"light":-1!=d.indexOf("on")&&-1!=d.indexOf("off")?"switch":null};g.prototype.getAccessToken=function(a,d){if(a)if("aio"!=a.sys&&"neoserver"!=a.sys)d&&d(Error("gateway type invalid"));else{var b=
this,c,f=require("xnm.aio.gateway.js");"neoserver"==a.sys?(a=JSON.parse(JSON.stringify(a)),a.sys="aio",a.version="EA",c=f.resolveGateway(a,!0)):c=f.resolveGateway(a);c?f.Admin.getGatewaySID(c,function(h,g){h?(b._logger.log("warn","get gateway sid error:"+h.message),h.code="50001",d&&d(h)):g?f.Admin.V5.getInfo(c,function(c,e){c?(b._logger.log("warn","get gateway info error:"+c.message),c.code="50101",d&&d(c)):e&&e.server?b._getAccessToken(g,a.password,!1,function(c,f){c?(c.code="50003",d&&d(c)):f?
d&&d(null,f,e.server):b._getAccessToken(g,a.password,!0,function(a,b){a?(a.code="50004",d&&d(a)):b?d&&d(null,b,e.server):d&&d(Error("access token empty"))})}):(b._logger.log("warn","gateway has no server"),c.code="50102",d&&d(c))}):(h=Error("remote access not established"),h.code="50002",d&&d())}):d&&d(Error("gateway json invalid"))}else d&&d(Error("gateway json is null"))};g.prototype.generateConfig=function(a,d,b,c,f,h,g,l,e,k){var p=function(a){for(var b=a.length,e={};b--;){var c=a[b];e[c.index]=
c.name}return e}(b),q=function(a){for(var b=a.length,e={};b--;){var c=a[b];e[c.index]=c.name}return e}(c);c={};d=e;b=e.indexOf(":");-1!=b&&(d=e.substr(0,b));for(var t=0;t<a.length;t++){var n=a[t];if(n&&n.cloud&&n.cloud.enabled&&n.info&&n.info.command&&0!=n.info.command.length&&("cloudservice"!=n.info.sys||!n.info.module)){e=n.name;b=p[n.room];if("_cameras"==e.substr(0,8)){b=null;var u=e.indexOf(":");e=e.substr(u+1)}if("_webpages"!=e.substr(0,9)){"_progs&sysvars"==b&&(b=q[n.info.gateway],"gw"==e.substr(0,
2)&&(u=e.indexOf("_"),e=e.substr(u+1)));var u=n.info.sys,v=n.info.type,w=this._getDeviceCatagory(n);w&&(v=w);b=(b?b+" ":"")+(e?e:"");n.cloud.alias&&(b=n.cloud.alias);e={name:b,module:u,sys:n.info.type,type:v,baseurl:"https://"+d+"/rapi/"+g,local:"http://"+l.ip+(l.port?":"+l.port:""),commands:{}};"cam"==u&&(e.manufacturer=n.info.manufacturer);c[b]=e;switch(u){case "hm":b=this._processHMCommands(n,h,e,c);break;case "aio":b=this._processAIOCommands(n,h,e,c);break;case "sonos":b=this._processSonosCommands(n,
h,e,c);break;case "hue":b=this._processHueCommands(n,h,e,c);break;case "easyled":case "milight":case "milightv6":b=this._processMilightCommands(n,h,e,c);break;case "lightify":b=this._processOsramCommands(n,h,e,c);break;case "harmony":b=this._processHarmonyCommands(n,h,e,c);break;case "pioneer":case "onkyo":case "denon":case "yamaha":b=this._processHarmonyCommands(n,h,e,c);break;case "mcontrol":b=this._processMcontrolCommands(n,h,e,c);break;case "fibaro":b=this._processFibaroHCCommands(n,h,e,c);break;
case "tado":b=this._processTadoCommands(n,h,e,c);break;case "netatmo":b=this._processNetatmoCommands(n,h,e,c);break;default:b=this._processCommandsFromMap(null,n,h,e,c)}e.commands=b}}}a={};if(f&&f.groups)for(h=0;h<f.groups.length;h++)if((p=f.groups[h])&&p.macros&&0!=p.macros.length)for(q=p.name,t=0;t<p.macros.length;t++)if(e=p.macros[t],b=e.name,e.cloud&&e.cloud.enabled){b=(q?q+" ":"")+(b?b:"");e.cloud.alias&&(b=e.cloud.alias);for(var x="",n=b.toLowerCase(),u="on off an aus up down auf ab hoch runter ein".split(" "),
v=0;v<u.length;v++){var w=u[v],y=n.substr(n.length-w.length);n.length>w.length&&y==w&&(x=b.substr(0,n.length-w.length).trim(),a[x]||(a[x]=[]),a[x].push({original_id:b,command:w}))}e={name:b,type:"scene",baseurl:"https://"+d+"/rapi/"+g,local:"http://"+l.ip+(l.port?":"+l.port:""),commands:{on:{type:"POST",url:"/cmd",data:{XC_FNC:"DoMacroRM",groupIdx:p.index,macroIdx:e.index}}}};c[b]=e}for(x in a){f=a[x];e={name:x,type:"scene",baseurl:"https://"+d+"/rapi/"+g,local:"http://"+l.ip+(l.port?":"+l.port:""),
commands:{}};for(b=0;b<f.length;b++)if((h=f[b])&&h.original_id&&h.command&&(p=h.original_id,q=c[p],delete c[p],q)){p=q.commands.on;q=h.command;switch(h.command){case "on":case "an":case "ein":q="on";break;case "off":case "aus":q="off";break;case "up":case "auf":case "hoch":q="up";break;case "down":case "ab":case "runter":q="down"}e.commands[q]=p}c[x]=e}k&&k(null,c)};g.prototype.uploadConfig=function(a,d,b,c){b={type:"mediola",configuration:b};a={host:require("url").parse(g.REMOTE_SERVER).host,port:443,
path:"/alexa/setConfiguration",method:"POST",timeout:3E4,auth:a+":"+d,user:a,password:d,headers:{"Content-Type":'text/xml; charset="utf-8"',Authorization:"Basic "+(new Buffer(a+":"+d)).toString("base64"),Connection:"close"}};var f=this;this._logger.log("trace","upload config to:"+JSON.stringify(a));a=require("https").request(a,function(a){a.setEncoding("utf8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){if(200==a.statusCode){f._logger.log("trace","upload config reponse:"+b);try{var d=
JSON.parse(b);if(d.XC_ERR){var e=Error(d.XC_ERR.msg);e.code=d.XC_ERR.code;c&&c(e)}else d.XC_SUC&&c&&c()}catch(g){c&&c(g)}}else f._logger.log("warn","upload config error +"+a.statusCode+":"+b),c&&c(Error("http response:"+a.statusCode))})});if(a.on)a.on("error",function(a){f._logger.log("warn","upload config error:"+a.message);c&&c(a);c=null});a.write(JSON.stringify(b));a.end()};g.prototype.setCustomCommandMap=function(a){this._customMap=a};g.prototype.loadCustomComamndMap=function(a,d){var b=require("fs-extra");
b.ensureFile(a,function(c){c?d&&d(null,{}):b.readFile(a,"utf8",function(a,b){if(a)d&&d(a);else if(b)try{var c=JSON.parse(b);d&&d(null,c)}catch(g){d&&d(null,{})}else d&&d(null,{})})})};g.prototype.saveCustomCommandMap=function(a,d,b){var c=require("fs-extra");c.ensureFile(a,function(f){if(f)b&&b(null,{});else try{var h=JSON.stringify(d,null,2);c.writeFile(a,h,function(a){b&&b(a)})}catch(g){b&&b(g)}})};return g}();
m.aio.voicemanager.Handler=function(){var g=function(){this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.Handler");this._devicemanager=this._configmanager=null;this._alexaHandler=new m.aio.voicemanager.AlexaHandler;this.CLOUD_PROTOCOL="https";this.CLOUD_HOST="webservice.mediola.com";this.CLOUD_PORT=443;this.CLOUD_PATH="/account/bindLicense"};g.prototype.CUSTOM_CMD_MAP_FILE="cloud_service_command.map";g.prototype.init=function(a,d,b,c){this._configmanager=a;this._devicemanager=d;this._macromanager=
b;c&&c()};g.prototype.loadCustomComamndMap=function(a,d){var b=this;this._configmanager.trace("/config/tenants/"+a,function(a,f){if(a)a.code="50100",d&&d(a);else{var h=require("path"),g=f.getFolderPath(),h=h.join(g,b.CUSTOM_CMD_MAP_FILE);b._alexaHandler.loadCustomComamndMap(h,function(a,b){d&&d(a,b)})}})};g.prototype.saveCustomComamndMap=function(a,d,b){var c=this;this._configmanager.trace("/config/tenants/"+a,function(a,h){if(a)a.code="50100",b&&b(a);else{var g=require("path"),l=h.getFolderPath(),
g=g.join(l,c.CUSTOM_CMD_MAP_FILE);c._alexaHandler.saveCustomCommandMap(g,d,function(a){b&&b(a)})}})};g.prototype.getCloudDeviceConfig=function(a,d,b){var c=null;if(d){var f=require("xnm.aio.cloudservice.js").resolveGateway(d);f?this._getCloudDevicesFromDB(a,f,function(a,c){if(a)b&&b(a);else if(c&&0!=c.length){var d=c.map(function(a){a=a.info;delete a.gateway;delete a.commands;delete a.states;return a});f.toCloudDevice(d,function(a,d){if(a)a.code=40003,b&&b(a);else if(d&&0!=d.length){for(var f={},
g=0;g<c.length;g++){var h=c[g];if(h)for(var l=0;l<d.length;l++){var u=d[l];u&&h.info.module==u.mod&&h.info.connection==u.connection&&h.info.id==u.id&&(u.name=h.__cloudref,f[h.__cloudref]=u)}}b&&b(null,f)}else b&&b(null,{})})}else b&&b(null,{})}):(c=Error("cloud json invalid"),c.code=4E4,b&&b(c))}else c=Error("cloud json invalid"),c.code=4E4,b&&b(c)};g.prototype._getCloudDevicesFromDB=function(a,d,b){var c=function(a,b){for(var c=0;c<b.length;c++){var d=b[c];if(d&&d.index==a)return d}return null},
f=this,g=require("xnm.aio.cloudservice.js"),r={filter:"prop","info.sys":"cloudservice","cloud.enabled":!0};this._devicemanager.execute("read",a,"device",r,function(l,e){l?(l.code=40001,b&&b(l)):e&&0!=e.length?(r={filter:"prop","info.sys":"cloudservice"},f._devicemanager.execute("read",a,"gateway",r,function(k,l){k?(k.code=40001,b&&b(k)):l&&0!=l.length?f._devicemanager.execute("read",a,"room",null,function(a,f){if(a)a.code=40001,b&&b(a);else if(f&&0!=f.length){for(var k=[],r=0;r<e.length;r++){var v=
e[r];if(v&&v.info&&v.info.gateway){var w=c(v.info.gateway,l);if(w&&w.info&&(w=g.resolveGateway(w.info))){if(!w.equalsTo(d)){a=Error("cloud device "+v.index+" belongs to another account");a.code=40002;b&&b(a);return}var x=c(v.room,f);x&&(w=v.name,x=x.name,w=(x?x+" ":"")+(w?w:""),v.cloud.alias&&(w=v.cloud.alias),v=JSON.parse(JSON.stringify(v)),v.__cloudref=w,k.push(v))}}}b&&b(null,k)}else b&&b(null,[])}):b&&b(null,[])})):b&&b(null,[])})};g.prototype.previewAlexaConfig=function(a,d,b,c,f){if(b&&b.username)if(c){var g=
{filter:"ui",f_ui_elem:"*",f_ui_type:"command"},r=this;this.getCloudDeviceConfig(a,b,function(b,e){b?f&&f(b):r._alexaHandler.getAccessToken(c,function(b,l,q){b?f&&f(b):r._devicemanager.execute("read",a,"device",g,function(b,k){b?(b.code="50005",f&&f(b)):r._devicemanager.execute("read",a,"gateway",g,function(b,g){b?(b.code="50006",f&&f(b)):r._devicemanager.execute("read",a,"gateway",null,function(b,h){b?(b.code="50007",f&&f(b)):r._devicemanager.execute("read",a,"room",null,function(b,t){b?(b.code=
"50008",f&&f(b)):r._macromanager.execute(a,"read",null,null,null,function(b,u){b?(b.code="50009",f&&f(b)):r.loadCustomComamndMap(a,function(a,b){if(a||!b)b=null;r._alexaHandler.setCustomCommandMap(b);r._alexaHandler.generateConfig(k,g,t,h,u,d,l,c,q,function(a,b){if(a)r._logger.log("warn","generate configuration error:"+a.message),a.code="50010",f&&f(a);else{var c={},d;if(e)for(d in e)c[d]=e[d];if(b)for(d in b)c[d]=b[d];(d=Object.keys(c))&&0!=d.length?f&&f(null,c):(r._logger.log("warn","generate empty configuration"),
a=Error("empty configuration"),a.code="50011",f&&f(a))}})})})})})})})})})}else f&&f(Error("gateway invalid"));else f&&f(Error("username is null"))};g.prototype.exportAlexaConfig=function(a,d,b,c,f){if(b&&b.username)if(c){var g=this;this.previewAlexaConfig(a,d,b,c,function(c,d){c?f&&f(c):g._configmanager.execute("read","/config/tenants/"+a,null,function(a,c){if(a)a.code="50013",f&&f(a);else{var p=null;c.license&&"normal"==c.license.type&&c.license.valid&&c.license.license&&(p=c.license.license);g._alexaHandler.uploadConfig(b.username,
b.password,d,function(a){a?(g._logger.log("warn","upload configuration error:"+a.message),a.code="000009"==a.code?"50014":"50012",f&&f(a)):p?g.bindLicense(b.username,b.password,p,function(a){a&&g._logger.log("warn","bind user license error:"+a.message);f&&f(null,d)}):f&&f(null,d)})}})})}else f&&f(Error("gateway invalid"));else f&&f(Error("username is null"))};g.prototype.bindLicense=function(a,d,b,c){d={host:this.CLOUD_HOST,port:this.CLOUD_PORT,path:this.CLOUD_PATH+"?license="+b,method:"GET",timeout:3E4,
auth:a+":"+d,user:a,password:d,headers:{"Content-Type":'text/xml; charset="utf-8"',Authorization:"Basic "+(new Buffer(a+":"+d)).toString("base64"),Connection:"close"}};var f=this;this._logger.log("trace","bind license "+b+" to:"+a);a=require(this.CLOUD_PROTOCOL).request(d,function(a){a.setEncoding("utf8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){200==a.statusCode?(f._logger.log("trace","bind license success"),c&&c()):(f._logger.log("warn","bind license success +"+a.statusCode+
":"+b),c&&c(Error("http response:"+a.statusCode)));c=null})});if(a.on)a.on("error",function(a){f._logger.log("warn","upload config error:"+a.message);c&&c(a);c=null});a.setTimeout(3E4,function(){c&&c(Error("timeout"));c=null});a.end()};return g}();"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.voicemanager.Handler);
