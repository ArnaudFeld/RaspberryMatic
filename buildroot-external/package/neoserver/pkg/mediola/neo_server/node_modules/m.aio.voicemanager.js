var m=m||{};m.aio=m.aio||{},m.aio.voicemanager=m.aio.voicemanager||{},m.aio.voicemanager.Util={clearHttpOptionForLog:function clearHttpOptionForLog(e){try{var o=JSON.parse(JSON.stringify(e));if(o.auth&&(o.auth="xxxxxx:xxxxxx"),o.headers)for(var n in headers)if(n&&"authorization"==n.toLocaleLowerCase()){var t=headers[n];if(t){var a=t.indexOf(" ");headers[n]=-1==a?"xxxxxx":t.substr(0,a)+" xxxxxx";}}return o;}catch(o){return e;}}},m.aio.voicemanager.CloudConfigHandler=function(){var e=function e(_e,o){this._devicemanager=_e,this._macromanager=o;};e.prototype._getCloudDeviceConfig=function(e,o,n){var t=null;if(!o)return(t=new Error("cloud json invalid")).code=4e4,void(n&&n(t));var a=require("xnm.aio.cloudservice.js").resolveGateway(o);if(!a)return(t=new Error("cloud json invalid")).code=4e4,void(n&&n(t));this._getCloudDevicesFromDB(e,a,function(e,o){if(e)n&&n(e);else if(o&&0!=o.length){var t=o.map(function(e){var o=e.info;return delete o.gateway,delete o.commands,delete o.states,o;});a.toCloudDevice(t,function(e,t){if(e)return e.code=40003,void(n&&n(e));if(t&&0!=t.length){for(var a={},r=0;r<o.length;r++){var i=o[r];if(i)for(var s=0;s<t.length;s++){var l=t[s];l&&(l.data&&i.info.module==l.data.mod&&i.info.connection==l.data.connection&&i.info.id==l.data.id?(l.name=i.__cloudref,a[i.__cloudref]=l):i.info.module==l.mod&&i.info.connection==l.connection&&i.info.id==l.id&&(l.name=i.__cloudref,l.data={mod:l.mod,connection:l.connection,id:l.id},delete l.mod,delete l.connection,delete l.id,a[i.__cloudref]=l));}}n&&n(null,a);}else n&&n(null,{});});}else n&&n(null,{});});},e.prototype._mergeConfig=function(e,o){var n,t={};if(e)for(n in e)t[n]=e[n];if(o)for(n in o)t[n]=o[n];return t;},e.prototype._getCloudDevicesFromDB=function(e,o,n){var t=function t(e,o){for(var n=0;n<o.length;n++){var t=o[n];if(t&&t.index==e)return t;}return null;},a=this,r=require("xnm.aio.cloudservice.js"),i={filter:"prop","info.sys":"cloudservice","cloud.enabled":!0};this._devicemanager.execute("read",e,"device",i,function(s,l){if(s)return s.code=40001,void(n&&n(s));l&&0!=l.length?(i={filter:"prop","info.sys":"cloudservice"},a._devicemanager.execute("read",e,"gateway",i,function(i,s){if(i)return i.code=40001,void(n&&n(i));s&&0!=s.length?a._devicemanager.execute("read",e,"room",null,function(e,a){if(e)return e.code=40001,void(n&&n(e));if(a&&0!=a.length){for(var i=[],u=0;u<l.length;u++){var c=l[u];if(c&&c.info&&c.info.gateway){var d=t(c.info.gateway,s);if(d&&d.info){var m=r.resolveGateway(d.info);if(m){if(!m.equalsTo(o))return(e=new Error("cloud device "+c.index+" belongs to another account")).code=40002,void(n&&n(e));var f=t(c.room,a);if(f){var p=c.name,g=f.name,v=(g?g+" ":"")+(p||"");c.cloud.alias&&(v=c.cloud.alias),(c=JSON.parse(JSON.stringify(c))).__cloudref=v,i.push(c);}}}}}n&&n(null,i);}else n&&n(null,[]);}):n&&n(null,[]);})):n&&n(null,[]);});},e.prototype._getCloudEnabledDevices=function(e,o){this._devicemanager.execute("read",e,"device",{filter:"prop","cloud.enabled":!0},function(e,n){o&&o(e,n);});},e.prototype._getGateways=function(e,o){this._devicemanager.execute("read",e,"gateway",null,function(e,n){o&&o(e,n);});},e.prototype._getRooms=function(e,o){this._devicemanager.execute("read",e,"room",null,function(e,n){o&&o(e,n);});},e.prototype._getGatewayInfo=function(e,o){if(e){if("aio"==e.sys||"neoserver"==e.sys){var n,t=this,a=require("xnm.aio.gateway.js");"neoserver"==e.sys?((e=JSON.parse(JSON.stringify(e))).sys="aio",e.version="EA",n=a.resolveGateway(e,!0)):n=a.resolveGateway(e),n?a.Admin.getGatewaySID(n,function(r,i){return r?(t._logger.log("warn","get gateway sid error:"+r.message),r.code="50001",r.message="get gateway sid error:"+r.message,void(o&&o(r))):i?e.password?void a.Admin.V5.getInfo(n,function(n,a){return n?(t._logger.log("warn","get gateway info error:"+n.message),n.message="get gateway info error:"+n.message,n.code="50101",void(o&&o(n))):a&&a.server?!a.cfg||64&parseInt(a.cfg,16)?(t._logger.log("warn","gateway cloud server is deactivated"),(n=new Error("gateway cloud server is deactivated")).code="50103",void(o&&o(n))):void t._getAccessToken(a.server,i,e.password,!1,function(n,r){if(n)return(n=new Error("get accesss token error:"+n.message)).code="50003",void(o&&o(n));r?o&&o(null,r,a.server,i):t._getAccessToken(a.server,i,e.password,!0,function(e,n){if(e)return(e=new Error("generate accesss token error:"+e.message)).code="50004",void(o&&o(e));n?o&&o(null,n,a.server,i):o&&o(new Error("access token empty"));});}):(t._logger.log("warn","gateway has no cloud server"),(n=new Error("gateway has no cloud server")).code="50102",void(o&&o(n)));}):((r=new Error("gateway has no password")).code="50002",void(o&&o(r))):((r=new Error("gateway has no sid")).code="50002",void(o&&o(r)));}):o&&o(new Error("gateway json invalid"));}else o&&o(new Error("gateway type invalid"));}else o&&o(new Error("gateway json is null"));},e.prototype._getAccessToken=function(e,o,n,t,a){var r=this._parseCCS(e),i=r.port;"https"==r.protocol&&80==i&&(i=443);var s={host:r.host,port:i,path:"/getAccessToken?sid="+o,method:"GET",timeout:3e4,auth:"user:"+n,user:"user",password:n,headers:{Authorization:"Basic "+new Buffer("user:"+n).toString("base64")}};t&&(s.path+="&force=1"),this._logger.log("trace","send get access token to:"+JSON.stringify(m.aio.voicemanager.Util.clearHttpOptionForLog(s)));var l=this,u=require(r.protocol).request(s,function(e){e.setEncoding("utf8");var o="";e.on("data",function(e){o+=e;}),e.on("end",function(){if(200==e.statusCode){l._logger.log("trace","get access token reponse:"+o);try{var n=JSON.parse(o);n.XC_ERR?a&&a(new Error(n.XC_ERR.msg)):n.XC_SUC?a&&a(null,n.XC_SUC.at):a&&a(new Error("invalid response"));}catch(e){a&&a(e);}}else l._logger.log("warn","get access token error +"+e.statusCode+":"+o),a&&a(new Error("http response:"+e.statusCode));});});u.on&&u.on("error",function(e){l._logger.log("warn","get access token error:"+e.message),a&&a(e),a=null;}),u.setTimeout&&u.setTimeout(5e3,function(){u.abort(),l._logger.log("warn","get access token timeout"),a&&a(new Error("http timeout")),a=null;}),u.end();},e.prototype._parseCCS=function(e){var o=e.indexOf(":");if(-1==o)return{protocol:"https",host:e,port:443};var n=e.substr(0,o),t=e.substr(o+1);return 8080==t?t=8443:80==t&&(t=443),{protocol:"https",host:n,port:t};};var o=function o(_o,n){e.call(this,_o,n),this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.V5ConfigHandler"),this._targetGatewayJSON=null,this._gatewayDetail={},this._tenantIdx=null,this._currentMacroGatewayIndex=null;};return(o.prototype=new e()).constructor=o,o.prototype.setTargetGateway=function(e){this._targetGatewayJSON=e;},o.prototype.exportConfig=function(e,o,n){var t=this;this._gatewayDetail={},this._tenantIdx=e,this._currentMacroGatewayIndex=null,this._getCloudDeviceConfig(e,o,function(o,a){o?n&&n(o):t._getGatewayDeviceConfig(e,function(o,r){o?n&&n(o):t._getMacrosConfig(e,function(e,o){if(e)n&&n(e);else{var i=t._mergeConfig(a,r);i=t._mergeConfig(o,i),n&&n(null,i);}});});});},o.prototype._isSameAsTargetGateway=function(e){return!!this._targetGatewayJSON&&e.ip==this._targetGatewayJSON.ip&&e.sid==this._targetGatewayJSON.sid;},o.prototype._getGatewayDeviceConfig=function(e,o){var n=function n(e,o){if(!o||0==o.length)return null;for(var n=o.length;n--;){var t=o[n];if(t&&t.index==e)return t;}return null;},t=this;this._getDevicesDetail(e,function(e,a){if(e)o&&o(e);else{for(var r=a.devices,i=a.gateways,s=a.rooms,l={},u=0;u<i.length;u++){var c=i[u];c&&c.info&&"aio"==c.info.sys&&c.info.version&&("C"!=c.info.version.charAt(0)&&"E"!=c.info.version.charAt(0)||"EA"!=c.info.version&&(t._targetGatewayJSON&&!t._isSameAsTargetGateway(c.info)||(l[c.index]=c)));}0!=Object.keys(l)?t._getGatewaysDetail(Object.values(l),function(e){if(e)o&&o(e);else if(r&&0!=r.length){for(var a=[],u=0;u<r.length;u++){var c=r[u];if(c&&c.info&&"aio"==c.info.sys&&c.info.gateway){var d=n(c.info.gateway,i);if(d&&l[c.info.gateway]){var m=n(c.room,s);a.push({device:c,gateway:d,room:m});}}}if(0!=a.length){var f={},p=(u=0,function(e,n){!e&&n&&(f=t._mergeConfig(f,n)),++u<a.length?t._genDeviceConfig(a[u].device,a[u].gateway,a[u].room,p):o&&o(null,f);});t._genDeviceConfig(a[u].device,a[u].gateway,a[u].room,p);}else o&&o(null,{});}else o&&o(null,{});}):o&&o(null,{});}});},o.prototype._genDeviceConfig=function(e,o,n,t){if(e&&e.info&&e.info.sys){if(o&&o.index){var a=this._gatewayDetail[o.index];if(a){var r=e.info.sys,i=this._devicemanager.getModule(r);if(i&&i.devicemanager&&i.devicemanager.toGeneralDevice){var s=i.devicemanager.toGeneralDevice(e.info,null,"v5");if(!s)return void(t&&t(null,null));s.name=this._genDeviceName(e,n),s.local="http://"+o.info.ip+(o.info.port?":"+o.info.port:""),s.baseurl=this._genBaseUrl(a),s.data||(s.data={}),s.data.sid=a.sid;var l={};l[s.name]=s,t&&t(null,l);}else t&&t(new Error("sys "+r+" can not be convert to general device"));}else t&&t(new Error("no gateway detail info"));}else t&&t(new Error("invalid gateway json"));}else t&&t(new Error("invalid device json"));},o.prototype._genDeviceName=function(e,o){if(e.cloud&&e.cloud.alias)return e.cloud.alias;var n=e.name,t=o.name;return n?t?t+" "+n:n:t;},o.prototype._genBaseUrl=function(e){var o=e.ccs,n=this._parseCCS(o);return n.protocol+"://"+n.host+"/rapi/"+e.token;},o.prototype._getDevicesDetail=function(e,o){var n=this;this._getCloudEnabledDevices(e,function(t,a){t?o&&o(t):n._getGateways(e,function(t,r){t?o&&o(t):n._getRooms(e,function(e,n){o&&o(e,{devices:a,gateways:r,rooms:n});});});});},o.prototype._getGatewaysDetail=function(e,o){var n=this,t=0,a=function a(r,i,s,l){r?o&&o(r):(n._gatewayDetail[e[t].index]={sid:l,ccs:s,token:i},++t<e.length?n._getGatewayInfo(e[t].info,a):o&&o());};n._getGatewayInfo(e[t].info,a);},o.prototype._getMacrosConfig=function(e,o){var n=this;this._macromanager.execute(e,"read",null,null,null,function(e,t){if(e)o&&o(e);else if(t&&t.groups&&0!=t.groups.length){for(var a={},r=0;r<t.groups.length;r++){var i=t.groups[r];if(i&&i.macros&&i.macros.length>0){var s=0,_l=function l(e,o,t){!e&&o&&t&&(a[o]=t),++s<i.macros.length&&n._getMacroConfig(i,i.macros[s],_l);};n._getMacroConfig(i,i.macros[s],_l);}}o&&o(null,a);}else o&&o(null,{});});},o.prototype._getMacroConfig=function(e,o,n){if(o&&o.cloud&&o.cloud.enabled){var t=e.name+" "+o.name;o.cloud.alias&&(t=o.cloud.alias);var a={name:t,type:"scene",commands:{on:{type:"POST",url:null,data:[]}}};this._currentMacroGatewayIndex=null;var r=this;if(o.commands&&o.commands.length>0){var i=0,s=function s(e,l,u){if(!e&&l&&a.commands.on.data.push(l),++i<o.commands.length)r._convertMacroCommand(o.commands[i],s);else{var c=r._gatewayDetail[r._currentMacroGatewayIndex];c?(a.commands.on.url=r._genBaseUrl(c)+"/macro",n&&n(null,t,a)):n&&n(new Error("no main gateway"));}};this._convertMacroCommand(o.commands[i],s);}}else n&&n(null,null,null);},o.prototype._convertMacroCommand=function(e,o){if(e&&e.classid)switch(e.classid){case"sleep":o(null,{P:e.time});break;case"command":if(!e.action||!e.action.device)return void o(new Error("invalid macro device command"));this._convertMacroDeviceCommand(e,o);break;default:o(new Error("unknown macro command"));}else o(new Error("invalid macro command"));},o.prototype._convertMacroDeviceCommand=function(e,o){var n=this;this._devicemanager.execute("read",this._tenantIdx,"device",{filter:"prop",index:e.action.device.index},function(t,a){if(t)o(t);else if(a&&0!=a.length){var r=a[0];r&&r.info&&r.info.sys?"aio"==r.info.sys?n._devicemanager.execute("read",n._tenantIdx,"gateway",{filter:"prop",index:r.info.gateway},function(t,a){if(t)o(t);else if(a&&0!=a.length){var i=a[0];if(i&&i.info&&i.index){n._gatewayDetail[i.index]&&(n._currentMacroGatewayIndex||(n._currentMacroGatewayIndex=i.index));var s=require("xnm.aio.gateway.js").devicemanager.getSystem(r.info,i.info);if(s){var l={value:e.action.value,ext:e.action.ext};if(s.buildQuery){var u=s.buildQuery(i.info,r.info,l);if(u){var c={},d=null;if("SendGenericCmd"==u.XC_FNC){if(d="/cmd?XC_FNC=SendGenericCmd&id="+u.id,u.data)for(var m in u.data)d+="&"+m+"="+(null==u.data[m]||null==u.data[m]?"":encodeURIComponent(u.data[m]));}else if("/api/command"==u.fnc)d="/api/command?json=",u.data&&(d+=encodeURIComponent(JSON.stringify(u.data)));else for(var m in d="/cmd?",u)d+="&"+m+"="+(null==u[m]||null==u[m]?"":encodeURIComponent(u[m]));i.index==n._currentMacroGatewayIndex?c.C=d:c.A={host:i.info.ip,cmd:d},o(null,c);}else o(new Error("invalid device command"));}else o(new Error("system do not support command"));}else o(new Error("unknown device type"));}else o(new Error("invalid gateway json"));}else o(new Error("no such gateway"));}):o(null,null):o(new Error("invalid device json"));}else o(new Error("no such device"));});},{V5:o};}(),m.aio.voicemanager.AlexaHandler=function(){var e=function e(){this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.Cloud"),this._customMap=null;};return e.LANG=["en","de"],e.MAP={on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],up:["up","up"],down:["down","down"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],dimup:["up","up"],dimdown:["down","down"],dimto:["value","value"],"move up":["up","up"],"move down":["down","down"],"move to":["value","value"],moveup:["up","up"],movedown:["down","down"],moveto:["value","value"],stop:["off","off"],brightness:["value","value"],"brightness up":["up","up"],"brightness down":["down","down"],"temperature up":["up","up"],"temperature down":["down","down"],"temperature to":["value","value"],"set temperature":["value","value"],temperature:["value","value"],"set point":["value","value"],"mode auto":["auto","auto"],"set auto mode":["auto","auto"],"auto mode":["auto","auto"],auto:["auto","auto"],"mode manu":["manu","manu"],"set manual mode":["manu","manu"],"manu mode":["manu","manu"],manu:["manu","manu"],"mode boost":["boost","boost"],"set boost mode":["boost","boost"],"boost mode":["boost","boost"],"boost on":["boost","boost"],boost:["boost","boost"],white:["white","weiß"],red:["red","rot"],purple:["purple","violett"],blue:["blue","blau"],cyan:["cyan","cyan"],green:["green","grün"],yellow:["yellow","gelb"],orange:["orange","orange"],mode:["mode","mode"],"power on":["on","on"],"power off":["off","off"],poweron:["on","on"],poweroff:["off","off"],volumeup:["up","up"],volumedown:["down","down"],"volume up":["up","up"],"volume down":["down","down"],"volume to":["value","value"]},e.HM_MAP={"short press":["short press","kurz drücken"],"long press":["long press","lange drücken"],"set value":["value","value"],red:["red","rot"],green:["green","grün"],orange:["orange","orange"],on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],"move up":["up","up"],"move down":["down","down"],"step up":["step up","step up"],"step down":["step down","step down"],"move to":["value","value"],stop:["off","off"],open:["open","öffnen"],lock:["lock","abschließen"],unlock:["unlock","aufschließen"],"temperature up":["up","up"],"temperature down":["down","down"],"temperature to":["value","value"],"set auto mode":["auto","auto"],"set manual mode":["manu","manu"],"set manu mode":["manu","manu"],"set boost mode":["boost","boost"],"set comfort mode":["comfort","komfort"],"lamella up":["lamella up","lamella up"],"lamella down":["lamella down","lamella down"],"lamella to":["lamella to","lamella to"]},e.AIO_MAP={on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],"mode auto":["auto","auto"],"mode manu":["manu","manu"],"mode toggle":["toggle","toggle"],up:["up","up"],down:["down","down"],"up step bit":["step up","step up"],"down step bit":["step down","step down"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],"dim off":["off","off"],Auf:["up","up"],Ab:["down","down"],Stop:["off","off"],"move up":["up","up"],"move down":["down","down"],"move in":["up","up"],"move out":["down","down"],"level up":["up","up"],"level down":["down","down"],"start dim":["up","up"],"stop dim":["down","down"],"step up":["step up","step up"],"step down":["step down","step down"],"move to":["value","value"],stop:["off","off"],open:["open","öffnen"],close:["close","schließen"],lock:["lock","abschließen"],unlock:["unlock","aufschließen"],"temperature up":["up","up"],"temperature down":["down","down"],"set temperature":["value","value"],"temperature to":["value","value"],"set auto mode":["auto","auto"],"auto mode":["auto","auto"],"set manual mode":["manu","manu"],"manu mode":["manu","manu"],"set boost mode":["boost","boost"],"boost mode":["boost","boost"],"boost on":["boost","boost"],"boost off":["boost off","boost aus"],"heater on":["heater on","heizung an"],"heater off":["heater off","heizung aus"],"led on":["led on","led an"],"led off":["led off","led aus"],"chime on":["chime on","chime an"],"chime off":["chime off","chime aus"],"panic alarm on":["panic on","panic an"],"panic alarm off":["panic off","panic aus"],disarmed:["disarm","entschärfen"],"all armed":["arm","scharf schalten"],"lamella up":["lamella up","lamella hoch"],"lamella down":["lamella down","lamella runter"],"lamella step up":["lamella step up","lamella step up"],"lamella step down":["lamella step down","lamella step down"],"lamella to":["lamella to","lamella to"],lamella:["lamella to","lamella to"],"tilt to":["lamella to","lamella to"],"preset position":["position to","position to"],activate:["on","on"],deactivate:["off","off"],A:["off","off"],B:["off","off"],C:["off","off"],"do scene":["do scene","scene starten"],brightness:["value","value"],color:["color","farblich"],white:["white","weiß"],red:["red","rot"],purple:["purple","violett"],blue:["blue","blau"],cyan:["cyan","cyan"],green:["green","grün"],yellow:["yellow","gelb"],orange:["orange","orange"],position:["value","value"],"position 1":["position 1","position 1"],"position 2":["position 2","position 2"],"brightness up":["up","up"],"brightness down":["down","down"],"set value":["value","value"]},e.SONOS_MAP={play:["play","play"],pause:["pause","pause"],stop:["off","off"],previous:["previous","previous"],next:["next","next"],"shuffle on":["shuffle on","shuffle on"],"shuffle off":["shuffle off","shuffle off"],"repeat off":["repeat off","repeat off"],"repeat all":["repeat all","repeat all"],"repeat one":["repeat one","repeat one"],"group volume":["value","value"],"group volume up":["up","up"],"group volume down":["down","down"],"group mute":["mute","mute"],"group unmute":["unmute","unmute"],volume:["value","value"],"volume up":["up","up"],"volume down":["down","down"],mute:["mute","mute"],unmute:["unmute","unmute"]},e.HUE_MAP={"color temperature":["color temperature","color temperatur"]},e.MILIGHT_MAP={"disco speed up":["faster","schneller"],"disco speed down":["slower","langsamer"],"speed up":["faster","schneller"],"speed down":["slower","langsamer"],"mode up":["next mode","nächste mode"],"mode down":["previous mode","vorherige mode"],"full brightness":["max","max"],"warm white up":["warmer","wärmer"],"cool white up":["cooler","kälter"],"max brightness":["max","max"],"night mode":["night mode","nacht mode"],"night light on":["night mode","nacht mode"],warmer:["warmer","wärmer"],cooler:["cooler","kälter"]},e.OSRAM_MAP={"color temperature":["color temperature","color temperatur"],"do scene":["scene","szene"]},e.HARMONY_MAP={"power on":["on","on"],"power off":["off","off"],poweron:["on","on"],poweroff:["off","off"],stop:["stop","stop"],volumeup:["up","up"],volumedown:["down","down"],"volume up":["up","up"],"volume down":["down","down"]},e.AV_MAP={stop:["stop","stop"]},e.TADO_MAP={"set manu temperature":["value","value"],manu:["value","value"]},e.NETATMO_MAP={manu:["value","value"]},e.FIBAROHC_MAP={"set value":["value","value"]},e.REMOTE_SERVER="https://cloud.mediola.com",e.prototype._getAccessToken=function(e,o,n,t,a){var r={host:require("url").parse("https://"+e).hostname,port:443,path:"/getAccessToken?sid="+o,method:"GET",timeout:3e4,auth:"user:"+n,user:"user",password:n,headers:{Authorization:"Basic "+new Buffer("user:"+n).toString("base64")}};t&&(r.path+="&force=1"),this._logger.log("trace","send get access token to:"+JSON.stringify(m.aio.voicemanager.Util.clearHttpOptionForLog(r)));var i=this,s=require("https").request(r,function(e){e.setEncoding("utf8");var o="";e.on("data",function(e){o+=e;}),e.on("end",function(){if(200==e.statusCode){i._logger.log("trace","get access token reponse:"+o);try{var n=JSON.parse(o);n.XC_ERR?a&&a(new Error(n.XC_ERR.msg)):n.XC_SUC?a&&a(null,n.XC_SUC.at):a&&a(new Error("invalid response"));}catch(e){a&&a(e);}}else i._logger.log("warn","get access token error +"+e.statusCode+":"+o),a&&a(new Error("http response:"+e.statusCode));});});s.on&&s.on("error",function(e){i._logger.log("warn","get access token error:"+e.message),a&&a(e),a=null;}),s.setTimeout&&s.setTimeout(5e3,function(){s.abort(),i._logger.log("warn","get access token timeout"),a&&a(new Error("http timeout")),a=null;}),s.end();},e.prototype._processHMCommands=function(o,n,t){return this._processCommandsFromMap(e.HM_MAP,o,n,t);},e.prototype._processAIOCommands=function(o,n,t){return this._processCommandsFromMap(e.AIO_MAP,o,n,t);},e.prototype._processSonosCommands=function(o,n,t){return this._processCommandsFromMap(e.SONOS_MAP,o,n,t);},e.prototype._processHueCommands=function(o,n,t){return this._processCommandsFromMap(e.HUE_MAP,o,n,t);},e.prototype._processMilightCommands=function(o,n,t,a){return this._processCommandsFromMap(e.MILIGHT_MAP,o,n,t,a);},e.prototype._processOsramCommands=function(o,n,t){return this._processCommandsFromMap(e.OSRAM_MAP,o,n,t);},e.prototype._processHarmonyCommands=function(o,n,t,a){return this._processCommandsFromMap(e.HARMONY_MAP,o,n,t,a);},e.prototype._processMcontrolCommands=function(e,o,n){if(e&&e.info&&e.info.command){var t=JSON.parse(JSON.stringify(e.info.command));e.info.command=t,e.info.command.push({type:"enum",name:"on",ref:{value:"do",ext:"on"}}),e.info.command.push({type:"enum",name:"off",ref:{value:"do",ext:"off"}}),e.info.command.push({type:"enum",name:"up",ref:{value:"do",ext:"up"}}),e.info.command.push({type:"enum",name:"down",ref:{value:"do",ext:"down"}}),e.info.command.push({type:"int",name:"move to",ref:{value:"setInt",ext:"%d"}});}return this._processCommandsFromMap(null,e,o,n);},e.prototype._processFibaroHCCommands=function(o,n,t){if(t&&"blind"==t.type&&o&&o.info&&o.info.command){for(var a=JSON.parse(JSON.stringify(o.info.command)),r=0;r<a.length;r++){var i=a[r];switch(i.name){case"open":i.name="up";break;case"close":i.name="down";break;case"up":i.name="step up";break;case"down":i.name="step down";break;case"stop":i.name="off";}}o.info.command=a;}return this._processCommandsFromMap(e.FIBAROHC_MAP,o,n,t);},e.prototype._processAVCommands=function(o,n,t,a){return this._processCommandsFromMap(e.AV_MAP,o,n,t,a);},e.prototype._processTadoCommands=function(o,n,t){return this._processCommandsFromMap(e.TADO_MAP,o,n,t);},e.prototype._processNetatmoCommands=function(o,n,t){return this._processCommandsFromMap(e.NETATMO_MAP,o,n,t);},e.prototype._processCommandsFromMap=function(o,n,t,a,r){t=t?String(t).toLowerCase():"de";var i={},s=e.LANG.indexOf(t);for(var l=0;l<n.info.command.length;l++){var u=n.info.command[l];if("string"===u.type&&("aio"!==n.info.sys||"STRING"!==n.info.type))continue;if("root"===u.type){this._processRootCommandsFromMap(i,u,o,n,t,a,r);continue;}var c={type:"POST",url:"/cmd",original:u.name,data:{XC_FNC:"SendRM",device:n.index,command:JSON.parse(JSON.stringify(u.ref))}};var d=u.name.toLowerCase();var _m=e.MAP[d]?e.MAP[d][s]:null,f=o&&o[d]?o[d][s]:null;f&&(_m=f);var p=null,g=null;var v=n.info.sys;if(this._customMap&&v&&this._customMap[v]&&(g=this._customMap[v],p=g[u.name]?g[u.name][s]:null),p&&(_m=p),"%d"!==u.ref.ext&&"%f"!==u.ref.ext&&"%s"!==u.ref.ext){if("%e"!==u.ref.ext)"rgb"!==u.type&&"rgbw"!==u.type?(_m||(_m=u.name),i[_m]=c,p&&(c.mappedCustom=!0)):(c=JSON.parse(JSON.stringify(c)),c.data.command.ext="FF0000",i[e.MAP.red[s]]=c,c=JSON.parse(JSON.stringify(c)),c.data.command.ext="FF00FF",i[e.MAP.purple[s]]=c,c=JSON.parse(JSON.stringify(c)),c.data.command.ext="0000FF",i[e.MAP.blue[s]]=c,c=JSON.parse(JSON.stringify(c)),c.data.command.ext="00FFFF",i[e.MAP.cyan[s]]=c,c=JSON.parse(JSON.stringify(c)),c.data.command.ext="00FF00",i[e.MAP.green[s]]=c,c=JSON.parse(JSON.stringify(c)),c.data.command.ext="FFFF00",i[e.MAP.yellow[s]]=c,c=JSON.parse(JSON.stringify(c)),c.data.command.ext="FF8C00",i[e.MAP.orange[s]]=c,"rgbw"===u.type&&(c=JSON.parse(JSON.stringify(c)),c.data.command.ext="FFFFFF",i[e.MAP.white[s]]=c));else if(_m||(_m=u.name),u.ref.extMeta&&u.ref.extMeta.length>0)for(var _e2=0;_e2<u.ref.extMeta.length;_e2++){var _o2=JSON.parse(JSON.stringify(c));_o2.data.command.ext=u.ref.extMeta[_e2],_o2.original+=" "+u.ref.extMeta[_e2];var _n=_m+" "+u.ref.extMeta[_e2];if(this._customMap&&v&&this._customMap[v]){g=this._customMap[v];var _e3=g[_o2.original]?g[_o2.original][s]:null;_e3&&(_n=_e3);}i[_n]=_o2;}}else{if(c.data.command.ext="{val}","%f"===u.ref.ext&&(c["float"]=1),u.ref.extMeta){var _e4=u.ref.extMeta.indexOf("-",1);if(-1!=_e4){var _o3=parseFloat(u.ref.extMeta.substr(0,_e4)),_n2=parseFloat(u.ref.extMeta.substr(_e4+1));c.min=_o3,c.max=_n2;}}u.ref.scale&&(c.step=parseFloat(u.ref.scale)),_m||(_m=u.name),"value"===_m?("%s"!==u.ref.ext||i[_m],i[_m]=c):(a&&!a.values&&(a.values={}),a&&a.values&&(a.values[_m]=c));}}return i;},e.prototype._processRootCommandsFromMap=function(o,n,t,a,r,i,s){r||(r="de"),r=r.toLowerCase();var l={},u=e.LANG.indexOf(r);if(n&&n.value&&n.children&&0!=n.children.length){if("mainzone"!=n.value&&"global"!=n.value){var c=i.name+" "+n.name,d={name:c,type:i.type,sys:i.sys,baseurl:i.baseurl,commands:{}};s[c]=d,o=d.commands;}for(var m=0;m<n.children.length;m++){var f=n.children[m];if(("string"!=f.type||"aio"==a.info.sys&&"STRING"==a.info.type)&&"root"!=f.type){var p={type:"POST",url:"/cmd",original:f.name,data:{XC_FNC:"SendRM",device:a.index,command:JSON.parse(JSON.stringify(f.ref))}};p.data.command.path=[n.value];var g=f.name.toLowerCase(),v=e.MAP[g]?e.MAP[g][u]:null,h=t&&t[g]?t[g][u]:null;h&&(v=h);var w=null,y=null,_=a.info.sys;if(this._customMap&&_&&this._customMap[_]&&(w=(y=this._customMap[_])[f.name]?y[f.name][u]:null),w&&(v=w),"%d"!=f.ref.ext&&"%f"!=f.ref.ext&&"%s"!=f.ref.ext){if("%e"!=f.ref.ext)"rgb"!=f.type&&"rgbw"!=f.type?(v||(v=f.name),o[v]=p,w&&(p.mappedCustom=!0)):((p=JSON.parse(JSON.stringify(p))).data.command.ext="FF0000",o[e.MAP.red[u]]=p,(p=JSON.parse(JSON.stringify(p))).data.command.ext="FF00FF",o[e.MAP.purple[u]]=p,(p=JSON.parse(JSON.stringify(p))).data.command.ext="0000FF",o[e.MAP.blue[u]]=p,(p=JSON.parse(JSON.stringify(p))).data.command.ext="00FFFF",o[e.MAP.cyan[u]]=p,(p=JSON.parse(JSON.stringify(p))).data.command.ext="00FF00",o[e.MAP.green[u]]=p,(p=JSON.parse(JSON.stringify(p))).data.command.ext="FFFF00",o[e.MAP.yellow[u]]=p,(p=JSON.parse(JSON.stringify(p))).data.command.ext="FF8C00",o[e.MAP.orange[u]]=p,"rgbw"==f.type&&((p=JSON.parse(JSON.stringify(p))).data.command.ext="FFFFFF",o[e.MAP.white[u]]=p));else if(v||(v=f.name),f.ref.extMeta&&f.ref.extMeta.length>0)for(var C=0;C<f.ref.extMeta.length;C++){var x=JSON.parse(JSON.stringify(p));x.data.command.ext=f.ref.extMeta[C],x.original+=" "+f.ref.extMeta[C];var b=v+" "+f.ref.extMeta[C];if(this._customMap&&_&&this._customMap[_]){var M=(y=this._customMap[_])[x.original]?y[x.original][u]:null;M&&(b=M);}o[b]=x;}}else{if(p.data.command.ext="{val}","%f"==f.ref.ext&&(p["float"]=1),f.ref.extMeta){var O=f.ref.extMeta.indexOf("-",1);if(-1!=O){var S=parseFloat(f.ref.extMeta.substr(0,O)),F=parseFloat(f.ref.extMeta.substr(O+1));p.min=S,p.max=F;}}f.ref.scale&&(p.step=parseFloat(f.ref.scale)),v||(v=f.name),"value"==v?("%s"!=f.ref.ext||l[v],l[v]=p):(i&&!i.values&&(i.values={}),i&&i.values&&(i.values[v]=p));}}}return o;}},e.prototype._isDeviceHeater=function(e){if(!e||!e.info)return!1;var o=e.info;if("hm"==o.sys){var n=String(o.type).toLowerCase();return!(!n.startsWith("hmip-etrv")&&!n.startsWith("hmip-wth"))||["hm-cc-rt-dn","hm-cc-rt-dn-bom","hm-cc-tc","hm-cc-vg-1","hm-tc-it-wm-w-eu","hmip-bwth","hmip-bwth24","hmip-heating","hmip-sth","hmip-sthd","hmipw-sth","hmipw-sthd","hmipw-wth","zel stg rm fwt"].indexOf(n)>=0;}if("aio"==o.sys){if("HM"==o.type){if(-1!=["heater","thermostat","wallthermo","wallthermostat","ip_heater","ip_wallthermo","ip_wallthermo2"].indexOf(o.data))return!0;}else if("FHT80b"==o.type)return!0;}else if("max"==o.sys){if(1==o.type||2==o.type||3==o.type)return!0;}else{if("tado"==o.sys)return!0;if("netatmo"==o.sys){if("NATherm1"==o.type)return!0;}else if("gira"===o.sys&&"heater"===o.type)return!0;}return!1;},e.prototype._isDeviceScene=function(e){return!(!e||!e.info||"hm"!=e.info.sys)&&"Prog"==e.info.type;},e.prototype._isDeviceBlind=function(e){if(!e||!e.info)return!1;var o=e.info;return"NY"===o.type&&"shutter"===o.data||!("aio"!==o.sys||"MBUS"!==o.type||!String(o.subtype).includes("shutter"));},e.prototype._getDeviceCatagory=function(e){if(!e||!e.info)return null;if(this._isDeviceHeater(e))return"heater";if(this._isDeviceScene(e))return"scene";if(this._isDeviceBlind(e))return"blind";if(!e.info.command)return null;if("fibaro"==e.info.sys)return this._getFibaroHCDeviceCatagory(e);for(var o=e.info.command,n=!1,t=0;t<o.length;t++){var a=o[t];if(a&&a.name){var r=a.name.toLowerCase();if(("hue"==e.info.sys||"osram"==e.info.sys)&&"brightness"==r)return"light";if("moveto"==r||"move to"==r||"position to"==r||"positionto"==r)return"blind";if("dimto"==r||"dim to"==r||"levelto"==r||"level to"==r)return"light";"on"==r&&(n=!0);}}return n||n?"switch":null;},e.prototype._getFibaroHCDeviceCatagory=function(e){for(var o=e.info.command,n=[],t=0;t<o.length;t++){var a=o[t];if(a&&a.name){var r=a.name.toLowerCase();-1==n.indexOf(r)&&n.push(r);}}return-1!=n.indexOf("open")&&-1!=n.indexOf("close")?"blind":-1!=n.indexOf("up")&&-1!=n.indexOf("down")&&-1!=n.indexOf("set value")?"light":-1!=n.indexOf("on")&&-1!=n.indexOf("off")?"switch":null;},e.prototype._convertDeviceToCloudFormat=function(e,o,n,t,a){var r=e.info.sys,i=e.info.type,s=this._getDeviceCatagory(e);s&&(i=s);var l={name:o,type:i,module:r,sys:r,baseurl:n,commands:{},states:{}};if("aio"==r&&"TASK"==e.info.type)return{name:o,type:"scene",module:r,sys:r,baseurl:n,commands:{on:{type:"POST",url:"/cmd",original:"run",data:{XC_FNC:"SendRM",device:e.index,command:{value:"run"}}}}};if("hm"==r&&"Prog"==e.info.type)return{name:o,type:"scene",module:r,sys:r,baseurl:n,commands:{on:{type:"POST",url:"/cmd",original:"run",data:{XC_FNC:"SendRM",device:e.index,command:{value:"progExec"}}}}};if(e.info.command&&e.info.command.length>0){var u;switch(r){case"hm":u=this._processHMCommands(e,t,l,a);break;case"aio":u=this._processAIOCommands(e,t,l,a);break;case"sonos":u=this._processSonosCommands(e,t,l,a);break;case"hue":u=this._processHueCommands(e,t,l,a);break;case"easyled":case"milight":case"milightv6":u=this._processMilightCommands(e,t,l,a);break;case"lightify":u=this._processOsramCommands(e,t,l,a);break;case"harmony":case"pioneer":case"onkyo":case"denon":case"yamaha":u=this._processHarmonyCommands(e,t,l,a);break;case"mcontrol":u=this._processMcontrolCommands(e,t,l,a);break;case"fibaro":u=this._processFibaroHCCommands(e,t,l,a);break;case"tado":u=this._processTadoCommands(e,t,l,a);break;case"netatmo":u=this._processNetatmoCommands(e,t,l,a);break;default:u=this._processCommandsFromMap(null,e,t,l,a);}l.commands=u;}return e.info.status&&Object.keys(e.info.status).length>0&&(l.states=e.info.status),l;},e.prototype._resovleDeviceID=function(e,o,n){var t,a=e.name,r=n[e.room];"_cameras"==a.substr(0,8)&&(r=null,t=a.indexOf(":"),a=a.substr(t+1)),"_progs&sysvars"==r&&(r=o[e.info.gateway],"gw"==a.substr(0,2)&&(t=a.indexOf("_"),a=a.substr(t+1)));var i=(r?r+" ":"")+(a||"");return e.cloud.alias&&(i=e.cloud.alias),i;},e.prototype._resovleBaseUrl=function(e,o){var n=e,t=e.indexOf(":");return-1!=t&&(n=e.substr(0,t)),"https://"+n+"/rapi/"+o;},e.prototype.getAccessToken=function(e,o){if(e){if("aio"==e.sys||"neoserver"==e.sys){var n,t=this,a=require("xnm.aio.gateway.js");"neoserver"==e.sys?((e=JSON.parse(JSON.stringify(e))).sys="aio",e.version="EA",n=a.resolveGateway(e,!0)):n=a.resolveGateway(e),n?a.Admin.getGatewaySID(n,function(r,i){return r?(t._logger.log("warn","get gateway sid error:"+r.message),r.code="50001",r.message="get gateway sid error:"+r.message,void(o&&o(r))):i?e.password?void a.Admin.V5.getInfo(n,function(n,a){return n?(t._logger.log("warn","get gateway info error:"+n.message),n.message="get gateway info error:"+n.message,n.code="50101",void(o&&o(n))):a&&a.server?!a.cfg||64&parseInt(a.cfg,16)?(t._logger.log("warn","gateway cloud server is deactivated"),(n=new Error("gateway cloud server is deactivated")).code="50103",void(o&&o(n))):void t._getAccessToken(a.server,i,e.password,!1,function(n,r){if(n)return(n=new Error("get accesss token error:"+n.message)).code="50003",void(o&&o(n));r?o&&o(null,r,a.server,i):t._getAccessToken(a.server,i,e.password,!0,function(e,n){if(e)return(e=new Error("generate accesss token error:"+e.message)).code="50004",void(o&&o(e));n?o&&o(null,n,a.server,i):o&&o(new Error("access token empty"));});}):(t._logger.log("warn","gateway has no cloud server"),(n=new Error("gateway has no cloud server")).code="50102",void(o&&o(n)));}):((r=new Error("gateway has no password")).code="50002",void(o&&o(r))):((r=new Error("gateway has no sid")).code="50002",void(o&&o(r)));}):o&&o(new Error("gateway json invalid"));}else o&&o(new Error("gateway type invalid"));}else o&&o(new Error("gateway json is null"));},e.prototype.generateConfig=function(e,o,n,t,a,r,i,s,l,u){for(var c=require("url").parse("https://"+s),d=function(e){for(var o=e.length,n={};o--;){var t=e[o];n[t.index]=t.name;}return n;}(o),m=function(e){for(var o=e.length,n={};o--;){var t=e[o];n[t.index]=t.name;}return n;}(n),f={},p=this._resovleBaseUrl(s,r),g=null,v=null,h=0;h<e.length;h++){var w=e[h];w&&w.info&&("cloudservice"==w.info.sys&&w.info.module||"_webpages"!=w.name.substr(0,9)&&(g=this._resovleDeviceID(w,m,d),(v=this._convertDeviceToCloudFormat(w,g,p,a,f)).data={mod:"mediola",ccs:c.hostname,accessToken:r,deviceID:w.index},v.acn_device={},["data","model","modelid","module","sys","type"].forEach(function(e){var o=w.info[e];null!=o&&(v.acn_device[e]=o);}),f[g]=v));}var y={},_=null;if(t&&t.groups)for(var C=0;C<t.groups.length;C++){var x=t.groups[C];if(x&&x.macros&&0!=x.macros.length)for(var b=x.name,M=0;M<x.macros.length;M++){var O=x.macros[M],S=O.name;if(O.cloud&&O.cloud.enabled){g=(b?b+" ":"")+(S||""),O.cloud.alias&&(g=O.cloud.alias),_="";for(var F=g.toLowerCase(),A=["on","off","an","aus","up","down","auf","ab","hoch","runter","ein"],E=0;E<A.length;E++){var N=A[E],D=F.substr(F.length-N.length);F.length>N.length&&D==N&&(y[_=g.substr(0,F.length-N.length).trim()]||(y[_]=[]),y[_].push({original_id:g,command:N}));}v={name:g,type:"scene",baseurl:p,local:"http://"+i.ip+(i.port?":"+i.port:""),commands:{on:{type:"POST",url:"/cmd",data:{XC_FNC:"DoMacroRM",groupIdx:x.index,macroIdx:O.index}}}},f[g]=v;}}}for(_ in y){var J=y[_];v={name:_,type:"scene",baseurl:p,local:"http://"+i.ip+(i.port?":"+i.port:""),commands:{}};for(var k=!1,T=!1,P=0;P<J.length;P++){var G=J[P];if(G&&G.original_id&&G.command){var H=G.original_id,I=f[H];if(delete f[H],!I)continue;var R=I.commands.on,L=G.command;switch(G.command){case"on":case"an":case"ein":k=!0,L="on";break;case"off":case"aus":k=!0,L="off";break;case"up":case"auf":case"hoch":T=!0,L="up";break;case"down":case"ab":case"runter":T=!0,L="down";}v.commands[L]=R;}}k?v.type="switch":T&&(v.type="blind"),f[_]=v;}u&&u(null,f);},e.prototype.uploadConfig=function(o,n,t){var a={type:"mediola",configuration:n},r=o.ip;r||(r=require("url").parse(e.REMOTE_SERVER).host);var i=o.port;i||(i=443);var s=o.username?o.username:"",l=o.password?o.password:"",u={host:r,port:i,path:"/alexa/setConfiguration",method:"POST",timeout:3e4,auth:s+":"+l,user:s,password:l,headers:{"Content-Type":'text/xml; charset="utf-8"',Authorization:"Basic "+new Buffer(s+":"+l).toString("base64"),Connection:"close"}},c=this;this._logger.log("trace","upload config to:"+JSON.stringify(u));var d=require("https").request(u,function(e){e.setEncoding("utf8");var o="";e.on("data",function(e){o+=e;}),e.on("end",function(){if(200==e.statusCode){c._logger.log("trace","upload config reponse:"+o);try{var n=JSON.parse(o);if(n.XC_ERR){var a=new Error(n.XC_ERR.msg);a.code=n.XC_ERR.code,t&&t(a);}else n.XC_SUC&&t&&t();}catch(e){t&&t(e);}}else c._logger.log("warn","upload config error +"+e.statusCode+":"+o),t&&t(new Error("http response:"+e.statusCode));});});d.on&&d.on("error",function(e){c._logger.log("warn","upload config error:"+e.message),t&&t(e),t=null;}),d.write(JSON.stringify(a)),d.end();},e.prototype.setCustomCommandMap=function(e){this._customMap=e;},e.prototype.loadCustomComamndMap=function(e,o){var n=require("fs-extra");n.ensureFile(e,function(t){t?o&&o(null,{}):n.readFile(e,"utf8",function(e,n){if(e)o&&o(e);else if(n)try{var t=JSON.parse(n);o&&o(null,t);}catch(e){o&&o(null,{});}else o&&o(null,{});});});},e.prototype.saveCustomCommandMap=function(e,o,n){var t=require("fs-extra");t.ensureFile(e,function(a){if(a)n&&n(null,{});else try{var r=JSON.stringify(o,null,2);t.writeFile(e,r,function(e){n&&n(e);});}catch(e){n&&n(e);}});},e;}(),m.aio.voicemanager.Handler=function(){var e=function e(){this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.Handler"),this._configmanager=null,this._devicemanager=null,this._alexaHandler=new m.aio.voicemanager.AlexaHandler(),this.CLOUD_PROTOCOL="https",this.CLOUD_HOST="webservice.mediola.com",this.CLOUD_PORT=443,this.CLOUD_PATH="/account/bindLicense";};return e.prototype.CUSTOM_CMD_MAP_FILE="cloud_service_command.map",e.prototype.init=function(e,o,n,t){this._configmanager=e,this._devicemanager=o,this._macromanager=n,t&&t();},e.prototype.loadCustomComamndMap=function(e,o){var n=this;this._configmanager.trace("/config/tenants/"+e,function(e,t){if(e)return e.code="50100",void(o&&o(e));var a=require("path"),r=t.getFolderPath();if(!r)return(e=new Error("tenant folder is null")).code="50100",void(o&&o(e));var i=a.join(r,n.CUSTOM_CMD_MAP_FILE);n._alexaHandler.loadCustomComamndMap(i,function(e,n){o&&o(e,n);});});},e.prototype.saveCustomComamndMap=function(e,o,n){var t=this;this._configmanager.trace("/config/tenants/"+e,function(e,a){if(e)return e.code="50100",void(n&&n(e));var r=require("path"),i=a.getFolderPath(),s=r.join(i,t.CUSTOM_CMD_MAP_FILE);t._alexaHandler.saveCustomCommandMap(s,o,function(e){n&&n(e);});});},e.prototype.getLocalDeviceConfig=function(e,o,n,t){if(o){var a=this;this._alexaHandler.getAccessToken(o,function(r,i,s,l){r?t&&t(r):a._getDeviceWithCommandAndStatus(e,function(r,u){if(r)return r.code="50005",void(t&&t(r));a._devicemanager.execute("read",e,"gateway",null,function(r,c){if(r)return r.code="50007",void(t&&t(r));a._devicemanager.execute("read",e,"room",null,function(r,d){if(r)return r.code="50008",void(t&&t(r));a._macromanager.execute(e,"read",null,null,null,function(r,m){if(r)return r.code="50009",void(t&&t(r));a.loadCustomComamndMap(e,function(e,r){!e&&r||(r=null),a._alexaHandler.setCustomCommandMap(r),a._alexaHandler.generateConfig(u,d,c,m,n,i,o,s,l,function(e,o){if(e)return a._logger.log("warn","generate configuration error:"+e.message),e.code="50010",void(t&&t(e));t&&t(null,o);});});});});});});});}else t&&t(null,null);},e.prototype.getCloudDeviceConfig=function(e,o,n){var t=null;if(!o)return(t=new Error("cloud json invalid")).code=4e4,void(n&&n(t));var a=require("xnm.aio.cloudservice.js").resolveGateway(o);if(!a)return(t=new Error("cloud json invalid")).code=4e4,void(n&&n(t));this._getCloudDevicesFromDB(e,a,function(e,o){if(e)n&&n(e);else if(o&&0!=o.length){var t=o.map(function(e){var o=e.info;return delete o.gateway,delete o.commands,delete o.states,o;});a.toCloudDevice(t,function(e,t){if(e)return e.code=40003,void(n&&n(e));if(t&&0!=t.length){for(var a={},r=0;r<o.length;r++){var i=o[r];if(i)for(var s=0;s<t.length;s++){var l=t[s];l&&(l.data&&i.info.module==l.data.mod&&i.info.connection==l.data.connection&&i.info.id==l.data.id?(l.name=i.__cloudref,a[i.__cloudref]=l):i.info.module==l.mod&&i.info.connection==l.connection&&i.info.id==l.id&&(l.name=i.__cloudref,l.data={mod:l.mod,connection:l.connection,id:l.id},delete l.mod,delete l.connection,delete l.id,a[i.__cloudref]=l));}}n&&n(null,a);}else n&&n(null,{});});}else n&&n(null,{});});},e.prototype._getCloudDevicesFromDB=function(e,o,n){var t=function t(e,o){for(var n=0;n<o.length;n++){var t=o[n];if(t&&t.index==e)return t;}return null;},a=this,r=require("xnm.aio.cloudservice.js"),i={filter:"prop","info.sys":"cloudservice","cloud.enabled":!0};this._devicemanager.execute("read",e,"device",i,function(s,l){if(s)return s.code=40001,void(n&&n(s));l&&0!=l.length?(i={filter:"prop","info.sys":"cloudservice"},a._devicemanager.execute("read",e,"gateway",i,function(i,s){if(i)return i.code=40001,void(n&&n(i));s&&0!=s.length?a._devicemanager.execute("read",e,"room",null,function(e,a){if(e)return e.code=40001,void(n&&n(e));if(a&&0!=a.length){for(var i=[],u=0;u<l.length;u++){var c=l[u];if(c&&c.info&&c.info.gateway){var d=t(c.info.gateway,s);if(d&&d.info){var m=r.resolveGateway(d.info);if(m){if(!m.equalsTo(o))return(e=new Error("cloud device "+c.index+" belongs to another account")).code=40002,void(n&&n(e));var f=t(c.room,a);if(f){var p=c.name,g=f.name,v=(g?g+" ":"")+(p||"");c.cloud.alias&&(v=c.cloud.alias),(c=JSON.parse(JSON.stringify(c))).__cloudref=v,i.push(c);}}}}}n&&n(null,i);}else n&&n(null,[]);}):n&&n(null,[]);})):n&&n(null,[]);});},e.prototype.previewAlexaConfig=function(e,o,n,t,a){if(n&&n.username){if(t&&t.version&&"C"==t.version.charAt(0)&&"CA"!=t.version.toUpperCase()){var r=new m.aio.voicemanager.CloudConfigHandler.V5(this._devicemanager,this._macromanager);return r.setTargetGateway(t),void r.exportConfig(e,n,function(e,o){a&&a(e,o);});}var i=this;this.getCloudDeviceConfig(e,n,function(n,r){n?a&&a(n):i.getLocalDeviceConfig(e,t,o,function(e,o){if(e)a&&a(e);else{var n={};if(r)for(var t in r)n[t]=r[t];if(o)for(var t in o)n[t]=o[t];var s=Object.keys(n);if(!s||0==s.length)return i._logger.log("warn","generate empty configuration"),(e=new Error("empty configuration")).code="50011",void(a&&a(e));a&&a(null,n);}});});}else a&&a(new Error("username is null"));},e.prototype.exportAlexaConfig=function(e,o,n,t,a){if(n&&n.username){if(t){var r=this;this.previewAlexaConfig(e,o,n,t,function(o,t){if(o)a&&a(o);else{var i={};if(t)for(var s in t){var l=t[s];delete l.sys,delete l.module,i[s]=l;}r._configmanager.execute("read","/config/tenants/"+e,null,function(e,o){if(e)return e.code="50013",void(a&&a(e));var t=null;o.license&&"normal"==o.license.type&&o.license.valid&&o.license.license&&(t=o.license.license),r._alexaHandler.uploadConfig(n,i,function(e){if(e)return r._logger.log("warn","upload configuration error:"+e.message),"000009"==e.code?e.code="50014":e.code="50012",void(a&&a(e));t?r.bindLicense(n.username,n.password,t,function(e){e&&r._logger.log("warn","bind user license error:"+e.message),a&&a(null,i);}):a&&a(null,i);});});}});}else a&&a(new Error("gateway invalid"));}else a&&a(new Error("username is null"));},e.prototype._getDeviceWithCommandAndStatus=function(e,o){var n={filter:"prop","cloud.enabled":!0},t=this,a={};this._devicemanager.execute("read",e,"device",{filter:"ui",f_ui_elem:"*",f_ui_type:"command"},function(r,i){if(r)o(r);else{if(i&&i.length>0)for(var s=0;s<i.length;s++){var l=i[s];if(l&&l.cloud&&l.cloud.enabled&&l.info&&l.info.command&&0!=l.info.command.length){var u=l.index;a[u]=l;}}t._devicemanager.execute("read",e,"device",n,function(n,r){if(n)o(n);else if(r&&0!=r.length){var i=0,s=function s(n,l){if(!n&&l&&(a[r[i].index]?a[r[i].index].info.status=l.states:(a[r[i].index]=r[i],r[i].info.status=l.states)),++i<r.length)t._devicemanager.toGeneralDevice(e,r[i].index,!1,s);else{var u=Object.values(a);o(null,u);}};t._devicemanager.toGeneralDevice(e,r[i].index,!1,s);}else{var l=Object.values(a);o(null,l);}});}});},e.prototype.bindLicense=function(e,o,n,t){var a={host:this.CLOUD_HOST,port:this.CLOUD_PORT,path:this.CLOUD_PATH+"?license="+n,method:"GET",timeout:3e4,auth:e+":"+o,user:e,password:o,headers:{"Content-Type":'text/xml; charset="utf-8"',Authorization:"Basic "+new Buffer(e+":"+o).toString("base64"),Connection:"close"}},r=this;this._logger.log("trace","bind license "+n+" to:"+e);var i=require(this.CLOUD_PROTOCOL).request(a,function(e){e.setEncoding("utf8");var o="";e.on("data",function(e){o+=e;}),e.on("end",function(){200==e.statusCode?(r._logger.log("trace","bind license success"),t&&t()):(r._logger.log("warn","bind license success +"+e.statusCode+":"+o),t&&t(new Error("http response:"+e.statusCode))),t=null;});});i.on&&i.on("error",function(e){r._logger.log("warn","upload config error:"+e.message),t&&t(e),t=null;}),i.setTimeout(3e4,function(){t&&t(new Error("timeout")),t=null;}),i.end();},e.prototype.uploadDeviceDB=function(e,o,n,t){this._uploadFile(e,o,"device_db",n,t);},e.prototype.uploadMacroDB=function(e,o,n,t){this._uploadFile(e,o,"macros_db",n,t);},e.prototype._uploadFile=function(e,o,n,t,a){var r="/xhub/xhubsync/upload2?gatewayid="+e+"&fileName="+n+"&auth=";o.password&&(r+=o.password);var i={host:o.ip,port:o.port,path:r,method:"POST",timeout:3e4,headers:{"Content-Type":"text/plain",Connection:"close"}},s=this;this._logger.log("trace","upload "+n+" to:"+JSON.stringify(i));var l=require("http").request(i,function(e){e.setEncoding("utf8");var o="";e.on("data",function(e){o+=e;}),e.on("end",function(){if(200==e.statusCode){s._logger.log("trace","upload "+n+" reponse:"+o);try{"success"==JSON.parse(o).status?a&&a():a&&a(new Error("failed to upload "+n));}catch(e){a&&a(e);}}else s._logger.log("warn","upload "+n+" error +"+e.statusCode+":"+o),a&&a(new Error("http response:"+e.statusCode));});});l.on&&l.on("error",function(e){s._logger.log("warn","upload "+n+" error:"+e.message),a&&a(e),a=null;}),l.write(JSON.stringify(t)),l.end();},e.prototype.exportV5Config=function(e,o,n,t,a){if(n&&n.username){if(t){var r=this;new m.aio.voicemanager.CloudConfigHandler.V5(this._devicemanager,this._macromanager).exportConfig(e,n,function(o,t){if(o)return r._logger.log("error","generate configuration error:"+o.message),o.code="50012",void(a&&a(o));r._configmanager.execute("read","/config/tenants/"+e,null,function(e,o){if(e)return e.code="50013",void(a&&a(e));var i=null;o.license&&"normal"==o.license.type&&o.license.valid&&o.license.license&&(i=o.license.license),r._alexaHandler.uploadConfig(n,t,function(e){if(e)return r._logger.log("warn","upload configuration error:"+e.message),"000009"==e.code?e.code="50014":e.code="50012",void(a&&a(e));i?r.bindLicense(n.username,n.password,i,function(e){e&&r._logger.log("warn","bind user license error:"+e.message),a&&a(null,t);}):a&&a(null,t);});});});}else a&&a(new Error("gateway invalid"));}else a&&a(new Error("username is null"));},e;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.voicemanager.Handler());