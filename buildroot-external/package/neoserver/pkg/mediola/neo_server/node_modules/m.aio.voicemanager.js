var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(e,a,b){e!=Array.prototype&&e!=Object.prototype&&(e[a]=b.value)};$jscomp.getGlobal=function(e){return"undefined"!=typeof window&&window===e?e:"undefined"!=typeof global&&null!=global?global:e};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var e=0;return function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+e++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var e=$jscomp.global.Symbol.iterator;e||(e=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[e]&&$jscomp.defineProperty(Array.prototype,e,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(e){var a=0;return $jscomp.iteratorPrototype(function(){return a<e.length?{done:!1,value:e[a++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(e){$jscomp.initSymbolIterator();e={next:e};e[$jscomp.global.Symbol.iterator]=function(){return this};return e};$jscomp.iteratorFromArray=function(e,a){$jscomp.initSymbolIterator();e instanceof String&&(e+="");var b=0,c={next:function(){if(b<e.length){var f=b++;return{value:a(f,e[f]),done:!1}}c.next=function(){return{done:!0,value:void 0}};return c.next()}};c[Symbol.iterator]=function(){return c};return c};
$jscomp.polyfill=function(e,a,b,c){if(a){b=$jscomp.global;e=e.split(".");for(c=0;c<e.length-1;c++){var f=e[c];f in b||(b[f]={});b=b[f]}e=e[e.length-1];c=b[e];a=a(c);a!=c&&null!=a&&$jscomp.defineProperty(b,e,{configurable:!0,writable:!0,value:a})}};$jscomp.polyfill("Array.prototype.keys",function(e){return e?e:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");$jscomp.owns=function(e,a){return Object.prototype.hasOwnProperty.call(e,a)};
$jscomp.polyfill("Object.values",function(e){return e?e:function(a){var b=[],c;for(c in a)$jscomp.owns(a,c)&&b.push(a[c]);return b}},"es8","es3");var m=m||{};m.aio=m.aio||{};m.aio.voicemanager=m.aio.voicemanager||{};
m.aio.voicemanager.Util={clearHttpOptionForLog:function(e){try{var a=JSON.parse(JSON.stringify(e));a.auth&&(a.auth="xxxxxx:xxxxxx");if(a.headers)for(var b in headers)if(b&&"authorization"==b.toLocaleLowerCase()){var c=headers[b];if(c){var f=c.indexOf(" ");headers[b]=-1==f?"xxxxxx":c.substr(0,f)+" xxxxxx"}}return a}catch(d){return e}}};
m.aio.voicemanager.CloudConfigHandler=function(){var e=function(b){this._devicemanager=b};e.prototype._getCloudDeviceConfig=function(b,c,a){var d=null;if(c){var f=require("xnm.aio.cloudservice.js").resolveGateway(c);f?this._getCloudDevicesFromDB(b,f,function(b,c){b?a&&a(b):c&&0!=c.length?(b=c.map(function(b){b=b.info;delete b.gateway;delete b.commands;delete b.states;return b}),f.toCloudDevice(b,function(b,d){if(b)b.code=40003,a&&a(b);else if(d&&0!=d.length){b={};for(var f=0;f<c.length;f++){var g=
c[f];if(g)for(var k=0;k<d.length;k++){var h=d[k];h&&(h.data&&g.info.module==h.data.mod&&g.info.connection==h.data.connection&&g.info.id==h.data.id?(h.name=g.__cloudref,b[g.__cloudref]=h):g.info.module==h.mod&&g.info.connection==h.connection&&g.info.id==h.id&&(h.name=g.__cloudref,h.data={mod:h.mod,connection:h.connection,id:h.id},delete h.mod,delete h.connection,delete h.id,b[g.__cloudref]=h))}}a&&a(null,b)}else a&&a(null,{})})):a&&a(null,{})}):(d=Error("cloud json invalid"),d.code=4E4,a&&a(d))}else d=
Error("cloud json invalid"),d.code=4E4,a&&a(d)};e.prototype._mergeConfig=function(b,c){var a={},d;if(b)for(d in b)a[d]=b[d];if(c)for(d in c)a[d]=c[d];return a};e.prototype._getCloudDevicesFromDB=function(b,c,a){var d=function(b,a){for(var c=0;c<a.length;c++){var d=a[c];if(d&&d.index==b)return d}return null},f=this,q=require("xnm.aio.cloudservice.js"),h={filter:"prop","info.sys":"cloudservice","cloud.enabled":!0};this._devicemanager.execute("read",b,"device",h,function(g,e){g?(g.code=40001,a&&a(g)):
e&&0!=e.length?(h={filter:"prop","info.sys":"cloudservice"},f._devicemanager.execute("read",b,"gateway",h,function(g,k){g?(g.code=40001,a&&a(g)):k&&0!=k.length?f._devicemanager.execute("read",b,"room",null,function(b,f){if(b)b.code=40001,a&&a(b);else if(f&&0!=f.length){b=[];for(var g=0;g<e.length;g++){var h=e[g];if(h&&h.info&&h.info.gateway){var l=d(h.info.gateway,k);if(l&&l.info&&(l=q.resolveGateway(l.info))){if(!l.equalsTo(c)){b=Error("cloud device "+h.index+" belongs to another account");b.code=
40002;a&&a(b);return}var p=d(h.room,f);p&&(l=h.name,p=p.name,l=(p?p+" ":"")+(l?l:""),h.cloud.alias&&(l=h.cloud.alias),h=JSON.parse(JSON.stringify(h)),h.__cloudref=l,b.push(h))}}}a&&a(null,b)}else a&&a(null,[])}):a&&a(null,[])})):a&&a(null,[])})};e.prototype._getCloudEnabledDevices=function(b,a){this._devicemanager.execute("read",b,"device",{filter:"prop","cloud.enabled":!0},function(b,c){a&&a(b,c)})};e.prototype._getGateways=function(b,a){this._devicemanager.execute("read",b,"gateway",null,function(b,
c){a&&a(b,c)})};e.prototype._getRooms=function(b,a){this._devicemanager.execute("read",b,"room",null,function(b,c){a&&a(b,c)})};e.prototype._getGatewayInfo=function(b,a){if(b)if("aio"!=b.sys&&"neoserver"!=b.sys)a&&a(Error("gateway type invalid"));else{var c=this,d=require("xnm.aio.gateway.js");if("neoserver"==b.sys){b=JSON.parse(JSON.stringify(b));b.sys="aio";b.version="EA";var g=d.resolveGateway(b,!0)}else g=d.resolveGateway(b);g?d.Admin.getGatewaySID(g,function(f,h){f?(c._logger.log("warn","get gateway sid error:"+
f.message),f.code="50001",f.message="get gateway sid error:"+f.message,a&&a(f)):h?b.password?d.Admin.V5.getInfo(g,function(d,g){d?(c._logger.log("warn","get gateway info error:"+d.message),d.message="get gateway info error:"+d.message,d.code="50101",a&&a(d)):g&&g.server?!g.cfg||parseInt(g.cfg,16)&64?(c._logger.log("warn","gateway cloud server is deactivated"),d=Error("gateway cloud server is deactivated"),d.code="50103",a&&a(d)):c._getAccessToken(g.server,h,b.password,!1,function(d,f){d?(d=Error("get accesss token error:"+
d.message),d.code="50003",a&&a(d)):f?a&&a(null,f,g.server,h):c._getAccessToken(g.server,h,b.password,!0,function(b,c){b?(b=Error("generate accesss token error:"+b.message),b.code="50004",a&&a(b)):c?a&&a(null,c,g.server,h):a&&a(Error("access token empty"))})}):(c._logger.log("warn","gateway has no cloud server"),d=Error("gateway has no cloud server"),d.code="50102",a&&a(d))}):(f=Error("gateway has no password"),f.code="50002",a&&a()):(f=Error("gateway has no sid"),f.code="50002",a&&a())}):a&&a(Error("gateway json invalid"))}else a&&
a(Error("gateway json is null"))};e.prototype._getAccessToken=function(a,c,f,d,g){a=this._parseCCS(a);c={host:a.host,port:a.port,path:"/getAccessToken?sid="+c,method:"GET",timeout:3E4,auth:"user:"+f,user:"user",password:f,headers:{Authorization:"Basic "+(new Buffer("user:"+f)).toString("base64")}};d&&(c.path+="&force=1");this._logger.log("trace","send get access token to:"+JSON.stringify(m.aio.voicemanager.Util.clearHttpOptionForLog(c)));var b=this,h=require(a.protocol).request(c,function(a){a.setEncoding("utf8");
var c="";a.on("data",function(a){c+=a});a.on("end",function(){if(200==a.statusCode){b._logger.log("trace","get access token reponse:"+c);try{var d=JSON.parse(c);d.XC_ERR?g&&g(Error(d.XC_ERR.msg)):d.XC_SUC?g&&g(null,d.XC_SUC.at):g&&g(Error("invalid response"))}catch(n){g&&g(n)}}else b._logger.log("warn","get access token error +"+a.statusCode+":"+c),g&&g(Error("http response:"+a.statusCode))})});if(h.on)h.on("error",function(a){b._logger.log("warn","get access token error:"+a.message);g&&g(a);g=null});
h.setTimeout&&h.setTimeout(5E3,function(){h.abort();b._logger.log("warn","get access token timeout");g&&g(Error("http timeout"));g=null});h.end()};e.prototype._parseCCS=function(a){var b=a.indexOf(":");if(-1==b)return{protocol:"https",host:a,port:443};var f=a.substr(0,b);a=a.substr(b+1);8080==a&&(a=8443);return{protocol:"https",host:f,port:a}};var a=function(a){this._devicemanager=a;this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.V5ConfigHandler");this._gatewayDetail={}};a.prototype=
new e;a.prototype.constructor=a;a.prototype.exportConfig=function(a,c,f){var b=this;this._gatewayDetail={};this._getCloudDeviceConfig(a,c,function(c,d){c?f&&f(c):b._getGatewayDeviceConfig(a,function(a,c){a?f&&f(a):(a=b._mergeConfig(d,c),f&&f(null,a))})})};a.prototype._getGatewayDeviceConfig=function(a,c){var b=function(a,b){if(!b||0==b.length)return null;for(var c=b.length;c--;){var d=b[c];if(d&&d.index==a)return d}return null},d=this;this._getDevicesDetail(a,function(a,f){if(a)c&&c(a);else{a=f.devices;
var g=f.gateways;f=f.rooms;if(a&&0!=a.length){for(var k=[],e={},q=0;q<a.length;q++){var n=a[q];if(n&&n.info&&"aio"==n.info.sys&&n.info.gateway){var r=b(n.info.gateway,g);if(r){e[n.info.gateway]||(e[n.info.gateway]=r);var t=b(n.room,f);k.push({device:n,gateway:r,room:t})}}}0==k.length?c&&c(null,{}):0==Object.keys(e)?c&&c(null,{}):d._getGatewaysDetail(Object.values(e),function(a){if(a)c&&c(a);else{var b={},f=0,g=function(a,h){!a&&h&&(b=d._mergeConfig(b,h));f++;f<k.length?d._genDeviceConfig(k[f].device,
k[f].gateway,k[f].room,g):c&&c(null,b)};d._genDeviceConfig(k[f].device,k[f].gateway,k[f].room,g)}})}else c&&c(null,{})}})};a.prototype._genDeviceConfig=function(a,c,f,d){if(a&&a.info&&a.info.sys)if(c&&c.index){var b=this._gatewayDetail[c.index];if(b){var e=a.info.sys,h=this._devicemanager.getModule(e);h&&h.devicemanager&&h.devicemanager.toGeneralDevice?(e=h.devicemanager.toGeneralDevice(a.info,null,"v5"))?(e.name=this._genDeviceName(a,f),e.local="http://"+c.info.ip+(c.info.port?":"+c.info.port:""),
e.baseurl=this._genBaseUrl(b),e.data={sid:b.sid},a={},a[e.name]=e,d&&d(null,a)):d&&d(null,null):d&&d(Error("sys "+e+" can not be convert to general device"))}else d&&d(Error("no gateway detail info"))}else d&&d(Error("invalid gateway json"));else d&&d(Error("invalid device json"))};a.prototype._genDeviceName=function(a,c){if(a.cloud&&a.cloud.alias)return a.cloud.alias;a=a.name;c=c.name;return a?c?c+" "+a:a:c};a.prototype._genBaseUrl=function(a){var b=this._parseCCS(a.ccs);return b.protocol+"://"+
b.host+":"+b.port+"/rapi/"+a.token};a.prototype._getDevicesDetail=function(a,c){var b=this;this._getCloudEnabledDevices(a,function(d,f){d?c&&c(d):b._getGateways(a,function(d,g){d?c&&c(d):b._getRooms(a,function(a,b){c&&c(a,{devices:f,gateways:g,rooms:b})})})})};a.prototype._getGatewaysDetail=function(a,c){var b=this,d=0,g=function(f,h,e,l){f?c&&c(f):(b._gatewayDetail[a[d].index]={sid:l,ccs:e,token:h},d++,d<a.length?b._getGatewayInfo(a[d].info,g):c&&c())};b._getGatewayInfo(a[d].info,g)};return{V5:a}}();
m.aio.voicemanager.AlexaHandler=function(){var e=function(){this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.Cloud");this._customMap=null};e.LANG=["en","de"];e.MAP={on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],up:["up","up"],down:["down","down"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],dimup:["up","up"],dimdown:["down","down"],dimto:["value","value"],"move up":["up","up"],"move down":["down","down"],"move to":["value","value"],moveup:["up",
"up"],movedown:["down","down"],moveto:["value","value"],stop:["off","off"],brightness:["value","value"],"brightness up":["up","up"],"brightness down":["down","down"],"temperature up":["up","up"],"temperature down":["down","down"],"temperature to":["value","value"],"set temperature":["value","value"],temperature:["value","value"],"mode auto":["auto","auto"],"set auto mode":["auto","auto"],"auto mode":["auto","auto"],auto:["auto","auto"],"mode manu":["manu","manu"],"set manual mode":["manu","manu"],
"manu mode":["manu","manu"],manu:["manu","manu"],"mode boost":["boost","boost"],"set boost mode":["boost","boost"],"boost mode":["boost","boost"],"boost on":["boost","boost"],boost:["boost","boost"],white:["white","wei\u00df"],red:["red","rot"],purple:["purple","violett"],blue:["blue","blau"],cyan:["cyan","cyan"],green:["green","gr\u00fcn"],yellow:["yellow","gelb"],orange:["orange","orange"],mode:["mode","mode"],"power on":["on","on"],"power off":["off","off"],poweron:["on","on"],poweroff:["off",
"off"],volumeup:["up","up"],volumedown:["down","down"],"volume up":["up","up"],"volume down":["down","down"],"volume to":["value","value"]};e.HM_MAP={"short press":["short press","kurz dr\u00fccken"],"long press":["long press","lange dr\u00fccken"],"set value":["value","value"],red:["red","rot"],green:["green","gr\u00fcn"],orange:["orange","orange"],on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],"move up":["up",
"up"],"move down":["down","down"],"step up":["step up","step up"],"step down":["step down","step down"],"move to":["value","value"],stop:["off","off"],open:["open","\u00f6ffnen"],lock:["lock","abschlie\u00dfen"],unlock:["unlock","aufschlie\u00dfen"],"temperature up":["up","up"],"temperature down":["down","down"],"temperature to":["value","value"],"set auto mode":["auto","auto"],"set manual mode":["manu","manu"],"set boost mode":["boost","boost"],"set comfort mode":["comfort","komfort"],"lamella up":["lamella up",
"lamella up"],"lamella down":["lamella down","lamella down"],"lamella to":["lamella to","lamella to"]};e.AIO_MAP={on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],"mode auto":["auto","auto"],"mode manu":["manu","manu"],"mode toggle":["toggle","toggle"],up:["up","up"],down:["down","down"],"up step bit":["step up","step up"],"down step bit":["step down","step down"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],"dim off":["off","off"],Auf:["up","up"],Ab:["down",
"down"],Stop:["off","off"],"move up":["up","up"],"move down":["down","down"],"move in":["up","up"],"move out":["down","down"],"level up":["up","up"],"level down":["down","down"],"start dim":["up","up"],"stop dim":["down","down"],"step up":["step up","step up"],"step down":["step down","step down"],"move to":["value","value"],stop:["off","off"],open:["open","\u00f6ffnen"],close:["close","schlie\u00dfen"],lock:["lock","abschlie\u00dfen"],unlock:["unlock","aufschlie\u00dfen"],"temperature up":["up",
"up"],"temperature down":["down","down"],"set temperature":["value","value"],"temperature to":["value","value"],"set auto mode":["auto","auto"],"auto mode":["auto","auto"],"set manual mode":["manu","manu"],"manu mode":["manu","manu"],"set boost mode":["boost","boost"],"boost mode":["boost","boost"],"boost on":["boost","boost"],"boost off":["boost off","boost aus"],"heater on":["heater on","heizung an"],"heater off":["heater off","heizung aus"],"led on":["led on","led an"],"led off":["led off","led aus"],
"chime on":["chime on","chime an"],"chime off":["chime off","chime aus"],"panic alarm on":["panic on","panic an"],"panic alarm off":["panic off","panic aus"],disarmed:["disarm","entsch\u00e4rfen"],"all armed":["arm","scharf schalten"],"lamella up":["lamella up","lamella hoch"],"lamella down":["lamella down","lamella runter"],"lamella step up":["lamella step up","lamella step up"],"lamella step down":["lamella step down","lamella step down"],"lamella to":["lamella to","lamella to"],lamella:["lamella to",
"lamella to"],"tilt to":["lamella to","lamella to"],"preset position":["position to","position to"],activate:["on","on"],deactivate:["off","off"],A:["off","off"],B:["off","off"],C:["off","off"],"do scene":["do scene","scene starten"],brightness:["value","value"],color:["color","farblich"],white:["white","wei\u00df"],red:["red","rot"],purple:["purple","violett"],blue:["blue","blau"],cyan:["cyan","cyan"],green:["green","gr\u00fcn"],yellow:["yellow","gelb"],orange:["orange","orange"],position:["value",
"value"],"position 1":["position 1","position 1"],"position 2":["position 2","position 2"],"brightness up":["up","up"],"brightness down":["down","down"],"set value":["value","value"]};e.SONOS_MAP={play:["play","play"],pause:["pause","pause"],stop:["off","off"],previous:["previous","previous"],next:["next","next"],"shuffle on":["shuffle on","shuffle on"],"shuffle off":["shuffle off","shuffle off"],"repeat off":["repeat off","repeat off"],"repeat all":["repeat all","repeat all"],"repeat one":["repeat one",
"repeat one"],"group volume":["value","value"],"group volume up":["up","up"],"group volume down":["down","down"],"group mute":["mute","mute"],"group unmute":["unmute","unmute"],volume:["value","value"],"volume up":["up","up"],"volume down":["down","down"],mute:["mute","mute"],unmute:["unmute","unmute"]};e.HUE_MAP={"color temperature":["color temperature","color temperatur"]};e.MILIGHT_MAP={"disco speed up":["faster","schneller"],"disco speed down":["slower","langsamer"],"speed up":["faster","schneller"],
"speed down":["slower","langsamer"],"mode up":["next mode","n\u00e4chste mode"],"mode down":["previous mode","vorherige mode"],"full brightness":["max","max"],"warm white up":["warmer","w\u00e4rmer"],"cool white up":["cooler","k\u00e4lter"],"max brightness":["max","max"],"night mode":["night mode","nacht mode"],"night light on":["night mode","nacht mode"],warmer:["warmer","w\u00e4rmer"],cooler:["cooler","k\u00e4lter"]};e.OSRAM_MAP={"color temperature":["color temperature","color temperatur"],"do scene":["scene",
"szene"]};e.HARMONY_MAP={"power on":["on","on"],"power off":["off","off"],poweron:["on","on"],poweroff:["off","off"],stop:["stop","stop"],volumeup:["up","up"],volumedown:["down","down"],"volume up":["up","up"],"volume down":["down","down"]};e.AV_MAP={stop:["stop","stop"]};e.TADO_MAP={"set manu temperature":["value","value"],manu:["value","value"]};e.NETATMO_MAP={manu:["value","value"]};e.FIBAROHC_MAP={"set value":["value","value"]};e.REMOTE_SERVER="https://cloud.mediola.com";e.prototype._getAccessToken=
function(a,b,c,f,d){a={host:require("url").parse("https://"+a).hostname,port:443,path:"/getAccessToken?sid="+b,method:"GET",timeout:3E4,auth:"user:"+c,user:"user",password:c,headers:{Authorization:"Basic "+(new Buffer("user:"+c)).toString("base64")}};f&&(a.path+="&force=1");this._logger.log("trace","send get access token to:"+JSON.stringify(m.aio.voicemanager.Util.clearHttpOptionForLog(a)));var g=this,e=require("https").request(a,function(a){a.setEncoding("utf8");var b="";a.on("data",function(a){b+=
a});a.on("end",function(){if(200==a.statusCode){g._logger.log("trace","get access token reponse:"+b);try{var c=JSON.parse(b);c.XC_ERR?d&&d(Error(c.XC_ERR.msg)):c.XC_SUC?d&&d(null,c.XC_SUC.at):d&&d(Error("invalid response"))}catch(p){d&&d(p)}}else g._logger.log("warn","get access token error +"+a.statusCode+":"+b),d&&d(Error("http response:"+a.statusCode))})});if(e.on)e.on("error",function(a){g._logger.log("warn","get access token error:"+a.message);d&&d(a);d=null});e.setTimeout&&e.setTimeout(5E3,
function(){e.abort();g._logger.log("warn","get access token timeout");d&&d(Error("http timeout"));d=null});e.end()};e.prototype._processHMCommands=function(a,b,c){return this._processCommandsFromMap(e.HM_MAP,a,b,c)};e.prototype._processAIOCommands=function(a,b,c){return this._processCommandsFromMap(e.AIO_MAP,a,b,c)};e.prototype._processSonosCommands=function(a,b,c){return this._processCommandsFromMap(e.SONOS_MAP,a,b,c)};e.prototype._processHueCommands=function(a,b,c){return this._processCommandsFromMap(e.HUE_MAP,
a,b,c)};e.prototype._processMilightCommands=function(a,b,c,f){return this._processCommandsFromMap(e.MILIGHT_MAP,a,b,c,f)};e.prototype._processOsramCommands=function(a,b,c){return this._processCommandsFromMap(e.OSRAM_MAP,a,b,c)};e.prototype._processHarmonyCommands=function(a,b,c,f){return this._processCommandsFromMap(e.HARMONY_MAP,a,b,c,f)};e.prototype._processMcontrolCommands=function(a,b,c){if(a&&a.info&&a.info.command){var f=JSON.parse(JSON.stringify(a.info.command));a.info.command=f;a.info.command.push({type:"enum",
name:"on",ref:{value:"do",ext:"on"}});a.info.command.push({type:"enum",name:"off",ref:{value:"do",ext:"off"}});a.info.command.push({type:"enum",name:"up",ref:{value:"do",ext:"up"}});a.info.command.push({type:"enum",name:"down",ref:{value:"do",ext:"down"}});a.info.command.push({type:"int",name:"move to",ref:{value:"setInt",ext:"%d"}})}return this._processCommandsFromMap(null,a,b,c)};e.prototype._processFibaroHCCommands=function(a,b,c){if(c&&"blind"==c.type&&a&&a.info&&a.info.command){for(var f=JSON.parse(JSON.stringify(a.info.command)),
d=0;d<f.length;d++){var g=f[d];switch(g.name){case "open":g.name="up";break;case "close":g.name="down";break;case "up":g.name="step up";break;case "down":g.name="step down";break;case "stop":g.name="off"}}a.info.command=f}return this._processCommandsFromMap(e.FIBAROHC_MAP,a,b,c)};e.prototype._processAVCommands=function(a,b,c,f){return this._processCommandsFromMap(e.AV_MAP,a,b,c,f)};e.prototype._processTadoCommands=function(a,b,c){return this._processCommandsFromMap(e.TADO_MAP,a,b,c)};e.prototype._processNetatmoCommands=
function(a,b,c){return this._processCommandsFromMap(e.NETATMO_MAP,a,b,c)};e.prototype._processCommandsFromMap=function(a,b,c,f,d){c||(c="de");c=c.toLowerCase();for(var g={},q=e.LANG.indexOf(c),h=0;h<b.info.command.length;h++){var k=b.info.command[h];if("string"!=k.type||"aio"==b.info.sys&&"STRING"==b.info.type)if("root"==k.type)this._processRootCommandsFromMap(g,k,a,b,c,f,d);else{var l={type:"POST",url:"/cmd",original:k.name,data:{XC_FNC:"SendRM",device:b.index,command:JSON.parse(JSON.stringify(k.ref))}},
p=k.name.toLowerCase(),n=e.MAP[p]?e.MAP[p][q]:null;(p=a&&a[p]?a[p][q]:null)&&(n=p);var r=null;p=b.info.sys;if(this._customMap&&p&&this._customMap[p]){var t=this._customMap[p];r=t[k.name]?t[k.name][q]:null}r&&(n=r);if("%d"==k.ref.ext||"%f"==k.ref.ext||"%s"==k.ref.ext)l.data.command.ext="{val}","%f"==k.ref.ext&&(l["float"]=1),k.ref.extMeta&&(r=k.ref.extMeta.indexOf("-",1),-1!=r&&(p=parseFloat(k.ref.extMeta.substr(0,r)),r=parseFloat(k.ref.extMeta.substr(r+1)),l.min=p,l.max=r)),k.ref.scale&&(l.step=parseFloat(k.ref.scale)),
n||(n=k.name),"value"==n?g[n]=l:(f&&!f.values&&(f.values={}),f&&f.values&&(f.values[n]=l));else if("%e"==k.ref.ext){if(n||(n=k.name),k.ref.extMeta&&0<k.ref.extMeta.length)for(r=0;r<k.ref.extMeta.length;r++){var u=JSON.parse(JSON.stringify(l));u.data.command.ext=k.ref.extMeta[r];u.original+=" "+k.ref.extMeta[r];var v=n+" "+k.ref.extMeta[r];this._customMap&&p&&this._customMap[p]&&(t=this._customMap[p],(t=t[u.original]?t[u.original][q]:null)&&(v=t));g[v]=u}}else"rgb"==k.type||"rgbw"==k.type?(l=JSON.parse(JSON.stringify(l)),
l.data.command.ext="FF0000",g[e.MAP.red[q]]=l,l=JSON.parse(JSON.stringify(l)),l.data.command.ext="FF00FF",g[e.MAP.purple[q]]=l,l=JSON.parse(JSON.stringify(l)),l.data.command.ext="0000FF",g[e.MAP.blue[q]]=l,l=JSON.parse(JSON.stringify(l)),l.data.command.ext="00FFFF",g[e.MAP.cyan[q]]=l,l=JSON.parse(JSON.stringify(l)),l.data.command.ext="00FF00",g[e.MAP.green[q]]=l,l=JSON.parse(JSON.stringify(l)),l.data.command.ext="FFFF00",g[e.MAP.yellow[q]]=l,l=JSON.parse(JSON.stringify(l)),l.data.command.ext="FF8C00",
g[e.MAP.orange[q]]=l,"rgbw"==k.type&&(l=JSON.parse(JSON.stringify(l)),l.data.command.ext="FFFFFF",g[e.MAP.white[q]]=l)):(n||(n=k.name),g[n]=l,r&&(l.mappedCustom=!0))}}return g};e.prototype._processRootCommandsFromMap=function(a,b,c,f,d,g,q){d||(d="de");d=d.toLowerCase();d=e.LANG.indexOf(d);if(b&&b.value&&b.children&&0!=b.children.length){if("mainzone"!=b.value&&"global"!=b.value){a=g.name+" "+b.name;var h={name:a,type:g.type,sys:g.sys,baseurl:g.baseurl,commands:{}};q[a]=h;a=h.commands}for(q=0;q<b.children.length;q++)if(h=
b.children[q],("string"!=h.type||"aio"==f.info.sys&&"STRING"==f.info.type)&&"root"!=h.type){var k={type:"POST",url:"/cmd",original:h.name,data:{XC_FNC:"SendRM",device:f.index,command:JSON.parse(JSON.stringify(h.ref))}};k.data.command.path=[b.value];var l=h.name.toLowerCase(),p=e.MAP[l]?e.MAP[l][d]:null;(l=c&&c[l]?c[l][d]:null)&&(p=l);var n=null;l=f.info.sys;if(this._customMap&&l&&this._customMap[l]){var r=this._customMap[l];n=r[h.name]?r[h.name][d]:null}n&&(p=n);if("%d"==h.ref.ext||"%f"==h.ref.ext||
"%s"==h.ref.ext)k.data.command.ext="{val}","%f"==h.ref.ext&&(k["float"]=1),h.ref.extMeta&&(n=h.ref.extMeta.indexOf("-",1),-1!=n&&(l=parseFloat(h.ref.extMeta.substr(0,n)),n=parseFloat(h.ref.extMeta.substr(n+1)),k.min=l,k.max=n)),h.ref.scale&&(k.step=parseFloat(h.ref.scale)),p||(p=h.name),"value"!=p&&(g&&!g.values&&(g.values={}),g&&g.values&&(g.values[p]=k));else if("%e"==h.ref.ext){if(p||(p=h.name),h.ref.extMeta&&0<h.ref.extMeta.length)for(n=0;n<h.ref.extMeta.length;n++){var t=JSON.parse(JSON.stringify(k));
t.data.command.ext=h.ref.extMeta[n];t.original+=" "+h.ref.extMeta[n];var u=p+" "+h.ref.extMeta[n];this._customMap&&l&&this._customMap[l]&&(r=this._customMap[l],(r=r[t.original]?r[t.original][d]:null)&&(u=r));a[u]=t}}else"rgb"==h.type||"rgbw"==h.type?(k=JSON.parse(JSON.stringify(k)),k.data.command.ext="FF0000",a[e.MAP.red[d]]=k,k=JSON.parse(JSON.stringify(k)),k.data.command.ext="FF00FF",a[e.MAP.purple[d]]=k,k=JSON.parse(JSON.stringify(k)),k.data.command.ext="0000FF",a[e.MAP.blue[d]]=k,k=JSON.parse(JSON.stringify(k)),
k.data.command.ext="00FFFF",a[e.MAP.cyan[d]]=k,k=JSON.parse(JSON.stringify(k)),k.data.command.ext="00FF00",a[e.MAP.green[d]]=k,k=JSON.parse(JSON.stringify(k)),k.data.command.ext="FFFF00",a[e.MAP.yellow[d]]=k,k=JSON.parse(JSON.stringify(k)),k.data.command.ext="FF8C00",a[e.MAP.orange[d]]=k,"rgbw"==h.type&&(k=JSON.parse(JSON.stringify(k)),k.data.command.ext="FFFFFF",a[e.MAP.white[d]]=k)):(p||(p=h.name),a[p]=k,n&&(k.mappedCustom=!0))}return a}};e.prototype._isDeviceHeater=function(a){var b="HM-CC-RT-DN;HM-CC-RT-DN-BoM;HM-CC-TC;ZEL STG RM FWT;HM-TC-IT-WM-W-EU;HMIP-WTH;HmIP-WTH-2;HMIP-eTRV;HmIP-eTRV-2;HmIP-STHD;HmIP-STH;HmIP-BWTH;HmIP-BWTH24".split(";"),
c="heater thermostat wallthermo wallthermostat ip_heater ip_wallthermo ip_wallthermo2".split(" ");if(!a||!a.info)return!1;a=a.info;if("hm"==a.sys){if(-1!=b.indexOf(a.type))return!0}else if("aio"==a.sys)if("HM"==a.type){if(-1!=c.indexOf(a.data))return!0}else{if("FHT80b"==a.type)return!0}else if("max"==a.sys){if(1==a.type||2==a.type||3==a.type)return!0}else if("tado"==a.sys||"netatmo"==a.sys&&"NATherm1"==a.type)return!0;return!1};e.prototype._getDeviceCatagory=function(a){if(!a||!a.info)return null;
if(this._isDeviceHeater(a))return"heater";if(!a.info.command)return null;if("fibaro"==a.info.sys)return this._getFibaroHCDeviceCatagory(a);for(var b=a.info.command,c=!1,f=0;f<b.length;f++){var d=b[f];if(d&&d.name){d=d.name.toLowerCase();if(("hue"==a.info.sys||"osram"==a.info.sys)&&"brightness"==d)return"light";if("moveto"==d||"move to"==d||"position to"==d||"positionto"==d)return"blind";if("dimto"==d||"dim to"==d||"levelto"==d||"level to"==d)return"light";"on"==d&&(c=!0)}}return c||c?"switch":null};
e.prototype._getFibaroHCDeviceCatagory=function(a){a=a.info.command;for(var b=[],c=0;c<a.length;c++){var f=a[c];f&&f.name&&(f=f.name.toLowerCase(),-1==b.indexOf(f)&&b.push(f))}return-1!=b.indexOf("open")&&-1!=b.indexOf("close")?"blind":-1!=b.indexOf("up")&&-1!=b.indexOf("down")&&-1!=b.indexOf("set value")?"light":-1!=b.indexOf("on")&&-1!=b.indexOf("off")?"switch":null};e.prototype._convertDeviceToCloudFormat=function(a,b,c,f,d){var g=a.info.sys,e=a.info.type,h=this._getDeviceCatagory(a);h&&(e=h);
e={name:b,type:e,module:g,sys:g,baseurl:c,commands:{},states:{}};if("aio"==g&&"TASK"==a.info.type)return{name:b,type:"scene",module:g,sys:g,baseurl:c,commands:{on:{type:"POST",url:"/cmd",original:"run",data:{XC_FNC:"SendRM",device:a.index,command:{value:"run"}}}}};if(a.info.command&&0<a.info.command.length){switch(g){case "hm":b=this._processHMCommands(a,f,e,d);break;case "aio":b=this._processAIOCommands(a,f,e,d);break;case "sonos":b=this._processSonosCommands(a,f,e,d);break;case "hue":b=this._processHueCommands(a,
f,e,d);break;case "easyled":case "milight":case "milightv6":b=this._processMilightCommands(a,f,e,d);break;case "lightify":b=this._processOsramCommands(a,f,e,d);break;case "harmony":b=this._processHarmonyCommands(a,f,e,d);break;case "pioneer":case "onkyo":case "denon":case "yamaha":b=this._processHarmonyCommands(a,f,e,d);break;case "mcontrol":b=this._processMcontrolCommands(a,f,e,d);break;case "fibaro":b=this._processFibaroHCCommands(a,f,e,d);break;case "tado":b=this._processTadoCommands(a,f,e,d);
break;case "netatmo":b=this._processNetatmoCommands(a,f,e,d);break;default:b=this._processCommandsFromMap(null,a,f,e,d)}e.commands=b}a.info.status&&0<Object.keys(a.info.status).length&&(e.states=a.info.status);return e};e.prototype._resovleDeviceID=function(a,b,c){var f=a.name;c=c[a.room];if("_cameras"==f.substr(0,8)){c=null;var d=f.indexOf(":");f=f.substr(d+1)}"_progs&sysvars"==c&&(c=b[a.info.gateway],"gw"==f.substr(0,2)&&(d=f.indexOf("_"),f=f.substr(d+1)));b=(c?c+" ":"")+(f?f:"");a.cloud.alias&&
(b=a.cloud.alias);return b};e.prototype._resovleBaseUrl=function(a,b){var c=a,f=a.indexOf(":");-1!=f&&(c=a.substr(0,f));return"https://"+c+"/rapi/"+b};e.prototype.getAccessToken=function(a,b){if(a)if("aio"!=a.sys&&"neoserver"!=a.sys)b&&b(Error("gateway type invalid"));else{var c=this,f=require("xnm.aio.gateway.js");if("neoserver"==a.sys){a=JSON.parse(JSON.stringify(a));a.sys="aio";a.version="EA";var d=f.resolveGateway(a,!0)}else d=f.resolveGateway(a);d?f.Admin.getGatewaySID(d,function(g,e){g?(c._logger.log("warn",
"get gateway sid error:"+g.message),g.code="50001",g.message="get gateway sid error:"+g.message,b&&b(g)):e?a.password?f.Admin.V5.getInfo(d,function(d,f){d?(c._logger.log("warn","get gateway info error:"+d.message),d.message="get gateway info error:"+d.message,d.code="50101",b&&b(d)):f&&f.server?!f.cfg||parseInt(f.cfg,16)&64?(c._logger.log("warn","gateway cloud server is deactivated"),d=Error("gateway cloud server is deactivated"),d.code="50103",b&&b(d)):c._getAccessToken(f.server,e,a.password,!1,
function(d,g){d?(d=Error("get accesss token error:"+d.message),d.code="50003",b&&b(d)):g?b&&b(null,g,f.server,e):c._getAccessToken(f.server,e,a.password,!0,function(a,d){a?(a=Error("generate accesss token error:"+a.message),a.code="50004",b&&b(a)):d?b&&b(null,d,f.server,e):b&&b(Error("access token empty"))})}):(c._logger.log("warn","gateway has no cloud server"),d=Error("gateway has no cloud server"),d.code="50102",b&&b(d))}):(g=Error("gateway has no password"),g.code="50002",b&&b(g)):(g=Error("gateway has no sid"),
g.code="50002",b&&b(g))}):b&&b(Error("gateway json invalid"))}else b&&b(Error("gateway json is null"))};e.prototype.generateConfig=function(a,b,c,f,d,g,e,h,k,l){var p=require("url").parse("https://"+h),n=function(a){for(var b=a.length,d={};b--;){var c=a[b];d[c.index]=c.name}return d}(b),q=function(a){for(var b=a.length,d={};b--;){var c=a[b];d[c.index]=c.name}return d}(c);c={};h=this._resovleBaseUrl(h,g);b=k=null;for(var t=0;t<a.length;t++){var u=a[t];!u||!u.info||"cloudservice"==u.info.sys&&u.info.module||
"_webpages"==u.name.substr(0,9)||(k=this._resovleDeviceID(u,q,n),b=this._convertDeviceToCloudFormat(u,k,h,d,c),b.data={mod:"mediola",ccs:p.hostname,accessToken:g,deviceID:u.index},c[k]=b)}a={};d=null;if(f&&f.groups)for(g=0;g<f.groups.length;g++)if((p=f.groups[g])&&p.macros&&0!=p.macros.length)for(n=p.name,q=0;q<p.macros.length;q++)if(b=p.macros[q],k=b.name,b.cloud&&b.cloud.enabled){k=(n?n+" ":"")+(k?k:"");b.cloud.alias&&(k=b.cloud.alias);d="";t=k.toLowerCase();u="on off an aus up down auf ab hoch runter ein".split(" ");
for(var v=0;v<u.length;v++){var w=u[v],x=t.substr(t.length-w.length);t.length>w.length&&x==w&&(d=k.substr(0,t.length-w.length).trim(),a[d]||(a[d]=[]),a[d].push({original_id:k,command:w}))}b={name:k,type:"scene",baseurl:h,local:"http://"+e.ip+(e.port?":"+e.port:""),commands:{on:{type:"POST",url:"/cmd",data:{XC_FNC:"DoMacroRM",groupIdx:p.index,macroIdx:b.index}}}};c[k]=b}for(d in a){f=a[d];b={name:d,type:"scene",baseurl:h,local:"http://"+e.ip+(e.port?":"+e.port:""),commands:{}};for(k=0;k<f.length;k++)if((g=
f[k])&&g.original_id&&g.command&&(p=g.original_id,n=c[p],delete c[p],n)){p=n.commands.on;n=g.command;switch(g.command){case "on":case "an":case "ein":n="on";break;case "off":case "aus":n="off";break;case "up":case "auf":case "hoch":n="up";break;case "down":case "ab":case "runter":n="down"}b.commands[n]=p}c[d]=b}l&&l(null,c)};e.prototype.uploadConfig=function(a,b,c){b={type:"mediola",configuration:b};var f=a.ip;f||(f=require("url").parse(e.REMOTE_SERVER).host);var d=a.port;d||(d=443);var g=a.username?
a.username:"";a=a.password?a.password:"";a={host:f,port:d,path:"/alexa/setConfiguration",method:"POST",timeout:3E4,auth:g+":"+a,user:g,password:a,headers:{"Content-Type":'text/xml; charset="utf-8"',Authorization:"Basic "+(new Buffer(g+":"+a)).toString("base64"),Connection:"close"}};var q=this;this._logger.log("trace","upload config to:"+JSON.stringify(a));a=require("https").request(a,function(a){a.setEncoding("utf8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){if(200==a.statusCode){q._logger.log("trace",
"upload config reponse:"+b);try{var d=JSON.parse(b);if(d.XC_ERR){var f=Error(d.XC_ERR.msg);f.code=d.XC_ERR.code;c&&c(f)}else d.XC_SUC&&c&&c()}catch(n){c&&c(n)}}else q._logger.log("warn","upload config error +"+a.statusCode+":"+b),c&&c(Error("http response:"+a.statusCode))})});if(a.on)a.on("error",function(a){q._logger.log("warn","upload config error:"+a.message);c&&c(a);c=null});a.write(JSON.stringify(b));a.end()};e.prototype.setCustomCommandMap=function(a){this._customMap=a};e.prototype.loadCustomComamndMap=
function(a,b){var c=require("fs-extra");c.ensureFile(a,function(f){f?b&&b(null,{}):c.readFile(a,"utf8",function(a,c){if(a)b&&b(a);else if(c)try{var d=JSON.parse(c);b&&b(null,d)}catch(h){b&&b(null,{})}else b&&b(null,{})})})};e.prototype.saveCustomCommandMap=function(a,b,c){var f=require("fs-extra");f.ensureFile(a,function(d){if(d)c&&c(null,{});else try{var e=JSON.stringify(b,null,2);f.writeFile(a,e,function(a){c&&c(a)})}catch(q){c&&c(q)}})};return e}();
m.aio.voicemanager.Handler=function(){var e=function(){this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.Handler");this._devicemanager=this._configmanager=null;this._alexaHandler=new m.aio.voicemanager.AlexaHandler;this.CLOUD_PROTOCOL="https";this.CLOUD_HOST="webservice.mediola.com";this.CLOUD_PORT=443;this.CLOUD_PATH="/account/bindLicense"};e.prototype.CUSTOM_CMD_MAP_FILE="cloud_service_command.map";e.prototype.init=function(a,b,c,f){this._configmanager=a;this._devicemanager=b;this._macromanager=
c;f&&f()};e.prototype.loadCustomComamndMap=function(a,b){var c=this;this._configmanager.trace("/config/tenants/"+a,function(a,d){a?(a.code="50100",b&&b(a)):(a=require("path"),(d=d.getFolderPath())?(d=a.join(d,c.CUSTOM_CMD_MAP_FILE),c._alexaHandler.loadCustomComamndMap(d,function(a,d){b&&b(a,d)})):(a=Error("tenant folder is null"),a.code="50100",b&&b(a)))})};e.prototype.saveCustomComamndMap=function(a,b,c){var f=this;this._configmanager.trace("/config/tenants/"+a,function(a,e){a?(a.code="50100",c&&
c(a)):(a=require("path"),e=e.getFolderPath(),e=a.join(e,f.CUSTOM_CMD_MAP_FILE),f._alexaHandler.saveCustomCommandMap(e,b,function(a){c&&c(a)}))})};e.prototype.getCloudDeviceConfig=function(a,b,c){var f=null;if(b){var d=require("xnm.aio.cloudservice.js").resolveGateway(b);d?this._getCloudDevicesFromDB(a,d,function(a,b){a?c&&c(a):b&&0!=b.length?(a=b.map(function(a){a=a.info;delete a.gateway;delete a.commands;delete a.states;return a}),d.toCloudDevice(a,function(a,d){if(a)a.code=40003,c&&c(a);else if(d&&
0!=d.length){a={};for(var f=0;f<b.length;f++){var e=b[f];if(e)for(var g=0;g<d.length;g++){var h=d[g];h&&(h.data&&e.info.module==h.data.mod&&e.info.connection==h.data.connection&&e.info.id==h.data.id?(h.name=e.__cloudref,a[e.__cloudref]=h):e.info.module==h.mod&&e.info.connection==h.connection&&e.info.id==h.id&&(h.name=e.__cloudref,h.data={mod:h.mod,connection:h.connection,id:h.id},delete h.mod,delete h.connection,delete h.id,a[e.__cloudref]=h))}}c&&c(null,a)}else c&&c(null,{})})):c&&c(null,{})}):(f=
Error("cloud json invalid"),f.code=4E4,c&&c(f))}else f=Error("cloud json invalid"),f.code=4E4,c&&c(f)};e.prototype._getCloudDevicesFromDB=function(a,b,c){var e=function(a,b){for(var d=0;d<b.length;d++){var c=b[d];if(c&&c.index==a)return c}return null},d=this,g=require("xnm.aio.cloudservice.js"),q={filter:"prop","info.sys":"cloudservice","cloud.enabled":!0};this._devicemanager.execute("read",a,"device",q,function(f,k){f?(f.code=40001,c&&c(f)):k&&0!=k.length?(q={filter:"prop","info.sys":"cloudservice"},
d._devicemanager.execute("read",a,"gateway",q,function(f,h){f?(f.code=40001,c&&c(f)):h&&0!=h.length?d._devicemanager.execute("read",a,"room",null,function(a,d){if(a)a.code=40001,c&&c(a);else if(d&&0!=d.length){a=[];for(var f=0;f<k.length;f++){var l=k[f];if(l&&l.info&&l.info.gateway){var n=e(l.info.gateway,h);if(n&&n.info&&(n=g.resolveGateway(n.info))){if(!n.equalsTo(b)){a=Error("cloud device "+l.index+" belongs to another account");a.code=40002;c&&c(a);return}var p=e(l.room,d);p&&(n=l.name,p=p.name,
n=(p?p+" ":"")+(n?n:""),l.cloud.alias&&(n=l.cloud.alias),l=JSON.parse(JSON.stringify(l)),l.__cloudref=n,a.push(l))}}}c&&c(null,a)}else c&&c(null,[])}):c&&c(null,[])})):c&&c(null,[])})};e.prototype.previewAlexaConfig=function(a,b,c,f,d){if(c&&c.username)if(f){var e=this;this.getCloudDeviceConfig(a,c,function(c,g){c?d&&d(c):e._alexaHandler.getAccessToken(f,function(c,h,p,n){c?d&&d(c):e._getDeviceWithCommandAndStatus(a,function(c,k){c?(c.code="50005",d&&d(c)):e._devicemanager.execute("read",a,"gateway",
null,function(c,l){c?(c.code="50007",d&&d(c)):e._devicemanager.execute("read",a,"room",null,function(c,q){c?(c.code="50008",d&&d(c)):e._macromanager.execute(a,"read",null,null,null,function(c,r){c?(c.code="50009",d&&d(c)):e.loadCustomComamndMap(a,function(a,c){if(a||!c)c=null;e._alexaHandler.setCustomCommandMap(c);e._alexaHandler.generateConfig(k,q,l,r,b,h,f,p,n,function(a,b){if(a)e._logger.log("warn","generate configuration error:"+a.message),a.code="50010",d&&d(a);else{a={};var c;if(g)for(c in g)a[c]=
g[c];if(b)for(c in b)a[c]=b[c];(b=Object.keys(a))&&0!=b.length?d&&d(null,a):(e._logger.log("warn","generate empty configuration"),a=Error("empty configuration"),a.code="50011",d&&d(a))}})})})})})})})})}else d&&d(Error("gateway invalid"));else d&&d(Error("username is null"))};e.prototype.exportAlexaConfig=function(a,b,c,e,d){if(c&&c.username)if(e){var f=this;this.previewAlexaConfig(a,b,c,e,function(b,e){if(b)d&&d(b);else{var g={};if(e)for(var h in e)b=e[h],delete b.sys,delete b.module,g[h]=b;f._configmanager.execute("read",
"/config/tenants/"+a,null,function(a,b){if(a)a.code="50013",d&&d(a);else{var e=null;b.license&&"normal"==b.license.type&&b.license.valid&&b.license.license&&(e=b.license.license);f._alexaHandler.uploadConfig(c,g,function(a){a?(f._logger.log("warn","upload configuration error:"+a.message),a.code="000009"==a.code?"50014":"50012",d&&d(a)):e?f.bindLicense(c.username,c.password,e,function(a){a&&f._logger.log("warn","bind user license error:"+a.message);d&&d(null,g)}):d&&d(null,g)})}})}})}else d&&d(Error("gateway invalid"));
else d&&d(Error("username is null"))};e.prototype._getDeviceWithCommandAndStatus=function(a,b){var c={filter:"prop","cloud.enabled":!0},e=this,d={};this._devicemanager.execute("read",a,"device",{filter:"ui",f_ui_elem:"*",f_ui_type:"command"},function(f,q){if(f)b(f);else{if(q&&0<q.length)for(f=0;f<q.length;f++){var g=q[f];g&&g.cloud&&g.cloud.enabled&&g.info&&g.info.command&&0!=g.info.command.length&&(d[g.index]=g)}e._devicemanager.execute("read",a,"device",c,function(c,f){if(c)b(c);else if(f&&0!=f.length){var g=
0,h=function(c,k){!c&&k&&(d[f[g].index]?d[f[g].index].info.status=k.states:(d[f[g].index]=f[g],f[g].info.status=k.states));g++;g<f.length?e._devicemanager.toGeneralDevice(a,f[g].index,!1,h):(c=Object.values(d),b(null,c))};e._devicemanager.toGeneralDevice(a,f[g].index,!1,h)}else c=Object.values(d),b(null,c)})}})};e.prototype.bindLicense=function(a,b,c,e){b={host:this.CLOUD_HOST,port:this.CLOUD_PORT,path:this.CLOUD_PATH+"?license="+c,method:"GET",timeout:3E4,auth:a+":"+b,user:a,password:b,headers:{"Content-Type":'text/xml; charset="utf-8"',
Authorization:"Basic "+(new Buffer(a+":"+b)).toString("base64"),Connection:"close"}};var d=this;this._logger.log("trace","bind license "+c+" to:"+a);a=require(this.CLOUD_PROTOCOL).request(b,function(a){a.setEncoding("utf8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){200==a.statusCode?(d._logger.log("trace","bind license success"),e&&e()):(d._logger.log("warn","bind license success +"+a.statusCode+":"+b),e&&e(Error("http response:"+a.statusCode)));e=null})});if(a.on)a.on("error",
function(a){d._logger.log("warn","upload config error:"+a.message);e&&e(a);e=null});a.setTimeout(3E4,function(){e&&e(Error("timeout"));e=null});a.end()};e.prototype.uploadDeviceDB=function(a,b,c,e){a="/xhub/xhubsync/upload2?gatewayid="+a+"&fileName=device_db&auth=";b.password&&(a+=b.password);b={host:b.ip,port:b.port,path:a,method:"POST",timeout:3E4,headers:{"Content-Type":"text/plain",Connection:"close"}};var d=this;this._logger.log("trace","upload device_db to:"+JSON.stringify(b));b=require("http").request(b,
function(a){a.setEncoding("utf8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){if(200==a.statusCode){d._logger.log("trace","upload config reponse:"+b);try{"success"==JSON.parse(b).status?e&&e():e&&e(Error("failed to upload device_db"))}catch(h){e&&e(h)}}else d._logger.log("warn","upload config error +"+a.statusCode+":"+b),e&&e(Error("http response:"+a.statusCode))})});if(b.on)b.on("error",function(a){d._logger.log("warn","upload device_db error:"+a.message);e&&e(a);e=null});b.write(JSON.stringify(c));
b.end()};e.prototype.exportV5Config=function(a,b,c,e,d){if(c&&c.username)if(e){var f=this;(new m.aio.voicemanager.CloudConfigHandler.V5(this._devicemanager)).exportConfig(a,c,function(b,e){b?(f._logger.log("error","generate configuration error:"+b.message),b.code="50012",d&&d(b)):f._configmanager.execute("read","/config/tenants/"+a,null,function(a,b){if(a)a.code="50013",d&&d(a);else{var g=null;b.license&&"normal"==b.license.type&&b.license.valid&&b.license.license&&(g=b.license.license);f._alexaHandler.uploadConfig(c,
e,function(a){a?(f._logger.log("warn","upload configuration error:"+a.message),a.code="000009"==a.code?"50014":"50012",d&&d(a)):g?f.bindLicense(c.username,c.password,g,function(a){a&&f._logger.log("warn","bind user license error:"+a.message);d&&d(null,e)}):d&&d(null,e)})}})})}else d&&d(Error("gateway invalid"));else d&&d(Error("username is null"))};return e}();"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.voicemanager.Handler);
