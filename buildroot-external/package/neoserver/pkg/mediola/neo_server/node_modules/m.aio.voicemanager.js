var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(n){var c=0;return function(){return c<n.length?{done:!1,value:n[c++]}:{done:!0}}};$jscomp.arrayIterator=function(n){return{next:$jscomp.arrayIteratorImpl(n)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(n,c,b){if(n==Array.prototype||n==Object.prototype)return n;n[c]=b.value;return n};$jscomp.getGlobal=function(n){n=["object"==typeof globalThis&&globalThis,n,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var c=0;c<n.length;++c){var b=n[c];if(b&&b.Math==Math)return b}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(n,c){var b=$jscomp.propertyToPolyfillSymbol[c];if(null==b)return n[c];b=n[b];return void 0!==b?b:n[c]};
$jscomp.polyfill=function(n,c,b,a){c&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(n,c,b,a):$jscomp.polyfillUnisolated(n,c,b,a))};$jscomp.polyfillUnisolated=function(n,c,b,a){b=$jscomp.global;n=n.split(".");for(a=0;a<n.length-1;a++){var d=n[a];if(!(d in b))return;b=b[d]}n=n[n.length-1];a=b[n];c=c(a);c!=a&&null!=c&&$jscomp.defineProperty(b,n,{configurable:!0,writable:!0,value:c})};
$jscomp.polyfillIsolated=function(n,c,b,a){var d=n.split(".");n=1===d.length;a=d[0];a=!n&&a in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var e=0;e<d.length-1;e++){var g=d[e];if(!(g in a))return;a=a[g]}d=d[d.length-1];b=$jscomp.IS_SYMBOL_NATIVE&&"es6"===b?a[d]:null;c=c(b);null!=c&&(n?$jscomp.defineProperty($jscomp.polyfills,d,{configurable:!0,writable:!0,value:c}):c!==b&&(void 0===$jscomp.propertyToPolyfillSymbol[d]&&($jscomp.propertyToPolyfillSymbol[d]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(d):
$jscomp.POLYFILL_PREFIX+d),$jscomp.defineProperty(a,$jscomp.propertyToPolyfillSymbol[d],{configurable:!0,writable:!0,value:c})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(n){if(n)return n;var c=function(d,e){this.$jscomp$symbol$id_=d;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:e})};c.prototype.toString=function(){return this.$jscomp$symbol$id_};var b=0,a=function(d){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new c("jscomp_symbol_"+(d||"")+"_"+b++,d)};return a},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(n){if(n)return n;n=Symbol("Symbol.iterator");for(var c="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),b=0;b<c.length;b++){var a=$jscomp.global[c[b]];"function"===typeof a&&"function"!=typeof a.prototype[n]&&$jscomp.defineProperty(a.prototype,n,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return n},"es6",
"es3");$jscomp.iteratorPrototype=function(n){n={next:n};n[Symbol.iterator]=function(){return this};return n};$jscomp.iteratorFromArray=function(n,c){n instanceof String&&(n+="");var b=0,a=!1,d={next:function(){if(!a&&b<n.length){var e=b++;return{value:c(e,n[e]),done:!1}}a=!0;return{done:!0,value:void 0}}};d[Symbol.iterator]=function(){return d};return d};$jscomp.polyfill("Array.prototype.keys",function(n){return n?n:function(){return $jscomp.iteratorFromArray(this,function(c){return c})}},"es6","es3");
$jscomp.owns=function(n,c){return Object.prototype.hasOwnProperty.call(n,c)};$jscomp.polyfill("Object.values",function(n){return n?n:function(c){var b=[],a;for(a in c)$jscomp.owns(c,a)&&b.push(c[a]);return b}},"es8","es3");var m=m||{};m.aio=m.aio||{};m.aio.voicemanager=m.aio.voicemanager||{};
m.aio.voicemanager.Util={clearHttpOptionForLog:function(n){try{var c=JSON.parse(JSON.stringify(n));c.auth&&(c.auth="xxxxxx:xxxxxx");if(c.headers)for(var b in headers)if(b&&"authorization"==b.toLocaleLowerCase()){var a=headers[b];if(a){var d=a.indexOf(" ");headers[b]=-1==d?"xxxxxx":a.substr(0,d)+" xxxxxx"}}return c}catch(e){return n}}};
m.aio.voicemanager.CloudConfigHandler=function(){var n=function(b,a){this._devicemanager=b;this._macromanager=a};n.prototype._getCloudDeviceConfig=function(b,a,d){var e=null;if(a){var g=require("xnm.aio.cloudservice.js").resolveGateway(a);g?this._getCloudDevicesFromDB(b,g,function(k,h){k?d&&d(k):h&&0!=h.length?(k=h.map(function(f){f=f.info;delete f.gateway;delete f.commands;delete f.states;return f}),g.toCloudDevice(k,function(f,l){if(f)f.code=40003,d&&d(f);else if(l&&0!=l.length){f={};for(var q=
0;q<h.length;q++){var p=h[q];if(p)for(var r=0;r<l.length;r++){var t=l[r];t&&(t.data&&p.info.module==t.data.mod&&p.info.connection==t.data.connection&&p.info.id==t.data.id?(t.name=p.__cloudref,f[p.__cloudref]=t):p.info.module==t.mod&&p.info.connection==t.connection&&p.info.id==t.id&&(t.name=p.__cloudref,t.data={mod:t.mod,connection:t.connection,id:t.id},delete t.mod,delete t.connection,delete t.id,f[p.__cloudref]=t))}}d&&d(null,f)}else d&&d(null,{})})):d&&d(null,{})}):(e=Error("cloud json invalid"),
e.code=4E4,d&&d(e))}else e=Error("cloud json invalid"),e.code=4E4,d&&d(e)};n.prototype._mergeConfig=function(b,a){var d={},e;if(b)for(e in b)d[e]=b[e];if(a)for(e in a)d[e]=a[e];return d};n.prototype._getCloudDevicesFromDB=function(b,a,d){var e=function(f,l){for(var q=0;q<l.length;q++){var p=l[q];if(p&&p.index==f)return p}return null},g=this,k=require("xnm.aio.cloudservice.js"),h={filter:"prop","info.sys":"cloudservice","cloud.enabled":!0};this._devicemanager.execute("read",b,"device",h,function(f,
l){f?(f.code=40001,d&&d(f)):l&&0!=l.length?(h={filter:"prop","info.sys":"cloudservice"},g._devicemanager.execute("read",b,"gateway",h,function(q,p){q?(q.code=40001,d&&d(q)):p&&0!=p.length?g._devicemanager.execute("read",b,"room",null,function(r,t){if(r)r.code=40001,d&&d(r);else if(t&&0!=t.length){r=[];for(var u=0;u<l.length;u++){var v=l[u];if(v&&v.info&&v.info.gateway){var w=e(v.info.gateway,p);if(w&&w.info&&(w=k.resolveGateway(w.info))){if(!w.equalsTo(a)){r=Error("cloud device "+v.index+" belongs to another account");
r.code=40002;d&&d(r);return}var y=e(v.room,t);y&&(w=v.name,y=y.name,w=(y?y+" ":"")+(w?w:""),v.cloud.alias&&(w=v.cloud.alias),v=JSON.parse(JSON.stringify(v)),v.__cloudref=w,r.push(v))}}}d&&d(null,r)}else d&&d(null,[])}):d&&d(null,[])})):d&&d(null,[])})};n.prototype._getCloudEnabledDevices=function(b,a){this._devicemanager.execute("read",b,"device",{filter:"prop","cloud.enabled":!0},function(d,e){a&&a(d,e)})};n.prototype._getGateways=function(b,a){this._devicemanager.execute("read",b,"gateway",null,
function(d,e){a&&a(d,e)})};n.prototype._getRooms=function(b,a){this._devicemanager.execute("read",b,"room",null,function(d,e){a&&a(d,e)})};n.prototype._getGatewayInfo=function(b,a){if(b)if("aio"!=b.sys&&"neoserver"!=b.sys)a&&a(Error("gateway type invalid"));else{var d=this,e=require("xnm.aio.gateway.js");if("neoserver"==b.sys){b=JSON.parse(JSON.stringify(b));b.sys="aio";b.version="EA";var g=e.resolveGateway(b,!0)}else g=e.resolveGateway(b);g?e.Admin.getGatewaySID(g,function(k,h){k?(d._logger.log("warn",
"get gateway sid error:"+k.message),k.code="50001",k.message="get gateway sid error:"+k.message,a&&a(k)):h?b.password?e.Admin.V5.getInfo(g,function(f,l){f?(d._logger.log("warn","get gateway info error:"+f.message),f.message="get gateway info error:"+f.message,f.code="50101",a&&a(f)):l&&l.server?!l.cfg||parseInt(l.cfg,16)&64?(d._logger.log("warn","gateway cloud server is deactivated"),f=Error("gateway cloud server is deactivated"),f.code="50103",a&&a(f)):d._getAccessToken(l.server,h,b.password,!1,
function(q,p){q?(q=Error("get accesss token error:"+q.message),q.code="50003",a&&a(q)):p?a&&a(null,p,l.server,h):d._getAccessToken(l.server,h,b.password,!0,function(r,t){r?(r=Error("generate accesss token error:"+r.message),r.code="50004",a&&a(r)):t?a&&a(null,t,l.server,h):a&&a(Error("access token empty"))})}):(d._logger.log("warn","gateway has no cloud server"),f=Error("gateway has no cloud server"),f.code="50102",a&&a(f))}):(k=Error("gateway has no password"),k.code="50002",a&&a(k)):(k=Error("gateway has no sid"),
k.code="50002",a&&a(k))}):a&&a(Error("gateway json invalid"))}else a&&a(Error("gateway json is null"))};n.prototype._getAccessToken=function(b,a,d,e,g){b=this._parseCCS(b);var k=b.port;"https"==b.protocol&&80==k&&(k=443);a={host:b.host,port:k,path:"/getAccessToken?sid="+a,method:"GET",timeout:3E4,auth:"user:"+d,user:"user",password:d,headers:{Authorization:"Basic "+(new Buffer("user:"+d)).toString("base64")}};e&&(a.path+="&force=1");this._logger.log("trace","send get access token to:"+JSON.stringify(m.aio.voicemanager.Util.clearHttpOptionForLog(a)));
var h=this,f=require(b.protocol).request(a,function(l){l.setEncoding("utf8");var q="";l.on("data",function(p){q+=p});l.on("end",function(){if(200==l.statusCode){h._logger.log("trace","get access token reponse:"+q);try{var p=JSON.parse(q);p.XC_ERR?g&&g(Error(p.XC_ERR.msg)):p.XC_SUC?g&&g(null,p.XC_SUC.at):g&&g(Error("invalid response"))}catch(r){g&&g(r)}}else h._logger.log("warn","get access token error +"+l.statusCode+":"+q),g&&g(Error("http response:"+l.statusCode))})});if(f.on)f.on("error",function(l){h._logger.log("warn",
"get access token error:"+l.message);g&&g(l);g=null});f.setTimeout&&f.setTimeout(5E3,function(){f.abort();h._logger.log("warn","get access token timeout");g&&g(Error("http timeout"));g=null});f.end()};n.prototype._parseCCS=function(b){var a=b.indexOf(":");if(-1==a)return{protocol:"https",host:b,port:443};var d=b.substr(0,a);b=b.substr(a+1);8080==b?b=8443:80==b&&(b=443);return{protocol:"https",host:d,port:b}};var c=function(b,a){n.call(this,b,a);this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.V5ConfigHandler");
this._targetGatewayJSON=null;this._gatewayDetail={};this._currentMacroGatewayIndex=this._tenantIdx=null};c.prototype=new n;c.prototype.constructor=c;c.prototype.setTargetGateway=function(b){this._targetGatewayJSON=b};c.prototype.exportConfig=function(b,a,d){var e=this;this._gatewayDetail={};this._tenantIdx=b;this._currentMacroGatewayIndex=null;this._getCloudDeviceConfig(b,a,function(g,k){g?d&&d(g):e._getGatewayDeviceConfig(b,function(h,f){h?d&&d(h):e._getMacrosConfig(b,function(l,q){l?d&&d(l):(l=
e._mergeConfig(k,f),l=e._mergeConfig(q,l),d&&d(null,l))})})})};c.prototype._isSameAsTargetGateway=function(b){return this._targetGatewayJSON?b.ip==this._targetGatewayJSON.ip&&b.sid==this._targetGatewayJSON.sid:!1};c.prototype._getGatewayDeviceConfig=function(b,a){var d=function(g,k){if(!k||0==k.length)return null;for(var h=k.length;h--;){var f=k[h];if(f&&f.index==g)return f}return null},e=this;this._getDevicesDetail(b,function(g,k){if(g)a&&a(g);else{var h=k.devices,f=k.gateways,l=k.rooms,q={};for(g=
0;g<f.length;g++)(k=f[g])&&k.info&&"aio"==k.info.sys&&k.info.version&&!("C"!=k.info.version.charAt(0)&&"E"!=k.info.version.charAt(0)||"EA"==k.info.version||e._targetGatewayJSON&&!e._isSameAsTargetGateway(k.info))&&(q[k.index]=k);0==Object.keys(q)?a&&a(null,{}):e._getGatewaysDetail(Object.values(q),function(p){if(p)a&&a(p);else if(h&&0!=h.length){for(var r=[],t=0;t<h.length;t++)if((p=h[t])&&p.info&&"aio"==p.info.sys&&p.info.gateway){var u=d(p.info.gateway,f);if(u&&q[p.info.gateway]){var v=d(p.room,
l);r.push({device:p,gateway:u,room:v})}}if(0==r.length)a&&a(null,{});else{var w={};t=0;var y=function(z,x){!z&&x&&(w=e._mergeConfig(w,x));t++;t<r.length?e._genDeviceConfig(r[t].device,r[t].gateway,r[t].room,y):a&&a(null,w)};e._genDeviceConfig(r[t].device,r[t].gateway,r[t].room,y)}}else a&&a(null,{})})}})};c.prototype._genDeviceConfig=function(b,a,d,e){if(b&&b.info&&b.info.sys)if(a&&a.index){var g=this._gatewayDetail[a.index];if(g){var k=b.info.sys,h=this._devicemanager.getModule(k);h&&h.devicemanager&&
h.devicemanager.toGeneralDevice?(k=h.devicemanager.toGeneralDevice(b.info,null,"v5"))?(k.name=this._genDeviceName(b,d),k.local="http://"+a.info.ip+(a.info.port?":"+a.info.port:""),k.baseurl=this._genBaseUrl(g),k.data||(k.data={}),k.data.sid=g.sid,b={},b[k.name]=k,e&&e(null,b)):e&&e(null,null):e&&e(Error("sys "+k+" can not be convert to general device"))}else e&&e(Error("no gateway detail info"))}else e&&e(Error("invalid gateway json"));else e&&e(Error("invalid device json"))};c.prototype._genDeviceName=
function(b,a){if(b.cloud&&b.cloud.alias)return b.cloud.alias;b=b.name;a=a.name;return b?a?a+" "+b:b:a};c.prototype._genBaseUrl=function(b){var a=this._parseCCS(b.ccs);return a.protocol+"://"+a.host+"/rapi/"+b.token};c.prototype._getDevicesDetail=function(b,a){var d=this;this._getCloudEnabledDevices(b,function(e,g){e?a&&a(e):d._getGateways(b,function(k,h){k?a&&a(k):d._getRooms(b,function(f,l){a&&a(f,{devices:g,gateways:h,rooms:l})})})})};c.prototype._getGatewaysDetail=function(b,a){var d=this,e=0,
g=function(k,h,f,l){k?a&&a(k):(d._gatewayDetail[b[e].index]={sid:l,ccs:f,token:h},e++,e<b.length?d._getGatewayInfo(b[e].info,g):a&&a())};d._getGatewayInfo(b[e].info,g)};c.prototype._getMacrosConfig=function(b,a){var d=this;this._macromanager.execute(b,"read",null,null,null,function(e,g){if(e)a&&a(e);else if(g&&g.groups&&0!=g.groups.length){var k={};for(e=0;e<g.groups.length;e++){var h=g.groups[e];if(h&&h.macros&&0<h.macros.length){var f=0,l=function(q,p,r){!q&&p&&r&&(k[p]=r);f++;f<h.macros.length&&
d._getMacroConfig(h,h.macros[f],l)};d._getMacroConfig(h,h.macros[f],l)}}a&&a(null,k)}else a&&a(null,{})})};c.prototype._getMacroConfig=function(b,a,d){if(a&&a.cloud&&a.cloud.enabled){var e=b.name+" "+a.name;a.cloud.alias&&(e=a.cloud.alias);var g={name:e,type:"scene",commands:{on:{type:"POST",url:null,data:[]}}};this._currentMacroGatewayIndex=null;var k=this;if(a.commands&&0<a.commands.length){var h=0,f=function(l,q,p){!l&&q&&g.commands.on.data.push(q);h++;h<a.commands.length?k._convertMacroCommand(a.commands[h],
f):(l=k._gatewayDetail[k._currentMacroGatewayIndex])?(g.commands.on.url=k._genBaseUrl(l)+"/macro",d&&d(null,e,g)):d&&d(Error("no main gateway"))};this._convertMacroCommand(a.commands[h],f)}}else d&&d(null,null,null)};c.prototype._convertMacroCommand=function(b,a){if(b&&b.classid)switch(b.classid){case "sleep":a(null,{P:b.time});break;case "command":if(!b.action||!b.action.device){a(Error("invalid macro device command"));break}this._convertMacroDeviceCommand(b,a);break;default:a(Error("unknown macro command"))}else a(Error("invalid macro command"))};
c.prototype._convertMacroDeviceCommand=function(b,a){var d=this;this._devicemanager.execute("read",this._tenantIdx,"device",{filter:"prop",index:b.action.device.index},function(e,g){if(e)a(e);else if(g&&0!=g.length){var k=g[0];k&&k.info&&k.info.sys?"aio"==k.info.sys?d._devicemanager.execute("read",d._tenantIdx,"gateway",{filter:"prop",index:k.info.gateway},function(h,f){if(h)a(h);else if(f&&0!=f.length)if((h=f[0])&&h.info&&h.index)if(d._gatewayDetail[h.index]&&!d._currentMacroGatewayIndex&&(d._currentMacroGatewayIndex=
h.index),f=require("xnm.aio.gateway.js").devicemanager.getSystem(k.info,h.info)){var l={value:b.action.value,ext:b.action.ext};if(f.buildQuery)if(f=f.buildQuery(h.info,k.info,l)){l={};if("SendGenericCmd"==f.XC_FNC){var q="/cmd?XC_FNC=SendGenericCmd&id="+f.id;if(f.data)for(var p in f.data)q+="&"+p+"="+(null==f.data[p]||void 0==f.data[p]?"":encodeURIComponent(f.data[p]))}else if("/api/command"==f.fnc)q="/api/command?json=",f.data&&(q+=encodeURIComponent(JSON.stringify(f.data)));else for(p in q="/cmd?",
f)q+="&"+p+"="+(null==f[p]||void 0==f[p]?"":encodeURIComponent(f[p]));h.index==d._currentMacroGatewayIndex?l.C=q:l.A={host:h.info.ip,cmd:q};a(null,l)}else a(Error("invalid device command"));else a(Error("system do not support command"))}else a(Error("unknown device type"));else a(Error("invalid gateway json"));else a(Error("no such gateway"))}):a(null,null):a(Error("invalid device json"))}else a(Error("no such device"))})};return{V5:c}}();
m.aio.voicemanager.AlexaHandler=function(){var n=function(){this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.Cloud");this._customMap=null};n.LANG=["en","de"];n.MAP={on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],up:["up","up"],down:["down","down"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],dimup:["up","up"],dimdown:["down","down"],dimto:["value","value"],"move up":["up","up"],"move down":["down","down"],"move to":["value","value"],moveup:["up",
"up"],movedown:["down","down"],moveto:["value","value"],stop:["off","off"],brightness:["value","value"],"brightness up":["up","up"],"brightness down":["down","down"],"temperature up":["up","up"],"temperature down":["down","down"],"temperature to":["value","value"],"set temperature":["value","value"],temperature:["value","value"],"set point":["value","value"],"mode auto":["auto","auto"],"set auto mode":["auto","auto"],"auto mode":["auto","auto"],auto:["auto","auto"],"mode manu":["manu","manu"],"set manual mode":["manu",
"manu"],"manu mode":["manu","manu"],manu:["manu","manu"],"mode boost":["boost","boost"],"set boost mode":["boost","boost"],"boost mode":["boost","boost"],"boost on":["boost","boost"],boost:["boost","boost"],white:["white","wei\u00df"],red:["red","rot"],purple:["purple","violett"],blue:["blue","blau"],cyan:["cyan","cyan"],green:["green","gr\u00fcn"],yellow:["yellow","gelb"],orange:["orange","orange"],mode:["mode","mode"],"power on":["on","on"],"power off":["off","off"],poweron:["on","on"],poweroff:["off",
"off"],volumeup:["up","up"],volumedown:["down","down"],"volume up":["up","up"],"volume down":["down","down"],"volume to":["value","value"]};n.HM_MAP={"short press":["short press","kurz dr\u00fccken"],"long press":["long press","lange dr\u00fccken"],"set value":["value","value"],red:["red","rot"],green:["green","gr\u00fcn"],orange:["orange","orange"],on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],"move up":["up",
"up"],"move down":["down","down"],"step up":["step up","step up"],"step down":["step down","step down"],"move to":["value","value"],stop:["off","off"],open:["open","\u00f6ffnen"],lock:["lock","abschlie\u00dfen"],unlock:["unlock","aufschlie\u00dfen"],"temperature up":["up","up"],"temperature down":["down","down"],"temperature to":["value","value"],"set auto mode":["auto","auto"],"set manual mode":["manu","manu"],"set manu mode":["manu","manu"],"set boost mode":["boost","boost"],"set comfort mode":["comfort",
"komfort"],"lamella up":["lamella up","lamella up"],"lamella down":["lamella down","lamella down"],"lamella to":["lamella to","lamella to"]};n.AIO_MAP={on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],"mode auto":["auto","auto"],"mode manu":["manu","manu"],"mode toggle":["toggle","toggle"],up:["up","up"],down:["down","down"],"up step bit":["step up","step up"],"down step bit":["step down","step down"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],"dim off":["off",
"off"],Auf:["up","up"],Ab:["down","down"],Stop:["off","off"],"move up":["up","up"],"move down":["down","down"],"move in":["up","up"],"move out":["down","down"],"level up":["up","up"],"level down":["down","down"],"start dim":["up","up"],"stop dim":["down","down"],"step up":["step up","step up"],"step down":["step down","step down"],"move to":["value","value"],stop:["off","off"],open:["open","\u00f6ffnen"],close:["close","schlie\u00dfen"],lock:["lock","abschlie\u00dfen"],unlock:["unlock","aufschlie\u00dfen"],
"temperature up":["up","up"],"temperature down":["down","down"],"set temperature":["value","value"],"temperature to":["value","value"],"set auto mode":["auto","auto"],"auto mode":["auto","auto"],"set manual mode":["manu","manu"],"manu mode":["manu","manu"],"set boost mode":["boost","boost"],"boost mode":["boost","boost"],"boost on":["boost","boost"],"boost off":["boost off","boost aus"],"heater on":["heater on","heizung an"],"heater off":["heater off","heizung aus"],"led on":["led on","led an"],"led off":["led off",
"led aus"],"chime on":["chime on","chime an"],"chime off":["chime off","chime aus"],"panic alarm on":["panic on","panic an"],"panic alarm off":["panic off","panic aus"],disarmed:["disarm","entsch\u00e4rfen"],"all armed":["arm","scharf schalten"],"lamella up":["lamella up","lamella hoch"],"lamella down":["lamella down","lamella runter"],"lamella step up":["lamella step up","lamella step up"],"lamella step down":["lamella step down","lamella step down"],"lamella to":["lamella to","lamella to"],lamella:["lamella to",
"lamella to"],"tilt to":["lamella to","lamella to"],"preset position":["position to","position to"],activate:["on","on"],deactivate:["off","off"],A:["off","off"],B:["off","off"],C:["off","off"],"do scene":["do scene","scene starten"],brightness:["value","value"],color:["color","farblich"],white:["white","wei\u00df"],red:["red","rot"],purple:["purple","violett"],blue:["blue","blau"],cyan:["cyan","cyan"],green:["green","gr\u00fcn"],yellow:["yellow","gelb"],orange:["orange","orange"],position:["value",
"value"],"position 1":["position 1","position 1"],"position 2":["position 2","position 2"],"brightness up":["up","up"],"brightness down":["down","down"],"set value":["value","value"]};n.SONOS_MAP={play:["play","play"],pause:["pause","pause"],stop:["off","off"],previous:["previous","previous"],next:["next","next"],"shuffle on":["shuffle on","shuffle on"],"shuffle off":["shuffle off","shuffle off"],"repeat off":["repeat off","repeat off"],"repeat all":["repeat all","repeat all"],"repeat one":["repeat one",
"repeat one"],"group volume":["value","value"],"group volume up":["up","up"],"group volume down":["down","down"],"group mute":["mute","mute"],"group unmute":["unmute","unmute"],volume:["value","value"],"volume up":["up","up"],"volume down":["down","down"],mute:["mute","mute"],unmute:["unmute","unmute"]};n.HUE_MAP={"color temperature":["color temperature","color temperatur"]};n.MILIGHT_MAP={"disco speed up":["faster","schneller"],"disco speed down":["slower","langsamer"],"speed up":["faster","schneller"],
"speed down":["slower","langsamer"],"mode up":["next mode","n\u00e4chste mode"],"mode down":["previous mode","vorherige mode"],"full brightness":["max","max"],"warm white up":["warmer","w\u00e4rmer"],"cool white up":["cooler","k\u00e4lter"],"max brightness":["max","max"],"night mode":["night mode","nacht mode"],"night light on":["night mode","nacht mode"],warmer:["warmer","w\u00e4rmer"],cooler:["cooler","k\u00e4lter"]};n.OSRAM_MAP={"color temperature":["color temperature","color temperatur"],"do scene":["scene",
"szene"]};n.HARMONY_MAP={"power on":["on","on"],"power off":["off","off"],poweron:["on","on"],poweroff:["off","off"],stop:["stop","stop"],volumeup:["up","up"],volumedown:["down","down"],"volume up":["up","up"],"volume down":["down","down"]};n.AV_MAP={stop:["stop","stop"]};n.TADO_MAP={"set manu temperature":["value","value"],manu:["value","value"]};n.NETATMO_MAP={manu:["value","value"]};n.FIBAROHC_MAP={"set value":["value","value"]};n.REMOTE_SERVER="https://cloud.mediola.com";n.prototype._getAccessToken=
function(c,b,a,d,e){c={host:require("url").parse("https://"+c).hostname,port:443,path:"/getAccessToken?sid="+b,method:"GET",timeout:3E4,auth:"user:"+a,user:"user",password:a,headers:{Authorization:"Basic "+(new Buffer("user:"+a)).toString("base64")}};d&&(c.path+="&force=1");this._logger.log("trace","send get access token to:"+JSON.stringify(m.aio.voicemanager.Util.clearHttpOptionForLog(c)));var g=this,k=require("https").request(c,function(h){h.setEncoding("utf8");var f="";h.on("data",function(l){f+=
l});h.on("end",function(){if(200==h.statusCode){g._logger.log("trace","get access token reponse:"+f);try{var l=JSON.parse(f);l.XC_ERR?e&&e(Error(l.XC_ERR.msg)):l.XC_SUC?e&&e(null,l.XC_SUC.at):e&&e(Error("invalid response"))}catch(q){e&&e(q)}}else g._logger.log("warn","get access token error +"+h.statusCode+":"+f),e&&e(Error("http response:"+h.statusCode))})});if(k.on)k.on("error",function(h){g._logger.log("warn","get access token error:"+h.message);e&&e(h);e=null});k.setTimeout&&k.setTimeout(5E3,
function(){k.abort();g._logger.log("warn","get access token timeout");e&&e(Error("http timeout"));e=null});k.end()};n.prototype._processHMCommands=function(c,b,a){return this._processCommandsFromMap(n.HM_MAP,c,b,a)};n.prototype._processAIOCommands=function(c,b,a){return this._processCommandsFromMap(n.AIO_MAP,c,b,a)};n.prototype._processSonosCommands=function(c,b,a){return this._processCommandsFromMap(n.SONOS_MAP,c,b,a)};n.prototype._processHueCommands=function(c,b,a){return this._processCommandsFromMap(n.HUE_MAP,
c,b,a)};n.prototype._processMilightCommands=function(c,b,a,d){return this._processCommandsFromMap(n.MILIGHT_MAP,c,b,a,d)};n.prototype._processOsramCommands=function(c,b,a){return this._processCommandsFromMap(n.OSRAM_MAP,c,b,a)};n.prototype._processHarmonyCommands=function(c,b,a,d){return this._processCommandsFromMap(n.HARMONY_MAP,c,b,a,d)};n.prototype._processMcontrolCommands=function(c,b,a){if(c&&c.info&&c.info.command){var d=JSON.parse(JSON.stringify(c.info.command));c.info.command=d;c.info.command.push({type:"enum",
name:"on",ref:{value:"do",ext:"on"}});c.info.command.push({type:"enum",name:"off",ref:{value:"do",ext:"off"}});c.info.command.push({type:"enum",name:"up",ref:{value:"do",ext:"up"}});c.info.command.push({type:"enum",name:"down",ref:{value:"do",ext:"down"}});c.info.command.push({type:"int",name:"move to",ref:{value:"setInt",ext:"%d"}})}return this._processCommandsFromMap(null,c,b,a)};n.prototype._processFibaroHCCommands=function(c,b,a){if(a&&"blind"==a.type&&c&&c.info&&c.info.command){for(var d=JSON.parse(JSON.stringify(c.info.command)),
e=0;e<d.length;e++){var g=d[e];switch(g.name){case "open":g.name="up";break;case "close":g.name="down";break;case "up":g.name="step up";break;case "down":g.name="step down";break;case "stop":g.name="off"}}c.info.command=d}return this._processCommandsFromMap(n.FIBAROHC_MAP,c,b,a)};n.prototype._processAVCommands=function(c,b,a,d){return this._processCommandsFromMap(n.AV_MAP,c,b,a,d)};n.prototype._processTadoCommands=function(c,b,a){return this._processCommandsFromMap(n.TADO_MAP,c,b,a)};n.prototype._processNetatmoCommands=
function(c,b,a){return this._processCommandsFromMap(n.NETATMO_MAP,c,b,a)};n.prototype._processCommandsFromMap=function(c,b,a,d,e){a=a?String(a).toLowerCase():"de";for(var g={},k=n.LANG.indexOf(a),h=0;h<b.info.command.length;h++){var f=b.info.command[h];if("string"!==f.type||"aio"===b.info.sys&&"STRING"===b.info.type)if("root"===f.type)this._processRootCommandsFromMap(g,f,c,b,a,d,e);else{var l={type:"POST",url:"/cmd",original:f.name,data:{XC_FNC:"SendRM",device:b.index,command:JSON.parse(JSON.stringify(f.ref))}},
q=f.name.toLowerCase(),p=n.MAP[q]?n.MAP[q][k]:null;(q=c&&c[q]?c[q][k]:null)&&(p=q);var r=null;q=b.info.sys;if(this._customMap&&q&&this._customMap[q]){var t=this._customMap[q];r=t[f.name]?t[f.name][k]:null}r&&(p=r);if("%d"===f.ref.ext||"%f"===f.ref.ext||"%s"===f.ref.ext)l.data.command.ext="{val}","%f"===f.ref.ext&&(l["float"]=1),f.ref.extMeta&&(r=f.ref.extMeta.indexOf("-",1),-1!=r&&(q=parseFloat(f.ref.extMeta.substr(0,r)),r=parseFloat(f.ref.extMeta.substr(r+1)),l.min=q,l.max=r)),f.ref.scale&&(l.step=
parseFloat(f.ref.scale)),p||(p=f.name),"value"===p?g[p]=l:(d&&!d.values&&(d.values={}),d&&d.values&&(d.values[p]=l));else if("%e"===f.ref.ext){if(p||(p=f.name),f.ref.extMeta&&0<f.ref.extMeta.length)for(r=0;r<f.ref.extMeta.length;r++){var u=JSON.parse(JSON.stringify(l));u.data.command.ext=f.ref.extMeta[r];u.original+=" "+f.ref.extMeta[r];var v=p+" "+f.ref.extMeta[r];this._customMap&&q&&this._customMap[q]&&(t=this._customMap[q],(t=t[u.original]?t[u.original][k]:null)&&(v=t));g[v]=u}}else"rgb"===f.type||
"rgbw"===f.type?(l=JSON.parse(JSON.stringify(l)),l.data.command.ext="FF0000",g[n.MAP.red[k]]=l,l=JSON.parse(JSON.stringify(l)),l.data.command.ext="FF00FF",g[n.MAP.purple[k]]=l,l=JSON.parse(JSON.stringify(l)),l.data.command.ext="0000FF",g[n.MAP.blue[k]]=l,l=JSON.parse(JSON.stringify(l)),l.data.command.ext="00FFFF",g[n.MAP.cyan[k]]=l,l=JSON.parse(JSON.stringify(l)),l.data.command.ext="00FF00",g[n.MAP.green[k]]=l,l=JSON.parse(JSON.stringify(l)),l.data.command.ext="FFFF00",g[n.MAP.yellow[k]]=l,l=JSON.parse(JSON.stringify(l)),
l.data.command.ext="FF8C00",g[n.MAP.orange[k]]=l,"rgbw"===f.type&&(l=JSON.parse(JSON.stringify(l)),l.data.command.ext="FFFFFF",g[n.MAP.white[k]]=l)):(p||(p=f.name),g[p]=l,r&&(l.mappedCustom=!0))}}return g};n.prototype._processRootCommandsFromMap=function(c,b,a,d,e,g,k){e||(e="de");e=e.toLowerCase();e=n.LANG.indexOf(e);if(b&&b.value&&b.children&&0!=b.children.length){if("mainzone"!=b.value&&"global"!=b.value){c=g.name+" "+b.name;var h={name:c,type:g.type,sys:g.sys,baseurl:g.baseurl,commands:{}};k[c]=
h;c=h.commands}for(k=0;k<b.children.length;k++)if(h=b.children[k],("string"!=h.type||"aio"==d.info.sys&&"STRING"==d.info.type)&&"root"!=h.type){var f={type:"POST",url:"/cmd",original:h.name,data:{XC_FNC:"SendRM",device:d.index,command:JSON.parse(JSON.stringify(h.ref))}};f.data.command.path=[b.value];var l=h.name.toLowerCase(),q=n.MAP[l]?n.MAP[l][e]:null;(l=a&&a[l]?a[l][e]:null)&&(q=l);var p=null;l=d.info.sys;if(this._customMap&&l&&this._customMap[l]){var r=this._customMap[l];p=r[h.name]?r[h.name][e]:
null}p&&(q=p);if("%d"==h.ref.ext||"%f"==h.ref.ext||"%s"==h.ref.ext)f.data.command.ext="{val}","%f"==h.ref.ext&&(f["float"]=1),h.ref.extMeta&&(p=h.ref.extMeta.indexOf("-",1),-1!=p&&(l=parseFloat(h.ref.extMeta.substr(0,p)),p=parseFloat(h.ref.extMeta.substr(p+1)),f.min=l,f.max=p)),h.ref.scale&&(f.step=parseFloat(h.ref.scale)),q||(q=h.name),"value"!=q&&(g&&!g.values&&(g.values={}),g&&g.values&&(g.values[q]=f));else if("%e"==h.ref.ext){if(q||(q=h.name),h.ref.extMeta&&0<h.ref.extMeta.length)for(p=0;p<h.ref.extMeta.length;p++){var t=
JSON.parse(JSON.stringify(f));t.data.command.ext=h.ref.extMeta[p];t.original+=" "+h.ref.extMeta[p];var u=q+" "+h.ref.extMeta[p];this._customMap&&l&&this._customMap[l]&&(r=this._customMap[l],(r=r[t.original]?r[t.original][e]:null)&&(u=r));c[u]=t}}else"rgb"==h.type||"rgbw"==h.type?(f=JSON.parse(JSON.stringify(f)),f.data.command.ext="FF0000",c[n.MAP.red[e]]=f,f=JSON.parse(JSON.stringify(f)),f.data.command.ext="FF00FF",c[n.MAP.purple[e]]=f,f=JSON.parse(JSON.stringify(f)),f.data.command.ext="0000FF",c[n.MAP.blue[e]]=
f,f=JSON.parse(JSON.stringify(f)),f.data.command.ext="00FFFF",c[n.MAP.cyan[e]]=f,f=JSON.parse(JSON.stringify(f)),f.data.command.ext="00FF00",c[n.MAP.green[e]]=f,f=JSON.parse(JSON.stringify(f)),f.data.command.ext="FFFF00",c[n.MAP.yellow[e]]=f,f=JSON.parse(JSON.stringify(f)),f.data.command.ext="FF8C00",c[n.MAP.orange[e]]=f,"rgbw"==h.type&&(f=JSON.parse(JSON.stringify(f)),f.data.command.ext="FFFFFF",c[n.MAP.white[e]]=f)):(q||(q=h.name),c[q]=f,p&&(f.mappedCustom=!0))}return c}};n.prototype._isDeviceHeater=
function(c){var b="hm-cc-rt-dn;hm-cc-rt-dn-bom;hm-cc-tc;hm-cc-vg-1;hm-tc-it-wm-w-eu;hmip-bwth;hmip-bwth24;hmip-etrv;hmip-etrv-2;hmip-etrv-b;hmip-etrv-b1;hmip-etrv-c;hmip-heating;hmip-sth;hmip-sthd;hmip-wth;hmip-wth-2;hmip-wth-b;hmipw-sth;hmipw-sthd;hmipw-wth;zel stg rm fwt".split(";"),a="heater thermostat wallthermo wallthermostat ip_heater ip_wallthermo ip_wallthermo2".split(" ");if(!c||!c.info)return!1;c=c.info;if("hm"==c.sys)return a=String(c.type).toLowerCase(),0<=b.indexOf(a);if("aio"==c.sys)if("HM"==
c.type){if(-1!=a.indexOf(c.data))return!0}else{if("FHT80b"==c.type)return!0}else if("max"==c.sys){if(1==c.type||2==c.type||3==c.type)return!0}else{if("tado"==c.sys)return!0;if("netatmo"==c.sys){if("NATherm1"==c.type)return!0}else if("gira"===c.sys&&"heater"===c.type)return!0}return!1};n.prototype._isDeviceScene=function(c){return c&&c.info&&"hm"==c.info.sys?"Prog"==c.info.type:!1};n.prototype._isDeviceBlind=function(c){return c&&c.info?"NY"===c.info.type&&"shutter"===c.info.data?!0:!1:!1};n.prototype._getDeviceCatagory=
function(c){if(!c||!c.info)return null;if(this._isDeviceHeater(c))return"heater";if(this._isDeviceScene(c))return"scene";if(this._isDeviceBlind(c))return"blind";if(!c.info.command)return null;if("fibaro"==c.info.sys)return this._getFibaroHCDeviceCatagory(c);for(var b=c.info.command,a=!1,d=0;d<b.length;d++){var e=b[d];if(e&&e.name){e=e.name.toLowerCase();if(("hue"==c.info.sys||"osram"==c.info.sys)&&"brightness"==e)return"light";if("moveto"==e||"move to"==e||"position to"==e||"positionto"==e)return"blind";
if("dimto"==e||"dim to"==e||"levelto"==e||"level to"==e)return"light";"on"==e&&(a=!0)}}return a||a?"switch":null};n.prototype._getFibaroHCDeviceCatagory=function(c){c=c.info.command;for(var b=[],a=0;a<c.length;a++){var d=c[a];d&&d.name&&(d=d.name.toLowerCase(),-1==b.indexOf(d)&&b.push(d))}return-1!=b.indexOf("open")&&-1!=b.indexOf("close")?"blind":-1!=b.indexOf("up")&&-1!=b.indexOf("down")&&-1!=b.indexOf("set value")?"light":-1!=b.indexOf("on")&&-1!=b.indexOf("off")?"switch":null};n.prototype._convertDeviceToCloudFormat=
function(c,b,a,d,e){var g=c.info.sys,k=c.info.type,h=this._getDeviceCatagory(c);h&&(k=h);k={name:b,type:k,module:g,sys:g,baseurl:a,commands:{},states:{}};if("aio"==g&&"TASK"==c.info.type)return{name:b,type:"scene",module:g,sys:g,baseurl:a,commands:{on:{type:"POST",url:"/cmd",original:"run",data:{XC_FNC:"SendRM",device:c.index,command:{value:"run"}}}}};if("hm"==g&&"Prog"==c.info.type)return k={name:b,type:"scene",module:g,sys:g,baseurl:a,commands:{on:{type:"POST",url:"/cmd",original:"run",data:{XC_FNC:"SendRM",
device:c.index,command:{value:"progExec"}}}}};if(c.info.command&&0<c.info.command.length){switch(g){case "hm":b=this._processHMCommands(c,d,k,e);break;case "aio":b=this._processAIOCommands(c,d,k,e);break;case "sonos":b=this._processSonosCommands(c,d,k,e);break;case "hue":b=this._processHueCommands(c,d,k,e);break;case "easyled":case "milight":case "milightv6":b=this._processMilightCommands(c,d,k,e);break;case "lightify":b=this._processOsramCommands(c,d,k,e);break;case "harmony":b=this._processHarmonyCommands(c,
d,k,e);break;case "pioneer":case "onkyo":case "denon":case "yamaha":b=this._processHarmonyCommands(c,d,k,e);break;case "mcontrol":b=this._processMcontrolCommands(c,d,k,e);break;case "fibaro":b=this._processFibaroHCCommands(c,d,k,e);break;case "tado":b=this._processTadoCommands(c,d,k,e);break;case "netatmo":b=this._processNetatmoCommands(c,d,k,e);break;default:b=this._processCommandsFromMap(null,c,d,k,e)}k.commands=b}c.info.status&&0<Object.keys(c.info.status).length&&(k.states=c.info.status);return k};
n.prototype._resovleDeviceID=function(c,b,a){var d=c.name;a=a[c.room];if("_cameras"==d.substr(0,8)){a=null;var e=d.indexOf(":");d=d.substr(e+1)}"_progs&sysvars"==a&&(a=b[c.info.gateway],"gw"==d.substr(0,2)&&(e=d.indexOf("_"),d=d.substr(e+1)));b=(a?a+" ":"")+(d?d:"");c.cloud.alias&&(b=c.cloud.alias);return b};n.prototype._resovleBaseUrl=function(c,b){var a=c,d=c.indexOf(":");-1!=d&&(a=c.substr(0,d));return"https://"+a+"/rapi/"+b};n.prototype.getAccessToken=function(c,b){if(c)if("aio"!=c.sys&&"neoserver"!=
c.sys)b&&b(Error("gateway type invalid"));else{var a=this,d=require("xnm.aio.gateway.js");if("neoserver"==c.sys){c=JSON.parse(JSON.stringify(c));c.sys="aio";c.version="EA";var e=d.resolveGateway(c,!0)}else e=d.resolveGateway(c);e?d.Admin.getGatewaySID(e,function(g,k){g?(a._logger.log("warn","get gateway sid error:"+g.message),g.code="50001",g.message="get gateway sid error:"+g.message,b&&b(g)):k?c.password?d.Admin.V5.getInfo(e,function(h,f){h?(a._logger.log("warn","get gateway info error:"+h.message),
h.message="get gateway info error:"+h.message,h.code="50101",b&&b(h)):f&&f.server?!f.cfg||parseInt(f.cfg,16)&64?(a._logger.log("warn","gateway cloud server is deactivated"),h=Error("gateway cloud server is deactivated"),h.code="50103",b&&b(h)):a._getAccessToken(f.server,k,c.password,!1,function(l,q){l?(l=Error("get accesss token error:"+l.message),l.code="50003",b&&b(l)):q?b&&b(null,q,f.server,k):a._getAccessToken(f.server,k,c.password,!0,function(p,r){p?(p=Error("generate accesss token error:"+p.message),
p.code="50004",b&&b(p)):r?b&&b(null,r,f.server,k):b&&b(Error("access token empty"))})}):(a._logger.log("warn","gateway has no cloud server"),h=Error("gateway has no cloud server"),h.code="50102",b&&b(h))}):(g=Error("gateway has no password"),g.code="50002",b&&b(g)):(g=Error("gateway has no sid"),g.code="50002",b&&b(g))}):b&&b(Error("gateway json invalid"))}else b&&b(Error("gateway json is null"))};n.prototype.generateConfig=function(c,b,a,d,e,g,k,h,f,l){var q=require("url").parse("https://"+h),p=
function(z){for(var x=z.length,A={};x--;){var B=z[x];A[B.index]=B.name}return A}(b),r=function(z){for(var x=z.length,A={};x--;){var B=z[x];A[B.index]=B.name}return A}(a);a={};h=this._resovleBaseUrl(h,g);b=f=null;for(var t=0;t<c.length;t++){var u=c[t];!u||!u.info||"cloudservice"==u.info.sys&&u.info.module||"_webpages"==u.name.substr(0,9)||(f=this._resovleDeviceID(u,r,p),b=this._convertDeviceToCloudFormat(u,f,h,e,a),b.data={mod:"mediola",ccs:q.hostname,accessToken:g,deviceID:u.index},a[f]=b)}c={};e=
null;if(d&&d.groups)for(g=0;g<d.groups.length;g++)if((q=d.groups[g])&&q.macros&&0!=q.macros.length)for(p=q.name,r=0;r<q.macros.length;r++)if(b=q.macros[r],f=b.name,b.cloud&&b.cloud.enabled){f=(p?p+" ":"")+(f?f:"");b.cloud.alias&&(f=b.cloud.alias);e="";t=f.toLowerCase();u="on off an aus up down auf ab hoch runter ein".split(" ");for(var v=0;v<u.length;v++){var w=u[v],y=t.substr(t.length-w.length);t.length>w.length&&y==w&&(e=f.substr(0,t.length-w.length).trim(),c[e]||(c[e]=[]),c[e].push({original_id:f,
command:w}))}b={name:f,type:"scene",baseurl:h,local:"http://"+k.ip+(k.port?":"+k.port:""),commands:{on:{type:"POST",url:"/cmd",data:{XC_FNC:"DoMacroRM",groupIdx:q.index,macroIdx:b.index}}}};a[f]=b}for(e in c){d=c[e];b={name:e,type:"scene",baseurl:h,local:"http://"+k.ip+(k.port?":"+k.port:""),commands:{}};g=f=!1;for(q=0;q<d.length;q++)if((p=d[q])&&p.original_id&&p.command&&(r=p.original_id,t=a[r],delete a[r],t)){r=t.commands.on;t=p.command;switch(p.command){case "on":case "an":case "ein":f=!0;t="on";
break;case "off":case "aus":f=!0;t="off";break;case "up":case "auf":case "hoch":g=!0;t="up";break;case "down":case "ab":case "runter":g=!0,t="down"}b.commands[t]=r}f?b.type="switch":g&&(b.type="blind");a[e]=b}l&&l(null,a)};n.prototype.uploadConfig=function(c,b,a){b={type:"mediola",configuration:b};var d=c.ip;d||(d=require("url").parse(n.REMOTE_SERVER).host);var e=c.port;e||(e=443);var g=c.username?c.username:"";c=c.password?c.password:"";c={host:d,port:e,path:"/alexa/setConfiguration",method:"POST",
timeout:3E4,auth:g+":"+c,user:g,password:c,headers:{"Content-Type":'text/xml; charset="utf-8"',Authorization:"Basic "+(new Buffer(g+":"+c)).toString("base64"),Connection:"close"}};var k=this;this._logger.log("trace","upload config to:"+JSON.stringify(c));c=require("https").request(c,function(h){h.setEncoding("utf8");var f="";h.on("data",function(l){f+=l});h.on("end",function(){if(200==h.statusCode){k._logger.log("trace","upload config reponse:"+f);try{var l=JSON.parse(f);if(l.XC_ERR){var q=Error(l.XC_ERR.msg);
q.code=l.XC_ERR.code;a&&a(q)}else l.XC_SUC&&a&&a()}catch(p){a&&a(p)}}else k._logger.log("warn","upload config error +"+h.statusCode+":"+f),a&&a(Error("http response:"+h.statusCode))})});if(c.on)c.on("error",function(h){k._logger.log("warn","upload config error:"+h.message);a&&a(h);a=null});c.write(JSON.stringify(b));c.end()};n.prototype.setCustomCommandMap=function(c){this._customMap=c};n.prototype.loadCustomComamndMap=function(c,b){var a=require("fs-extra");a.ensureFile(c,function(d){d?b&&b(null,
{}):a.readFile(c,"utf8",function(e,g){if(e)b&&b(e);else if(g)try{var k=JSON.parse(g);b&&b(null,k)}catch(h){b&&b(null,{})}else b&&b(null,{})})})};n.prototype.saveCustomCommandMap=function(c,b,a){var d=require("fs-extra");d.ensureFile(c,function(e){if(e)a&&a(null,{});else try{var g=JSON.stringify(b,null,2);d.writeFile(c,g,function(k){a&&a(k)})}catch(k){a&&a(k)}})};return n}();
m.aio.voicemanager.Handler=function(){var n=function(){this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.Handler");this._devicemanager=this._configmanager=null;this._alexaHandler=new m.aio.voicemanager.AlexaHandler;this.CLOUD_PROTOCOL="https";this.CLOUD_HOST="webservice.mediola.com";this.CLOUD_PORT=443;this.CLOUD_PATH="/account/bindLicense"};n.prototype.CUSTOM_CMD_MAP_FILE="cloud_service_command.map";n.prototype.init=function(c,b,a,d){this._configmanager=c;this._devicemanager=b;this._macromanager=
a;d&&d()};n.prototype.loadCustomComamndMap=function(c,b){var a=this;this._configmanager.trace("/config/tenants/"+c,function(d,e){d?(d.code="50100",b&&b(d)):(d=require("path"),(e=e.getFolderPath())?(e=d.join(e,a.CUSTOM_CMD_MAP_FILE),a._alexaHandler.loadCustomComamndMap(e,function(g,k){b&&b(g,k)})):(d=Error("tenant folder is null"),d.code="50100",b&&b(d)))})};n.prototype.saveCustomComamndMap=function(c,b,a){var d=this;this._configmanager.trace("/config/tenants/"+c,function(e,g){e?(e.code="50100",a&&
a(e)):(e=require("path"),g=g.getFolderPath(),g=e.join(g,d.CUSTOM_CMD_MAP_FILE),d._alexaHandler.saveCustomCommandMap(g,b,function(k){a&&a(k)}))})};n.prototype.getLocalDeviceConfig=function(c,b,a,d){if(b){var e=this;this._alexaHandler.getAccessToken(b,function(g,k,h,f){g?d&&d(g):e._getDeviceWithCommandAndStatus(c,function(l,q){l?(l.code="50005",d&&d(l)):e._devicemanager.execute("read",c,"gateway",null,function(p,r){p?(p.code="50007",d&&d(p)):e._devicemanager.execute("read",c,"room",null,function(t,
u){t?(t.code="50008",d&&d(t)):e._macromanager.execute(c,"read",null,null,null,function(v,w){v?(v.code="50009",d&&d(v)):e.loadCustomComamndMap(c,function(y,z){if(y||!z)z=null;e._alexaHandler.setCustomCommandMap(z);e._alexaHandler.generateConfig(q,u,r,w,a,k,b,h,f,function(x,A){x?(e._logger.log("warn","generate configuration error:"+x.message),x.code="50010",d&&d(x)):d&&d(null,A)})})})})})})})}else d&&d(null,null)};n.prototype.getCloudDeviceConfig=function(c,b,a){var d=null;if(b){var e=require("xnm.aio.cloudservice.js").resolveGateway(b);
e?this._getCloudDevicesFromDB(c,e,function(g,k){g?a&&a(g):k&&0!=k.length?(g=k.map(function(h){h=h.info;delete h.gateway;delete h.commands;delete h.states;return h}),e.toCloudDevice(g,function(h,f){if(h)h.code=40003,a&&a(h);else if(f&&0!=f.length){h={};for(var l=0;l<k.length;l++){var q=k[l];if(q)for(var p=0;p<f.length;p++){var r=f[p];r&&(r.data&&q.info.module==r.data.mod&&q.info.connection==r.data.connection&&q.info.id==r.data.id?(r.name=q.__cloudref,h[q.__cloudref]=r):q.info.module==r.mod&&q.info.connection==
r.connection&&q.info.id==r.id&&(r.name=q.__cloudref,r.data={mod:r.mod,connection:r.connection,id:r.id},delete r.mod,delete r.connection,delete r.id,h[q.__cloudref]=r))}}a&&a(null,h)}else a&&a(null,{})})):a&&a(null,{})}):(d=Error("cloud json invalid"),d.code=4E4,a&&a(d))}else d=Error("cloud json invalid"),d.code=4E4,a&&a(d)};n.prototype._getCloudDevicesFromDB=function(c,b,a){var d=function(h,f){for(var l=0;l<f.length;l++){var q=f[l];if(q&&q.index==h)return q}return null},e=this,g=require("xnm.aio.cloudservice.js"),
k={filter:"prop","info.sys":"cloudservice","cloud.enabled":!0};this._devicemanager.execute("read",c,"device",k,function(h,f){h?(h.code=40001,a&&a(h)):f&&0!=f.length?(k={filter:"prop","info.sys":"cloudservice"},e._devicemanager.execute("read",c,"gateway",k,function(l,q){l?(l.code=40001,a&&a(l)):q&&0!=q.length?e._devicemanager.execute("read",c,"room",null,function(p,r){if(p)p.code=40001,a&&a(p);else if(r&&0!=r.length){p=[];for(var t=0;t<f.length;t++){var u=f[t];if(u&&u.info&&u.info.gateway){var v=d(u.info.gateway,
q);if(v&&v.info&&(v=g.resolveGateway(v.info))){if(!v.equalsTo(b)){p=Error("cloud device "+u.index+" belongs to another account");p.code=40002;a&&a(p);return}var w=d(u.room,r);w&&(v=u.name,w=w.name,v=(w?w+" ":"")+(v?v:""),u.cloud.alias&&(v=u.cloud.alias),u=JSON.parse(JSON.stringify(u)),u.__cloudref=v,p.push(u))}}}a&&a(null,p)}else a&&a(null,[])}):a&&a(null,[])})):a&&a(null,[])})};n.prototype.previewAlexaConfig=function(c,b,a,d,e){if(a&&a.username)if(d&&d.version&&"C"==d.version.charAt(0)&&"CA"!=d.version.toUpperCase()){var g=
new m.aio.voicemanager.CloudConfigHandler.V5(this._devicemanager,this._macromanager);g.setTargetGateway(d);g.exportConfig(c,a,function(h,f){e&&e(h,f)})}else{var k=this;this.getCloudDeviceConfig(c,a,function(h,f){h?e&&e(h):k.getLocalDeviceConfig(c,d,b,function(l,q){if(l)e&&e(l);else{l={};var p;if(f)for(p in f)l[p]=f[p];if(q)for(p in q)l[p]=q[p];(q=Object.keys(l))&&0!=q.length?e&&e(null,l):(k._logger.log("warn","generate empty configuration"),l=Error("empty configuration"),l.code="50011",e&&e(l))}})})}else e&&
e(Error("username is null"))};n.prototype.exportAlexaConfig=function(c,b,a,d,e){if(a&&a.username)if(d){var g=this;this.previewAlexaConfig(c,b,a,d,function(k,h){if(k)e&&e(k);else{var f={};if(h)for(var l in h)k=h[l],delete k.sys,delete k.module,f[l]=k;g._configmanager.execute("read","/config/tenants/"+c,null,function(q,p){if(q)q.code="50013",e&&e(q);else{var r=null;p.license&&"normal"==p.license.type&&p.license.valid&&p.license.license&&(r=p.license.license);g._alexaHandler.uploadConfig(a,f,function(t){t?
(g._logger.log("warn","upload configuration error:"+t.message),t.code="000009"==t.code?"50014":"50012",e&&e(t)):r?g.bindLicense(a.username,a.password,r,function(u){u&&g._logger.log("warn","bind user license error:"+u.message);e&&e(null,f)}):e&&e(null,f)})}})}})}else e&&e(Error("gateway invalid"));else e&&e(Error("username is null"))};n.prototype._getDeviceWithCommandAndStatus=function(c,b){var a={filter:"prop","cloud.enabled":!0},d=this,e={};this._devicemanager.execute("read",c,"device",{filter:"ui",
f_ui_elem:"*",f_ui_type:"command"},function(g,k){if(g)b(g);else{if(k&&0<k.length)for(g=0;g<k.length;g++){var h=k[g];h&&h.cloud&&h.cloud.enabled&&h.info&&h.info.command&&0!=h.info.command.length&&(e[h.index]=h)}d._devicemanager.execute("read",c,"device",a,function(f,l){if(f)b(f);else if(l&&0!=l.length){var q=0,p=function(r,t){!r&&t&&(e[l[q].index]?e[l[q].index].info.status=t.states:(e[l[q].index]=l[q],l[q].info.status=t.states));q++;q<l.length?d._devicemanager.toGeneralDevice(c,l[q].index,!1,p):(r=
Object.values(e),b(null,r))};d._devicemanager.toGeneralDevice(c,l[q].index,!1,p)}else f=Object.values(e),b(null,f)})}})};n.prototype.bindLicense=function(c,b,a,d){b={host:this.CLOUD_HOST,port:this.CLOUD_PORT,path:this.CLOUD_PATH+"?license="+a,method:"GET",timeout:3E4,auth:c+":"+b,user:c,password:b,headers:{"Content-Type":'text/xml; charset="utf-8"',Authorization:"Basic "+(new Buffer(c+":"+b)).toString("base64"),Connection:"close"}};var e=this;this._logger.log("trace","bind license "+a+" to:"+c);c=
require(this.CLOUD_PROTOCOL).request(b,function(g){g.setEncoding("utf8");var k="";g.on("data",function(h){k+=h});g.on("end",function(){200==g.statusCode?(e._logger.log("trace","bind license success"),d&&d()):(e._logger.log("warn","bind license success +"+g.statusCode+":"+k),d&&d(Error("http response:"+g.statusCode)));d=null})});if(c.on)c.on("error",function(g){e._logger.log("warn","upload config error:"+g.message);d&&d(g);d=null});c.setTimeout(3E4,function(){d&&d(Error("timeout"));d=null});c.end()};
n.prototype.uploadDeviceDB=function(c,b,a,d){this._uploadFile(c,b,"device_db",a,d)};n.prototype.uploadMacroDB=function(c,b,a,d){this._uploadFile(c,b,"macros_db",a,d)};n.prototype._uploadFile=function(c,b,a,d,e){c="/xhub/xhubsync/upload2?gatewayid="+c+"&fileName="+a+"&auth=";b.password&&(c+=b.password);b={host:b.ip,port:b.port,path:c,method:"POST",timeout:3E4,headers:{"Content-Type":"text/plain",Connection:"close"}};var g=this;this._logger.log("trace","upload "+a+" to:"+JSON.stringify(b));b=require("http").request(b,
function(k){k.setEncoding("utf8");var h="";k.on("data",function(f){h+=f});k.on("end",function(){if(200==k.statusCode){g._logger.log("trace","upload "+a+" reponse:"+h);try{"success"==JSON.parse(h).status?e&&e():e&&e(Error("failed to upload "+a))}catch(f){e&&e(f)}}else g._logger.log("warn","upload "+a+" error +"+k.statusCode+":"+h),e&&e(Error("http response:"+k.statusCode))})});if(b.on)b.on("error",function(k){g._logger.log("warn","upload "+a+" error:"+k.message);e&&e(k);e=null});b.write(JSON.stringify(d));
b.end()};n.prototype.exportV5Config=function(c,b,a,d,e){if(a&&a.username)if(d){var g=this;(new m.aio.voicemanager.CloudConfigHandler.V5(this._devicemanager,this._macromanager)).exportConfig(c,a,function(k,h){k?(g._logger.log("error","generate configuration error:"+k.message),k.code="50012",e&&e(k)):g._configmanager.execute("read","/config/tenants/"+c,null,function(f,l){if(f)f.code="50013",e&&e(f);else{var q=null;l.license&&"normal"==l.license.type&&l.license.valid&&l.license.license&&(q=l.license.license);
g._alexaHandler.uploadConfig(a,h,function(p){p?(g._logger.log("warn","upload configuration error:"+p.message),p.code="000009"==p.code?"50014":"50012",e&&e(p)):q?g.bindLicense(a.username,a.password,q,function(r){r&&g._logger.log("warn","bind user license error:"+r.message);e&&e(null,h)}):e&&e(null,h)})}})})}else e&&e(Error("gateway invalid"));else e&&e(Error("username is null"))};return n}();"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.voicemanager.Handler);
