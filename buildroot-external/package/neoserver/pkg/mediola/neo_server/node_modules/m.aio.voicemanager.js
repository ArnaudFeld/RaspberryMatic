var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,a,c){b!=Array.prototype&&b!=Object.prototype&&(b[a]=c.value)};$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var b=0;return function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+b++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.iterator;b||(b=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[b]&&$jscomp.defineProperty(Array.prototype,b,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(b){var a=0;return $jscomp.iteratorPrototype(function(){return a<b.length?{done:!1,value:b[a++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(b){$jscomp.initSymbolIterator();b={next:b};b[$jscomp.global.Symbol.iterator]=function(){return this};return b};$jscomp.iteratorFromArray=function(b,a){$jscomp.initSymbolIterator();b instanceof String&&(b+="");var c=0,e={next:function(){if(c<b.length){var d=c++;return{value:a(d,b[d]),done:!1}}e.next=function(){return{done:!0,value:void 0}};return e.next()}};e[Symbol.iterator]=function(){return e};return e};
$jscomp.polyfill=function(b,a,c,e){if(a){c=$jscomp.global;b=b.split(".");for(e=0;e<b.length-1;e++){var d=b[e];d in c||(c[d]={});c=c[d]}b=b[b.length-1];e=c[b];a=a(e);a!=e&&null!=a&&$jscomp.defineProperty(c,b,{configurable:!0,writable:!0,value:a})}};$jscomp.polyfill("Array.prototype.keys",function(b){return b?b:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");var m=m||{};m.aio=m.aio||{};m.aio.voicemanager=m.aio.voicemanager||{};
m.aio.voicemanager.AlexaHandler=function(){var b=function(){this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.Cloud");this._customMap=null};b.LANG=["en","de"];b.MAP={on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],up:["up","up"],down:["down","down"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],dimup:["up","up"],dimdown:["down","down"],dimto:["value","value"],"move up":["up","up"],"move down":["down","down"],"move to":["value","value"],moveup:["up",
"up"],movedown:["down","down"],moveto:["value","value"],stop:["off","off"],brightness:["value","value"],"brightness up":["up","up"],"brightness down":["down","down"],"temperature up":["up","up"],"temperature down":["down","down"],"temperature to":["value","value"],"set temperature":["value","value"],temperature:["value","value"],"mode auto":["auto","auto"],"set auto mode":["auto","auto"],"auto mode":["auto","auto"],auto:["auto","auto"],"mode manu":["manu","manu"],"set manual mode":["manu","manu"],
"manu mode":["manu","manu"],manu:["manu","manu"],"mode boost":["boost","boost"],"set boost mode":["boost","boost"],"boost mode":["boost","boost"],"boost on":["boost","boost"],boost:["boost","boost"],white:["white","wei\u00df"],red:["red","rot"],purple:["purple","violett"],blue:["blue","blau"],cyan:["cyan","cyan"],green:["green","gr\u00fcn"],yellow:["yellow","gelb"],orange:["orange","orange"],mode:["mode","mode"],"power on":["on","on"],"power off":["off","off"],poweron:["on","on"],poweroff:["off",
"off"],volumeup:["up","up"],volumedown:["down","down"],"volume up":["up","up"],"volume down":["down","down"],"volume to":["value","value"]};b.HM_MAP={"short press":["short press","kurz dr\u00fccken"],"long press":["long press","lange dr\u00fccken"],"set value":["value","value"],red:["red","rot"],green:["green","gr\u00fcn"],orange:["orange","orange"],on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],"move up":["up",
"up"],"move down":["down","down"],"step up":["step up","step up"],"step down":["step down","step down"],"move to":["value","value"],stop:["off","off"],open:["open","\u00f6ffnen"],lock:["lock","abschlie\u00dfen"],unlock:["unlock","aufschlie\u00dfen"],"temperature up":["up","up"],"temperature down":["down","down"],"temperature to":["value","value"],"set auto mode":["auto","auto"],"set manual mode":["manu","manu"],"set boost mode":["boost","boost"],"set comfort mode":["comfort","komfort"],"lamella up":["lamella up",
"lamella up"],"lamella down":["lamella down","lamella down"],"lamella to":["lamella to","lamella to"]};b.AIO_MAP={on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],"mode auto":["auto","auto"],"mode manu":["manu","manu"],"mode toggle":["toggle","toggle"],up:["up","up"],down:["down","down"],"up step bit":["step up","step up"],"down step bit":["step down","step down"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],"dim off":["off","off"],Auf:["up","up"],Ab:["down",
"down"],Stop:["off","off"],"move up":["up","up"],"move down":["down","down"],"move in":["up","up"],"move out":["down","down"],"level up":["up","up"],"level down":["down","down"],"start dim":["up","up"],"stop dim":["down","down"],"step up":["step up","step up"],"step down":["step down","step down"],"move to":["value","value"],stop:["off","off"],open:["open","\u00f6ffnen"],close:["close","schlie\u00dfen"],lock:["lock","abschlie\u00dfen"],unlock:["unlock","aufschlie\u00dfen"],"temperature up":["up",
"up"],"temperature down":["down","down"],"set temperature":["value","value"],"temperature to":["value","value"],"set auto mode":["auto","auto"],"auto mode":["auto","auto"],"set manual mode":["manu","manu"],"manu mode":["manu","manu"],"set boost mode":["boost","boost"],"boost mode":["boost","boost"],"boost on":["boost","boost"],"boost off":["boost off","boost aus"],"heater on":["heater on","heizung an"],"heater off":["heater off","heizung aus"],"led on":["led on","led an"],"led off":["led off","led aus"],
"chime on":["chime on","chime an"],"chime off":["chime off","chime aus"],"panic alarm on":["panic on","panic an"],"panic alarm off":["panic off","panic aus"],disarmed:["disarm","entsch\u00e4rfen"],"all armed":["arm","scharf schalten"],"lamella up":["lamella up","lamella hoch"],"lamella down":["lamella down","lamella runter"],"lamella step up":["lamella step up","lamella step up"],"lamella step down":["lamella step down","lamella step down"],"lamella to":["lamella to","lamella to"],lamella:["lamella to",
"lamella to"],"tilt to":["lamella to","lamella to"],"preset position":["position to","position to"],activate:["on","on"],deactivate:["off","off"],A:["off","off"],B:["off","off"],C:["off","off"],"do scene":["do scene","scene starten"],brightness:["value","value"],color:["color","farblich"],white:["white","wei\u00df"],red:["red","rot"],purple:["purple","violett"],blue:["blue","blau"],cyan:["cyan","cyan"],green:["green","gr\u00fcn"],yellow:["yellow","gelb"],orange:["orange","orange"],position:["value",
"value"],"position 1":["position 1","position 1"],"position 2":["position 2","position 2"],"brightness up":["up","up"],"brightness down":["down","down"],"set value":["value","value"]};b.SONOS_MAP={play:["play","play"],pause:["pause","pause"],stop:["off","off"],previous:["previous","previous"],next:["next","next"],"shuffle on":["shuffle on","shuffle on"],"shuffle off":["shuffle off","shuffle off"],"repeat off":["repeat off","repeat off"],"repeat all":["repeat all","repeat all"],"repeat one":["repeat one",
"repeat one"],"group volume":["value","value"],"group volume up":["up","up"],"group volume down":["down","down"],"group mute":["mute","mute"],"group unmute":["unmute","unmute"],volume:["value","value"],"volume up":["up","up"],"volume down":["down","down"],mute:["mute","mute"],unmute:["unmute","unmute"]};b.HUE_MAP={"color temperature":["color temperature","color temperatur"]};b.MILIGHT_MAP={"disco speed up":["faster","schneller"],"disco speed down":["slower","langsamer"],"speed up":["faster","schneller"],
"speed down":["slower","langsamer"],"mode up":["next mode","n\u00e4chste mode"],"mode down":["previous mode","vorherige mode"],"full brightness":["max","max"],"warm white up":["warmer","w\u00e4rmer"],"cool white up":["cooler","k\u00e4lter"],"max brightness":["max","max"],"night mode":["night mode","nacht mode"],"night light on":["night mode","nacht mode"],warmer:["warmer","w\u00e4rmer"],cooler:["cooler","k\u00e4lter"]};b.OSRAM_MAP={"color temperature":["color temperature","color temperatur"],"do scene":["scene",
"szene"]};b.HARMONY_MAP={"power on":["on","on"],"power off":["off","off"],poweron:["on","on"],poweroff:["off","off"],stop:["stop","stop"],volumeup:["up","up"],volumedown:["down","down"],"volume up":["up","up"],"volume down":["down","down"]};b.AV_MAP={stop:["stop","stop"]};b.TADO_MAP={"set manu temperature":["value","value"],manu:["value","value"]};b.NETATMO_MAP={manu:["value","value"]};b.FIBAROHC_MAP={"set value":["value","value"]};b.REMOTE_SERVER="https://cloud.mediola.com";b.prototype._getAccessToken=
function(a,c,e,d){a={host:require("url").parse(b.REMOTE_SERVER).host,port:443,path:"/getAccessToken?sid="+a,method:"GET",timeout:3E4,auth:"user:"+c,user:"user",password:c,headers:{Authorization:"Basic "+(new Buffer("user:"+c)).toString("base64")}};e&&(a.path+="&force=1");this._logger.log("trace","send get access token to:"+JSON.stringify(a));var l=this,f=require("https").request(a,function(a){a.setEncoding("utf8");var e="";a.on("data",function(a){e+=a});a.on("end",function(){if(200==a.statusCode){l._logger.log("trace",
"get access token reponse:"+e);try{var f=JSON.parse(e);f.XC_ERR?d&&d(Error(f.XC_ERR.msg)):f.XC_SUC?d&&d(null,f.XC_SUC.at):d&&d(Error("invalid response"))}catch(h){d&&d(h)}}else l._logger.log("warn","get access token error +"+a.statusCode+":"+e),d&&d(Error("http response:"+a.statusCode))})});if(f.on)f.on("error",function(a){l._logger.log("warn","get access token error:"+a.message);d&&d(a);d=null});f.setTimeout&&f.setTimeout(5E3,function(){f.abort();l._logger.log("warn","get access token timeout");
d&&d(Error("http timeout"));d=null});f.end()};b.prototype._processHMCommands=function(a,c,e){return this._processCommandsFromMap(b.HM_MAP,a,c,e)};b.prototype._processAIOCommands=function(a,c,e){return this._processCommandsFromMap(b.AIO_MAP,a,c,e)};b.prototype._processSonosCommands=function(a,c,e){return this._processCommandsFromMap(b.SONOS_MAP,a,c,e)};b.prototype._processHueCommands=function(a,c,e){return this._processCommandsFromMap(b.HUE_MAP,a,c,e)};b.prototype._processMilightCommands=function(a,
c,e,d){return this._processCommandsFromMap(b.MILIGHT_MAP,a,c,e,d)};b.prototype._processOsramCommands=function(a,c,e){return this._processCommandsFromMap(b.OSRAM_MAP,a,c,e)};b.prototype._processHarmonyCommands=function(a,c,e,d){return this._processCommandsFromMap(b.HARMONY_MAP,a,c,e,d)};b.prototype._processMcontrolCommands=function(a,c,e){if(a&&a.info&&a.info.command){var d=JSON.parse(JSON.stringify(a.info.command));a.info.command=d;a.info.command.push({type:"enum",name:"on",ref:{value:"do",ext:"on"}});
a.info.command.push({type:"enum",name:"off",ref:{value:"do",ext:"off"}});a.info.command.push({type:"enum",name:"up",ref:{value:"do",ext:"up"}});a.info.command.push({type:"enum",name:"down",ref:{value:"do",ext:"down"}});a.info.command.push({type:"int",name:"move to",ref:{value:"setInt",ext:"%d"}})}return this._processCommandsFromMap(null,a,c,e)};b.prototype._processFibaroHCCommands=function(a,c,e){if(e&&"blind"==e.type&&a&&a.info&&a.info.command){for(var d=JSON.parse(JSON.stringify(a.info.command)),
l=0;l<d.length;l++){var f=d[l];switch(f.name){case "open":f.name="up";break;case "close":f.name="down";break;case "up":f.name="step up";break;case "down":f.name="step down";break;case "stop":f.name="off"}}a.info.command=d}return this._processCommandsFromMap(b.FIBAROHC_MAP,a,c,e)};b.prototype._processAVCommands=function(a,c,e,d){return this._processCommandsFromMap(b.AV_MAP,a,c,e,d)};b.prototype._processTadoCommands=function(a,c,e){return this._processCommandsFromMap(b.TADO_MAP,a,c,e)};b.prototype._processNetatmoCommands=
function(a,c,e){return this._processCommandsFromMap(b.NETATMO_MAP,a,c,e)};b.prototype._processCommandsFromMap=function(a,c,e,d,l){e||(e="de");e=e.toLowerCase();for(var f={},t=b.LANG.indexOf(e),k=0;k<c.info.command.length;k++){var g=c.info.command[k];if("string"!=g.type||"aio"==c.info.sys&&"STRING"==c.info.type)if("root"==g.type)this._processRootCommandsFromMap(f,g,a,c,e,d,l);else{var h={type:"POST",url:"/cmd",original:g.name,data:{XC_FNC:"SendRM",device:c.index,command:JSON.parse(JSON.stringify(g.ref))}},
r=g.name.toLowerCase(),p=b.MAP[r]?b.MAP[r][t]:null;(r=a&&a[r]?a[r][t]:null)&&(p=r);var q=null;r=c.info.sys;if(this._customMap&&r&&this._customMap[r]){var n=this._customMap[r];q=n[g.name]?n[g.name][t]:null}q&&(p=q);if("%d"==g.ref.ext||"%f"==g.ref.ext||"%s"==g.ref.ext)h.data.command.ext="{val}","%f"==g.ref.ext&&(h["float"]=1),g.ref.extMeta&&(q=g.ref.extMeta.indexOf("-",1),-1!=q&&(r=parseFloat(g.ref.extMeta.substr(0,q)),q=parseFloat(g.ref.extMeta.substr(q+1)),h.min=r,h.max=q)),g.ref.scale&&(h.step=parseFloat(g.ref.scale)),
p||(p=g.name),"value"==p?f[p]=h:(d&&!d.values&&(d.values={}),d&&d.values&&(d.values[p]=h));else if("%e"==g.ref.ext){if(p||(p=g.name),g.ref.extMeta&&0<g.ref.extMeta.length)for(q=0;q<g.ref.extMeta.length;q++){var u=JSON.parse(JSON.stringify(h));u.data.command.ext=g.ref.extMeta[q];u.original+=" "+g.ref.extMeta[q];var v=p+" "+g.ref.extMeta[q];this._customMap&&r&&this._customMap[r]&&(n=this._customMap[r],(n=n[u.original]?n[u.original][t]:null)&&(v=n));f[v]=u}}else"rgb"==g.type||"rgbw"==g.type?(h=JSON.parse(JSON.stringify(h)),
h.data.command.ext="FF0000",f[b.MAP.red[t]]=h,h=JSON.parse(JSON.stringify(h)),h.data.command.ext="FF00FF",f[b.MAP.purple[t]]=h,h=JSON.parse(JSON.stringify(h)),h.data.command.ext="0000FF",f[b.MAP.blue[t]]=h,h=JSON.parse(JSON.stringify(h)),h.data.command.ext="00FFFF",f[b.MAP.cyan[t]]=h,h=JSON.parse(JSON.stringify(h)),h.data.command.ext="00FF00",f[b.MAP.green[t]]=h,h=JSON.parse(JSON.stringify(h)),h.data.command.ext="FFFF00",f[b.MAP.yellow[t]]=h,h=JSON.parse(JSON.stringify(h)),h.data.command.ext="FF8C00",
f[b.MAP.orange[t]]=h,"rgbw"==g.type&&(h=JSON.parse(JSON.stringify(h)),h.data.command.ext="FFFFFF",f[b.MAP.white[t]]=h)):(p||(p=g.name),f[p]=h,q&&(h.mappedCustom=!0))}}return f};b.prototype._processRootCommandsFromMap=function(a,c,e,d,l,f,t){l||(l="de");l=l.toLowerCase();l=b.LANG.indexOf(l);if(c&&c.value&&c.children&&0!=c.children.length){if("mainzone"!=c.value&&"global"!=c.value){a=f.name+" "+c.name;var k={name:a,sys:f.sys,type:f.type,baseurl:f.baseurl,commands:{}};t[a]=k;a=k.commands}for(t=0;t<c.children.length;t++)if(k=
c.children[t],("string"!=k.type||"aio"==d.info.sys&&"STRING"==d.info.type)&&"root"!=k.type){var g={type:"POST",url:"/cmd",original:k.name,data:{XC_FNC:"SendRM",device:d.index,command:JSON.parse(JSON.stringify(k.ref))}};g.data.command.path=[c.value];var h=k.name.toLowerCase(),r=b.MAP[h]?b.MAP[h][l]:null;(h=e&&e[h]?e[h][l]:null)&&(r=h);var p=null;h=d.info.sys;if(this._customMap&&h&&this._customMap[h]){var q=this._customMap[h];p=q[k.name]?q[k.name][l]:null}p&&(r=p);if("%d"==k.ref.ext||"%f"==k.ref.ext||
"%s"==k.ref.ext)g.data.command.ext="{val}","%f"==k.ref.ext&&(g["float"]=1),k.ref.extMeta&&(p=k.ref.extMeta.indexOf("-",1),-1!=p&&(h=parseFloat(k.ref.extMeta.substr(0,p)),p=parseFloat(k.ref.extMeta.substr(p+1)),g.min=h,g.max=p)),k.ref.scale&&(g.step=parseFloat(k.ref.scale)),r||(r=k.name),"value"!=r&&(f&&!f.values&&(f.values={}),f&&f.values&&(f.values[r]=g));else if("%e"==k.ref.ext){if(r||(r=k.name),k.ref.extMeta&&0<k.ref.extMeta.length)for(p=0;p<k.ref.extMeta.length;p++){var n=JSON.parse(JSON.stringify(g));
n.data.command.ext=k.ref.extMeta[p];n.original+=" "+k.ref.extMeta[p];var u=r+" "+k.ref.extMeta[p];this._customMap&&h&&this._customMap[h]&&(q=this._customMap[h],(q=q[n.original]?q[n.original][l]:null)&&(u=q));a[u]=n}}else"rgb"==k.type||"rgbw"==k.type?(g=JSON.parse(JSON.stringify(g)),g.data.command.ext="FF0000",a[b.MAP.red[l]]=g,g=JSON.parse(JSON.stringify(g)),g.data.command.ext="FF00FF",a[b.MAP.purple[l]]=g,g=JSON.parse(JSON.stringify(g)),g.data.command.ext="0000FF",a[b.MAP.blue[l]]=g,g=JSON.parse(JSON.stringify(g)),
g.data.command.ext="00FFFF",a[b.MAP.cyan[l]]=g,g=JSON.parse(JSON.stringify(g)),g.data.command.ext="00FF00",a[b.MAP.green[l]]=g,g=JSON.parse(JSON.stringify(g)),g.data.command.ext="FFFF00",a[b.MAP.yellow[l]]=g,g=JSON.parse(JSON.stringify(g)),g.data.command.ext="FF8C00",a[b.MAP.orange[l]]=g,"rgbw"==k.type&&(g=JSON.parse(JSON.stringify(g)),g.data.command.ext="FFFFFF",a[b.MAP.white[l]]=g)):(r||(r=k.name),a[r]=g,p&&(g.mappedCustom=!0))}return a}};b.prototype._isDeviceHeater=function(a){var c="HM-CC-RT-DN;HM-CC-RT-DN-BoM;HM-CC-TC;ZEL STG RM FWT;HM-TC-IT-WM-W-EU;HMIP-WTH;HmIP-WTH-2;HMIP-eTRV;HMIP-eTRV-2;HmIP-STHD;HmIP-STH;HmIP-BWTH;HmIP-BWTH24".split(";"),
e="heater thermostat wallthermo wallthermostat ip_heater ip_wallthermo ip_wallthermo2".split(" ");if(!a||!a.info)return!1;a=a.info;if("hm"==a.sys){if(-1!=c.indexOf(a.type))return!0}else if("aio"==a.sys)if("HM"==a.type){if(-1!=e.indexOf(a.data))return!0}else{if("FHT80b"==a.type)return!0}else if("max"==a.sys){if(1==a.type||2==a.type||3==a.type)return!0}else if("tado"==a.sys||"netatmo"==a.sys&&"NATherm1"==a.type)return!0;return!1};b.prototype._getDeviceCatagory=function(a){if(!a||!a.info)return null;
if(this._isDeviceHeater(a))return"heater";if(!a.info.command)return null;if("fibaro"==a.info.sys)return this._getFibaroHCDeviceCatagory(a);for(var c=a.info.command,e=!1,d=0;d<c.length;d++){var b=c[d];if(b&&b.name){b=b.name.toLowerCase();if(("hue"==a.info.sys||"osram"==a.info.sys)&&"brightness"==b)return"light";if("moveto"==b||"move to"==b||"position to"==b||"positionto"==b)return"blind";if("dimto"==b||"dim to"==b||"levelto"==b||"level to"==b)return"light";"on"==b&&(e=!0)}}return e||e?"switch":null};
b.prototype._getFibaroHCDeviceCatagory=function(a){a=a.info.command;for(var c=[],e=0;e<a.length;e++){var d=a[e];d&&d.name&&(d=d.name.toLowerCase(),-1==c.indexOf(d)&&c.push(d))}return-1!=c.indexOf("open")&&-1!=c.indexOf("close")?"blind":-1!=c.indexOf("up")&&-1!=c.indexOf("down")&&-1!=c.indexOf("set value")?"light":-1!=c.indexOf("on")&&-1!=c.indexOf("off")?"switch":null};b.prototype.getAccessToken=function(a,c){if(a)if("aio"!=a.sys&&"neoserver"!=a.sys)c&&c(Error("gateway type invalid"));else{var e=
this,d=require("xnm.aio.gateway.js");if("neoserver"==a.sys){a=JSON.parse(JSON.stringify(a));a.sys="aio";a.version="EA";var b=d.resolveGateway(a,!0)}else b=d.resolveGateway(a);b?d.Admin.getGatewaySID(b,function(f,l){f?(e._logger.log("warn","get gateway sid error:"+f.message),f.code="50001",c&&c(f)):l?d.Admin.V5.getInfo(b,function(d,f){d?(e._logger.log("warn","get gateway info error:"+d.message),d.code="50101",c&&c(d)):f&&f.server?e._getAccessToken(l,a.password,!1,function(d,b){d?(d.code="50003",c&&
c(d)):b?c&&c(null,b,f.server):e._getAccessToken(l,a.password,!0,function(a,d){a?(a.code="50004",c&&c(a)):d?c&&c(null,d,f.server):c&&c(Error("access token empty"))})}):(e._logger.log("warn","gateway has no server"),d.code="50102",c&&c(d))}):(f=Error("remote access not established"),f.code="50002",c&&c())}):c&&c(Error("gateway json invalid"))}else c&&c(Error("gateway json is null"))};b.prototype.generateConfig=function(a,b,e,d,l,f,t,k,g,h){var c=function(a){for(var d=a.length,b={};d--;){var f=a[d];
b[f.index]=f.name}return b}(e),p=function(a){for(var d=a.length,b={};d--;){var f=a[d];b[f.index]=f.name}return b}(d);d={};b=g;e=g.indexOf(":");-1!=e&&(b=g.substr(0,e));for(var q=0;q<a.length;q++){var n=a[q];if(n&&n.cloud&&n.cloud.enabled&&n.info&&n.info.command&&0!=n.info.command.length){g=n.name;e=c[n.room];if("_cameras"==g.substr(0,8)){e=null;var u=g.indexOf(":");g=g.substr(u+1)}if("_webpages"!=g.substr(0,9)){"_progs&sysvars"==e&&(e=p[n.info.gateway],"gw"==g.substr(0,2)&&(u=g.indexOf("_"),g=g.substr(u+
1)));u=n.info.sys;var v=n.info.type,w=this._getDeviceCatagory(n);w&&(v=w);e=(e?e+" ":"")+(g?g:"");n.cloud.alias&&(e=n.cloud.alias);g={name:e,sys:u,type:v,baseurl:"https://"+b+"/rapi/"+t,local:"http://"+k.ip+(k.port?":"+k.port:""),commands:{}};"cam"==u&&(g.manufacturer=n.info.manufacturer);d[e]=g;switch(u){case "hm":e=this._processHMCommands(n,f,g,d);break;case "aio":e=this._processAIOCommands(n,f,g,d);break;case "sonos":e=this._processSonosCommands(n,f,g,d);break;case "hue":e=this._processHueCommands(n,
f,g,d);break;case "easyled":case "milight":case "milightv6":e=this._processMilightCommands(n,f,g,d);break;case "lightify":e=this._processOsramCommands(n,f,g,d);break;case "harmony":e=this._processHarmonyCommands(n,f,g,d);break;case "pioneer":case "onkyo":case "denon":case "yamaha":e=this._processHarmonyCommands(n,f,g,d);break;case "mcontrol":e=this._processMcontrolCommands(n,f,g,d);break;case "fibaro":e=this._processFibaroHCCommands(n,f,g,d);break;case "tado":e=this._processTadoCommands(n,f,g,d);
break;case "netatmo":e=this._processNetatmoCommands(n,f,g,d);break;default:e=this._processCommandsFromMap(null,n,f,g,d)}g.commands=e}}}a={};if(l&&l.groups)for(f=0;f<l.groups.length;f++)if((c=l.groups[f])&&c.macros&&0!=c.macros.length)for(p=c.name,q=0;q<c.macros.length;q++)if(g=c.macros[q],e=g.name,g.cloud&&g.cloud.enabled){e=(p?p+" ":"")+(e?e:"");g.cloud.alias&&(e=g.cloud.alias);var x="";n=e.toLowerCase();u="on off an aus up down auf ab hoch runter ein".split(" ");for(v=0;v<u.length;v++){w=u[v];var y=
n.substr(n.length-w.length);n.length>w.length&&y==w&&(x=e.substr(0,n.length-w.length).trim(),a[x]||(a[x]=[]),a[x].push({original_id:e,command:w}))}g={name:e,type:"scene",baseurl:"https://"+b+"/rapi/"+t,local:"http://"+k.ip+(k.port?":"+k.port:""),commands:{on:{type:"POST",url:"/cmd",data:{XC_FNC:"DoMacroRM",groupIdx:c.index,macroIdx:g.index}}}};d[e]=g}for(x in a){l=a[x];g={name:x,type:"scene",baseurl:"https://"+b+"/rapi/"+t,local:"http://"+k.ip+(k.port?":"+k.port:""),commands:{}};for(e=0;e<l.length;e++)if((f=
l[e])&&f.original_id&&f.command&&(c=f.original_id,p=d[c],delete d[c],p)){c=p.commands.on;p=f.command;switch(f.command){case "on":case "an":case "ein":p="on";break;case "off":case "aus":p="off";break;case "up":case "auf":case "hoch":p="up";break;case "down":case "ab":case "runter":p="down"}g.commands[p]=c}d[x]=g}h&&h(null,d)};b.prototype.uploadConfig=function(a,c,e,d){e={type:"mediola",configuration:e};a={host:require("url").parse(b.REMOTE_SERVER).host,port:443,path:"/alexa/setConfiguration",method:"POST",
timeout:3E4,auth:a+":"+c,user:a,password:c,headers:{"Content-Type":'text/xml; charset="utf-8"',Authorization:"Basic "+(new Buffer(a+":"+c)).toString("base64"),Connection:"close"}};var l=this;this._logger.log("trace","upload config to:"+JSON.stringify(a));a=require("https").request(a,function(a){a.setEncoding("utf8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){if(200==a.statusCode){l._logger.log("trace","upload config reponse:"+b);try{var f=JSON.parse(b);if(f.XC_ERR){var e=Error(f.XC_ERR.msg);
e.code=f.XC_ERR.code;d&&d(e)}else f.XC_SUC&&d&&d()}catch(h){d&&d(h)}}else l._logger.log("warn","upload config error +"+a.statusCode+":"+b),d&&d(Error("http response:"+a.statusCode))})});if(a.on)a.on("error",function(a){l._logger.log("warn","upload config error:"+a.message);d&&d(a);d=null});a.write(JSON.stringify(e));a.end()};b.prototype.setCustomCommandMap=function(a){this._customMap=a};b.prototype.loadCustomComamndMap=function(a,b){var e=require("fs-extra");e.ensureFile(a,function(d){d?b&&b(null,
{}):e.readFile(a,"utf8",function(a,d){if(a)b&&b(a);else if(d)try{var e=JSON.parse(d);b&&b(null,e)}catch(k){b&&b(null,{})}else b&&b(null,{})})})};b.prototype.saveCustomCommandMap=function(a,b,e){var d=require("fs-extra");d.ensureFile(a,function(c){if(c)e&&e(null,{});else try{var f=JSON.stringify(b,null,2);d.writeFile(a,f,function(a){e&&e(a)})}catch(t){e&&e(t)}})};return b}();
m.aio.voicemanager.Handler=function(){var b=function(){this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.Handler");this._devicemanager=this._configmanager=null;this._alexaHandler=new m.aio.voicemanager.AlexaHandler;this.CLOUD_PROTOCOL="https";this.CLOUD_HOST="webservice.mediola.com";this.CLOUD_PORT=443;this.CLOUD_PATH="/account/bindLicense"};b.prototype.CUSTOM_CMD_MAP_FILE="cloud_service_command.map";b.prototype.init=function(a,b,e,d){this._configmanager=a;this._devicemanager=b;this._macromanager=
e;d&&d()};b.prototype.loadCustomComamndMap=function(a,b){var e=this;this._configmanager.trace("/config/tenants/"+a,function(a,c){a?(a.code="50100",b&&b(a)):(a=require("path"),c=c.getFolderPath(),c=a.join(c,e.CUSTOM_CMD_MAP_FILE),e._alexaHandler.loadCustomComamndMap(c,function(a,d){b&&b(a,d)}))})};b.prototype.saveCustomComamndMap=function(a,b,e){var d=this;this._configmanager.trace("/config/tenants/"+a,function(a,f){a?(a.code="50100",e&&e(a)):(a=require("path"),f=f.getFolderPath(),f=a.join(f,d.CUSTOM_CMD_MAP_FILE),
d._alexaHandler.saveCustomCommandMap(f,b,function(a){e&&e(a)}))})};b.prototype.previewAlexaConfig=function(a,b,e,d){if(e){var c={filter:"ui",f_ui_elem:"*",f_ui_type:"command"},f=this;this._alexaHandler.getAccessToken(e,function(l,k,g){l?d&&d(l):f._configmanager.execute("read","/config/tenants/"+a,null,function(h,l){h?(h.code="50013",d&&d(h)):f._devicemanager.execute("read",a,"device",c,function(h,l){h?(h.code="50005",d&&d(h)):f._devicemanager.execute("read",a,"gateway",c,function(c,h){c?(c.code="50006",
d&&d(c)):f._devicemanager.execute("read",a,"gateway",null,function(c,n){c?(c.code="50007",d&&d(c)):f._devicemanager.execute("read",a,"room",null,function(c,p){c?(c.code="50008",d&&d(c)):f._macromanager.execute(a,"read",null,null,null,function(c,q){c?(c.code="50009",d&&d(c)):f.loadCustomComamndMap(a,function(a,c){if(a||!c)c=null;f._alexaHandler.setCustomCommandMap(c);f._alexaHandler.generateConfig(l,h,p,n,q,b,k,e,g,function(a,b){a?(f._logger.log("warn","generate configuration error:"+a.message),a.code=
"50010",d&&d(a)):(a=Object.keys(b))&&0!=a.length?d&&d(null,b):(f._logger.log("warn","generate empty configuration"),a=Error("empty configuration"),a.code="50011",d&&d(a))})})})})})})})})})}else d&&d(Error("gateway invalid"))};b.prototype.exportAlexaConfig=function(a,b,e,d,l,f){if(e)if(l){var c={filter:"ui",f_ui_elem:"*",f_ui_type:"command"},k=this;this._alexaHandler.getAccessToken(l,function(g,h,r){g?f&&f(g):k._configmanager.execute("read","/config/tenants/"+a,null,function(g,q){if(g)g.code="50013",
f&&f(g);else{var n=null;q.license&&"normal"==q.license.type&&q.license.valid&&q.license.license&&(n=q.license.license);k._devicemanager.execute("read",a,"device",c,function(g,p){g?(g.code="50005",f&&f(g)):k._devicemanager.execute("read",a,"gateway",c,function(c,g){c?(c.code="50006",f&&f(c)):k._devicemanager.execute("read",a,"gateway",null,function(c,q){c?(c.code="50007",f&&f(c)):k._devicemanager.execute("read",a,"room",null,function(c,t){c?(c.code="50008",f&&f(c)):k._macromanager.execute(a,"read",
null,null,null,function(c,u){c?(c.code="50009",f&&f(c)):k.loadCustomComamndMap(a,function(a,c){if(a||!c)c=null;k._alexaHandler.setCustomCommandMap(c);k._alexaHandler.generateConfig(p,g,t,q,u,b,h,l,r,function(a,b){a?(k._logger.log("warn","generate configuration error:"+a.message),a.code="50010",f&&f(a)):(a=Object.keys(b))&&0!=a.length?k._alexaHandler.uploadConfig(e,d,b,function(a){a?(k._logger.log("warn","upload configuration error:"+a.message),a.code="000009"==a.code?"50014":"50012",f&&f(a)):n?k.bindLicense(e,
d,n,function(a){a&&k._logger.log("warn","bind user license error:"+a.message);f&&f(null,b)}):f&&f(null,b)}):(k._logger.log("warn","generate empty configuration"),a=Error("empty configuration"),a.code="50011",f&&f(a))})})})})})})})}})})}else f&&f(Error("gateway invalid"));else f&&f(Error("username is null"))};b.prototype.bindLicense=function(a,b,e,d){b={host:this.CLOUD_HOST,port:this.CLOUD_PORT,path:this.CLOUD_PATH+"?license="+e,method:"GET",timeout:3E4,auth:a+":"+b,user:a,password:b,headers:{"Content-Type":'text/xml; charset="utf-8"',
Authorization:"Basic "+(new Buffer(a+":"+b)).toString("base64"),Connection:"close"}};var c=this;this._logger.log("trace","bind license "+e+" to:"+a);a=require(this.CLOUD_PROTOCOL).request(b,function(a){a.setEncoding("utf8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){200==a.statusCode?(c._logger.log("trace","bind license success"),d&&d()):(c._logger.log("warn","bind license success +"+a.statusCode+":"+b),d&&d(Error("http response:"+a.statusCode)));d=null})});if(a.on)a.on("error",
function(a){c._logger.log("warn","upload config error:"+a.message);d&&d(a);d=null});a.setTimeout(3E4,function(){d&&d(Error("timeout"));d=null});a.end()};return b}();"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.voicemanager.Handler);
