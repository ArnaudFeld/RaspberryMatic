"use strict";function _typeof(o){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o;}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o;},_typeof(o);}function _createForOfIteratorHelper(o,allowArrayLike){var it=typeof Symbol!=="undefined"&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length==="number"){if(it)o=it;var i=0;var F=function F(){};return{s:F,n:function n(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]};},e:function e(_e49){throw _e49;},f:F};}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}var normalCompletion=true,didErr=false,err;return{s:function s(){it=it.call(o);},n:function n(){var step=it.next();normalCompletion=step.done;return step;},e:function e(_e50){didErr=true;err=_e50;},f:function f(){try{if(!normalCompletion&&it["return"]!=null)it["return"]();}finally{if(didErr)throw err;}}};}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen);}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2;}function _regeneratorRuntime(){"use strict";/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */_regeneratorRuntime=function _regeneratorRuntime(){return e;};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value;},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",c=i.asyncIterator||"@@asyncIterator",u=i.toStringTag||"@@toStringTag";function define(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e];}try{define({},"");}catch(t){define=function define(t,e,r){return t[e]=r;};}function wrap(t,e,r,n){var i=e&&e.prototype instanceof Generator?e:Generator,a=Object.create(i.prototype),c=new Context(n||[]);return o(a,"_invoke",{value:makeInvokeMethod(t,r,c)}),a;}function tryCatch(t,e,r){try{return{type:"normal",arg:t.call(e,r)};}catch(t){return{type:"throw",arg:t};}}e.wrap=wrap;var h="suspendedStart",l="suspendedYield",f="executing",s="completed",y={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,a,function(){return this;});var d=Object.getPrototypeOf,v=d&&d(d(values([])));v&&v!==r&&n.call(v,a)&&(p=v);var g=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach(function(e){define(t,e,function(t){return this._invoke(e,t);});});}function AsyncIterator(t,e){function invoke(r,o,i,a){var c=tryCatch(t[r],t,o);if("throw"!==c.type){var u=c.arg,h=u.value;return h&&"object"==_typeof(h)&&n.call(h,"__await")?e.resolve(h.__await).then(function(t){invoke("next",t,i,a);},function(t){invoke("throw",t,i,a);}):e.resolve(h).then(function(t){u.value=t,i(u);},function(t){return invoke("throw",t,i,a);});}a(c.arg);}var r;o(this,"_invoke",{value:function value(t,n){function callInvokeWithMethodAndArg(){return new e(function(e,r){invoke(t,n,e,r);});}return r=r?r.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg();}});}function makeInvokeMethod(e,r,n){var o=h;return function(i,a){if(o===f)throw new Error("Generator is already running");if(o===s){if("throw"===i)throw a;return{value:t,done:!0};}for(n.method=i,n.arg=a;;){var c=n.delegate;if(c){var u=maybeInvokeDelegate(c,n);if(u){if(u===y)continue;return u;}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===h)throw o=s,n.arg;n.dispatchException(n.arg);}else"return"===n.method&&n.abrupt("return",n.arg);o=f;var p=tryCatch(e,r,n);if("normal"===p.type){if(o=n.done?s:l,p.arg===y)continue;return{value:p.arg,done:n.done};}"throw"===p.type&&(o=s,n.method="throw",n.arg=p.arg);}};}function maybeInvokeDelegate(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator["return"]&&(r.method="return",r.arg=t,maybeInvokeDelegate(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),y;var i=tryCatch(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,y;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,y):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,y);}function pushTryEntry(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e);}function resetTryEntry(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e;}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0);}function values(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function next(){for(;++o<e.length;)if(n.call(e,o))return next.value=e[o],next.done=!1,next;return next.value=t,next.done=!0,next;};return i.next=i;}}throw new TypeError(_typeof(e)+" is not iterable");}return GeneratorFunction.prototype=GeneratorFunctionPrototype,o(g,"constructor",{value:GeneratorFunctionPrototype,configurable:!0}),o(GeneratorFunctionPrototype,"constructor",{value:GeneratorFunction,configurable:!0}),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===GeneratorFunction||"GeneratorFunction"===(e.displayName||e.name));},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(g),t;},e.awrap=function(t){return{__await:t};},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,function(){return this;}),e.AsyncIterator=AsyncIterator,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new AsyncIterator(wrap(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then(function(t){return t.done?t.value:a.next();});},defineIteratorMethods(g),define(g,u,"Generator"),define(g,a,function(){return this;}),define(g,"toString",function(){return"[object Generator]";}),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function next(){for(;r.length;){var t=r.pop();if(t in e)return next.value=t,next.done=!1,next;}return next.done=!0,next;};},e.values=values,Context.prototype={constructor:Context,reset:function reset(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(resetTryEntry),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t);},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval;},dispatchException:function dispatchException(e){if(this.done)throw e;var r=this;function handle(n,o){return a.type="throw",a.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o;}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],a=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var c=n.call(i,"catchLoc"),u=n.call(i,"finallyLoc");if(c&&u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc);}else if(c){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc);}}}},abrupt:function abrupt(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break;}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,y):this.complete(a);},complete:function complete(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),y;},finish:function finish(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),resetTryEntry(r),y;}},"catch":function _catch(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;resetTryEntry(r);}return o;}}throw new Error("illegal catch attempt");},delegateYield:function delegateYield(e,r,n){return this.delegate={iterator:values(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),y;}},e;}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value;}catch(error){reject(error);return;}if(info.done){resolve(value);}else{Promise.resolve(value).then(_next,_throw);}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value);}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err);}_next(undefined);});};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,_toPropertyKey(descriptor.key),descriptor);}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);Object.defineProperty(Constructor,"prototype",{writable:false});return Constructor;}function _toPropertyKey(arg){var key=_toPrimitive(arg,"string");return _typeof(key)==="symbol"?key:String(key);}function _toPrimitive(input,hint){if(_typeof(input)!=="object"||input===null)return input;var prim=input[Symbol.toPrimitive];if(prim!==undefined){var res=prim.call(input,hint||"default");if(_typeof(res)!=="object")return res;throw new TypeError("@@toPrimitive must return a primitive value.");}return(hint==="string"?String:Number)(input);}var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.junghome=xnm.aio.junghome||{},xnm.aio.junghome={_logger:{log:function log(){}},parseJSON:function parseJSON(e){return new xnm.aio.junghome.JungGateway(e);}},xnm.aio.junghome.Helpers={normalizeValue:function normalizeValue(e,t){switch(e.key){case"switch":case"status_led":e.value="heater"==t?"1"==e.value?"auto":"manual":"1"==e.value?"on":"off";break;case"up_request":case"down_request":case"trigger_request":e.value="1"==e.value?"pressed":"released";case"level_move":"1"==e.value&&(e.value="closing"),"0"==e.value&&(e.value="stopped"),"-1"==e.value&&(e.value="opening");}}},xnm.aio.junghome.JungGateway=/*#__PURE__*/function(){function e(_e,t){_classCallCheck(this,e);"undefined"==typeof require||null==require?this._logger={log:function log(e,t){console&&console.log&&(e&&"error"!=e?console.log(e,t):console.log("error",t,t.stack));}}:this._logger=require("x.logger.js").getLogger("xnm.aio.junghome.JungGateway"),this.REQUESTS_TIMEOUT_MS=t||1e4,this.gwInfo=_e,this.CommandHandler=null,this.cachedFunctions=null;}_createClass(e,[{key:"_doRequest",value:function _doRequest(_e2,t,a,n,o){var r={host:this.gwInfo.ip,port:this.gwInfo.port,path:t,method:_e2,timeout:this.REQUESTS_TIMEOUT_MS,headers:{Connection:"close","Content-Type":"application/json"},rejectUnauthorized:!1};if(this.gwInfo.token&&(r.headers.token=this.gwInfo.token),a)for(var s in a)a.hasOwnProperty(s)&&(r.headers[s]=a[s]);n&&n.length&&(r.headers["Content-Length"]=n.length);var i=require("https"),u=this,l=o,m=i.request(r,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){if(u._logger.log("debug","request on ".concat(r.path," ==> receive code: ").concat(e.statusCode)),e.statusCode>299)return u._logger.log("error","response:"+e.statusMessage),void(l&&(l(new Error(e.statusMessage),t,e),l=null));try{t=JSON.parse(t);}catch(e){}l&&(l(null,t,e),l=null);});});m.on&&m.on("error",function(e){u._logger.log("error","do request error:"+e.message),l&&(l(e),l=null);}),m.setTimeout&&m.setTimeout(this.REQUESTS_TIMEOUT_MS,function(){u._logger.log("error","do request timeout"),m.abort(),l&&(l(new Error("timeout")),l=null);}),n&&(this._logger.log("debug","request body: "+n),m.write(n)),m.end();}},{key:"get",value:function(){var _get=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(_e3,t,a){var _this=this;return _regeneratorRuntime().wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:return _context.abrupt("return",new Promise(function(n,o){_this._doRequest("GET",_e3,t,a,function(_e4,t){_e4&&o(_e4),n(t);});}));case 1:case"end":return _context.stop();}},_callee);}));function get(_x,_x2,_x3){return _get.apply(this,arguments);}return get;}()},{key:"post",value:function(){var _post=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(_e5,t,a){var _this2=this;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1)switch(_context2.prev=_context2.next){case 0:return _context2.abrupt("return",new Promise(function(n,o){_this2._doRequest("POST",_e5,t,a,function(_e6,t){_e6&&o(_e6),n(t);});}));case 1:case"end":return _context2.stop();}},_callee2);}));function post(_x4,_x5,_x6){return _post.apply(this,arguments);}return post;}()},{key:"put",value:function(){var _put=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee3(_e7,t,a){var _this3=this;return _regeneratorRuntime().wrap(function _callee3$(_context3){while(1)switch(_context3.prev=_context3.next){case 0:return _context3.abrupt("return",new Promise(function(n,o){_this3._doRequest("PUT",_e7,t,a,function(_e8,t){_e8&&o(_e8),n(t);});}));case 1:case"end":return _context3.stop();}},_callee3);}));function put(_x7,_x8,_x9){return _put.apply(this,arguments);}return put;}()},{key:"patch",value:function(){var _patch=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee4(_e9,t,a){var _this4=this;return _regeneratorRuntime().wrap(function _callee4$(_context4){while(1)switch(_context4.prev=_context4.next){case 0:return _context4.abrupt("return",new Promise(function(n,o){_this4._doRequest("PATCH",_e9,t,a,function(_e10,t){_e10&&o(_e10),n(t);});}));case 1:case"end":return _context4.stop();}},_callee4);}));function patch(_x10,_x11,_x12){return _patch.apply(this,arguments);}return patch;}()},{key:"isJungGateway",value:function(){var _isJungGateway=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee5(){var _t,t;return _regeneratorRuntime().wrap(function _callee5$(_context5){while(1)switch(_context5.prev=_context5.next){case 0:if(!e.gatewaysCache[this.gwInfo.ip]){_context5.next=4;break;}_t=e.gatewaysCache[this.gwInfo.ip];if(!(Date.now()-_t.time<e.cacheTime&&_t.gwInfo)){_context5.next=4;break;}return _context5.abrupt("return",(this._logger.log("debug","is Jung Home gateway based on cached data"),_t.gwInfo));case 4:_context5.next=6;return this._hasGatewayHomePage();case 6:if(_context5.sent){_context5.next=8;break;}return _context5.abrupt("return",!1);case 8:t={ip:this.gwInfo.ip};return _context5.abrupt("return",(e.gatewaysCache[this.gwInfo.ip]={time:Date.now(),gwInfo:t},t));case 10:case"end":return _context5.stop();}},_callee5,this);}));function isJungGateway(){return _isJungGateway.apply(this,arguments);}return isJungGateway;}()},{key:"_hasGatewayHomePage",value:function(){var _hasGatewayHomePage2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee6(){return _regeneratorRuntime().wrap(function _callee6$(_context6){while(1)switch(_context6.prev=_context6.next){case 0:return _context6.abrupt("return",this.get("/").then(function(_e11){return!(!_e11||!_e11.includes("JUNG HOME Gateway"));})["catch"](function(_e12){return!1;}));case 1:case"end":return _context6.stop();}},_callee6,this);}));function _hasGatewayHomePage(){return _hasGatewayHomePage2.apply(this,arguments);}return _hasGatewayHomePage;}()},{key:"getToken",value:function(){var _getToken=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee7(_e13){var t,a;return _regeneratorRuntime().wrap(function _callee7$(_context7){while(1)switch(_context7.prev=_context7.next){case 0:_e13&&"string"==typeof _e13||(_e13="Mediola Creator Neo"),_e13.startsWith("Mediola")||(_e13="Mediola ".concat(_e13));t={user_name:_e13};_context7.next=4;return this.post("/api/junghome/register",null,JSON.stringify(t));case 4:a=_context7.sent;if(a){_context7.next=7;break;}throw this.generateJungError("can not get token, no result",3);case 7:if(a.token){_context7.next=9;break;}throw this.generateJungError("no token : ".concat(a),3);case 9:return _context7.abrupt("return",a.token);case 10:case"end":return _context7.stop();}},_callee7,this);}));function getToken(_x13){return _getToken.apply(this,arguments);}return getToken;}()},{key:"getDevices",value:function(){var _getDevices=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee8(_e14){var t,a,n,o,r;return _regeneratorRuntime().wrap(function _callee8$(_context8){while(1)switch(_context8.prev=_context8.next){case 0:_context8.prev=0;_context8.next=3;return this.isJungGateway();case 3:if(_context8.sent){_context8.next=5;break;}throw this.generateJungError("gateway is unreachable");case 5:_context8.next=7;return this.getGatewayFunctions();case 7:t=_context8.sent;_context8.next=10;return this.getGatewayScenes();case 10:a=_context8.sent;if(!(!t||!t.length)){_context8.next=13;break;}throw this.generateJungError("functions are empty");case 13:_context8.next=15;return this.getGatewayGroups();case 15:n=_context8.sent;o=this._convertFunctionsToMediolaDevices(t,n);r=this._convertScenesToMediolaDevices(a);_e14(null,o.concat(r));_context8.next=24;break;case 21:_context8.prev=21;_context8.t0=_context8["catch"](0);xnm.aio.junghome.DM._handleError(_context8.t0,_e14);case 24:case"end":return _context8.stop();}},_callee8,this,[[0,21]]);}));function getDevices(_x14){return _getDevices.apply(this,arguments);}return getDevices;}()},{key:"_convertFunctionsToMediolaDevices",value:function _convertFunctionsToMediolaDevices(_e15,t){var _this5=this;var a=[],n=[];var o=1;var _iterator=_createForOfIteratorHelper(_e15),_step;try{var _loop=function _loop(){var r=_step.value;try{var _e16={name:void 0,roomName:void 0,sys:"junghome",address:void 0,type:void 0,jungInfo:void 0};if(_e16.jungInfo=r,r.label&&(_e16.name=r.label,n.includes(_e16.name)&&(_e16.name="".concat(_e16.name),o>=1&&(_e16.name+=" - ".concat(o)),o++),n.push(_e16.name)),r.id&&(_e16.address=r.id),r.parent_groups){var _a="";r.parent_groups.forEach(function(_e17){var n=t.find(function(t){return t.id==_e17;});if(!n)return;var o=n.name;_a+=o+" ";}),_e16.roomName=_a.trim().replace(/\s/,"-");}_e16.type=_this5._findDeviceType(r.type),_e16.type&&"undefined"!==_e16.type&&a.push(_e16);}catch(_e18){_this5._logger.log("error","problematic function: ".concat(JSON.stringify(r))),_this5._logger.log("error",_e18);}};for(_iterator.s();!(_step=_iterator.n()).done;){_loop();}}catch(err){_iterator.e(err);}finally{_iterator.f();}return a;}},{key:"_convertScenesToMediolaDevices",value:function _convertScenesToMediolaDevices(_e19){var t=[],a=[];var n=1;var _iterator2=_createForOfIteratorHelper(_e19),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var o=_step2.value;try{var _e20={name:void 0,roomName:void 0,sys:"junghome",address:void 0,type:void 0,jungInfo:void 0};_e20.jungInfo=o,o.label&&(_e20.name=o.label,a.includes(_e20.name)&&(_e20.name="".concat(_e20.name),n>1&&(_e20.name+=" - ".concat(n)),n++),a.push(_e20.name)),o.id&&(_e20.address=o.id),_e20.type="scene",t.push(_e20);}catch(_e21){this._logger.log("error","problematic scene: ".concat(JSON.stringify(o))),this._logger.log("error",_e21);}}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}return t;}},{key:"_findDeviceType",value:function _findDeviceType(_e22){var t="undefined";switch(_e22){case"OnOff":t="switch";break;case"DimmerLight":t="dimmer";break;case"ColorLight":t="dimmerrgbw";break;case"Position":t="shutter";break;case"PositionAndAngle":t="blind";break;case"Thermostat":t="heater";break;case"Socket":t="socket";break;case"Measurement":t="measurement";break;case"RockerSwitch":t="rocker_switch";break;case"Trigger":t="trigger";}return this._logger.log("debug","[JungGateway._findDeviceType] Assigned function type \"".concat(_e22,"\" as device type \"").concat(t,"\".")),t;}},{key:"executeCommandCreator",value:function(){var _executeCommandCreator=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee9(_e23,t,a){var n,o,r,s,i,u,l;return _regeneratorRuntime().wrap(function _callee9$(_context9){while(1)switch(_context9.prev=_context9.next){case 0:this._logger.log("debug","executing ".concat(t.value," on ").concat(_e23.address));_context9.prev=1;_context9.next=4;return this.isJungGateway();case 4:if(_context9.sent){_context9.next=6;break;}return _context9.abrupt("return",void a(this.generateJungError("gateway is unreachable",5)));case 6:n=_e23.jungInfo;if(n){_context9.next=9;break;}throw this.generateJungError("function or scene info is not valid",3);case 9:if(!("scene"==t.value)){_context9.next=13;break;}_context9.next=12;return this.runScene(n.id);case 12:return _context9.abrupt("return",void a(null));case 13:o=this.getDataPointValueKeyType(t);r=this.getDataPointType(t);s=n.datapoints.find(function(_e24){return _e24.type==r;});if(s){_context9.next=18;break;}throw this._logger.log("error","device ".concat(JSON.stringify(_e23)," for running commands has problem - command : ").concat(t)),this.generateJungError("problem with data",3);case 18:i=n.id;u=s.id;_context9.next=22;return this.getDataPointKeyTypeValue(t,i,u,o);case 22:l=_context9.sent;_context9.next=25;return this.setDataPoint(i,u,{key:o,value:l});case 25:a(null);_context9.next=31;break;case 28:_context9.prev=28;_context9.t0=_context9["catch"](1);this._logger.log("error",_context9.t0),a(_context9.t0);case 31:case"end":return _context9.stop();}},_callee9,this,[[1,28]]);}));function executeCommandCreator(_x15,_x16,_x17){return _executeCommandCreator.apply(this,arguments);}return executeCommandCreator;}()},{key:"getDataPointType",value:function getDataPointType(_e26){var t=_e26.value;return _e26.value.includes("::")&&(t=_e26.value.split("::")[0]),this.getDataPointValueKeyType({value:t});}},{key:"getDataPointKeyTypeValue",value:function(){var _getDataPointKeyTypeValue=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee10(_e27,t,a,n){var o,r;return _regeneratorRuntime().wrap(function _callee10$(_context10){while(1)switch(_context10.prev=_context10.next){case 0:r=_e27.value;_context10.t0=(r.includes("::")&&(r=_e27.value.split("::")[1]),r);_context10.next=_context10.t0==="on"?4:_context10.t0==="off"?6:_context10.t0==="level_move"?6:_context10.t0==="Up"?6:_context10.t0==="toggle"?8:_context10.t0==="brightness"?13:_context10.t0==="level"?13:_context10.t0==="angle"?13:_context10.t0==="temperature_ctrl"?13:_context10.t0==="temperature_ctrl_preset"?13:_context10.t0==="color_temperature"?13:_context10.t0==="Down"?15:_context10.t0==="StepUp"?17:_context10.t0==="StepDown"?22:_context10.t0==="mode"?27:28;break;case 4:o=1;return _context10.abrupt("break",28);case 6:o=0;return _context10.abrupt("break",28);case 8:_context10.next=10;return this.getCurrentValueOfKey(t,a,n);case 10:o=_context10.sent;o=1==o?0:1;return _context10.abrupt("break",28);case 13:o=_e27.ext;return _context10.abrupt("break",28);case 15:o=100;return _context10.abrupt("break",28);case 17:_context10.next=19;return this.getCurrentValueOfKey(t,a,n);case 19:o=_context10.sent;o<100&&o++;return _context10.abrupt("break",28);case 22:_context10.next=24;return this.getCurrentValueOfKey(t,a,n);case 24:o=_context10.sent;o>0&&o--;return _context10.abrupt("break",28);case 27:"auto"==_e27.ext&&(o=1),"manual"==_e27.ext&&(o=0);case 28:return _context10.abrupt("return","".concat(o));case 29:case"end":return _context10.stop();}},_callee10,this);}));function getDataPointKeyTypeValue(_x18,_x19,_x20,_x21){return _getDataPointKeyTypeValue.apply(this,arguments);}return getDataPointKeyTypeValue;}()},{key:"getDataPointValueKeyType",value:function getDataPointValueKeyType(_e28){var t,a=_e28.value;switch(a.includes("::")&&(a=_e28.value.split("::")[1]),a){case"on":case"off":case"toggle":case"mode":t="switch";break;case"brightness":t="brightness";break;case"level":case"Up":case"Down":case"StepUp":case"StepDown":t="level";break;case"level_move":t="level_move";break;case"angle":t="angle";break;case"temperature_ctrl":t="temperature_ctrl";break;case"temperature_ctrl_preset":t="temperature_ctrl_preset";break;case"color_temperature":t="color_temperature";}return t;}},{key:"getStatesCreator",value:function(){var _getStatesCreator=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee11(_e29,t,a){var _this6=this;var _e30,n,_iterator3,_step3,_loop2,_ret;return _regeneratorRuntime().wrap(function _callee11$(_context12){while(1)switch(_context12.prev=_context12.next){case 0:_context12.prev=0;_e30=[];_context12.next=4;return this.isJungGateway();case 4:if(_context12.sent){_context12.next=6;break;}return _context12.abrupt("return",(t.forEach(function(t){_e30.push({id:t.id,status:"gateway unreachable"});}),void a(null,_e30)));case 6:_context12.next=8;return this.getGatewayFunctions();case 8:n=_context12.sent;_iterator3=_createForOfIteratorHelper(t);_context12.prev=10;_loop2=/*#__PURE__*/_regeneratorRuntime().mark(function _loop2(){var a,t,o,r,s,i,u,l,m,_e32,c;return _regeneratorRuntime().wrap(function _loop2$(_context11){while(1)switch(_context11.prev=_context11.next){case 0:a=_step3.value;t=a.device,o=n.find(function(_e31){return _e31.id==t.address;});if(!(!o||!o.datapoints)){_context11.next=4;break;}return _context11.abrupt("return",0);case 4:r=o.datapoints,s=a.status;l=s.value,m=s.value;if(l.includes("::")){_e32=l.split("::");l=_e32[0],m=_e32[1],3==_e32.length&&"quantity"==l&&(i=_e32[2]);}if(!(u="quantity"==l?r.find(function(_e33){return _e33.type==l&&_e33.id==i;}):r.find(function(_e34){return _e34.type==l;}),!u)){_context11.next=9;break;}return _context11.abrupt("return",0);case 9:c=u.values.find(function(_e35){return _e35.key==m;});null==c||null==c?(_this6._logger.log("warn","unavailable state for ".concat(l," : ").concat(m)),_e30.push({id:a.id,status:"undefined"})):(xnm.aio.junghome.Helpers.normalizeValue(c,t.type),_e30.push({id:a.id,status:c.value}));case 11:case"end":return _context11.stop();}},_loop2);});_iterator3.s();case 13:if((_step3=_iterator3.n()).done){_context12.next=20;break;}return _context12.delegateYield(_loop2(),"t0",15);case 15:_ret=_context12.t0;if(!(_ret===0)){_context12.next=18;break;}return _context12.abrupt("continue",18);case 18:_context12.next=13;break;case 20:_context12.next=25;break;case 22:_context12.prev=22;_context12.t1=_context12["catch"](10);_iterator3.e(_context12.t1);case 25:_context12.prev=25;_iterator3.f();return _context12.finish(25);case 28:a(null,_e30);_context12.next=34;break;case 31:_context12.prev=31;_context12.t2=_context12["catch"](0);this._logger.log("error",_context12.t2),a(_context12.t2);case 34:case"end":return _context12.stop();}},_callee11,this,[[0,31],[10,22,25,28]]);}));function getStatesCreator(_x22,_x23,_x24){return _getStatesCreator.apply(this,arguments);}return getStatesCreator;}()},{key:"getGatewayFunctions",value:function(){var _getGatewayFunctions=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee12(){return _regeneratorRuntime().wrap(function _callee12$(_context13){while(1)switch(_context13.prev=_context13.next){case 0:return _context13.abrupt("return",this.get("/api/junghome/functions/"));case 1:case"end":return _context13.stop();}},_callee12,this);}));function getGatewayFunctions(){return _getGatewayFunctions.apply(this,arguments);}return getGatewayFunctions;}()},{key:"getGatewayFunction",value:function(){var _getGatewayFunction=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee13(_e37){return _regeneratorRuntime().wrap(function _callee13$(_context14){while(1)switch(_context14.prev=_context14.next){case 0:return _context14.abrupt("return",this.get("/api/junghome/functions/".concat(_e37)));case 1:case"end":return _context14.stop();}},_callee13,this);}));function getGatewayFunction(_x25){return _getGatewayFunction.apply(this,arguments);}return getGatewayFunction;}()},{key:"getDataPoint",value:function(){var _getDataPoint=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee14(_e38,t){return _regeneratorRuntime().wrap(function _callee14$(_context15){while(1)switch(_context15.prev=_context15.next){case 0:return _context15.abrupt("return",this.get("/api/junghome/functions/".concat(_e38,"/datapoints/").concat(t)));case 1:case"end":return _context15.stop();}},_callee14,this);}));function getDataPoint(_x26,_x27){return _getDataPoint.apply(this,arguments);}return getDataPoint;}()},{key:"getCurrentValueOfKey",value:function(){var _getCurrentValueOfKey=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee15(_e39,t,a){var n,o;return _regeneratorRuntime().wrap(function _callee15$(_context16){while(1)switch(_context16.prev=_context16.next){case 0:_context16.next=2;return this.getDataPoint(_e39,t);case 2:n=_context16.sent;if(n.values){_context16.next=5;break;}throw this.generateJungError("can not get current value of ".concat(_e39,"/").concat(t,"/").concat(a));case 5:o=n.values.find(function(_e40){return _e40.key==a;});if(!(null==o||null==o)){_context16.next=8;break;}throw this.generateJungError("".concat(a," is not in values of ").concat(_e39,"/").concat(t));case 8:return _context16.abrupt("return",o.value);case 9:case"end":return _context16.stop();}},_callee15,this);}));function getCurrentValueOfKey(_x28,_x29,_x30){return _getCurrentValueOfKey.apply(this,arguments);}return getCurrentValueOfKey;}()},{key:"getGatewayScenes",value:function(){var _getGatewayScenes=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee16(){return _regeneratorRuntime().wrap(function _callee16$(_context17){while(1)switch(_context17.prev=_context17.next){case 0:return _context17.abrupt("return",this.get("/api/junghome/scenes/"));case 1:case"end":return _context17.stop();}},_callee16,this);}));function getGatewayScenes(){return _getGatewayScenes.apply(this,arguments);}return getGatewayScenes;}()},{key:"runScene",value:function(){var _runScene=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee17(_e41){return _regeneratorRuntime().wrap(function _callee17$(_context18){while(1)switch(_context18.prev=_context18.next){case 0:return _context18.abrupt("return",this.post("/api/junghome/scenes/".concat(_e41)));case 1:case"end":return _context18.stop();}},_callee17,this);}));function runScene(_x31){return _runScene.apply(this,arguments);}return runScene;}()},{key:"setDataPoint",value:function(){var _setDataPoint=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee18(_e42,t,a){var n;return _regeneratorRuntime().wrap(function _callee18$(_context19){while(1)switch(_context19.prev=_context19.next){case 0:n={data:[a]};return _context19.abrupt("return",this.patch("/api/junghome/functions/".concat(_e42,"/datapoints/").concat(t),null,JSON.stringify(n)));case 2:case"end":return _context19.stop();}},_callee18,this);}));function setDataPoint(_x32,_x33,_x34){return _setDataPoint.apply(this,arguments);}return setDataPoint;}()},{key:"getGatewayGroups",value:function(){var _getGatewayGroups=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee19(){return _regeneratorRuntime().wrap(function _callee19$(_context20){while(1)switch(_context20.prev=_context20.next){case 0:return _context20.abrupt("return",this.get("/api/junghome/groups/"));case 1:case"end":return _context20.stop();}},_callee19,this);}));function getGatewayGroups(){return _getGatewayGroups.apply(this,arguments);}return getGatewayGroups;}()},{key:"getLatestFunctionDefinitions",value:function(){var _getLatestFunctionDefinitions=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee20(){return _regeneratorRuntime().wrap(function _callee20$(_context21){while(1)switch(_context21.prev=_context21.next){case 0:return _context21.abrupt("return",this.get("/api/junghome/types/functions"));case 1:case"end":return _context21.stop();}},_callee20,this);}));function getLatestFunctionDefinitions(){return _getLatestFunctionDefinitions.apply(this,arguments);}return getLatestFunctionDefinitions;}()},{key:"_prepareToken",value:function(){var _prepareToken2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee21(){var _e43;return _regeneratorRuntime().wrap(function _callee21$(_context22){while(1)switch(_context22.prev=_context22.next){case 0:if(!this.gwInfo.token){_context22.next=2;break;}return _context22.abrupt("return",this.gwInfo.token);case 2:_context22.next=4;return this.getToken(this.gwInfo.username);case 4:_e43=_context22.sent;return _context22.abrupt("return",(this.gwInfo.token=_e43,_e43));case 6:case"end":return _context22.stop();}},_callee21,this);}));function _prepareToken(){return _prepareToken2.apply(this,arguments);}return _prepareToken;}()},{key:"equalsTo",value:function equalsTo(t){return!!t&&t instanceof e&&this.gwInfo.ip==t.gwInfo.ip;}},{key:"generateJungError",value:function generateJungError(_e44,t){return new xnm.aio.junghome.DM.Error(t,_e44);}}]);return e;}(),xnm.aio.junghome.JungGateway.gatewaysCache={},xnm.aio.junghome.JungGateway.cacheTime=3e5,xnm.aio.junghome.DM={MAP:{"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"switch",options:["on","off"]}}],ipevt:[{type:"enum",name:"state",ref:{value:"switch",options:["on","off"]}}]},dimmer:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"brightness",ref:{value:"brightness",value_t:"brightness",ext:"%d",extMeta:"0-100"}}],status:[{type:"enum",name:"state",ref:{value:"switch",options:["on","off"]}},{type:"int",name:"brightness",ref:{value:"brightness",value_t:"brightness",ext:"%d",extMeta:"0-100"}}],ipevt:[{type:"enum",name:"state",ref:{value:"switch",options:["on","off"]}},{type:"int",name:"brightness",ref:{value:"brightness",value_t:"brightness",ext:"%d",extMeta:"0-100"}}]},shutter:{command:[{type:"enum",name:"step up",ref:{value:"StepUp",value_t:"stepUp"}},{type:"enum",name:"step down",ref:{value:"StepDown",value_t:"stepDown"}},{type:"enum",name:"move up",ref:{value:"Up",value_t:"moveUp"}},{type:"enum",name:"move down",ref:{value:"Down",value_t:"moveDown"}},{type:"int",name:"position",ref:{value:"level::level",value_t:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"stop",ref:{value:"level::level_move",value_t:"stop"}}],status:[{type:"int",name:"position",ref:{value:"level::level",value_t:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"state",ref:{value:"level::level_move",options:["stopped","closing","opening"]}}],ipevt:[{type:"int",name:"position",ref:{value:"level::level",value_t:"position",ext:"%d",extMeta:"0-100"}}]},blind:{command:[{type:"enum",name:"step up",ref:{value:"StepUp",value_t:"stepUp"}},{type:"enum",name:"step down",ref:{value:"StepDown",value_t:"stepDown"}},{type:"enum",name:"move up",ref:{value:"Up",value_t:"moveUp"}},{type:"enum",name:"move down",ref:{value:"Down",value_t:"moveDown"}},{type:"int",name:"position",ref:{value:"level::level",value_t:"position",ext:"%d",extMeta:"0-100"}},{type:"int",name:"slat position",ref:{value:"angle",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"stop",ref:{value:"level::level_move",value_t:"stop"}}],status:[{type:"int",name:"position",ref:{value:"level::level",value_t:"position",ext:"%d",extMeta:"0-100"}},{type:"int",name:"slat position",ref:{value:"angle"}},{type:"enum",name:"state",ref:{value:"level::level_move",options:["stopped","closing","opening"]}}],ipevt:[{type:"int",name:"position",ref:{value:"level::level",value_t:"position",ext:"%d",extMeta:"0-100"}},{type:"int",name:"slat position",ref:{value:"angle"}}]},heater:{command:[{type:"float",name:"set temperature",ref:{value:"temperature_ctrl::temperature_ctrl",value_t:"setpointTemp",ext:"%d",extMeta:"5-30"}},{type:"enum",name:"preset mode",ref:{value:"temperature_ctrl::temperature_ctrl_preset",ext:"%e",extMeta:["frost","eco","comfort"]}},{type:"enum",name:"mode",ref:{value:"mode",value_t:"mode",ext:"%e",extMeta:["auto","manual"]}}],status:[{type:"float",name:"set temperature",ref:{value:"temperature_ctrl::temperature_ctrl",value_t:"setpointTemp",unit:"degrees Celsius"}},{type:"enum",name:"preset mode",ref:{value:"temperature_ctrl::temperature_ctrl_preset",options:["none","frost","eco","comfort"]}},{type:"enum",name:"mode",ref:{value:"switch",value_t:"mode",ext:"%e",extMeta:["auto","manual"]}}],ipevt:[{type:"float",name:"set temperature",ref:{value:"temperature_ctrl::temperature_ctrl",value_t:"setpointTemp",unit:"degrees Celsius"}},{type:"enum",name:"preset mode",ref:{value:"temperature_ctrl::temperature_ctrl_preset",options:["none","frost","eco","comfort"]}},{type:"enum",name:"mode",ref:{value:"switch",value_t:"mode",ext:"%e",extMeta:["auto","manual"]}}]},dimmerrgbw:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"brightness",ref:{value:"brightness",value_t:"brightness",ext:"%d",extMeta:"0-100"}},{type:"int",name:"color temperature",ref:{value:"color_temperature",value_t:"color_temperature",ext:"%d",extMeta:"800-20000"}}],status:[{type:"enum",name:"state",ref:{value:"switch",options:["on","off"]}},{type:"int",name:"brightness",ref:{value:"brightness",value_t:"brightness"}},{type:"int",name:"color temperature",ref:{value:"color_temperature",value_t:"color_temperature",unit:"Kelvin"}}],ipevt:[{type:"enum",name:"state",ref:{value:"switch",options:["on","off"]}},{type:"int",name:"brightness",ref:{value:"brightness",value_t:"brightness"}}]},socket:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"switch",options:["on","off"]}}],ipevt:[{type:"enum",name:"state",ref:{value:"switch",options:["on","off"]}}]},measurement:{command:[],status:[]},rocker_switch:{command:[],status:[],ipevt:[{type:"enum",name:"led status",ref:{value:"status_led",options:["on","off"]}},{type:"enum",name:"up long pressed",ref:{value:"up_request",options:["pressed","released"]}},{type:"enum",name:"down long pressed",ref:{value:"down_request",options:["pressed","released"]}},{type:"enum",name:"pressed",ref:{value:"trigger_request",options:["pressed","released"]}}]},trigger:{command:[],status:[],ipevt:[{type:"enum",name:"led status",ref:{value:"status_led",options:["on","off"]}},{type:"enum",name:"pressed",ref:{value:"trigger_request",options:["pressed","released"]}}]},scene:{command:[{type:"enum",name:"run",ref:{value:"scene"}}],status:[],ipevt:[]}},SYS:"junghome",getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"JUNG HOME"}];},getIPDeviceType:function getIPDeviceType(){return[{sys:xnm.aio.junghome.DM.SYS,name:"JUNG HOME"}];},applyIPEventFilter:function applyIPEventFilter(e,t){if(!e||!e.type)return null;var a=this.getIPevtMap(e);return a?{ipevt:a}:null;},applyUIFilter:function applyUIFilter(e,t,a){if(!e.sys)return null;var n=function n(e,t){if("*"===e||"*"===e[0])return!0;for(var a=0;a<e.length;a++)if(e[a]==t)return!0;return!1;},o=function o(e,t){var o=[],r=null,s=xnm.aio.junghome.DM.getCommandStatusMap(e,a);return s&&(r=function(e,t,a){var o=[];switch(a.catagory){case"command":e.command&&e.command.forEach(function(e){if(n(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));o.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(n(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));o.push(t);}});}return o;}(s,0,t),o=o.concat(r)),o;},r=JSON.parse(JSON.stringify(e)),s=null;switch(t.catagory){case"command":s=o(e,t),r.command=s;break;case"status":s=o(e,t),r.status=s;break;default:return null;}return s&&0!=s.length?r:null;},supportSmartWidget:function supportSmartWidget(e,t){return!(!e||!e.type)&&"undefined"!==e.type;},applySmartWidgetFilter:function applySmartWidgetFilter(e,t,a,n,o){if(!t||!t.type)return null;var r=function(e){var t=[];switch(e.type){case"blind":t.push("blind");break;case"shutter":t.push("shutter");break;case"dimmer":t.push("dimmer","switch");break;case"dimmerrgbw":t.push("dimmer","rgb","switch");break;case"socket":case"switch":t.push("switch");break;case"heater":t.push("thermostat");}return t;}(t),s=function(e){var t={};switch(e.type){case"blind":case"shutter":t["%moveTo%"]={value:"level::level",ext:"%d",extMeta:"0-100"},t["%moveDown%"]={value:"Down"},t["%moveUp%"]={value:"Up"},t["%stop%"]={value:"level::level_move"},"blind"===e.type&&(t["%lamellaTo%"]={value:"angle",ext:"%d",extMeta:"0-100"});break;case"dimmer":case"dimmerrgbw":case"socket":case"switch":t["%dimOn%"]={value:"on"},t["%on%"]={value:"on"},t["%dimOff%"]={value:"off"},t["%off%"]={value:"off"},t["%toggle%"]={value:"toggle"},"dimmer"!==e.type&&"dimmerrgbw"!==e.type||(t["%dimTo%"]={value:"brightness",ext:"%d",extMeta:"0-100"}),"dimmerrgbw"===e.type&&(t["%colorTemp%"]={value:"color_temperature",ext:"%d",extMeta:"800-20000"});break;case"heater":t["%thermoTempTo%"]={value:"temperature_ctrl::temperature_ctrl",ext:"%d",extMeta:"5-30"},t["%thermoAuto%"]={value:"mode",ext:"auto"},t["%thermoManu%"]={value:"mode",ext:"manual"};}return t;}(t),i=function(e){var t={};switch(e.type){case"blind":case"shutter":t["%blindState%"]={value:"level::level",extMeta:"0-100"},t["%shutterState%"]={value:"level::level",extMeta:"0-100"},"blind"===e.type&&(t["%lamellaState%"]={value:"angle",extMeta:"0-100"});break;case"dimmer":case"dimmerrgbw":case"socket":case"switch":t["%switchState%"]={value:"switch"},"dimmer"!==e.type&&"dimmerrgbw"!==e.type||(t["%dimmerState%"]={value:"brightness",extMeta:"0-100"}),"dimmerrgbw"===e.type&&(t["%colorTempState%"]={value:"color_temperature",extMeta:"800-20000"});break;case"heater":t["%thermoSetTemp%"]={value:"temperature_ctrl::temperature_ctrl"},t["%thermoMode%"]={value:"switch"};}return t;}(t);return e._injectToSmartWidgetTemplate(n,r,o,s,i);},createDevice:function createDevice(e,t,a){var n=xnm.aio.junghome.DM;e?a(null,e):a(new n.Error(n.Error.ERROR_CODE.INVALID,"info is missing"));},createGateway:function createGateway(e,t,a){var _this7=this;return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee22(){var _t2,_a2;return _regeneratorRuntime().wrap(function _callee22$(_context23){while(1)switch(_context23.prev=_context23.next){case 0:_context23.prev=0;_this7._checkGwInfo(e);_t2=new xnm.aio.junghome.JungGateway(e,3e4);_context23.next=5;return _t2.isJungGateway();case 5:if(_context23.sent){_context23.next=7;break;}throw new xnm.aio.junghome.DM.Error(_this7.Error.ERROR_CODE.NOT_FOUND,"no jung home gateway");case 7:if(!e.username){_context23.next=12;break;}_context23.next=10;return _t2.getToken(e.username)["catch"](function(e){if("timeout"==e.message)throw _t2.generateJungError("did you press the jung home button?",5);throw e;});case 10:_a2=_context23.sent;e.token=_a2;case 12:a(null,e);_context23.next=18;break;case 15:_context23.prev=15;_context23.t0=_context23["catch"](0);_this7._handleError(_context23.t0,a);case 18:case"end":return _context23.stop();}},_callee22,null,[[0,15]]);}))();},deleteDevice:function deleteDevice(e,t,a){a();},deleteGateway:function deleteGateway(e,t,a){a();},getCommandStatusMap:function getCommandStatusMap(e,t){var _e$jungInfo;if(!e.type)return null;if(!xnm.aio.junghome.DM.MAP[e.type])return null;var a=JSON.parse(JSON.stringify(xnm.aio.junghome.DM.MAP[e.type]));if(e!==null&&e!==void 0&&(_e$jungInfo=e.jungInfo)!==null&&_e$jungInfo!==void 0&&_e$jungInfo.datapoints){var _t3=e.jungInfo.datapoints.filter(function(e){return"quantity"==e.type;});var _iterator4=_createForOfIteratorHelper(_t3),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var _e45=_step4.value;var _t4={type:"enum",name:"quantity",ref:{value:"quantity::quantity"}};_t4.ref.value="quantity::quantity::".concat(_e45.id);var n=_e45.values.find(function(e){return"quantity_label"==e.key;});n&&"NaN"!=n.value&&(_t4.name=n.value);var o=_e45.values.find(function(e){return"quantity_unit"==e.key;});o&&(_t4.ref.unit=o.value),a.status.push(_t4);}}catch(err){_iterator4.e(err);}finally{_iterator4.f();}}return a;},getIPevtMap:function getIPevtMap(e){return e.type&&xnm.aio.junghome.DM.MAP[e.type]&&xnm.aio.junghome.DM.MAP[e.type].ipevt||null;},toGeneralDevice:function toGeneralDevice(e){return e?"blind"===e.type?{type:"blind",commands:{position:{value:{type:"INT",min:0,max:100}},rotation:{value:{type:"INT",min:0,max:100}},up:{},down:{}},states:{position:{type:"INT",min:0,max:100},rotation:{type:"INT",min:0,max:100}},details:{commands:{position:{value:"level",ext:"%d",extMeta:"0-100"},rotation:{value:"angle",ext:"%d",extMeta:"0-100"},up:{value:"Up"},down:{value:"Down"}},states:{position:{value:"level",ext:"%d",extMeta:"0-100"},rotation:{value:"angle",ext:"%d",extMeta:"0-100"}}}}:"shutter"===e.type?{type:"blind",commands:{position:{value:{type:"INT",min:0,max:100}},up:{},down:{}},states:{position:{type:"INT",min:0,max:100}},details:{commands:{position:{value:"level",ext:"%d",extMeta:"0-100"},up:{value:"Up"},down:{value:"Down"}},states:{position:{value:"level",ext:"%d",extMeta:"0-100"}}}}:"dimmer"===e.type?{type:"dimmer",commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100}}},states:{brightness:{type:"INT",min:0,max:100},state:{values:["on","off"]}},details:{commands:{on:{value:"on"},off:{value:"off"},toggle:{value:"toggle"},brightness:{value:"brightness",ext:"%d",extMeta:"0-100"}},states:{brightness:{value:"brightness",ext:"%d",extMeta:"0-100"},state:{value:"switch"}}}}:"dimmerrgbw"===e.type?{type:"dimmer",commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100}},color_temperature:{value:{type:"INT",min:800,max:2e4}}},states:{brightness:{type:"INT",min:0,max:100},state:{values:["on","off"]}},details:{commands:{on:{value:"on"},off:{value:"off"},toggle:{value:"toggle"},brightness:{value:"brightness",ext:"%d",extMeta:"0-100"},color_temperature:{value:"color_temperature",ext:"%d",extMeta:"800-20000"}},states:{state:{value:"switch"},brightness:{value:"brightness",ext:"%d",extMeta:"0-100"},color_temperature:{value:"color_temperature",ext:"%d",extMeta:"800-20000"}}}}:"heater"===e.type?{type:"heater",commands:{tempTo:{value:{type:"INT",step:1}}},states:{temperature:{value:{type:"INT",step:1}}},details:{commands:{tempTo:{value:"temperature_ctrl",ext:"%d"}},states:{temperature:{value:"temperature_ctrl"}}}}:"switch"===e.type?{type:"switch",commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]}},details:{commands:{on:{value:"on"},off:{value:"off"},toggle:{value:"toggle"}},states:{state:{value:"switch"}}}}:null:null;},updateDevice:function updateDevice(e,t,a){var n=xnm.aio.junghome.DM;e?a(null,e):a(new n.Error(n.Error.ERROR_CODE.INVALID,"info is missing"));},updateGateway:function(){var _updateGateway=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee23(e,t,a,n){return _regeneratorRuntime().wrap(function _callee23$(_context24){while(1)switch(_context24.prev=_context24.next){case 0:if(!t){_context24.next=5;break;}_context24.next=3;return this.createGateway(t,a,n);case 3:_context24.next=6;break;case 5:n(new this.Error(this.Error.ERROR_CODE.INVALID,"no new info"));case 6:case"end":return _context24.stop();}},_callee23,this);}));function updateGateway(_x35,_x36,_x37,_x38){return _updateGateway.apply(this,arguments);}return updateGateway;}(),_checkGwInfo:function _checkGwInfo(e){if(!e)throw new xnm.aio.junghome.DM.Error(xnm.aio.junghome.DM.Error.ERROR_CODE.INVALID,"info is invalid");if(!e.ip)throw new xnm.aio.junghome.DM.Error(xnm.aio.junghome.DM.Error.ERROR_CODE.INVALID,"ip is invalid");if(!e.port)throw new xnm.aio.junghome.DM.Error(xnm.aio.junghome.DM.Error.ERROR_CODE.INVALID,"port is invalid");if(!e.sys||"junghome"!=e.sys)throw new xnm.aio.junghome.DM.Error(xnm.aio.junghome.DM.Error.ERROR_CODE.INVALID,"sys is invalid");},_handleError:function _handleError(e,t){console.log(e),e.code?t(e,null):t(new xnm.aio.junghome.DM.Error(xnm.aio.junghome.DM.Error.ERROR_CODE.UNKNOWN,e.message?e.message:"unknown error"),null);}},xnm.aio.junghome.DM.Error=function(e,t){this.code=e,this.message=t,this.stack=new Error().stack;},xnm.aio.junghome.DM.Error.prototype=new Error(),xnm.aio.junghome.DM.Error.prototype.name="JungDMError",xnm.aio.junghome.DM.Error.prototype.code=4,xnm.aio.junghome.DM.Error.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOWN:4,NOT_FOUND:5,IP_EXISTS:6},xnm.aio.junghome.Handler=function(){var e=require("x.logger.js");e&&(this._logger=e.getLogger("xnm.aio.junghomehome"));},xnm.aio.junghome.Handler.prototype={devicemanager:xnm.aio.junghome.DM,helpers:xnm.aio.junghome.Helpers,discoverWithTimeout:function discoverWithTimeout(e,t){var _this8=this;return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee24(){var a,n;return _regeneratorRuntime().wrap(function _callee24$(_context25){while(1)switch(_context25.prev=_context25.next){case 0:_context25.prev=0;a=setTimeout(function(){t&&t(new xnm.aio.junghome.DM.Error(0,"timeout")),t=null;},e);_context25.next=4;return _this8._findGatewaysLocatedInNetwork();case 4:n=_context25.sent;t&&t(null,n),clearTimeout(a);_context25.next=11;break;case 8:_context25.prev=8;_context25.t0=_context25["catch"](0);_this8._logger.log("error","discoverWithTimeout"),_this8._logger.log("error",_context25.t0),t&&t(_context25.t0,null);case 11:case"end":return _context25.stop();}},_callee24,null,[[0,8]]);}))();},getDeviceCommands:function getDeviceCommands(e,t){console.log("getDeviceCommands","deviceData",e);var a=xnm.aio.junghome.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),n=a?a.command:[];t&&t(null,n);},getDeviceList:function getDeviceList(e,t){return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee25(){var a;return _regeneratorRuntime().wrap(function _callee25$(_context26){while(1)switch(_context26.prev=_context26.next){case 0:_context26.prev=0;if(e.username){_context26.next=3;break;}return _context26.abrupt("return",void t(new Error("gateway does not have username")));case 3:if(e.token){_context26.next=5;break;}return _context26.abrupt("return",void t(new Error("gateway does not have any token, try to connect to gateway again")));case 5:a=new xnm.aio.junghome.JungGateway(e);if(a.isJungGateway()){_context26.next=8;break;}return _context26.abrupt("return",void t(new Error("gw is not reachable")));case 8:_context26.next=10;return a.getDevices(t);case 10:_context26.next=15;break;case 12:_context26.prev=12;_context26.t0=_context26["catch"](0);t(_context26.t0);case 15:case"end":return _context26.stop();}},_callee25,null,[[0,12]]);}))();},registModule:function registModule(e){e.register(xnm.aio.junghome.DM.SYS,"junghome");},resolveGateway:function resolveGateway(e){return e?xnm.aio.junghome.parseJSON(e):null;},_findGatewaysLocatedInNetwork:function _findGatewaysLocatedInNetwork(){return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee26(){var e,t,a,n,o,_i,_n,_e46,_t5,_iterator5,_step5,_e47,_loop3,_i2,_o;return _regeneratorRuntime().wrap(function _callee26$(_context28){while(1)switch(_context28.prev=_context28.next){case 0:e=[],t=require("os");if(t){_context28.next=3;break;}throw new xnm.aio.junghome.DM.Error(0,"it is not node environment");case 3:a=t.networkInterfaces(),n=Object.keys(a);if(!(!a||0==n.length)){_context28.next=6;break;}throw new xnm.aio.junghome.DM.Error(0,"msg:no_interfaces");case 6:o=[];for(_i=0,_n=n;_i<_n.length;_i++){_e46=_n[_i];_t5=a[_e46];_iterator5=_createForOfIteratorHelper(_t5);try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){_e47=_step5.value;"IPv4"==_e47.family&&1!=_e47.internal&&o.push(_e47);}}catch(err){_iterator5.e(err);}finally{_iterator5.f();}}if(!(o.length>5)){_context28.next=10;break;}throw new xnm.aio.junghome.DM.Error(0,"msg:max_interfaces|5");case 10:_loop3=/*#__PURE__*/_regeneratorRuntime().mark(function _loop3(){var t,a,n,_e48,_t6,_o2,o,r;return _regeneratorRuntime().wrap(function _loop3$(_context27){while(1)switch(_context27.prev=_context27.next){case 0:t=_o[_i2];a=/(\d{1,3}\.\d{1,3}\.\d{1,3})/gm.exec(t.address)[0],n=[];for(_e48=1;_e48<254;_e48++){_t6="".concat(a,".").concat(_e48),_o2=new xnm.aio.junghome.JungGateway({sys:"junghome",ip:_t6,port:443},5e3);n.push(_o2.isJungGateway());}_context27.next=5;return Promise.all(n);case 5:o=_context27.sent;r=1;o.forEach(function(t,a){if(t){var _a3={sys:"junghome",ip:t.ip,port:443,name:"JUNG HOME ".concat(r)};e.push(_a3),r++;}});case 8:case"end":return _context27.stop();}},_loop3);});_i2=0,_o=o;case 12:if(!(_i2<_o.length)){_context28.next=17;break;}return _context28.delegateYield(_loop3(),"t0",14);case 14:_i2++;_context28.next=12;break;case 17:return _context28.abrupt("return",e);case 18:case"end":return _context28.stop();}},_callee26);}))();},doCommand:function doCommand(e,t,a,n){var o=this.resolveGateway(e);o?o.executeCommandCreator(t,a,function(e){n&&n(e);}):n&&n(new Error("gateway json format invalid"));},doStatus:function doStatus(e,t,a,n,o){var r=this.resolveGateway(t);if(r){var s=[{id:e,device:a,status:n}];r.getStatesCreator(null,s,function(e,t){e?o&&o(e):o&&o(null,t[0]);});}else o&&o(new Error("gateway json format invalid"));}},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.junghome.Handler());