var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.moehlenhoff=xnm.aio.moehlenhoff||{};xnm.aio.moehlenhoff.Alpha2Device=function(){var d=function(a){this._address=a.address;this._name=a.name};d.prototype.toJSON=function(){return{sys:xnm.aio.moehlenhoff.Alpha2.DM.SYS,address:this._address,name:this._name,dpt:"DEVICE"}};return d}();
xnm.aio.moehlenhoff.Alpha2HeatArea=function(){var d=function(a){this._address=a.address;this._dpt=a.dpt;this._name=a.name;this._number=a.number;this._iodevice=a.iodevice};d.prototype.toJSON=function(){return{sys:xnm.aio.moehlenhoff.Alpha2.DM.SYS,address:this._address,dpt:this._dpt,name:this._name,number:this._number,iodevice:this._iodevice}};return d}();
xnm.aio.moehlenhoff.Alpha2=function(){var d=function(a,b){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.moehlenhoff.Alpha2");this._ip=a;this._port=b;if(!this._port||0>this._port)this._port=80};d.prototype.executeCommand=function(a,b,c){var e=a.address.split(":");a=2<=e.length?{id:a.id,type:a.type,address:e[0],dpt:a.data,number:e[1]}:null;this._executeCommand(a,b,c)};d.prototype.getStates=function(a,b,c){var e=function(a,b){if(!b||
!b.Devices)return null;if(b.Devices.Device)return b.Devices.Device.ID==a?b.Devices.Device:null;if(b.Devices.Devices){b=b.Devices.Devices;for(var c=0;c<b.length;c++){var e=b[c];if(e.ID==a)return e}}return null},f=this;b=function(a){for(var b=[],c=0;c<a.length;c++){var e=a[c],f=e.address.split(":");2<=f.length&&b.push({id:e.id,type:e.type,address:f[0],dpt:e.data,number:f[1]})}return b}(b);this._getInfo(function(d,g){if(d)c&&c(d);else{var h,l;if(b&&a.setState)for(d=0;d<b.length;d++){var m=b[d];if(h=
e(m.address,g))switch(m.dpt){case "HEATAREA":var n;a:{if(h&&h.HEATAREAs)for(n=0;n<h.HEATAREAs.length;n++){var p=h.HEATAREAs[n];if(p.NUMBER==m.number){n=p;break a}}n=null}if(n)for(l in h=f._getStateValues(m,n,h),h)h.hasOwnProperty(l)&&a.setState(m.id+":"+l,h[l])}}c&&c("OK")}})};d.prototype._executeCommand=function(a,b,c){if(a)if(a.address)if(b){var e='<?xml version="1.0" encoding="UTF-8"?><Devices><Device><ID>'+a.address+"</ID>%subdev</Device></Devices>";if("vac_off"==b)e=e.replace("%subdev","<VACATION><VACATION_STATE>0</VACATION_STATE><START_DATE>2000-00-00</START_DATE><END_DATE>2000-00-00</END_DATE></VACATION>");
else if("vac_on"==b.name&&b.start&&b.end){var f="<VACATION><VACATION_STATE>1</VACATION_STATE><START_DATE>"+b.start+"</START_DATE><END_DATE>"+b.end+"</END_DATE></VACATION>";e=e.replace("%subdev",f)}switch(a.dpt){case "HEATAREA":if(null==a.number||"undefined"==typeof a.number){c&&c(Error("device number invalid"));return}a='<HEATAREA nr="'+a.number+'">%cmd</HEATAREA>';e=e.replace("%subdev",a);switch(b){case "auto":f="<HEATAREA_MODE>0</HEATAREA_MODE>";break;case "day":f="<HEATAREA_MODE>1</HEATAREA_MODE>";
break;case "night":f="<HEATAREA_MODE>2</HEATAREA_MODE>";break;default:if("string"==typeof b&&b.match(/^w_p/))f="<PROGRAM_WEEK>"+b.replace("w_p","")+"</PROGRAM_WEEK>";else if("string"==typeof b&&b.match(/^we_p/))f="<PROGRAM_WEEKEND>"+b.replace("we_p","")+"</PROGRAM_WEEKEND>";else{var d;"number"==typeof b?d=b/5:b.match(/^[-+]?[0-9]*\.?[0-9]+$/)?d=parseFloat(b/5):c&&c(Error("no such command"));5>d&&(d=5);30<d&&(d=30);f="<T_TARGET>"+d+"</T_TARGET>"}}f&&(e=e.replace("%cmd",f))}this._doRequest({path:"/data/changes.xml",
method:"POST"},e,function(a){c&&c(a)})}else c&&c(Error("command invalid"));else c&&c(Error("device address invalid"));else c&&c(Error("device address format invalid"))};d.prototype._getStates=function(a){var b=this;this._getInfo(function(c,e){c?a&&a(c):(c=b._resolveInfo(e),a&&a(null,c))})};d.prototype._resolveInfo=function(a){if(!a||!a.Devices)return null;var b,c=[];a.Devices.Device&&(b=this._resolveDevice(a.Devices.Device))&&c.push(b);if(a.Devices.Devices){a=a.Devices.Devices;for(var e=0;e<a.length;e++)(b=
this._resolveDevice(a[e]))&&c.push(b)}return c};d.prototype._resolveDevice=function(a){if(!a)return null;var b=this._getStateValues(null,null,a);if(!b)return null;b.id=a.ID;b.heatAreas=[];if(a.HEATAREAs)for(var c=0;c<a.HEATAREAs.length;c++){var e=a.HEATAREAs[c],f=this._getStateValues(null,e,a);f&&(f.number=e.NUMBER,b.heatAreas.push(f))}return b};d.prototype.getDevices=function(a){this._getDevices(function(b,c){if(b)a&&a(b);else if(c){for(var e in c)if(c.hasOwnProperty(e)){b=c[e];for(var f=0;f<b.length;f++)delete b[f]._deviceName}a&&
a(null,c)}else a&&a(null,{})})};d.prototype._getDevices=function(a){this._getInfo(function(b,c){if(b)a&&a(b);else if(b={},c.Devices&&c.Devices.Devices){c=c.Devices.Devices;for(var e=0;e<c.length;e++){var f=c[e];if(f.ID){b[f.ID]=[];var d=f.NAME,g={};if(f.IODEVICEs)for(var k=0;k<f.IODEVICEs.length;k++){var l=f.IODEVICEs[k];l.HEATAREA_NR&&(g[l.HEATAREA_NR]=l)}if(f.HEATAREAs)for(k=0;k<f.HEATAREAs.length;k++)if(l=f.HEATAREAs[k],l.NUMBER){if(g[l.NUMBER]){var m=g[l.NUMBER].IODEVICE_TYPE;switch(m){case "1":case "3":case "4":m=
"analog";break;default:m="digital"}}b[f.ID].push({type:"alpha2",address:f.ID,dpt:"HEATAREA",name:l.HEATAREA_NAME,number:l.NUMBER,iodevice:m,_deviceName:d})}}}a&&a(null,b)}else a&&a(Error("info format invalid"))})};d.prototype._getStateValues=function(a,b,c,e){a={};e="\u00b0C";var f={};if(c){if(c.VACATION){switch(c.VACATION.VACATION_STATE){case "0":a.vacation="off";break;default:a.vacation="on"}c.VACATION.START_DATE&&(a.vacation_start_date=c.VACATION.START_DATE);c.VACATION.START_TIME&&(a.vacation_start_time=
c.VACATION.START_TIME);c.VACATION.END_DATE&&(a.vacation_end_date=c.VACATION.END_DATE);c.VACATION.END_TIME&&(a.vacation_end_time=c.VACATION.END_TIME)}c.TEMPERATUREUNIT&&"0"!=c.TEMPERATUREUNIT&&(e="\u00b0F");if(c.PROGRAM&&c.PROGRAM.SHIFT_PROGRAMs)for(var d=c.PROGRAM.SHIFT_PROGRAMs,g=0;g<d.length;g++){var k=d[g],l=k.NUMBER,m=k.START;k=k.END;l&&m&&k&&(a["prog_"+l]=a["prog_"+l]?a["prog_"+l]+(","+m+"-"+k):m+"-"+k)}if(c.IODEVICEs)for(d=0;d<c.IODEVICEs.length;d++)g=c.IODEVICEs[d],g.HEATAREA_NR&&(f[g.HEATAREA_NR]=
g)}if(b){switch(b.HEATAREA_MODE){case "0":a.mode="auto";break;case "1":a.mode="day";break;case "2":a.mode="night"}b.T_ACTUAL&&(a.actual_temp=parseFloat(b.T_ACTUAL),a.actual_temp_text=parseFloat(b.T_ACTUAL)+e);b.T_TARGET&&(a.target_temp=parseFloat(5*b.T_TARGET),a.target_temp_text=parseFloat(b.T_TARGET)+e);b.PROGRAM_WEEK&&(a.prog_week_0="inactive",a.prog_week_1="inactive",a.prog_week_2="inactive",a.prog_week_3="inactive",a["prog_week_"+parseInt(b.PROGRAM_WEEK)]="active");b.PROGRAM_WEEKEND&&(a.prog_weekend_0=
"inactive",a.prog_weekend_1="inactive",a.prog_weekend_2="inactive",a.prog_weekend_3="inactive",a["prog_weekend_"+parseInt(b.PROGRAM_WEEKEND)]="active");b.PARTY&&(a.party=parseInt(b.PARTY));if(f&&f[b.NUMBER]){e=f[b.NUMBER];switch(e.IODEVICE_TYPE){case "1":case "3":case "4":a.iodevice="analog";break;default:a.iodevice="digital"}if(e.BATTERY)switch(e.BATTERY){case "0":a.battery=0;break;case "1":a.battery=50;break;case "2":a.battery=100}if(e.SIGNALSTRENGTH)switch(e.SIGNALSTRENGTH){case "0":a.signal=0;
break;case "1":a.signal=50;break;case "2":a.signal=100}}}return a};d.prototype._getInfo=function(a){var b=this;this._doRequest({path:"/data/static.xml",method:"GET"},null,function(c,e){if(c)a&&a(c);else try{var f=$($.parseXML(e)),d=b._xml2json(f);a&&a(null,d)}catch(g){a&&a(g)}})};d.prototype._xml2json=function(a){var b=a.children();if(b&&0<b.length){a={};for(var c=0;c<b.length;c++){var e=$(b[c]),f=e.prop("tagName"),d=this._xml2json(e);if("HEATAREA"==f||"HEATCTRL"==f||"IODEVICE"==f){var g=e.attr("nr");
null!=g&&"undefined"!=typeof g&&(d.NUMBER=g)}"SHIFT_PROGRAM"==f&&(g=e.attr("nr"),e=e.attr("shiftingtime"),null!=g&&"undefined"!=typeof g&&(d.NUMBER=g),null!=e&&"undefined"!=typeof e&&(d.SHIFINGTIME=e));"Device"==f||"HEATAREA"==f||"HEATCTRL"==f||"IODEVICE"==f?(a[f+"s"]||(a[f+"s"]=[]),a[f+"s"].push(d)):a[f]&&!a[f+"s"]?(a[f+"s"]=[],a[f+"s"].push(a[f]),a[f+"s"].push(d),delete a[f]):!a[f]&&a[f+"s"]?a[f+"s"].push(d):a[f]=d}return a}return a.text()};d.prototype._doRequest=function(a,b,c){var e=c;a.host=
this._ip;a.port=this._port;a.headers={"Content-Type":'text/xml; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"};"POST"==a.method&&b&&(a.headers["Content-Length"]=b.length);var f=this,d="";c=require("http").request(a,function(a){a.setEncoding("utf8");a.on("data",function(a){d+=a});a.on("end",function(){if(200!=a.statusCode){f._logger.log("warn","Failed to post request to "+f._ip+" with status code:"+a.statusCode);var b=Error("http request failed with status code:"+a.statusCode)}e&&(e(b,
d),e=null)})});c.setTimeout(5E3);c.on("timeout",function(){e&&e(Error("http timeout"));e=null});if(c.on&&"function"==typeof c.on)c.on("error",function(a){e&&e(a);e=null});"POST"==a.method&&b&&c.write(b);c.end()};d.prototype.getDevicesCreator=function(a){this._getDevices(function(b,c){if(b)a&&a(b);else{b={};var e=[];if(c){for(var d in c)if(c.hasOwnProperty(d)){var h=c[d];if(h)for(var g=0;g<h.length;g++){var k=h[g];k&&(k.address&&!b[k.address]&&(b[k.address]=new xnm.aio.moehlenhoff.Alpha2Device(k),
b[k.address]._name=k._deviceName,e.push(b[k.address])),k=new xnm.aio.moehlenhoff.Alpha2HeatArea(k),e.push(k))}}a&&a(null,e)}}})};d.prototype.executeCommandCreator=function(a,b,c){if(a)if(b){var e=b.value;if("vac_on"==b.value){e={name:"vac_on"};for(var d=0;d<b.ext.length;d++){var h=b.ext[d];if(h)switch(h.value){case "start":e.start=h.ext;break;case "end":e.end=h.ext}}}"target_temp"==e&&(e=5*b.ext);this._executeCommand(a,e,c)}else c&&c(Error("command in null"));else c&&c(Error("device in null"))};d.prototype.getStatesCreator=
function(a,b,c){var e=function(a,b,c,e){a=function(a,b){if(!b.heatAreas)return null;for(var c=0;c<b.heatAreas.length;c++)if(b.heatAreas[c]&&b.heatAreas[c].number==a)return b.heatAreas[c];return null};if(!b.address||!c||!c.value)return null;e=function(a,b){for(var c=0;c<b.length;c++)if(b[c]&&b[c].id==a)return b[c];return null}(b.address,e);if(!e)return null;switch(b.dpt){case "HEATAREA":b=a(b.number,e);if(!b)return null;b=b[c.value];return"target_temp"==c.value?b/5:b;case "DEVICE":return e[c.value]}};
this._getStates(function(a,d){if(a)c&&c(a);else{a=[];for(var f=0;f<b.length;f++){var k=b[f],h=e(k.id,k.device,k.status,d);h&&a.push({id:k.id,status:h})}c&&c(null,a)}})};d.prototype.toJSON=function(){return{sys:xnm.aio.moehlenhoff.Alpha2.DM.SYS,ip:this._ip,port:this._port}};d.prototype.equalsTo=function(a){return a&&a instanceof d?this._ip==a._ip&&this._port==a._port:!1};d.parseJSON=function(a){return a&&a.ip?new d(a.ip,a.port):null};return d}();
xnm.aio.moehlenhoff.Alpha2.DM=function(){var d=function(a,c){this.code=a;this.message=c;this.stack=Error().stack};d.prototype=Error();d.prototype.name="Alpha2DMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var a={alpha2:{DEVICE:{command:[{type:"enum",name:"vacation off",ref:{value:"vac_off"}},{type:"multi",name:"vacation on",ref:{value:"vac_on",ext:"%multi",extMeta:[{type:"string",name:"start date",ref:{value:"start",ext:"%s"}},
{type:"string",name:"end date",ref:{value:"end",ext:"%s"}}]}}],status:[{type:"enum",name:"vacation",ref:{value:"vacation",options:["off","on"]}},{type:"string",name:"vacation start date",ref:{value:"vacation_start_date"}},{type:"string",name:"vacation start time",ref:{value:"vacation_start_time"}},{type:"string",name:"vacation end date",ref:{value:"vacation_end_date"}},{type:"string",name:"vacation end time",ref:{value:"vacation_end_time"}},{type:"string",name:"program 1",ref:{value:"prog_1"}},{type:"string",
name:"program 2",ref:{value:"prog_2"}},{type:"string",name:"program 3",ref:{value:"prog_3"}},{type:"string",name:"program 4",ref:{value:"prog_4"}}]},HEATAREA:{command:[{type:"enum",name:"auto mode",ref:{value:"auto"}},{type:"enum",name:"day mode",ref:{value:"day"}},{type:"enum",name:"night mode",ref:{value:"night"}},{type:"enum",name:"week program 0",ref:{value:"w_p0"}},{type:"enum",name:"week program 1",ref:{value:"w_p1"}},{type:"enum",name:"week program 2",ref:{value:"w_p2"}},{type:"enum",name:"week program 3",
ref:{value:"w_p3"}},{type:"enum",name:"weekend program 0",ref:{value:"we_p0"}},{type:"enum",name:"weekend program 1",ref:{value:"we_p1"}},{type:"enum",name:"weekend program 2",ref:{value:"we_p2"}},{type:"enum",name:"weekend program 3",ref:{value:"we_p3"}},{type:"float",name:"target temparature",ref:{value:"target_temp",ext:"%f",extMeta:"5-30",scale:"0.2"}}],status:[{type:"enum",name:"mode",ref:{value:"mode",options:["auto","day","night"]}},{type:"float",name:"actual temparature",ref:{value:"actual_temp"}},
{type:"string",name:"actual temparature with unit",ref:{value:"actual_temp_text"}},{type:"float",name:"target temparature",ref:{value:"target_temp",extMeta:"5-30",scale:"0.2"}},{type:"string",name:"target temparature with unit",ref:{value:"target_temp_text"}},{type:"enum",name:"week program 0",ref:{value:"prog_week_0",options:["active","inactive"]}},{type:"enum",name:"week program 1",ref:{value:"prog_week_1",options:["active","inactive"]}},{type:"enum",name:"week program 2",ref:{value:"prog_week_2",
options:["active","inactive"]}},{type:"enum",name:"week program 3",ref:{value:"prog_week_3",options:["active","inactive"]}},{type:"enum",name:"weekend program 0",ref:{value:"prog_weekend_0",options:["active","inactive"]}},{type:"enum",name:"weekend program 1",ref:{value:"prog_weekend_1",options:["active","inactive"]}},{type:"enum",name:"weekend program 2",ref:{value:"prog_weekend_2",options:["active","inactive"]}},{type:"enum",name:"weekend program 3",ref:{value:"prog_weekend_3",options:["active",
"inactive"]}}]}}};return{SYS:"alpha2",NEA_SMART_SYS:"neasmart",hasSys:function(a){return a==this.SYS||a==this.NEA_SMART_SYS},registModule:function(a){a.register(this.SYS,"moehlenhoff");a.register(this.NEA_SMART_SYS,"moehlenhoff")},getGatewayType:function(){return[{sys:this.SYS,name:"M\u00f6hlenhoff Alpha2",port:80},{sys:this.NEA_SMART_SYS,name:"REHAU Nea Smart",port:80}]},createGateway:function(a,c,e){c=d.ERROR_CODE;a?a.ip?e(null,a):e(new d(c.INVALID,"ip is invalid")):e(new d(c.INVALID,"info is invalid"))},
updateGateway:function(a,c,e,f){a=d.ERROR_CODE;c?c.ip?f(null,c):f(new d(a.INVALID,"ip is invalid")):f(new d(a.INVALID,"update is invalid"))},deleteGateway:function(a,c,e){e()},createDevice:function(a,c,e){var b=d.ERROR_CODE;if(a.gateway)if(c.data&&c.data.gateways&&0!==c.data.gateways.length){c=c.data.gateways;var h;for(h=0;h<c.length;h++)if(c[h].index===a.gateway){var g=c[h];break}g?e(null,a):e(new d(b.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else e(new d(b.NOT_FOUND,"gateway with index "+
a.gateway+" not exists"));else e(new d(b.INVALID,"gateway is invalid"))},updateDevice:function(a,c,e){var b=d.ERROR_CODE;if(a)if(a.gateway){c=c.data.gateways;var h;for(h=0;h<c.length;h++)if(c[h].index===a.gateway){var g=c[h];break}g?e(null,a):e(new d(b.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else e(new d(b.INVALID,"gateway is invalid"));else e(new d(b.INVALID,"info is invalid"))},deleteDevice:function(a,c,e){e()},getCommandStatusMap:function(b){if(!b||!b.sys||!b.dpt)return null;
var c=b.sys;c==this.NEA_SMART_SYS&&(c=this.SYS);c=a[c];if(!c)return null;c=c[b.dpt];if("analog"==b.iodevice){b={command:[],status:c.status};for(var e=0;e<c.command.length;e++){var d=c.command[e];"target_temp"!=d.ref.value&&b.command.push(d)}c=b}return c}}}();xnm.aio.rehau=xnm.aio.rehau||{};
xnm.aio.rehau.NeaSmartDevice=function(){var d=function(a){this._address=a.address;this._name=a.name};d.prototype.toJSON=function(){return{sys:xnm.aio.rehau.NeaSmart.DM.SYS,address:this._address,name:this._name,dpt:"DEVICE"}};return d}();
xnm.aio.rehau.NeaSmartHeatArea=function(){var d=function(a){this._address=a.address;this._dpt=a.dpt;this._name=a.name;this._number=a.number;this._iodevice=a.iodevice};d.prototype.toJSON=function(){return{sys:xnm.aio.rehau.NeaSmart.DM.SYS,address:this._address,dpt:this._dpt,name:this._name,number:this._number,iodevice:this._iodevice}};return d}();xnm.aio.rehau.NeaSmart=function(d,a){xnm.aio.moehlenhoff.Alpha2.call(this,d,a);this._logger=require("x.logger.js").getLogger("xnm.aio.rehau.NeaSmart")};
xnm.aio.rehau.NeaSmart.prototype=new xnm.aio.moehlenhoff.Alpha2;xnm.aio.rehau.NeaSmart.prototype.constructor=xnm.aio.rehau.NeaSmart;xnm.aio.rehau.NeaSmart.prototype.toJSON=function(){return{sys:xnm.aio.rehau.NeaSmart.DM.SYS,ip:this._ip,port:this._port}};xnm.aio.rehau.NeaSmart.prototype.equalsTo=function(d){return d&&d instanceof xnm.aio.rehau.NeaSmart?this._ip==d._ip&&this._port==d._port:!1};xnm.aio.rehau.NeaSmart.parseJSON=function(d){return d&&d.ip?new xnm.aio.rehau.NeaSmart(d.ip,d.port):null};
xnm.aio.rehau.NeaSmart.prototype.getDevicesCreator=function(d){this._getDevices(function(a,b){if(a)d&&d(a);else{a={};var c=[];if(b){for(var e in b)if(b.hasOwnProperty(e)){var f=b[e];if(f)for(var h=0;h<f.length;h++){var g=f[h];g&&(g.address&&!a[g.address]&&(a[g.address]=new xnm.aio.rehau.NeaSmartDevice(g),a[g.address]._name=g._deviceName,c.push(a[g.address])),g=new xnm.aio.rehau.NeaSmartHeatArea(g),c.push(g))}}d&&d(null,c)}}})};xnm.aio.rehau.NeaSmart.DM={SYS:xnm.aio.moehlenhoff.Alpha2.DM.NEA_SMART_SYS};
xnm.aio.moehlenhoff.DM=function(){var d=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};d.prototype=Error();d.prototype.name="MoehlenhoffDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{getGatewayType:function(a){var b=[],c;for(c in xnm.aio.moehlenhoff)if(xnm.aio.moehlenhoff.hasOwnProperty(c)){var e=xnm.aio.moehlenhoff[c];e&&e.DM&&e.DM.getGatewayType&&((e=e.DM.getGatewayType(a))&&Array.isArray(e)?b=
b.concat(e):b.push(e))}return b},_getSystem:function(a){for(var b in xnm.aio.moehlenhoff)if(xnm.aio.moehlenhoff.hasOwnProperty(b)){var c=xnm.aio.moehlenhoff[b];if(c&&c.DM&&c.DM.SYS&&c.DM.SYS==a||c&&c.DM&&c.DM.hasSys&&c.DM.hasSys(a))return c}return null},createGateway:function(a,b,c){var e=d.ERROR_CODE;if(a)if(a.sys){var f=this._getSystem(a.sys);f&&f.DM&&f.DM.createGateway?f.DM.createGateway(a,b,c):c&&c(new d(e.INVALID,"no such sys:"+a.sys))}else c&&c(new d(e.INVALID,"sys is invalid"));else c&&c(new d(e.INVALID,
"info is invalid"))},updateGateway:function(a,b,c,e){var f=d.ERROR_CODE;if(b)if(b.sys){var h=this._getSystem(b.sys);h&&h.DM&&h.DM.updateGateway?h.DM.updateGateway(a,b,c,e):e&&e(new d(f.INVALID,"no such sys:"+b.sys))}else e&&e(new d(f.INVALID,"sys is invalid"));else e&&e(new d(f.INVALID,"update is invalid"))},deleteGateway:function(a,b,c){var e=d.ERROR_CODE;if(a)if(a.sys){var f=this._getSystem(a.sys);f&&f.DM&&f.DM.deleteGateway?f.DM.deleteGateway(a,b,c):c&&c(new d(e.INVALID,"no such sys:"+a.sys))}else c&&
c(new d(e.INVALID,"sys is invalid"));else c&&c()},createDevice:function(a,b,c){var e=d.ERROR_CODE;if(a)if(a.sys){var f=this._getSystem(a.sys);f&&f.DM&&f.DM.createDevice?f.DM.createDevice(a,b,c):c&&c(new d(e.INVALID,"no such sys:"+a.sys))}else c&&c(new d(e.INVALID,"sys is invalid"));else c&&c(new d(e.INVALID,"info is invalid"))},updateDevice:function(a,b,c){var e=d.ERROR_CODE;if(a)if(a.sys){var f=this._getSystem(a.sys);f&&f.DM&&f.DM.updateDevice?f.DM.updateDevice(a,b,c):c&&c(new d(e.INVALID,"no such sys:"+
a.sys))}else c&&c(new d(e.INVALID,"sys is invalid"));else c&&c(new d(e.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){var e=d.ERROR_CODE;if(a)if(a.sys){var f=this._getSystem(a.sys);f&&f.DM&&f.DM.deleteDevice?f.DM.deleteDevice(a,b,c):c&&c(new d(e.INVALID,"no such sys:"+a.sys))}else c&&c(new d(e.INVALID,"sys is invalid"));else c&&c()},applyUIFilter:function(a,b){var c=function(a,c){if("*"==a)return!0;for(var b=!1,e=0;e<a.length;e++)if(a[e]==c){b=!0;break}return b},e=function(a,b,e){var d=
[];switch(e.catagory){case "command":a.command&&a.command.forEach(function(a){c(e.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))});break;case "status":a.status&&a.status.forEach(function(a){c(e.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))})}return d},d=function(a,c){var b=[],d;if(a.sys){var f=this._getSystem(a.sys);f&&f.DM&&f.DM.getCommandStatusMap&&(d=f.DM.getCommandStatusMap(a))}d&&(a=e(d,a,c),b=b.concat(a));return b};if(!a.sys)return null;var h=JSON.parse(JSON.stringify(a)),
g=null;switch(b.catagory){case "command":g=d.call(this,a,b);h.command=g;break;case "status":g=d.call(this,a,b);h.status=g;break;default:return null}return g&&0!=g.length?h:null}}}();
xnm.aio.moehlenhoff.Handler=function(){var d=function(){var a=require("x.logger.js");xnm.aio.moehlenhoff.DM._logger=a?a.getLogger("xnm.aio.moehlenhoff.DM"):{log:function(){}}};d.prototype.Alpha2=xnm.aio.moehlenhoff.Alpha2;d.prototype.NeaSmart=xnm.aio.rehau.NeaSmart;d.prototype.getDeviceCommandList=function(a,b){b=[];if("analog"==a.data||"digital"==a.data)b.push({id:window.XC_Text.auto,cmd:"auto"}),b.push({id:window.XC_Text.day,cmd:"day"}),b.push({id:window.XC_Text.night,cmd:"night"}),b.push({id:window.XC_Text.w_p0,
cmd:"w_p0"}),b.push({id:window.XC_Text.w_p1,cmd:"w_p1"}),b.push({id:window.XC_Text.w_p2,cmd:"w_p2"}),b.push({id:window.XC_Text.w_p3,cmd:"w_p3"}),b.push({id:window.XC_Text.we_p0,cmd:"we_p0"}),b.push({id:window.XC_Text.we_p1,cmd:"we_p1"}),b.push({id:window.XC_Text.we_p2,cmd:"we_p2"}),b.push({id:window.XC_Text.we_p3,cmd:"we_p3"});"digital"==a.data&&(a=this.getDeviceCommandListDigital(),b.push.apply(b,a));return b};d.prototype.getDeviceCommandListDigital=function(){for(var a=[],b=4.8,c=24,e=0;126>e;e++)b+=
.2,c++,a.push({id:window.XC_Text.target_temp+b.toFixed(1),cmd:c});return a};d.prototype.devicemanager=xnm.aio.moehlenhoff.DM;d.prototype.registModule=function(a){for(var b in xnm.aio.moehlenhoff)if(xnm.aio.moehlenhoff.hasOwnProperty(b)){var c=xnm.aio.moehlenhoff[b];c&&c.DM&&c.DM.registModule&&c.DM.registModule(a)}};d.prototype.resolveGateway=function(a){if(!a)return null;switch(a.sys){case xnm.aio.moehlenhoff.Alpha2.DM.SYS:return xnm.aio.moehlenhoff.Alpha2.parseJSON(a);case xnm.aio.moehlenhoff.Alpha2.DM.NEA_SMART_SYS:return xnm.aio.rehau.NeaSmart.parseJSON(a);
default:return null}};d.prototype.getDeviceCommands=function(a,b){a=(a=xnm.aio.moehlenhoff.DM.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};d.prototype.getDeviceStatus=function(a,b){a=(a=xnm.aio.moehlenhoff.DM.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)};d.prototype.getDevices=function(a,b){a?(a=this.resolveGateway(a))?a.getDevicesCreator?a.getDevicesCreator(function(a,e){b&&b(a,e)}):b&&b(Error("gateway do not have getDevicesCreator function")):
b&&b(Error("gatewayJSON invalid")):b&&b(Error("gatewayJSON is empty"))};d.prototype.doCommand=function(a,b,c,e){a?(a=this.resolveGateway(a))?a.executeCommandCreator(b,c,function(a){e&&e(a)}):e&&e(Error("gatewayJSON invalid")):e&&e(Error("gatewayJSON is empty"))};d.prototype.doStatus=function(a,b,c,e,d){b?(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:c,status:e}],function(a,b){a?d&&d(a):d&&d(null,b[0])}):d&&d(Error("gatewayJSON invalid")):d&&d(Error("gatewayJSON is empty"))};return d}();
"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.moehlenhoff.Handler);
