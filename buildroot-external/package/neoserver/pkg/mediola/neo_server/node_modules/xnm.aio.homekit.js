var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(a==Array.prototype||a==Object.prototype)return a;a[b]=c.value;return a};
$jscomp.getGlobal=function(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};
$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(a,b){var c=$jscomp.propertyToPolyfillSymbol[b];if(null==c)return a[b];c=a[c];return void 0!==c?c:a[b]};$jscomp.polyfill=function(a,b,c,d){b&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(a,b,c,d):$jscomp.polyfillUnisolated(a,b,c,d))};
$jscomp.polyfillUnisolated=function(a,b,c,d){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];if(!(e in c))return;c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})};
$jscomp.polyfillIsolated=function(a,b,c,d){var e=a.split(".");a=1===e.length;d=e[0];d=!a&&d in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var l=0;l<e.length-1;l++){var h=e[l];if(!(h in d))return;d=d[h]}e=e[e.length-1];c=$jscomp.IS_SYMBOL_NATIVE&&"es6"===c?d[e]:null;b=b(c);null!=b&&(a?$jscomp.defineProperty($jscomp.polyfills,e,{configurable:!0,writable:!0,value:b}):b!==c&&(void 0===$jscomp.propertyToPolyfillSymbol[e]&&($jscomp.propertyToPolyfillSymbol[e]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(e):
$jscomp.POLYFILL_PREFIX+e),$jscomp.defineProperty(d,$jscomp.propertyToPolyfillSymbol[e],{configurable:!0,writable:!0,value:b})))};$jscomp.polyfill("Object.is",function(a){return a?a:function(b,c){return b===c?0!==b||1/b===1/c:b!==b&&c!==c}},"es6","es3");
$jscomp.polyfill("Array.prototype.includes",function(a){return a?a:function(b,c){var d=this;d instanceof String&&(d=String(d));var e=d.length;c=c||0;for(0>c&&(c=Math.max(c+e,0));c<e;c++){var l=d[c];if(l===b||Object.is(l,b))return!0}return!1}},"es7","es3");
$jscomp.checkStringArgs=function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};$jscomp.polyfill("String.prototype.includes",function(a){return a?a:function(b,c){return-1!==$jscomp.checkStringArgs(this,b,"includes").indexOf(b,c||0)}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};
xnm.aio.homekit=xnm.aio.homekit||{};xnm.aio.homekit.XCHomeKit=function(){this._stateCallback=this._errorCallback=null;var a=require("x.logger.js");this._logger=a?a.getLogger("xnm.aio.homekit"):{log:function(){}}};xnm.aio.homekit.XCHomeKit.prototype.on=function(a,b){if("error"===a)this._errorCallback=b;else if("updatedState"===a){this._stateCallback=b;var c=this;XC.callHost("homekit","setStateCallback",null,function(d){d&&c._stateCallback(d)})}};
xnm.aio.homekit.XCHomeKit.prototype.getDevices=function(a){this._logger.log("trace","Calling getDevices on host.");var b=this;XC.callHost("homekit","getDevices",{},function(c){b._logger.log("debug","Received getDevices response.");a&&a(c)})};xnm.aio.homekit.XCHomeKit.prototype.getStates=function(a){this._logger.log("trace","Calling getStates on host.");var b=this;XC.callHost("homekit","getStates",{},function(c){b._logger.log("trace","Received getStates response.");a&&a(c)})};
xnm.aio.homekit.XCHomeKit.prototype.updateStates=function(a){this._logger.log("trace","Calling updateStates on host.");var b={};a&&(b.devices=a);XC.callHost("homekit","updateStates",b)};
xnm.aio.homekit.XCHomeKit.prototype.executeCommand=function(a,b,c,d){this._logger.log("trace","Calling executeCommand on host with: "+a+" | "+b+" | "+c);a={id:a,command:b};c&&(a.value=c);var e=this;XC.callHost("homekit","executeCommand",a,function(l){try{e._logger.log("debug","Command has been executed: "+JSON.stringify(l))}catch(h){e._logger.log("error","JSON error in executeCommand response: "+h.message)}d&&(l&&l.error?d(!1):d(!0))})};
xnm.aio.homekit.XCHomeKit.prototype.doScene=function(a,b){this._logger.log("trace","Calling doScene on host for ID: "+a);var c=this;XC.callHost("homekit","doScene",{id:a},function(d){try{c._logger.log("debug","Scene has been executed: "+JSON.stringify(d))}catch(e){c._logger.log("error","JSON error in doScene response: "+e.message)}b&&(d&&d.error?b(!1):b(!0))})};
xnm.aio.homekit.XCHomeKit.prototype.showCamera=function(a,b){this._logger.log("trace","Calling showCamera on host for ID: "+a);b.id=a;XC.callHost("homekit","showCamera",b)};xnm.aio.homekit.XCHomeKit.prototype.hideCamera=function(a){this._logger.log("trace","Calling hideCamera on host for ID: "+a);XC.callHost("homekit","hideCamera",{id:a})};
xnm.aio.homekit.XCHomeKit.prototype.showCameraSnapshot=function(a,b,c,d,e){this._logger.log("trace","Calling showCameraSnapshot on host for ID: "+a);a={id:a};b&&(a.left=b);c&&(a.top=c);d&&(a.width=d);e&&(a.height=e);XC.callHost("homekit","showCameraSnapshot",a)};xnm.aio.homekit.XCHomeKit.prototype.hideCameraSnapshot=function(a){this._logger.log("trace","Calling hideCameraSnapshot on host for ID: "+a);XC.callHost("homekit","hideCameraSnapshot",{id:a})};
xnm.aio.homekit.XCHomeKit.prototype.hideAllCameraViews=function(){this._logger.log("trace","Calling hideAllCameraViews on host.");XC.callHost("homekit","hideAllCameraViews",null)};
xnm.aio.homekit.DM={SYS:"homekit",applySmartWidgetFilter:function(a,b,c,d,e){c=this.applyUIFilter(b,{catagory:"command",elems:"*"});var l=this.applyUIFilter(b,{catagory:"status",elems:"*"}),h=null,k=null;c&&Array.isArray(c.command)&&0<c.command.length&&(h={},c.command.forEach(function(q){q&&q.ref&&(h[q.ref.value]=q.ref)}));l&&Array.isArray(l.status)&&0<l.status.length&&(k={},l.status.forEach(function(q){q&&q.ref&&(k[q.ref.value]=q.ref)}));if(!h&&!k)return null;h=h||{};k=k||{};c={};l={};var f=[],m=
{},g={};switch(b.type){case "airQualitySensor":case "dioxideSensor":g["%co2State%"]="dioxideLevel";f.push("sensor_co2");break;case "blind":case "shutter":m["%lamellaTo%"]="targetVerticalTilt";m["%moveDown%"]="down";m["%moveTo%"]="targetPosition";m["%moveUp%"]="up";m["%stop%"]="stop";g["%blindState%"]="currentPosition";g["%lamellaState%"]="currentVerticalTilt";g["%shutterState%"]="currentPosition";f.push("blind","shutter");break;case "heater":case "thermostat":m["%thermoTempDown%"]="down";m["%thermoTempUp%"]=
"up";g["%humState%"]="currentHumidity";g["%tempState%"]="currentTemperature";g["%thermoCurrentTemp%"]="currentTemperature";g["%thermoSetTemp%"]="targetTemperature";f.push("climate","thermostat","weather_station");break;case "motionSensor":g["%motionState%"]="motionDetected";f.push("motion");break;case "light":case "switch":m["%colorTemp%"]="colorTemperature";m["%dimTo%"]="brightness";m["%off%"]="off";m["%on%"]="on";m["%rgb%"]="color";m["%toggle%"]="toggle";g["%colorTempState%"]="colorTemperature";
g["%dimmerState%"]="brightness";g["%switchState%"]="powerState";f.push("dimmer","rgb","switch");break;default:return null}for(var n in m)b=m[n],h[b]&&(c[n]=h[b]);for(var p in g)n=g[p],k[n]&&(l[p]=k[n]);return a._injectToSmartWidgetTemplate(d,f,e,c,l,null)},applyUIFilter:function(a,b,c){if(!a.sys)return null;var d=function(f,m){if("*"===f||"*"===f[0])return!0;for(var g=0;g<f.length;g++)if(f[g]==m)return!0;return!1},e=function(f,m,g){var n=[];switch(g.catagory){case "command":f.command&&f.command.forEach(function(p){d(g.elems,
p.type)&&(p=JSON.parse(JSON.stringify(p)),n.push(p))});break;case "status":f.status&&f.status.forEach(function(p){d(g.elems,p.type)&&(p=JSON.parse(JSON.stringify(p)),n.push(p))})}return n},l=function(f,m){var g=[],n=xnm.aio.homekit.DM.getCommandStatusMap(f,c);n&&(f=e(n,f,m),g=g.concat(f));return g},h=JSON.parse(JSON.stringify(a)),k=null;switch(b.catagory){case "command":k=l(a,b);h.command=k;break;case "status":k=l(a,b);h.status=k;break;default:return null}return k&&0!=k.length?h:null},createDevice:function(a,
b,c){b=xnm.aio.homekit.DM;a?a.type?c(null,a):c(new b.Error(b.Error.ERROR_CODE.INVALID,"type is missing")):c(new b.Error(b.Error.ERROR_CODE.INVALID,"info is missing"))},createGateway:function(a,b,c){b=xnm.aio.homekit.DM;a?c(null,a):c(new b.Error(b.ERROR.ERROR_CODE.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){c&&c()},deleteGateway:function(a,b,c){c&&c()},getCommandStatusMap:function(a,b){b={command:[],status:[]};if("scene"===a.type)return b.command.push({name:"scene",type:"enum",ref:{value:"scene"}}),
b;var c={command:{enum:"%e",float:"%f",int:"%d",rgb:"%rgb",rgbw:"%rgbw",string:"%s"}};c.state=JSON.parse(JSON.stringify(c.command));c.state.rgb="%s";c.state.rgbw="%s";var d={},e=function(f,m,g){var n={name:m,type:"enum",ref:{value:m}};if(g.value&&"object"===typeof g.value){if("string"===typeof g.value.type){var p=String(g.value.type).toLowerCase();"bool"===p&&(p="enum");n.type=p;c[f][p]&&(n.ref.ext=c[f][p])}0<=["number","string"].indexOf(typeof g.value.min)&&0<=["number","string"].indexOf(typeof g.value.max)&&
(n.ref.extMeta=String(g.value.min)+"-"+String(g.value.max));"command"===f&&n.ref.extMeta&&(d[m]={},d[m].extMeta=n.ref.extMeta)}"string"===typeof g.type&&(p=String(g.type).toLowerCase(),"bool"===p&&(p="enum",n.ref.options=["true","false"]),n.type=p,c[f][p]&&(n.ref.ext=c[f][p]));Array.isArray(g.values)&&(n.ref.ext="%e","command"===f?n.ref.extMeta||(n.ref.extMeta=g.values.slice(0)):n.ref.options=g.values.slice(0));return n};if(a.commands&&"object"===typeof a.commands)for(var l in a.commands)b.command.push(e("command",
l,a.commands[l]));if(a.states&&"object"===typeof a.states)for(var h in a.states)b.status.push(e("state",h,a.states[h]));for(var k in d)for(a=d[k],l=0;l<b.status.length;l++)if(h=b.status[l],h.name===k){!h.ref.extMeta&&a.extMeta&&(h.ref.extMeta=a.extMeta);break}return b},getGatewayType:function(){return[{sys:this.SYS,name:"HomeKit"}]},supportSmartWidget:function(a){return a&&a.type&&(a.commands||a.states)?"airQualitySensor blind dioxideSensor heater light motionSensor shutter switch thermostat".split(" ").includes(a.type):
!1},toGeneralDevice:function(a){return null},updateDevice:function(a,b,c){b=xnm.aio.homekit.DM;a?a.type?c(null,a):c(new b.Error(b.Error.ERROR_CODE.INVALID,"type is missing")):c(new b.Error(b.Error.ERROR_CODE.INVALID,"info is missing"))},updateGateway:function(a,b,c,d){a=xnm.aio.homekit.DM;b?d(null,b):d(new a.Error(a.Error.ERROR_CODE.INVALID,"update is invalid"))}};xnm.aio.homekit.DM.Error=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};xnm.aio.homekit.DM.Error.prototype=Error();
xnm.aio.homekit.DM.Error.prototype.name="HomeKitDMError";xnm.aio.homekit.DM.Error.prototype.code=0;xnm.aio.homekit.DM.Error.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,INVALID:2,UNKNOWN:3,NOT_FOUND:4};xnm.aio.homekit.Handler=xnm.aio.homekit.XCHomeKit;xnm.aio.homekit.Handler.prototype.devicemanager=xnm.aio.homekit.DM;
xnm.aio.homekit.Handler.prototype._buildRequestOptions=function(a,b){var c=require("url").parse(a.url);a={headers:{Authorization:a.basicAuth,"Content-Type":"application/json"},host:c.hostname,method:b||"GET",path:c.path,port:c.port};0!==a.headers.Authorization.indexOf("Basic ")&&(a.headers.Authorization="Basic "+a.headers.Authorization);a.port||(a.port=443);return a};
xnm.aio.homekit.Handler.prototype.deleteFromServer=function(a,b){this._logger.log("trace","deleteFromServer()");this.exportToServer(a,"",b)};xnm.aio.homekit.Handler.prototype.executeCommandCreator=function(a,b,c){if(b&&b.value){var d=this;"scene"===a.type?this.doScene(a.id,function(e){d.updateStates();c&&c(e)}):this.executeCommand(a.id,b.value,b.ext,function(e){d.updateStates([a.id]);c&&c(e)})}else c&&c(Error("Command value is empty."))};
xnm.aio.homekit.Handler.prototype.exportToServer=function(a,b,c){this._logger.log("trace","exportToServer()");var d=null;try{if("string"===typeof b&&0===b.length)d=b;else{b={encrypted:!1,data:b};if(a.password){b.encrypted=!0;d=JSON.stringify(b.data);var e=require("x.crypt");b.data=e.AES.encodeString(d,a.password);b.data=b.data.replace(/[\r\n]/g,"")}d=JSON.stringify(b)}}catch(h){this._logger.log("error",h.message);c&&c(h);return}e=require("https");a=this._buildRequestOptions(a,"POST");var l=this;a=
e.request(a,function(h){var k="";h.on("data",function(f){k+=String(f)});h.on("end",function(){var f=null;0===k.indexOf('{"XC_ERR":')?(f=Error(k),l._logger.log("error","exportToServer: "+f.message)):l._logger.log("debug","Data has been exported.");c(f,k)})});"function"===typeof a.setEncoding&&a.setEncoding("utf-8");a.write(d);a.end()};
xnm.aio.homekit.Handler.prototype.getStatesCreator=function(a,b,c){this.getStates(function(d){for(var e=[],l=0;l<b.length;l++){var h=b[l];if(h&&h.id&&h.status){var k=d[h.device.id];k&&(k=k[h.status.value],"undefined"!==typeof k&&null!==k&&e.push({id:h.id,status:k}))}}c&&c(null,e)})};
xnm.aio.homekit.Handler.prototype.importFromServer=function(a,b){this._logger.log("trace","importFromServer()");var c=require("https"),d=this._buildRequestOptions(a,"GET"),e=this;c=c.request(d,function(l){var h="";l.on("data",function(k){h+=String(k)});l.on("end",function(){var k=null;try{k=JSON.parse(h)}catch(n){b(n,h);return}var f=k,m=null;if(k.XC_SUC){if(k=k.XC_SUC,f=k.data,k.encrypted)if(a.password)try{var g=require("x.crypt");f=f.replace(/[\r\n]/g,"");(f=g.AES.decodeString(f,a.password))&&(f=
JSON.parse(f));f||(m=Error("Could not decrypt data, wrong password."))}catch(n){m=n}else m=Error("Data is encrypted, but no password has been provided.")}else k.XC_ERR&&(f=k.XC_ERR,m="000000"===f.code&&"internal error"===f.msg?Error("No exported data available."):Error(h));m?e._logger.log("error",m.message):e._logger.log("debug","Data has been received.");b(m,f)})});"function"===typeof c.setEncoding&&c.setEncoding("utf-8");c.end()};
xnm.aio.homekit.Handler.prototype.registModule=function(a){a.register(xnm.aio.homekit.DM.SYS,"homekit")};xnm.aio.homekit.Handler.prototype.resolveDevice=function(a){return this};"undefined"!==typeof exports&&"undefined"!==typeof module&&module.exports&&(exports=module.exports=new xnm.aio.homekit.Handler);
