var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var c=0;return function(){return c<a.length?{done:!1,value:a[c++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,b){a!=Array.prototype&&a!=Object.prototype&&(a[c]=b.value)};$jscomp.getGlobal=function(a){a=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,a];for(var c=0;c<a.length;++c){var b=a[c];if(b&&b.Math==Math)return b}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(a,c){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:c})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function a(b){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(b||"")+"_"+c++,b)}var c=0;return a}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.asyncIterator;a||(a=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};
$jscomp.iteratorFromArray=function(a,c){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var b=0,d={next:function(){if(b<a.length){var f=b++;return{value:c(f,a[f]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
$jscomp.polyfill=function(a,c,b,d){if(c){b=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var f=a[d];f in b||(b[f]={});b=b[f]}a=a[a.length-1];d=b[a];c=c(d);c!=d&&null!=c&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:c})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");var x=x||{};x.hub=x.hub||{};x.hub.v5=x.hub.v5||{};
x.hub.v5.LocalSPIBus=function(a,c){this._device=c;this._openspi=null;this._timeout=2E3;this._callback=null};x.hub.v5.LocalSPIBus.prototype._transferChunked=function(a,c,b,d){var f=a;a.length>b&&(f=a.slice(0,b));var e=new Buffer(f.length),h=this;this._openspi.transfer(f,e,function(f,e){c=Buffer.concat([c,e]);a.length>b?h._transferChunked(a.slice(b),c,b,d):d(c)})};
x.hub.v5.LocalSPIBus.prototype._openDevice=function(a){var c=require("spi"),b=this,d=this._device;null==this._openspi&&(this._openspi=new c.Spi(d,{mode:c.MODE.MODE_0,chipSelect:c.CS.low,bitOrder:c.ORDER.msb}),this._openspi.maxSpeed(1E6),this._openspi.open());this._transferChunked(new Buffer(a),new Buffer([]),63,function(a){for(var c=0;c<a.length;c++);b._callback&&b._callback({error:null,data:a})})};x.hub.v5.LocalSPIBus.prototype.send=function(a,c,b){this._callback=b;this._openDevice(a)};
x.hub.v5.LocalSPIBus.prototype.receive=function(a,c,b){c=[];for(var d=0;d<a;d++)c.push(0);this.send(c,null,function(a){b&&b(a)})};x.hub.v5.LocalSPIBus.prototype.end=function(){};x.hub.v5.STMSPISerial=function(){this._onTimeout=this._onData=this._onError=this._timeoutTimer=this._spiPort=this._pin=this._port=null};x.hub.v5.STMSPISerial.prototype.on=function(a,c){"error"==a?this._onError=c:"data"==a?this._onData=c:"timeout"==a&&(this._onTimeout=c)};
x.hub.v5.STMSPISerial.prototype.open=function(a,c,b,d){b||(b=1E6);this._port=a;this._pin=d;this._baudrate=b;try{var f=require("spi")}catch(e){}f?(this._spiPort=new f.Spi(this._port,{mode:f.MODE.MODE_0,chipSelect:f.CS.low,bitOrder:f.ORDER.msb}),this._spiPort.maxSpeed(this._baudrate),this._spiPort.open(),c&&c(),this._read()):this._onError&&this._onError()};
x.hub.v5.STMSPISerial.prototype._writeChunked=function(a,c,b,d){var f=a;a.length>b&&(f=a.slice(0,b));new Buffer(f.length);var e=this;this._spiPort.write(f,function(f,g){a.length>b?e._writeChunked(a.slice(b),c,b,d):d()})};
x.hub.v5.STMSPISerial.prototype.write=function(a,c){if(this._spiPort){var b=this;XC.debugf("WRITE SPI:");XC.debugf(a);b._writeChunked(new Buffer(a),new Buffer([]),63,function(a){c&&(b._timeoutTimer&&clearTimeout(b._timeoutTimer),b._timeoutTimer=setTimeout(function(){b._spiPort=null;b._onTimeout&&b._onTimeout()},c))})}};x.hub.v5.STMSPISerial.prototype.flush=function(){};
x.hub.v5.STMSPISerial.prototype.close=function(){this._spiPort&&this._spiPort.close();this._timeoutTimer&&(clearTimeout(this._timeoutTimer),this._timeoutTimer=null);this._onTimeout=this._onData=this._onError=null};x.hub.v5.STMSPISerial.prototype.generateCommandMessage=function(a,c){var b=a;if(c){b=[31];b.push(c);for(c=0;c<a.length;c++)if("string"==typeof a)b.push(a.charCodeAt(c));else{var d=a[c];31!=d&&4!=d&&27!=d||b.push(27);b.push(d)}b.push(0);b.push(4)}return b};
x.hub.v5.STMSPISerial.prototype._read=function(){if(this._spiPort){var a=this,c=require("child_process").exec;c=c("cat /sys/class/gpio/"+this._pin+"/value");c.stdout.on("data",function(b){if(1==b.trim()&&a._spiPort){var c=new Buffer(63);for(b=0;63>b;b++)c[b]="0x00";var f=new Buffer(c.length);setTimeout(function(){a._spiPort.transfer(c,f,function(b,c){b=!1;for(var d=0;63>d;d++)if(4!=c[d]){b=!0;break}b&&a._timeoutTimer&&(clearTimeout(a._timeoutTimer),a._timeoutTimer=null);b&&a._onData&&a._onData(c)})},
50)}});c.on("error",function(b){});c.on("close",function(b){a._readTimeout=setTimeout(function(){a._read()},50)})}};x.hub.v5.USBSerial=function(a,c,b){this._logger=require("x.logger.js").getLogger("x.hub.v5.USBSerial");this._port=a;this._pin=c;this._pin||(this._pin="gpio228");this._stmUSBSerial=null;this._receiveBuffer=new Buffer([]);this._onData=null;this._useAck=!0;this._reqFifo=[];this.REQ_FIFO_MAX_LEN=5;this.ACK_TO=200;this.RSP_TO=1E4;this.RSP_END_TO=2E3;this._openSTMUSB(b)};
x.hub.v5.USBSerial.prototype.on=function(a,c){"data"==a&&(this._onData=c)};x.hub.v5.USBSerial.prototype.reset=function(a){this._logger.log("info","reset st fifo");var c=this._reqFifo;this._reqFifo=[];for(var b=0;b<c.length;b++)this._onRequestCancel(c[b]);a&&a()};
x.hub.v5.USBSerial.prototype._getNextDataPackage=function(){for(var a=!1,c=!1,b=!1,d,f=0,e=[],h=0;h<this._receiveBuffer.length;h++){d=!1;if(27==this._receiveBuffer[h]||4==this._receiveBuffer[h]||31==this._receiveBuffer[h])if(a)d=!0;else if(27==this._receiveBuffer[h])a=!0;else if(4==this._receiveBuffer[h]){var g=!1;c&&(g=!0);c=!1;b=!0;if(g){this._receiveBuffer=this._receiveBuffer.slice(h+1);break}else b=!1}else 31==this._receiveBuffer[h]&&(c=!0,f=0);else c&&(d=!0);d&&(e[f++]=this._receiveBuffer[h],
a=!1)}a=null;b&&2<=f&&(a=new Buffer(e.slice(0,f)));return a};
x.hub.v5.USBSerial.prototype._openSTMUSB=function(a){if(this._stmUSBSerial)a&&a(!0);else{var c=this,b=a,d=require("xnm.aio.m10T.js"),f=null,e=!1;-1!=this._port.indexOf("spi")?(e=!0,f=new x.hub.v5.STMSPISerial,d=1E6):(f=new d.STMUSBSerial,d=115200);f.on("error",function(){c._logger.log("trace","st port error");try{c._stmUSBSerial.close()}catch(h){}c._stmUSBSerial=null;b&&b(!1);b=null});f.on("timeout",function(){c._logger.log("trace","st port timeout");if(e){try{c._stmUSBSerial.close()}catch(h){}c._stmUSBSerial=
null;setTimeout(function(){c._openSTMUSB(a)},500)}});f.on("data",function(b){c._logger.log("trace","st data:"+b.toString("hex"));c._receiveBuffer=Buffer.concat([c._receiveBuffer,b]);for(b=c._getNextDataPackage();b;){c._logger.log("trace","st package:"+b.toString("hex"));var a=b.slice(1,b.length-1);switch(b[0]){case 80:c._logger.log("info","receive st event:"+a.toString());c._sendAck();break;case 0:c._onNak();break;case 1:c._onAck();break;case 34:c._sendAck();c._onRspError(a);break;case 32:c._sendAck();
c._onRsp(a);break;case 33:c._sendAck(),c._onRspEnd(a)}c._onData&&c._onData({type:b[0],data:a});b=c._getNextDataPackage()}});f.open(this._port,function(){c._logger.log("trace","st connected");c._stmUSBSerial=f;b&&b(!0);b=null},d,this._pin)}};
x.hub.v5.USBSerial.prototype.sendCommand=function(a,c,b,d){this._logger.log("info","add st (0x"+a.toString(16)+") request:"+(c&&c instanceof Buffer?c.toString("hex"):c));d=this._reqFifo.length;a={type:a,req:c,ackTo:null,ackToRetry:0,rspTo:null,state:0,callback:b,responseBuffer:null};this._reqFifo.length==this.REQ_FIFO_MAX_LEN&&(this._onRequestCancel(this._reqFifo[1]),this._reqFifo.splice(1,1));this._reqFifo.push(a);0==d&&this._sendNextReq()};
x.hub.v5.USBSerial.prototype._sendNextReq=function(){var a=this._reqFifo[0];if(a){var c=this;a.state=!this._useAck||16!=a.type&&17!=a.type?53==a.type?0:2:1;2==a.state&&(a.rspTo=setTimeout(function(){c._onRspTimeout()},this.RSP_TO));this._logger.log("debug","send st (0x"+a.type.toString(16)+") request:"+(a.req&&a.req instanceof Buffer?a.req.toString("hex"):a.req));this._openSTMUSB(function(b){b?(b=c._stmUSBSerial.generateCommandMessage(a.req,a.type),c._stmUSBSerial.write(b,0,function(){1==a.state?
a.ackTo=setTimeout(function(){c._onAckTimeout()},c.ACK_TO):0==a.state&&c._onRequestFinish(null)})):(c._logger.log("debug","open st failed"),c._onRequestFinish("st not open"))})}};x.hub.v5.USBSerial.prototype._sendAck=function(){if(this._useAck){this._logger.log("debug","send ack to st");var a=this._stmUSBSerial.generateCommandMessage("",1);this._stmUSBSerial.write(a)}};
x.hub.v5.USBSerial.prototype._onAckTimeout=function(){var a=this._reqFifo[0];if(a)if(a.ackToRetry+=1,3<a.ackToRetry)this._onRequestFinish("response ack timeout 3 times");else{this._logger.log("debug","st ack timeout, re-send "+a.ackToRetry+". request:"+a.req);var c=this;a.state=1;a.ackTo=setTimeout(function(){c._onAckTimeout()},this.ACK_TO*a.ackToRetry);this._logger.log("debug","re-send st (0x"+a.type.toString(16)+") request:"+a.req);a=this._stmUSBSerial.generateCommandMessage(a.req,a.type);this._stmUSBSerial.write(a)}};
x.hub.v5.USBSerial.prototype._onNak=function(){var a=this._reqFifo[0];a&&(this._logger.log("debug","receive st nak:"+a.req),this._onRequestFinish("response nak"))};x.hub.v5.USBSerial.prototype._onAck=function(){var a=this._reqFifo[0];if(a&&1==a.state){this._logger.log("debug","receive st ack:"+a.req);var c=this;a.state=2;a.ackTo&&(clearTimeout(a.ackTo),a.ackTo=null);a.rspTo&&(clearTimeout(a.rspTo),a.rspTo=null);a.rspTo=setTimeout(function(){c._onRspTimeout()},this.RSP_TO)}};
x.hub.v5.USBSerial.prototype._onRspTimeout=function(){var a=this._reqFifo[0];a&&(this._logger.log("debug","st response timeout:"+a.req),1==a.state?this._onRequestFinish("no ack"):2==a.state?this._onRequestFinish("response timeout"):3==a.state&&this._onRequestFinish("response end timeout"))};x.hub.v5.USBSerial.prototype._onRspError=function(a){this._logger.log("debug","receive st response_error");this._onRequestFinish("response error:"+(a?a.toString():""))};
x.hub.v5.USBSerial.prototype._onRsp=function(a){var c=this._reqFifo[0];if(c&&0!=c.state&&1!=c.state){this._logger.log("debug","receive st response:"+c.req+" --\x3e "+a.toString());var b=this;c.state=3;c.rspTo&&clearTimeout(c.rspTo);c.rspTo=setTimeout(function(){b._onRspTimeout()},this.RSP_END_TO);c.responseBuffer=c.responseBuffer?Buffer.concat([c.responseBuffer,a]):a}};
x.hub.v5.USBSerial.prototype._onRspEnd=function(a){var c=this._reqFifo[0];c&&0!=c.state&&1!=c.state&&(16==c.type||17==c.type?this._logger.log("debug","receive st response_end:"+c.req+" --\x3e "+a.toString()):this._logger.log("debug","receive st response_end:"+c.req.toString("hex")+" --\x3e "+a.toString("hex")),c.state=0,c.rspTo&&(clearTimeout(c.rspTo),c.rspTo=null),c.responseBuffer=c.responseBuffer?Buffer.concat([c.responseBuffer,a]):a,this._onRequestFinish(null))};
x.hub.v5.USBSerial.prototype._onRequestFinish=function(a){var c=this._reqFifo[0];if(c){c.ackTo&&(clearTimeout(c.ackTo),c.ackTo=null);c.rspTo&&(clearTimeout(c.rspTo),c.rspTo=null);var b="request finish:";b=16==c.type||17==c.type?b+(c.req+" --\x3e "):b+(c.req.toString("hex")+" --\x3e ");a?this._logger.log("warn",b+a):(c.responseBuffer&&(b+=c.responseBuffer.toString()),this._logger.log("info",b));try{c.callback&&c.callback({error:a,data:c.responseBuffer})}catch(d){}this._reqFifo.splice(0,1);this._sendNextReq()}};
x.hub.v5.USBSerial.prototype._onRequestCancel=function(a){a&&(a.ackTo&&(clearTimeout(a.ackTo),a.ackTo=null),a.rspTo&&(clearTimeout(a.rspTo),a.rspTo=null),this._logger.log("warn","request cancelled:"+a.req),a.callback&&a.callback({error:"request cancelled"}))};x.hub.v5.PK=null;
x.hub.v5.getHWSerial=function(a){var c=require("child_process").exec;c=c("cat /proc/cpuinfo | grep Serial | cut -d ':' -f 2");c.stdout.on("data",function(b){a(b.trim());a=null});c.on("error",function(b){a&&a("");a=null});c.on("close",function(b){a&&a("");a=null})};
x.hub.v5.getPrivateKey=function(a){x.hub.v5.PK?a(x.hub.v5.PK):x.hub.v5.getHWSerial(function(c){var b="";if(!localStorage.getItem("x.hub.v5.PK")){for(var d=0;64>d;d++)b+=Math.floor(15*Math.random()).toString(16);localStorage.setItem("x.hub.v5.PK",b)}b=localStorage.getItem("x.hub.v5.PK");d=require("x.crypt.js");x.hub.v5.PK=d.SHA256(b+c);a(x.hub.v5.PK)})};
x.hub.v5.CloudConnect=function(){var a=function(){this._logger=require("x.logger.js").getLogger("x.hub.v5.CloudConnect");this._client=null};a.prototype.CLOUD_SERVER="v5ws.mediola.com";a.prototype.CLOUD_SERVER_PORT=443;a.prototype.init=function(a){this._client&&(this._client.stop(),this._client=null);var b=this;this._buildClient(function(c){b._client=c;b._client.init(a)})};a.prototype.sendMessage=function(a,b){this._client&&this._client.sendMessage(a,b)};a.prototype.sendMessageActive=function(a,b){this._client?
this._client.sendMessageActive(a,b):b&&b(Error("no cloud connection client"))};a.prototype._buildClient=function(a){var b=localStorage.getItem("x.hub.v5.cloudServer");b||(b=this.CLOUD_SERVER);var c=localStorage.getItem("x.hub.v5.cloudPort");c||(c=this.CLOUD_SERVER_PORT);443==c&&(c=80);var f=localStorage.getItem("x.hub.v5.SID");if("v5ws.mediola.com"==b)a(new x.hub.v5.CloudConnectWS);else{var e=new (require("ws"))("ws://"+b+":"+c+"/ws/"+f),h=this;e.on("upgrade",function(b){a&&(h._logger.log("trace",
"support ws"),a(new x.hub.v5.CloudConnectWS),a=null,e.close())});e.on("error",function(b){a&&(h._logger.log("trace","not support ws"),a(new x.hub.v5.CloudConnectHTTP),a=null,e.close())});e.on("close",function(b,c){a&&(h._logger.log("trace","not support ws"),a(new x.hub.v5.CloudConnectHTTP),a=null,e.close())})}};return a}();
x.hub.v5.CloudConnectHTTP=function(){var a=function(){};a.prototype.check=function(){if("EA"==global.HARDWARE_VERSION){var a=require("dns").getServers();require("fs").readFile("/etc/resolv.conf",{encoding:"utf8"},function(b,c){if(!b){b=c.split("\n");c=!1;if(b&&0<b.length)for(var d=0;d<b.length;d++){var f=b[d].trim();if("#"!=f.charAt(0)&&"nameserver"==f.substr(0,10)&&(f=f.replace("nameserver","").trim())&&-1==a.indexOf(f)){c=!0;break}}c&&(b=require("child_process").exec,b("/etc/init.d/S60_v5plus_daemon restart"))}})}};
var c=function(){this._logger=require("x.logger.js").getLogger("x.hub.v5.CloudConnect.HTTP");this._request=null;this._timeout=3E5;this._error_count=0;this._run=!1;this._dns_error_count=0};c.prototype.CLOUD_SERVER="v5ws.mediola.com";c.prototype.CLOUD_SERVER_PORT=443;c.prototype.init=function(b){b&&(this._server=b);this._run=!0;this._liveResponse=null;this._messages=[];this._challenge=[];this._cloudToken=[0,0,0,0,0,0,0,0];b=require("x.crypt.js");this._cloudServer=localStorage.getItem("x.hub.v5.cloudServer");
this._cloudServer||(this._cloudServer=this.CLOUD_SERVER);this._cloudPort=localStorage.getItem("x.hub.v5.cloudPort");this._cloudPort||(this._cloudPort=this.CLOUD_SERVER_PORT);localStorage.getItem("x.hub.v5.SID")&&(this._SID=b.AES.h2a(localStorage.getItem("x.hub.v5.SID")));this._cloudKey=localStorage.getItem("x.hub.v5.cloudKey");var a=this;this._computeKeys(function(){a._request?a._disconnect(!0):a.checkConnection()})};c.prototype.stop=function(){this._run=!1;this._disconnect(!0)};c.prototype.checkConnection=
function(){if(this._run&&localStorage&&localStorage.getItem("x.hub.v5.config")){var a=parseInt(localStorage.getItem("x.hub.v5.config"),16);0==(a&64)&&this._cloudServer&&localStorage.getItem("x.hub.v5.SID")?this._connect():this._disconnect()}};c.prototype.sendMessage=function(a,c){c?this._messages.push(a):this._messages.unshift(a)};c.prototype.sendMessageActive=function(a,c){this._messages.unshift(a);this._request&&this._request.abort();c&&c()};c.prototype._computeKeys=function(a){var b=this;this._iv&&
this._key?a():x.hub.v5.getPrivateKey(function(c){var d=require("x.crypt.js");c=d.Curve25519.curve25519(c,b._cloudKey);for(var f="",g=0;g<c.length;g++)f+=XC.getHexVal(c[g],2);b._key=d.AES.h2a(f.substr(0,32));b._iv=d.AES.h2a(f.substr(32));a()})};c.prototype._handleServerResponse=function(a){var c=this,b=[],e=null;if(4<=a.length)if(4<=a.length&&240==a[1])a.splice(0,4);else if(4<=a.length&&255==a[1])a.splice(0,4),this._request&&this._request.abort();else{var h=(a[2]<<8)+a[3];a.length>=h+4&&(e=a[1],b=
a.slice(4,h+4),a.splice(0,h+4))}if(0<b.length){a=[];for(h=0;h<b.length;h++)a.push(b[h]);b=require("x.crypt.js");b.AES.setSize(128);b=b.AES.a2a(b.AES.decrypt(a,this._key,this._iv,!1));if(16<=b.length)if(b.slice(8,16).toString()==this._challenge.toString()){this._cloudToken=b.slice(0,8);for(a=b.length-1;16<a&&0!=b[a];)a--;b=(new Buffer(b.slice(16,a))).toString("utf8");0!=e&&(this._liveResponse?this._liveResponse=null:0<this._messages.length&&this._messages.pop());if(0==e||1==e){var g=null;localStorage&&
localStorage.getItem("x.hub.Server.pwd")&&(g=localStorage.getItem("x.hub.Server.pwd"));null==g&&(g="null");b!=g?(this.sendMessage("0101"+g,!0),this._request&&this._request.abort()):0==e?this._request&&this._request.abort():0<this._messages.length&&this._request&&this._request.abort()}else if((5==e||3==e)&&8<b.length){var k=null;5==e&&(k=b.substr(0,8),b=b.substr(8));e=c._parseTunnelUrl(b);c=this;if("/"==e.pathname||"/info"==e.pathname||"/set"==e.pathname||"/cmd"==e.pathname||"/executeCommand"==e.pathname||
"/getStates"==e.pathname){if(e.query&&e.query.json)try{JSON.parse(e.query.json)}catch(l){b=b.replace(e.pathname,""),"?json="==b.substr(0,6)&&(b=b.substr(6),e.query={json:b})}this._logger.log("trace","Remote Request Query:"+JSON.stringify(e.query));if(e.query&&e.query.json&&1==Object.keys(e.query).length)try{e.query=JSON.parse(e.query.json);e.path="";for(g in e.query)e.path+="&"+g+"="+e.query[g];e.path=e.pathname+"?"+e.path.substr(1)}catch(l){}this._server.doRequest(e.pathname,{query:e.query,url:e.path},
function(a){k&&(c._liveResponse=k+a);c._request&&c._request.abort()})}else{if(e.query&&e.query.json)try{JSON.parse(e.query.json)}catch(l){b=b.replace(e.pathname,""),"?json="==b.substr(0,6)&&(b=b.substr(6),e.query={json:b})}this._logger.log("trace","Remote Request Query:"+JSON.stringify(e.query));if(e.query&&e.query.json&&1==Object.keys(e.query).length)try{e.query=JSON.parse(e.query.json);e.path="";for(g in e.query)e.path+="&"+g+"="+e.query[g];e.path=e.pathname+"?"+e.path.substr(1)}catch(l){}this._server.doRequest(e.pathname,
{query:e.query,url:e.path,pathname:e.pathname},function(a){k&&(c._liveResponse=k+a);c._request&&c._request.abort()})}}}else return 1}return 0};c.prototype._disconnect=function(a){this._request&&(this._request.abort(),a&&(this._request=null))};c.prototype._connect=function(){var b=225,c="";this._liveResponse?(c=this._liveResponse,b=226):0<this._messages.length&&(c=this._messages[this._messages.length-1]);var f=require("x.crypt.js");f.AES.setSize(128);c=f.AES.s2a(c);var e=[];e=e.concat(this._cloudToken);
this._challenge=[];for(var h=0;8>h;h++)this._challenge.push(Math.floor(255*Math.random()));e=e.concat(this._challenge);e=e.concat(c);c=f.AES.encrypt(e,this._key,this._iv);c=f.AES.a2a(c);f.AES.a2a(f.AES.decrypt(c,this._key,this._iv,!1));b=[0,b];b=b.concat(this._SID);b=b.concat(c);b=new Buffer(b);f=this._cloudPort;80==f&&(f=443);c=require("x.hub.v5.js");e="";c.server&&(e="CCU3"==c.server.hostType?e+(c.server.HWV+"-CCU3/"+c.server.VERSION+"/"+c.server._vid):e+(c.server.HWV+"/"+c.server.VERSION+"/"+c.server._vid));
f={host:this._cloudServer,port:f,path:"/msmt",method:"POST",headers:{"Content-Type":"application/octet-stream","Content-Length":b.length,Connection:"keep-alive","X-MG-Info":e}};c=require("https");var g=this;g._logger.log("trace","Remote Access Start: "+JSON.stringify(f));this._request=c.request(f,function(a){g._logger.log("trace","Remote Access Response:"+a.statusCode);g._dns_error_count=0;if(200==a.statusCode){a.setEncoding("binary");var b=[],c=0;a.on("data",function(a){a=new Buffer(a,"binary");
for(var d=0;d<a.length;d++)b.push(a[d]);c=g._handleServerResponse(b)});a.on("end",function(){g._logger.log("trace","Remote Access End");g._error_count=0;g._disconnect();1==c?setTimeout(function(){g._iv=null;g._key=null;g._request=null;g.init()},1E3):g.checkConnection()})}else XC.debugf("Failed to post request to "+g.ip)});this._request.setTimeout(this._timeout,function(){g._logger.log("warn","Remote Access Timeout");g._request.abort()});this._request.on("close",function(a){XC.debugf("close")});this._request.on("error",
function(b){g._logger.log("warn","Remote Access ERROR: "+b);"EAI_AGAIN"==b.code&&(g._dns_error_count++,5<g._dns_error_count&&(g._dns_error_count=0,(new a).check()));g._error_count++;g._disconnect();b=g._error_count*g._error_count*100;2E3<b&&(b=2E3);setTimeout(function(){g.checkConnection()},b)});b&&this._request.write(b);this._request.end()};c.prototype._parseTunnelUrl=function(a){for(var b,c=-1;c<a.length&&(c++,"?"!=a.charAt(c)););if(-1==c)return{pathname:a};b=0==c?"/":a.substr(0,c);return"json="==
a.substr(c+1,5)?{pathname:b,query:{json:a.substr(c+6)}}:require("url").parse(a,!0)};return c}();
x.hub.v5.CloudConnectWS=function(){var a=require("util"),c=require("events"),b=function(a,c,b,h,g,k,l,m){this._logger=require("x.logger.js").getLogger("x.hub.v5.CloudConnect.WS.Socket");this._host=a;this._port=c;this._sid=b;this._token=h;this._hwv=g;this._server=k;this._ckey=l;this._civ=m;this._ws=this._hmac_key=this._communication_key=this._server_key=this._client_key=null;this._state=0;this._reqBuf="";this._pongTO=this._pingInterval=null;this._pongTOCount=0};a.inherits(b,c);b.prototype.open=function(){var a=
require("x.crypt.js"),c=require("crypto"),b=new (require("ws"))("ws://"+this._host+":"+this._port+"/ws/"+this._sid);if(b._req&&b._req._headers&&b._req._headers["sec-websocket-key"]){this._logger.log("trace","Sec-WebSocket-Key: "+b._req._headers["sec-websocket-key"]);var h=new Buffer(b._req._headers["sec-websocket-key"],"base64");this._client_key=a.AES.a2a(a.AES.decrypt(h,this._ckey,this._civ,!1));this._logger.log("trace","client_key: "+this._client_key)}var g=this;this._state=1;b.on("upgrade",function(b){g._logger.log("trace",
"upgrade");g._state=2;var d=!1;if(b&&b.headers&&b.headers["x-sec-websocket-token"]&&(g._logger.log("trace","X-Sec-WebSocket-Token: "+b.headers["x-sec-websocket-token"]),104==b.headers["x-sec-websocket-token"].length)){var f=b.headers["x-sec-websocket-token"].substr(0,64);b=b.headers["x-sec-websocket-token"].substr(64);g._logger.log("trace","hmac: "+b);g._server_key=a.AES.a2a(a.AES.decrypt(a.AES.h2a(f),g._ckey,g._civ,!1));g._logger.log("trace","server_key: "+g._server_key);g._communication_key=g._client_key.slice(0,
16).concat(g._server_key.slice(0,16));g._logger.log("trace","communication_key: "+g._communication_key);g._hmac_key=g._server_key.slice(16,32);g._logger.log("trace","hmac_key: "+g._hmac_key);f="";for(var e=0;e<g._communication_key.length;e++)f+=XC.getHexVal(g._communication_key[e],2);e="";for(var h=0;h<g._hmac_key.length;h++)e+=XC.getHexVal(g._hmac_key[h],2);e=c.createHmac("sha1",e);e.update(f);f=e.digest("hex").toUpperCase();g._logger.log("trace","hmac_check: "+f+" hmac:"+b);f==b&&(d=!0)}d||(g._state=
5)});b.on("open",function(){g._logger.log("trace","open");2==g._state?(g._state=3,g._logger.log("trace","connected"),g._sendMessage({token:g._token,server:g._server,hwv:g._hwv},1),g._startPeriodicPing(),g.emit("open")):5==g._state&&(g._logger.log("trace","key exchange failed"),g.emit("error",Error("key exchange failed")),g.close())});b.on("message",function(b){g._logger.log("trace","message ("+b.length+"):"+b.toString("hex"));var c=g._communication_key.slice(0,16),d=g._communication_key.slice(16,
32);b=a.AES.a2a(a.AES.decrypt(b,c,d,!1));if(8<b.length){c=b.slice(0,8);g._logger.log("trace","head: "+c);d=!0;c[0]&128&&(d=!1,c[0]-=128);b=a.AES.a2s([b.splice(8)]);g._logger.log("trace","data:"+b);g._reqBuf+=b;b=null;if(5==c[0]){b="";for(var f=4;8>f;f++)b+=XC.getHexVal(c[f],2);g._logger.log("trace","liveID: "+b)}d&&(d=g._reqBuf,g._reqBuf="",g._onReq(d,c,b))}});b.on("close",function(a,b){g._logger.log("trace","socket closed #"+a+":"+b);g._onClose("close")});b.on("error",function(a){g._logger.log("warn",
"socket error:"+a.message);g._onError(a)});b.on("pong",function(){g._logger.log("trace","PONG!");g._pongTO&&clearTimeout(g._pongTO);g._pongTO=null;g._pongTOCount=0});this._ws=b};b.prototype.abort=function(){this._state=4;this.removeAllListeners("open");this.removeAllListeners("error");this.removeAllListeners("close");this.removeAllListeners("message");this._pingInterval&&clearInterval(this._pingInterval);this._pingInterval=null;this._pongTO&&clearTimeout(this._pingTO);this._pingTO=null;this._ws&&
this._ws.terminate();this._ws=null};b.prototype.close=function(){this._state=4;this._pingInterval&&clearInterval(this._pingInterval);this._pingInterval=null;this._pongTO&&clearTimeout(this._pingTO);this._pingTO=null;this._ws&&this._ws.close();this._ws=null};b.prototype.send=function(a,b,c,h){3!=this._state?h&&h(Error("scoket not connected")):this._sendMessage(a,b,c,null,h)};b.prototype._sendMessage=function(a,b,c,h,g){var d=require("x.crypt.js");a=JSON.stringify(a);var f=this._communication_key.slice(0,
16),e=this._communication_key.slice(16,32);b=[b&255,0,0,0];b=c?b.concat(d.AES.h2a(c)):b.concat([0,0,0,0]);b=b.concat(d.AES.s2a(a));h&&(b[0]|=128);c=d.AES.a2a(d.AES.encrypt(b,f,e));this._ws.send(c,{binary:!0,mask:!0},function(a){g&&g(a)})};b.prototype._onError=function(a){this.emit("error",a)};b.prototype._onClose=function(){this._state=4;this._pingInterval&&clearInterval(this._pingInterval);this._pingInterval=null;this._pongTO&&clearTimeout(this._pingTO);this._pingTO=null;this.emit("close")};b.prototype._onReq=
function(a,b,c){this.emit("message",a,b,c)};b.prototype._startPeriodicPing=function(){var a=this;this._pingInterval=setInterval(function(){a._logger.log("trace","PING WS");a._ws.ping();a._pongTO&&clearTimeout(a._pongTO);a._pongTO=setTimeout(function(){a._pongTOCount++;3<=a._pongTOCount&&a._onPingPongFailed()},5E3)},2E4)};b.prototype._onPingPongFailed=function(){this.emit("error",Error("ping-pong failed"));this.close()};a=function(){this._logger=require("x.logger.js").getLogger("x.hub.v5.CloudConnect.WS");
this._cloudKey=this._localIP=this._hwv=this._at=this._sid=this._port=this._host=this._server=null;this._enabled=!1;this._socket=this._ckey=this._civ=null;this._state=0;this._reconnTO=null};a.prototype.CLOUD_SERVER="v5ws.mediola.com";a.prototype.CLOUD_SERVER_PORT=443;a.prototype.init=function(a){a&&(this._server=a);this._host=localStorage.getItem("x.hub.v5.cloudServer");this._host||(this._host=this.CLOUD_SERVER);this._port=localStorage.getItem("x.hub.v5.cloudPort");this._port||(this._port=this.CLOUD_SERVER_PORT);
443==this._port&&(this._port=80);this._sid=localStorage.getItem("x.hub.v5.SID");this._at=localStorage.getItem("x.hub.Server.pwd");this._hwv=a.HWV;this._localIP=this._getLocalIP();this._cloudKey=localStorage.getItem("x.hub.v5.cloudKey");a=(a=localStorage.getItem("x.hub.v5.config"))?parseInt(a,16):255;this._enabled=0==(a&64);this._abort();this._state=1;if(this._sid&&this._at&&this._cloudKey&&this._enabled){var b=this;this._civ=this._ckey=null;this._computeKeys(function(){b._connect()})}};a.prototype.stop=
function(){this._abort()};a.prototype._connect=function(){this._logger.log("info","connect socket");var a=this,c=new b(this._host,this._port,this._sid,this._at,this._hwv,this._localIP,this._ckey,this._civ);c.on("open",function(){a._logger.log("trace","socket open");a._onSocketOpen()});c.on("error",function(b){a._logger.log("trace","socket error:"+b.message);a._onSocketError(b)});c.on("close",function(){a._logger.log("trace","socket close");a._onSocketClose()});c.on("message",function(b,c,d){a._logger.log("trace",
"socket message type:"+c[0]);d&&a._logger.log("trace","socket message liveID:"+d);a._logger.log("trace","socket message:"+b);a._onSocketMessage(b,c,d)});c.open();this._socket=c};a.prototype._abort=function(){0!=this._state&&this._socket&&this._socket.abort();this._reconnTO&&clearTimeout(this._reconnTO);this._socket=this._reconnTO=null;this._state=0};a.prototype._onSocketOpen=function(){this._logger.log("info","successfully connect to cloud:");this._state=2};a.prototype._onSocketError=function(a){var b=
this;switch(this._state){case 1:this._logger.log("warn","failed to connect to cloud:"+a.message);this._logger.log("trace","re-connect after 30 seconds");this._state=1;this._socket.abort();this._reconnTO=setTimeout(function(){b._logger.log("trace","re-try connect to cloud after connection failed");b._reconnTO=null;b._connect()},3E4);break;case 2:this._logger.log("warn","cloud connection err:"+a.message),this._logger.log("trace","re-connect after 30 seconds"),this._state=1,this._socket.abort(),this._reconnTO=
setTimeout(function(){b._logger.log("trace","re-try connect to cloud after connection error");b._reconnTO=null;b._connect()},3E4)}};a.prototype._onSocketClose=function(){this._logger.log("trace","cloud connection closed");if(2==this._state&&(this._state=1,!this._reconnTO)){var a=this;this._logger.log("trace","re-connect after 30 seconds");this._reconnTO=setTimeout(function(){a._logger.log("trace","re-try connect to cloud after connection closed");a._reconnTO=null;a._connect()},3E4)}};a.prototype._onSocketMessage=
function(a,b,c){var d=this._parseTunnelUrl(a);if(d.query&&d.query.json)try{var e=decodeURIComponent(d.query.json);JSON.parse(e)}catch(m){a=a.replace(d.pathname,""),"?json="==a.substr(0,6)&&(a=a.substr(6),d.query={json:a})}this._logger.log("trace","Remote Request Path:"+JSON.stringify(d.pathname));this._logger.log("trace","Remote Request Query:"+JSON.stringify(d.query));if(d.query&&d.query.json&&1==Object.keys(d.query).length)try{e=decodeURIComponent(d.query.json);d.query=JSON.parse(e);d.path="";for(var f in d.query)d.path+=
"&"+f+"="+d.query[f];d.path=d.pathname+"?"+d.path.substr(1)}catch(m){}var l=this;this._server.doRequest(d.pathname,{query:d.query,url:d.path,pathname:d.pathname,source:"cloud"},function(a){l._logger.log("trace","Remote Request Response:"+a);c&&a&&l._socket.send(JSON.parse(a),b[0],c)})};a.prototype._computeKeys=function(a){if(this._ckey&&this._civ)a();else{var b=this;x.hub.v5.getPrivateKey(function(c){c=require("x.crypt.js").Curve25519.curve25519(c,b._cloudKey);for(var d="",e=0;e<c.length;e++)d+=XC.getHexVal(c[e],
2);b._ckey=c.slice(0,16);b._civ=c.slice(16,32);a()})}};a.prototype._parseTunnelUrl=function(a){for(var b,c=-1;c<a.length&&(c++,"?"!=a.charAt(c)););if(-1==c)return{pathname:a};b=0==c?"/":a.substr(0,c);return"json="==a.substr(c+1,5)?{pathname:b,query:{json:a.substr(c+6)}}:require("url").parse(a,!0)};a.prototype._getLocalIP=function(){var a=require("os").networkInterfaces(),b;for(b in a)for(var c=a[b],h=0;h<c.length;h++){var g=c[h];if(g&&!g.internal&&"IPv4"==g.family&&g.address)return g.address}return null};
return a}();x.hub.v5.DownloadFile=function(a,c,b){var d=require("http"),f=require("fs");f.existsSync(a)&&f.unlinkSync(a);var e=f.createWriteStream(a);d.get(c,function(c){c&&200==c.statusCode?(c.pipe(e),e.on("finish",function(){e.close(function(){b&&b(!0)})}),e.on("error",function(c){f.unlink(a);b&&b(!1)})):b&&b(!1)}).on("error",function(c){f.unlink(a);b&&b(!1)})};
x.hub.v5.BackupSTData=function(a,c,b){if(a._stmPort){var d=function(b,c,d){a.doSTMCommand(b,function(a){a&&a.XC_SUC?require("fs").writeFile(c,JSON.stringify(a.XC_SUC),function(a){a?d(!1):d(!0)}):d(!1)})};d("XC_FNC=GetStates&config=1",c+"/states.json",function(a){a?d("XC_FNC=GetSI",c+"/si.json",function(a){a&&b?b(!0):b&&b(!1)}):b&&b(!1)})}else b&&b(!0)};x.hub.v5.ResetSTData=function(a,c){a.doSTMRequest(53,[],function(a){c&&c()})};
x.hub.v5.RestoreSTData=function(a,c,b){var d=require("fs-extra"),f=require("querystring"),e=function(b){var e=function(c){if(0<c.length){var d=c.pop();d.type&&d.adr?(d=f.stringify(d),a.doSTMCommand("XC_FNC=AddSensor&"+d,function(a){e(c)})):e(c)}else b(!0)};d.existsSync(c+"/states.json")?d.readFile(c+"/states.json",function(a,c){if(a)b(!1);else{a=null;try{a=JSON.parse(c.toString())}catch(m){}a?0<a.length?e(a):b(!0):b(!1)}}):b(!0)};a._stmPort?e(function(a){a?b&&b(!0):b&&b(!1)}):b&&b(!0)};
x.hub.v5.NativeWrapper=function(){this._mconfigPath="../../sbin/mconfig";this._stserPath="../../bin/stser";this._resetPin=236;this._hmPort="/dev/hmip-uart";this._usbMountPath="/media/usb0";this._resetPinState="1";this._getIpCbs=[]};
x.hub.v5.NativeWrapper.prototype._execMConfig=function(a,c){var b=require("child_process").exec;a=b(this._mconfigPath+" "+a);var d="";a.stdout.on("data",function(a){a=String(a).trim();a=a.replace(/[\n\r]/g,"");a=a.replace(/\\x00/g,"");d+=a});a.on("error",function(a){c&&c({XC_ERR:{code:"000001",msg:"Error when executing mconfig."}})});a.on("close",function(a){a=null;if(0<d.length)try{a=JSON.parse(d)}catch(e){a={XC_ERR:{code:"000001",msg:e.message},res:String(d)}}c&&c(a)})};
x.hub.v5.NativeWrapper.prototype._exec=function(a,c,b){var d=require("child_process").exec;a=d(a);a.stdout.on("data",function(a){a=String(a).trim();c&&c(a)});a.on("error",function(a){b&&b(a)});a.on("close",function(a){b&&b()})};
x.hub.v5.NativeWrapper.prototype.checkHMSerial=function(a){var c=require("child_process").exec;c=c("eq3configcmd update-coprocessor -p "+this._hmPort+" -c -v -d /srv/hm-root/opt/hm/firmware/");var b="";c.stdout.on("data",function(a){b+=a.trim().replace(/[\n\r]/g,"")});c.stderr.on("data",function(a){b+=a.trim().replace(/[\n\r]/g,"")});c.on("error",function(a){});c.on("close",function(c){-1<b.indexOf("<Info> Version:")&&(b="OK");a&&a(b)})};
x.hub.v5.NativeWrapper.prototype.getIPData=function(a){var c=this._getIpCbs.length;a&&-1==this._getIpCbs.indexOf(a)&&this._getIpCbs.push(a);if(0==c){var b=this;this._execMConfig("config network show",function(a){var c=b._getIpCbs;b._getIpCbs=[];var d={};if(a){for(var h in a){var g=a[h];d[h]=[];for(l=0;l<g.length;l++){var k=g[l];"object"===typeof g[l]&&null!==g[l]&&(k.IPV4&&(k.IP=k.IPV4,delete k.IPV4),k.MAC&&(k.MAC=k.MAC.replace(/:/g,"-")),k.DNS&&Array.isArray(k.DNS)&&k.DNS[0]&&(k.DNS=k.DNS[0]),k.DHCP=
k.DHCP&&"TRUE"==k.DHCP,d[h].push(k))}}l=0}else var l=0;for(;l<c.length;l++)c[l]&&c[l](d)})}};x.hub.v5.NativeWrapper.prototype._setNTP=function(a,c){a?this._execMConfig("config network ntp server "+a,function(a){c&&c(!0)}):c&&c(!1)};
x.hub.v5.NativeWrapper.prototype.scanWiFi=function(a){this._execMConfig("config network wlan scan",function(c){var b=null,d=[];if(Array.isArray(c))for(var f=0;f<c.length;f++)"string"===typeof c[f].ssid&&0<c[f].ssid.length&&d.push(c[f]);else"string"===typeof c?b=Error(JSON.stringify({XC_ERR:{msg:c}})):c.XC_ERR&&(b=Error(JSON.stringify(c)));a&&a(b,d)})};
x.hub.v5.NativeWrapper.prototype.connectWiFi=function(a,c,b){a='config network wlan connect "'+(String(a).replace(/"/g,'\\"')+'"');a+='"'+String(c).replace(/"/g,'\\"')+'"';var d=this;this._execMConfig(a,function(a){a=a&&"done"==a.status;b&&b(a);setTimeout(function(){d.reboot()},1E3)})};x.hub.v5.NativeWrapper.prototype.resetNetwork=function(a){this._execMConfig("config network reset",function(c){var b=!1;c&&"done"==c.status&&(b=!0);a&&a(b)})};
x.hub.v5.NativeWrapper.prototype.resetHM=function(a){this._execMConfig("system resetHM",function(c){var b=!1;c&&"done"==c.status&&(b=!0);a&&a(b)})};x.hub.v5.NativeWrapper.prototype.resetZway=function(a){this._execMConfig("system resetZWAY",function(c){var b=!1;c&&"done"==c.status&&(b=!0);a&&a(b)})};x.hub.v5.NativeWrapper.prototype.resetZigbee=function(a){this._execMConfig("system resetZigbee",function(c){var b=!1;c&&"done"==c.status&&(b=!0);a&&a(b)})};
x.hub.v5.NativeWrapper.prototype._setIPData=function(a,c){var b=null;1==a.DHCP?b="config network lan dhcp":a.IP&&a.SN&&a.GW&&a.DNS&&(b="config network lan static "+a.IP+" "+a.SN+" "+a.GW+" "+a.DNS);var d=this;this._setNTP(a.NTP,function(){c&&c(!0);b&&d._execMConfig(b,function(a){XC.debugf("setIPData:");XC.debugf(a);setTimeout(function(){d._execMConfig("config network restart eth0",function(a){XC.debugf(a)})},1500)})})};
x.hub.v5.NativeWrapper.prototype._setMAC=function(a,c,b){c.MAC?a.doSTMRequest(57,XC.getBytes(c.MAC,!0),function(d){d||XC.debugf("set st mac error");a.doSTMRequest(58,[],function(a){a&&XC.debugf("new mac: "+a.toString("hex"));b&&(a&&a.toString("hex")==c.MAC.toLowerCase()?b(!0):b(!1))})}):b&&b(!0)};x.hub.v5.NativeWrapper.prototype.setIPData=function(a,c,b){var d=this;this._setMAC(a,c,function(a){a?d._setIPData(c,b):b&&b(!1)})};
x.hub.v5.NativeWrapper.prototype.setWLANData=function(a,c){var b=null;!0===a.DHCP?b="config network wlan dhcp":a.IP&&a.SN&&a.GW&&a.DNS&&(b="config network wlan static ",b+='"'+a.IP+'" "'+a.SN+'" "'+a.GW+'" "'+a.DNS+'"');var d=this;this._setNTP(a.NTP,function(){b?d._execMConfig(b,function(a){c&&c(!0);setTimeout(function(){d._execMConfig("config network restart wlan0",function(a){XC.debugf(a)})},1500)}):c&&c(!0)})};
x.hub.v5.NativeWrapper.prototype.updateFirmware=function(a,c,b,d){var f=require("http"),e=require("fs");e.existsSync("/tmp/firmware_update.iopk")&&e.unlinkSync("/tmp/firmware_update.iopk");var h=e.createWriteStream("/tmp/firmware_update.iopk"),g=this;f.get("http://"+a+":"+c+b,function(a){a&&200==a.statusCode?(a.pipe(h),h.on("finish",function(){h.close(function(){g._execMConfig("system update",function(a){XC.debugf(a);d&&d('{"XC_SUC":{}}')})})}),h.on("error",function(a){e.unlink("/tmp/firmware_update.iopk");
d&&d('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})):d&&d('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')}).on("error",function(a){e.unlink("/tmp/firmware_update.iopk");d&&d('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})};
x.hub.v5.NativeWrapper.prototype.updateSTFirmware=function(a,c,b,d,f){var e=require("http"),h=require("fs");h.existsSync("/tmp/st.bin")&&h.unlinkSync("/tmp/st.bin");var g=h.createWriteStream("/tmp/st.bin");e.get("http://"+a+":"+c+b,function(a){a&&200==a.statusCode?(a.pipe(g),g.on("finish",function(){g.close(function(){var a=new (require("xnm.aio.m10T.js").STMUpdater)("/tmp/st.bin");a.hostType="A20";var b=0;a.startSPIUpdate(new x.hub.v5.LocalSPIBus("SPI","/dev/spidev0.0"),function(c){c.error?(XC.debugf("\r\nfailed to flash ST ("+
c.error+")"),a.resetST(!1),f?f('{"XC_SUC":{}}'):d&&d.send("ERROR.")):100==c.state?(XC.debugf("\r\nflashed ST!"),a.resetST(!1),f?f('{"XC_SUC":{}}'):d&&d.end("100.")):d&&b!=c.state&&(d.write(c.state+"."),b=c.state)})})}),g.on("error",function(a){h.unlink("/tmp/st.bin");f?f('{"XC_ERR":{"code":"000000", "msg":"internal error"}}'):d&&d.send("ERROR.")})):f?f('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'):d&&d.send("ERROR.")}).on("error",function(a){h.unlink("/tmp/st.bin");f?f('{"XC_ERR":{"code":"000000", "msg":"internal error"}}'):
d&&d.send("ERROR.")})};
x.hub.v5.NativeWrapper.prototype.updateV5PFirmware=function(a,c,b){var d=this;this._saveFirmware(a,function(f,e){f?(c.end("ERROR.["+f.message+"]"),b&&b(f)):d._splitFirmwareV5PlusFile(e,"/tmp",a.query.filename,function(a,e,f){a?(c.end("ERROR.["+a.message+"]"),b&&b(a)):e&&f?d._updateSTFirmware(f,c,function(a){a?(c.end("ERROR.["+a.message+"]"),b&&b(a)):d._updateA20Firmware(e,function(a){a?(c.end("ERROR.["+a.message+"]"),b&&b(a)):(c.end('{"XC_SUC":{}}',function(){b&&(b(),b=null)}),setTimeout(function(){b&&
(b(),b=null)},5E3))})}):f?d._updateSTFirmware(f,c,function(a){a?(c.end("ERROR.["+a.message+"]"),b&&b(a)):(c.end('{"XC_SUC":{}}',function(){b&&(b(),b=null)}),setTimeout(function(){b&&(b(),b=null)},5E3))}):e&&d._updateA20Firmware(e,function(a){if(a)c.end("ERROR.["+a.message+"]"),b&&b(a);else var d=0,e=setInterval(function(){d++;100>=d?c.write(d+"."):(clearInterval(e),c.end('{"XC_SUC":{}}',function(){b&&(b(),b=null)}),setTimeout(function(){b&&(b(),b=null)},5E3))},10)})})})};
x.hub.v5.NativeWrapper.prototype._saveFirmware=function(a,c){var b=require("fs");require("os");var d=require("path"),f=d.join("/tmp","/firmware_update.v5pfw");b.existsSync(d)&&b.unlinkSync(d);var e=b.createWriteStream(f);a.pipe(e);e.on("finish",function(){e.close(function(){c&&c(null,f)})});e.on("error",function(a){b.unlink(f);c&&c(a)})};
x.hub.v5.NativeWrapper.prototype._splitFirmwareV5PlusFile=function(a,c,b,d){var f=require("fs"),e=require("os"),h=require("path");c=c||e.tmpdir();var g=function(b,c,d,e){b=f.createWriteStream(b);b.on("finish",function(){e&&e(null)});var g=f.createReadStream(a,{flags:"r",start:c,end:d});g.on("error",function(a){e&&e(a);e=null;g.end()});g.pipe(b)};f.readFileLine(a,1,function(e,f){if(e)"string"==typeof e&&(e=Error(e)),d&&d(e,null,null);else{var k=(new (require("xnm.aio.m10T.js").V5Updater)).parseHeader(f);
f=e=!1;if(!k&&(b&&-1!=b.indexOf(".iopk")?e=!0:b&&-1!=b.indexOf(".bin")&&(f=!0),!e&&!f)){e=Error("Could not parse header section of file.");d&&d(e,null,null);return}Date.now();var l=h.join(c,"firmware_update.iopk"),q=h.join(c,"st.bin");if(k){var p=k.offset+k.esp[3],n=p+k.esp[4];g(l,p,n,function(a){p=k.offset+k.st[3];n=p+k.st[4];var b=k.st[2].split(".");a=parseInt(b[0]);b=parseInt(b[1]);1<a||1==a&&1<=b?d&&d(null,l,null):g(q,p,n,function(a){d&&d(null,l,q)})})}else e?d&&d(null,a,null):f?d&&d(null,null,
a):d&&d(Error("invalid firmware data"),null,null)}})};x.hub.v5.NativeWrapper.prototype._updateA20Firmware=function(a,c){var b=global.FIRMWARE_VERSION;console.log("update system "+b);"1.0"!=b.substr(0,3)&&c&&c();var d=this;setTimeout(function(){d._execMConfig("system update",function(a){console.log("update system finish "+b.substr(0,3));"1.0"==b.substr(0,3)&&c&&c()})},1500)};
x.hub.v5.NativeWrapper.prototype._updateSTFirmware=function(a,c,b){var d=new (require("xnm.aio.m10T.js").STMUpdater)(a);d.hostType="A20";var f=0;d.startSPIUpdate(new x.hub.v5.LocalSPIBus("SPI","/dev/spidev0.0"),function(a){console.log("!!!!!!!",a?JSON.stringify(a):"null");a.error?(XC.debugf("\r\nfailed to flash ST ("+a.error+")"),d.resetST(!1),c&&c.write("ERROR.["+a.error+"]"),b&&b(Error(a.error))):100==a.state?(XC.debugf("\r\nflashed ST!"),d.resetST(!1),c&&c.write("100."),b&&b()):c&&f!=a.state&&
(c.write(a.state+"."),f=a.state)})};
x.hub.v5.NativeWrapper.prototype.backup=function(a,c){var b=require("fs-extra");b.existsSync("/tmp/firmware_backup.iopk")&&b.removeSync("/tmp/firmware_backup.iopk");var d=this;x.hub.v5.BackupSTData(a,"./data",function(a){a?d._execMConfig("system backup "+(Math.floor(49*Math.random())+1),function(a){a&&"done"==a.status&&b.existsSync("/tmp/firmware_backup.iopk")?(a=(new Date).toISOString().substr(0,16).replace(/T/g,"").replace(/-/g,"").replace(/:/g,""),c.setHeader("Content-disposition","attachment; filename=backup_"+
a+".iopk"),c.sendFile("/tmp/firmware_backup.iopk",null,function(a){b.removeSync("./data/states.json");b.removeSync("./data/si.json");b.removeSync("/tmp/firmware_backup.iopk");a&&c.status(500).end()})):c.status(500).end()}):c.status(500).end()})};
x.hub.v5.NativeWrapper.prototype.restore=function(a,c,b){var d=require("fs-extra");d.existsSync("/tmp/firmware_backup.iopk")&&d.removeSync("/tmp/firmware_backup.iopk");var f=this;x.hub.v5.DownloadFile("/tmp/firmware_backup.iopk",c,function(c){c&&d.existsSync("/tmp/firmware_backup.iopk")?f._execMConfig("system restore",function(c){c&&"done"==c.status?x.hub.v5.RestoreSTData(a,"./data",function(a){a?(d.removeSync("/tmp/firmware_backup.iopk"),b&&b('{"XC_SUC":{}}')):b&&b('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')}):
b&&b('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')}):b&&b('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})};x.hub.v5.NativeWrapper.prototype.reboot=function(){this._execMConfig("system reboot",function(a){})};
x.hub.v5.NativeWrapper.prototype._checkResetPin=function(a,c,b){0==a.readSync()&&(a=Date.now()-this._resetPinPressBegin,8E3<a?(this._resetPinPressBegin=Date.now(),this._resetMode="reboot",c&&c.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0000")):6E3<a?(this._resetMode="factory",c&&c.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0003")):4E3<a?(this._resetMode="passwords",c&&c.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0004")):2E3<a&&(this._resetMode="network",c&&c.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0001")))};
x.hub.v5.NativeWrapper.prototype.watchResetPin=function(a,c){var b=require("onoff").Gpio,d=new b(this._resetPin,"in","both");d.unexport();d=new b(this._resetPin,"in","both");var f=this,e=null;d.watch(function(b,g){e&&(clearInterval(e),e=null);a&&a.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0000");0==g?(f._resetPinPressBegin=Date.now(),f._resetMode=null,e=setInterval(function(){f._checkResetPin(d,a,c)},200)):c&&c(f._resetMode)})};
x.hub.v5.NativeWrapper.prototype.checkResetPin=function(){return(new (require("onoff").Gpio)(this._resetPin,"in","both")).readSync()};
x.hub.v5.NativeWrapper.prototype.mountUSB=function(a){var c=a,b=setTimeout(function(){c&&c(Error("execute setUSBmount start timeout"));c=null},2E4),d=this;a=require("child_process").exec;a=a("../../sbin/setUSBmount start");var f="",e="";a.stdout.on("data",function(a){f+=a;XC.debugf("setUSBmount start: "+f)});a.stderr.on("data",function(a){e+=a;XC.debugf("setUSBmount start error: "+e)});a.on("error",function(a){b&&(clearTimeout(b),b=null);c&&c(Error("execute setUSBmount start error"));c=null});a.on("close",
function(a){XC.debugf("exec close");XC.debugf("setUSBmount start: "+f);b&&(clearTimeout(b),b=null);if(e){e=e.replace("/dev/sda","");e=e.replace("on","");e=e.replace("/media/usb0","");var g=Error(e)}c&&c(g,d._usbMountPath);c=null})};
x.hub.v5.NativeWrapper.prototype.unmountUSB=function(a){var c=a,b=setTimeout(function(){c&&c(Error("execute setUSBmount stop timeout"));c=null},2E4);a=require("child_process").exec;a=a("../../sbin/setUSBmount stop");var d="";a.stdout.on("data",function(a){});a.stderr.on("data",function(a){d+=a;XC.debugf("setUSBmount stop error: "+d)});a.on("error",function(a){b&&(clearTimeout(b),b=null);c&&c(Error("execute setUSBmount stop error"));c=null});a.on("close",function(a){if(d){d=d.replace("/dev/sda","");
d=d.replace("on","");d=d.replace("/media/usb0","");var b=Error(d)}c&&c(b);c=null})};x.hub.v5.NativeWrapper.prototype.setDateTime=function(a,c,b,d,f,e){c+="";2>c.length&&(c="0"+c);b+="";2>b.length&&(b="0"+b);d+="";2>d.length&&(d="0"+d);f+="";2>f.length&&(f="0"+f);a=c+b+d+f+a;console.log("set system time:"+a);this._execMConfig("system set time "+a,function(a){console.log("set system time finish",a);e&&e(!0)})};x.hub.v5.NativeWrapper.prototype.runMdev=function(a){this._exec("mdev -s",null,a)};
x.hub.v5.Handler=function(){this._logger=require("x.logger.js").getLogger("x.hub.v5.Handler");this._usbPath=this._pk=this._serial=this.server=null};
x.hub.v5.Handler.prototype.setRGBColor=function(a){if(this.server&&"A20"==this.server.hostType)this.server.doSTMCommand("XC_FNC=SendSC&type=RGB&data=00"+a);else{var c=parseInt(a,16);c&16711680&&(c|=1048576);c&65280&&(c|=4096);c&255&&(c|=16);try{var b=require("rpi-ws281x-native/lib/ws281x-native");b&&(b.init(1),b.render([c]),setTimeout(function(){b.render([c])},100))}catch(d){}}};
x.hub.v5.Handler.prototype.getPublicKey=function(a){x.hub.v5.getPrivateKey(function(c){c=require("x.crypt.js").Curve25519.curve25519(c);for(var b="",d=0;d<c.length;d++)b+=XC.getHexVal(c[d],2);b=b.toLowerCase();a(b)})};
x.hub.v5.Handler.prototype.backup=function(a,c,b){var d=require("fs"),f=require("fs-extra");d.existsSync("/tmp/backup")&&d.rmdirRecursiveSync("/tmp/backup");d.mkdirSync("/tmp/backup");this._backup(a,"/tmp/backup",b,function(a,b,d){a?c.status(500).end():(c.setHeader("Content-disposition","attachment; filename="+d),c.sendFile(b,null,function(a){f.removeSync("/tmp/backup");f.removeSync(b);a&&c.status(500).end()}))})};
x.hub.v5.Handler.prototype.restore=function(a,c,b,d){var f=require("fs");require("fs-extra");var e=this;x.hub.v5.DownloadFile("/tmp/restore.zip",c,function(c){c?(f.existsSync("/tmp/restore/")&&f.rmdirRecursiveSync("/tmp/restore/"),e._extractBackupZip("/tmp/restore.zip","/tmp/restore/",b,function(b){b?d&&d('{"XC_ERR":{"msg":"'+b.message+'"}}'):f.existsSync("/tmp/restore/backup")?e._restore(a,"/tmp/restore/","backup",function(a){a?d&&d('{"XC_ERR":{"code":"000000", "msg":"'+a.message+'"}}'):d('{"XC_SUC":{}}')}):
d&&d('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})):d&&d('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})};x.hub.v5.Handler.prototype.mountUSB=function(a){var c=this;this.Native.mountUSB(function(b,d){b?a&&a({error:b}):c.setBackupUsbPath(d,a)})};x.hub.v5.Handler.prototype.unmountUSB=function(a){try{require("fs-extra").remove("./backup_local")}catch(c){}this._usbPath=null;this.Native.unmountUSB(function(c){a&&a({error:c})})};
x.hub.v5.Handler.prototype.setBackupUsbPath=function(a,c){this._usbPath=a;var b=require("fs-extra");b.existsSync("./backup_local")?b.emptyDirSync("./backup_local"):b.ensureDirSync("./backup_local");b.existsSync(a)||b.ensureDirSync(a);c&&c({})};x.hub.v5.Handler.prototype.saveDeviceXMLforBackup=function(a,c){require("fs-extra").writeFile("./backup_local/devices.xml",a,function(a){c&&c({error:a})})};
x.hub.v5.Handler.prototype.saveMacrosXMLforBackup=function(a,c){require("fs-extra").writeFile("./backup_local/macros.xml",a,function(a){c&&c({error:a})})};x.hub.v5.Handler.prototype.saveIrcodesXMLforBackup=function(a,c){require("fs-extra").writeFile("./backup_local/ircodes.xml",a,function(a){c&&c({error:a})})};
x.hub.v5.Handler.prototype.backupLocal=function(a,c,b){if(this._usbPath){var d=require("fs-extra"),f=this;this._backup(a,"./backup_local",c,function(a,c,g){d.emptyDir("./backup_local");a?b&&b({error:a}):d.move(c,f._usbPath+"/"+g,{overwrite:!0},function(a){b&&b({error:a,data:g})})})}else b&&b({error:Error("please choose the usb storage")})};
x.hub.v5.Handler.prototype.listUsbBackups=function(a){this._usbPath?require("fs-extra").readdir(this._usbPath,function(c,b){if(c)a&&a({error:c});else{c=[];for(var d=0;d<b.length;d++){var f=b[d],e=f.indexOf(".xbp");if(-1!=e){var h={filename:b[d],time:null},g=f.substr(0,e);"backup_"==g.substr(0,7)&&(g=g.substr(7));f=g.substr(0,4);e=g.substr(4,2);var k=g.substr(6,2),l=g.substr(8,2),m=g.substr(10,2);g=g.substr(12,2);h.time=f+"-"+e+"-"+k+" "+l+":"+m+":"+g;c.push(h)}}a&&a({data:c})}}):a&&a({error:Error("please choose the usb storage")})};
x.hub.v5.Handler.prototype.deleteBackup=function(a,c){this._usbPath?require("fs-extra").remove(this._usbPath+"/"+a,function(a){c&&c({error:a})}):c&&c({error:Error("please mount the usb storage")})};
x.hub.v5.Handler.prototype.loadBackup=function(a,c,b){if(this._usbPath){var d=require("fs-extra"),f=this;d.ensureDirSync("./restore_local/");d.emptyDirSync("./restore_local/");d.copy(this._usbPath+"/"+a,"./"+a,function(d){d?b&&b({error:d}):f._extractBackupZip("./"+a,"./restore_local/",c,function(a){b&&b({error:a})})})}else b&&b({error:Error("please choose the usb storage")})};
x.hub.v5.Handler.prototype.loadDeviceXML=function(a){require("fs-extra").readFile("./restore_local/backup_local/devices.xml",{encoding:"utf8"},function(c,b){a&&a({error:c,data:b})})};x.hub.v5.Handler.prototype.loadMacroXML=function(a){require("fs-extra").readFile("./restore_local/backup_local/macros.xml",{encoding:"utf8"},function(c,b){a&&a({error:c,data:b})})};
x.hub.v5.Handler.prototype.loadIrcodesXML=function(a){require("fs-extra").readFile("./restore_local/backup_local/ircodes.xml",{encoding:"utf8"},function(c,b){a&&a({error:c,data:b})})};x.hub.v5.Handler.prototype.restoreLocal=function(a,c){this._restore(a,"./restore_local/","backup_local",function(a){c&&c({error:a})})};
x.hub.v5.Handler.prototype.testReadOnly=function(a){var c=require("fs-extra"),b="./read_only_test_"+(new Date).getTime();c.ensureFile(b,function(d){d?a&&a(d):c.remove(b,function(b){a&&a(b)})})};x.hub.v5.Handler.prototype.fixReadOnly=function(a,c){a.writeHead(200,{"Content-Type":"text/plain"});this.Native._exec("/etc/init.d/S99_checkfs manual",function(b){a.write(b)},function(b){b?a.write('{"XC_ERR":{"code":"01001", "message":"'+b.message+'"}}'):a.write('{"XC_SUC":{}}');a.end()})};
x.hub.v5.Handler.prototype._backup=function(a,c,b,d){var f=this;x.hub.v5.BackupSTData(a,c,function(a){if(a){var e=require("fs-extra");e.copySync("./data",c+"/data");e.existsSync(c+"/data/localstorage/x.hub.Server.pwd")&&e.removeSync(c+"/data/localstorage/x.hub.Server.pwd");e.existsSync("/srv/hm-root/opt/hm/etc/config")&&e.copySync("/srv/hm-root/opt/hm/etc/config",c+"/config");e.existsSync("/srv/z-way-server/config")&&e.copySync("/srv/z-way-server/config",c+"/zway/config");e.existsSync("/srv/z-way-server/automation/storage")&&
e.copySync("/srv/z-way-server/automation/storage",c+"/zway/automation/storage");e.existsSync("/srv/Apps/zigbee/SYSTEM/data")&&e.copySync("/srv/Apps/zigbee/SYSTEM/data",c+"/zigbee/data");a=require("archiver");var g=new Date,k=g.getFullYear()+"",l=g.getMonth()+1+"";1==l.length&&(l="0"+l);var m=g.getDate()+"";1==m.length&&(m="0"+m);var r=g.getHours()+"";1==r.length&&(r="0"+r);var q=g.getMinutes()+"";1==q.length&&(q="0"+q);g=g.getSeconds()+"";1==g.length&&(g="0"+g);var p="backup_"+(k+l+m+r+q+g)+".xbp",
n="/tmp/"+p;k=e.createWriteStream(n);a=a("zip");k.on("close",function(){if(b){var a=require("crypto").createCipher("aes-256-cbc",b),c=e.createReadStream(n),f=e.createWriteStream(n+".enc");f.on("finish",function(){e.removeSync(n);d&&d(null,n+".enc",p)});c.pipe(a).pipe(f)}else d&&d(null,n,p)});k.on("error",function(a){f._logger.log("warn","write backup zip file failed:"+a.message);d&&d(a);d=null});a.on("error",function(a){f._logger.log("warn","zip backup data failed:"+a.message);d&&d(a);d=null});a.pipe(k);
a.directory(c+"/","backup");a.finalize()}else f._logger.log("warn","backup st data failed"),d&&d(Error("backup st data failed")),d=null})};
x.hub.v5.Handler.prototype._extractBackupZip=function(a,c,b,d){var f=require("fs"),e=require("fs-extra"),h=require("adm-zip"),g=null;try{(new h(a)).extractAllTo(c,!0)}catch(l){g="invalid backup file/password"}if(g)if(b){b=require("crypto").createDecipher("aes-256-cbc",b);var k=f.createReadStream(a);f=f.createWriteStream(a+".dec.zip");b.on("error",function(){e.removeSync(a);e.removeSync(a+".dec.zip");d&&d(Error(g))});f.on("finish",function(){g=null;try{(new h(a+".dec.zip")).extractAllTo(c,!0)}catch(l){g=
"invalid backup file/password"}e.removeSync(a);e.removeSync(a+".dec.zip");d&&d(g?Error(g):null)});k.pipe(b).pipe(f)}else e.removeSync(a),d&&d(Error(g)),d=null;else e.removeSync(a),d&&d(),d=null};
x.hub.v5.Handler.prototype._restore=function(a,c,b,d){var f=require("fs"),e=require("fs-extra"),h=c+b;if(f.existsSync(h+"/zigbee/data"))try{e.ensureDirSync("/srv/Apps/zigbee/SYSTEM"),e.copySync(h+"/zigbee/data","/srv/Apps/zigbee/SYSTEM/data")}catch(g){}if(f.existsSync(h+"/zway/config")&&f.existsSync("/srv/z-way-server"))try{e.copySync(h+"/zway/config","/srv/z-way-server/config")}catch(g){}if(f.existsSync(h+"/zway/automation/storage")&&f.existsSync("/srv/z-way-server/automation"))try{e.copySync(h+
"/zway/automation/storage","/srv/z-way-server/automation/storage")}catch(g){}this._restoreHM(h,function(){x.hub.v5.RestoreSTData(a,h,function(a){a?e.copy(h+"/data","./data",function(a){e.removeSync(c);a&&d?d(Error("internal error")):d&&d()}):d&&d(Error("internal error"))})})};
x.hub.v5.Handler.prototype._restoreHM=function(a,c){function b(a){a=e.extname(a);return".ap"===a||".apkx"===a}var d=require("fs"),f=require("fs-extra"),e=require("path");d.existsSync(a+"/config")&&d.existsSync("/srv/hm-root/opt/hm/etc")?this.Native.resetHM(function(e){XC.debugf("reset HM:"+e);try{f.copySync(a+"/config","/srv/hm-root/opt/hm/etc/config");var g=[];d.readdirSync("/srv/hm-root/opt/hm/etc/config/crRFD/data").filter(b).forEach(function(a){g.push(a)});for(e=0;e<g.length;e++);}catch(k){console.error(k)}c&&
c()}):c&&c()};x.hub.v5.Handler.prototype.getSerialPorts=function(a){var c=null;try{c=require("serialport")}catch(b){c=null}c?this.Native.runMdev(function(b){console.log("run mdev finish",b);b?a(JSON.stringify({XC_ERR:{code:"00000",msg:"run mdev error:"+b.message}})):c.list(function(b,c){console.log("list serial port finish",b,JSON.stringify(c));void 0==c&&(c=[]);b=[];for(var d=0;d<c.length;d++)c[d]&&b.push(c[d].comName);a('{"XC_SUC":'+JSON.stringify(b)+"}")})}):a('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')};
x.hub.v5.Handler.prototype.getLogs=function(a){var c=require("fs-extra"),b=require("archiver"),d="logs_"+(new Date).toISOString().substr(0,16).replace(/T/g,"").replace(/-/g,"").replace(/:/g,"")+".zip",f="/tmp/"+d,e=c.createWriteStream(f);b=b("zip");e.on("close",function(){a.setHeader("Content-disposition","attachment; filename="+d);a.sendFile(f,null,function(b){c.removeSync(f);b&&a.status(500).end()})});e.on("error",function(b){a.status(500).end()});b.on("error",function(b){a.status(500).end()});
b.pipe(e);b.directory("/var/log");b.finalize()};
x.hub.v5.Handler.prototype.getNeoServerLogs=function(a){var c=require("path"),b=require("x.hub.fileman.js").fileManager,d=b.getUserRootDataPath(),f=c.dirname(b.getLogFile()),e=b.getTmpDir(),h=require("fs-extra");b=require("archiver");var g="logs_"+(new Date).toISOString().substr(0,16).replace(/T/g,"").replace(/-/g,"").replace(/:/g,"")+".zip",k=e+c.sep+g;c=h.createWriteStream(k);b=b("zip");c.on("close",function(){a.setHeader("Content-disposition","attachment; filename="+g);a.sendFile(k,null,function(b){h.removeSync(k);
b&&a.status(500).end()})});c.on("error",function(b){a.status(500).end()});b.on("error",function(b){a.status(500).end()});b.pipe(c);b.directory(d);b.directory(f);b.finalize()};x.hub.v5.Handler.prototype.clearLogs=function(a){require("fs-extra").emptyDir("/var/log",function(c){a&&a()})};
x.hub.v5.Handler.prototype.reset=function(a,c,b){var d=require("fs"),f=require("fs-extra");"passwords"==c?(d.existsSync("./data/localstorage/x.hub.Server.pwd")&&f.removeSync("./data/localstorage/x.hub.Server.pwd"),b&&b()):"factory"==c?(d.existsSync("./data")&&f.emptyDirSync("./data"),x.hub.v5.ResetSTData(a,function(){b&&b()})):b&&b()};
x.hub.v5.Handler.prototype.resetST=function(a){this._logger.log("info","reset st");this._logger.log("trace","set st led to permant white");var c=this;this.server.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0105",function(b){b&&b.XC_SUC?(c._logger.log("trace","reset st data"),x.hub.v5.ResetSTData(c.server,function(){c._logger.log("trace","reboot st");var b=new (require("xnm.aio.m10T.js").STMUpdater);b.hostType=c.server.hostType;b.resetST();c._logger.log("info","reset st finish");a&&a()})):(b=b&&b.XC_ERR?
Error(b.XC_ERR):Error("set led white failed"),c._logger.log("trace","set led white error:"+b.message),a&&a(b))})};
x.hub.v5.Handler.prototype.rebootST=function(a){this._logger.log("info","reboot st");this._logger.log("trace","set st led to permant white");var c=this;this.server.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0105",function(b){b&&b.XC_SUC?(c._logger.log("trace","now reboot st"),b=new (require("xnm.aio.m10T.js").STMUpdater),b.hostType=c.server.hostType,b.resetST(),c._logger.log("info","reboot st finish"),a&&a()):(b=b&&b.XC_ERR?Error(b.XC_ERR):Error("set led white failed"),c._logger.log("trace","set led white error:"+
b.message),a&&a(b))})};x.hub.v5.Handler.prototype.USBSerial=x.hub.v5.USBSerial;x.hub.v5.Handler.prototype.CloudConnect=x.hub.v5.CloudConnect;x.hub.v5.Handler.prototype.LocalSPIBus=x.hub.v5.LocalSPIBus;x.hub.v5.Handler.prototype.Native=new x.hub.v5.NativeWrapper;"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.v5.Handler);
