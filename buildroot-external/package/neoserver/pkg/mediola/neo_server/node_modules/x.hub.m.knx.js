var util=require("util"),EventEmitter=require("events"),crypto=require("crypto"),fs_extra=require("fs-extra"),fileman=require("x.hub.fileman.js"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.knx=x.hub.m.knx||{};require("x.logger.js").setLevel("info","xnm.aio.knx");require("x.logger.js").setLevel("info","x.hub.m.knx");
x.hub.m.knx.KNXIPGateway=function(){var e=function(a,b,c,d){this._gid=a;this._ip=b;this._port=c;this._port||(this.port=3671);this._mac=d;this._serial_number=this._physical_address=this._name=null};e.prototype.getID=function(){return this._gid};e.prototype.getIP=function(){return this._ip};e.prototype.getPort=function(){return this._port};e.prototype.getMAC=function(){return this._mac};e.prototype.toJSON=function(){return{gid:this._gid,ip:this._ip,port:this._port,mac:this._mac,name:this._name,physical_address:this._physical_address,
serial_number:this._serial_number}};e.prototype.fromJSON=function(a){this._gid=a.gid;this._ip=a.ip;this._port=a.port;this._port||(this.port=3671);this._mac=a.mac;this._name=a.name;this._physical_address=a.physical_address;this._serial_number=a.serial_number};e.prototype.updateJSON=function(a){a&&a.ip&&(this._ip=a.ip,this._port=a.port,this._port||(this.port=3671),this._mac=a.mac,this._name=a.name,this._physical_address=a.physical_address,this._serial_number=a.serial_number)};e.fromJSON=function(a){if(!a||
!a.gid||!a.ip)return null;var b=new e;b.fromJSON(a);return b};return e}();
x.hub.m.knx.KNXIPDevice=function(){var e=function(a,b,c,d){this._did=a;this._type=b;this._gid=c;this._name=null;this._channels=d};e.prototype.getID=function(){return this._did};e.prototype.getGID=function(){return this._gid};e.prototype.getChannels=function(){return this._channels};e.prototype.toJSON=function(){var a={};a.did=this._did;a.data=this._type;a.gid=this._gid;a.name=this._name;a.channels=this._channels;return a};e.prototype.fromJSON=function(a){this._did=a.did;this._type=a.data;this._name=
a.name;this._gid=a.gid;this._channels=a.channels};e.prototype.updateJSON=function(a){a&&a.data&&(this._type=a.data,this._name=a.name,this._gid=a.gid,this._channels=a.channels)};e.fromJSON=function(a){if(!(a&&a.data&&a.did&&a.gid))return null;var b=new e;b.fromJSON(a);return b};return e}();
x.hub.m.knx.DeviceHandler=function(){var e=function(a){this._logger=require("x.logger.js").getLogger("x.hub.m.knx.DeviceHandler");this._controller=a;this._gateways=[];this._devices=[]};e.prototype.IP_GATEWAY_FILE="knx_gateway.json";e.prototype.DEVICE_FILE="knx_device.json";e.prototype.init=function(a){this._logger.log("trace","init");var b=this,c=2;this._loadGateways(function(d,f){c--;d&&b._logger.log("warn","load knx ip gateways error:"+d.message);f&&(b._gateways=f);0==c&&a&&a()});this._loadDevices(function(d,
f){c--;d&&b._logger.log("warn","load knx devices error:"+d.message);f&&(b._devices=f);0==c&&a&&a()})};e.prototype.getIPGatewayObjs=function(){return this._gateways};e.prototype.getIPGatewayObj=function(a){for(var b=0;b<this._gateways.length;b++){var c=this._gateways[b];if(a==c.getID())return c}return null};e.prototype.getIPGateways=function(a){var b=[];this._gateways.forEach(function(a){a&&(a=a.toJSON())&&b.push(a)});a&&a(null,b)};e.prototype.addIPGateway=function(a,b){var c;if(a&&a.ip){c=[];for(var d=
0;d<this._gateways.length;d++){var f=this._gateways[d];if(f){var g=f.getID(),e=f.getIP(),l=f.getMAC();c.push(g);if(e==a.ip){c=Error("find knx ip gateway with same ip");c.code="09002";b&&b(null,f.toJSON());return}if(l&&a.mac&&l==a.mac){c=Error("find knx ip gateway with mac address");c.code="09003";b&&b(c);return}}}for(f=1;-1!=c.indexOf(f);)f++;a.gid=f;var k=x.hub.m.knx.KNXIPGateway.fromJSON(a);if(k){this._gateways.push(k);var m=this;this._saveGateways(this._gateways,function(a){a?(a.code="09006",b&&
b(a)):m._controller._monitorManager.startMonitor(k,function(){b&&b(null,k.toJSON())})})}else c=Error("json format invalid"),c.code="09001",b&&b(c)}else c=Error("json format invalid"),c.code="09001",b&&b(c)};e.prototype.updateIPGateway=function(a,b){var c,d=x.hub.m.knx.KNXIPGateway.fromJSON(a);if(d){var f=null;this._gateways.forEach(function(b){b&&b.getID()==d.getID()&&(f=b)});if(f){var g=f.getIP(),e=f.getPort();f.updateJSON(a)}else this._gateways.push(d);var l=this;this._saveGateways(this._gateways,
function(c){c?(c.code="09006",b&&b(c)):g!=a.ip||e!=a.port?l._controller._monitorManager.stopMonitor(f,function(){l._controller._monitorManager.startMonitor(f,function(){b&&b(null,f.toJSON())})}):b&&b(null,f.toJSON())})}else c=Error("json format invalid"),c.code="09001",b&&b(c)};e.prototype.deleteIPGateway=function(a,b){var c;if(a&&a.gid){c=-1;for(var d=null,f=0;f<this._gateways.length;f++){var g=this._gateways[f];if(g&&g.getID()==a.gid){c=f;d=g;break}}if(-1==c)b&&b();else{this._gateways.splice(c,
1);var e=this;this._saveGateways(this._gateways,function(a){a?(a.code="09006",b&&b(a)):e._controller._monitorManager.stopMonitor(d,function(){b&&b()})})}}else c=Error("json format invalid"),c.code="09001",b&&b(c)};e.prototype.deleteAllIPGateway=function(a){this._gateways=[];var b=this;this._saveGateways(this._gateways,function(c){c?(c.code="09006",a&&a(c)):b._controller._monitorManager.stopAllMonitors(function(){a&&a()})})};e.prototype.getAllDevices=function(){return this._devices};e.prototype.getDevices=
function(a){var b=[];this._devices.forEach(function(a){a&&(a=a.toJSON())&&b.push(a)});a&&a(null,b)};e.prototype.addDevice=function(a,b){var c;if(a)if(a.gid)if(this.getIPGatewayObj(a.gid)){var d=[];this._devices.forEach(function(b){b&&(b=b.getID(),d.push(b))});for(c=1;-1!=d.indexOf(c);)c++;a.did=c;var f=x.hub.m.knx.KNXIPDevice.fromJSON(a);f?(this._devices.push(f),this._saveDevices(this._devices,function(a){a&&(a.code="09007");b&&b(a,f.toJSON())})):(c=Error("json format invalid"),c.code="09001",b&&
b(c))}else c=Error("no such knx ip gateway with id:"+a.gid),c.code="09004",b&&b(c);else c=Error("no such knx ip gateway with id:"+a.gid),c.code="09004",b&&b(c);else c=Error("json format invalid"),c.code="09001",b&&b(c)};e.prototype.updateDevice=function(a,b){var c,d=x.hub.m.knx.KNXIPDevice.fromJSON(a);if(d)if(a.gid)if(this.getIPGatewayObj(a.gid)){var f=null;this._devices.forEach(function(b){b&&b.getID()==d.getID()&&(f=b)});f?f.updateJSON(a):this._devices.push(d);this._saveDevices(this._devices,function(a){a&&
(a.code="09007");b&&b(a,f.toJSON())})}else c=Error("no such knx ip gateway with id:"+a.gid),c.code="09004",b&&b(c);else c=Error("no such knx ip gateway with id:"+a.gid),c.code="09004",b&&b(c);else c=Error("json format invalid"),c.code="09001",b&&b(c)};e.prototype.deleteDevice=function(a,b){var c;if(a&&a.did){c=-1;for(var d=null,f=0;f<this._devices.length;f++)if((d=this._devices[f])&&d.getID()==a.did){c=f;break}-1==c?b&&b():(this._devices.splice(c,1),this._saveDevices(this._devices,function(a){a&&
(a.code="09007");b&&b(a)}))}else c=Error("json format invalid"),c.code="09001",b&&b(c)};e.prototype.deleteAllDevice=function(a){this._devices=[];this._saveDevices(this._devices,function(b){b&&(b.code="09007");a&&a(b)})};e.prototype.getDeviceObj=function(a){if(!this._devices)return null;for(var b=0;b<this._devices.length;b++){var c=this._devices[b];if(c&&c.getID()==a)return c}return null};e.prototype._getGatewayFile=function(){var a=fileman.fileManager,b=require("path"),a=a.getUserRootDataPath();return b.resolve(a,
this.IP_GATEWAY_FILE)};e.prototype._getDeviceFile=function(){var a=fileman.fileManager,b=require("path"),a=a.getUserRootDataPath();return b.resolve(a,this.DEVICE_FILE)};e.prototype._loadGateways=function(a){var b=require("fs-extra"),c=this._getGatewayFile();b.ensureFile(c,function(d){d?a&&a(d):b.readFile(c,"utf8",function(b,c){if(b)a&&a(b);else if(c)try{var d=[];JSON.parse(c).forEach(function(b){(b=x.hub.m.knx.KNXIPGateway.fromJSON(b))&&d.push(b)});a&&a(null,d)}catch(e){a&&a(e)}else a&&a(null,[])})})};
e.prototype._saveGateways=function(a,b){var c=this._getGatewayFile(),d=[];a&&a.forEach(function(b){(b=b.toJSON())&&d.push(b)});fs_extra.writeFile(c,JSON.stringify(d,null,2),function(a){b&&b(a)})};e.prototype._loadDevices=function(a){var b=require("fs-extra"),c=this._getDeviceFile();b.ensureFile(c,function(d){d?a&&a(d):b.readFile(c,"utf8",function(b,c){if(b)a&&a(b);else if(c)try{var d=[];JSON.parse(c).forEach(function(b){(b=x.hub.m.knx.KNXIPDevice.fromJSON(b))&&d.push(b)});a&&a(null,d)}catch(e){a&&
a(e)}else a&&a(null,[])})})};e.prototype._saveDevices=function(a,b){var c=this._getDeviceFile(),d=[];a&&a.forEach(function(b){(b=b.toJSON())&&d.push(b)});fs_extra.writeFile(c,JSON.stringify(d,null,2),function(a){b&&b(a)})};return e}();
x.hub.m.knx.Monitor=function(){var e=function(a,b){this._logger=require("x.logger.js").getLogger("x.hub.m.knx.Monitor");this._ip=a;this._port=b;this._manager=null;this._gateways=[];this._knx=null;this._monitorState=0;this._monitorError=this._reconnTO=null;this._forceStopped=!1};e.prototype.getIP=function(){return this._ip};e.prototype.getPort=function(){return this._port};e.prototype.getKNXSession=function(){return this._knx};e.prototype.setManager=function(a){this._manager=a};e.prototype.addGateway=
function(a){if(a){for(var b=a.getID(),c=!1,d=0;d<this._gateways.length;d++){var f=this._gateways[d];if(f&&f.getID()==b){c=!0;break}}c||this._gateways.push(a)}};e.prototype.hasGateway=function(a){if(!a)return!1;a=a.getID();for(var b=!1,c=0;c<this._gateways.length;c++){var d=this._gateways[c];if(d&&d.getID()==a){b=!0;break}}return b};e.prototype.getGateways=function(){return this._gateways};e.prototype.getGatewayWithMac=function(a){if(!a)return null;for(var b=0;b<this._gateways.length;b++){var c=this._gateways[b];
if(c&&c.getMAC()==a)return c}return null};e.prototype.start=function(a){this._forceStopped=!1;if(0!=this._monitorState&&4!=this._monitorState)a&&a(Error("monitor already started"));else{this._logger.log("debug","start monitor: "+this._ip+":"+this._port);var b=this;this._knx=new (require("xnm.aio.knx.js").KNXGateway)(this._ip,null,null);this._knx.on("message",function(a,d,f){var e=f.getData();b._logger.log("debug","receive monitor message:"+e.toString("hex")+"@"+d);var h=require("x.hub.m.knx.js");
b._gateways.forEach(function(b){if(b&&b.getID())h.onMonitorMessage(b.getID(),d,e)})});this._knx.on("error",function(a){b._monitorError=a;b._logger.log("warn","monitor error:"+a.message+" + code:"+(a.code?a.code:""))});this._knx.on("close",function(){b._logger.log("warn","monitor closed");b._restart()});this._monitorState=1;this._knx.startMonitor(function(){b._monitorState=2;a&&a()})}};e.prototype.stop=function(a){this._forceStopped=!0;if(0==this._monitorState||3==this._monitorState)a&&a();else if(this._monitorState=
3,this._logger.log("debug","stop monitor: "+this._ip+":"+this._port),this._knx){var b=this;this._knx.stopMonitor(function(){b._monitorState=0;b._knx.removeAllListeners();b._knx=null;a&&a()})}else a&&a()};e.prototype.stopForGateway=function(a,b){this._logger.log("debug","stop monitor for gateway: "+a.getID());for(var c=-1,d=0;d<this._gateways.length;d++){var f=this._gateways[d];f&&f.getID()==a.getID()&&(c=d)}-1!=c&&this._gateways.splice(c,1);0==this._gateways.length?this.stop(function(){b&&b(null,
!0)}):b&&b(null,!1)};e.prototype.getState=function(){return{state:this._monitorState,error:this._monitorError}};e.prototype._restart=function(){if(0==this._gateways.length)this._monitorState=0;else if(4!=this._monitorState&&!this._forceStopped){this._logger.log("debug","try to restart monitor after 30sec");var a=this;this._monitorState=4;this._reconnTO=setTimeout(function(){a.start()},3E4)}};return e}();
x.hub.m.knx.MonitorManager=function(){var e=function(a){this._logger=require("x.logger.js").getLogger("x.hub.m.knx.MonitorManager");this._controller=a;this._monitors={}};e.prototype.init=function(a){var b=this;if(this._controller&&this._controller._deviceHandler){var c=this._controller._deviceHandler.getIPGatewayObjs(),d=0,f=function(){d++;d<c.length&&b.startMonitor(c[d],f)};this.startMonitor(c[d],f)}a&&a()};e.prototype.startMonitor=function(a,b){if(a){var c=a.getIP(),d=a.getPort();this._startMonitor(c,
d,a,b)}else b&&b(Error("gateway is null"))};e.prototype._startMonitor=function(a,b,c,d){if(c){this._logger.log("info","start connect monitor to gateway "+c.getID()+" ("+a+":"+b+")");var f=b+"@"+a,e=this._monitors[f];e?(e.addGateway(c),d&&d()):(e=new x.hub.m.knx.Monitor(a,b),e.addGateway(c),e.setManager(this),this._monitors[f]=e,e.start(d))}else d&&d(Error("gateway is null"))};e.prototype.stopMonitor=function(a,b){var c=null,d=null,f;for(f in this._monitors){var e=this._monitors[f];if(e&&e.hasGateway(a)){c=
e;d=f;break}}if(c){var h=this;c.stopForGateway(a,function(a,c){c&&(h._logger.log("debug","monitor "+d+" stopped"),delete h._monitors[d]);b&&b(a)})}else b&&b()};e.prototype.stopAllMonitors=function(a){var b=Object.keys(this._monitors);if(0==b.length)a&&a();else{var c=0,d=this._monitors;this._monitors={};var f=function(){c++;c>=b.length?a&&a():d[b[c]].stop(f)};d[b[c]].stop(f)}};e.prototype.onFindKNX=function(a){if(a){var b=a.getIP(),c=a.getPort();a=a.getMAC();var d=c+"@"+b,f=null,e=null,h;for(h in this._monitors){var l=
this._monitors[h].getGatewayWithMac(a);if(l){f=l;e=h;break}}if(f&&e!=d){var k=this;this.stopMonitor(f,function(){k._startMonitor(b,c,f)})}}};e.prototype.listMonitors=function(a){var b=[],c;for(c in this._monitors)this._monitors.hasOwnProperty(c)&&b.push(this._monitors[c]);a&&a(null,b)};e.prototype.getMonitorForGateway=function(a){for(var b in this._monitors)if(this._monitors.hasOwnProperty(b)){var c=this._monitors[b];if(c&&c.hasGateway(a))return c}return null};return e}();
x.hub.m.knx.SearchHandler=function(){var e=require("xnm.aio.knx.js").Finder,a=function(b){this._logger=require("x.logger.js").getLogger("x.hub.m.knx.SearchHandler");this._controller=b;var a=this;this._searchListener=function(b,f){a._onFindKNX(b,f)};this._searching=!1;this._searchCB=[];this._searchResult=[];this._nextSearchTO=this._searchTO=null};a.SEARCH_INTERVAL=3E5;a.prototype.init=function(b){e.on("found",this._searchListener);this._search();b&&b()};a.prototype._onFindKNX=function(b,a){var d=b.toJSON();
this._logger.log("info","find knx ip gateway:"+JSON.stringify(d));if(d.hapi&&d.hapi.ip&&d.mac){var f={ip:d.hapi.ip,port:d.hapi.port,mac:d.mac,name:d.name.replace(/\0/g,""),physical_address:d.physical_address,serial_number:d.serial_number},d=new x.hub.m.knx.KNXIPGateway;d.fromJSON(f);for(var f=!1,e=0;e<this._searchResult.length;e++){var h=this._searchResult[e];h&&h.getIP()==d.getIP()&&h.getPort()==d.getPort()&&(f=!0)}f||this._searchResult.push(d);if(this._controller&&this._controller._monitorManager)this._controller._monitorManager.onFindKNX(d,
a)}};a.prototype.search=function(b){b&&-1==this._searchCB.indexOf(b)&&this._searchCB.push(b);this._searching||this._search()};a.prototype._search=function(){this._logger.log("debug","start search knx ip gateway");this._searching=!0;this._nextSearchTO&&(this._logger.log("trace","clear next automatic search"),clearTimeout(this._nextSearchTO),this._nextSearchTO=null);var b=this;e.startSearchKNX();this._searchTO=setTimeout(function(){b._logger.log("trace","finish searching knx ip gateway");e.stopSearchKNX();
b._searching=!1;b._searchTO=null;var c=b._searchCB;b._searchCB=[];var d=b._searchResult;b._searchResult=[];b._nextSearchTO=setTimeout(function(){b._nextSearchTO=null;b._logger.log("trace","start next automatic search");b._search()},a.SEARCH_INTERVAL);c.forEach(function(b){b&&b(null,d)})},3E3)};return a}();
x.hub.m.knx.Handler=function(){var e={sendSTAEvent:function(b){var a=require("x.hub.eventbus.js");a.emit("gatewayevent",b,{address:"KNX"},"STA");a.emit("udpevent",b,"STA")}},a=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.knx.Handler");this._deviceHandler=new this.DeviceHandler(this);this._monitorManager=new this.MonitorManager(this);this._searchHandler=new this.SearchHandler(this)};a.prototype.DeviceHandler=x.hub.m.knx.DeviceHandler;a.prototype.MonitorManager=x.hub.m.knx.MonitorManager;
a.prototype.SearchHandler=x.hub.m.knx.SearchHandler;a.prototype.init=function(b){var a=this;this._deviceHandler.init(function(){a._monitorManager.init(function(){a._searchHandler.init(function(){b&&b({})})})})};a.prototype.getSystems=function(){return["knx"]};a.prototype.addStateDevice=function(b,a){a&&a({})};a.prototype.getAllStates=function(){var b=null,a=this;this._deviceHandler.getAllDevices().forEach(function(d){var e=a.getStates(d);e&&(b||(b={}),b[d.getID()]=e)});return b};a.prototype.getStates=
function(b){return b&&b.getID()?this._getStates(b.getID()):null};a.prototype._getStates=function(b){b=this._deviceHandler.getDeviceObj(b);if(!b)return null;var a=b.getGID();if(!a)return null;a=this._deviceHandler.getIPGatewayObj(a);if(!a)return null;a=this._monitorManager.getMonitorForGateway(a);if(!a)return null;a=a.getKNXSession();return a?(b=require("xnm.aio.knx.js").KNXGateway._Device.resolve(b.toJSON()))?b.getStates(a):null:null};a.prototype.executeCommand=function(a,c,d){d&&d({error:Error("not implemented yet")})};
a.prototype._executeCommand=function(a,c,d){var e=this._deviceHandler.getDeviceObj(a);if(e){var g=e.getGID();if(g)if(a=this._deviceHandler.getIPGatewayObj(g))if(a=this._monitorManager.getMonitorForGateway(a)){var h=a.getState().state;2!=h?d&&d(Error("monitor for gateway "+g+" is in state:"+h)):(a=a.getKNXSession())?(e=require("xnm.aio.knx.js").KNXGateway._Device.resolve(e.toJSON()))?e.executeCommand(c,a,function(a){d&&d(a)}):d&&d(Error("device format invalid")):d&&d(Error("knx session for gateway "+
g+" is null"))}else d&&d(Error("no monitor for gateway with id:"+g));else d&&d(Error("no such gateway with id:"+g));else d&&d(Error("device "+a+" has no gid"))}else d&&d(Error("no such device with id:"+a))};a.prototype.executeCommandLegacy=function(a,c,d){a?c?this._executeCommand(a,c,function(a){d&&d({error:a})}):d&&d({error:Error("command invalid")}):d&&d({error:Error("address invalid")})};a.prototype.getAllStatesLegacy=function(a,c){var d=[];try{var e=this.getAllStates(),g;for(g in e)e.hasOwnProperty(g)&&
d.push({type:"KNX",adr:g,state:e[g]});a&&a({data:d})}catch(h){a&&a({error:h})}};a.prototype.getIPGateways=function(a){this._deviceHandler.getIPGateways(function(c,d){a&&a({error:c,data:d})})};a.prototype.addIPGateway=function(a,c){this._deviceHandler.addIPGateway(a,function(a,b){c&&c({error:a,data:b})})};a.prototype.updateIPGateway=function(a,c){this._deviceHandler.updateIPGateway(a,function(a,b){c&&c({error:a,data:b})})};a.prototype.deleteIPGateway=function(a,c){this._deviceHandler.deleteIPGateway(a,
function(a){c&&c({error:a})})};a.prototype.getDevices=function(a){this._deviceHandler.getDevices(function(c,d){a&&a({error:c,data:d})})};a.prototype.addDevice=function(a,c){this._deviceHandler.addDevice(a,function(a,b){c&&c({error:a,data:b})})};a.prototype.updateDevice=function(a,c){this._deviceHandler.updateDevice(a,function(a,b){c&&c({error:a,data:b})})};a.prototype.deleteDevice=function(a,c){this._deviceHandler.deleteDevice(a,function(a){c&&c({error:a})})};a.prototype.clean=function(a){this._monitorManager.stopAllMonitors(a)};
a.prototype.listMonitors=function(a){this._monitorManager.listMonitors(function(c,d){if(c)a&&a({error:c});else{var e=[];d.forEach(function(a){if(a){var b=a.getGateways();b&&b.forEach(function(b){if(b){var c=a.getState();b={gateway:b.getID(),monitor:{ip:a.getIP(),port:a.getPort()},state:c.state,error:c.error?c.error.message:null};e.push(b)}})}});a&&a({data:e})}})};a.prototype.reset=function(a){var c=this;this._deviceHandler.deleteAllDevice(function(){c._deviceHandler.deleteAllIPGateway(function(){a&&
a({})})})};a.prototype.searchKNXGateway=function(a){this._searchHandler.search(function(c,d){if(c)a&&a({error:c});else{var e=[];d&&d.forEach(function(a){a&&(a=a.toJSON())&&e.push(a)});a&&a({data:e})}})};a.prototype.onMonitorMessage=function(a,c,d){var f=this._deviceHandler.getAllDevices(),g=require("xnm.aio.knx.js").KNXGateway;require("x.hub.eventbus.js");var h=this;f.forEach(function(f){if(f&&f.getGID()==a){var k=f.getChannels();if(k){var m=!1,p;for(p in k)if(k.hasOwnProperty(p)){var n=k[p];if(n&&
n.event&&n.event.ga&&g._adr2long(n.event.ga)==c){m=!0;break}}m&&(k=h.getStates(f),h._logger.log("info","receive event ("+d.toString("hex")+"@"+c+") for device "+f.getID()+":"+JSON.stringify(k)),f={type:"KNX",adr:f.getID(),state:k},e.sendSTAEvent(f))}}})};return a}();module.exports=new x.hub.m.knx.Handler;
