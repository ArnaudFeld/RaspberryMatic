var util=require("util"),EventEmitter=require("events"),crypto=require("crypto"),fs_extra=require("fs-extra"),fileman=require("x.hub.fileman.js"),x=x||{};x.hub=x.hub||{},x.hub.m=x.hub.m||{},x.hub.m.knx=x.hub.m.knx||{},x.hub.m.knx.KNXIPGateway=function(){var t=function t(_t,e,r,i){this._gid=_t,this._ip=e,this._port=r,this._port||(this.port=3671),this._mac=i,this._name=null,this._physical_address=null,this._serial_number=null;};return t.prototype.getID=function(){return this._gid;},t.prototype.getIP=function(){return this._ip;},t.prototype.getPort=function(){return this._port;},t.prototype.getMAC=function(){return this._mac;},t.prototype.toJSON=function(){return{gid:this._gid,ip:this._ip,port:this._port,mac:this._mac,name:this._name,physical_address:this._physical_address,serial_number:this._serial_number};},t.prototype.fromJSON=function(t){this._gid=t.gid,this._ip=t.ip,this._port=t.port,this._port||(this.port=3671),this._mac=t.mac,this._name=t.name,this._physical_address=t.physical_address,this._serial_number=t.serial_number;},t.prototype.updateJSON=function(t){t&&t.ip&&(this._ip=t.ip,this._port=t.port,this._port||(this.port=3671),this._mac=t.mac,this._name=t.name,this._physical_address=t.physical_address,this._serial_number=t.serial_number);},t.fromJSON=function(e){if(!e||!e.gid||!e.ip)return null;var r=new t();return r.fromJSON(e),r;},t;}(),x.hub.m.knx.KNXIPDevice=function(){var t=function t(_t2,e,r,i){this._did=_t2,this._type=e,this._gid=r,this._name=null,this._channels=i;};return t.prototype.getID=function(){return this._did;},t.prototype.getGID=function(){return this._gid;},t.prototype.getChannels=function(){return this._channels;},t.prototype.toJSON=function(){var t={};return t.did=this._did,t.data=this._type,t.gid=this._gid,t.name=this._name,t.channels=this._channels,t;},t.prototype.fromJSON=function(t){this._did=t.did,this._type=t.data,this._name=t.name,this._gid=t.gid,this._channels=t.channels;},t.prototype.updateJSON=function(t){t&&t.data&&(this._type=t.data,this._name=t.name,this._gid=t.gid,this._channels=t.channels);},t.fromJSON=function(e){if(!(e&&e.data&&e.did&&e.gid))return null;var r=new t();return r.fromJSON(e),r;},t;}(),x.hub.m.knx.DeviceHandler=function(){var t=function t(_t3){this._logger=require("x.logger.js").getLogger("x.hub.m.knx.DeviceHandler"),this._controller=_t3,this._gateways=[],this._devices=[];};return t.prototype.IP_GATEWAY_FILE="knx_gateway.json",t.prototype.DEVICE_FILE="knx_device.json",t.prototype.init=function(t){this._logger.log("trace","init");var e=this,r=2;this._loadGateways(function(i,o){r--,i&&e._logger.log("warn","load knx ip gateways error:"+i.message),o&&(e._gateways=o),0==r&&t&&t();}),this._loadDevices(function(i,o){r--,i&&e._logger.log("warn","load knx devices error:"+i.message),o&&(e._devices=o),0==r&&t&&t();});},t.prototype.getIPGatewayObjs=function(){return this._gateways;},t.prototype.getIPGatewayObj=function(t){for(var e=0;e<this._gateways.length;e++){var r=this._gateways[e];if(t==r.getID())return r;}return null;},t.prototype.getIPGateways=function(t){var e=[];this._gateways.forEach(function(t){if(t){var r=t.toJSON();r&&e.push(r);}}),t&&t(null,e);},t.prototype.addIPGateway=function(t,e){var r;if(!t||!t.ip)return(r=new Error("json format invalid")).code="09001",void(e&&e(r));for(var i=[],o=0;o<this._gateways.length;o++){var n=this._gateways[o];if(n){var a=n.getID(),s=n.getIP(),h=n.getMAC();if(i.push(a),s==t.ip)return(r=new Error("find knx ip gateway with same ip")).code="09002",void(e&&e(null,n.toJSON()));if(h&&t.mac&&h==t.mac)return(r=new Error("find knx ip gateway with mac address")).code="09003",void(e&&e(r));}}for(var c=1;-1!=i.indexOf(c);)c++;t.gid=c;var u=x.hub.m.knx.KNXIPGateway.fromJSON(t);if(!u)return(r=new Error("json format invalid")).code="09001",void(e&&e(r));this._gateways.push(u);var l=this;this._saveGateways(this._gateways,function(t){if(t)return t.code="09006",void(e&&e(t));l._controller._monitorManager.startMonitor(u,function(){e&&e(null,u.toJSON());});});},t.prototype.updateIPGateway=function(t,e){var r,i=x.hub.m.knx.KNXIPGateway.fromJSON(t);if(!i)return(r=new Error("json format invalid")).code="09001",void(e&&e(r));var o=null;if(this._gateways.forEach(function(t){t&&t.getID()==i.getID()&&(o=t);}),o){var n=o.getIP(),a=o.getPort();o.updateJSON(t);}else this._gateways.push(i);var s=this;this._saveGateways(this._gateways,function(r){if(r)return r.code="09006",void(e&&e(r));n!=t.ip||a!=t.port?s._controller._monitorManager.stopMonitor(o,function(){s._controller._monitorManager.startMonitor(o,function(){e&&e(null,o.toJSON());});}):e&&e(null,o.toJSON());});},t.prototype.deleteIPGateway=function(t,e){var r;if(!t||!t.gid)return(r=new Error("json format invalid")).code="09001",void(e&&e(r));for(var i=-1,o=null,n=0;n<this._gateways.length;n++){var a=this._gateways[n];if(a&&a.getID()==t.gid){i=n,o=a;break;}}if(-1!=i){this._gateways.splice(i,1);var s=this;this._saveGateways(this._gateways,function(t){if(t)return t.code="09006",void(e&&e(t));s._controller._monitorManager.stopMonitor(o,function(){e&&e();});});}else e&&e();},t.prototype.deleteAllIPGateway=function(t){this._gateways=[];var e=this;this._saveGateways(this._gateways,function(r){if(r)return r.code="09006",void(t&&t(r));e._controller._monitorManager.stopAllMonitors(function(){t&&t();});});},t.prototype.getAllDevices=function(){return this._devices;},t.prototype.getDevices=function(t){var e=[];this._devices.forEach(function(t){if(t){var r=t.toJSON();r&&e.push(r);}}),t&&t(null,e);},t.prototype.addDevice=function(t,e){var r;if(!t)return(r=new Error("json format invalid")).code="09001",void(e&&e(r));if(!t.gid)return(r=new Error("no such knx ip gateway with id:"+t.gid)).code="09004",void(e&&e(r));if(!this.getIPGatewayObj(t.gid))return(r=new Error("no such knx ip gateway with id:"+t.gid)).code="09004",void(e&&e(r));var i=[];this._devices.forEach(function(t){if(t){var e=t.getID();i.push(e);}});for(var o=1;-1!=i.indexOf(o);)o++;t.did=o;var n=x.hub.m.knx.KNXIPDevice.fromJSON(t);if(!n)return(r=new Error("json format invalid")).code="09001",void(e&&e(r));this._devices.push(n),this._saveDevices(this._devices,function(t){t&&(t.code="09007"),e&&e(t,n.toJSON());});},t.prototype.updateDevice=function(t,e){var r,i=x.hub.m.knx.KNXIPDevice.fromJSON(t);if(!i)return(r=new Error("json format invalid")).code="09001",void(e&&e(r));if(!t.gid)return(r=new Error("no such knx ip gateway with id:"+t.gid)).code="09004",void(e&&e(r));if(!this.getIPGatewayObj(t.gid))return(r=new Error("no such knx ip gateway with id:"+t.gid)).code="09004",void(e&&e(r));var o=null;this._devices.forEach(function(t){t&&t.getID()==i.getID()&&(o=t);}),o?o.updateJSON(t):this._devices.push(i),this._saveDevices(this._devices,function(t){t&&(t.code="09007"),e&&e(t,o.toJSON());});},t.prototype.deleteDevice=function(t,e){var r;if(!t||!t.did)return(r=new Error("json format invalid")).code="09001",void(e&&e(r));for(var i=-1,o=null,n=0;n<this._devices.length;n++)if((o=this._devices[n])&&o.getID()==t.did){i=n;break;}-1!=i?(this._devices.splice(i,1),this._saveDevices(this._devices,function(t){t&&(t.code="09007"),e&&e(t);})):e&&e();},t.prototype.deleteAllDevice=function(t){this._devices=[],this._saveDevices(this._devices,function(e){e&&(e.code="09007"),t&&t(e);});},t.prototype.getDeviceObj=function(t){if(!this._devices)return null;for(var e=0;e<this._devices.length;e++){var r=this._devices[e];if(r&&r.getID()==t)return r;}return null;},t.prototype._getGatewayFile=function(){var t=fileman.fileManager,e=require("path"),r=t.getUserRootDataPath();return e.resolve(r,this.IP_GATEWAY_FILE);},t.prototype._getDeviceFile=function(){var t=fileman.fileManager,e=require("path"),r=t.getUserRootDataPath();return e.resolve(r,this.DEVICE_FILE);},t.prototype._loadGateways=function(t){var e=require("fs-extra"),r=this._getGatewayFile();e.ensureFile(r,function(i){i?t&&t(i):e.readFile(r,"utf8",function(e,r){if(e)t&&t(e);else if(r)try{var i=[];JSON.parse(r).forEach(function(t){var e=x.hub.m.knx.KNXIPGateway.fromJSON(t);e&&i.push(e);}),t&&t(null,i);}catch(e){t&&t(e);}else t&&t(null,[]);});});},t.prototype._saveGateways=function(t,e){var r=this._getGatewayFile(),i=[];t&&t.forEach(function(t){var e=t.toJSON();e&&i.push(e);}),fs_extra.writeFile(r,JSON.stringify(i,null,2),function(t){e&&e(t);});},t.prototype._loadDevices=function(t){var e=require("fs-extra"),r=this._getDeviceFile();e.ensureFile(r,function(i){i?t&&t(i):e.readFile(r,"utf8",function(e,r){if(e)t&&t(e);else if(r)try{var i=[];JSON.parse(r).forEach(function(t){var e=x.hub.m.knx.KNXIPDevice.fromJSON(t);e&&i.push(e);}),t&&t(null,i);}catch(e){t&&t(e);}else t&&t(null,[]);});});},t.prototype._saveDevices=function(t,e){var r=this._getDeviceFile(),i=[];t&&t.forEach(function(t){var e=t.toJSON();e&&i.push(e);}),fs_extra.writeFile(r,JSON.stringify(i,null,2),function(t){e&&e(t);});},t;}(),x.hub.m.knx.Monitor=function(){var t=function t(_t4,e){this._logger=require("x.logger.js").getLogger("x.hub.m.knx.Monitor"),this._ip=_t4,this._port=e,this._manager=null,this._gateways=[],this._knx=null,this._monitorState=0,this._reconnTO=null,this._monitorError=null,this._forceStopped=!1;};return t.prototype.getIP=function(){return this._ip;},t.prototype.getPort=function(){return this._port;},t.prototype.getKNXSession=function(){return this._knx;},t.prototype.setManager=function(t){this._manager=t;},t.prototype.addGateway=function(t){if(t){for(var e=t.getID(),r=!1,i=0;i<this._gateways.length;i++){var o=this._gateways[i];if(o&&o.getID()==e){r=!0;break;}}r||this._gateways.push(t);}},t.prototype.hasGateway=function(t){if(!t)return!1;for(var e=t.getID(),r=!1,i=0;i<this._gateways.length;i++){var o=this._gateways[i];if(o&&o.getID()==e){r=!0;break;}}return r;},t.prototype.getGateways=function(){return this._gateways;},t.prototype.getGatewayWithMac=function(t){if(!t)return null;for(var e=0;e<this._gateways.length;e++){var r=this._gateways[e];if(r&&r.getMAC()==t)return r;}return null;},t.prototype.start=function(t){if(this._forceStopped=!1,0==this._monitorState||4==this._monitorState){this._logger.log("debug","start monitor: "+this._ip+":"+this._port);var e=this,r=require("xnm.aio.knx.js").KNXGateway;this._knx=new r(this._ip,null,null),this._knx.on("message",function(t,r,i){var o=i.getData();e._logger.log("debug","receive monitor message:"+o.toString("hex")+"@"+r);var n=require("x.hub.m.knx.js");e._gateways.forEach(function(t){t&&t.getID()&&n.onMonitorMessage(t.getID(),r,o);});}),this._knx.on("error",function(t){e._monitorError=t,e._logger.log("warn","monitor error:"+t.message+" + code:"+(t.code?t.code:""));}),this._knx.on("close",function(){e._logger.log("warn","monitor closed"),e._restart();}),this._monitorState=1,this._knx.startMonitor(function(){e._monitorState=2,t&&t();});}else t&&t(new Error("monitor already started"));},t.prototype.stop=function(t){if(this._forceStopped=!0,0!=this._monitorState&&3!=this._monitorState){if(this._monitorState=3,this._logger.log("debug","stop monitor: "+this._ip+":"+this._port),this._knx){var e=this;this._knx.stopMonitor(function(){e._monitorState=0,e._knx.removeAllListeners(),e._knx=null,t&&t();});}else t&&t();}else t&&t();},t.prototype.stopForGateway=function(t,e){this._logger.log("debug","stop monitor for gateway: "+t.getID());for(var r=-1,i=0;i<this._gateways.length;i++){var o=this._gateways[i];o&&o.getID()==t.getID()&&(r=i);}-1!=r&&this._gateways.splice(r,1),0==this._gateways.length?this.stop(function(){e&&e(null,!0);}):e&&e(null,!1);},t.prototype.getState=function(){return{state:this._monitorState,error:this._monitorError};},t.prototype._restart=function(){if(0!=this._gateways.length){if(4!=this._monitorState&&!this._forceStopped){this._logger.log("debug","try to restart monitor after 30sec");var t=this;this._monitorState=4,this._reconnTO=setTimeout(function(){t.start();},3e4);}}else this._monitorState=0;},t;}(),x.hub.m.knx.MonitorManager=function(){var t=function t(_t5){this._logger=require("x.logger.js").getLogger("x.hub.m.knx.MonitorManager"),this._controller=_t5,this._monitors={};};return t.prototype.init=function(t){var e=this;if(this._controller&&this._controller._deviceHandler){var r=this._controller._deviceHandler.getIPGatewayObjs(),i=0,o=function o(){++i<r.length&&e.startMonitor(r[i],o);};this.startMonitor(r[i],o);}t&&t();},t.prototype.startMonitor=function(t,e){if(t){var r=t.getIP(),i=t.getPort();this._startMonitor(r,i,t,e);}else e&&e(new Error("gateway is null"));},t.prototype._startMonitor=function(t,e,r,i){if(r){this._logger.log("info","start connect monitor to gateway "+r.getID()+" ("+t+":"+e+")");var o=e+"@"+t,n=this._monitors[o];n?(n.addGateway(r),i&&i()):((n=new x.hub.m.knx.Monitor(t,e)).addGateway(r),n.setManager(this),this._monitors[o]=n,n.start(i));}else i&&i(new Error("gateway is null"));},t.prototype.stopMonitor=function(t,e){var r=null,i=null;for(var o in this._monitors){var n=this._monitors[o];if(n&&n.hasGateway(t)){r=n,i=o;break;}}if(r){var a=this;r.stopForGateway(t,function(t,r){r&&(a._logger.log("debug","monitor "+i+" stopped"),delete a._monitors[i]),e&&e(t);});}else e&&e();},t.prototype.stopAllMonitors=function(t){var e=Object.keys(this._monitors);if(0!=e.length){var r=0,i=this._monitors;this._monitors={};var o=function o(){++r>=e.length?t&&t():i[e[r]].stop(o);};i[e[r]].stop(o);}else t&&t();},t.prototype.onFindKNX=function(t){if(t){var e=t.getIP(),r=t.getPort(),i=t.getMAC(),o=r+"@"+e,n=null,a=null;for(var s in this._monitors){var h=this._monitors[s].getGatewayWithMac(i);if(h){n=h,a=s;break;}}if(n&&a!=o){var c=this;this.stopMonitor(n,function(){c._startMonitor(e,r,n);});}}},t.prototype.listMonitors=function(t){var e=[];for(var r in this._monitors)this._monitors.hasOwnProperty(r)&&e.push(this._monitors[r]);t&&t(null,e);},t.prototype.getMonitorForGateway=function(t){for(var e in this._monitors)if(this._monitors.hasOwnProperty(e)){var r=this._monitors[e];if(r&&r.hasGateway(t))return r;}return null;},t;}(),x.hub.m.knx.SearchHandler=function(){var t=require("xnm.aio.knx.js").Finder,e=function e(t){this._logger=require("x.logger.js").getLogger("x.hub.m.knx.SearchHandler"),this._controller=t;var e=this;this._searchListener=function(t,r){e._onFindKNX(t,r);},this._errorListener=function(t){e._onKNXFinderError(t);},this._searching=!1,this._searchCB=[],this._searchResult=[],this._searchTO=null,this._nextSearchTO=null;};return e.SEARCH_INTERVAL=3e5,e.prototype.init=function(e){t.on("found",this._searchListener),t.on("error",this._errorListener),this._search(),e&&e();},e.prototype._onFindKNX=function(t,e){var r=t.toJSON();if(this._logger.log("info","find knx ip gateway:"+JSON.stringify(r)),r.hapi&&r.hapi.ip&&r.mac){var i={ip:r.hapi.ip,port:r.hapi.port,mac:r.mac,name:r.name.replace(/\0/g,""),physical_address:r.physical_address,serial_number:r.serial_number},o=new x.hub.m.knx.KNXIPGateway();o.fromJSON(i);for(var n=!1,a=0;a<this._searchResult.length;a++){var s=this._searchResult[a];s&&s.getIP()==o.getIP()&&s.getPort()==o.getPort()&&(n=!0);}n||this._searchResult.push(o),this._controller&&this._controller._monitorManager&&this._controller._monitorManager.onFindKNX(o,e);}},e.prototype._onKNXFinderError=function(e){this._logger.log("debug","knx finder error:"+e.message),t.stopSearchKNX(),this._search();},e.prototype.search=function(t){t&&-1==this._searchCB.indexOf(t)&&this._searchCB.push(t),this._searching||this._search();},e.prototype._search=function(){this._logger.log("debug","start search knx ip gateway"),this._searching=!0,this._nextSearchTO&&(this._logger.log("trace","clear next automatic search"),clearTimeout(this._nextSearchTO),this._nextSearchTO=null);var r=this;t.startSearchKNX(),this._searchTO=setTimeout(function(){r._logger.log("trace","finish searching knx ip gateway"),t.stopSearchKNX(),r._searching=!1,r._searchTO=null;var i=r._searchCB;r._searchCB=[];var o=r._searchResult;r._searchResult=[],r._nextSearchTO=setTimeout(function(){r._nextSearchTO=null,r._logger.log("trace","start next automatic search"),r._search();},e.SEARCH_INTERVAL),i.forEach(function(t){t&&t(null,o);});},3e3);},e;}(),x.hub.m.knx.Handler=function(){var t=function t(){this._logger=require("x.logger.js").getLogger("x.hub.m.knx.Handler"),this._deviceHandler=new this.DeviceHandler(this),this._monitorManager=new this.MonitorManager(this),this._searchHandler=new this.SearchHandler(this);};return t.prototype.DeviceHandler=x.hub.m.knx.DeviceHandler,t.prototype.MonitorManager=x.hub.m.knx.MonitorManager,t.prototype.SearchHandler=x.hub.m.knx.SearchHandler,t.prototype.init=function(t){var e=this;this._deviceHandler.init(function(){e._monitorManager.init(function(){e._searchHandler.init(function(){t&&t({});});});});},t.prototype.getSystems=function(){return["knx"];},t.prototype.addStateDevice=function(t,e){e&&e({});},t.prototype.getAllStates=function(){var t=null,e=this;return this._deviceHandler.getAllDevices().forEach(function(r){var i=e.getStates(r);i&&(t||(t={}),t[r.getID()]=i);}),t;},t.prototype.getStates=function(t){return t&&t.getID()?this._getStates(t.getID()):null;},t.prototype._getStates=function(t){var e=this._deviceHandler.getDeviceObj(t);if(!e)return null;var r=e.getGID();if(!r)return null;var i=this._deviceHandler.getIPGatewayObj(r);if(!i)return null;var o=this._monitorManager.getMonitorForGateway(i);if(!o)return null;var n=o.getKNXSession();if(!n)return null;var a=require("xnm.aio.knx.js").KNXGateway._Device.resolve(e.toJSON());return a?a.getStates(n):null;},t.prototype.executeCommand=function(t,e,r){r&&r({error:new Error("not implemented yet")});},t.prototype._executeCommand=function(t,e,r){var i=this._deviceHandler.getDeviceObj(t);if(i){var o=i.getGID();if(o){var n=this._deviceHandler.getIPGatewayObj(o);if(n){var a=this._monitorManager.getMonitorForGateway(n);if(a){var s=a.getState().state;if(2==s){var h=a.getKNXSession();if(h){var c=require("xnm.aio.knx.js").KNXGateway._Device.resolve(i.toJSON());c?c.executeCommand(e,h,function(t){r&&r(t);}):r&&r(new Error("device format invalid"));}else r&&r(new Error("knx session for gateway "+o+" is null"));}else r&&r(new Error("monitor for gateway "+o+" is in state:"+s));}else r&&r(new Error("no monitor for gateway with id:"+o));}else r&&r(new Error("no such gateway with id:"+o));}else r&&r(new Error("device "+t+" has no gid"));}else r&&r(new Error("no such device with id:"+t));},t.prototype.executeCommandLegacy=function(t,e,r){t?e?this._executeCommand(t,e,function(t){r&&r({error:t});}):r&&r({error:new Error("command invalid")}):r&&r({error:new Error("address invalid")});},t.prototype.getAllStatesLegacy=function(t,e){var r=[];try{var i=this.getAllStates();for(var o in i)if(i.hasOwnProperty(o)){var n={type:"KNX",adr:o,state:i[o]};r.push(n);}t&&t({data:r});}catch(e){t&&t({error:e});}},t.prototype.getIPGateways=function(t){this._deviceHandler.getIPGateways(function(e,r){t&&t({error:e,data:r});});},t.prototype.addIPGateway=function(t,e){this._deviceHandler.addIPGateway(t,function(t,r){e&&e({error:t,data:r});});},t.prototype.updateIPGateway=function(t,e){this._deviceHandler.updateIPGateway(t,function(t,r){e&&e({error:t,data:r});});},t.prototype.deleteIPGateway=function(t,e){this._deviceHandler.deleteIPGateway(t,function(t){e&&e({error:t});});},t.prototype.getDevices=function(t){this._deviceHandler.getDevices(function(e,r){t&&t({error:e,data:r});});},t.prototype.addDevice=function(t,e){this._deviceHandler.addDevice(t,function(t,r){e&&e({error:t,data:r});});},t.prototype.updateDevice=function(t,e){this._deviceHandler.updateDevice(t,function(t,r){e&&e({error:t,data:r});});},t.prototype.deleteDevice=function(t,e){this._deviceHandler.deleteDevice(t,function(t){e&&e({error:t});});},t.prototype.clean=function(t){this._monitorManager.stopAllMonitors(t);},t.prototype.listMonitors=function(t){this._monitorManager.listMonitors(function(e,r){if(e)t&&t({error:e});else{var i=[];r.forEach(function(t){if(t){var e=t.getGateways();e&&e.forEach(function(e){if(e){var r=t.getState(),o={gateway:e.getID(),monitor:{ip:t.getIP(),port:t.getPort()},state:r.state,error:r.error?r.error.message:null};i.push(o);}});}}),t&&t({data:i});}});},t.prototype.reset=function(t){var e=this;this._deviceHandler.deleteAllDevice(function(){e._deviceHandler.deleteAllIPGateway(function(){t&&t({});});});},t.prototype.searchKNXGateway=function(t){this._searchHandler.search(function(e,r){if(e)t&&t({error:e});else{var i=[];r&&r.forEach(function(t){if(t){var e=t.toJSON();e&&i.push(e);}}),t&&t({data:i});}});},t.prototype.onMonitorMessage=function(t,e,r){var i=this._deviceHandler.getAllDevices(),o=require("xnm.aio.knx.js").KNXGateway,n=(require("x.hub.eventbus.js"),this);i.forEach(function(i){if(i&&i.getGID()==t){var a=i.getChannels();if(a){var s=!1;for(var h in a)if(a.hasOwnProperty(h)){var c=a[h];if(c&&c.event&&c.event.ga&&o._adr2long(c.event.ga)==e){s=!0;break;}}if(s){var u=n.getStates(i);n._logger.log("info","receive event ("+r.toString("hex")+"@"+e+") for device "+i.getID()+":"+JSON.stringify(u)),function(t){var e=require("x.hub.eventbus.js");e.emit("gatewayevent",t,{address:"KNX"},"STA"),e.emit("udpevent",t,"STA");}({type:"KNX",adr:i.getID(),state:u});}}}});},t;}(),module.exports=new x.hub.m.knx.Handler();