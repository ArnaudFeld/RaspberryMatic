require("./x.nodeext.js");
var XCXMLNode=function(a,c,b,g){this._name=a;this._attributes=c;this._parent=b;this._value=g;this._children=[];XCXMLNode.prototype.addChild=function(a){this._children.push(a)};XCXMLNode.prototype.getParent=function(){return this._parent};XCXMLNode.prototype.prop=function(a){return"tagName"==a?this._name:null};XCXMLNode.prototype.text=function(){return this._unescapeXml(this._value)};XCXMLNode.prototype.getAttributes=function(){return this._attributes};XCXMLNode.prototype.children=function(){var a=
this._children;a.each=function(b){for(var d=0;d<a.length;d++)b.call(a[d])};return a};XCXMLNode.prototype.attr=function(a,b){null!=b&&(this._attributes[a]=b);return this._attributes[a]};XCXMLNode.prototype.attr2=function(a){var b;if((b=this.attr(a))&&""!=b&&"null"!=b)return b};XCXMLNode.prototype.find=function(a,b){null==b&&(b=[],b.each=function(a){for(var d=0;d<b.length;d++)a.call(b[d])});a=a.trim();a=a.replace(/\\./g,".");var d=a.indexOf(" ",0),e=a.indexOf("[",0),c=a,f=null,g=null;if(-1!=d||-1!=
e)if(-1==e||-1<d&&d<e)f=a.substring(d+1).trim(),c=a.substring(0,d);else if(-1==d||-1<e&&e<d)d=a.indexOf("]",e),-1!=d&&(f=a.substring(d+1).trim(),c=a.substring(0,e),d=a.substring(e+1,d).trim().split("="),2==d.length&&(g={},g.id=d[0].trim(),g.value=d[1].replace(/'/g,"").replace(/\"/g,"").trim()));if(null==this._parent){var l=this._name;l&&(d=l.indexOf(":"),0<d&&(l=l.substr(d+1)),l==c&&(d=!0,g&&(d=!1,this.getAttributes()[g.id]==g.value&&(d=!0)),d&&(f?this.find(f,b):b.push(this))))}if(0<this._children.length)for(e=
0;e<this._children.length;e++)l=this._children[e]._name,d=l.indexOf(":"),0<d&&(l=l.substr(d+1)),l==c&&(d=!0,g&&(d=!1,this._children[e].getAttributes()[g.id]==g.value&&(d=!0)),d&&(f?this._children[e].find(f,b):b.push(this._children[e]))),this._children[e].find(a,b);return b};XCXMLNode.prototype.getXMLString=function(){return this._getXMLString(0)};XCXMLNode.prototype._getXMLString=function(a){for(var b="",d=0;d<a;d++)b+="  ";var e=b+"<"+this._name;if(this._attributes)for(var c in this._attributes)e+=
" "+c+'="'+this._attributes[c]+'"';if(0<this._children.length){e+=">\r\n";for(d=0;d<this._children.length;d++)e+=this._children[d]._getXMLString(a+1);e+=b+"</"+this._name+">\r\n"}else e=null!=this._value?e+(">"+this._value+"</"+this._name+">\r\n"):e+"/>\r\n";return e};XCXMLNode.prototype.XML_CHAR_MAP={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&apos;"};XCXMLNode.prototype._escapeXml=function(a){return a.replace(/[<>&"']/g,function(a){return x.xmlrpc.XML_CHAR_MAP[a]})};XCXMLNode.prototype._unescapeXml=
function(a){if(!a)return a;a=a.replace(/&lt;/g,"<");a=a.replace(/&gt;/g,">");a=a.replace(/&amp;/g,"&");a=a.replace(/&quot;/g,'"');return a=a.replace(/&apos;/g,"'")}},XCXMLDocument=function(a,c){this._XMLString=null;a&&(this._XMLString=a.trim());this._rootNode=null;this._XMLHead='<?xml version="1.0" encoding="UTF-8" ?>';var b=-1;null!=this._XMLString&&5<this._XMLString.length&&("<?xml"==this._XMLString.substring(0,5)&&(b=this._XMLString.indexOf(">",0),this._XMLHead=this._XMLString.substring(0,b+1)),
b=this._XMLString.indexOf("<",b));if(-1<b){var g=null;try{require("sax")&&(g=require("sax"))}catch(h){g=null}if(c||null==g)this._rootNode=this._parseNode(b,[],null);else{var g=g.parser(!0),k=null,d=this;g.ontext=function(a){k&&(k._value=a)};g.onopentag=function(a){a=new XCXMLNode(a.name,a.attributes,k,null);k&&k._children.push(a);k=a;d._rootNode||(d._rootNode=k)};g.onclosetag=function(a){k&&(k=k._parent)};g.write(this._XMLString.substr(b)).close()}}else this._rootNode=new XCXMLNode;this._XMLString=
null};XCXMLDocument.prototype.getRootNode=function(){return this._rootNode};XCXMLDocument.prototype.getXMLString=function(){var a=this._XMLHead+"\r\n";this._rootNode&&(a+=this._rootNode.getXMLString());return a};XCXMLDocument.prototype.find=function(a,c){return this._rootNode.find(a,c)};XCXMLDocument.prototype.attr=function(a,c){return this._rootNode.attr(a,c)};XCXMLDocument.prototype.children=function(){return[this._rootNode]};
XCXMLDocument.prototype._parseAttributes=function(a,c){var b=this._XMLString.indexOf("=",a),g=this._XMLString.indexOf(">",a);if(-1<b&&b<g){var g=this._XMLString.substring(a+1,b).trim(),h='"',k=this._XMLString.indexOf('"',b);-1==k&&(h="'",k=this._XMLString.indexOf("'",b));b=k;if(-1<b&&(h=this._XMLString.indexOf(h,b+1),-1<h))return b=this._XMLString.substring(b+1,h),c[g]=b,h+1}return-1};
XCXMLDocument.prototype._parseNode=function(a,c,b){for(var g=null,h=!0;h;){var h=!1,k=null,d=c.length;if(!this._XMLString)return null;var e=this._XMLString.indexOf(" ",a),m=this._XMLString.indexOf(">",a),f=null,n=null,l={};if(-1<e&&e<m){if(f=this._XMLString.substring(a+1,e),"!--"!=f){for(m=this._parseAttributes(e,l);-1!=m;)e=m,m=this._parseAttributes(e,l);e=this._XMLString.indexOf(">",e)}}else-1<m&&(e=m,f=this._XMLString.substring(a+1,m));m=this._XMLString.indexOf("<",e);-1<e&&-1<m&&m>e+1&&(m=this._XMLString.substring(e+
1,m).trim(),0<m.length&&">"!=m[0]&&(n=m));e=this._XMLString.indexOf(">",e);if(-1!=e){if(null!=f)if("/"!=this._XMLString.charAt(e-1)&&"/"!=f.charAt(0)&&c.push(f),"/"==f.charAt(0)){if(f=f.substring(1),a=c.pop(),!(f==a||f&&a&&f.trim()==a.trim()))return console.log("INVALID XML ("+f+"<->"+a+")!!!"),null}else f=f.replace("/",""),k=new XCXMLNode(f,l,b,n),g||(g=k),null!=b&&b.addChild(k);a=this._XMLString.indexOf("<",e);-1<a&&(c.length<d?this._parseNode(a,c,b.getParent()):c.length==d?this._parseNode(a,c,
b):(b=k,h=!0))}}return g};var XCLogWriter=function(){};XCLogWriter.prototype.writeConsole=function(a){console.log(a)};XCLogWriter.prototype.writeFile=function(a,c,b){var g=this,h=require("fs");h.exists(c,function(k){k?h.stat(c,function(d,e){!d&&e&&(e.size/1024>=b?g._copyFile(c,c+".1",function(){h.writeFile(c,a+"\n",function(a){})}):h.appendFile(c,a+"\n",function(a){}))}):h.writeFile(c,a+"\n",function(a){})})};
XCLogWriter.prototype._copyFile=function(a,c,b){require("child_process").execFile("/bin/cp",["--no-target-directory",a,c],function(a){b&&b(a)})};XC=new function(){};XC.debugf=function(a){var c=null;try{var b=require("x.logger.js");b&&(c=b.getLogger("x.core.debugf"),c.log("trace",a))}catch(g){c=null}c||console.log(a)};XC.getHexVal=function(a,c){for(var b=a.toString(16).toUpperCase();b.length<c;)b="0"+b;return b};
XC.getBytes=function(a,c){var b=[],g=a.length;if(c)for(var h=0;h<g;h+=2)b.push(parseInt(a.substr(h,2),16));else for(h=0;h<g;h++)b.push(a.charCodeAt(h));return b};XC.createObject=function(a){switch(a){case "x.logger.writer":return new XCLogWriter}return null};
dateFormat=function(a){function c(a,b){a=String(a);for(b=b||2;a.length<b;)a="0"+a;return a}function b(a){a=new Date(a.getFullYear(),a.getMonth(),a.getDate());a.setDate(a.getDate()-(a.getDay()+6)%7+3);var b=new Date(a.getFullYear(),0,4);b.setDate(b.getDate()-(b.getDay()+6)%7+3);var c=a.getTimezoneOffset()-b.getTimezoneOffset();a.setHours(a.getHours()-c);return 1+Math.floor((a-b)/6048E5)}function g(a){a=a.getDay();0===a&&(a=7);return a}function h(a){return null===a?"null":void 0===a?"undefined":"object"!==
typeof a?typeof a:Array.isArray(a)?"array":{}.toString.call(a).slice(8,-1).toLowerCase()}var k=function(){var a=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZWN]|'[^']*'|'[^']*'/g,e=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,m=/[^-+\dA-Z]/g;return function(f,n,l,v){1!==arguments.length||"string"!==h(f)||/\d/.test(f)||(n=f,f=void 0);f=f||new Date;f instanceof Date||(f=new Date(f));if(isNaN(f))throw TypeError("Invalid date");
n=String(k.masks[n]||n||k.masks["default"]);var q=n.slice(0,4);if("UTC:"===q||"GMT:"===q)n=n.slice(4),l=!0,"GMT:"===q&&(v=!0);var p=l?"getUTC":"get",q=f[p+"Date"](),w=f[p+"Day"](),t=f[p+"Month"](),y=f[p+"FullYear"](),r=f[p+"Hours"](),z=f[p+"Minutes"](),A=f[p+"Seconds"](),p=f[p+"Milliseconds"](),u=l?0:f.getTimezoneOffset(),C=b(f),D=g(f),B={d:q,dd:c(q),ddd:k.i18n.dayNames[w],dddd:k.i18n.dayNames[w+7],m:t+1,mm:c(t+1),mmm:k.i18n.monthNames[t],mmmm:k.i18n.monthNames[t+12],yy:String(y).slice(2),yyyy:y,
h:r%12||12,hh:c(r%12||12),H:r,HH:c(r),M:z,MM:c(z),s:A,ss:c(A),l:c(p,3),L:c(Math.round(p/10)),t:12>r?"a":"p",tt:12>r?"am":"pm",T:12>r?"A":"P",TT:12>r?"AM":"PM",Z:v?"GMT":l?"UTC":(String(f).match(e)||[""]).pop().replace(m,""),o:(0<u?"-":"+")+c(100*Math.floor(Math.abs(u)/60)+Math.abs(u)%60,4),S:["th","st","nd","rd"][3<q%10?0:(10!=q%100-q%10)*q%10],W:C,N:D};return n.replace(a,function(a){return a in B?B[a]:a.slice(1,a.length-1)})}}();k.masks={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",
longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:sso",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'",expiresHeaderFormat:"ddd, dd mmm yyyy HH:MM:ss Z"};k.i18n={dayNames:"Sun Mon Tue Wed Thu Fri Sat Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" "),monthNames:"Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec January February March April May June July August September October November December".split(" ")};
return k}(this);"undefined"==typeof window&&(window={XCHost:{}},window.XCHost.getType=function(){return"node-webkit"},window.XCHost.getVersion=function(){return"1.0"},window.XC_Text={});$=function(a){return a};$.parseXML=function(a){if("string"!==typeof a||!a)return new XCXMLDocument;var c=null;try{c=new XCXMLDocument(a)}catch(b){c=new XCXMLDocument,XC.debugf("failed to parse XML")}return c};$.parseJSON=function(a){try{return JSON.parse(a)}catch(c){}return null};
$.ajax=function(a){var c=require("url").parse(a.url),b={host:c.hostname,port:c.port,path:c.path,method:"GET"},g="string";a.dataType&&(g=a.dataType);a.method&&(b.method=a.method);a.type&&(b.method=a.type);a.headers&&(b.headers=a.headers);if(a.username||a.password)b.auth=(a.username?a.username:"")+":"+(a.password?a.password:"");var h;a.data&&("object"==typeof a.data?(b.headers||(b.headers={}),h=require("querystring").stringify(a.data,null,null,{encodeURIComponent:encodeURI}),b.headers["Content-Type"]=
"application/x-www-form-urlencoded","POST"==b.method||"PUT"==b.method?b.headers["Content-Length"]=h.length:"GET"==b.method&&(b.path=b.path+"?"+h)):"string"==typeof a.data&&(b.headers||(b.headers={}),"POST"==b.method||"PUT"==b.method)&&(b.headers["Content-Length"]=Buffer.byteLength(a.data,"utf8")));a.contentType&&(b.headers||(b.headers={}),b.headers["Content-Type"]=a.contentType);a.complete&&(a.error=a.complete);var k=require("http");"https:"==c.protocol&&(k=require("https"),process&&process.env&&
(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),b.port||(b.port=443));var d=k.request(b,function(b){if(a.statusCode&&a.statusCode[b.statusCode])a.statusCode[b.statusCode]();var c="";b.on("data",function(a){c+=a});b.on("end",function(){var d={getAllResponseHeaders:function(){return b.headers},getResponseHeader:function(a){return b.headers[a]}};if(200==b.statusCode)if(a.complete)a.complete({responseText:c});else{if(a.success){if("json"==g)try{c=JSON.parse(c)}catch(h){a.error&&a.error({status:b.statusCode,
responseText:c},"error","json parse error");a.error=void 0;return}a.success(c,"200",d)}}else a.error&&a.error({status:b.statusCode,responseText:c},"error",c),a.error=void 0})});d.on("error",function(b){a.error&&a.error(null,b.message);a.error=void 0});a.timeout&&d.setTimeout(a.timeout,function(){d.abort();a.error&&a.error(null,"timeout");a.error=void 0});a.data&&"get"!=b.method.toLowerCase()&&"delete"!=b.method.toLowerCase()&&("string"==typeof a.data||a.data instanceof Buffer?d.write(a.data):"object"==
typeof a.data?h&&d.write(h):d.write(a.data));d.end()};$.trim=function(a){return a.trim()};
