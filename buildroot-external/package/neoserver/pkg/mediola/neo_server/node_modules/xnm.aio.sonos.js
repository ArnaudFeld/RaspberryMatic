var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.sonos=xnm.aio.sonos||{};
xnm.aio.sonos.Master=function(){var d=function(){"undefined"!=typeof require&&require?(this._logger=require("x.logger.js").getLogger("xnm.aio.sonos.Master"),require("x.logger.js").setLevel("info","xnm.aio.sonos.Master")):this._logger={log:{}};this._searchCB=[];this._autoSearchTimeout=null;this._tmpPlayers={};this._players={};this._mediaServer={};this._currentZone=this._topology=null;this._discovery=new xnm.aio.sonos.Discovery(this);this.search(null)};d.prototype.getBufferedPlayers=function(){var a=
[],b;for(b in this._players)if(this._players.hasOwnProperty(b)){var c=this._players[b];c&&!c.dummy&&c.player&&a.push(c.player)}return a};d.prototype.getBufferedMediaServers=function(){var a=[],b;for(b in this._mediaServer)this._mediaServer.hasOwnProperty(b)&&a.push(this._mediaServer[b]);for(b in this._players)if(this._players.hasOwnProperty(b)){var c=this._players[b];c&&c.player&&c.player._server&&(c.player._server._sonosServer=!0,a.push(c.player._server))}return a};d.prototype.search=function(a){var b=
this._searchCB.length;a&&-1==this._searchCB.indexOf(a)&&this._searchCB.push(a);if(0==b){this._autoSearchTimeout&&(clearTimeout(this._autoSearchTimeout),this._autoSearchTimeout=null);this._search();var c=this;setTimeout(function(){c._autoSearchTimeout=setTimeout(function(){c._logger.log("trace","auto search timeout, search again");c.search(null)},3E4);var a=c._searchCB;c._searchCB=[];a.forEach(function(a){a&&a()})},5E3)}};d.prototype._search=function(){for(var a in this._players)if(this._players.hasOwnProperty(a)){var b=
this._players[a];5<=b.missCount?delete this._players[a]:b.missCount++}this._mediaServer={};this._discovery.search(null)};d.prototype.findPlayer=function(a){var b=a.uuid;if(b){var c=this._players[b];c||(this._players[b]={missCount:0,dummy:!1},c=this._players[b]);if(c.player)c.player.setIP(a.ip),c.player.setPort(a.port);else{var b=new xnm.aio.sonos.Player(a.ip,a.port,a.uuid,a.name),e,f;if(a.embeddedDevices)for(var d=0;d<a.embeddedDevices.length;d++){var g=a.embeddedDevices[d];g&&"urn:schemas-upnp-org:device:MediaServer:1"==
g.deviceType?f=g:g&&"urn:schemas-upnp-org:device:MediaRenderer:1"==g.deviceType&&(e=g)}b._device=a;b._renderer=e;b._server=f;c.player=b}c.dummy=!1;c.missCount=0;var l=this;c.player.getZoneGroupState(function(a,c,b){!a&&c&&b&&l._updateTopology(c)})}};d.prototype.findMediaServer=function(a){var b=a.uuid;b&&(this._mediaServer[b]=a)};d.prototype.getCurrentZone=function(a){if(this._currentZone)a&&a(null,this._currentZone);else{var b=this;this.search(function(c){c?a&&a(c):this._currentZone?b.getCurrentZone(a):
a&&a(Error("no current zone"))})}};d.prototype.setCurrentZone=function(a,b){if(this._topology){var c=null,e;for(e in this._topology){var f=this._topology[e];if(f&&f.id==a){c=f;break}}c&&c.coordinator?(e=this._players[c.coordinator])?(this._currentZone=JSON.parse(JSON.stringify(c)),this._currentZone.player=e.player,b&&b()):b&&b(Error("no such player")):b&&b(Error("no such zone"))}else{var d=this;this.search(function(a){a?b&&b(a):this._topology?d.setCurrentZone(b):b&&b(Error("no player found"))})}};
d.prototype.getZones=function(a){var b=this,c=this.getBufferedPlayers();c&&0!=c.length?a&&a(null,this._topology):this.search(function(c,f){c?a&&a(c):f&&0!=f.length?b.getZones(a):a&&a(Error("find no sonos player"))})};d.prototype.getPlayer=function(a){var b=null;if("master"==a.type)return this;if(!a.uuid){if(!a.ip)return null;for(var c in this._players)if(this._players.hasOwnProperty(c)&&(b=this._players[c])&&b.player&&b.player.getIP()==a.ip)return b.player;if(this._tmpPlayers[a.ip])return this._tmpPlayers[a.ip];
b=new xnm.aio.sonos.Player(a.ip,a.port,a.uuid,a.name);return this._tmpPlayers[a.ip]=b}if((c=this._players[a.uuid])&&c.player)return c.player;if(!a.ip)return null;b=new xnm.aio.sonos.Player(a.ip,a.port,a.uuid,a.name);this._players[a.uuid]={missCount:0,dummy:!0,player:b};return b};d.prototype._updateTopology=function(a){this._topology||(this._topology={});var b=this;a.forEach(function(a){a&&a.id&&(b._topology[a.id]=a)});for(var c,e=0;e<a.length;e++)if((c=a[e])&&c.coordinator){var f=this._players[c.coordinator];
if(f&&f.player&&!this._currentZone){this._currentZone=JSON.parse(JSON.stringify(c));this._currentZone.player=f.player;return}}for(var d=0;d<a.length;d++)if((c=a[e])&&c.coordinator&&(f=this._players[c.coordinator])&&f.player){this._currentZone=JSON.parse(JSON.stringify(c));this._currentZone.player=f.player;break}};d.prototype.executeCommandCreator=function(a,b,c){if(this._currentZone)this._currentZone.player.executeCommandCreator(a,b,c);else{var e=this;this.search(function(f){f?c&&c(f):e._currentZone?
e._currentZone.player.executeCommandCreator(a,b,c):c&&c(f)})}};d.prototype.getStatesCreator=function(a,b,c){if(this._currentZone)this._currentZone.player.getStatesCreator(a,b,c);else{var e=this;this.search(function(f){f?c&&c(f):e._currentZone?e._currentZone.player.getStatesCreator(a,b,c):c&&c(null,[])})}};d.prototype.play=function(a,b,c){if(this._currentZone)this._currentZone.player.play(a,b,c);else{var e=this;this.search(function(f){f?c&&c(f):e._currentZone?e._currentZone.player.play(a,b,c):c&&c(f)})}};
d.prototype.addToQueueAndPlay=function(a,b,c){if(this._currentZone)this._currentZone.player.addToQueueAndPlay(a,b,c);else{var e=this;this.search(function(f){f?c&&c(f):e._currentZone?e._currentZone.player.addToQueueAndPlay(a,b,c):c&&c(f)})}};d.prototype.addToQueue=function(a,b,c){if(this._currentZone)this._currentZone.player.addToQueue(a,b,c);else{var e=this;this.search(function(f){f?c&&c(f):e._currentZone?e._currentZone.player.addToQueue(a,b,c):c&&c(f)})}};d.prototype.replaceQueueAndPlay=function(a,
b,c){if(this._currentZone)this._currentZone.player.replaceQueueAndPlay(a,b,c);else{var e=this;this.search(function(f){f?c&&c(f):e._currentZone?e._currentZone.player.replaceQueueAndPlay(a,b,c):c&&c(f)})}};d.prototype.browser=function(a,b,c,e,f){if(this._currentZone)this._currentZone.player.browser(a,b,c,e,f);else{var d=this;this.search(function(g){g?f&&f(g):d._currentZone?d._currentZone.player.browser(a,b,c,e,f):f&&f(g)})}};d.prototype.clearQueue=function(a,b){if(this._currentZone)this._currentZone.player.clearQueue(b);
else{var c=this;this.search(function(e){e?b&&b(e):c._currentZone?c._currentZone.player.clearQueue(a,b):b&&b(e)})}};d.prototype.toJSON=function(){return{sys:"sonos",type:"master",ip:"xxxxxx",port:0,uuid:"master"}};d.prototype.equalsTo=function(a){return a&&a instanceof d?!0:!1};return d}();
xnm.aio.sonos.Player=function(){var d=function(a,b,c,e){var f=require("x.logger.js");this._logger=f?f.getLogger("xnm.aio.sonos.Player"):{log:function(){}};this.ip=a;this.port=b;if(!b||0>b)this.port=1400;this.uuid=c;this.name=e;this.zoneName=null;this.ip&&this.port&&(this._device=this._getDevice(this.ip,this.port,this.uuid,this.name),this._renderer=this._getRenderer(this.ip,this.port,this.uuid),this._server=this._getServer(this.ip,this.port,this.uuid));this.CommandHandler=null};d.prototype.PLAY_MODE=
"NORMAL REPEAT_ALL REPEAT_ONE SHUFFLE_NOREPEAT SHUFFLE SHUFFLE_REPEAT_ONE".split(" ");d.prototype.zoneGroupTopology={type:"urn:schemas-upnp-org:service:ZoneGroupTopology:1",url:"/ZoneGroupTopology/Control"};d.prototype.groupManagement={type:"urn:schemas-upnp-org:service:GroupManagement:1",url:"/GroupManagement/Control"};d.prototype._getDevice=function(a,b,c,e){var f=new (require("x.upnp.js").Device);f.init(a,b,c,null);f.name=e;return f};d.prototype._getRenderer=function(a,b,c){var e=new (require("x.upnp.js").MediaRenderer);
e.init(a,b,c,{avTransport:{type:"urn:schemas-upnp-org:service:AVTransport:1",url:"/MediaRenderer/AVTransport/Control"},connectionManager:{type:"urn:schemas-upnp-org:service:ConnectionManager:1",url:"/MediaRenderer/ConnectionManager/Control"},renderingControl:{type:"urn:schemas-upnp-org:service:RenderingControl:1",url:"/MediaRenderer/RenderingControl/Control"},groupRenderingControl:{type:"urn:schemas-upnp-org:service:GroupRenderingControl:1",url:"/MediaRenderer/GroupRenderingControl/Control"},queue:{type:"urn:schemas-sonos-com:service:Queue:1",
url:"/MediaRenderer/Queue/Control"}});return e};d.prototype._getServer=function(a,b,c){var e=new (require("x.upnp.js").MediaServer);e.init(a,b,c,{contentDirectory:{type:"urn:schemas-upnp-org:service:ContentDirectory:1",url:"/MediaServer/ContentDirectory/Control"},connectionManager:{type:"urn:schemas-upnp-org:service:ConnectionManager:1",url:"/MediaServer/ConnectionManager/Control"}});return e};d.prototype.play=function(){this._getRenderer().play()};d.prototype.pause=function(){this._getRenderer().pause()};
d.prototype.stop=function(){this._getRenderer().stop()};d.prototype.previous=function(){this._getRenderer().previous()};d.prototype.next=function(){this._getRenderer().next()};d.prototype.mute=function(a){this._getRenderer().mute(a)};d.prototype.isMuted=function(a){this._getRenderer().isMuted(a)};d.prototype.getVolume=function(a){this._getRenderer().getVolume(a)};d.prototype.setVolume=function(a,b){this._getRenderer().setVolume(a,b)};d.prototype.getPlayState=function(a){this._getRenderer().getPlayState(a)};
d.prototype.getInfo=function(a){this._getRenderer().getInfo(a)};d.prototype.playItem=function(a,b){this._getRenderer().playItem(a,b)};d.prototype.playPlaylist=function(){var a=require("x.upnp.js"),b=this._getRenderer(),c;c='<u:SetAVTransportURI xmlns:u="urn:schemas-upnp-org:service:AVTransport:1"><InstanceID>0</InstanceID>'+("<CurrentURI>x-rincon-queue:"+b.uuid+"#0</CurrentURI><CurrentURIMetaData></CurrentURIMetaData>");c+="</u:SetAVTransportURI>";(new a.SOAPRequest).doRequest(b.getURL(b.AVTransport),
'"urn:schemas-upnp-org:service:AVTransport:1#SetAVTransportURI"',c,function(a){b.play()})};d.prototype.getPlaylist=function(a){a=require("x.upnp.js");var b=this._getRenderer(),c;c='<u:Browse xmlns:u="urn:schemas-upnp-org:service:ContentDirectory:1"><ObjectID>Q:0</ObjectID><BrowseFlag>BrowseDirectChildren</BrowseFlag>';c+="<Filter>dc:title,res,dc:creator,upnp:artist,upnp:album,upnp:albumArtURI</Filter>";c+="<StartingIndex>{0}</StartingIndex>";c+="<RequestedCount>{1}</RequestedCount>";c+="<SortCriteria></SortCriteria>";
c+="</u:Browse>";(new a.SOAPRequest).doRequest(b.getURL("/MediaServer/ContentDirectory/Control"),'"urn:schemas-upnp-org:service:ContentDirectory:1#Browse"',c,function(a){var c=[];a=b._parseSOAPResponse(a,!0);(a=$($.parseXML(a)))&&a.find("item").each(function(){$(this);c.push(b._parseItemMetaData($(this)))})})};d.prototype.clearPlaylist=function(a){var b=require("x.upnp.js"),c=this._getRenderer(),e;e='<u:RemoveAllTracksFromQueue xmlns:u="urn:schemas-upnp-org:service:AVTransport:1"><InstanceID>0</InstanceID></u:RemoveAllTracksFromQueue>';
(new b.SOAPRequest).doRequest(c.getURL(c.AVTransport),'"urn:schemas-upnp-org:service:AVTransport:1#RemoveAllTracksFromQueue"',e,function(c){a&&a()})};d.prototype.addToPlaylist=function(a,b){var c=require("x.upnp.js"),e=this._getRenderer(),f;f='<u:AddURIToQueue xmlns:u="urn:schemas-upnp-org:service:AVTransport:1"><InstanceID>0</InstanceID>'+("<EnqueuedURI>"+a+"</EnqueuedURI>");f+="<EnqueuedURIMetaData></EnqueuedURIMetaData><DesiredFirstTrackNumberEnqueued>0</DesiredFirstTrackNumberEnqueued><EnqueueAsNext>1</EnqueueAsNext>";
f+="</u:AddURIToQueue>";(new c.SOAPRequest).doRequest(e.getURL(e.AVTransport),'"urn:schemas-upnp-org:service:AVTransport:1#AddURIToQueue"',f,function(a){b&&b()})};d.prototype.setPlaylist=function(a,b){if(0<a.length){var c=a.pop(),e=this;this.addToPlaylist(c.url,function(){e.setPlaylist(a,b)})}else b&&b()};d.prototype.executeCommand=function(a,b,c){var e=this;a=!0;"play"==b?this.play():"pause"==b?this.pause():"stop"==b?this.stop():"previous"==b?this.previous():"next"==b?this.next():"toggleMute"==b?
(a=!1,this.isMuted(function(a){a?e.mute(!1):e.mute(!0);c&&setTimeout(function(){c()},200)})):(a=!1,this.setVolume(Math.floor(parseInt(b)),function(){c&&setTimeout(function(){c()},200)}));a&&c&&setTimeout(function(){c()},200)};d.prototype.getStates=function(a,b,c){var e=this;this.CommandHandler=a;this.getVolume(function(a){e.isMuted(function(d){e.getPlayState(function(g){var l={volume:a,muted:d,state:g};b&&e.CommandHandler&&e.CommandHandler.setState?(e.CommandHandler.setState(b.id+":volume",a),e.CommandHandler.setState(b.id+
":muted",d),e.CommandHandler.setState(b.id+":state",g)):e.CommandHandler&&e.CommandHandler.receivedState&&e.CommandHandler.receivedState("sonos",e.ip,l);e.getInfo(function(a){var b={artist:"",title:""};"PLAYING"==g&&(b.artist=a.artist?a.artist:"?",b.title=a.title?a.title:"?");e.CommandHandler&&e.CommandHandler.receivedState&&e.CommandHandler.receivedState("sonos",e.ip,b);c&&(l.title=b.title,l.artist=b.artist,c(l))})})})})};d.prototype.getStateValues=function(a){return a};d.prototype.getIP=function(){return this._device?
this._device.ip:null};d.prototype.setIP=function(a){this._device&&(this._device.ip=a);this._renderer&&(this._renderer.ip=a);this._server&&(this._server.ip=a)};d.prototype.getPort=function(){return this._device?this._device.port:null};d.prototype.setPort=function(a){this._device&&(this._device.port=a);this._renderer&&(this._renderer.port=a);this._server&&(this._server.port=a)};d.prototype.getUUID=function(){return this._device?this._device.uuid:null};d.prototype.getName=function(){return this._device?
this._device.name:null};d.prototype.executeCommandCreator=function(a,b,c){b&&b.value?this._executeCommand(b.value,b.ext,function(a){c&&c(a)},b):c&&c(Error("command value is empty"))};d.prototype.getStatesCreator=function(a,b,c){a=[];for(var e=this,d=0;d<b.length;d++){var h=b[d];if(h&&h.id&&h.status&&h.status.value){var g=null;switch(h.status.value){case "muted":g="MUTE";break;case "volume":g="VOLUME";break;case "groupMuted":g="GROUP_MUTE";break;case "groupVolume":g="GROUP_VOLUME";break;case "shuffle":case "repeat":g=
"PLAY_MODE";break;case "loudness":g="LOUDNESS";break;case "bass":g="BASS";break;case "treble":g="TREBLE";break;case "balance":g="BALANCE";break;case "playState":g="PLAY_STATE";break;case "duration":case "durationS":case "position":case "positionS":case "artist":case "title":case "album":g="PLAY_INFO"}g&&-1==a.indexOf(g)&&a.push(g)}}this._getStates(a,function(a,d){a&&e._logger.log("trace","["+e.ip+":"+e.port+"]get states error:"+a.stack);if(d){for(var f=[],g=0;g<b.length;g++){var h=b[g];if(h&&h.id){var m=
"?";if(h.status)switch(h.status.value){case "muted":null!=d.muted&&"undefined"!=typeof d.muted&&(m=d.muted);break;case "volume":null!=d.volume&&"undefined"!=typeof d.volume&&(m=d.volume);break;case "groupMuted":null!=d.groupMuted&&"undefined"!=typeof d.groupMuted&&(m=d.groupMuted);break;case "groupVolume":null!=d.groupVolume&&"undefined"!=typeof d.groupVolume&&(m=d.groupVolume);break;case "shuffle":d.playMode&&d.playMode.shuffle&&(m=d.playMode.shuffle);break;case "repeat":d.playMode&&d.playMode.repeat&&
(m=d.playMode.repeat);break;case "loudness":d.loudness&&(m=d.loudness);break;case "bass":null!=d.bass&&"undefined"!=typeof d.bass&&(m=d.bass);break;case "treble":null!=d.treble&&"undefined"!=typeof d.treble&&(m=d.treble);break;case "balance":null!=d.balance&&"undefined"!=typeof d.balance&&(m=d.balance);break;case "playState":d.transportState&&(m=d.transportState);break;case "duration":d.playInfo&&d.playInfo.duration&&(m=d.playInfo.duration);break;case "durationS":d.playInfo&&"undefined"!=typeof d.playInfo.durationSec&&
null!=d.playInfo.durationSec&&(m=d.playInfo.durationSec);break;case "position":d.playInfo&&d.playInfo.position&&(m=d.playInfo.position);break;case "positionS":d.playInfo&&"undefined"!=typeof d.playInfo.positionSec&&null!=d.playInfo.positionSec&&(m=d.playInfo.positionSec);break;case "artist":m=d.playInfo&&d.playInfo.trackMetaData&&d.playInfo.trackMetaData.artist?d.playInfo.trackMetaData.artist:"";break;case "title":m=d.playInfo&&d.playInfo.trackMetaData&&d.playInfo.trackMetaData.title?d.playInfo.trackMetaData.title:
"";break;case "album":m=d.playInfo&&d.playInfo.trackMetaData&&d.playInfo.trackMetaData.album?d.playInfo.trackMetaData.album:""}f.push({id:h.id,status:m})}}c&&c(null,f)}else c&&c(Error("get state error"))})};d.prototype._executeCommand=function(a,b,c,e){if(this._renderer)switch(a){case "play":this._renderer.play(c);break;case "pause":this._renderer.pause(c);break;case "stop":this._renderer.stop(c);break;case "previous":this._renderer.previous(c);break;case "next":this._renderer.next(c);break;case "mute":this._renderer.mute(c);
break;case "unmute":this._renderer.unmute(c);break;case "toggleMute":this._renderer.toggleMute(c);break;case "volume":if("undefined"==typeof b||null==b){c&&c(Error("volume value invalid"));break}this._renderer.setVolume(b,c);break;case "volumeUp":this.volumeUp(c);break;case "volumeDown":this.volumeDown(c);break;case "shuffleOn":this.shuffleOn(c);break;case "shuffleOff":this.shuffleOff(c);break;case "shuffleToggle":this.shuffleToggle(c);break;case "repeatOff":this.repeatOff(c);break;case "repeatAll":this.repeatAll(c);
break;case "repeatOne":this.repeatOne(c);break;case "repeatSwitch":this.repeatSwitch(c);break;case "groupVolume":if("undefined"==typeof b||null==b){c&&c(Error("volume value invalid"));break}this.setGroupVolume(b,c);break;case "groupVolumeUp":this.groupVolumeUp(c);break;case "groupVolumeDown":this.groupVolumeDown(c);break;case "groupMute":this.groupMute(c);break;case "groupUnmute":this.groupUnmute(c);break;case "groupToggleMute":this.groupToggleMute(c);break;case "loudnessOn":this.activateLoudness(c);
break;case "loudnessOff":this.deactivateLoudness(c);break;case "toggleLoudness":this.toggleLoudness(c);break;case "bass":if("undefined"==typeof b||null==b){c&&c(Error("volume value invalid"));break}this.setBass(b,c);break;case "bassUp":this.bassUp(c);break;case "bassDown":this.bassDown(c);break;case "treble":if("undefined"==typeof b||null==b){c&&c(Error("volume value invalid"));break}this.setTreble(b,c);break;case "trebleUp":this.trebleUp(c);break;case "trebleDown":this.trebleDown(c);break;case "balance":if("undefined"==
typeof b||null==b){c&&c(Error("volume value invalid"));break}this.setBalance(b,c);break;case "balanceLeft":this.balanceToLeft(c);break;case "balanceRight":this.balanceToRight(c);break;case "seekTo":if("undefined"==typeof b||null==b){c&&c(Error("seek value invalid"));break}this._renderer.seekRelTimeSec(b,c);break;case "playLineIn":this.playLineIn(c);break;case "playUrl":if("undefined"==typeof b||null==b){c&&c(Error("playUrl url invalid"));break}this.playUrl(b,c);break;case "playUrlwithTimeout":if("undefined"==
typeof b||null==b){c&&c(Error("playUrl url invalid"));break}this.addUrlToQueueAndPlayThenDelete(b,e?e.timeout:0,c);break;default:c&&c(Error("unknown command"))}else c&&c(Error("renderer not initialized"))};d.prototype._getStates=function(a,b){if(this._renderer)if(a&&0!=a.length){var c=function(){d--;0==d&&b&&b(null,e)},e={},d=a.length;-1!=a.indexOf("PLAY_STATE")&&this._renderer.getPlayState(function(a,b){a||(e.transportState=b);c()});-1!=a.indexOf("PLAY_INFO")&&this.getPlayInfo(function(a,b){a||(e.playInfo=
b);c()});-1!=a.indexOf("MUTE")&&this._renderer.isMuted(function(a,b){a||(e.muted=b);c()});-1!=a.indexOf("VOLUME")&&this._renderer.getVolume(function(a,b){a||(e.volume=b);c()});-1!=a.indexOf("PLAY_MODE")&&this.getPlayMode(function(a,b){a||(e.playMode=b);c()});-1!=a.indexOf("GROUP_MUTE")&&this.isGroupMuted(function(a,b){a||(e.groupMuted=b);c()});-1!=a.indexOf("GROUP_VOLUME")&&this.getGroupVolume(function(a,b){a||(e.groupVolume=b);c()});-1!=a.indexOf("BALANCE")&&this.getBalance(function(a,b){a||(e.balance=
b);c()});-1!=a.indexOf("BASS")&&this.getBass(function(a,b){a||(e.bass=b);c()});-1!=a.indexOf("TREBLE")&&this.getTeble(function(a,b){a||(e.treble=b);c()});-1!=a.indexOf("LOUDNESS")&&this.isLoudnessActive(function(a,b){a||(e.loudness=b?"on":"off");c()})}else b&&b(null,{});else b&&b(Error("renderer not initialized"))};d.prototype.playUrl=function(a,b){if(a){var c=this;this._renderer._setAVTransportURI(0,a,null,function(a){a?b&&b(a):c._renderer.play(b)})}else b&&b(Error("url is null"))};d.prototype.addUrlToQueueAndPlayThenDelete=
function(a,b,c){if(a){b||(b=30);var e=this;this._addURItoQueue(0,a,null,0,!0,function(a,d){a?c&&c(a):d&&"undefined"!=typeof d.firstTrackNumberEnqueued&&null!=d.firstTrackNumberEnqueued?e._renderer.seekTrack(d.firstTrackNumberEnqueued,function(a){a?c&&c(a):e._renderer.play(function(a){a?c&&c(a):setTimeout(function(){e._removeAllTracks(0,0,function(a){c&&c(a)})},1E3*b)})}):c&&c(Error("result format invalid"))})}else c&&c(Error("url is null"))};d.prototype.play=function(a,b,c){if(a&&b&&b["class"]&&b.id){var e=
this;a.browseMetaData(b.id,function(a,d){a?c&&c(a):b.res&&b.res.url?e._renderer.playResource({url:b.res.url},d.result,c):c&&c(Error("resource url invalid"))})}else c&&c(Error("play obj invalid"))};d.prototype.addToQueueAndPlay=function(a,b,c){if(a&&b&&b.res&&b.res.url&&b.id){var e=this;b.parentID&&"Q:"==b.parentID.substr(0,2)?this.playFromQueue(a,b,c):a.browseMetaData(b.id,function(a,d){a?c&&c(a):d&&d.meta&&d.meta.res&&"x-sonosapi-stream"==d.meta.res.substr(0,17)?e._renderer.playResource({url:d.meta.res},
d.meta.resMD,c):e._addURI(0,0,b.res.url,d.result,0,!0,function(a,b){a?c&&c(a):b&&"undefined"!=typeof b.firstTrackNumberEnqueued&&null!=b.firstTrackNumberEnqueued?e._renderer.seekTrack(b.firstTrackNumberEnqueued,function(a){a?e.playQueue(c):e._renderer.play(c)}):c&&c(Error("result format invalid"))})})}else c&&c(Error("play obj invalid"))};d.prototype.playQueue=function(a){var b=this;this._renderer._setAVTransportURI(0,"x-rincon-queue:"+this._renderer.uuid+"#0",null,function(c){c?a&&a(c):b._renderer.play(a)})};
d.prototype.playFromQueue=function(a,b,c){if(b.id)if(a=b.id.indexOf("/"),-1==a)c&&c(Error("queue object id is invalid"));else{var e=this;b=b.id.substr(a+1);this._renderer.seekTrack(b,function(a){a?e.playQueue(c):e._renderer.play(c)})}else c&&c(Error("queue object id is null"))};d.prototype.addToQueue=function(a,b,c){if(a&&b&&b.res&&b.res.url&&b.id){var e=this;a.browseMetaData(b.id,function(a,d){a?c&&c(a):e._addURI(0,0,b.res.url,d.result,0,!0,c)})}else c&&c(Error("play obj invalid"))};d.prototype.replaceQueueAndPlay=
function(a,b,c){if(a&&b&&b.res&&b.res.url&&b.id){var e=this;a.browseMetaData(b.id,function(a,d){a?c&&c(a):e._removeAllTracks(0,0,function(a){a?c&&c(a):e._addURI(0,0,b.res.url,d.result,0,!0,function(a,b){a?c&&c(a):b&&"undefined"!=typeof b.firstTrackNumberEnqueued&&null!=b.firstTrackNumberEnqueued?e._renderer.seekTrack(b.firstTrackNumberEnqueued,function(a){a?c&&c(a):e._renderer.play(c)}):c&&c(Error("result format invalid"))})})})}else c&&c(Error("play obj invalid"))};d.prototype.browser=function(a,
b,c,e,d){a?(b||(b=0),c||(c=0),e||(e=0),a.browseChildren(b,c,e,null,function(c,b,e){if(!c&&b)for(var k=0;k<b.length;k++)b[k]&&(b[k].id&&"Q:"==b[k].id.substr(0,2)&&"Q:"==b[k].parentID&&b[k].res&&delete b[k].res,b[k].albumArtURI&&"http://"!=b[k].albumArtURI.substr(0,7)&&(b[k].albumArtURI="http://"+a.ip+":"+a.port+b[k].albumArtURI),b[k].info&&b[k].info.albumArtURI&&"http://"!=b[k].info.albumArtURI.substr(0,7)&&(b[k].info.albumArtURI="http://"+a.ip+":"+a.port+b[k].info.albumArtURI));d&&d(c,b,e)})):d&&
d(Error("play obj invalid"))};d.prototype.getZoneGroupState=function(a){var b=this;this._getZoneGroupState(function(c,e){if(c)a&&a(c);else if(e&&e.zoneGroupState){for(var d=!1,h=0;h<e.zoneGroupState.length;h++){var g=e.zoneGroupState[h];g&&g.coordinator==b.getUUID()&&(d=!0);for(var l=0;l<g.members.length;l++){var k=g.members[l];k&&k.uuid==b.getUUID()&&k.name&&(b.zoneName=k.name)}}a&&a(null,e.zoneGroupState,d)}else a&&a(Error("unknow zone group state"))})};d.prototype.getZoneGroupState=function(a){var b=
this;this._getZoneGroupState(function(c,e){if(c)a&&a(c);else if(e&&e.zoneGroupState){for(var d=!1,h=0;h<e.zoneGroupState.length;h++){var g=e.zoneGroupState[h];g&&g.coordinator==b.getUUID()&&(d=!0);for(var l=0;l<g.members.length;l++){var k=g.members[l];k&&k.uuid==b.getUUID()&&k.name&&(b.zoneName=k.name)}}a&&a(null,e.zoneGroupState,d)}else a&&a(Error("unknow zone group state"))})};d.prototype.playLineIn=function(a){var b=this.getUUID();b?this._renderer.playResource({url:"x-rincon-stream:"+b},"",a):
a&&a(Error("no uuid"))};d.prototype.clearQueue=function(a,b){var c=0;"Q:1"==a&&(c=1);this._removeAllTracks(c,0,b)};d.prototype.volumeUp=function(a){this._setRelativeVolume(0,"Master",5,a)};d.prototype.volumeDown=function(a){this._setRelativeVolume(0,"Master",-5,a)};d.prototype.getPlayInfo=function(a){if(this._renderer){var b=function(b){h--;b?a&&a(b):0==h&&(c&&"x-sonosapi-stream"==c.substr(0,17)&&e&&d&&d.trackMetaData&&(e["class"]&&(d.trackMetaData["class"]=e["class"]),e.title&&(d.trackMetaData.title=
e.title),d.trackMetaData.streamContent&&(d.trackMetaData.artist=d.trackMetaData.streamContent)),d&&d.trackMetaData&&d.trackMetaData.creator&&!d.trackMetaData.artist&&(d.trackMetaData.artist=d.trackMetaData.creator),a&&a(null,d))},c,e,d,h=2,g=this;this._renderer.getPlayInfo(function(a,c){!a&&c&&(c.trackMetaData&&c.trackMetaData.albumArtURI&&"http://"!=c.trackMetaData.albumArtURI.substr(0,7)&&(c.trackMetaData.albumArtURI="http://"+g._renderer.ip+":"+g._renderer.port+c.trackMetaData.albumArtURI),d=c);
b&&b(a);a&&(b=null)});this._renderer.getMediaInfo(function(a,d){!a&&d&&(c=d.currentURI,e=d.currentURIMetaData);b&&b(a);a&&(b=null)})}else a&&a(Error("renderer not initialized"))};d.prototype.getPlayMode=function(a){if(this._renderer){var b=this;this._renderer.getPlayMode(function(c,d){c?a&&a(c):a&&a(null,b._parsePlayMode(d))})}else a&&a(Error("renderer not initialized"))};d.prototype.setPlayMode=function(a,b){this._renderer?(a=this._buildPlayMode(a),this._renderer.setPlayMode(a,b)):b&&b(Error("renderer not initialized"))};
d.prototype._parsePlayMode=function(a){switch(a){case "NORMAL":return{shuffle:"off",repeat:"off"};case "REPEAT_ALL":return{shuffle:"off",repeat:"all"};case "REPEAT_ONE":return{shuffle:"off",repeat:"one"};case "SHUFFLE_NOREPEAT":return{shuffle:"on",repeat:"off"};case "SHUFFLE":return{shuffle:"on",repeat:"all"};case "SHUFFLE_REPEAT_ONE":return{shuffle:"on",repeat:"one"};default:return{shuffle:"off",repeat:"off"}}};d.prototype._buildPlayMode=function(a){var b=a.shuffle;a=a.repeat;b||(b="off");a||(a=
"off");return"off"==b&&"off"==a?"NORMAL":"off"==b&&"all"==a?"REPEAT_ALL":"off"==b&&"one"==a?"REPEAT_ONE":"on"==b&&"off"==a?"SHUFFLE_NOREPEAT":"on"==b&&"all"==a?"SHUFFLE":"on"==b&&"one"==a?"SHUFFLE_REPEAT_ONE":"NORMAL"};d.prototype.isGroupMuted=function(a){this._getGroupMute(0,function(b,c){b?a&&a(b):a&&a(null,"1"==c.currentMute)})};d.prototype.groupMute=function(a){this._setGroupMute(0,!0,function(b,c){b?a&&a(b):a&&a(null,"1"==c.currentMute)})};d.prototype.groupUnmute=function(a){this._setGroupMute(0,
!1,function(b,c){b?a&&a(b):a&&a(null,"1"==c.currentMute)})};d.prototype.groupToggleMute=function(a){var b=this;this.isGroupMuted(function(c,d){c?a&&a(c):d?b.groupUnmute(a):b.groupMute(a)})};d.prototype.getGroupVolume=function(a){this._getGroupVolume(0,function(b,c){b?a&&a(b):a&&a(null,parseInt(c.currentVolume))})};d.prototype.setGroupVolume=function(a,b){a=parseInt(a);0>a&&(a=0);100<a&&(a=100);this._setGroupVolume(0,a,b)};d.prototype.groupVolumeUp=function(a){this._setRelativeGroupVolume(0,5,a)};
d.prototype.groupVolumeDown=function(a){this._setRelativeGroupVolume(0,-5,a)};d.prototype.getBalance=function(a){if(this._renderer){var b=100,c=100,d=2,f=function(f){d--;f?a&&a(f):0==d&&a&&a(null,c-b)};this._renderer._getVolume(0,"LF",function(a,c){!a&&c&&(b=parseInt(c.volume));f&&f(a);a&&(f=null)});this._renderer._getVolume(0,"RF",function(a,b){!a&&b&&(c=parseInt(b.volume));f&&f(a);a&&(f=null)})}else a&&a(Error("renderer not initialized"))};d.prototype.setBalance=function(a,b){a=parseInt(a);100<
a&&(a=100);-100>a&&(a=-100);var c=100,d=100;0>a?d=a+100:0<a&&(c=100-a);var f=2,h=function(a){f--;a?b&&b(a):0==f&&b&&b()};this._renderer._setVolume(0,"LF",c,function(a){h&&h(a);a&&(h=null)});this._renderer._setVolume(0,"RF",d,function(a){h&&h(a);a&&(h=null)})};d.prototype.balanceToLeft=function(a){var b=this;this.getBalance(function(c,d){c?a&&a(c):(d=parseInt(d),b.setBalance(d-5,a))})};d.prototype.balanceToRight=function(a){var b=this;this.getBalance(function(c,d){c?a&&a(c):(d=parseInt(d),b.setBalance(d+
5,a))})};d.prototype.getBass=function(a){this._getBass(0,function(b,c){b?a&&a(b):a&&a(null,parseInt(c.currentBase))})};d.prototype.setBass=function(a,b){a=parseInt(a);10<a&&(a=10);-10>a&&(a=-10);this._setBass(0,a,b)};d.prototype.bassUp=function(a){var b=this;this.getBass(function(c,d){c?a&&a(c):(d=parseInt(d),b.setBass(d+1,a))})};d.prototype.bassDown=function(a){var b=this;this.getBass(function(c,d){c?a&&a(c):(d=parseInt(d),--d,b.setBass(d,a))})};d.prototype.getTeble=function(a){this._getTreble(0,
function(b,c){b?a&&a(b):a&&a(null,parseInt(c.currentTreble))})};d.prototype.setTreble=function(a,b){a=parseInt(a);10<a&&(a=10);-10>a&&(a=-10);this._setTreble(0,a,b)};d.prototype.trebleUp=function(a){var b=this;this.getTeble(function(c,d){c?a&&a(c):(d=parseInt(d),b.setTreble(d+1,a))})};d.prototype.trebleDown=function(a){var b=this;this.getTeble(function(c,d){c?a&&a(c):(d=parseInt(d),--d,b.setTreble(d,a))})};d.prototype.isLoudnessActive=function(a){this._getLoudness(0,"Master",function(b,c){b?a&&a(b):
a&&a(null,"1"==c.currentLoudness)})};d.prototype.activateLoudness=function(a){this._setLoudness(0,"Master",!0,a)};d.prototype.deactivateLoudness=function(a){this._setLoudness(0,"Master",!1,a)};d.prototype.toggleLoudness=function(a){var b=this;this.isLoudnessActive(function(c,d){c?a&&a(c):d?b.deactivateLoudness(a):b.activateLoudness(a)})};d.prototype.shuffleOn=function(a){if(this._renderer){var b=this;this.getPlayMode(function(c,d){c?a&&a(c):(d.shuffle="on",b.setPlayMode(d,a))})}else a&&a(Error("renderer not initialized"))};
d.prototype.shuffleOff=function(a){if(this._renderer){var b=this;this.getPlayMode(function(c,d){c?a&&a(c):(d.shuffle="off",b.setPlayMode(d,a))})}else a&&a(Error("renderer not initialized"))};d.prototype.shuffleToggle=function(a){if(this._renderer){var b=this;this.getPlayMode(function(c,d){c?a&&a(c):(d.shuffle="on"==d.shuffle?"off":"on",b.setPlayMode(d,a))})}else a&&a(Error("renderer not initialized"))};d.prototype.repeatOff=function(a){if(this._renderer){var b=this;this.getPlayMode(function(c,d){c?
a&&a(c):(d.repeat="off",b.setPlayMode(d,a))})}else a&&a(Error("renderer not initialized"))};d.prototype.repeatOne=function(a){if(this._renderer){var b=this;this.getPlayMode(function(c,d){c?a&&a(c):(d.repeat="one",b.setPlayMode(d,a))})}else a&&a(Error("renderer not initialized"))};d.prototype.repeatAll=function(a){if(this._renderer){var b=this;this.getPlayMode(function(c,d){c?a&&a(c):(d.repeat="all",b.setPlayMode(d,a))})}else a&&a(Error("renderer not initialized"))};d.prototype.repeatSwitch=function(a){if(this._renderer){var b=
this;this.getPlayMode(function(c,d){c?a&&a(c):(d.repeat="off"==d.repeat?"all":"all"==d.repeat?"one":"off",b.setPlayMode(d,a))})}else a&&a(Error("renderer not initialized"))};d.prototype._setRelativeVolume=function(a,b,c,d){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"SetRelativeVolume",{InstanceID:a,Channel:b,Adjustment:c},function(a,c){if(a)d&&d(a);else{var b={},l=c.find("NewVolume");0<l.length&&(b.newVolume=
$(l[0]).text());d&&d(null,b)}}):d&&d(Error("renderer not initialized"))};d.prototype._getGroupMute=function(a,b){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.groupRenderingControl.url),this._renderer.groupRenderingControl.type,"GetGroupMute",{InstanceID:a},function(a,d){if(a)b&&b(a);else{var f={},h=d.find("CurrentMute");0<h.length&&(f.currentMute=$(h[0]).text());b&&b(null,f)}}):b&&b(Error("renderer not initialized"))};d.prototype._setGroupMute=function(a,b,c){this._renderer?
this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.groupRenderingControl.url),this._renderer.groupRenderingControl.type,"SetGroupMute",{InstanceID:a,DesiredMute:b?"True":"False"},c):c&&c(Error("renderer not initialized"))};d.prototype._getGroupVolume=function(a,b){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.groupRenderingControl.url),this._renderer.groupRenderingControl.type,"GetGroupVolume",{InstanceID:a},function(a,d){if(a)b&&b(a);else{var f=
{},h=d.find("CurrentVolume");0<h.length&&(f.currentVolume=$(h[0]).text());b&&b(null,f)}}):b&&b(Error("renderer not initialized"))};d.prototype._setGroupVolume=function(a,b,c){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.groupRenderingControl.url),this._renderer.groupRenderingControl.type,"SetGroupVolume",{InstanceID:a,DesiredVolume:b},c):c&&c(Error("renderer not initialized"))};d.prototype._setRelativeGroupVolume=function(a,b,c){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.groupRenderingControl.url),
this._renderer.groupRenderingControl.type,"SetRelativeGroupVolume",{InstanceID:a,Adjustment:b},function(a,b){if(a)c&&c(a);else{var d={},g=b.find("NewVolume");0<g.length&&(d.newVolume=$(g[0]).text());c&&c(null,d)}}):c&&c(Error("renderer not initialized"))};d.prototype._getBass=function(a,b){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"GetBass",{InstanceID:a},function(a,d){if(a)b&&b(a);else{var f={},h=d.find("CurrentBass");
0<h.length&&(f.currentBase=$(h[0]).text());b&&b(null,f)}}):b&&b(Error("renderer not initialized"))};d.prototype._setBass=function(a,b,c){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"SetBass",{InstanceID:a,DesiredBass:b},c):c&&c(Error("renderer not initialized"))};d.prototype._getTreble=function(a,b){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),
this._renderer.renderingControl.type,"GetTreble",{InstanceID:a},function(a,d){if(a)b&&b(a);else{var f={},h=d.find("CurrentTreble");0<h.length&&(f.currentTreble=$(h[0]).text());b&&b(null,f)}}):b&&b(Error("renderer not initialized"))};d.prototype._setTreble=function(a,b,c){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"SetTreble",{InstanceID:a,DesiredTreble:b},c):c&&c(Error("renderer not initialized"))};d.prototype._getLoudness=
function(a,b,c){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"GetLoudness",{InstanceID:a,Channel:b},function(a,b){if(a)c&&c(a);else{var d={},g=b.find("CurrentLoudness");0<g.length&&(d.currentLoudness=$(g[0]).text());c&&c(null,d)}}):c&&c(Error("renderer not initialized"))};d.prototype._setLoudness=function(a,b,c,d){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),
this._renderer.renderingControl.type,"SetLoudness",{InstanceID:a,Channel:b,DesiredLoudness:c?"True":"False"},d):d&&d(Error("renderer not initialized"))};d.prototype._getZoneGroupState=function(a){if(this._renderer){var b=this;this._renderer._doSOAPRequest(this._renderer.getURL(this.zoneGroupTopology.url),this.zoneGroupTopology.type,"GetZoneGroupState",null,function(c,d){if(c)a&&a(c);else{var f={},h=d.find("ZoneGroupState");if(0<h.length)if(h=$(h[0]).text())try{var g=$($.parseXML(h));f.zoneGroupStateRaw=
g;f.zoneGroupState=b._parseZoneGroupState(g)}catch(l){a&&a(l);return}else f.zoneGroupStateRaw="",f.zoneGroupState=null;a&&a(null,f)}})}else a&&a(Error("renderer not initialized"))};d.prototype._parseZoneGroupState=function(a){var b=[];a.find("ZoneGroup").each(function(){var a=$(this),d=a.attr("ID"),f=a.attr("Coordinator");if(d&&f){var h={id:d,coordinator:f,members:[]};a.find("ZoneGroupMember").each(function(){var a=$(this),b=a.attr("UUID"),a=a.attr("ZoneName");b&&a&&h.members.push({uuid:b,name:a})});
b.push(h)}});return b};d.prototype._addURItoQueue=function(a,b,c,d,f,h){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.avTransport.url),this._renderer.avTransport.type,"AddURIToQueue",{InstanceID:a,EnqueuedURI:b,EnqueuedURIMetaData:c,DesiredFirstTrackNumberEnqueued:d,EnqueueAsNext:f?"True":"False"},function(a,b){if(a)h&&h(a);else{var c={},d=b.find("FirstTrackNumberEnqueued");0<d.length&&(c.firstTrackNumberEnqueued=$(d[0]).text());d=b.find("NumTracksAdded");0<d.length&&
(c.numTracksAdded=$(d[0]).text());d=b.find("NewQueueLength");0<d.length&&(c.newQueueLength=$(d[0]).text());h&&h(null,c)}}):h&&h(Error("renderer not initialized"))};d.prototype._addURI=function(a,b,c,d,f,h,g){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.queue.url),this._renderer.queue.type,"AddURI",{QueueID:a,UpdateID:b,EnqueuedURI:c,EnqueuedURIMetaData:d,DesiredFirstTrackNumberEnqueued:f,EnqueueAsNext:h?"True":"False"},function(a,b){if(a)g&&g(a);else{var c={},
d=b.find("FirstTrackNumberEnqueued");0<d.length&&(c.firstTrackNumberEnqueued=$(d[0]).text());d=b.find("NumTracksAdded");0<d.length&&(c.numTracksAdded=$(d[0]).text());d=b.find("NewQueueLength");0<d.length&&(c.newQueueLength=$(d[0]).text());g&&g(null,c)}}):g&&g(Error("renderer not initialized"))};d.prototype._removeAllTracks=function(a,b,c){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.queue.url),this._renderer.queue.type,"RemoveAllTracks",{QueueID:a,UpdateID:b},
function(a,b){if(a)c&&c(a);else{var d={},g=b.find("NewUpdateID");0<g.length&&(d.newUpdateID=$(g[0]).text());c&&c(null,d)}}):c&&c(Error("renderer not initialized"))};d.prototype.toJSON=function(){return{sys:xnm.aio.sonos.DM.SYS,type:"play",ip:this.getIP(),port:this.getPort(),uuid:this.getUUID(),model:this._renderer?this._renderer.modelName:null,name:this.getName(),zoneName:this.zoneName}};d.prototype.equalsTo=function(a){return a&&a instanceof d?this.getIP()==a.getIP()&&this.getPort()==a.getPort():
!1};d.parseJSON=function(a){return a.ip&&a.port?new d(a.ip,a.port,a.uuid,a.name):null};return d}();
xnm.aio.sonos.Discovery=function(){var d=function(a){"undefined"!=typeof require&&require?(this._logger=require("x.logger.js").getLogger("xnm.aio.sonos.Discovery"),require("x.logger.js").setLevel("info","xnm.aio.sonos.Discovery")):this._logger={log:{}};this._upnpCB=null;this._listener=a};d.prototype.search=function(){if(!this._upnpCB){var a=this;this._upnpCB=function(b){a._findUpnpDevice(b)}}var b=require("x.upnp.js").getDiscoveryService();b.addCallback("upnp:rootdevice",this._upnpCB);b.discoverTarget("upnp:rootdevice")};
d.prototype._findUpnpDevice=function(a){if(a)switch(a.deviceType){case "urn:schemas-upnp-org:device:ZonePlayer:1":this._logger.log("trace","find sonos player");this._listener&&this._listener.findPlayer(a);break;case "urn:schemas-upnp-org:device:MediaServer:1":this._logger.log("trace","find media server:"+a.name+" @"+a.ip),this._listener&&this._listener.findMediaServer(a)}};return d}();
xnm.aio.sonos.DM=function(){var d={master:{command:[{type:"enum",name:"play",ref:{value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}},{type:"enum",name:"shuffle on",ref:{value:"shuffleOn"}},{type:"enum",name:"shuffle off",ref:{value:"shuffleOff"}},{type:"enum",name:"toggle shuffle",ref:{value:"shuffleToggle"}},{type:"enum",name:"repeat off",ref:{value:"repeatOff"}},
{type:"enum",name:"repeat all",ref:{value:"repeatAll"}},{type:"enum",name:"repeat one",ref:{value:"repeatOne"}},{type:"enum",name:"switch repeat",ref:{value:"repeatSwitch"}},{type:"int",name:"group volume",ref:{value:"groupVolume",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"group volume up",ref:{value:"groupVolumeUp"}},{type:"enum",name:"group volume down",ref:{value:"groupVolumeDown"}},{type:"enum",name:"group mute",ref:{value:"groupMute"}},{type:"enum",name:"group unmute",ref:{value:"groupUnmute"}},
{type:"enum",name:"group toggle mute",ref:{value:"groupToggleMute"}},{type:"enum",name:"loudness on",ref:{value:"loudnessOn"}},{type:"enum",name:"loudness off",ref:{value:"loudnessOff"}},{type:"enum",name:"toggle loudness",ref:{value:"toggleLoudness"}},{type:"int",name:"set bass",ref:{value:"bass",ext:"%d",extMeta:"-10-10"}},{type:"enum",name:"bass up",ref:{value:"bassUp"}},{type:"enum",name:"bass down",ref:{value:"bassDown"}},{type:"int",name:"set treble",ref:{value:"treble",ext:"%d",extMeta:"-10-10"}},
{type:"enum",name:"treble up",ref:{value:"trebleUp"}},{type:"enum",name:"treble down",ref:{value:"trebleDown"}},{type:"int",name:"set balance",ref:{value:"balance",ext:"%d",extMeta:"-100-100",scale:"5"}},{type:"enum",name:"balance to left",ref:{value:"balanceLeft"}},{type:"enum",name:"balance to right",ref:{value:"balanceRight"}},{type:"int",name:"seek to (seconds)",ref:{value:"seekTo",ext:"%d"}}],status:[{type:"enum",name:"group muted",ref:{value:"groupMuted",options:["true","false"]}},{type:"int",
name:"group volume",ref:{value:"groupVolume",extMeta:"0-100"}},{type:"enum",name:"shuffle state",ref:{value:"shuffle",options:["on","off"]}},{type:"enum",name:"repeat state",ref:{value:"repeat",options:["off","one","all"]}},{type:"enum",name:"loudness state",ref:{value:"loudness",options:["off","on"]}},{type:"int",name:"bass",ref:{value:"bass",extMeta:"-10-10"}},{type:"int",name:"treble",ref:{value:"treble",extMeta:"-10-10"}},{type:"int",name:"balance",ref:{value:"balance",extMeta:"-100-100"}},{type:"string",
name:"play state",ref:{value:"playState",options:"STOPPED PLAYING TRANSITIONING PAUSED_PLAYBACK PAUSED_RECORDING RECORDING NO_MEDIA_PRESENT".split(" ")}},{type:"string",name:"track duration",ref:{value:"duration"}},{type:"int",name:"track duration (seconds)",ref:{value:"durationS"}},{type:"string",name:"track position",ref:{value:"position"}},{type:"int",name:"track position (seconds)",ref:{value:"positionS"}},{type:"string",name:"artist",ref:{value:"artist"}},{type:"string",name:"title",ref:{value:"title"}},
{type:"string",name:"album",ref:{value:"album"}}]},play:{command:[{type:"enum",name:"play",ref:{value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"int",name:"volume",ref:{value:"volume",ext:"%d",
extMeta:"0-100"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"enum",name:"shuffle on",ref:{value:"shuffleOn"}},{type:"enum",name:"shuffle off",ref:{value:"shuffleOff"}},{type:"enum",name:"toggle shuffle",ref:{value:"shuffleToggle"}},{type:"enum",name:"repeat off",ref:{value:"repeatOff"}},{type:"enum",name:"repeat all",ref:{value:"repeatAll"}},{type:"enum",name:"repeat one",ref:{value:"repeatOne"}},{type:"enum",name:"switch repeat",
ref:{value:"repeatSwitch"}},{type:"int",name:"group volume",ref:{value:"groupVolume",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"group volume up",ref:{value:"groupVolumeUp"}},{type:"enum",name:"group volume down",ref:{value:"groupVolumeDown"}},{type:"enum",name:"group mute",ref:{value:"groupMute"}},{type:"enum",name:"group unmute",ref:{value:"groupUnmute"}},{type:"enum",name:"group toggle mute",ref:{value:"groupToggleMute"}},{type:"enum",name:"loudness on",ref:{value:"loudnessOn"}},{type:"enum",
name:"loudness off",ref:{value:"loudnessOff"}},{type:"enum",name:"toggle loudness",ref:{value:"toggleLoudness"}},{type:"int",name:"set bass",ref:{value:"bass",ext:"%d",extMeta:"-10-10"}},{type:"enum",name:"bass up",ref:{value:"bassUp"}},{type:"enum",name:"bass down",ref:{value:"bassDown"}},{type:"int",name:"set treble",ref:{value:"treble",ext:"%d",extMeta:"-10-10"}},{type:"enum",name:"treble up",ref:{value:"trebleUp"}},{type:"enum",name:"treble down",ref:{value:"trebleDown"}},{type:"int",name:"set balance",
ref:{value:"balance",ext:"%d",extMeta:"-100-100",scale:"5"}},{type:"enum",name:"balance to left",ref:{value:"balanceLeft"}},{type:"enum",name:"balance to right",ref:{value:"balanceRight"}},{type:"int",name:"seek to (seconds)",ref:{value:"seekTo",ext:"%d"}},{type:"enum",name:"play line-in",ref:{value:"playLineIn"}}],status:[{type:"enum",name:"muted",ref:{value:"muted",options:["true","false"]}},{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-100"}},{type:"enum",name:"group muted",ref:{value:"groupMuted",
options:["true","false"]}},{type:"int",name:"group volume",ref:{value:"groupVolume",extMeta:"0-100"}},{type:"enum",name:"shuffle state",ref:{value:"shuffle",options:["on","off"]}},{type:"enum",name:"repeat state",ref:{value:"repeat",options:["off","one","all"]}},{type:"enum",name:"loudness state",ref:{value:"loudness",options:["off","on"]}},{type:"int",name:"bass",ref:{value:"bass",extMeta:"-10-10"}},{type:"int",name:"treble",ref:{value:"treble",extMeta:"-10-10"}},{type:"int",name:"balance",ref:{value:"balance",
extMeta:"-100-100"}},{type:"string",name:"play state",ref:{value:"playState",options:"STOPPED PLAYING TRANSITIONING PAUSED_PLAYBACK PAUSED_RECORDING RECORDING NO_MEDIA_PRESENT".split(" ")}},{type:"string",name:"track duration",ref:{value:"duration"}},{type:"int",name:"track duration (seconds)",ref:{value:"durationS"}},{type:"string",name:"track position",ref:{value:"position"}},{type:"int",name:"track position (seconds)",ref:{value:"positionS"}},{type:"string",name:"artist",ref:{value:"artist"}},
{type:"string",name:"title",ref:{value:"title"}},{type:"string",name:"album",ref:{value:"album"}}]}},a=function(a,c){this.code=a;this.message=c;this.stack=Error().stack};a.prototype=Error();a.prototype.name="SonosDMError";a.prototype.code=0;a.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"sonos",getIPDeviceType:function(){return[{sys:this.SYS,name:"Sonos Player",port:1400}]},createDevice:function(b,c,d){c=a.ERROR_CODE;b?b.type?b.ip?d(null,
b):d(new a(c.INVALID,"ip is invalid")):d(new a(c.INVALID,"type is invalid")):d(new a(c.INVALID,"info is invalid"))},updateDevice:function(b,c,d){c=a.ERROR_CODE;b?b.type?b.ip?d(null,b):d(new a(c.INVALID,"ip is invalid")):d(new a(c.INVALID,"type is invalid")):d(new a(c.INVALID,"info is invalid"))},deleteDevice:function(a,c,d){d()},applyUIFilter:function(a,c,d){var f=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},h=function(a,b,c){var d=[];switch(c.catagory){case "command":a.command&&
a.command.forEach(function(a){f(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))});break;case "status":a.status&&a.status.forEach(function(a){f(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))})}return d},g=function(a,b){var c=[],f=null;if(f=xnm.aio.sonos.DM.getCommandStatusMap(a,d))f=h(f,a,b),c=c.concat(f);return c};if(!a.sys)return null;var l=JSON.parse(JSON.stringify(a)),k=null;switch(c.catagory){case "command":k=g(a,c);l.command=k;break;case "status":k=g(a,c);l.status=
k;break;default:return null}return k&&0!=k.length?l:null},getCommandStatusMap:function(a,c){return a.type?d[a.type]:null}}}();
xnm.aio.sonos.Handler=function(){var d=function(){this.detectedPlayers={};this._master=new xnm.aio.sonos.Master};d.prototype.discoverPlayers=function(a){var b=require("x.upnp.js");if(b){var c=this;b.discoverDevices(function(b){if("sonos"==b.type){var d=new xnm.aio.sonos.Player(b.ip,1400,b.uuid,b.name);c.detectedPlayers[b.uuid]=d;a(d)}})}};d.prototype.getStateValues=function(a,b){return(new xnm.aio.sonos.Player).getStateValues(b)};d.prototype.getDeviceCommandList=function(a,b){var c=[];c.push({id:window.XC_Text.pplay,
cmd:"play"});c.push({id:window.XC_Text.ppause,cmd:"pause"});if(!b){c.push({id:window.XC_Text.pstop,cmd:"stop"});for(var d=0;100>=d;d+=5)c.push({id:window.XC_Text.volume+" "+d+"%",cmd:""+d})}return c};d.prototype.getDevice=function(a){return new xnm.aio.sonos.Player(a.address,a.port)};d.prototype.devicemanager=xnm.aio.sonos.DM;d.prototype.Player=xnm.aio.sonos.Player;d.prototype.registModule=function(a){a.register(xnm.aio.sonos.DM.SYS,"sonos")};d.prototype.resolveDevice=function(a){return a?this._master.getPlayer(a):
null};d.prototype.getDeviceCommands=function(a,b){var c=xnm.aio.sonos.DM.applyUIFilter(a,{catagory:"command",elems:"*"}),c=c?c.command:[];b&&b(null,c)};d.prototype.getDeviceStatus=function(a,b){var c=xnm.aio.sonos.DM.applyUIFilter(a,{catagory:"status",elems:"*"}),c=c?c.status:[];b&&b(null,c)};d.prototype.doCommand=function(a,b,c){var d=this.resolveDevice(a);d?d.executeCommandCreator(a,b,function(a){c&&c(a)}):c&&c(Error("device json format invalid"))};d.prototype.doStatus=function(a,b,c,d){var f=this.resolveDevice(b);
f?f.getStatesCreator(null,[{id:a,device:b,status:c}],function(a,b){a?d&&d(a):d&&d(null,b[0])}):d&&d(Error("device json format invalid"))};d.prototype.discoverWithTimeout=function(a,b){var c=this;this._master.search(function(){for(var a=c._master.getBufferedPlayers(),d=[],h=0;h<a.length;h++)d.push(a[h]);d.push(c._master);b&&b(null,d)})};d.prototype.getPlayer=function(a,b){if(a&&a.uuid&&a.type)if("master"==a.type)b&&b(null,this._master);else{var c=this._master.getPlayer(a.uuid);if(c)b&&b(null,c);else{var d=
this;this._master.search(function(){c=d._master.getPlayer(a.uuid);b&&b(null,c)})}}else b&&b(Error("device json invalid"))};d.prototype.getMediaServer=function(a){var b=this._master.getBufferedMediaServers();if(0==b.length){var c=this;this._master.search(function(){a&&a(null,c._master.getBufferedMediaServers())})}else a&&a(null,b)};return d}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.sonos.Handler);
