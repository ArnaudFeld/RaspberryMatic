var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.commandhandler=xnm.aio.commandhandler||{};
xnm.aio.commandhandler.CommandHandler=function(f){this.SystemData=f;this._states={};this.isInRemoteMode=this.isInDemoMode=!1;this.getStatesCallback=this.RemoteController=null;this.getCurrentState=function(a){return void 0!=this._states[a]?this._states[a]:"?"};this.setState=function(a,b,c){this._states[a]=b;this.RemoteController&&(this.RemoteController.currentPage&&this.RemoteController.currentPage.updatedState(a,b),this.RemoteController.refreshStates&&this.RemoteController.refreshStates())};this.receivedState=
function(a,b,c,e){var h=this;"hue"==a?this.SystemData.$devicesXML.find("gateways gateway[type='"+a+"']").each(function(){var d=$(this);h.SystemData.$devicesXML.find("devices device[gateway='"+d.attr("id")+"']").each(function(){var d={},g=$(this),e=g.attr("data");g.attr("subtype")&&(e=g.attr("subtype"));if(g.attr("address")==b){var f=g.parent().attr("id")+"."+g.attr("id");"hue"==a&&(d=require("xnm.aio.hue.js").getStateValues({type:e},c))}for(var n in d)"state"==n?h.setState(f,d[n]):h.setState(f+":"+
n,d[n])})}):"sonos"!=a&&"wemo"!=a&&"orvibo"!=a&&"edimax"!=a&&"kt"!=a&&"siegenia"!=a||h.SystemData.$devicesXML.find("devices device[address='"+b+"']").each(function(){var b={},b=$(this),e=b.parent().attr("id")+"."+b.attr("id"),g=b.attr("data");b.attr("subtype")&&(g=b.attr("subtype"));var b=require("xnm.aio."+a+".js").getStateValues({type:g},c),f;for(f in b)"state"==f?h.setState(e,b[f]):h.setState(e+":"+f,b[f])})};this._executeDemoCommand=function(a,b){var c=b.location+"."+b.id;b.channel&&(c=c+":"+
b.channel);var e=a;"toggle"==a?e="on"==this._states[c]?"off":"off"==this._states[c]?"on":"0"==this._states[c]?"100":"0":"up"==a?(e=parseInt(this._states[c])+5,100<e&&(e=100),e=""+e):"down"==a?(e=parseInt(this._states[c])-5,0>e&&(e=0),e=""+e):"moveUp"==a?e="0":"moveDown"==a&&(e="100");this.setState(c,e);"PE"==b.type?"on"==e?this.setState(c+":current","123"):"off"==e?this.setState(c+":current","0"):this.setState(c+":current","?"):"FHT80B"==b.type&&(XC.debugf("FHT80b: "+a),c=b.location+"."+b.id,e=this._states[c+
":MC"],"setManu"==a?(this.setState(c+":M","manu",!0),this.setState(c+":MC",e.substr(0,e.length-4)+"manu")):"setAuto"==a?(this.setState(c+":M","auto",!0),this.setState(c+":MC",e.substr(0,e.length-4)+"auto")):(this.setState(c+":T",a,!0),this.setState(c+":MC",(5*a/10).toFixed(1)+"\u00b0"+e.substr(e.length-5))));this.getStatesCallback&&this.getStatesCallback()};this._executeGroupCommand=function(a,b){var c=this,e=a.split(":");2==e.length&&"lamella"==e[1]&&(a=e[0],b="L"+b);this.SystemData.$devicesXML.find("groups device[id='"+
a+"'] ref").each(function(){var a=$(this);XC.debugf("execute group command: "+a.text()+"."+b);c.execute(a.text()+"."+b,null,!0)})};this.execute=function(a,b,c,e){b=a.split(".");if(3==b.length)if("M:L1"==b[2]||"M:L2"==b[2])c=new xnm.aio.commandhandler.Macro(this,null,e),c.addCommand(b[0]+"."+b[1]+".moveUp"),"M:L1"==b[2]&&(c.addCommand("SLEEP 3500"),c.addCommand(b[0]+"."+b[1]+".moveDown"),c.addCommand("SLEEP 4500")),"M:L2"==b[2]&&(c.addCommand("SLEEP 8000"),c.addCommand(b[0]+"."+b[1]+".moveDown"),c.addCommand("SLEEP 8000")),
c.addCommand(b[0]+"."+b[1]+".stop"),c.start();else if(b[0]=="["+window.XC_Text.groups+"]")this._executeGroupCommand(b[1],b[2]);else if("[OVERVIEW]"==b[0]){var h=this;this.SystemData.$devicesXML.find("gateways gateway").each(function(){var a=$(this);if("aiogateway"==a.attr("type")){var b=new (require("xnm.aio.gateway.js").Gateway)(a.attr("ip"));h.isInRemoteMode&&b.setRemoteAccessMode(a.attr("sid"));b.executeRequest("SIAUGreset",null,function(a,c){b.getStates(h)})}})}else XC.debugf("execute gatewaycommand: "+
a),this.isInDemoMode||(this._states[b[0]+"."+b[1]]=b[2]),(a=this.SystemData.getDeviceData(b[0]+"."+b[1]))&&(c?this.executeCommand(b[2],a,e,!1):this.executeCommand(b[2],a,e,!0));else 2==b.length?(c=new xnm.aio.commandhandler.Macro(this,a,e),c.start()):0<a.indexOf("://")&&window.XC&&window.XC.callHost&&window.XC.callHost("SYSTEM","startApp",{scheme:a})};this.executeCommand=function(a,b,c,e){XC.debugf("execute command: "+a);if(this.isInDemoMode)this._executeDemoCommand(a,b),c&&c.call();else{if("CODE"==
b.type&&(b.code||this.SystemData.$ircodesXML.find("ircodes device[id='"+b.data+"'] key[id='"+a+"']").each(function(){b.code=$(this).attr("code")}),b.code)){var h=!1,d=b.code;0==d.indexOf("JS:")?(h=d.split(":"),4==h.length&&(new (require("xnm.aio.jointspace.js").Device)(h[1])).executeCommand(h[2],h[3],c),h=!0):0==d.indexOf("http:")||0==d.indexOf("HTTP:")?(new HTTPDevice,new (require("xnm.aio.commandhandler.js").executeHTTPCommand)(d,c),h=!0):0<d.indexOf("://")&&(window.XC&&window.XC.callHost&&window.XC.callHost("SYSTEM",
"startApp",{scheme:d}),h=!0);if(h)return}var k=this,g=this.SystemData.getGateway(b.gateway);if(g&&"aiogateway"==g.attr("type")){var f=new (require("xnm.aio.gateway.js").Gateway)(g.attr("ip"));this.isInRemoteMode&&f.setRemoteAccessMode(g.attr("sid"));f.executeCommand(a,b,function(){c&&c.call();e&&(k.isInRemoteMode?setTimeout(function(){f.getStates(k)},1E3):"IN"!=b.type||"fan"!=b.data&&"fanV2"!=b.data?f.getStates(k):(f.CommandHandler=k,f.executeRequest("ingetstate",{adr:b.address},function(a){a&&a.data&&
a.data.state&&f.evaluateINState(b.location+"."+b.id,b.data,a.data.state)})))})}else if(g&&"allone"==g.attr("type"))(a=require("xnm.aio.orvibo.js").getDevice({address:g.attr("udn")}))&&a.sendIR(b.code,function(){c&&c.call()});else if(g&&"hcgw"==g.attr("type")){var m=require("xnm.aio.hcgw.js"),n=m.getSignal(b.type,b.address,a);a=m.getDetectedGateways();if($.isEmptyObject(a))m.discoverGateways(function(a){$.isEmptyObject(a)&&(a={},g.children().each(function(){var b=$(this),c=new m.Gateway(b.attr("ip"));
"1"==b.attr("mode")&&(c.mode=1);a[b.attr("ip")]=c}));m.sendSignalToGateways(n,a,function(){c&&c.call()})});else{m.sendSignalToGateways(n,a,function(){e&&m.discoverGateways();c&&c.call()});h=g.getXMLString();g.children().remove();for(var l in a)d=$(this.SystemData.$devicesXML.get(0).createElement("transmitter")),d.attr("ip",l),d.attr("mode",a[l].mode),d.appendTo(g);h!=g.getXMLString()&&this.SystemData.saveData("devices")}}else if(k.isInRemoteMode)c&&(XC.debugf("executed command for unknown gateway"),
c.call());else if(g&&"hue"==g.attr("type")){var q=new (require("xnm.aio.hue.js").Bridge)(g.attr("ip"),g.attr("port"));q.executeCommand(b,a,function(){XC.debugf("executed hue command");c&&c.call();e&&q.getStates(k)})}else if(g&&"hm"==g.attr("type")){var r=new (require("xnm.aio.hm.js").CCU)(g.attr("ip"));r.executeCommand(b,a,function(){XC.debugf("executed hm command");c&&c.call();b.id&&(0>b.id.indexOf(".")&&(b.id=b.location+"."+b.id),e&&r.getStates(k,[b],function(a,b){if(!a&&b)for(var c=0;c<b.length;c++)k.setState(b[c].id,
b[c].status)}))})}else if(g&&"fritzbox"==g.attr("type")){var t=new (require("xnm.aio.fritz.js").Box)(g.attr("ip"),g.attr("pwd"));t.executeCommand(b,a,function(){XC.debugf("executed fritz command");c&&c.call();b.id=b.location+"."+b.id;e&&t.getStates(k,[b])})}else if(g&&"alpha2"==g.attr("type")){var u=new (require("xnm.aio.moehlenhoff.js").Alpha2)(g.attr("ip"));u.executeCommand(b,a,function(){XC.debugf("executed moehlenhoff command");c&&c.call();b.id=b.location+"."+b.id;e&&u.getStates(k,[b])})}else if(g)XC.debugf("executeCommand for unknown gatewaytype");
else if(h=b.type,"wemo"==h||"orvibo"==h||"edimax"==h||"kt"==h||"sonos"==h||"siegenia"==h){l={address:b.address,data:b.data};"wemo"==h?(l.port=49154,h=b.address.split(":"),2==h.length&&(l.address=h[0],l.port=h[1])):"sonos"==h?l.port=1400:"siegenia"==h&&(l.pwd=b.pwd);var p=require("xnm.aio."+b.type+".js").getDevice(l);p?p.executeCommand(null,a,function(){XC.debugf("executed "+b.type+" command");c&&c.call();e&&p.getStates(k)}):c&&c.call()}else"aiogateway"==h&&(f=new (require("xnm.aio.gateway.js").Gateway)(b.address),
f.executeGatewayCommand(a,function(){c&&c.call()}))}};this.getStatesForDevice=function(a,b){if(a.attr){var c={};c.id=a.parent().attr("id")+"."+a.attr("id");c.type=a.attr("type");c.address=a.attr("address");c.data=a.attr("data");c.subtype=a.attr("data");c.pwd=a.attr("pwd");a.attr("subtype")&&(c.subtype=a.attr("subtype"));a.attr("gateway")&&(c.gateway=a.attr("gateway"));a=c}if("alpha2"==a.type)c=$(this.SystemData.$devicesXML.find("gateways gateway[id='"+a.gateway+"']")),(new (require("xnm.aio.moehlenhoff.js").Alpha2)(c.attr("ip"))).getStates(this,
a,b);else if("sonos"==a.type||"wemo"==a.type||"orvibo"==a.type||"edimax"==a.type||"kt"==a.type||"siegenia"==a.type)"wemo"==a.type?(a.port=49154,c=a.address.split(":"),2==c.length&&(a.address=c[0],a.port=c[1])):"sonos"==a.type&&(a.port=1400),(c=require("xnm.aio."+a.type+".js").getDevice(a))&&c.getStates(this,a,b)};this.getStatesForLocations=function(a){for(var b={},c=[],e=0;e<a.length;e++)a[e].find("device").each(function(){var a=$(this),d=a.attr("gateway");d&&!b[d]&&(b[d]=[]);var e={};e.id=a.parent().attr("id")+
"."+a.attr("id");e.type=a.attr("type");e.data=a.attr("data");e.address=a.attr("address");e.pwd=a.attr("pwd");e.subtype=a.attr("data");a.attr("subtype")&&(e.subtype=a.attr("subtype"));d?b[d].push(e):c.push(e)});var h=!1,d;for(d in b){var f=this;this.SystemData.$devicesXML.find("gateways gateway[id='"+d+"']").each(function(){var a=$(this);if("aiogateway"==a.attr("type")){var c=new (require("xnm.aio.gateway.js").Gateway)(a.attr("ip"));f.isInRemoteMode&&c.setRemoteAccessMode(a.attr("sid"));c.getStates(f,
b[d]);h=!0}else if("hm"==a.attr("type"))(new (require("xnm.aio.hm.js").CCU)(a.attr("ip"))).getStates(f,b[d],function(a,b){if(!a&&b)for(var c=0;c<b.length;c++)f.setState(b[c].id,b[c].status)});else if("fritzbox"==a.attr("type"))(new (require("xnm.aio.fritz.js").Box)(a.attr("ip"),a.attr("pwd"))).getStates(f,b[d]);else if("alpha2"==a.attr("type"))(new (require("xnm.aio.moehlenhoff.js").Alpha2)(a.attr("ip"))).getStates(f,b[d]);else if(!f.isInRemoteMode&&"hue"==a.attr("type")){var e=new (require("xnm.aio.hue.js").Bridge)(a.attr("ip"),
a.attr("port"));e.getStates(f,b[d],function(a){"AUT"==a&&window.setTimeout(function(){XC.showConfirm(window.XC_Text.t_hueauth,function(){e.authorizeUser()},null)},0)})}})}if(!this.isInRemoteMode)for(e=0;e<c.length;e++)this.getStatesForDevice(c[e]);h||this.getStatesCallback&&this.getStatesCallback()};this.computeSIAUOverviewStates=function(){var a=this,b="closed",c="ok",e="ok",f="off";this.SystemData.$devicesXML.find("locations location device").each(function(){var d=$(this),k="";if("door"==d.attr("data")||
"window"==d.attr("data")||"genius"==d.attr("data")){var g=a.getCurrentState(d.parent().attr("id")+"."+d.attr("id"));"closed"!=g&&"closed_night"!=g&&"open_night"!=g&&(b="alert");a._states["[OVERVIEW].window-door"]=b}"smoke"==d.attr("data")&&("ok"!=a.getCurrentState(d.parent().attr("id")+"."+d.attr("id"))&&(c="alert"),a._states["[OVERVIEW]."+d.attr("data")]=c);"glass"==d.attr("data")&&("ok"!=a.getCurrentState(d.parent().attr("id")+"."+d.attr("id"))&&(e="alert"),a._states["[OVERVIEW]."+d.attr("data")]=
e);"HM"==d.attr("type")?(new (require("xnm.aio.gateway.js").Systems.HM),"dimmer"==d.attr("data")?k="dimmer":"switch"==d.attr("data")?k="switch":"light"==d.attr("data")?k="light":"meteringSwitch"==d.attr("data")&&(k="meteringSwitch")):"PE"==d.attr("type")&&"switch"==d.attr("data")&&(k="switch");if("light"==k||"dimmer"==k||"switch"==k||"meteringSwitch"==k)d=a.getCurrentState(d.parent().attr("id")+"."+d.attr("id")),"off"!=d&&"?"!=d&&"0"!=d&&(f="on"),a._states["[OVERVIEW].light-socket"]=f})};this.computeEscoOverviewStates=
function(){var a=this,b="closed",c="off",e="off",f="open";this.SystemData.$devicesXML.find("locations location device").each(function(){var d=$(this),k=d.attr("data");if("HM"==d.attr("type"))if(new (require("xnm.aio.gateway.js").Systems.HM),"door"==k||"window"==k||"esco-window"==k)d=a.getCurrentState(d.parent().attr("id")+"."+d.attr("id")),"closed"!=d&&"?"!=d&&"off"!=d&&"0"!=d&&(b="alert"),a._states["[OVERVIEW].window-door"]=b;else if("light"==k||"dimmer"==k)d=a.getCurrentState(d.parent().attr("id")+
"."+d.attr("id")),"off"!=d&&"?"!=d&&(c="alert"),a._states["[OVERVIEW].light"]=c;else if("switch"==k||"meteringSwitch"==k)d=a.getCurrentState(d.parent().attr("id")+"."+d.attr("id")),"off"!=d&&"?"!=d&&(e="alert"),a._states["[OVERVIEW].switch"]=e;else if("shutter"==k||"blind"==k||"awning"==k)d=a.getCurrentState(d.parent().attr("id")+"."+d.attr("id")),"off"!=d&&"?"!=d&&"0"!=d&&"0.5"!=d&&(f="alert"),a._states["[OVERVIEW].shutter"]=f})}};
xnm.aio.commandhandler.Macro=function(f,a,b){this._commandHandler=f;this._callback=b;this._commands=[];this._currentCommand=0;this._pause=250;if(a&&(f=a.split("."),2==f.length)){var c=this;this._commandHandler.SystemData.$macrosXML.find("location[id='"+f[0]+"'] macro[id='"+f[1]+"']").each(function(){$this=$(this);$this.children().each(function(){var a=$(this),b=a.attr("action"),d=a.attr("time"),a=a.attr("sleep");b&&1<b.length?c.addCommand(b):d&&1<d.length?c.addCommand("SLEEP "+d):a&&1<a.length&&c.addCommand("SLEEP "+
a)})});f=this._commands.length;for(a=0;a<f;a++)if("IN"==this._commands[a].data.type&&6<this._commands[a].command.length&&"moveTo"==this._commands[a].command.substr(0,6))for(b=0;b<f;b++)"IN"==this._commands[b].data.type&&this._commands[a].data.address==this._commands[b].data.address&&1<this._commands[b].command.length&&"L"==this._commands[b].command.substr(0,1)&&(this._commands[a].command+=this._commands[b].command,this._commands[b].removed=!0)}};
xnm.aio.commandhandler.Macro.prototype.addCommand=function(f){var a=f.split(".");3==a.length?(f=this._commandHandler.SystemData.$devicesXML.find("locations location[id='"+a[0]+"'] device[id='"+a[1]+"']"))&&0<f.length&&($d=$(f[0]),data={},data.type=$d.attr("type"),data.address=$d.attr("address"),data.data=$d.attr("data"),data.gateway=$d.attr("gateway"),this._commands.push({type:"CMD",command:a[2],data:data})):2==a.length?(f=this._commandHandler.SystemData.$devicesXML.find("devices gateways gateway[id='"+
a[0]+"']"))&&0<f.length&&($g=$(f[0]),data={},data.type=$g.attr("type"),data.address=$g.attr("ip"),this._commands.push({type:"CMD",command:a[1],data:data})):1==a.length&&(a=f.split(" "),2==a.length&&"SLEEP"==a[0]&&this._commands.push({type:"SLEEP",command:a[1],data:{}}))};xnm.aio.commandhandler.Macro.prototype.start=function(){for(var f=[],a=this._commands.length-1;0<=a;a--)this._commands[a].removed||f.push(this._commands[a]);this._commands=f;this._executeNextCommand(!0)};
xnm.aio.commandhandler.Macro.prototype._executeNextCommand=function(f){if(this._commandHandler&&0<this._commands.length){var a=this._commands.pop(),b=this;"CMD"==a.type&&(f?this._commandHandler.executeCommand(a.command,a.data,function(){b._executeNextCommand()}):setTimeout(function(){b._commandHandler.executeCommand(a.command,a.data,function(){b._executeNextCommand()})},b._pause));"SLEEP"==a.type&&setTimeout(function(){b._executeNextCommand(!0)},parseInt(a.command))}else XC.debugf("macro finished"),
this._callback&&this._callback()};xnm.aio.commandhandler.Handler=function(){};xnm.aio.commandhandler.Handler.prototype.CommandHandler=xnm.aio.commandhandler.CommandHandler;xnm.aio.commandhandler.Handler.prototype.Macro=xnm.aio.commandhandler.Macro;xnm.aio.commandhandler.Handler.prototype.executeHTTPCommand=function(f,a){$.ajax({type:"GET",url:f,timeout:3E3,cache:!1,complete:function(b){a&&a.call()}})};
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.commandhandler.Handler);
