var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,f,e){a!=Array.prototype&&a!=Object.prototype&&(a[f]=e.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(a,f,e,n){if(f){e=$jscomp.global;a=a.split(".");for(n=0;n<a.length-1;n++){var m=a[n];m in e||(e[m]={});e=e[m]}a=a[a.length-1];n=e[a];f=f(n);f!=n&&null!=f&&$jscomp.defineProperty(e,a,{configurable:!0,writable:!0,value:f})}};$jscomp.polyfill("Object.is",function(a){return a?a:function(a,e){return a===e?0!==a||1/a===1/e:a!==a&&e!==e}},"es6","es3");
$jscomp.polyfill("Array.prototype.includes",function(a){return a?a:function(a,e){var f=this;f instanceof String&&(f=String(f));var m=f.length;for(e=e||0;e<m;e++)if(f[e]==a||Object.is(f[e],a))return!0;return!1}},"es7","es3");
$jscomp.checkStringArgs=function(a,f,e){if(null==a)throw new TypeError("The 'this' value for String.prototype."+e+" must not be null or undefined");if(f instanceof RegExp)throw new TypeError("First argument to String.prototype."+e+" must not be a regular expression");return a+""};$jscomp.polyfill("String.prototype.includes",function(a){return a?a:function(a,e){return-1!==$jscomp.checkStringArgs(this,a,"includes").indexOf(a,e||0)}},"es6","es3");
$jscomp.owns=function(a,f){return Object.prototype.hasOwnProperty.call(a,f)};$jscomp.polyfill("Object.assign",function(a){return a?a:function(a,e){for(var f=1;f<arguments.length;f++){var m=arguments[f];if(m)for(var b in m)$jscomp.owns(m,b)&&(a[b]=m[b])}return a}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.commandhandler=xnm.aio.commandhandler||{};
xnm.aio.commandhandler.CommandHandler=function(a,f,e,n,m){this.SystemData=a;this.RulesManager=f;this.RemoteHandler=n;this.CloudHandler=m;this.gwModule=require("xnm.aio.gateway.js");this.CFG=e;this._persistentAioKeys=["_lastCF3colorSeq","_lastCF4colorSeq"];this._persistentAioData={};this._states={};this.RemoteController=null;this._updateReceivers=[];this.getStatesCallback=null;this.getCurrentState=function(b){return void 0!==this._states[b]?this._states[b]:"?"};this.setState=function(b,c){this._states[b]!=
c&&(this._states[b]=c,this._updateReceivers.forEach(function(a){a.filter(b)&&a.callback(b.substr(b.indexOf(":")+1),c)}.bind(this)))};this.deleteDeviceStates=function(b){for(var c in this._states)this._states.hasOwnProperty(c)&&parseInt(c.split(":")[0])===b&&delete this._states[c]};this.subscribe=function(b,c,a){var d={filter:b,callback:c,refresh:a};this._updateReceivers.push(d);return{unsubscribe:function(b){return function(){var g=b.indexOf(d);-1!==g&&b.splice(g,1)}}(this._updateReceivers)}};this.subscribeForDevice=
function(b,c,a){var d=b.index;return this.subscribe(function(b){return+b.split(":")[0]===d},c,a)};this.clearSubscribers=function(){this._updateReceivers=[]};this.subscribeForStateOnDevices=function(b,a,h){return this.subscribe(function(b){var c=b.split(":")[0];return a.some(function(b){return b.index===+c})},function(a,c){b.some(function(b){return a===b})&&h(c)})};this.refreshSubscribers=function(){this._updateReceivers.forEach(function(b){void 0!==b.refresh&&b&&b.refresh()}.bind(this))};this.receivedState=
function(b,a,h,d){var c=this;"hue"===b?this.SystemData.getGateways(function(a){return a.info.sys===b}).forEach(function(c){this.SystemData.getDevices(function(b){return b.info.gateway===c.index}).forEach(function(c){var g={},d="",l=c.info.data;c.info.subtype&&(l=c.info.subtype);c.info.address==a&&(d=c.room+"."+c.index,"hue"===b&&(g=require("xnm.aio.hue.js").getStateValues({type:l},h),g.rgb=h.rgb,g.effect=h.effect));for(var e in g)"state"==e?this.setState(d,g[e]):this.setState(d+":"+e,g[e])}.bind(this))}.bind(this)):
("sonos"==b||"wemo"==b||"orvibo"==b||"edimax"==b||"kt"==b||"siegenia"==b||"lightify"==b)&&c.SystemData.getDevices(function(b){return b.info.address===a}).forEach(function(a){XC.debugf(a);XC.debugf(h);var g=a.room+"."+a.index,d=a.data;a.subtype&&(d=a.subtype);"lightify"===b&&(b="osram");a=require("xnm.aio."+b+".js").getStateValues({type:d},h);"osram"===b&&(a.rgb=""+XC.getHexVal(h.red,2)+XC.getHexVal(h.green,2)+XC.getHexVal(h.blue,2),a.ct=h.colorTemp);for(var l in a)"state"==l?c.setState(g,a[l]):c.setState(g+
":"+l,a[l])})};this.execute=function(b,a,h,d){var c=this.SystemData.getDevices(function(a){return a.index==b})[0];c&&this.executeCommand(a,c.info,h,d)};this.executeCommand=function(b,a,h,d){var c=this,g=this,e=a.gateway,p=a.sys,k=this.SystemData.getGateways(function(b){return b.index===e})[0];if(k&&("aio"===p||"hm"===p)){var f=this.gwModule.resolveGateway(k.info);f.CommandHandler=this;this._restoreAioData(f);k.info.server&&f.setRemoteUrl("https://"+this.CFG.links.cloudAccessServer+"/rapi/live/");
k.info.password&&(f._at=this.hash(k.info.password));var m=this.RemoteHandler.isRemote();f.setCloudAccess(m);m&&(h=!0);f.executeCommandCreator(null,{value:m?"raOn":"raOff"});f.executeCommandCreator(a,b,function(l){c._saveAioData(f);XC.debugf("Executed Gateway Command: "+a.sys+" "+b+(m?" (remote)":" (local)"));h&&setTimeout(function(){return f.getStates(g)},1E3);d&&d(l)})}else if(!this.RemoteHandler.isRemote())if(k&&"fritzbox"===p){var n=new (require("xnm.aio.fritz.js").Box)(k.info.ip,k.info.password);
n.executeCommand(a,b,function(){XC.debugf("executed fritz command");d&&d.call();a.id=a.location+"."+a.id;h&&n.getStates(g,[a])})}else if(k&&"alpha2"===p){var t=new (require("xnm.aio.moehlenhoff.js").Alpha2)(k.info.ip);t.executeCommandCreator(a,b,function(){XC.debugf("executed moehlenhoff command");d&&d.call();a.id=a.location+"."+a.id;h&&t.getStates(g,[a])})}else if(k)XC.debugf("executeCommand for unknown gatewaytype");else if("wemo orvibo edimax kt sonos siegenia".split(" ").includes(p)){k={address:a.address,
data:a.data};if("wemo"===p){k.port=49154;var q=a.address.split(":");2==q.length&&(k.address=q[0],k.port=q[1])}"sonos"===p&&(k.port=1400,k.address=a.ip);"siegenia"===p&&(k.pwd=a.pwd);var r=require("xnm.aio."+p+".js").getDevice(k);r?r.executeCommandCreator(k,b,function(b,a){XC.debugf("executed "+p+" command");"siegenia"===p?d&&d.call(null,b,a):d&&d.call();h&&r.getStates(g)}):d&&d.call()}else"aiogateway"===p&&(f=new this.gwModule.Gateway(a.address),f.executeGatewayCommand(b,function(){d&&d.call()}))};
this._restoreAioData=function(b){if(this._persistentAioData[b._mac])for(var a in this._persistentAioData[b._mac])b[a]=this._persistentAioData[b._mac][a];else this._persistentAioData[b._mac]={}};this._saveAioData=function(a){var b=this;this._persistentAioKeys.forEach(function(c){c in a&&(b._persistentAioData[a._mac][c]=a[c])})};this.hash=function(a){a=String(a);return require("x.crypt.js").MD5(unescape(encodeURI(a+"_SALT!")))};this.getStatesForDevice=function(a,c){var b=this;if(a.info&&"cloudservice"===
a.info.sys)try{(new this.CloudHandler).getModuleStates(a.info.module,function(c,d){b.deleteDeviceStates(a.index);if(d&&(c=d[a.info.connection])&&(c=c[a.info.id])&&c.states)for(var l in c.states)b.setState(a.index+":"+l,c.states[l])})}catch(g){throw XC.debugf(g),g;}else if(!this.RemoteHandler.isRemote()){var d=a.sys;if(-1!=="sonos wemo orvibo edimax kt siegenia".split(" ").indexOf(d)){if("wemo"===d){a.port=49154;var l=a.address.split(":");2===l.length&&(a.address=l[0],a.port=l[1])}"sonos"===d&&(a.port=
1400);(d=require("xnm.aio."+d+".js").devicemanager.getCommandStatusMap(a))&&d.getStates(this,a,c)}}};this.getStatesForDevices=function(a,c){var b={},d=[];this._orderByGateway(a,b,d);this.getStatesPerGateway(b,d,c)};this.getStatesForLocations=function(a,c){var b=this,d={},l=[];a.forEach(function(a){var f=b.SystemData.getDevices(function(b){return b.room===a.index});b._orderByGateway(f,d,l,c)});this.getStatesPerGateway(d,l)};this._orderByGateway=function(a,c,f,d){a.forEach(function(a){if("cloudservice"===
a.info.sys){if(!d)return;var b=a}else b=Object.assign({},a.info),b.id=a.index,b.type=a.info.sys,b.subtype=a.info.subtype?a.info.subtype:a.info.data;(a=a.info.gateway)?(c[a]||(c[a]=[]),c[a].push(b)):f.push(b)})};this.getStatesPerGateway=function(a,c,f){for(var b in a){var e=this.SystemData.getGateways(function(a){return a.index==b})[0],g=e.info.sys,h=a[b];"aio"===g?(g=this.gwModule.resolveGateway(e.info),this.RemoteHandler.isRemote()&&(g.setRemoteAccessMode(e.info.sid),g.setRemoteUrl("https://"+this.CFG.links.cloudAccessServer+
"/rapi/live/"),g._at=this.hash(e.info.password)),g.getStates(this,h,function(a,b){null==a&&f&&f(Error("Error getting states "+b))})):"hm"===g?(XC.debugf("GET HM STATES"),(new (require("xnm.aio.hm.js").CCU)(e.info.ip)).getStates(this,h,function(a,b){if(!a&&b)for(a=0;a<b.length;a++)this.setState(b[a].id,b[a].status)}.bind(this))):"fritzbox"===g?(new (require("xnm.aio.fritz.js").Box)(e.info.ip,e.info.password)).getStates(this,h):"alpha2"===g&&(new (require("xnm.aio.moehlenhoff.js").Alpha2)(e.info.ip)).getStates(this,
h)}for(a=0;a<c.length;a++)this.getStatesForDevice(c[a])}};xnm.aio.commandhandler.Handler=function(){};xnm.aio.commandhandler.Handler.prototype.CommandHandler=xnm.aio.commandhandler.CommandHandler;"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.commandhandler.Handler);
