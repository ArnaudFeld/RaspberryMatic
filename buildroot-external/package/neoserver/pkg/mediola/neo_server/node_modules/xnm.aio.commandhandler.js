var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.commandhandler=xnm.aio.commandhandler||{},xnm.aio.commandhandler.CommandHandler=function(e,t,a,i,s){this.SystemData=e,this.RulesManager=t,this.RemoteHandler=i,this.CloudHandler=s,this.gwModule=require("xnm.aio.gateway.js"),this.CFG=a,this._gealanFans=null,this._persistentAioKeys=["_lastCF3colorSeq","_lastCF4colorSeq"],this._persistentAioData={},this._states={},this.RemoteController=null,this._updateReceivers=[],this.getStatesCallback=null,this.setGealanFanFactory=function(e){this._gealanFans=e;},this.getCurrentState=function(e){return void 0!==this._states[e]?this._states[e]:"?";},this.setState=function(e,t){if(this._states[e]!=t){this._states[e]=t;for(var a=0;a<this._updateReceivers.length;a++){var i=this._updateReceivers[a];i.filter(e)&&i.callback(e.substr(e.indexOf(":")+1),t);}}},this.deleteDeviceStates=function(e){for(var t in this._states)this._states.hasOwnProperty(t)&&parseInt(t.split(":")[0])===e&&delete this._states[t];},this.subscribe=function(e,t,a){var i,s={filter:e,callback:t,refresh:a};return this._updateReceivers.push(s),{unsubscribe:(i=this._updateReceivers,function(){var e=i.indexOf(s);-1!==e&&i.splice(e,1);})};},this.subscribeForDevice=function(e,t,a){var i=e.index;return this.subscribe(function(e){return+e.split(":")[0]===i;},t,a);},this.clearSubscribers=function(){this._updateReceivers=[];},this.subscribeForStateOnDevices=function(e,t,a){return this.subscribe(function(e){var a=e.split(":")[0];return t.some(function(e){return e.index===+a;});},function(t,i){e.some(function(e){return t===e;})&&a(i);});},this.refreshSubscribers=function(){this._updateReceivers.forEach(function(e){void 0!==e.refresh&&e&&e.refresh();}.bind(this));},this.receivedState=function(e,t,a,i){XC.debugf(e),XC.debugf(t),XC.debugf(a);var s=this;"hue"===e?this.SystemData.getGateways(function(t){return t.info.sys===e;}).forEach(function(i){this.SystemData.getDevices(function(e){return e.info.gateway===i.index;}).forEach(function(i){var s={},n="",o=i.info.data;for(var r in i.info.subtype&&(o=i.info.subtype),i.info.address==t&&(n=i.room+"."+i.index,"hue"===e&&((s=require("xnm.aio.hue.js").getStateValues({type:o},a)).rgb=a.rgb,s.effect=a.effect)),s)"state"==r?this.setState(n,s[r]):this.setState(n+":"+r,s[r]);}.bind(this));}.bind(this)):"sonos"!=e&&"wemo"!=e&&"orvibo"!=e&&"edimax"!=e&&"kt"!=e&&"siegenia"!=e&&"lightify"!=e||s.SystemData.getDevices(function(e){return e.info.address===t;}).forEach(function(t){XC.debugf(t),XC.debugf(a);var i={},n=t.room+"."+t.index,o=t.data;for(var r in t.subtype&&(o=t.subtype),"lightify"===e&&(e="osram"),i=require("xnm.aio."+e+".js").getStateValues({type:o},a),"osram"===e&&(i.rgb=""+XC.getHexVal(a.red,2)+XC.getHexVal(a.green,2)+XC.getHexVal(a.blue,2),i.ct=a.colorTemp),i)"state"==r?s.setState(n,i[r]):s.setState(n+":"+r,i[r]);});},this.execute=function(e,t,a,i){var s=this.SystemData.getDevices(function(t){return t.index==e;})[0];s&&this.executeCommand(t,s.info,a,i);},this.executeCommand=function(e,t,a,i){var _this=this;var s=this,n=t.gateway,o=t.sys,r=this.SystemData.getGateways(function(e){return e.index===n;},!0)[0];if(!r||"aio"!==o&&"hm"!==o){if(!this.RemoteHandler.isRemote())if(r&&"fritzbox"===o){var d=new(require("xnm.aio.fritz.js").Box)(r.info.ip,r.info.password);d.executeCommand(t,e,function(){XC.debugf("executed fritz command"),i&&i.call(),t.id=t.location+"."+t.id,a&&d.getStates(s,[t]);});}else if(r&&"alpha2"===o){var h=new(require("xnm.aio.moehlenhoff.js").Alpha2)(r.info.ip);h.executeCommandCreator(t,e,function(){XC.debugf("executed moehlenhoff command"),i&&i.call(),t.id=t.location+"."+t.id,a&&h.getStates(s,[t]);});}else if(r)XC.debugf("executeCommand for unknown gatewaytype");else if(["edimax","kt","orvibo","siegenia","sonos","wemo"].includes(o)){var f={address:t.address,data:t.data};if("wemo"===o){f.port=49154;var u=t.address.split(":");2==u.length&&(f.address=u[0],f.port=u[1]);}else"sonos"===o?(f.port=1400,f.address=t.ip):"siegenia"===o&&(f.pwd=t.pwd);var c=require("xnm.aio."+o+".js").getDevice(f);c?c.executeCommandCreator(f,e,function(e,t){XC.debugf("executed "+o+" command"),"siegenia"===o?i&&i.call(null,e,t):i&&i.call(),a&&c.getStates(s);}):i&&i.call();}else"gealan"===o?new(require("xnm.aio.gealan.js").Fan)(t.ip,t.port,t.username,t.password).executeCommandCreator(t,e,function(e,t){XC.debugf("executed "+o+" command"),i&&i.call();}):"aiogateway"===o&&(l=new this.gwModule.Gateway(t.address)).executeGatewayCommand(e,function(){i&&i.call();});}else{var l;(l=this.gwModule.resolveGateway(r.info)).CommandHandler=this,this._restoreAioData(l),r.info.server&&l.setRemoteUrl("https://"+this.CFG.links.cloudAccessServer+"/rapi/live/"),r.info.password&&(l._at=this.hash(r.info.password));var m=this.RemoteHandler.isRemote();l.setCloudAccess(m),m&&(a=!0),l.executeCommandCreator(null,{value:m?"raOn":"raOff"}),l.executeCommandCreator(t,e,function(n){_this._saveAioData(l),XC.debugf("Executed Gateway Command: "+t.sys+" "+e+(m?" (remote)":" (local)")),a&&setTimeout(function(){return l.getStates(s);},1e3),i&&i(n);});}},this._restoreAioData=function(e){if(this._persistentAioData[e._mac])for(var t in this._persistentAioData[e._mac])e[t]=this._persistentAioData[e._mac][t];else this._persistentAioData[e._mac]={};},this._saveAioData=function(e){var _this2=this;this._persistentAioKeys.forEach(function(t){t in e&&(_this2._persistentAioData[e._mac][t]=e[t]);});},this.hash=function(e){return e=String(e),require("x.crypt.js").MD5(unescape(encodeURI(e+"_SALT!")));},this.getStatesForDevice=function(e,t){var _this3=this;if(e.info&&"cloudservice"===e.info.sys&&new this.CloudHandler().getModuleStates(e.info.module,function(t,a){if(_this3.deleteDeviceStates(e.index),a){var i=a[e.info.connection];if(i){var s=i[e.info.id];if(s&&s.states)for(var n in s.states)_this3.setState(e.index+":"+n,s.states[n]);}}}),e.info&&e.info.mod){this.deleteDeviceStates(e.index);var a=this.gwModule.devicemanager.getSystem(e.info);if(!a)return;var i,s=this.SystemData.getGateways(function(t){return t.index===e.info.gateway;})[0];if(!s)return;var n=s.info.mac;this._aioCache?(this._aioCache[n]||(this._aioCache[n]=this.gwModule.resolveGateway(s.info)),i=this._aioCache[n]):i=this.gwModule.resolveGateway(s.info),this.RemoteHandler.isRemote()&&(i.setRemoteAccessMode(s.info.sid),i.setRemoteUrl("https://"+this.CFG.links.cloudAccessServer+"/rapi/live/"),i._at=this.hash(s.info.password)),i.executeCommandCreator(null,{value:this.RemoteHandler.isRemote()?"raOn":"raOff"}),a.getStatesCreator(i,e.info,function(a,i){if(!a&&i){for(var s in i)_this3.setState(e.index+":"+s,i[s]);t&&t(i);}});}else if(!this.RemoteHandler.isRemote()){var o=e.sys;if(-1!==["gealan"].indexOf(o)&&"gealan"==o){var r=this._gealanFans.getFan({ip:e.ip,port:e.port,mac:e.mac}),d=[];require("xnm.aio.gealan.js").getDeviceStatus(e,function(t,a){for(var i=0;i<a.length;i++){var s=a[i];if(s.ref&&s.ref.value){var n={id:s.ref.value,device:e,status:{value:s.ref.value}};d.push(n);}}}),r.getStatesCreator(null,d,function(a,i){if(!a&&i){for(var s=0;s<i.length;s++){var n=i[s];_this3.setState(e.id+":"+n.id,n.status);}t&&t(a,i);}});}}},this.getStatesForDevices=function(e,t){var a={},i=[];this._orderByGateway(e,a,i),this.getStatesPerGateway(a,i,t);},this.getStatesForLocations=function(e,t){var _this4=this;var a={},i=[];e.forEach(function(e){var s=_this4.SystemData.getDevices(function(t){return t.room===e.index;});_this4._orderByGateway(s,a,i,t);}),this.getStatesPerGateway(a,i);},this._orderByGateway=function(e,t,a,i){e.forEach(function(e){var s={};if("cloudservice"===e.info.sys){if(!i)return;s=e;}else e.info.mod?s=e:((s=Object.assign({},e.info)).id=e.index,s.subtype=e.info.subtype?e.info.subtype:e.info.data);var n=e.info.gateway;n&&!e.info.mod?(t[n]||(t[n]=[]),t[n].push(s)):a.push(s);});},this.getStatesPerGateway=function(e,t,a){var _this5=this;for(var i in e){var s=this.SystemData.getGateways(function(e){return e.index==i;},!0)[0];if(!s)return;var n=s.info.sys,o=e[i];if("aio"!==n)"hm"!==n?"fritzbox"!==n?"alpha2"!==n||new(require("xnm.aio.moehlenhoff.js").Alpha2)(s.info.ip).getStates(this,o):new(require("xnm.aio.fritz.js").Box)(s.info.ip,s.info.password).getStates(this,o):(XC.debugf("GET HM STATES"),new(require("xnm.aio.hm.js").CCU)(s.info.ip).getStates(this,o,function(e,t){if(!e&&t)for(var a=0;a<t.length;a++)this.setState(t[a].id,t[a].status);}.bind(this)));else{var r=this.gwModule.resolveGateway(s.info);this.RemoteHandler.isRemote()&&(r.setRemoteAccessMode(s.info.sid),r.setRemoteUrl("https://"+this.CFG.links.cloudAccessServer+"/rapi/live/"),r._at=this.hash(s.info.password),r.setCloudAccess(!0),r.executeCommandCreator(null,{value:"raOn"})),r.getStates(this,o,function(e,t){null==e&&a&&a(new Error("Error getting states "+t));});}}setTimeout(function(){_this5._aioCache=[];for(var e=0;e<t.length;e++)_this5.getStatesForDevice(t[e]);_this5._aioCache=[];},1e3);};},xnm.aio.commandhandler.Handler=function(){},xnm.aio.commandhandler.Handler.prototype.CommandHandler=xnm.aio.commandhandler.CommandHandler,"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.commandhandler.Handler());