var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,g,h){b!=Array.prototype&&b!=Object.prototype&&(b[g]=h.value)};$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(b,g,h,l){if(g){h=$jscomp.global;b=b.split(".");for(l=0;l<b.length-1;l++){var n=b[l];n in h||(h[n]={});h=h[n]}b=b[b.length-1];l=h[b];g=g(l);g!=l&&null!=g&&$jscomp.defineProperty(h,b,{configurable:!0,writable:!0,value:g})}};$jscomp.polyfill("Object.is",function(b){return b?b:function(b,h){return b===h?0!==b||1/b===1/h:b!==b&&h!==h}},"es6","es3");
$jscomp.polyfill("Array.prototype.includes",function(b){return b?b:function(b,h){var g=this;g instanceof String&&(g=String(g));var n=g.length;for(h=h||0;h<n;h++)if(g[h]==b||Object.is(g[h],b))return!0;return!1}},"es7","es3");
$jscomp.checkStringArgs=function(b,g,h){if(null==b)throw new TypeError("The 'this' value for String.prototype."+h+" must not be null or undefined");if(g instanceof RegExp)throw new TypeError("First argument to String.prototype."+h+" must not be a regular expression");return b+""};$jscomp.polyfill("String.prototype.includes",function(b){return b?b:function(b,h){return-1!==$jscomp.checkStringArgs(this,b,"includes").indexOf(b,h||0)}},"es6","es3");
$jscomp.owns=function(b,g){return Object.prototype.hasOwnProperty.call(b,g)};$jscomp.polyfill("Object.assign",function(b){return b?b:function(b,h){for(var g=1;g<arguments.length;g++){var n=arguments[g];if(n)for(var a in n)$jscomp.owns(n,a)&&(b[a]=n[a])}return b}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.commandhandler=xnm.aio.commandhandler||{};
xnm.aio.commandhandler.CommandHandler=function(b,g,h,l,n){this.SystemData=b;this.RulesManager=g;this.RemoteHandler=l;this.CloudHandler=n;this.gwModule=require("xnm.aio.gateway.js");this.CFG=h;this._gealanFans=null;this._persistentAioKeys=["_lastCF3colorSeq","_lastCF4colorSeq"];this._persistentAioData={};this._states={};this.RemoteController=null;this._updateReceivers=[];this.getStatesCallback=null;this.setGealanFanFactory=function(a){this._gealanFans=a};this.getCurrentState=function(a){return void 0!==
this._states[a]?this._states[a]:"?"};this.setState=function(a,c){this._states[a]!=c&&(this._states[a]=c,this._updateReceivers.forEach(function(b){b.filter(a)&&b.callback(a.substr(a.indexOf(":")+1),c)}.bind(this)))};this.deleteDeviceStates=function(a){for(var c in this._states)this._states.hasOwnProperty(c)&&parseInt(c.split(":")[0])===a&&delete this._states[c]};this.subscribe=function(a,c,b){var d={filter:a,callback:c,refresh:b};this._updateReceivers.push(d);return{unsubscribe:function(a){return function(){var c=
a.indexOf(d);-1!==c&&a.splice(c,1)}}(this._updateReceivers)}};this.subscribeForDevice=function(a,c,b){var d=a.index;return this.subscribe(function(a){return+a.split(":")[0]===d},c,b)};this.clearSubscribers=function(){this._updateReceivers=[]};this.subscribeForStateOnDevices=function(a,c,b){return this.subscribe(function(a){var b=a.split(":")[0];return c.some(function(a){return a.index===+b})},function(c,q){a.some(function(a){return c===a})&&b(q)})};this.refreshSubscribers=function(){this._updateReceivers.forEach(function(a){void 0!==
a.refresh&&a&&a.refresh()}.bind(this))};this.receivedState=function(a,c,b,d){XC.debugf(a);XC.debugf(c);XC.debugf(b);var m=this;"hue"===a?this.SystemData.getGateways(function(b){return b.info.sys===a}).forEach(function(f){this.SystemData.getDevices(function(a){return a.info.gateway===f.index}).forEach(function(f){var k={},e="",d=f.info.data;f.info.subtype&&(d=f.info.subtype);f.info.address==c&&(e=f.room+"."+f.index,"hue"===a&&(k=require("xnm.aio.hue.js").getStateValues({type:d},b),k.rgb=b.rgb,k.effect=
b.effect));for(var m in k)"state"==m?this.setState(e,k[m]):this.setState(e+":"+m,k[m])}.bind(this))}.bind(this)):("sonos"==a||"wemo"==a||"orvibo"==a||"edimax"==a||"kt"==a||"siegenia"==a||"lightify"==a)&&m.SystemData.getDevices(function(a){return a.info.address===c}).forEach(function(c){XC.debugf(c);XC.debugf(b);var d=c.room+"."+c.index,k=c.data;c.subtype&&(k=c.subtype);"lightify"===a&&(a="osram");c=require("xnm.aio."+a+".js").getStateValues({type:k},b);"osram"===a&&(c.rgb=""+XC.getHexVal(b.red,2)+
XC.getHexVal(b.green,2)+XC.getHexVal(b.blue,2),c.ct=b.colorTemp);for(var e in c)"state"==e?m.setState(d,c[e]):m.setState(d+":"+e,c[e])})};this.execute=function(a,c,b,d){var m=this.SystemData.getDevices(function(c){return c.index==a})[0];m&&this.executeCommand(c,m.info,b,d)};this.executeCommand=function(a,c,b,d){var m=this,f=this,h=c.gateway,k=c.sys,e=this.SystemData.getGateways(function(a){return a.index===h},!0)[0];if(e&&("aio"===k||"hm"===k)){var p=this.gwModule.resolveGateway(e.info);p.CommandHandler=
this;this._restoreAioData(p);e.info.server&&p.setRemoteUrl("https://"+this.CFG.links.cloudAccessServer+"/rapi/live/");e.info.password&&(p._at=this.hash(e.info.password));var g=this.RemoteHandler.isRemote();p.setCloudAccess(g);g&&(b=!0);p.executeCommandCreator(null,{value:g?"raOn":"raOff"});p.executeCommandCreator(c,a,function(e){m._saveAioData(p);XC.debugf("Executed Gateway Command: "+c.sys+" "+a+(g?" (remote)":" (local)"));b&&setTimeout(function(){return p.getStates(f)},1E3);d&&d(e)})}else if(!this.RemoteHandler.isRemote())if(e&&
"fritzbox"===k){var q=new (require("xnm.aio.fritz.js").Box)(e.info.ip,e.info.password);q.executeCommand(c,a,function(){XC.debugf("executed fritz command");d&&d.call();c.id=c.location+"."+c.id;b&&q.getStates(f,[c])})}else if(e&&"alpha2"===k){var n=new (require("xnm.aio.moehlenhoff.js").Alpha2)(e.info.ip);n.executeCommandCreator(c,a,function(){XC.debugf("executed moehlenhoff command");d&&d.call();c.id=c.location+"."+c.id;b&&n.getStates(f,[c])})}else if(e)XC.debugf("executeCommand for unknown gatewaytype");
else if("edimax kt orvibo siegenia sonos wemo".split(" ").includes(k)){e={address:c.address,data:c.data};if("wemo"===k){e.port=49154;var l=c.address.split(":");2==l.length&&(e.address=l[0],e.port=l[1])}else"sonos"===k?(e.port=1400,e.address=c.ip):"siegenia"===k&&(e.pwd=c.pwd);l=require("xnm.aio."+k+".js");var r=l.getDevice(e);r?r.executeCommandCreator(e,a,function(a,c){XC.debugf("executed "+k+" command");"siegenia"===k?d&&d.call(null,a,c):d&&d.call();b&&r.getStates(f)}):d&&d.call()}else"gealan"===
k?(l=require("xnm.aio.gealan.js"),(new l.Fan(c.ip,c.port,c.username,c.password)).executeCommandCreator(c,a,function(a,c){XC.debugf("executed "+k+" command");d&&d.call()})):"aiogateway"===k&&(p=new this.gwModule.Gateway(c.address),p.executeGatewayCommand(a,function(){d&&d.call()}))};this._restoreAioData=function(a){if(this._persistentAioData[a._mac])for(var c in this._persistentAioData[a._mac])a[c]=this._persistentAioData[a._mac][c];else this._persistentAioData[a._mac]={}};this._saveAioData=function(a){var c=
this;this._persistentAioKeys.forEach(function(b){b in a&&(c._persistentAioData[a._mac][b]=a[b])})};this.hash=function(a){a=String(a);return require("x.crypt.js").MD5(unescape(encodeURI(a+"_SALT!")))};this.getStatesForDevice=function(a,b){var c=this;a.info&&"cloudservice"===a.info.sys&&(new this.CloudHandler).getModuleStates(a.info.module,function(b,e){c.deleteDeviceStates(a.index);if(e&&(b=e[a.info.connection])&&(b=b[a.info.id])&&b.states)for(var d in b.states)c.setState(a.index+":"+d,b.states[d])});
if(a.info&&a.info.mod){var d=this.gwModule.devicemanager.getSystem(a.info);if(d){var m=this.SystemData.getGateways(function(b){return b.index===a.info.gateway})[0];if(m){var f=m.info.mac;this._aioCache?(this._aioCache[f]||(this._aioCache[f]=this.gwModule.resolveGateway(m.info)),f=this._aioCache[f]):f=this.gwModule.resolveGateway(m.info);this.RemoteHandler.isRemote()&&(f.setRemoteAccessMode(m.info.sid),f.setRemoteUrl("https://"+this.CFG.links.cloudAccessServer+"/rapi/live/"),f._at=this.hash(m.info.password));
f.executeCommandCreator(null,{value:this.RemoteHandler.isRemote()?"raOn":"raOff"});d.getStatesCreator(f,a.info,function(b,e){if(!b&&e)for(var d in e)c.setState(a.index+":"+d,e[d])})}}}else if(!this.RemoteHandler.isRemote()&&(d=a.sys,-1!==["gealan"].indexOf(d)&&"gealan"==d)){d=this._gealanFans.getFan({ip:a.ip,port:a.port,mac:a.mac});var h=[];require("xnm.aio.gealan.js").getDeviceStatus(a,function(b,c){for(b=0;b<c.length;b++){var e=c[b];e.ref&&e.ref.value&&h.push({id:e.ref.value,device:a,status:{value:e.ref.value}})}});
d.getStatesCreator(null,h,function(d,e){if(!d&&e){for(var f=0;f<e.length;f++){var m=e[f];c.setState(a.id+":"+m.id,m.status)}b&&b(d,e)}})}};this.getStatesForDevices=function(a,b){var c={},d=[];this._orderByGateway(a,c,d);this.getStatesPerGateway(c,d,b)};this.getStatesForLocations=function(a,b){var c=this,d={},m=[];a.forEach(function(a){var f=c.SystemData.getDevices(function(b){return b.room===a.index});c._orderByGateway(f,d,m,b)});this.getStatesPerGateway(d,m)};this._orderByGateway=function(a,b,h,
d){a.forEach(function(a){if("cloudservice"===a.info.sys){if(!d)return;var c=a}else a.info.mod?c=a:(c=Object.assign({},a.info),c.id=a.index,c.type=a.info.sys,c.subtype=a.info.subtype?a.info.subtype:a.info.data);var g=a.info.gateway;g&&!a.info.mod?(b[g]||(b[g]=[]),b[g].push(c)):h.push(c)})};this.getStatesPerGateway=function(a,b,h){var c=this,g;for(g in a){var f=this.SystemData.getGateways(function(a){return a.index==g},!0)[0];if(!f)return;var l=f.info.sys,k=a[g];"aio"===l?(l=this.gwModule.resolveGateway(f.info),
this.RemoteHandler.isRemote()&&(l.setRemoteAccessMode(f.info.sid),l.setRemoteUrl("https://"+this.CFG.links.cloudAccessServer+"/rapi/live/"),l._at=this.hash(f.info.password)),l.getStates(this,k,function(a,b){null==a&&h&&h(Error("Error getting states "+b))})):"hm"===l?(XC.debugf("GET HM STATES"),(new (require("xnm.aio.hm.js").CCU)(f.info.ip)).getStates(this,k,function(a,b){if(!a&&b)for(a=0;a<b.length;a++)this.setState(b[a].id,b[a].status)}.bind(this))):"fritzbox"===l?(new (require("xnm.aio.fritz.js").Box)(f.info.ip,
f.info.password)).getStates(this,k):"alpha2"===l&&(new (require("xnm.aio.moehlenhoff.js").Alpha2)(f.info.ip)).getStates(this,k)}setTimeout(function(){c._aioCache=[];for(var a=0;a<b.length;a++)c.getStatesForDevice(b[a]);c._aioCache=[]},1E3)}};xnm.aio.commandhandler.Handler=function(){};xnm.aio.commandhandler.Handler.prototype.CommandHandler=xnm.aio.commandhandler.CommandHandler;"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.commandhandler.Handler);
