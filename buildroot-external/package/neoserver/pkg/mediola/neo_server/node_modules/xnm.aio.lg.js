var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.lg=xnm.aio.lg||{};xnm.aio.lg.CRC_TABLE=null;
xnm.aio.lg.TV=function(){var c=function(a,b,d){this._logger=require("x.logger.js").getLogger("xnm.aio.lg.TV");this.ip=a;this.port=b;if(!this.port||0>this.port)this.port=8080;this.udpport=7070;this.authKey=d;this.controlUrl="/hdcp/api/dtv_wifirc";this.authUrl="/hdcp/api/auth"};c.AUTHKEY_REQ='<?xml version="1.0" encoding="utf-8"?><auth><type>AuthKeyReq</type></auth>';c.AUTH_REQ='<?xml version="1.0" encoding="utf-8"?><auth><type>AuthReq</type><value>%@</value></auth>';c.KEY_INPUT='<?xml version="1.0" encoding="utf-8"?><command><session>%@1</session><type>HandleKeyInput</type><value>%@2</value></command>';
c.prototype._executeCommand=function(a,b){if(a){this._logger.log("debug","execute command:"+a);var d=this;this._getSession(function(e,c){if(e)b&&b(e);else if("u"==a.charAt(0).toLowerCase()){var g=a.substr(1),g=d._buildUdpReq(c,g);d._doUdpCommand(g,b)}else d._doHttpCommand(c,a,b)})}else b&&b(Error("code is empty"))};c.prototype._showAuthKey=function(a){this._logger.log("debug","auth key");var b=this;this._doRequest(this.authUrl,c.AUTHKEY_REQ,function(d){b._logger.log("warn","auth key "+(d?"error:"+
d.message:"success"));a&&a(d)})};c.prototype._getSession=function(a){if(this.authKey){this._logger.log("debug","get session");var b=c.AUTH_REQ.replace("%@",this.authKey),d=this;this._doRequest(this.authUrl,b,function(b,c){if(b)d._logger.log("warn","get session http error:"+b.message),a&&a(b);else{var g;if(c){var h=c.indexOf("<session>"),f=c.indexOf("</session>");-1!=h&&-1!=f&&9<f-h&&(g=c.substring(h+9,f))}g?(d._logger.log("debug","get session success:"+g),a&&a(null,g)):(d._logger.log("warn","get session reponse error"),
a&&a(Error("get session reponse error")))}})}else this._logger.log("warn","no auth key"),a&&a(Error("no auth key"))};c.prototype._doHttpCommand=function(a,b,d){a=c.KEY_INPUT.replace("%@1",a);a=a.replace("%@2",b);this._logger.log("debug","do http command:"+b);this._doRequest(this.controlUrl,a,function(b){d&&d(b)})};c.prototype._buildUdpReq=function(a,b){var d=parseInt(a),e=[0,0,0,0];e.push(d&255);e.push(d>>8&255);e.push(d>>16&255);e.push(d>>24&255);for(d=0;d<b.length;d+=2){var c=b.substr(d,2),c=parseInt(c,
16);e.push(c)}d=this._crc32(e);e[0]=d&255;e[1]=d>>8&255;e[2]=d>>16&255;e[3]=d>>24&255;return e};c.prototype._doUdpCommand=function(a,b){var d=require("dgram").createSocket("udp4"),e=new Buffer(a);d.send(e,0,e.length,this.udpport,this.ip,function(a){d.close();b&&b(a)})};c.prototype._doRequest=function(a,b,d){var e=this;a="http://"+this.ip+":"+this.port+a;this._logger.log("trace","send data:"+b);var c=d;$.ajax({url:a,type:"POST",timeout:3E3,data:b,dataType:"text",cache:!1,headers:{"Content-Type":"application/atom+xml",
"Content-Length":b.length},username:this.username,password:this.password,success:function(b){e._logger.log("trace","http request success:"+b);c&&(c(null,b),c=null)},error:function(b,a){var d="http request error:"+(b?b.status:"0")+"-"+a;c&&(c(Error(d)),c=null)}})};c.prototype._crc32=function(a){for(var b=xnm.aio.lg.CRC_TABLE||(xnm.aio.lg.CRC_TABLE=this._makeCRCTable()),d=-1,e=0;e<a.length;e++)d=d>>>8^b[(d^a[e])&255];return(d^-1)>>>0};c.prototype._makeCRCTable=function(){for(var a,b=[],d=0;256>d;d++){a=
d;for(var e=0;8>e;e++)a=a&1?3988292384^a>>>1:a>>>1;b[d]=a}return b};return c}();xnm.aio.lg.TV2012=function(){var c=function(a,b,d){xnm.aio.lg.TV.call(this,a,b,d);this._logger=require("x.logger.js").getLogger("xnm.aio.lg.TV2012");this.controlUrl="/roap/api/command";this.authUrl="/roap/api/auth"};c.prototype=Object.create(xnm.aio.lg.TV.prototype);return c.prototype.constructor=c}();
xnm.aio.lg.BDP=function(){var c=function(b,a,e){this.bdp=b;this.code=a;this.callback=e;this._socket=null};c.prototype.run=function(){var b=this;this.bdp._connect({onError:function(a){b._finish(a)},onTimeout:function(){b._finish(Error("response timeout"))},onData:function(){b._socket.end();b._finish()},onClose:function(){b._finish()}},function(a,e){if(a)b._finish(a);else{b._socket=e;var c=b.bdp._buildReq(b.code);b.bdp._logger&&b.bdp._logger.log("trace","send lg bdp request:"+c);e.write(c,"hex")}})};
c.prototype._finish=function(b){b&&this.bdp._logger.log("warn","execute lg bdp command error:"+b.message);this.callback&&this.callback(b);this.callback=null;this.bdp._finishTask(this)};var a=function(b,a){this._logger=require("x.logger.js").getLogger("xnm.aio.lg.BDP");this.ip=b;this.port=a;this.port||(this.port=9740);this._tasks=[]};a.prototype._executeCommand=function(b,a){var e=new c(this,b,a);this._tasks.push(e);e.run()};a.prototype._finishTask=function(b){for(var a=-1,c=0;c<this._tasks.length;c++)if(this._tasks[c]===
b){a=c;break}-1!=a&&this._tasks.splice(a,1)};a.prototype._buildReq=function(b){return 30>b.length?b+"02"+b+"01":b};a.prototype._hex2arr=function(b){for(var a=[],c=0;c<b.length;c+=2)a.push(parseInt(b.substr(c,2),16));return a};a.prototype._connect=function(a,c){var e=this,k={port:this.port,host:this.ip},g=!1,h=c,f=require("net").connect(k);a.__socket=f;f.setTimeout(1E4);f.setEncoding("hex");f.on("connect",function(){e._logger.log("trace","connect tcp to:"+e.ip);g=!0;if(h){var c=a.__socket;delete a.__socket;
h(null,c)}});f.on("data",function(c){e._logger.log("trace","receive from tcp:"+e.ip+" data:"+c);a.onData(c)});f.on("error",function(c){g?(e._logger.log("trace","tcp:"+e.ip+" error:"+c.message),f.end(),a.onError(c)):(e._logger.log("trace","tcp:"+e.ip+" connection error:"+c.message),h&&(h(c),h=null))});f.on("timeout",function(){g?(e._logger.log("trace","tcp:"+e.ip+" data timeout"),f.end(),a.onTimeout()):(e._logger.log("trace","tcp:"+e.ip+" connection timeout"),f.end(),h&&(h(Error("connection timeout")),
h=null))});f.on("close",function(){e._logger.log("trace","tcp:"+e.ip+" close socket");a.onClose()});f._doConnect&&"function"==typeof f._doConnect&&f._doConnect()};return a}();xnm.aio.lg.BDP.DM=function(){return{SYS:"lgav",getIPDeviceType:function(){return{sys:this.SYS,name:"LG BDP"}}}}();
xnm.aio.lg.DM=function(){return{getSys:function(){var c=[],a;for(a in xnm.aio.lg)xnm.aio.lg.hasOwnProperty(a)&&xnm.aio.lg[a]&&xnm.aio.lg[a].DM&&c.push(xnm.aio.lg[a]);return c},registModule:function(c){for(var a=this.getSys(),b=0;b<a.length;b++)a[b]&&a[b].DM&&a[b].DM.SYS&&c.register(a[b].DM.SYS,"lg")},getIPDeviceType:function(){return[]}}}();
xnm.aio.lg.Handler=function(){var c=function(){};c.prototype.devicemanager=xnm.aio.lg.DM;c.prototype.BDP=xnm.aio.lg.BDP;c.prototype.TV=xnm.aio.lg.TV;c.prototype.TV2012=xnm.aio.lg.TV2012;c.prototype.registModule=function(a){this.devicemanager.registModule(a)};c.prototype.showAuthKey=function(a,b){if(a&&a.ip){var c=new xnm.aio.lg.TV(a.ip,a.port);"lgtv2012"==a.id&&(c=new xnm.aio.lg.TV2012(a.ip,a.port));c._showAuthKey(b)}else b&&b(Error("device json invalid format"))};return c}();
"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.lg.Handler);
