var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.lg=xnm.aio.lg||{},xnm.aio.lg.CRC_TABLE=null,xnm.aio.lg.TV=function(){var t=function t(_t,e,o){this._logger=require("x.logger.js").getLogger("xnm.aio.lg.TV"),this.ip=_t,this.port=e,(!this.port||this.port<0)&&(this.port=8080),this.udpport=7070,this.authKey=o,this.controlUrl="/hdcp/api/dtv_wifirc",this.authUrl="/hdcp/api/auth";};return t.AUTHKEY_REQ='<?xml version="1.0" encoding="utf-8"?><auth><type>AuthKeyReq</type></auth>',t.AUTH_REQ='<?xml version="1.0" encoding="utf-8"?><auth><type>AuthReq</type><value>%@</value></auth>',t.KEY_INPUT='<?xml version="1.0" encoding="utf-8"?><command><session>%@1</session><type>HandleKeyInput</type><value>%@2</value></command>',t.prototype._executeCommand=function(t,e){if(t){this._logger.log("debug","execute command:"+t);var o=this;this._getSession(function(n,r){if(n)e&&e(n);else if("u"==t.charAt(0).toLowerCase()){var i=t.substr(1),s=o._buildUdpReq(r,i);o._doUdpCommand(s,e);}else o._doHttpCommand(r,t,e);});}else e&&e(new Error("code is empty"));},t.prototype._showAuthKey=function(e){this._logger.log("debug","auth key");var o=this;this._doRequest(this.authUrl,t.AUTHKEY_REQ,function(t){o._logger.log("warn","auth key "+(t?"error:"+t.message:"success")),e&&e(t);});},t.prototype._getSession=function(e){if(!this.authKey)return this._logger.log("warn","no auth key"),void(e&&e(new Error("no auth key")));this._logger.log("debug","get session");var o=t.AUTH_REQ.replace("%@",this.authKey),n=this;this._doRequest(this.authUrl,o,function(t,o){if(t)return n._logger.log("warn","get session http error:"+t.message),void(e&&e(t));var r;if(o){var i=o.indexOf("<session>"),s=o.indexOf("</session>");-1!=i&&-1!=s&&s-i>9&&(r=o.substring(i+9,s));}if(!r)return n._logger.log("warn","get session reponse error"),void(e&&e(new Error("get session reponse error")));n._logger.log("debug","get session success:"+r),e&&e(null,r);});},t.prototype._doHttpCommand=function(e,o,n){var r=t.KEY_INPUT.replace("%@1",e);r=r.replace("%@2",o),this._logger.log("debug","do http command:"+o),this._doRequest(this.controlUrl,r,function(t){n&&n(t);});},t.prototype._buildUdpReq=function(t,e){var o=parseInt(t),n=[0,0,0,0];n.push(255&o),n.push(o>>8&255),n.push(o>>16&255),n.push(o>>24&255);for(var r=0;r<e.length;r+=2){var i=e.substr(r,2);i=parseInt(i,16),n.push(i);}var s=this._crc32(n);return n[0]=255&s,n[1]=s>>8&255,n[2]=s>>16&255,n[3]=s>>24&255,n;},t.prototype._doUdpCommand=function(t,e){var o=require("dgram").createSocket("udp4"),n=new Buffer(t);o.send(n,0,n.length,this.udpport,this.ip,function(t){o.close(),e&&e(t);});},t.prototype._doRequest=function(t,e,o){var n=this,r="http://"+this.ip+":"+this.port+t;this._logger.log("trace","send data:"+e);var i=o;$.ajax({url:r,type:"POST",timeout:3e3,data:e,dataType:"text",cache:!1,headers:{"Content-Type":"application/atom+xml","Content-Length":e.length},username:this.username,password:this.password,success:function success(t){n._logger.log("trace","http request success:"+t),i&&(i(null,t),i=null);},error:function error(t,e){var o="http request error:"+(t?t.status:"0")+"-"+e;i&&(i(new Error(o)),i=null);}});},t.prototype._crc32=function(t){for(var e=xnm.aio.lg.CRC_TABLE||(xnm.aio.lg.CRC_TABLE=this._makeCRCTable()),o=-1,n=0;n<t.length;n++)o=o>>>8^e[255&(o^t[n])];return(-1^o)>>>0;},t.prototype._makeCRCTable=function(){for(var t,e=[],o=0;o<256;o++){t=o;for(var n=0;n<8;n++)t=1&t?3988292384^t>>>1:t>>>1;e[o]=t;}return e;},t;}(),xnm.aio.lg.TV2012=function(){var t=function t(_t2,e,o){xnm.aio.lg.TV.call(this,_t2,e,o),this._logger=require("x.logger.js").getLogger("xnm.aio.lg.TV2012"),this.controlUrl="/roap/api/command",this.authUrl="/roap/api/auth";};return(t.prototype=Object.create(xnm.aio.lg.TV.prototype)).constructor=t,t;}(),xnm.aio.lg.BDP=function(){var t=function t(_t3,e,o){this.bdp=_t3,this.code=e,this.callback=o,this._socket=null;};t.prototype.run=function(){var t=this,e={onError:function onError(e){t._finish(e);},onTimeout:function onTimeout(){t._finish(new Error("response timeout"));},onData:function onData(){t._socket.end(),t._finish();},onClose:function onClose(){t._finish();}};this.bdp._connect(e,function(e,o){if(e)t._finish(e);else{t._socket=o;var n=t.bdp._buildReq(t.code);t.bdp._logger&&t.bdp._logger.log("trace","send lg bdp request:"+n),o.write(n,"hex");}});},t.prototype._finish=function(t){t&&this.bdp._logger.log("warn","execute lg bdp command error:"+t.message),this.callback&&this.callback(t),this.callback=null,this.bdp._finishTask(this);};var e=function e(t,_e){this._logger=require("x.logger.js").getLogger("xnm.aio.lg.BDP"),this.ip=t,this.port=_e,this.port||(this.port=9740),this._tasks=[];};return e.prototype._executeCommand=function(e,o){var n=new t(this,e,o);this._tasks.push(n),n.run();},e.prototype._finishTask=function(t){for(var e=-1,o=0;o<this._tasks.length;o++)if(this._tasks[o]===t){e=o;break;}-1!=e&&this._tasks.splice(e,1);},e.prototype._buildReq=function(t){return t.length<30?t+"02"+t+"01":t;},e.prototype._hex2arr=function(t){for(var e=[],o=0;o<t.length;o+=2)e.push(parseInt(t.substr(o,2),16));return e;},e.prototype._connect=function(t,e){var o=this,n={port:this.port,host:this.ip},r=!1,i=e,s=require("net").connect(n);t.__socket=s,s.setTimeout(1e4),s.setEncoding("hex"),s.on("connect",function(){if(o._logger.log("trace","connect tcp to:"+o.ip),r=!0,i){var e=t.__socket;delete t.__socket,i(null,e);}}),s.on("data",function(e){o._logger.log("trace","receive from tcp:"+o.ip+" data:"+e),t.onData(e);}),s.on("error",function(e){r?(o._logger.log("trace","tcp:"+o.ip+" error:"+e.message),s.end(),t.onError(e)):(o._logger.log("trace","tcp:"+o.ip+" connection error:"+e.message),i&&(i(e),i=null));}),s.on("timeout",function(){r?(o._logger.log("trace","tcp:"+o.ip+" data timeout"),s.end(),t.onTimeout()):(o._logger.log("trace","tcp:"+o.ip+" connection timeout"),s.end(),i&&(i(new Error("connection timeout")),i=null));}),s.on("close",function(){o._logger.log("trace","tcp:"+o.ip+" close socket"),t.onClose();}),s._doConnect&&"function"==typeof s._doConnect&&s._doConnect();},e;}(),xnm.aio.lg.BDP.DM={SYS:"lgav",getIPDeviceType:function getIPDeviceType(){return{sys:this.SYS,name:"LG BDP"};}},xnm.aio.lg.DM=function(){var t=function t(_t4,e){this.code=_t4,this.message=e,this.stack=new Error().stack;};return(t.prototype=new Error()).name="LGDMError",t.prototype.code=0,t.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{getSys:function getSys(){var t=[];for(var e in xnm.aio.lg)xnm.aio.lg.hasOwnProperty(e)&&xnm.aio.lg[e]&&xnm.aio.lg[e].DM&&t.push(xnm.aio.lg[e]);return t;},registModule:function registModule(t){for(var e=this.getSys(),o=0;o<e.length;o++)e[o]&&e[o].DM&&e[o].DM.SYS&&t.register(e[o].DM.SYS,"lg");},getIPDeviceType:function getIPDeviceType(){return[];}};}(),xnm.aio.lg.Handler=function(){var t=function t(){};return t.prototype.devicemanager=xnm.aio.lg.DM,t.prototype.BDP=xnm.aio.lg.BDP,t.prototype.TV=xnm.aio.lg.TV,t.prototype.TV2012=xnm.aio.lg.TV2012,t.prototype.registModule=function(t){this.devicemanager.registModule(t);},t.prototype.showAuthKey=function(t,e){if(t&&t.ip){var o=new xnm.aio.lg.TV(t.ip,t.port);"lgtv2012"==t.id&&(o=new xnm.aio.lg.TV2012(t.ip,t.port)),o._showAuthKey(e);}else e&&e(new Error("device json invalid format"));},t;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.lg.Handler());