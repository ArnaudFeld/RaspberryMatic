var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.yellowstone=xnm.aio.yellowstone||{};
xnm.aio.yellowstone.Cloudy=function(){var k=[1,2,3,4,5],f=function(a,b,c){this._taskBuffer=null;this._cloudy=a;this._command=b;this._callback=c};f.prototype.run=function(){this._cloudy._logger.log("debug","run command task: "+JSON.stringify(this._command));var a=this,b;if(this._command.raw)b=this._cloudy._buildRawCommandReq(this._command.raw);else if(this._command.hexValue)b=this._cloudy._buildHexCommandReq(this._command.bg,this._command.sig,this._command.hexValue);else if("toggle"==this._command.command){var c=
this._cloudy._buildStateReq(this._command.bg);this._cloudy._doStateReq(c,function(c,l){if(c)!c||1!=c.errorCode&&2!=c.errorCode&&3!=c.errorCode?a._taskBuffer._finishLastTask(c):a._taskBuffer._finishAllTask(c);else{var e=a._command.sig;l&&l.intState&&"undefined"!=typeof l.intState[e]&&null!=l.intState[e]?(e=l.intState[e],b=a._cloudy._buildCommandReq(a._command.bg,a._command.sig,0==e?1:0),a._cloudy._doCommandReq(b,function(b){!b||1!=b.errorCode&&2!=b.errorCode&&3!=b.errorCode?a._taskBuffer._finishLastTask(b):
a._taskBuffer._finishAllTask(b)})):a._taskBuffer._finishLastTask(c)}})}else b=this._cloudy._buildCommandReq(this._command.bg,this._command.sig,this._command.value);b&&this._cloudy._doCommandReq(b,function(b){!b||1!=b.errorCode&&2!=b.errorCode&&3!=b.errorCode?a._taskBuffer._finishLastTask(b):a._taskBuffer._finishAllTask(b)})};var h=function(a,b,c){this._taskBuffer=null;this._cloudy=a;this._bgs=b;this._callback=c};h.prototype.run=function(){this._cloudy._logger.log("debug","run status task: "+JSON.stringify(this._bgs));
var a=this,b={},c=0,d=function(l,e){if(l&&4!=l.errorCode&&5!=l.errorCode)1==l.errorCode||2==l.errorCode||3==l.errorCode?a._taskBuffer._finishAllTask(l):a._taskBuffer._finishLastTask(l);else if(e&&(b[a._bgs[c]]=e),c++,c<a._bgs.length){var g;g=-1==a._bgs[c]?a._cloudy._buildRawMsgReq():a._cloudy._buildStateReq(a._bgs[c]);a._cloudy._doStateReq(g,d)}else a._taskBuffer._finishLastTask(null,b)},l;l=-1==this._bgs[c]?this._cloudy._buildRawMsgReq():this._cloudy._buildStateReq(this._bgs[c]);this._cloudy._doStateReq(l,
d)};var g=function(a){this._cloudy=a;this._buffer=[]};g.prototype.executeTask=function(a){var b=this._buffer.length;a._taskBuffer=this;this._buffer.push(a);0==b&&this._doNextTask()};g.prototype._doNextTask=function(){0!=this._buffer.length&&this._buffer[0].run()};g.prototype._finishLastTask=function(a,b){if(0<this._buffer.length){var c=this._buffer[0];c&&c._callback&&(c._callback(a,b),c._callback=null);this._buffer.splice(0,1)}this._doNextTask()};g.prototype._finishAllTask=function(a){var b=this._buffer;
this._buffer=[];for(var c=0;c<b.length;c++)b[c]&&b[c]._callback&&(b[c]._callback(a),b[c]._callback=null)};var m=function(a){this._cloudy=a;this._logger=a._logger;this._buffer=[];this._dataBuffer=this._bufferEmptyTo=null};m.prototype.RESPONSE_TO=2E3;m.prototype.sendPacket=function(a,b){if(a){var c=this._buffer.length;this._buffer.push({packet:a,callback:b});this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null);0==c&&this._sendNextPacket()}else b&&b(Error("message is null"))};
m.prototype._sendNextPacket=function(){if(0!=this._buffer.length){var a=this,b=this._buffer[0];this._cloudy._sendPacket(b.packet,function(c){c?(c.errorCode=k[0],a._finishAllPacket(c)):b.timeout=setTimeout(function(){a._logger.log("warn","packet response timeout");var b=Error("packet reponse timeout");b.errorCode=k[3];a._finishLastPacket(b)},a.RESPONSE_TO)})}};m.prototype._finishLastPacket=function(a,b){0<this._buffer.length&&(this._buffer[0]&&(this._buffer[0].timeout&&(clearTimeout(this._buffer[0].timeout),
this._buffer[0].timeout=null),this._buffer[0].callback&&(this._buffer[0].callback(a,b),this._buffer[0].callback=null)),this._buffer.splice(0,1));if(0==this._buffer.length){var c=this;this._bufferEmptyTo=setTimeout(function(){c._bufferEmptyTo=null;0==c._buffer.length&&c._cloudy._disconnect()},500)}else this._sendNextPacket()};m.prototype._finishAllPacket=function(a){var b=this._buffer;this._buffer=[];this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null);for(var c=0;c<b.length;c++)b[c]&&
(b[c].timeout&&(clearTimeout(b[c].timeout),b[c].timeout=null),b[c].callback&&(b[c].callback(a),b[c].callback=null))};m.prototype._hex2ascii=function(a){for(var b="",c=0;c<a.length;c+=2)b+=String.fromCharCode(parseInt(a.substr(c,2),16));return b};m.prototype._handlePacket=function(a){if(0<this._buffer.length&&this._buffer[0]){var b=this._buffer[0].packet;if(b&&3<=b.length)switch(b.substr(0,3)){case "CRO":case "CWO":case "CRS":a.raw&&2<=a.raw.length&&(a.params=a.raw.substr(1));break;case "CGO":a.raw&&
2<=a.raw.length&&(a.params=a.raw.substr(1).trim().split(" "))}this._logger.log("trace","parsed packet:"+JSON.stringify(a));this._finishLastPacket(null,a)}};m.prototype._handleData=function(){for(var a=null,b=!1,c=0;c<=this._dataBuffer.length-2;c+=2){var d=this._dataBuffer.substr(c,2),l=null;c<=this._dataBuffer.length-4&&(l=this._dataBuffer.substr(c+2,2));if("04"==d.toLowerCase()){a=this._dataBuffer.substr(0,c);b=!0;this._dataBuffer=c==this._dataBuffer.length-2?null:this._dataBuffer.substr(c+2);break}else if(("0d"==
d.toLowerCase()||"0a"==d.toLowerCase())&&"03"==l.toLowerCase()){a=this._dataBuffer.substr(0,c);this._dataBuffer=c==this._dataBuffer.length-4?null:this._dataBuffer.substr(c+4);break}}"undefined"!=typeof a&&null!=a&&(a=this._hex2ascii(a),c={},c.interrupt=b,c.raw=a,c.ok=">"==a.charAt(0),this._logger.log("trace","receive packet:"+JSON.stringify(c)),this._handlePacket(c));"undefined"!=typeof a&&null!=a&&this._dataBuffer&&this._handleData()};m.prototype._onSocketData=function(a){a&&(this._dataBuffer=this._dataBuffer?
this._dataBuffer+a:a);this._dataBuffer&&this._handleData()};m.prototype._onSocketTimeout=function(){};m.prototype._onSocketError=function(a){a.errorCode=k[1];this._finishAllPacket(a)};m.prototype._onSocketClose=function(a){a=Error("socket closed");a.errorCode=k[2];this._finishAllPacket(a)};var e=function(a,b){this._logger=require("x.logger.js").getLogger("xnm.aio.yellowstone.Cloudy");this._ip=a;this._port=b;this._port||(this._port=4E3);this._socket=null;this._taskBuffer=new g(this);this._packetBuffer=
new m(this)};e.prototype.executeCommandCreator=function(a,b,c){if(b&&b.value){var d;switch(b.value){case "rawCmd":if(!b.ext){c&&c(Error("command rawCmd ext null"));return}d={raw:b.ext};break;default:if(!a||"undefined"==typeof a.bg||null==a.bg||"undefined"==typeof a.sig||null==a.sig){c&&c(Error("device invalid"));return}switch(b.value){case "on":d={bg:a.bg,sig:a.sig,value:1};break;case "off":d={bg:a.bg,sig:a.sig,value:0};break;case "toggle":d={bg:a.bg,sig:a.sig,command:"toggle"};break;default:if("undefined"==
typeof b.ext||null==b.ext){c&&c(Error("command setValue ext null"));return}switch(b.value){case "setHex":d={bg:a.bg,sig:a.sig,hexValue:b.ext};break;case "setInt":b=parseInt(b.ext);d={bg:a.bg,sig:a.sig,value:b};break;case "setFloat":b=parseFloat(b.ext);if(0==parseFloat(a.scale))b=0;else{d=parseFloat(a.scale);if(isNaN(d)||!d)d=1;b=Math.round(b/d)}d={bg:a.bg,sig:a.sig,value:b}}}}d?this._executeCommand(d,c):c&&c(Error("no such command"))}else c&&c(Error("command is null"))};e.prototype.getStatesCreator=
function(a,b,c){if(b)if(0==b.length)c&&c(null,[]);else{a=[];for(var d=0;d<b.length;d++){var l=b[d];l&&(l=!l.device||l.device.ip?-1:l.device.bg,-1==a.indexOf(l)&&a.push(l))}this._getStates(a,function(a,d){var l=[];if(d)for(var e=0;e<b.length;e++)if(b[e]&&b[e].id){var g="?";if((!b[e].device||b[e].device.ip)&&b[e].status&&b[e].status.value)"undefined"!=typeof d["-1"]&&null!=d["-1"]&&(g=d["-1"]);else if(b[e].device&&b[e].status&&b[e].status.value){var f=b[e].device.bg,h=b[e].device.sig,m=b[e].device.scale;
if("undefined"!=typeof f&&null!=f&&"undefined"!=typeof h&&null!=h&&d[f]&&(f=d[f],"undefined"!=typeof f&&null!=f)){var k=null;switch(b[e].status.value){case "stateHex":f.hexState&&f.hexState[h]&&(g=f.hexState[h]);break;case "stateFloat":f.intState&&"undefined"!=typeof f.intState[h]&&null!=f.intState[h]&&(k=f.intState[h],"undefined"!=typeof m&&null!=m&&(k*=parseFloat(m)),g=k);break;case "stateInt":f.intState&&"undefined"!=typeof f.intState[h]&&null!=f.intState[h]&&(g=f.intState[h]);break;case "stateBi":f.intState&&
"undefined"!=typeof f.intState[h]&&null!=f.intState[h]&&(k=f.intState[h],g=0==k?"off":"on")}}}if("undefined"==typeof g||null==g)g="?";l.push({id:b[e].id,status:g})}c&&c(null,l)})}else c&&c(Error("deviceList is null"))};e.prototype._executeCommand=function(a,b){this._logger.log("debug","execute command: "+JSON.stringify(a));var c=new f(this,a,b);this._taskBuffer.executeTask(c)};e.prototype._getStates=function(a,b){this._logger.log("debug","get states: "+JSON.stringify(a));var c=new h(this,a,b);this._taskBuffer.executeTask(c)};
e.prototype._resolveMsg=function(a){var b=null;a&&(a=a.params.replace(/"/g,""),">"==a.charAt(0)&&1<a.length&&(a=a.substr(1)),b=a.trim());return b};e.prototype._resolveStatus=function(a){var b=[],c=[];if(a.params)for(var d=0;d<a.params.length;d++){var e=parseInt(a.params[d],16);e&2147483648&&(e=(e&2147483647)-2147483648);for(var f=a.params[d];8>f.length;)f="0"+f;c.push(f);b.push(e)}return{hexState:c,intState:b}};e.prototype._doCommandReq=function(a,b){this._packetBuffer.sendPacket(a,function(a,d){a?
b(a):d&&!d.interrupt&&d.ok&&d.params?b():(a=Error("CWO response error"),a.errorCode=5,b(a))})};e.prototype._doStateReq=function(a,b){var c=this;this._packetBuffer.sendPacket(a,function(d,e){if(d)b(d);else if(e&&!e.interrupt&&e.ok&&e.params){var f;f=0==a.indexOf("CRS")?c._resolveMsg(e):c._resolveStatus(e);b(null,f)}else d=Error("state (CGO, CRS) response error"),d.errorCode=5,b(d)})};e.prototype._buildCommandReq=function(a,b,c){-2147483648>c&&(c=-2147483648);2147483647<c&&(c=2147483647);0>c&&(c=c+
2147483648|2147483648);return"CWO "+a+" "+b+" "+c.toString(16)};e.prototype._buildRawCommandReq=function(a){return'CWR "'+a+'"'};e.prototype._buildHexCommandReq=function(a,b,c){8<c.length&&(c=c.substr(c.length-8));return"CWO "+a+" "+b+" "+c};e.prototype._buildStateReq=function(a){return"CGO "+a+" 0 64"};e.prototype._buildRawMsgReq=function(){return"CRS"};e.prototype._buildData=function(a){for(var b=[],c=0;c<a.length;c++)b.push(a.charCodeAt(c));b.push(13);b.push(3);return new Buffer(b)};e.prototype._sendPacket=
function(a,b){if(this._socket){this._logger.log("trace","send packet:"+a);var c=this._buildData(a);this._socket.write(c,"binary");b()}else{var d=this;this._connect(function(c){c?b(c):d._sendPacket(a,b)})}};e.prototype._connect=function(a){this._socket&&(this._socket.end(),this._socket=null);var b=this,c={port:this._port,host:this._ip},d=require("net").connect(c);d.setTimeout(5E3);d.__connected=!1;d.setEncoding("hex");d.on("connect",function(){b._logger.log("trace","connect to cloudy:"+b._ip);d.__connected=
!0;b._socket=d;a()});d.on("data",function(a){b._logger.log("trace","receive from cloudy "+(d.__disconnected?"(closed)":"")+":"+b._ip+" data:"+a);d.__disconnected||b._packetBuffer._onSocketData(a)});d.on("error",function(c){d.__connected?(b._logger.log("trace","cloudy"+(d.__disconnected?"(closed)":"")+":"+b._ip+" error:"+c.message),d.destroy(),d.__disconnected||(d.__disconnected=!0,b._socket=null,b._packetBuffer._onSocketError(c))):(b._logger.log("trace","cloudy:"+b._ip+" connection error:"+c.message),
a(c))});d.on("timeout",function(){d.__connected?(b._logger.log("trace","cloudy"+(d.__disconnected?"(closed)":"")+":"+b._ip+" data timeout"),d.__disconnected||b._packetBuffer._onSocketTimeout()):(b._logger.log("trace","cloudy:"+b._ip+" connection timeout"),d.destroy&&d.destroy(),a(Error("timeout")))});d.on("close",function(){b._logger.log("trace","cloudy"+(d.__disconnected?"(closed)":"")+":"+b._ip+" close socket");d.__disconnected||(d.__disconnected=!0,b._socket=null,b._packetBuffer._onSocketClose(d))});
d._doConnect&&"function"==typeof d._doConnect&&d._doConnect();return d};e.prototype._disconnect=function(){this._logger.log("debug","disconnect socket");this._socket&&(this._socket.__disconnected=!0,this._socket.end(),this._socket=null)};e.prototype.toJSON=function(){return{sys:"cloudy",ip:this._ip,port:this._port}};e.prototype.equalsTo=function(a){return a&&a instanceof e?this._ip==a._ip&&this._port==a._port:!1};return e}();
xnm.aio.yellowstone.Handler=function(){var k=function(){};k.prototype.Cloudy=xnm.aio.yellowstone.Cloudy;k.prototype.devicemanager=null;k.prototype.registModule=function(f){f.register("cloudy","yellowstone")};k.prototype.resolveGateway=function(f){return f&&f.ip?new xnm.aio.yellowstone.Cloudy(f.ip,f.port):null};k.prototype.getDeviceCommands=function(f,h){var g=this.devicemanager.applyUIFilter(f,{catagory:"command",elems:"*"}),g=g?g.command:[];h&&h(null,g)};k.prototype.getDeviceStatus=function(f,h){var g=
this.devicemanager.applyUIFilter(f,{catagory:"status",elems:"*"}),g=g?g.status:[];h&&h(null,g)};k.prototype.getGatewayCommands=function(f,h){var g=this.devicemanager.applyUIFilterGateway(f,{catagory:"command",elems:"*"}),g=g?g.command:[];h&&h(null,g)};k.prototype.getGatewayStatus=function(f,h){var g=this.devicemanager.applyUIFilterGateway(f,{catagory:"status",elems:"*"}),g=g?g.status:[];h&&h(null,g)};k.prototype.doCommand=function(f,h,g,k){(f=this.resolveGateway(f))?f.executeCommandCreator(h,g,function(e){k&&
k(e)}):k&&k(Error("gateway json format invalid"))};k.prototype.doStatus=function(f,h,g,k,e){(h=this.resolveGateway(h))?h.getStatesCreator(null,[{id:f,device:g,status:k}],function(a,b){a?e&&e(a):e&&e(null,b[0])}):e&&e(Error("gateway json format invalid"))};k.prototype.getDeviceList=function(f,h){this.resolveGateway(f)?h&&h(null,this.devicemanager.BG_LIST):h&&h(Error("gateway json format invalid"))};return k}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.yellowstone.Handler);
