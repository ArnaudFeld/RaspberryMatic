var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(b){var a=0;return function(){return a<b.length?{done:!1,value:b[a++]}:{done:!0}}};$jscomp.arrayIterator=function(b){return{next:$jscomp.arrayIteratorImpl(b)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,a,d){b!=Array.prototype&&b!=Object.prototype&&(b[a]=d.value)};$jscomp.getGlobal=function(b){b=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,b];for(var a=0;a<b.length;++a){var d=b[a];if(d&&d.Math==Math)return d}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(b,a){this.$jscomp$symbol$id_=b;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:a})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function b(d){if(this instanceof b)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(d||"")+"_"+a++,d)}var a=0;return b}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.iterator;b||(b=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[b]&&$jscomp.defineProperty(Array.prototype,b,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.asyncIterator;b||(b=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(b){$jscomp.initSymbolIterator();b={next:b};b[$jscomp.global.Symbol.iterator]=function(){return this};return b};
$jscomp.iteratorFromArray=function(b,a){$jscomp.initSymbolIterator();b instanceof String&&(b+="");var d=0,e={next:function(){if(d<b.length){var c=d++;return{value:a(c,b[c]),done:!1}}e.next=function(){return{done:!0,value:void 0}};return e.next()}};e[Symbol.iterator]=function(){return e};return e};
$jscomp.polyfill=function(b,a,d,e){if(a){d=$jscomp.global;b=b.split(".");for(e=0;e<b.length-1;e++){var c=b[e];c in d||(d[c]={});d=d[c]}b=b[b.length-1];e=d[b];a=a(e);a!=e&&null!=a&&$jscomp.defineProperty(d,b,{configurable:!0,writable:!0,value:a})}};$jscomp.polyfill("Array.prototype.keys",function(b){return b?b:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");var x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.gateway=x.hub.m.gateway||{};
x.hub.m.gateway.AIOMODULE=require("xnm.aio.gateway.js");
x.hub.m.gateway.Monitor=function(){var b=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.gateway.Monitor");var a=this;this._eventCallback=function(d,e){a._onGatewayEvent(d,e)};this._eventCallback.onError=function(d){a._restartEventListener()};this._restartTO=null};b.prototype.init=function(a){var d=this;x.hub.m.gateway.AIOMODULE.startGatewayEventListener(this._eventCallback,function(e){e?d._restartEventListener():d._restartTO&&(clearTimeout(d._restartTO),d._restartTO=null);a&&a()})};
b.prototype._onGatewayEvent=function(a,d){require("x.hub.eventbus.js").emit("gatewayevent",a,d,"EVT")};b.prototype._onEventListenerError=function(a){};b.prototype._restartEventListener=function(){this._restartTO&&clearTimeout(this._restartTO);var a=this;this._restartTO=setTimeout(function(){a.init()},5E3)};return b}();
x.hub.m.gateway.GatewayInternalHandler=function(){var b=function(){this._devices={};this._meta={};this._states={}};b.prototype.addStateDevice=function(a,d,e){if(a&&a.type&&a.address){a=JSON.parse(JSON.stringify(a));delete a.gateway;var c=this._getDeviceID(a);this._devices[c]||(this._devices[c]=a);this._meta[c]||(this._meta[c]=[]);this._states[c]||(this._states[c]={});e&&this._meta[c].push(e);d&&d()}else d&&d(Error("device json invalid"))};b.prototype.removeStateDevice=function(a,d,e){if(!a||!a.type||
!a.address)d&&d(Error("device json invalid"));else if(e){a=JSON.parse(JSON.stringify(a));delete a.gateway;a=this._getDeviceID(a);var c=this._meta[a];if(c){for(var b=-1,g=0;g<c.length;g++){var f=c[g];if(f&&f.src==e.src&&f.taskID==e.taskID&&f.statusKey==e.statusKey){b=g;break}}0<=b&&c.splice(b,1);0==c.length&&(delete this._devices[a],delete this._meta[a],delete this._states[a])}d&&d()}};b.prototype.onEvent=function(a,d,e){if(a&&a.type){d=null;var c=this._getSystem(a);if(c){var b=null,g;for(g in this._devices)if(this._devices.hasOwnProperty(g)){var f=
this._devices[g];if("EVT"==e&&c._handleUdpState){var h=c._handleUdpState(f,a);if(h&&0<Object.keys(h).length){b=f;this._getDeviceID(b);d=h;break}}else if("STA"==e&&c._handleState){if(a.sid){if(f.sid&&f.sid!=a.sid)continue;if(f.type!=a.type||f.address!=a.adr)continue}if(a.sid&&a.changed&&a.changed.length){var k=JSON.parse(JSON.stringify(a));k.state={};a.changed.forEach(function(c){k.state[c]=a.state[c]});h=c._handleState(f,k)}else h=c._handleState(f,a);if(h&&0<Object.keys(h).length){b=f;this._getDeviceID(b);
d=h;break}}else if("BTN"==e&&g==a.type+"@"+a.adr){b=f;d=a.state;break}}d&&this._updateState(b,d,a)}}};b.prototype._getDeviceID=function(a){return a&&a.sid?"sid@"+a.sid:a&&"ZWAVE2"==a.type?a.type+"@"+a.address+"."+a.instance:a.type+"@"+a.address};b.prototype._getSystem=function(a){return x.hub.m.gateway.AIOMODULE.devicemanager.getSystem(a)};b.prototype._updateState=function(a,d,e){var c=this._getDeviceID(a),b=this._meta[c],g=this._states[c]?this._states[c]:{};this._states[c]=d;if(b&&0<b.length)for(var f in d)if(d.hasOwnProperty(f)){c=
d[f];var h=g[f];c={key:f,value:c,changed:h!=c,oldValue:h};e&&e.sid&&e.changed&&e.changed.length&&(c.changed=!0,delete c.oldValue);h=require("x.hub.eventbus.js");require("x.hub.taskman.js");for(var k=0;k<b.length;k++){var l=b[k];!l||l.statusKey!=f&&"*"!=l.statusKey||h.emit("status",{module:"aio",device:a,gateway:null,data:c},l)}}};return b}();
x.hub.m.gateway.Handler=function(){var b=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.gateway.Handler");this._intHandler=new x.hub.m.gateway.GatewayInternalHandler;this._monitor=new x.hub.m.gateway.Monitor;this._on={};this._localIpBuffer=[];this._localIpUpdateInterval=null;this._db2GatewayNeoIndex=this._db1GatewayNeoIndex=0};b.prototype.on=function(a,d){this._on[a]=d};b.prototype._checkStateChange=function(a,d){};b.prototype.updateGatewayStates=function(a,d){d({})};b.prototype.updateStates=
function(a,d){d({})};b.prototype.getStates=function(a){return{}};b.prototype.getAllStates=function(){return[]};b.prototype.init=function(a){var d=this;require("x.hub.eventbus.js").on("gatewayevent",function(a,c,b){d._onEvent(a,c,b)});localStorage&&(this._db1GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB1NeoIdx"),this._db2GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB2NeoIdx"));this._updateLocalIPBuffer();this._localIpUpdateInterval=setInterval(function(){d._updateLocalIPBuffer()},
18E5);this._monitor.init()};b.prototype.getSystems=function(){return["aio"]};b.prototype.addStateDevice=function(a,d,b){a&&a.type&&a.address?this._intHandler.addStateDevice(a,function(a){d&&d({error:a})},b):d&&d({error:Error("device json invalid")})};b.prototype.removeStateDevice=function(a,d,b){a&&a.type&&a.address?this._intHandler.removeStateDevice(a,function(a){d&&d({error:a})},b):d&&d({error:Error("device json invalid")})};b.prototype.getState=function(a,d,b){if(a.gateway)if(a.gateway.ip){a=JSON.parse(JSON.stringify(a));
var c=a.gateway;c=this._processPassword(c);c.__isself?this._getStateLocal(c,a,d,b):x.hub.m.gateway.AIOMODULE.doStatus("hub",c,a,{value:d},function(a,c){var d=null;c&&(d={value:c.status,time:(new Date).getTime()});b&&b({error:a,data:d})})}else b&&b({error:Error("gateway json invalid")});else this._getStateIQ(a,d,b)};b.prototype.executeCommand=function(a,d,b){if(a)if(a.gateway){a=JSON.parse(JSON.stringify(a));var c=a.gateway;c.ip?((c=this._processPassword(c))&&!a.type&&(a=c),c.__isself?this._executeCommandLocal(c,
a,d,b):x.hub.m.gateway.AIOMODULE.doCommand(c,a,d,function(a){b&&b({error:a})})):b&&b({errror:Error("gateway json invalid")})}else this._executeCommandIQ(a,d,b);else b&&b({error:Error("device is null")})};b.prototype.checkDeviceMatch=function(a,d){if(!(d&&d.device&&a&&a.device))return!1;var b=a.device.address;b&&"string"==typeof b&&(b=b.toUpperCase());var c=d.device.address;c&&"string"==typeof c&&(c=c.toUpperCase());a=a.device.type;return b==c&&a==d.device.type};b.prototype.updateGatewayNeoIndex=function(){localStorage&&
(this._db1GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB1NeoIdx"),this._db2GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB2NeoIdx"))};b.prototype._onEvent=function(a,b,e){if(!(a.module||a.sys||(this._logger.log("trace","from "+(b?b.address:null)+" receive "+e+" event:"+JSON.stringify(a)),this._localIpBuffer&&b&&b.address&&"STA"==e&&-1!=this._localIpBuffer.indexOf(b.address)||b&&"Sysvar"!=b.address&&a.type&&-1!=["ONOFF","FLOAT","STRING","INT"].indexOf(a.type)))){var c=require("x.hub.eventbus.js");
if(a.type&&"IR"==a.type&&a.data)c.emit("irevt",{code:a.data});else this._intHandler.onEvent(a,b,e)}};b.prototype._executeCommandIQ=function(a,b,e){if(a.type){var c;if("HM"==a.type.toUpperCase())"ip_siren"==a.data&&(b.value=x.hub.m.gateway.AIOMODULE.Systems.HM_X._buildData(null,a,b)),(c=require("x.hub.moduleman.js").modulemanager.getModule("hm"))?c.executeCommand(a,b,e):e&&e({error:Error("no module for type HM")});else if("ENOCEAN"==a.type.toUpperCase())(c=require("x.hub.moduleman.js").modulemanager.getModule("enocean"))?
c.executeCommand(a,b,e):e&&e({error:Error("no module for type ENOCEAN")});else{var d=x.hub.m.gateway.AIOMODULE.getGatewayFunctionForType(a.type);if(d){if("CODE"==a.type){var g=x.hub.m.gateway.AIOMODULE.Systems.Code._rebuildDevice(JSON.parse(JSON.stringify(a)));a=x.hub.m.gateway.AIOMODULE.Systems.Code._findIRCode(b,a);a=x.hub.m.gateway.AIOMODULE.Systems.Code._buildParam(a,g)}else a="BG"==a.type?x.hub.m.gateway.AIOMODULE.Systems.BG._buildParam(null,a,b):x.hub.m.gateway.AIOMODULE.getGatewayParams(a,
b.value);d="http://localhost/command?XC_FNC="+d;if(a)for(c in a)d+="&"+c+"="+encodeURIComponent(a[c]);try{var f=require("x.hub.js").server;f?f._doSTMCommandRequest(d,!1,function(a){e&&e({error:a})}):e&&e({error:Error("server not initialized")})}catch(h){e&&e({error:h})}}else e&&e({error:Error("unknow device type")})}}else e&&e({error:Error("device type is null")})};b.prototype._executeCommandLocal=function(a,b,e,c){var d=x.hub.m.gateway.AIOMODULE.devicemanager.getSystem(b,a);if(d&&d.buildQuery){var g=
x.hub.m.gateway.AIOMODULE.resolveGateway(a);if(d=d.buildQuery(g?g:a,b,e)){try{var f=require("x.hub.js").server;if(!f){c&&c({error:Error("server not initialized")});return}var h=require("querystring"),k,l;if(d.fnc&&0==d.fnc.indexOf("/api")){(l=k=d.fnc)&&delete d.fnc;if(d.data)d=d.data;else{var m=h.stringify(d);d=h.parse(m);l=k+"?"+m}var p={url:l,query:d}}else"SendGenericCmd"==d.XC_FNC?(k="/cmd",p={method:"POST",url:l,query:d,json:d}):(k="/cmd",m=h.stringify(d),d=h.parse(m),l=k+"?"+m,p={url:l,query:d});
this._logger.log("trace","execute command local directly "+l);var q=this;f.doRequest(k,p,function(a){q._logger.log("trace","execute command local directly return:"+JSON.stringify(a));var b=null;if(a)try{(b=JSON.parse(a))&&b.XC_SUC?c&&c({data:b}):b&&b.XC_ERR?c&&c({error:Error(a)}):c&&c({error:Error("/cmd request return invalid format")})}catch(t){c&&c({error:t})}else c&&c({error:Error("/cmd request return null")})})}catch(r){c&&c({error:r})}return}}this._logger.log("trace","execute command via localhost:"+
JSON.stringify(b)+" command:"+JSON.stringify(e));x.hub.m.gateway.AIOMODULE.doCommand(a,b,e,function(a){c&&c({error:a})})};b.prototype._getStateIQ=function(a,b,e){var c={ip:"127.0.0.1",port:require("x.hub.js").server._port,version:"EA"};c=this._processPassword(c);this._getStateLocal(c,a,b,e)};b.prototype._getStateLocal=function(a,b,e,c){var d=function(a,b,c){if(a.error)return{error:a.error};a=c._handleGeneralStatesRsp(a.data,b);b=null;a&&a[0]&&(b={value:a[0].status,time:(new Date).getTime()});return{error:null,
data:b}},g=x.hub.m.gateway.AIOMODULE.resolveGateway(a);if(g){var f=[{id:"hub",device:b,status:{value:e}}],h=this;if(b&&"dev"==b.common_type)b.id?require("x.hub.commandman.js").commandHandlerV6.getDeviceStatesWithId(b.id,function(a,b){a?c&&c({error:a}):(a={value:b?b[e]:null,time:(new Date).getTime()},c&&c({error:null,data:a}))}):c&&c({error:Error("device json invalid")});else if(b&&b.type)switch(b.type){case "HM":require("x.hub.m.hm.js").getAllStatesLegacy(function(a){a=d(a,f,g);c&&c(a)});break;case "ENOCEAN":require("x.hub.m.enocean.js").getAllStatesLegacy(function(a){a=
d(a,f,g);c&&c(a)});break;case "ZWAVE2":require("x.hub.m.zway.js").getAllStatesLegacy(function(a){a=d(a,f,g);c&&c(a)});break;case "KNX":require("x.hub.m.knx.js").getAllStatesLegacy(function(a){a=d(a,f,g);c&&c(a)});break;case "ZIGBEE":require("x.hub.m.zigbee.js").getAllStatesLegacy(function(a){a=d(a,f,g);c&&c(a)});break;case "ONOFF":case "FLOAT":case "INT":case "STRING":require("x.hub.sysvarman.js").getSysvarStates(function(a){a=d(a,f,g);c&&c(a)});break;case "TASK":require("x.hub.taskman.js").readAllTasks(function(a){if(a.error)a=
d(a,f,g);else{var b=[];a.data.forEach(function(a){a&&b.push({type:"TASK",id:a.id,active:a.active})});a=d({data:b},f,g)}c&&c(a)});break;default:(a=require("x.hub.js").server)?(this._logger.log("trace","get states from ST directly"),a.doSTMCommand("XC_FNC=getStates",function(a){h._logger.log("trace","get states from ST return:"+JSON.stringify(a));if(a)if(a.XC_SUC){var b={data:null};Array.isArray(a.XC_SUC)?b.data=a.XC_SUC:0<Object.keys(a.XC_SUC).length&&(b.data=[a.XC_SUC]);a=d(b,f,g);c&&c(a)}else c&&
c({error:Error("ST get states return error:"+JSON.stringify(a))});else c&&c({error:Error("ST get states return null")})})):c&&c({error:Error("server not initialized")})}else x.hub.m.gateway.AIOMODULE.doStatus("hub",a,b,{value:e},function(a,b){var d=null;b&&(d={value:b.status,time:(new Date).getTime()});c&&c({error:a,data:d})})}else c&&c({error:Error("gateway json format invalid")})};b.prototype._processPassword=function(a){var b=this._localIpBuffer,e="";localStorage&&(e=localStorage.getItem("x.hub.Server.pwd"));
"localhost"==a.ip||"127.0.0.1"==a.ip||-1!=b.indexOf(a.ip)?(a.__isself=!0,e&&(a.at=e)):a.__neoInfo&&(1==a.__neoInfo.db&&a.__neoInfo.index==this._db1GatewayNeoIndex?(a.__isself=!0,e&&(a.at=e)):2==a.__neoInfo.db&&a.__neoInfo.index==this._db2GatewayNeoIndex&&(a.__isself=!0,e&&(a.at=e)));return a};b.prototype._updateLocalIPBuffer=function(){(new Date).getTime();var a=[],b=require("os").networkInterfaces(),e;for(e in b)for(var c=b[e],n=0;n<c.length;n++)a.push(c[n].address);this._localIpBuffer=a};return b}();
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.gateway.Handler);
