var x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.gateway=x.hub.m.gateway||{};require("x.logger.js").setLevel("trace","x.hub.m.gateway");x.hub.m.gateway.AIOMODULE=require("xnm.aio.gateway.js");
x.hub.m.gateway.Monitor=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.gateway.Monitor");var a=this;this._eventCallback=function(b,d){a._onGatewayEvent(b,d)};this._eventCallback.onError=function(b){a._restartEventListener()};this._restartTO=null};e.prototype.init=function(a){var b=this;x.hub.m.gateway.AIOMODULE.startGatewayEventListener(this._eventCallback,function(d){d?b._restartEventListener():b._restartTO&&(clearTimeout(b._restartTO),b._restartTO=null);a&&a()})};
e.prototype._onGatewayEvent=function(a,b){require("x.hub.eventbus.js").emit("gatewayevent",a,b,"EVT")};e.prototype._onEventListenerError=function(a){};e.prototype._restartEventListener=function(){this._restartTO&&clearTimeout(this._restartTO);var a=this;this._restartTO=setTimeout(function(){a.init()},5E3)};return e}();
x.hub.m.gateway.GatewayInternalHandler=function(){var e=function(){this._devices={};this._meta={}};e.prototype.addStateDevice=function(a,b,d){if(a&&a.type&&a.address){a=JSON.parse(JSON.stringify(a));delete a.gateway;var c=this._getDeviceID(a);this._devices[c]||(this._devices[c]=a);this._meta[c]||(this._meta[c]=[]);d&&this._meta[c].push(d);b&&b()}else b&&b(Error("device json invalid"))};e.prototype.removeStateDevice=function(a,b,d){if(!a||!a.type||!a.address)b&&b(Error("device json invalid"));else if(d){a=
JSON.parse(JSON.stringify(a));delete a.gateway;a=this._getDeviceID(a);var c=this._meta[a];if(c){for(var h=-1,e=0;e<c.length;e++){var f=c[e];if(f&&f.src==d.src&&f.taskID==d.taskID&&f.statusKey==d.statusKey){h=e;break}}0<=h&&c.splice(h,1);0==c.length&&(delete this._devices[a],delete this._meta[a])}b&&b()}};e.prototype.onEvent=function(a,b,d){if(a&&a.type){b=null;var c=this._getSystem(a);if(c){var h=null,e;for(e in this._devices)if(this._devices.hasOwnProperty(e)){var f=this._devices[e];if("EVT"==d&&
c._handleUdpState){var g=c._handleUdpState(f,a);if(g&&0<Object.keys(g).length){h=f;this._getDeviceID(h);b=g;break}}else if("STA"==d&&c._handleState){if((g=c._handleState(f,a))&&0<Object.keys(g).length){h=f;this._getDeviceID(h);b=g;break}}else if("BTN"==d&&e==a.type+"@"+a.adr){h=f;b=a.state;break}}b&&this._updateState(h,b)}}};e.prototype._getDeviceID=function(a){return a&&"ZWAVE2"==a.type?a.type+"@"+a.address+"."+a.instance:a.type+"@"+a.address};e.prototype._getSystem=function(a){return x.hub.m.gateway.AIOMODULE.devicemanager.getSystem(a)};
e.prototype._updateState=function(a,b){var d=this._getDeviceID(a);if((d=this._meta[d])&&0<d.length)for(var c in b)if(b.hasOwnProperty(c)){var h=b[c],h={key:c,value:h,changed:void 0!=h,oldValue:void 0},e=require("x.hub.eventbus.js");require("x.hub.taskman.js");for(var f=0;f<d.length;f++){var g=d[f];!g||g.statusKey!=c&&"*"!=g.statusKey||e.emit("status",{module:"aio",device:a,gateway:null,data:h},g)}}};return e}();
x.hub.m.gateway.Handler=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.gateway.Handler");this._intHandler=new x.hub.m.gateway.GatewayInternalHandler;this._monitor=new x.hub.m.gateway.Monitor;this._on={};this._localIpBuffer=[];this._localIpUpdateInterval=null;this._db2GatewayNeoIndex=this._db1GatewayNeoIndex=0};e.prototype.on=function(a,b){this._on[a]=b};e.prototype._checkStateChange=function(a,b){};e.prototype.updateGatewayStates=function(a,b){b({})};e.prototype.updateStates=
function(a,b){b({})};e.prototype.getStates=function(a){return{}};e.prototype.getAllStates=function(){return[]};e.prototype.init=function(a){var b=this;require("x.hub.eventbus.js").on("gatewayevent",function(a,c,h){b._onEvent(a,c,h)});localStorage&&(this._db1GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB1NeoIdx"),this._db2GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB2NeoIdx"));this._updateLocalIPBuffer();this._localIpUpdateInterval=setInterval(function(){b._updateLocalIPBuffer()},
18E5);this._monitor.init()};e.prototype.getSystems=function(){return["aio"]};e.prototype.addStateDevice=function(a,b,d){a&&a.type&&a.address?this._intHandler.addStateDevice(a,function(a){b&&b({error:a})},d):b&&b({error:Error("device json invalid")})};e.prototype.removeStateDevice=function(a,b,d){a&&a.type&&a.address?this._intHandler.removeStateDevice(a,function(a){b&&b({error:a})},d):b&&b({error:Error("device json invalid")})};e.prototype.getState=function(a,b,d){if(a.gateway)if(a.gateway.ip){a=JSON.parse(JSON.stringify(a));
var c=a.gateway,c=this._processPassword(c);c.__isself?this._getStateLocal(c,a,b,d):x.hub.m.gateway.AIOMODULE.doStatus("hub",c,a,{value:b},function(a,c){var b=null;c&&(b={value:c.status,time:(new Date).getTime()});d&&d({error:a,data:b})})}else d&&d({error:Error("gateway json invalid")});else this._getStateIQ(a,b,d)};e.prototype.executeCommand=function(a,b,d){if(a)if(a.gateway){a=JSON.parse(JSON.stringify(a));var c=a.gateway;c.ip?((c=this._processPassword(c))&&!a.type&&(a=c),c.__isself?this._executeCommandLocal(c,
a,b,d):x.hub.m.gateway.AIOMODULE.doCommand(c,a,b,function(a){d&&d({error:a})})):d&&d({errror:Error("gateway json invalid")})}else this._executeCommandIQ(a,b,d);else d&&d({error:Error("device is null")})};e.prototype.checkDeviceMatch=function(a,b){if(!(b&&b.device&&a&&a.device))return!1;var d=a.device.address;d&&"string"==typeof d&&(d=d.toUpperCase());var c=b.device.address;c&&"string"==typeof c&&(c=c.toUpperCase());var e=a.device.type;return d==c&&e==b.device.type};e.prototype.updateGatewayNeoIndex=
function(){localStorage&&(this._db1GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB1NeoIdx"),this._db2GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB2NeoIdx"))};e.prototype._onEvent=function(a,b,d){if(!(a.module||a.sys||(this._logger.log("trace","from "+(b?b.address:null)+" receive "+d+" event:"+JSON.stringify(a)),this._localIpBuffer&&b&&b.address&&"STA"==d&&-1!=this._localIpBuffer.indexOf(b.address)||b&&"Sysvar"!=b.address&&a.type&&-1!=["ONOFF","FLOAT","STRING","INT"].indexOf(a.type)))){var c=
require("x.hub.eventbus.js");if(a.type&&"IR"==a.type&&a.data)c.emit("irevt",{code:a.data});else this._intHandler.onEvent(a,b,d)}};e.prototype._executeCommandIQ=function(a,b,d){if(a.type){var c;if("HM"==a.type.toUpperCase())"ip_siren"==a.data&&(b.value=x.hub.m.gateway.AIOMODULE.Systems.HM_X._buildData(null,a,b)),(c=require("x.hub.moduleman.js").modulemanager.getModule("hm"))?c.executeCommand(a,b,d):d&&d({error:Error("no module for type HM")});else if("ENOCEAN"==a.type.toUpperCase())(c=require("x.hub.moduleman.js").modulemanager.getModule("enocean"))?
c.executeCommand(a,b,d):d&&d({error:Error("no module for type ENOCEAN")});else{var e=x.hub.m.gateway.AIOMODULE.getGatewayFunctionForType(a.type);if(e){if("CODE"==a.type){var k=x.hub.m.gateway.AIOMODULE.Systems.Code._rebuildDevice(JSON.parse(JSON.stringify(a)));a=x.hub.m.gateway.AIOMODULE.Systems.Code._findIRCode(b,a);a=x.hub.m.gateway.AIOMODULE.Systems.Code._buildParam(a,k)}else a="BG"==a.type?x.hub.m.gateway.AIOMODULE.Systems.BG._buildParam(null,a,b):x.hub.m.gateway.AIOMODULE.getGatewayParams(a,
b.value);e="http://localhost/command?XC_FNC="+e;if(a)for(c in a)e+="&"+c+"="+encodeURIComponent(a[c]);try{var f=require("x.hub.js").server;f?f._doSTMCommandRequest(e,!1,function(a){d&&d({error:a})}):d&&d({error:Error("server not initialized")})}catch(g){d&&d({error:g})}}else d&&d({error:Error("unknow device type")})}}else d&&d({error:Error("device type is null")})};e.prototype._executeCommandLocal=function(a,b,d,c){var e=x.hub.m.gateway.AIOMODULE.devicemanager.getSystem(b,a);if(e&&e.buildQuery&&(e=
e.buildQuery(a,b,d))){try{var k=require("x.hub.js").server;if(!k){c&&c({error:Error("server not initialized")});return}var f=require("querystring"),g=f.stringify(e),e=f.parse(g);a="/cmd?"+g;this._logger.log("trace","execute command local directly "+a);var l=this;k.doRequest("/cmd",{url:a,query:e},function(a){l._logger.log("trace","execute command local directly return:"+JSON.stringify(a));var b=null;if(a)try{(b=JSON.parse(a))&&b.XC_SUC?c&&c({data:b}):b&&b.XC_ERR?c&&c({error:Error(a)}):c&&c({error:Error("/cmd request return invalid format")})}catch(d){c&&
c({error:d})}else c&&c({error:Error("/cmd request return null")})})}catch(m){c&&c({error:m})}return}this._logger.log("trace","execute command via localhost:"+JSON.stringify(b)+" command:"+JSON.stringify(d));x.hub.m.gateway.AIOMODULE.doCommand(a,b,d,function(a){c&&c({error:a})})};e.prototype._getStateIQ=function(a,b,d){var c={ip:"127.0.0.1",port:require("x.hub.js").server._port,version:"EA"},c=this._processPassword(c);this._getStateLocal(c,a,b,d)};e.prototype._getStateLocal=function(a,b,d,c){var e=
function(a,c,b){if(a.error)return{error:a.error};a=b._handleGeneralStatesRsp(a.data,c);c=null;a&&a[0]&&(c={value:a[0].status,time:(new Date).getTime()});return{error:null,data:c}},k=x.hub.m.gateway.AIOMODULE.resolveGateway(a);if(k){var f=[{id:"hub",device:b,status:{value:d}}],g=this;if(b&&b.type)switch(b.type){case "HM":require("x.hub.m.hm.js").getAllStatesLegacy(function(a){a=e(a,f,k);c&&c(a)});break;case "ENOCEAN":require("x.hub.m.enocean.js").getAllStatesLegacy(function(a){a=e(a,f,k);c&&c(a)});
break;case "ZWAVE2":require("x.hub.m.zway.js").getAllStatesLegacy(function(a){a=e(a,f,k);c&&c(a)});break;case "KNX":require("x.hub.m.knx.js").getAllStatesLegacy(function(a){a=e(a,f,k);c&&c(a)});break;case "ZIGBEE":require("x.hub.m.zigbee.js").getAllStatesLegacy(function(a){a=e(a,f,k);c&&c(a)});break;case "ONOFF":case "FLOAT":case "INT":case "STRING":require("x.hub.sysvarman.js").getSysvarStates(function(a){a=e(a,f,k);c&&c(a)});break;case "TASK":require("x.hub.taskman.js").readAllTasks(function(a){if(a.error)a=
e(a,f,k);else{var b=[];a.data.forEach(function(a){a&&b.push({type:"TASK",id:a.id,active:a.active})});a=e({data:b},f,k)}c&&c(a)});break;default:a=require("x.hub.js").server;if(!a){c&&c({error:Error("server not initialized")});break}this._logger.log("trace","get states from ST directly");a.doSTMCommand("XC_FNC=getStates",function(a){g._logger.log("trace","get states from ST return:"+JSON.stringify(a));if(a)if(a.XC_SUC){var b={data:null};Array.isArray(a.XC_SUC)?b.data=a.XC_SUC:0<Object.keys(a.XC_SUC).length&&
(b.data=[a.XC_SUC]);a=e(b,f,k);c&&c(a)}else c&&c({error:Error("ST get states return error:"+JSON.stringify(a))});else c&&c({error:Error("ST get states return null")})})}else x.hub.m.gateway.AIOMODULE.doStatus("hub",a,b,{value:d},function(a,b){var d=null;b&&(d={value:b.status,time:(new Date).getTime()});c&&c({error:a,data:d})})}else c&&c({error:Error("gateway json format invalid")})};e.prototype._processPassword=function(a){var b=this._localIpBuffer,d="";localStorage&&(d=localStorage.getItem("x.hub.Server.pwd"));
"localhost"==a.ip||"127.0.0.1"==a.ip||-1!=b.indexOf(a.ip)?(a.__isself=!0,d&&(a.at=d)):a.__neoInfo&&(1==a.__neoInfo.db&&a.__neoInfo.index==this._db1GatewayNeoIndex?(a.__isself=!0,d&&(a.at=d)):2==a.__neoInfo.db&&a.__neoInfo.index==this._db2GatewayNeoIndex&&(a.__isself=!0,d&&(a.at=d)));return a};e.prototype._updateLocalIPBuffer=function(){(new Date).getTime();var a=[],b=require("os").networkInterfaces(),d;for(d in b)for(var c=b[d],e=0;e<c.length;e++)a.push(c[e].address);this._localIpBuffer=a};return e}();
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.gateway.Handler);
