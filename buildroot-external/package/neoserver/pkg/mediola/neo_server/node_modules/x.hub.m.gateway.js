var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(c,a,b){c!=Array.prototype&&c!=Object.prototype&&(c[a]=b.value)};$jscomp.getGlobal=function(c){return"undefined"!=typeof window&&window===c?c:"undefined"!=typeof global&&null!=global?global:c};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var c=0;return function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+c++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var c=$jscomp.global.Symbol.iterator;c||(c=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[c]&&$jscomp.defineProperty(Array.prototype,c,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(c){var a=0;return $jscomp.iteratorPrototype(function(){return a<c.length?{done:!1,value:c[a++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(c){$jscomp.initSymbolIterator();c={next:c};c[$jscomp.global.Symbol.iterator]=function(){return this};return c};$jscomp.iteratorFromArray=function(c,a){$jscomp.initSymbolIterator();c instanceof String&&(c+="");var b=0,e={next:function(){if(b<c.length){var d=b++;return{value:a(d,c[d]),done:!1}}e.next=function(){return{done:!0,value:void 0}};return e.next()}};e[Symbol.iterator]=function(){return e};return e};
$jscomp.polyfill=function(c,a,b,e){if(a){b=$jscomp.global;c=c.split(".");for(e=0;e<c.length-1;e++){var d=c[e];d in b||(b[d]={});b=b[d]}c=c[c.length-1];e=b[c];a=a(e);a!=e&&null!=a&&$jscomp.defineProperty(b,c,{configurable:!0,writable:!0,value:a})}};$jscomp.polyfill("Array.prototype.keys",function(c){return c?c:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");var x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.gateway=x.hub.m.gateway||{};
require("x.logger.js").setLevel("trace","x.hub.m.gateway");x.hub.m.gateway.AIOMODULE=require("xnm.aio.gateway.js");
x.hub.m.gateway.Monitor=function(){var c=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.gateway.Monitor");var a=this;this._eventCallback=function(b,e){a._onGatewayEvent(b,e)};this._eventCallback.onError=function(b){a._restartEventListener()};this._restartTO=null};c.prototype.init=function(a){var b=this;x.hub.m.gateway.AIOMODULE.startGatewayEventListener(this._eventCallback,function(e){e?b._restartEventListener():b._restartTO&&(clearTimeout(b._restartTO),b._restartTO=null);a&&a()})};
c.prototype._onGatewayEvent=function(a,b){require("x.hub.eventbus.js").emit("gatewayevent",a,b,"EVT")};c.prototype._onEventListenerError=function(a){};c.prototype._restartEventListener=function(){this._restartTO&&clearTimeout(this._restartTO);var a=this;this._restartTO=setTimeout(function(){a.init()},5E3)};return c}();
x.hub.m.gateway.GatewayInternalHandler=function(){var c=function(){this._devices={};this._meta={}};c.prototype.addStateDevice=function(a,b,e){if(a&&a.type&&a.address){a=JSON.parse(JSON.stringify(a));delete a.gateway;var d=this._getDeviceID(a);this._devices[d]||(this._devices[d]=a);this._meta[d]||(this._meta[d]=[]);e&&this._meta[d].push(e);b&&b()}else b&&b(Error("device json invalid"))};c.prototype.removeStateDevice=function(a,b,e){if(!a||!a.type||!a.address)b&&b(Error("device json invalid"));else if(e){a=
JSON.parse(JSON.stringify(a));delete a.gateway;a=this._getDeviceID(a);var d=this._meta[a];if(d){for(var c=-1,g=0;g<d.length;g++){var f=d[g];if(f&&f.src==e.src&&f.taskID==e.taskID&&f.statusKey==e.statusKey){c=g;break}}0<=c&&d.splice(c,1);0==d.length&&(delete this._devices[a],delete this._meta[a])}b&&b()}};c.prototype.onEvent=function(a,b,e){if(a&&a.type){b=null;var d=this._getSystem(a);if(d){var c=null,g;for(g in this._devices)if(this._devices.hasOwnProperty(g)){var f=this._devices[g];if("EVT"==e&&
d._handleUdpState){var h=d._handleUdpState(f,a);if(h&&0<Object.keys(h).length){c=f;this._getDeviceID(c);b=h;break}}else if("STA"==e&&d._handleState){if((h=d._handleState(f,a))&&0<Object.keys(h).length){c=f;this._getDeviceID(c);b=h;break}}else if("BTN"==e&&g==a.type+"@"+a.adr){c=f;b=a.state;break}}b&&this._updateState(c,b)}}};c.prototype._getDeviceID=function(a){return a&&"ZWAVE2"==a.type?a.type+"@"+a.address+"."+a.instance:a.type+"@"+a.address};c.prototype._getSystem=function(a){return x.hub.m.gateway.AIOMODULE.devicemanager.getSystem(a)};
c.prototype._updateState=function(a,b){var e=this._getDeviceID(a);if((e=this._meta[e])&&0<e.length)for(var d in b)if(b.hasOwnProperty(d)){var c=b[d];c={key:d,value:c,changed:void 0!=c,oldValue:void 0};var g=require("x.hub.eventbus.js");require("x.hub.taskman.js");for(var f=0;f<e.length;f++){var h=e[f];!h||h.statusKey!=d&&"*"!=h.statusKey||g.emit("status",{module:"aio",device:a,gateway:null,data:c},h)}}};return c}();
x.hub.m.gateway.Handler=function(){var c=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.gateway.Handler");this._intHandler=new x.hub.m.gateway.GatewayInternalHandler;this._monitor=new x.hub.m.gateway.Monitor;this._on={};this._localIpBuffer=[];this._localIpUpdateInterval=null;this._db2GatewayNeoIndex=this._db1GatewayNeoIndex=0};c.prototype.on=function(a,b){this._on[a]=b};c.prototype._checkStateChange=function(a,b){};c.prototype.updateGatewayStates=function(a,b){b({})};c.prototype.updateStates=
function(a,b){b({})};c.prototype.getStates=function(a){return{}};c.prototype.getAllStates=function(){return[]};c.prototype.init=function(a){var b=this;require("x.hub.eventbus.js").on("gatewayevent",function(a,d,c){b._onEvent(a,d,c)});localStorage&&(this._db1GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB1NeoIdx"),this._db2GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB2NeoIdx"));this._updateLocalIPBuffer();this._localIpUpdateInterval=setInterval(function(){b._updateLocalIPBuffer()},
18E5);this._monitor.init()};c.prototype.getSystems=function(){return["aio"]};c.prototype.addStateDevice=function(a,b,e){a&&a.type&&a.address?this._intHandler.addStateDevice(a,function(a){b&&b({error:a})},e):b&&b({error:Error("device json invalid")})};c.prototype.removeStateDevice=function(a,b,e){a&&a.type&&a.address?this._intHandler.removeStateDevice(a,function(a){b&&b({error:a})},e):b&&b({error:Error("device json invalid")})};c.prototype.getState=function(a,b,e){if(a.gateway)if(a.gateway.ip){a=JSON.parse(JSON.stringify(a));
var d=a.gateway;d=this._processPassword(d);d.__isself?this._getStateLocal(d,a,b,e):x.hub.m.gateway.AIOMODULE.doStatus("hub",d,a,{value:b},function(a,b){var d=null;b&&(d={value:b.status,time:(new Date).getTime()});e&&e({error:a,data:d})})}else e&&e({error:Error("gateway json invalid")});else this._getStateIQ(a,b,e)};c.prototype.executeCommand=function(a,b,e){if(a)if(a.gateway){a=JSON.parse(JSON.stringify(a));var d=a.gateway;d.ip?((d=this._processPassword(d))&&!a.type&&(a=d),d.__isself?this._executeCommandLocal(d,
a,b,e):x.hub.m.gateway.AIOMODULE.doCommand(d,a,b,function(a){e&&e({error:a})})):e&&e({errror:Error("gateway json invalid")})}else this._executeCommandIQ(a,b,e);else e&&e({error:Error("device is null")})};c.prototype.checkDeviceMatch=function(a,b){if(!(b&&b.device&&a&&a.device))return!1;var e=a.device.address;e&&"string"==typeof e&&(e=e.toUpperCase());var d=b.device.address;d&&"string"==typeof d&&(d=d.toUpperCase());a=a.device.type;return e==d&&a==b.device.type};c.prototype.updateGatewayNeoIndex=function(){localStorage&&
(this._db1GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB1NeoIdx"),this._db2GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB2NeoIdx"))};c.prototype._onEvent=function(a,b,e){if(!(a.module||a.sys||(this._logger.log("trace","from "+(b?b.address:null)+" receive "+e+" event:"+JSON.stringify(a)),this._localIpBuffer&&b&&b.address&&"STA"==e&&-1!=this._localIpBuffer.indexOf(b.address)||b&&"Sysvar"!=b.address&&a.type&&-1!=["ONOFF","FLOAT","STRING","INT"].indexOf(a.type)))){var d=require("x.hub.eventbus.js");
if(a.type&&"IR"==a.type&&a.data)d.emit("irevt",{code:a.data});else this._intHandler.onEvent(a,b,e)}};c.prototype._executeCommandIQ=function(a,b,e){if(a.type){var d;if("HM"==a.type.toUpperCase())"ip_siren"==a.data&&(b.value=x.hub.m.gateway.AIOMODULE.Systems.HM_X._buildData(null,a,b)),(d=require("x.hub.moduleman.js").modulemanager.getModule("hm"))?d.executeCommand(a,b,e):e&&e({error:Error("no module for type HM")});else if("ENOCEAN"==a.type.toUpperCase())(d=require("x.hub.moduleman.js").modulemanager.getModule("enocean"))?
d.executeCommand(a,b,e):e&&e({error:Error("no module for type ENOCEAN")});else{var c=x.hub.m.gateway.AIOMODULE.getGatewayFunctionForType(a.type);if(c){if("CODE"==a.type){var g=x.hub.m.gateway.AIOMODULE.Systems.Code._rebuildDevice(JSON.parse(JSON.stringify(a)));a=x.hub.m.gateway.AIOMODULE.Systems.Code._findIRCode(b,a);a=x.hub.m.gateway.AIOMODULE.Systems.Code._buildParam(a,g)}else a="BG"==a.type?x.hub.m.gateway.AIOMODULE.Systems.BG._buildParam(null,a,b):x.hub.m.gateway.AIOMODULE.getGatewayParams(a,
b.value);c="http://localhost/command?XC_FNC="+c;if(a)for(d in a)c+="&"+d+"="+encodeURIComponent(a[d]);try{var f=require("x.hub.js").server;f?f._doSTMCommandRequest(c,!1,function(a){e&&e({error:a})}):e&&e({error:Error("server not initialized")})}catch(h){e&&e({error:h})}}else e&&e({error:Error("unknow device type")})}}else e&&e({error:Error("device type is null")})};c.prototype._executeCommandLocal=function(a,b,e,d){var c=x.hub.m.gateway.AIOMODULE.devicemanager.getSystem(b,a);if(c&&c.buildQuery&&(c=
c.buildQuery(a,b,e))){try{var g=require("x.hub.js").server;if(!g){d&&d({error:Error("server not initialized")});return}var f=require("querystring"),h=f.stringify(c);c=f.parse(h);a="/cmd?"+h;this._logger.log("trace","execute command local directly "+a);var l=this;g.doRequest("/cmd",{url:a,query:c},function(a){l._logger.log("trace","execute command local directly return:"+JSON.stringify(a));var b=null;if(a)try{(b=JSON.parse(a))&&b.XC_SUC?d&&d({data:b}):b&&b.XC_ERR?d&&d({error:Error(a)}):d&&d({error:Error("/cmd request return invalid format")})}catch(n){d&&
d({error:n})}else d&&d({error:Error("/cmd request return null")})})}catch(m){d&&d({error:m})}return}this._logger.log("trace","execute command via localhost:"+JSON.stringify(b)+" command:"+JSON.stringify(e));x.hub.m.gateway.AIOMODULE.doCommand(a,b,e,function(a){d&&d({error:a})})};c.prototype._getStateIQ=function(a,b,c){var d={ip:"127.0.0.1",port:require("x.hub.js").server._port,version:"EA"};d=this._processPassword(d);this._getStateLocal(d,a,b,c)};c.prototype._getStateLocal=function(a,b,c,d){var e=
function(a,b,c){if(a.error)return{error:a.error};a=c._handleGeneralStatesRsp(a.data,b);b=null;a&&a[0]&&(b={value:a[0].status,time:(new Date).getTime()});return{error:null,data:b}},g=x.hub.m.gateway.AIOMODULE.resolveGateway(a);if(g){var f=[{id:"hub",device:b,status:{value:c}}],h=this;if(b&&b.type)switch(b.type){case "HM":require("x.hub.m.hm.js").getAllStatesLegacy(function(a){a=e(a,f,g);d&&d(a)});break;case "ENOCEAN":require("x.hub.m.enocean.js").getAllStatesLegacy(function(a){a=e(a,f,g);d&&d(a)});
break;case "ZWAVE2":require("x.hub.m.zway.js").getAllStatesLegacy(function(a){a=e(a,f,g);d&&d(a)});break;case "KNX":require("x.hub.m.knx.js").getAllStatesLegacy(function(a){a=e(a,f,g);d&&d(a)});break;case "ZIGBEE":require("x.hub.m.zigbee.js").getAllStatesLegacy(function(a){a=e(a,f,g);d&&d(a)});break;case "ONOFF":case "FLOAT":case "INT":case "STRING":require("x.hub.sysvarman.js").getSysvarStates(function(a){a=e(a,f,g);d&&d(a)});break;default:(a=require("x.hub.js").server)?(this._logger.log("trace",
"get states from ST directly"),a.doSTMCommand("XC_FNC=getStates",function(a){h._logger.log("trace","get states from ST return:"+JSON.stringify(a));if(a)if(a.XC_SUC){var b={data:null};Array.isArray(a.XC_SUC)?b.data=a.XC_SUC:0<Object.keys(a.XC_SUC).length&&(b.data=[a.XC_SUC]);a=e(b,f,g);d&&d(a)}else d&&d({error:Error("ST get states return error:"+JSON.stringify(a))});else d&&d({error:Error("ST get states return null")})})):d&&d({error:Error("server not initialized")})}else x.hub.m.gateway.AIOMODULE.doStatus("hub",
a,b,{value:c},function(a,b){var c=null;b&&(c={value:b.status,time:(new Date).getTime()});d&&d({error:a,data:c})})}else d&&d({error:Error("gateway json format invalid")})};c.prototype._processPassword=function(a){var b=this._localIpBuffer,c="";localStorage&&(c=localStorage.getItem("x.hub.Server.pwd"));"localhost"==a.ip||"127.0.0.1"==a.ip||-1!=b.indexOf(a.ip)?(a.__isself=!0,c&&(a.at=c)):a.__neoInfo&&(1==a.__neoInfo.db&&a.__neoInfo.index==this._db1GatewayNeoIndex?(a.__isself=!0,c&&(a.at=c)):2==a.__neoInfo.db&&
a.__neoInfo.index==this._db2GatewayNeoIndex&&(a.__isself=!0,c&&(a.at=c)));return a};c.prototype._updateLocalIPBuffer=function(){(new Date).getTime();var a=[],b=require("os").networkInterfaces(),c;for(c in b)for(var d=b[c],k=0;k<d.length;k++)a.push(d[k].address);this._localIpBuffer=a};return c}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.gateway.Handler);
