var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(e){var a=0;return function(){return a<e.length?{done:!1,value:e[a++]}:{done:!0}}};$jscomp.arrayIterator=function(e){return{next:$jscomp.arrayIteratorImpl(e)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(e,a,c){if(e==Array.prototype||e==Object.prototype)return e;e[a]=c.value;return e};$jscomp.getGlobal=function(e){e=["object"==typeof globalThis&&globalThis,e,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var a=0;a<e.length;++a){var c=e[a];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(e,a){var c=$jscomp.propertyToPolyfillSymbol[a];if(null==c)return e[a];c=e[c];return void 0!==c?c:e[a]};
$jscomp.polyfill=function(e,a,c,d){a&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(e,a,c,d):$jscomp.polyfillUnisolated(e,a,c,d))};$jscomp.polyfillUnisolated=function(e,a,c,d){c=$jscomp.global;e=e.split(".");for(d=0;d<e.length-1;d++){var b=e[d];if(!(b in c))return;c=c[b]}e=e[e.length-1];d=c[e];a=a(d);a!=d&&null!=a&&$jscomp.defineProperty(c,e,{configurable:!0,writable:!0,value:a})};
$jscomp.polyfillIsolated=function(e,a,c,d){var b=e.split(".");e=1===b.length;d=b[0];d=!e&&d in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var g=0;g<b.length-1;g++){var l=b[g];if(!(l in d))return;d=d[l]}b=b[b.length-1];c=$jscomp.IS_SYMBOL_NATIVE&&"es6"===c?d[b]:null;a=a(c);null!=a&&(e?$jscomp.defineProperty($jscomp.polyfills,b,{configurable:!0,writable:!0,value:a}):a!==c&&(void 0===$jscomp.propertyToPolyfillSymbol[b]&&($jscomp.propertyToPolyfillSymbol[b]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(b):
$jscomp.POLYFILL_PREFIX+b),$jscomp.defineProperty(d,$jscomp.propertyToPolyfillSymbol[b],{configurable:!0,writable:!0,value:a})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(e){if(e)return e;var a=function(b,g){this.$jscomp$symbol$id_=b;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:g})};a.prototype.toString=function(){return this.$jscomp$symbol$id_};var c=0,d=function(b){if(this instanceof d)throw new TypeError("Symbol is not a constructor");return new a("jscomp_symbol_"+(b||"")+"_"+c++,b)};return d},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(e){if(e)return e;e=Symbol("Symbol.iterator");for(var a="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),c=0;c<a.length;c++){var d=$jscomp.global[a[c]];"function"===typeof d&&"function"!=typeof d.prototype[e]&&$jscomp.defineProperty(d.prototype,e,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return e},"es6",
"es3");$jscomp.iteratorPrototype=function(e){e={next:e};e[Symbol.iterator]=function(){return this};return e};$jscomp.iteratorFromArray=function(e,a){e instanceof String&&(e+="");var c=0,d=!1,b={next:function(){if(!d&&c<e.length){var g=c++;return{value:a(g,e[g]),done:!1}}d=!0;return{done:!0,value:void 0}}};b[Symbol.iterator]=function(){return b};return b};$jscomp.polyfill("Array.prototype.keys",function(e){return e?e:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
var x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.gateway=x.hub.m.gateway||{};x.hub.m.gateway.AIOMODULE=require("xnm.aio.gateway.js");
x.hub.m.gateway.Monitor=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.gateway.Monitor");var a=this;this._eventCallback=function(c,d){a._onGatewayEvent(c,d)};this._eventCallback.onError=function(c){a._restartEventListener()};this._restartTO=null};e.prototype.init=function(a){var c=this;x.hub.m.gateway.AIOMODULE.startGatewayEventListener(this._eventCallback,function(d){d?c._restartEventListener():c._restartTO&&(clearTimeout(c._restartTO),c._restartTO=null);a&&a()})};
e.prototype._onGatewayEvent=function(a,c){require("x.hub.eventbus.js").emit("gatewayevent",a,c,"EVT")};e.prototype._onEventListenerError=function(a){};e.prototype._restartEventListener=function(){this._restartTO&&clearTimeout(this._restartTO);var a=this;this._restartTO=setTimeout(function(){a.init()},5E3)};return e}();
x.hub.m.gateway.GatewayInternalHandler=function(){var e=function(){this._devices={};this._meta={};this._states={}};e.prototype.addStateDevice=function(a,c,d){if(a&&a.type&&a.address){a=JSON.parse(JSON.stringify(a));delete a.gateway;var b=this._getDeviceID(a);this._devices[b]||(this._devices[b]=a);this._meta[b]||(this._meta[b]=[]);this._states[b]||(this._states[b]={});if(d){a=!1;for(var g=0;g<this._meta[b].length;g++){var l=this._meta[b][g];if(l&&l.statusKey==d.statusKey&&l.src==d.src&&l.taskID==d.taskID){a=
!0;break}}a||this._meta[b].push(d)}c&&c()}else c&&c(Error("device json invalid"))};e.prototype.removeStateDevice=function(a,c,d){if(!a||!a.type||!a.address)c&&c(Error("device json invalid"));else if(d){a=JSON.parse(JSON.stringify(a));delete a.gateway;a=this._getDeviceID(a);var b=this._meta[a];if(b){for(var g=-1,l=0;l<b.length;l++){var h=b[l];if(h&&h.src==d.src&&h.taskID==d.taskID&&h.statusKey==d.statusKey){g=l;break}}0<=g&&b.splice(g,1);0==b.length&&(delete this._devices[a],delete this._meta[a],delete this._states[a])}c&&
c()}};e.prototype.onEvent=function(a,c,d){if(a){var b,g=null,l=!1;if(a.sid)for(b in this._devices){var h=this._devices[b];if(h.sid==a.sid){var m=JSON.parse(JSON.stringify(a));h.type&&!m.type&&(m.type=h.type);h.address&&!m.address&&(m.address=h.address);h.address&&!m.adr&&(m.adr=h.address);h.data&&!m.data&&(m.data=h.data);if(c=this._getSystem(m)){if(a.changed&&a.changed.length){m.state={};a.changed.forEach(function(n){m.state[n]=a.state[n]});var f=c._handleState(h,m)}if(f&&0<Object.keys(f).length){var k=
h;this._getDeviceID(k);g=f;l=!0;break}}}}if(!l){if(!a.type)return;c=this._getSystem(a);if(!c)return;for(b in this._devices)if(this._devices.hasOwnProperty(b))if(h=this._devices[b],"EVT"==d&&c._handleUdpState){if((f=c._handleUdpState(h,a))&&0<Object.keys(f).length){k=h;this._getDeviceID(k);g=f;break}}else if("STA"==d&&c._handleState){if((f=c._handleState(h,a))&&0<Object.keys(f).length){k=h;this._getDeviceID(k);g=f;break}}else if("BTN"==d&&b==a.type+"@"+a.adr){k=h;g=a.state;break}}g&&this._updateState(k,
g,a)}};e.prototype._getDeviceID=function(a){if(a&&a.sid){var c="sid@"+a.sid;a.type&&a.address&&(c+="@"+a.type+"@"+a.address);return c}return a&&"ZWAVE2"==a.type?a.type+"@"+a.address+"."+a.instance:a.type+"@"+a.address};e.prototype._getSystem=function(a){return x.hub.m.gateway.AIOMODULE.devicemanager.getSystem(a)};e.prototype._updateState=function(a,c,d){var b=this._getDeviceID(a),g=this._meta[b],l=this._states[b]?this._states[b]:{};this._states[b]=c;if(g&&0<g.length)for(var h in c)if(c.hasOwnProperty(h)){b=
c[h];var m=l[h];b={key:h,value:b,changed:m!=b,oldValue:m};d&&d.sid&&d.changed&&d.changed.length&&(b.changed=!0,delete b.oldValue);if("aio"==a.sys&&"MBUS"==a.type)if("undefined"==typeof m||null==m)continue;else if(!b.changed)continue;m=require("x.hub.eventbus.js");require("x.hub.taskman.js");for(var f=0;f<g.length;f++){var k=g[f];!k||k.statusKey!=h&&"*"!=k.statusKey||m.emit("status",{module:"aio",device:a,gateway:null,data:b},k)}}};return e}();
x.hub.m.gateway.Handler=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.gateway.Handler");this._intHandler=new x.hub.m.gateway.GatewayInternalHandler;this._monitor=new x.hub.m.gateway.Monitor;this._on={};this._localIpBuffer=[];this._localIpUpdateInterval=null;this._db2GatewayNeoIndex=this._db1GatewayNeoIndex=0};e.prototype.on=function(a,c){this._on[a]=c};e.prototype._checkStateChange=function(a,c){};e.prototype.updateGatewayStates=function(a,c){c({})};e.prototype.updateStates=
function(a,c){c({})};e.prototype.getStates=function(a){return{}};e.prototype.getAllStates=function(){return[]};e.prototype.init=function(a){var c=this;require("x.hub.eventbus.js").on("gatewayevent",function(d,b,g){c._onEvent(d,b,g)});localStorage&&(this._db1GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB1NeoIdx"),this._db2GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB2NeoIdx"));this._updateLocalIPBuffer();this._localIpUpdateInterval=setInterval(function(){c._updateLocalIPBuffer()},
18E5);this._monitor.init()};e.prototype.getSystems=function(){return["aio"]};e.prototype.addStateDevice=function(a,c,d){a&&a.type&&a.address?this._intHandler.addStateDevice(a,function(b){c&&c({error:b})},d):c&&c({error:Error("device json invalid")})};e.prototype.removeStateDevice=function(a,c,d){a&&a.type&&a.address?this._intHandler.removeStateDevice(a,function(b){c&&c({error:b})},d):c&&c({error:Error("device json invalid")})};e.prototype.getState=function(a,c,d){if(a.gateway)if(a.gateway.ip){a=JSON.parse(JSON.stringify(a));
var b=a.gateway;b=this._processPassword(b);b.__isself?this._getStateLocal(b,a,c,d):x.hub.m.gateway.AIOMODULE.doStatus("hub",b,a,{value:c},function(g,l){var h=null;l&&(h={value:l.status,time:(new Date).getTime()});d&&d({error:g,data:h})})}else d&&d({error:Error("gateway json invalid")});else this._getStateIQ(a,c,d)};e.prototype.executeCommand=function(a,c,d){if(a)if(a.gateway){a=JSON.parse(JSON.stringify(a));var b=a.gateway;b.ip?((b=this._processPassword(b))&&!a.type&&(a=b),b.__isself?this._executeCommandLocal(b,
a,c,d):x.hub.m.gateway.AIOMODULE.doCommand(b,a,c,function(g){d&&d({error:g})})):d&&d({errror:Error("gateway json invalid")})}else this._executeCommandIQ(a,c,d);else d&&d({error:Error("device is null")})};e.prototype.checkDeviceMatch=function(a,c){if(!(c&&c.device&&a&&a.device))return!1;var d=a.device.address;d&&"string"==typeof d&&(d=d.toUpperCase());var b=c.device.address;b&&"string"==typeof b&&(b=b.toUpperCase());a=a.device.type;return d==b&&a==c.device.type};e.prototype.updateGatewayNeoIndex=function(){localStorage&&
(this._db1GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB1NeoIdx"),this._db2GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB2NeoIdx"))};e.prototype._onEvent=function(a,c,d){if(!(a.module||a.sys||(this._logger.log("trace","from "+(c?c.address:null)+" receive "+d+" event:"+JSON.stringify(a)),this._localIpBuffer&&c&&c.address&&"STA"==d&&-1!=this._localIpBuffer.indexOf(c.address)||c&&"Sysvar"!=c.address&&a.type&&-1!=["ONOFF","FLOAT","STRING","INT"].indexOf(a.type)))){var b=require("x.hub.eventbus.js");
if(a.type&&"IR"==a.type&&a.data)b.emit("irevt",{code:a.data});else this._intHandler.onEvent(a,c,d)}};e.prototype._executeCommandIQ=function(a,c,d){if(a.type){var b;if("HM"==a.type.toUpperCase()&&"EA"==global.HARDWARE_VERSION)"ip_siren"==a.data&&(c.value=x.hub.m.gateway.AIOMODULE.Systems.HM_X._buildData(null,a,c)),(b=require("x.hub.moduleman.js").modulemanager.getModule("hm"))?b.executeCommand(a,c,d):d&&d({error:Error("no module for type HM")});else if("ENOCEAN"==a.type.toUpperCase()&&"EA"==global.HARDWARE_VERSION)(b=
require("x.hub.moduleman.js").modulemanager.getModule("enocean"))?b.executeCommand(a,c,d):d&&d({error:Error("no module for type ENOCEAN")});else{var g=x.hub.m.gateway.AIOMODULE.getGatewayFunctionForType(a.type);if(g){if("CODE"==a.type){var l=x.hub.m.gateway.AIOMODULE.Systems.Code._rebuildDevice(JSON.parse(JSON.stringify(a)));a=x.hub.m.gateway.AIOMODULE.Systems.Code._findIRCode(c,a);a=x.hub.m.gateway.AIOMODULE.Systems.Code._buildParam(a,l)}else a="BG"==a.type?x.hub.m.gateway.AIOMODULE.Systems.BG._buildParam(null,
a,c):x.hub.m.gateway.AIOMODULE.getGatewayParams(a,c.value);g="http://localhost/command?XC_FNC="+g;if(a)for(b in a)g+="&"+b+"="+encodeURIComponent(a[b]);try{var h=require("x.hub.js").server;h?h._doSTMCommandRequest(g,!1,function(m){d&&d({error:m})}):d&&d({error:Error("server not initialized")})}catch(m){d&&d({error:m})}}else d&&d({error:Error("unknow device type")})}}else d&&d({error:Error("device type is null")})};e.prototype._executeCommandLocal=function(a,c,d,b){var g=x.hub.m.gateway.AIOMODULE.devicemanager.getSystem(c,
a);if(g&&g.buildQuery){var l=x.hub.m.gateway.AIOMODULE.resolveGateway(a);if(g=g.buildQuery(l?l:a,c,d)){try{var h=require("x.hub.js").server;if(!h){b&&b({error:Error("server not initialized")});return}var m=require("querystring"),f,k;if(g.fnc&&0==g.fnc.indexOf("/api")){(k=f=g.fnc)&&delete g.fnc;if(g.data)g=g.data;else{var n=m.stringify(g);g=m.parse(n);k=f+"?"+n}var r={url:k,query:g}}else"SendGenericCmd"==g.XC_FNC?(f="/cmd",r={method:"POST",url:k,query:g,json:g}):(f="/cmd",n=m.stringify(g),g=m.parse(n),
k=f+"?"+n,r={url:k,query:g});this._logger.log("trace","execute command local directly "+k);var t=this;h.doRequest(f,r,function(p){t._logger.log("trace","execute command local directly return:"+JSON.stringify(p));var q=null;if(p)try{(q=JSON.parse(p))&&q.XC_SUC?b&&b({data:q}):q&&q.XC_ERR?b&&b({error:Error(p)}):b&&b({error:Error("/cmd request return invalid format")})}catch(u){b&&b({error:u})}else b&&b({error:Error("/cmd request return null")})})}catch(p){b&&b({error:p})}return}}this._logger.log("trace",
"execute command via localhost:"+JSON.stringify(c)+" command:"+JSON.stringify(d));x.hub.m.gateway.AIOMODULE.doCommand(a,c,d,function(p){b&&b({error:p})})};e.prototype._getStateIQ=function(a,c,d){var b={ip:"127.0.0.1",port:require("x.hub.js").server._port,version:"EA"};b=this._processPassword(b);this._getStateLocal(b,a,c,d)};e.prototype._getStateLocal=function(a,c,d,b){var g=function(f,k,n){if(f.error)return{error:f.error};f=n._handleGeneralStatesRsp(f.data,k);k=null;f&&f[0]&&(k={value:f[0].status,
time:(new Date).getTime()});return{error:null,data:k}},l=x.hub.m.gateway.AIOMODULE.resolveGateway(a);if(l){var h=[{id:"hub",device:c,status:{value:d}}],m=this;c&&"dev"==c.common_type?c.id?require("x.hub.commandman.js").commandHandlerV6.getDeviceStatesWithId(c.id,function(f,k){f?b&&b({error:f}):(f={value:k?k[d]:null,time:(new Date).getTime()},b&&b({error:null,data:f}))}):b&&b({error:Error("device json invalid")}):c&&c.type?"HM"==c.type&&"CA"!=global.HARDWARE_VERSION?require("x.hub.m.hm.js").getAllStatesLegacy(function(f){f=
g(f,h,l);b&&b(f)}):"ENOCEAN"==c.type&&"CA"!=global.HARDWARE_VERSION?require("x.hub.m.enocean.js").getAllStatesLegacy(function(f){f=g(f,h,l);b&&b(f)}):"ZWAVE2"==c.type?require("x.hub.m.zway.js").getAllStatesLegacy(function(f){f=g(f,h,l);b&&b(f)}):"KNX"==c.type?require("x.hub.m.knx.js").getAllStatesLegacy(function(f){f=g(f,h,l);b&&b(f)}):"ZIGBEE"==c.type?require("x.hub.m.zigbee.js").getAllStatesLegacy(function(f){f=g(f,h,l);b&&b(f)}):"ONOFF"==c.type||"FLOAT"==c.type||"INT"==c.type||"STRING"==c.type?
require("x.hub.sysvarman.js").getSysvarStates(function(f){f=g(f,h,l);b&&b(f)}):"TASK"==c.type?require("x.hub.taskman.js").readAllTasks(function(f){if(f.error)f=g(f,h,l);else{var k=[];f.data.forEach(function(n){n&&k.push({type:"TASK",id:n.id,active:n.active})});f=g({data:k},h,l)}b&&b(f)}):(a=require("x.hub.js").server)?(this._logger.log("trace","get states from ST directly"),a.doSTMCommand("XC_FNC=getStates",function(f){m._logger.log("trace","get states from ST return:"+JSON.stringify(f));if(f)if(f.XC_SUC){var k=
{data:null};Array.isArray(f.XC_SUC)?k.data=f.XC_SUC:0<Object.keys(f.XC_SUC).length&&(k.data=[f.XC_SUC]);f=g(k,h,l);b&&b(f)}else b&&b({error:Error("ST get states return error:"+JSON.stringify(f))});else b&&b({error:Error("ST get states return null")})})):b&&b({error:Error("server not initialized")}):x.hub.m.gateway.AIOMODULE.doStatus("hub",a,c,{value:d},function(f,k){var n=null;k&&(n={value:k.status,time:(new Date).getTime()});b&&b({error:f,data:n})})}else b&&b({error:Error("gateway json format invalid")})};
e.prototype._processPassword=function(a){var c=this._localIpBuffer,d="";localStorage&&(d=localStorage.getItem("x.hub.Server.pwd"));"localhost"==a.ip||"127.0.0.1"==a.ip||-1!=c.indexOf(a.ip)?(a.ip="127.0.0.1",a.port=require("x.hub.js").getServer()._port,a.__isself=!0,d&&(a.at=d)):a.__neoInfo&&(1==a.__neoInfo.db&&a.__neoInfo.index==this._db1GatewayNeoIndex?(a.ip="127.0.0.1",a.port=require("x.hub.js").getServer()._port,a.__isself=!0,d&&(a.at=d)):2==a.__neoInfo.db&&a.__neoInfo.index==this._db2GatewayNeoIndex&&
(a.ip="127.0.0.1",a.port=require("x.hub.js").getServer()._port,a.__isself=!0,d&&(a.at=d)));return a};e.prototype._updateLocalIPBuffer=function(){(new Date).getTime();var a=[],c=require("os").networkInterfaces(),d;for(d in c)for(var b=c[d],g=0;g<b.length;g++)a.push(b[g].address);this._localIpBuffer=a};return e}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.gateway.Handler);
