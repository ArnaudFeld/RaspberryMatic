var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.artnet=xnm.aio.artnet||{};xnm.aio.artnet.Controller=function(b,a,d){this.ip=b;this.port=a;this.port||(this.port=6454);this.name=d;this._DMXdata=[]};
xnm.aio.artnet.Controller.prototype._doRequest=function(b,a,d){var c=[65,114,116,45,78,101,116,0],c=c.concat(b.concat([0,14]));c.push(0);c.push(0);c.push(0);c.push(0);b=a.length;512<b&&(b=512);c.push((b&65280)>>8);c.push(b&255);c=c.concat(a);a=require("dgram").createSocket("udp4");a.on("message",function(a,b){XC.debugf(a)});c=new Buffer(c);XC.debugf(c);a.send(c,0,18+b,this.port,this.ip,function(a,b){d&&d()})};
xnm.aio.artnet.Controller.prototype.sendDMX512Data=function(b){this._doRequest([0,80],this._DMXdata,b)};xnm.aio.artnet.Controller.prototype.setDMX512Data=function(b){this._DMXdata=b};xnm.aio.artnet.Controller.prototype.setDMX512Channel=function(b,a){512<b&&(b=512);--b;if(!(0>b)){for(;this._DMXdata.length<=b;)this._DMXdata.push(0);this._DMXdata[b]=a}};
xnm.aio.artnet.Discovery=function(){this.detectedControllers={};this._sockets=[];var b=require("os"),a=require("dgram");if(b&&b.networkInterfaces){var d=this,a=a.createSocket("udp4");a.bind(6454,"0.0.0.0");a.on("message",function(a,b){d._receivedData(b.address,a)});var b=b.networkInterfaces(),c;for(c in b)for(var a=b[c],e=0;e<a.length;e++)this._addDiscoverSocket(6454,a[e])}else this._addDiscoverSocket(6454,null)};
xnm.aio.artnet.Discovery.prototype._receivedData=function(b,a){if(110<a.length&&(a instanceof Array||a instanceof Buffer)&&0==a[8]&&33==a[9]){for(var d=a[10]+"."+a[11]+"."+a[12]+"."+a[13],c="",e=44;108>e&&0!=a[e];e++)c+=String.fromCharCode(a[e]);this.detectedControllers[d]||(this.detectedControllers[d]=new xnm.aio.artnet.Controller(d,null,c),this._callback&&this._callback(this.detectedControllers[d]))}};
xnm.aio.artnet.Discovery.prototype._addDiscoverSocket=function(b,a){var d=require("dgram"),c=this;if(a)"IPv4"==a.family&&0==a.internal&&(e=d.createSocket("udp4"),e.on("listening",function(){e.setBroadcast(!0)}),e.bind(b,a.address),this._sockets.push(e));else{var e=d.createSocket("udp4");e.on("message",function(a,b){c._receivedData(b.address,a)});this._sockets.push(e)}};
xnm.aio.artnet.Discovery.prototype._sendDiscoveryMessages=function(b,a,d,c){b=new Buffer([65,114,116,45,78,101,116,0,0,32,0,14,0,0]);for(a=0;a<this._sockets.length;a++)this._sockets[a].send(b,0,b.length,6454,"255.255.255.255")};xnm.aio.artnet.Discovery.prototype.discoverControllers=function(b){this._callback=b;var a=this,d=0,c=setInterval(function(){a._sendDiscoveryMessages();1<=d++&&clearInterval(c)},250)};xnm.aio.artnet.Handler=function(){this._discovery=null};
xnm.aio.artnet.Handler.prototype.discoverControllers=function(b){this._discovery||(this._discovery=new xnm.aio.artnet.Discovery);this._discovery.discoverControllers(b)};xnm.aio.artnet.Handler.prototype.Controller=xnm.aio.artnet.Controller;"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.artnet.Handler);
