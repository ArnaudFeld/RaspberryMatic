var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.homewizard=xnm.aio.homewizard||{};xnm.aio.homewizard.HomeWizard=function(c,a,d){this._logger=require("x.logger.js").getLogger("xnm.aio.homewizard.HomeWizard");this.ip=c;this.port=a;a||(this.port=80);this.password=d;this.CommandHandler=null};
xnm.aio.homewizard.HomeWizard.prototype._doRequest=function(c,a){var d=this,b="http://"+this.ip+":"+this.port+"/"+this.password+"/"+c;this._logger.log("trace","send to url:"+b);var e=a;$.ajax({url:b,type:"GET",timeout:1E4,dataType:"json",success:function(b){d._logger.log("trace","http request success:"+JSON.stringify(b));e&&(e(null,b),e=null)},error:function(b,a){var c="http request error:"+(b?b.status:"0")+"-"+a;d._logger.log("trace",c);e&&(e(Error(c)),e=null)}})};
xnm.aio.homewizard.HomeWizard.prototype._sendRequest=function(c,a){this._doRequest(c,function(c,b){!c&&b&&b.response&&"ok"==b.status?b&&b.response&&"ok"==b.status?a&&a(null,b.response):(b&&b.status?(c=Error(b.status),c.errCode=b.error):c=Error("response is empty"),a&&a(c)):a&&a(c)})};xnm.aio.homewizard.HomeWizard.prototype.getDevices=function(c){this._sendRequest("get-sensors",function(a,d){c&&c(a,d)})};
xnm.aio.homewizard.HomeWizard.prototype._resolveState=function(c,a){if(!c||!c.type||!a||"undefined"==typeof c.address||null==c.address)return null;var d,b,e=null;switch(c.type){case "switch":case "dimmer":case "radiator":case "asun":case "somfy":d="switches";break;case "wind":d="windmeters";break;case "rain":d="rainmeters";break;case "thermo":d="thermometers";break;case "doorbell":case "smoke":case "contact":case "motion":d="kakusensors";break;case "energylink":d="energylinks";break;default:return null}if(a[d])for(var f=
0;f<a[d].length;f++)if(a[d][f]&&c.address+""==a[d][f].id+""){b=a[d][f];break}if(b)switch(e={},c.type){case "switch":case "dimmer":case "radiator":case "asun":case "somfy":"undefined"!=typeof b.status&&null!=b.status&&(e.status=b.status);"undefined"!=typeof b.dimlevel&&null!=b.dimlevel&&(e.dimlevel=b.dimlevel);"undefined"!=typeof b.tte&&null!=b.tte&&(e.status=b.tte,e.tte=b.tte);break;case "wind":e.windLowBat="no"!=b.lowBattery;e.windS=b.ws;b.dir&&-1!=b.dir.indexOf(" ")&&(d=b.dir.split(" "),e.windD=
parseInt(d[1].trim()),e.windDS=d[0].trim());e.windGS=b.gu;e.windT=b.wc;e.windSMax=b["ws+"];e.windSMaxT=b["ws+t"];e.windSMin=b["ws-"];e.windSMinT=b["ws-t"];break;case "rain":e.rainLowBat="no"!=b.lowBattery;e.rainL=b.mm;e.rainL3h=b["3h"];break;case "thermo":e.thermoLowBat="no"!=b.lowBattery;e.thermoT=b.te;e.thermoH=b.hu;e.thermoTMax=b["te+"];e.thermoTMaxT=b["te+t"];e.thermoTMin=b["te-"];e.thermoTMinT=b["te-t"];e.thermoHMax=b["hu+"];e.thermoHMaxT=b["hu+t"];e.thermoHMin=b["hu-"];e.thermoHMinT=b["hu-t"];
break;case "doorbell":e.doorbellE=b.status?"ring":"none";e.doorbellET=b.timestamp;break;case "smoke":e.smokeE=b.status?"alarm":"ok";e.smokeET=b.timestamp;break;case "motion":e.motionE=b.status&&"no"!=b.status?"on":"off";e.motionET=b.timestamp;break;case "contact":e.contactE=b.status?"open":"closed";e.contactET=b.timestamp;break;case "energylink":b.s1&&(e.s1Value=b.s1.po,e.s1TotalD=b.s1.dayTotal,e.s1Max=b.s1["po+"],e.s1MaxT=b.s1["po+t"],e.s1Min=b.s1["po-"],e.s1MinT=b.s1["po-t"]),b.s2&&(e.s2Value=b.s2.po,
e.s2TotalD=b.s2.dayTotal,e.s2Max=b.s2["po+"],e.s2MaxT=b.s2["po+t"],e.s2Min=b.s2["po-"],e.s2MinT=b.s2["po-t"])}return e};
xnm.aio.homewizard.HomeWizard.prototype.executeCommand=function(c,a,d){var b=null,e=!0;if("on"==a)"switch"==c.type||"dimmer"==c.type||"radiator"==c.type?b="sw/"+c.address+"/on":"scene"==c.type&&(b="gp/"+c.address+"/on");else if("off"==a)"switch"==c.type||"dimmer"==c.type||"radiator"==c.type?b="sw/"+c.address+"/off":"scene"==c.type&&(b="gp/"+c.address+"/off");else if("toggle"==a){if("switch"==c.type||"dimmer"==c.type){var f=this;this.getStates(null,[c],function(a,e){b="sw/"+c.address+"/off";1==e.length&&
e[0].state&&"off"==e[0].state.status&&(b="sw/"+c.address+"/on");f._sendRequest(b,function(b){d&&d(b)})});e=!1}}else if("up"==a)if("somfy"==c.type)b="sf/"+c.address+"/up";else{if("asun"==c.type||"brel"==c.type)b="sw/"+c.address+"/up"}else if("down"==a)if("somfy"==c.type)b="sf/"+c.address+"/down";else{if("asun"==c.type||"brel"==c.type)b="sw/"+c.address+"/down"}else"stop"==a?"somfy"==c.type?b="sf/"+c.address+"/stop":"brel"==c.type&&(b="sw/"+c.address+"/stop"):(0==a.indexOf("dimTo")&&(a=a.replace(/dimTo/g,
"")),0==a.indexOf("setTo")&&(a=a.replace(/setTo/g,"")),a=a.replace(/%/g,""),"dimmer"==c.type?b="sw/dim/"+c.address+"/"+a:"radiator"==c.type&&(b="sw/"+c.address+"/settarget/"+a));e&&!b?d&&d(Error("no such command")):e&&b&&this._sendRequest(b,function(b){d&&d(b)})};
xnm.aio.homewizard.HomeWizard.prototype.getStates=function(c,a,d){var b=this;this.CommandHandler=c;this._sendRequest("get-sensors",function(c,f){if(c)d&&d(c,a);else{for(var g=0;g<a.length;g++){var h=b._resolveState(a[g],f);h&&(a[g].state=h)}d&&d(null,a)}})};xnm.aio.homewizard.HomeWizard.prototype.getStateValues=function(c,a){return a};
xnm.aio.homewizard.HomeWizard.prototype.executeCommandCreator=function(c,a,d){if(a&&a.value){var b=a.value;if("dimTo"==a.value){if("undefined"==typeof a.ext||null==a.ext){d&&d(Error("command dimTo ext format invalid"));return}b=a.value+a.ext}else if("setTo"==a.value){if("undefined"==typeof a.ext||null==a.ext){d&&d(Error("command setTo ext format invalid"));return}b=a.value+a.ext}this.executeCommand(c,b,function(b){d&&d(b)})}else d&&d(Error("command json format invalid"))};
xnm.aio.homewizard.HomeWizard.prototype.getStatesCreator=function(c,a,d){if(a)if(0==a.length)d&&d(null,[]);else{for(var b=[],e=0;e<a.length;e++)if(a[e]&&a[e].device){var f=JSON.parse(JSON.stringify(a[e].device));b.push(f)}this.getStates(c,b,function(b,c){for(var e=[],f=0;f<a.length;f++)if(a[f].id){var l="?";a[f].status&&a[f].status.value&&c&&c[f]&&c[f].state&&(l=c[f].state[a[f].status.value],"undefined"==typeof l||null==l)&&(l="?");e.push({id:a[f].id,status:l})}d&&d(b,e)})}else d&&d(Error("deviceList is null"))};
xnm.aio.homewizard.HomeWizard.prototype.toJSON=function(){return{sys:xnm.aio.homewizard.DM.SYS,ip:this.ip,port:this.port,password:this.password}};xnm.aio.homewizard.HomeWizard.prototype.equalsTo=function(c){return c&&c instanceof xnm.aio.homewizard.HomeWizard?this.ip==c.ip&&this.port==c.port&&this.password==c.password:!1};
xnm.aio.homewizard.DM=function(){var c=function(a,c){this.code=a;this.message=c;this.stack=Error().stack};c.prototype=Error();c.prototype.name="HomewizardDMError";c.prototype.code=0;c.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"homewizard",MAP:{"switch":{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"status",ref:{value:"status",
options:["on","off"]}}]},dimmer:{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}}],status:[{type:"enum",name:"status",ref:{value:"status",options:["on","off"]}},{type:"int",name:"dim level",ref:{value:"dimlevel",extMeta:"0-100"}}]},radiator:{command:[{type:"enum",name:"night mode",ref:{value:"off"}},{type:"enum",name:"day mode",ref:{value:"on"}},
{type:"float",name:"temperature",ref:{value:"setTo",ext:"%f",extMeta:"5.0-28.0",scale:"0.5"}}],status:[{type:"float",name:"temperature",ref:{value:"status",extMeta:"5.0-28.0",scale:"0.5"}}]},somfy:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}}]},asun:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}}]},brel:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",
name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}}]},scene:{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}}]},wind:{status:[{type:"enum",name:"battery low",ref:{value:"windLowBat",options:["true","false"]}},{type:"float",name:"wind speed",ref:{value:"windS"}},{type:"int",name:"wind direction",ref:{value:"windD"}},{type:"string",name:"wind direction (string)",ref:{value:"windDS"}},{type:"float",name:"gust speed",ref:{value:"windGS"}},
{type:"float",name:"wind temperature",ref:{value:"windT"}},{type:"float",name:"max wind speed",ref:{value:"windSMax"}},{type:"string",name:"max wind speed time",ref:{value:"windSMaxT"}},{type:"float",name:"min wind speed",ref:{value:"windSMin"}},{type:"string",name:"min wind speed time",ref:{value:"windSMinT"}}]},rain:{status:[{type:"enum",name:"battery low",ref:{value:"rainLowBat",options:["true","false"]}},{type:"int",name:"rain level",ref:{value:"rainL"}},{type:"int",name:"rain level (3h)",ref:{value:"rainL3h"}}]},
thermo:{status:[{type:"enum",name:"battery low",ref:{value:"thermoLowBat",options:["true","false"]}},{type:"float",name:"temperature",ref:{value:"thermoT"}},{type:"float",name:"humidity",ref:{value:"thermoH"}},{type:"float",name:"max temperature",ref:{value:"thermoTMax"}},{type:"string",name:"max temperature time",ref:{value:"thermoTMaxT"}},{type:"float",name:"min temperature",ref:{value:"thermoTMin"}},{type:"string",name:"min temperature time",ref:{value:"thermoTMinT"}},{type:"float",name:"max humidity",
ref:{value:"thermoHMax"}},{type:"string",name:"max humidity time",ref:{value:"thermoHMaxT"}},{type:"float",name:"min humidity",ref:{value:"thermoHMin"}},{type:"string",name:"min humidity time",ref:{value:"thermoHMinT"}}]},doorbell:{status:[{type:"enum",name:"last event",ref:{value:"doorbellE",options:["none","ring"]}},{type:"string",name:"last event time",ref:{value:"doorbellET"}}]},smoke:{status:[{type:"enum",name:"last event",ref:{value:"smokeE",options:["ok","alarm"]}},{type:"string",name:"last event time",
ref:{value:"smokeET"}}]},motion:{status:[{type:"enum",name:"last event",ref:{value:"motionE",options:["on","off"]}},{type:"string",name:"last event time",ref:{value:"motionET"}}]},contact:{status:[{type:"enum",name:"last event",ref:{value:"contactE",options:["open","closed"]}},{type:"string",name:"last event time",ref:{value:"contactET"}}]},energylink:{status:[{type:"float",name:"s1 value",ref:{value:"s1Value"}},{type:"float",name:"s1 daily total",ref:{value:"s1TotalD"}},{type:"float",name:"max s1 value",
ref:{value:"s1Max"}},{type:"string",name:"max s1 value time",ref:{value:"s1MaxT"}},{type:"float",name:"min s1 value",ref:{value:"s1Min"}},{type:"string",name:"min s1 value time",ref:{value:"s1MinT"}},{type:"float",name:"s2 value",ref:{value:"s2Value"}},{type:"float",name:"s2 daily total",ref:{value:"s2TotalD"}},{type:"float",name:"max s2 value",ref:{value:"s2Max"}},{type:"string",name:"max s2 value time",ref:{value:"s2MaxT"}},{type:"float",name:"min s2 value",ref:{value:"s2Min"}},{type:"string",name:"min s2 value time",
ref:{value:"s2MinT"}}]}},getGatewayType:function(){return[{sys:this.SYS,name:"HomeWizard",port:80}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"switch",name:"Switch"},{sys:this.SYS,type:"dimmer",name:"Dimmer"},{sys:this.SYS,type:"radiator",name:"Thermostat"},{sys:this.SYS,type:"somfy",name:"Somfy Blind"},{sys:this.SYS,type:"asun",name:"ASUN Blind"}]},createGateway:function(a,d,b){d=c.ERROR_CODE;a?a.ip?a.password?b(null,a):b(new c(d.INVALID,"password is invalid")):b(new c(d.INVALID,
"ip is invalid")):b(new c(d.INVALID,"info is invalid"))},updateGateway:function(a,d,b,e){a=c.ERROR_CODE;d?d.ip?d.password?e(null,d):e(new c(a.INVALID,"password is invalid")):e(new c(a.INVALID,"ip is invalid")):e(new c(a.INVALID,"update is invalid"))},deleteGateway:function(a,c,b){b()},createDevice:function(a,d,b){var e=c.ERROR_CODE;if(a)if(a.gateway)if(null==a.address||"undefined"==typeof a.address)b(new c(e.INVALID,"address is invalid"));else if(null==a.type||"undefined"==typeof a.type)b(new c(e.INVALID,
"type is invalid"));else if(d.data&&d.data.gateways&&0!==d.data.gateways.length){d=d.data.gateways;var f,g;for(f=0;f<d.length;f++)if(d[f].index===a.gateway){g=d[f];break}g?b(null,a):b(new c(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else b(new c(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else b(new c(e.INVALID,"gateway is invalid"));else b(new c(e.INVALID,"info is invalid"))},updateDevice:function(a,d,b){var e=c.ERROR_CODE;if(a)if(a.gateway)if(null==a.address||"undefined"==
typeof a.address)b(new c(e.INVALID,"address is invalid"));else if(null==a.type||"undefined"==typeof a.type)b(new c(e.INVALID,"type is invalid"));else if(d.data&&d.data.gateways&&0!==d.data.gateways.length){d=d.data.gateways;var f,g;for(f=0;f<d.length;f++)if(d[f].index===a.gateway){g=d[f];break}g?b(null,a):b(new c(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else b(new c(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else b(new c(e.INVALID,"gateway is invalid"));else b(new c(e.INVALID,
"info is invalid"))},deleteDevice:function(a,c,b){b()},applyUIFilter:function(a,c){var b=this,e=function(b,c){if("*"==b)return!0;for(var a=!1,e=0;e<b.length;e++)if(b[e]==c){a=!0;break}return a},f=function(b,c,a){var d=[];switch(a.catagory){case "command":b.command&&b.command.forEach(function(b){e(a.elems,b.type)&&(b=JSON.parse(JSON.stringify(b)),d.push(b))});break;case "status":b.status&&b.status.forEach(function(b){e(a.elems,b.type)&&(b=JSON.parse(JSON.stringify(b)),d.push(b))})}return d},g=function(a,
c){var e=[],d=null;if(d=b.getCommandStatusMap(a))d=f(d,a,c),e=e.concat(d);return e};if(!a||null==a.type||"undefined"==typeof a.type)return null;var h=JSON.parse(JSON.stringify(a)),k=null;switch(c.catagory){case "command":k=g(a,c);h.command=k;break;case "status":k=g(a,c);h.status=k;break;default:return null}return k&&0!=k.length?h:null},getCommandStatusMap:function(a){return a&&a.type?this.MAP[a.type]:null}}}();
xnm.aio.homewizard.Handler=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.homewizard.Handler");this.detectedHomeWizards={}};xnm.aio.homewizard.Handler.prototype.HomeWizard=xnm.aio.homewizard.HomeWizard;xnm.aio.homewizard.Handler.prototype.devicemanager=xnm.aio.homewizard.DM;xnm.aio.homewizard.Handler.prototype.registModule=function(c){c.register(this.devicemanager.SYS,"homewizard")};
xnm.aio.homewizard.Handler.prototype.resolveGateway=function(c){return c&&c.ip&&c.password?new xnm.aio.homewizard.HomeWizard(c.ip,c.port,c.password):null};xnm.aio.homewizard.Handler.prototype.getDeviceCommands=function(c,a){var d=xnm.aio.homewizard.DM.applyUIFilter(c,{catagory:"command",elems:"*"}),d=d?d.command:[];a&&a(null,d)};xnm.aio.homewizard.Handler.prototype.getDeviceStatus=function(c,a){var d=xnm.aio.homewizard.DM.applyUIFilter(c,{catagory:"status",elems:"*"}),d=d?d.status:[];a&&a(null,d)};
xnm.aio.homewizard.Handler.prototype.doCommand=function(c,a,d,b){(c=this.resolveGateway(c))?c.executeCommandCreator(a,d,function(a){b&&b(a)}):b&&b(Error("gateway json format invalid"))};xnm.aio.homewizard.Handler.prototype.doStatus=function(c,a,d,b,e){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:c,device:d,status:b}],function(b,a){b?e&&e(b):e&&e(null,a[0])}):e&&e(Error("gateway json format invalid"))};
xnm.aio.homewizard.Handler.prototype.getDeviceList=function(c,a){var d=this.resolveGateway(c);if(d){var b=this;d.getDevices(function(c,d){if(c)a&&a(c);else{var g=[];d&&(d.switches&&d.switches.forEach(function(a){if(a)switch(a.type){case "switch":case "dimmer":case "radiator":case "somfy":case "asun":case "brel":g.push({sys:b.devicemanager.SYS,type:a.type,address:a.id,name:a.name})}}),d.scenes&&d.scenes.forEach(function(a){a&&g.push({sys:b.devicemanager.SYS,type:"scene",address:a.id,name:a.name})}),
d.windmeters&&d.windmeters.forEach(function(a){a&&g.push({sys:b.devicemanager.SYS,type:"wind",address:a.id,name:a.name})}),d.rainmeters&&d.rainmeters.forEach(function(a){a&&g.push({sys:b.devicemanager.SYS,type:"rain",address:a.id,name:a.name})}),d.thermometers&&d.thermometers.forEach(function(a){a&&g.push({sys:b.devicemanager.SYS,type:"thermo",address:a.id,name:a.name})}),d.kakusensors&&d.kakusensors.forEach(function(a){a&&a.type&&("doorbell"!=a.type&&"smoke"!=a.type&&"contact"!=a.type&&"motion"!=
a.type||g.push({sys:b.devicemanager.SYS,type:a.type,address:a.id,name:a.name}))}),d.energylinks&&d.energylinks.forEach(function(a){a&&g.push({sys:b.devicemanager.SYS,type:"energylink",address:a.id,name:a.name})}));a&&a(null,g)}})}else a&&a(Error("gateway json format invalid"))};
xnm.aio.homewizard.Handler.prototype.discoverHomeWizards=function(c){var a=this,d=function(b,c){$.ajax({url:"http://"+b,type:"GET",timeout:2E3,success:function(b){a._logger.log("trace","local search success:"+JSON.stringify(b));c&&(c(null),c=null)},error:function(b,d){var h="local search error:"+(b?b.status:"0")+"-"+d;a._logger.log("trace",h);c&&(c(Error(h)),c=null)}})};(function(b){$.ajax({url:"http://gateway.homewizard.nl/discovery.php",type:"GET",timeout:2E3,dataType:"json",success:function(c){a._logger.log("trace",
"remote search success:"+JSON.stringify(c));var d,g;c&&"ok"==c.status&&c.ip?g=c.ip:d=Error("repsonse not ok");b&&(b(d,g),b=null)},error:function(c,d){var g="remote search error:"+(c?c.status:"0")+"-"+d;a._logger.log("trace",g);b&&(b(Error(g)),b=null)}})})(function(a,e){a||!e?c&&c(null,[]):d(e,function(a){a?c&&c(null,[]):c&&c(null,[new xnm.aio.homewizard.HomeWizard(e)])})})};
xnm.aio.homewizard.Handler.prototype.getStateValues=function(c,a){return(new xnm.aio.homewizard.HomeWizard).getStateValues(c.type,a)};xnm.aio.homewizard.Handler.prototype.getDeviceCommandList=function(c,a,d){c=[];a&&(c.push({id:window.XC_Text.on,cmd:"on"}),c.push({id:window.XC_Text.off,cmd:"off"}));return c};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.homewizard.Handler);
