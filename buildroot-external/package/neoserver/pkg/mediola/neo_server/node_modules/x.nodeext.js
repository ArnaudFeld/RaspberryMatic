var http=require("http"),fs=require("fs");
http._getFileFallback=function(e,c,a){var f=require("os").tmpdir()+require("path").sep+"xcdl"+require("path").sep,b=f+Math.random().toString(36).substring(2);fs.existsSync(f)||fs.mkdirSync(f);f=require("url").parse(e);var d=80,h=!1;if(f.port){d=parseInt(f.port);if(0===d||isNaN(d))d=80;if(!(0<d&&65536>d)){a&&a(null);return}h=!0}var k=f.hostname,g=f.path,l;"https"==e.substring(0,5).toLowerCase()&&(h||(d=443));c&&c.user&&(l=c.user+":"+c.password);null==d&&(d=80);var m="",n=0,q=!1,p=require("net").connect({port:d,
host:k},function(){var a="GET "+g+" HTTP/1.1\r\n";a+="Host: "+k+"\r\n";l&&(a+="Authorization: Basic "+(new Buffer(l)).toString("base64")+"\r\n");p.write(a+"Connection: close\r\n\r\n")});p.on("data",function(a){if(q)fs.appendFileSync(b,a);else{n=m.length;m+=a.toString();var c=m.indexOf("\n\r\n");-1==c&&(c=m.indexOf("\n\n"));if(-1!=c){var f=m.indexOf("\n",c+1);q=!0;fs.writeFileSync(b,a.slice(f-n+1));m=m.substr(0,c)}}});p.on("end",function(){fs.existsSync(b)?a(b):a(null)});p.on("error",function(){a(null)})};
http.getFile=function(e,c,a,f,b){"undefined"==typeof b&&(b={});"undefined"==typeof b.encodeURL&&(b.encodeURL=!0);var d=require("os").tmpdir()+require("path").sep+"xcdl"+require("path").sep,h=d+Math.random().toString(36).substring(2);try{fs.existsSync(d)||fs.mkdirSync(d)}catch(n){a&&a(n);return}var k=require("url").parse(e),g=80;d=!1;if(k.port){g=parseInt(k.port);if(0===g||isNaN(g))g=80;if(!(0<g&&65536>g)){a&&a(null);return}d=!0}var l={host:k.hostname,port:g,path:b.encodeURL?encodeURI(decodeURI(k.path)):
k.path,method:"GET",headers:{}};c&&c.user&&(l.auth=c.user+":"+c.password);f&&(l.headers.Authorization=f);var m=require("http");b=m;"https"==e.substring(0,5).toLowerCase()&&(b=require("https"),d||(l.port=443));b=b.request(l,function(b){if(200==b.statusCode){var d=fs.createWriteStream(h);b.pipe(d);d.on("finish",function(){d.end();a(h)});d.on("error",function(){d.end()})}else 302==b.statusCode?b.headers.location?(m.getFile(b.headers.location,c,a,null,{encodeURL:!1}),b.destroy()):a&&a(null):401!=b.statusCode||
f?a(null):(f=null,b.headers&&b.headers["www-authenticate"]&&"Digest "==b.headers["www-authenticate"].substr(0,7)?(f=require("x.crypt.js").DigestAuth(b.headers["www-authenticate"],l.path,c.user,c.password))?m.getFile(e,c,a,f):a&&a(null):a&&a(null))});b.on("error",function(b){XC.debugf(b);m._getFileFallback(e,c,a)});b.end()};
http.postFile=function(e,c,a,f){var b=require("url").parse(c),d=80,h=!1;if(b.port){d=parseInt(b.port);if(0===d||isNaN(d))d=80;if(!(0<d&&65536>d)){f&&f(null);return}h=!0}b={host:b.hostname,port:d,path:b.path,method:"POST",headers:{Connection:"close","Content-Type":"application/octet-stream"}};a&&a.user&&(b.auth=a.user+":"+a.password);a=require("http");"https"==c.substring(0,5).toLowerCase()&&(a=require("https"),h||(b.port=443));var k=a.request(b,function(a){f&&f(a)});try{var g=fs.createReadStream(e);
g.pipe(k);g.on("finish",function(){g.close()});g.on("error",function(a){g.close();k.emit("error",a)})}catch(l){k.emit("error",l)}return k};
http.getFileAIOCloud=function(e,c,a,f,b){"undefined"==typeof b&&(b={});b=require("os").tmpdir()+require("path").sep+"xcdl"+require("path").sep;var d=b+Math.random().toString(36).substring(2);try{fs.existsSync(b)||fs.mkdirSync(b)}catch(n){a&&a(n);return}var h=require("url").parse(e),k=80;b=!1;if(h.port){k=parseInt(h.port);if(0===k||isNaN(k))k=80;if(!(0<k&&65536>k)){a&&a(null);return}b=!0}var g={host:h.hostname,port:k,path:h.path,method:"GET",headers:{}};if(c&&c.url){"?"==g.path[g.path.length-1]&&(g.path=
g.path.substring(0,g.path.length-1));h=!0;for(var l in c.url)g.path+=h?"?":"&",g.path+=l+"="+encodeURIComponent(c.url[l]),h=!1}c&&c.user&&(g.auth=c.user+":"+c.password);f&&(g.headers.Authorization=f);var m=require("http");l=m;"https"==e.substring(0,5).toLowerCase()&&(l=require("https"),b||(g.port=443));l=l.request(g,function(b){if(200==b.statusCode){var h=fs.createWriteStream(d);b.pipe(h);h.on("finish",function(){h.end();a(d)});h.on("error",function(){h.end()})}else 302==b.statusCode?b.headers.location?
(delete c.url,m.getFile(b.headers.location,c,a,null,{encodeURL:!1}),b.destroy()):a&&a(null):401!=b.statusCode||f?a(null):(f=null,b.headers&&b.headers["www-authenticate"]&&"Digest "==b.headers["www-authenticate"].substr(0,7)?(f=require("x.crypt.js").DigestAuth(b.headers["www-authenticate"],g.path,c.user,c.password))?m.getFile(e,c,a,f):a&&a(null):a&&a(null))});l.on("error",function(b){XC.debugf(b);m._getFileFallback(e,c,a)});l.end()};
fs.readFileLine=function(e,c,a){fs.readFile(e,function(f,b){f=!1;b=b.toString("utf-8").split("\n");b[c-1]&&(a(null,b[c-1]),f=!0);f||a("failed",null)})};fs.readFileBinary=function(e,c,a,f){fs.open(e,"r",function(b,d){fs.fstat(d,function(b,e){b=e.size;c>=b?(fs.close(d),f(null,"")):(c+a>b&&(a=b-c),1024<a&&(a=1024),b=new Buffer(a),fs.read(d,b,0,a,c,function(b,a,c){a=c.toString("hex");fs.close(d);b?f("failed",null):f(null,a)}))})})};
fs.rmdirRecursiveSync=function(e){var c=[];fs.existsSync(e)&&(c=fs.readdirSync(e),c.forEach(function(a,c){a=e+"/"+a;fs.lstatSync(a).isDirectory()?fs.rmdirRecursiveSync(a):fs.unlinkSync(a)}),fs.rmdirSync(e))};fs.mkdirRecursiveSync=function(e){var c=require("path");fs.existsSync(c.dirname(e))||fs.mkdirRecursiveSync(c.dirname(e));fs.existsSync(e)||fs.mkdirSync(e)};fs.copyFileSync=function(e,c){var a=c.substring(0,c.lastIndexOf("/"));fs.mkdirRecursiveSync(a);fs.writeFileSync(c,fs.readFileSync(e))};
fs.dataPath=function(){var e=null;try{e=require("nw.gui")}catch(c){}return"object"==typeof nw&&null!==nw&&nw.App?nw.App.dataPath+require("path").sep+"..":e?e.App.dataPath:process.cwd()};if("undefined"===typeof localStorage||null===localStorage){localStorage=null;try{var ls=require("node-localstorage").LocalStorage;localStorage=new ls("./localstorage")}catch(e){}};
