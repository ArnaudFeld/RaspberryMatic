var http=require("http"),fs=require("fs");
http._getFileFallback=function(e,c,a){var g=require("os").tmpdir()+require("path").sep+"xcdl"+require("path").sep,b=g+Math.random().toString(36).substring(2);fs.existsSync(g)||fs.mkdirSync(g);var g=require("url").parse(e),d=80,m=!1;if(g.port){d=parseInt(g.port);if(0===d||isNaN(d))d=80;if(!(0<d&&65536>d)){a&&a(null);return}m=!0}var l=g.hostname,f=g.path,h;"https"==e.substring(0,5).toLowerCase()&&(m||(d=443));c&&c.user&&(h=c.user+":"+c.password);null==d&&(d=80);var k="",n=0,q=!1,p=require("net").connect({port:d,
host:l},function(){var a="GET "+f+" HTTP/1.1\r\n",a=a+("Host: "+l+"\r\n");h&&(a+="Authorization: Basic "+(new Buffer(h)).toString("base64")+"\r\n");p.write(a+"Connection: close\r\n\r\n")});p.on("data",function(a){if(q)fs.appendFileSync(b,a);else{n=k.length;k+=a.toString();var c=k.indexOf("\n\r\n");-1==c&&(c=k.indexOf("\n\n"));if(-1!=c){var d=k.indexOf("\n",c+1);q=!0;fs.writeFileSync(b,a.slice(d-n+1));k=k.substr(0,c)}}});p.on("end",function(){fs.existsSync(b)?a(b):a(null)});p.on("error",function(){a(null)})};
http.getFile=function(e,c,a,g,b){"undefined"==typeof b&&(b={});"undefined"==typeof b.encodeURL&&(b.encodeURL=!0);var d=require("os").tmpdir()+require("path").sep+"xcdl"+require("path").sep,m=d+Math.random().toString(36).substring(2);try{fs.existsSync(d)||fs.mkdirSync(d)}catch(l){a&&a(l);return}var f=require("url").parse(e),h=80,d=!1;if(f.port){h=parseInt(f.port);if(0===h||isNaN(h))h=80;if(!(0<h&&65536>h)){a&&a(null);return}d=!0}var k={host:f.hostname,port:h,path:b.encodeURL?encodeURI(decodeURI(f.path)):
f.path,method:"GET",headers:{}};c&&c.user&&(k.auth=c.user+":"+c.password);g&&(k.headers.Authorization=g);var n=require("http");b=n;"https"==e.substring(0,5).toLowerCase()&&(b=require("https"),d||(k.port=443));b=b.request(k,function(b){if(200==b.statusCode){var d=fs.createWriteStream(m);b.pipe(d);d.on("finish",function(){d.end();a(m)});d.on("error",function(){d.end()})}else 302==b.statusCode?b.headers.location?(n.getFile(b.headers.location,c,a,null,{encodeURL:!1}),b.destroy()):a&&a(null):401!=b.statusCode||
g?a(null):(g=null,b.headers&&b.headers["www-authenticate"]&&"Digest "==b.headers["www-authenticate"].substr(0,7)?(g=require("x.crypt.js").DigestAuth(b.headers["www-authenticate"],k.path,c.user,c.password))?n.getFile(e,c,a,g):a&&a(null):a&&a(null))});b.on("error",function(b){XC.debugf(b);n._getFileFallback(e,c,a)});b.end()};
http.postFile=function(e,c,a,g){var b=require("url").parse(c),d=80,m=!1;if(b.port){d=parseInt(b.port);if(0===d||isNaN(d))d=80;if(!(0<d&&65536>d)){g&&g(null);return}m=!0}b={host:b.hostname,port:d,path:b.path,method:"POST",headers:{Connection:"close","Content-Type":"application/octet-stream"}};a&&a.user&&(b.auth=a.user+":"+a.password);a=require("http");"https"==c.substring(0,5).toLowerCase()&&(a=require("https"),m||(b.port=443));var l=a.request(b,function(a){g&&g(a)});try{var f=fs.createReadStream(e);
f.pipe(l);f.on("finish",function(){f.close()});f.on("error",function(a){f.close();l.emit("error",a)})}catch(h){l.emit("error",h)}return l};
http.getFileAIOCloud=function(e,c,a,g,b){"undefined"==typeof b&&(b={});b=require("os").tmpdir()+require("path").sep+"xcdl"+require("path").sep;var d=b+Math.random().toString(36).substring(2);try{fs.existsSync(b)||fs.mkdirSync(b)}catch(m){a&&a(m);return}var l=require("url").parse(e),f=80;b=!1;if(l.port){f=parseInt(l.port);if(0===f||isNaN(f))f=80;if(!(0<f&&65536>f)){a&&a(null);return}b=!0}var h={host:l.hostname,port:f,path:l.path,method:"GET",headers:{}};if(c&&c.url){"?"==h.path[h.path.length-1]&&(h.path=
h.path.substring(0,h.path.length-1));var l=!0,k;for(k in c.url)h.path+=l?"?":"&",h.path+=k+"="+encodeURIComponent(c.url[k]),l=!1}c&&c.user&&(h.auth=c.user+":"+c.password);g&&(h.headers.Authorization=g);var n=require("http");k=n;"https"==e.substring(0,5).toLowerCase()&&(k=require("https"),b||(h.port=443));k=k.request(h,function(b){if(200==b.statusCode){var f=fs.createWriteStream(d);b.pipe(f);f.on("finish",function(){f.end();a(d)});f.on("error",function(){f.end()})}else 302==b.statusCode?b.headers.location?
(delete c.url,n.getFile(b.headers.location,c,a,null,{encodeURL:!1}),b.destroy()):a&&a(null):401!=b.statusCode||g?a(null):(g=null,b.headers&&b.headers["www-authenticate"]&&"Digest "==b.headers["www-authenticate"].substr(0,7)?(g=require("x.crypt.js").DigestAuth(b.headers["www-authenticate"],h.path,c.user,c.password))?n.getFile(e,c,a,g):a&&a(null):a&&a(null))});k.on("error",function(b){XC.debugf(b);n._getFileFallback(e,c,a)});k.end()};
fs.readFileLine=function(e,c,a){fs.readFile(e,function(e,b){var d=!1,m=b.toString("utf-8").split("\n");m[c-1]&&(a(null,m[c-1]),d=!0);d||a("failed",null)})};fs.readFileBinary=function(e,c,a,g){fs.open(e,"r",function(b,d){fs.fstat(d,function(b,e){var f=e.size;c>=f?(fs.close(d),g(null,"")):(c+a>f&&(a=f-c),1024<a&&(a=1024),f=new Buffer(a),fs.read(d,f,0,a,c,function(a,b,c){b=c.toString("hex");fs.close(d);a?g("failed",null):g(null,b)}))})})};
fs.rmdirRecursiveSync=function(e){var c=[];fs.existsSync(e)&&(c=fs.readdirSync(e),c.forEach(function(a,c){var b=e+"/"+a;fs.lstatSync(b).isDirectory()?fs.rmdirRecursiveSync(b):fs.unlinkSync(b)}),fs.rmdirSync(e))};fs.mkdirRecursiveSync=function(e){var c=require("path");fs.existsSync(c.dirname(e))||fs.mkdirRecursiveSync(c.dirname(e));fs.existsSync(e)||fs.mkdirSync(e)};fs.copyFileSync=function(e,c){var a=c.substring(0,c.lastIndexOf("/"));fs.mkdirRecursiveSync(a);fs.writeFileSync(c,fs.readFileSync(e))};
fs.dataPath=function(){var e=null;try{e=require("nw.gui")}catch(c){}return"object"==typeof nw&&null!==nw&&nw.App?nw.App.dataPath+require("path").sep+"..":e?e.App.dataPath:process.cwd()};if("undefined"===typeof localStorage||null===localStorage){localStorage=null;try{var ls=require("node-localstorage").LocalStorage;localStorage=new ls("./localstorage")}catch(e$$8){}};
