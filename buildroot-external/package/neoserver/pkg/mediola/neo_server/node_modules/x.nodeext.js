var http=require("http"),fs=require("fs");
http._getFileFallback=function(e,c,b){var f=require("os").tmpdir()+require("path").sep+"xcdl"+require("path").sep,a=f+Math.random().toString(36).substring(2);fs.existsSync(f)||fs.mkdirSync(f);f=require("url").parse(e);var d=80,h=!1;if(f.port){d=parseInt(f.port);if(0===d||isNaN(d))d=80;if(!(0<d&&65536>d)){b&&b(null);return}h=!0}var k=f.hostname,g=f.path,l;"https"==e.substring(0,5).toLowerCase()&&(h||(d=443));c&&c.user&&(l=c.user+":"+c.password);null==d&&(d=80);var m="",n=0,q=!1,p=require("net").connect({port:d,
host:k},function(){var b="GET "+g+" HTTP/1.1\r\n";b+="Host: "+k+"\r\n";l&&(b+="Authorization: Basic "+(new Buffer(l)).toString("base64")+"\r\n");p.write(b+"Connection: close\r\n\r\n")});p.on("data",function(b){if(q)fs.appendFileSync(a,b);else{n=m.length;m+=b.toString();var c=m.indexOf("\n\r\n");-1==c&&(c=m.indexOf("\n\n"));if(-1!=c){var f=m.indexOf("\n",c+1);q=!0;fs.writeFileSync(a,b.slice(f-n+1));m=m.substr(0,c)}}});p.on("end",function(){fs.existsSync(a)?b(a):b(null)});p.on("error",function(){b(null)})};
http.getFile=function(e,c,b,f,a){"undefined"==typeof a&&(a={});"undefined"==typeof a.encodeURL&&(a.encodeURL=!0);var d=require("os").tmpdir()+require("path").sep+"xcdl"+require("path").sep,h=d+Math.random().toString(36).substring(2);try{fs.existsSync(d)||fs.mkdirSync(d)}catch(n){b&&b(n);return}var k=require("url").parse(e),g=80;d=!1;if(k.port){g=parseInt(k.port);if(0===g||isNaN(g))g=80;if(!(0<g&&65536>g)){b&&b(null);return}d=!0}var l={host:k.hostname,port:g,path:a.encodeURL?encodeURI(decodeURI(k.path)):
k.path,method:"GET",headers:{}};c&&c.user&&(l.auth=c.user+":"+c.password);f&&(l.headers.Authorization=f);var m=require("http");a=m;"https"==e.substring(0,5).toLowerCase()&&(a=require("https"),d||(l.port=443));a=a.request(l,function(a){if(200==a.statusCode){var d=fs.createWriteStream(h);a.pipe(d);d.on("finish",function(){d.end();b(h)});d.on("error",function(){d.end()})}else 301==a.statusCode||302==a.statusCode?a.headers.location?(m.getFile(a.headers.location,c,b,null,{encodeURL:!1}),a.destroy()):b&&
b(null):401!=a.statusCode||f?b(null):(f=null,a.headers&&a.headers["www-authenticate"]&&"Digest "==a.headers["www-authenticate"].substr(0,7)?(f=require("x.crypt.js").DigestAuth(a.headers["www-authenticate"],l.path,c.user,c.password))?m.getFile(e,c,b,f):b&&b(null):b&&b(null))});a.on("error",function(a){XC.debugf(a);m._getFileFallback(e,c,b)});a.end()};
http.postFile=function(e,c,b,f){var a=require("url").parse(c),d=80,h=!1;if(a.port){d=parseInt(a.port);if(0===d||isNaN(d))d=80;if(!(0<d&&65536>d)){f&&f(null);return}h=!0}a={host:a.hostname,port:d,path:a.path,method:"POST",headers:{Connection:"close","Content-Type":"application/octet-stream"}};b&&b.user&&(a.auth=b.user+":"+b.password);b=require("http");"https"==c.substring(0,5).toLowerCase()&&(b=require("https"),h||(a.port=443));var k=b.request(a,function(b){f&&f(b)});try{var g=fs.createReadStream(e);
g.pipe(k);g.on("finish",function(){g.close()});g.on("error",function(b){g.close();k.emit("error",b)})}catch(l){k.emit("error",l)}return k};
http.getFileAIOCloud=function(e,c,b,f,a){"undefined"==typeof a&&(a={});a=require("os").tmpdir()+require("path").sep+"xcdl"+require("path").sep;var d=a+Math.random().toString(36).substring(2);try{fs.existsSync(a)||fs.mkdirSync(a)}catch(n){b&&b(n);return}var h=require("url").parse(e),k=80;a=!1;if(h.port){k=parseInt(h.port);if(0===k||isNaN(k))k=80;if(!(0<k&&65536>k)){b&&b(null);return}a=!0}var g={host:h.hostname,port:k,path:h.path,method:"GET",headers:{}};if(c&&c.url){"?"==g.path[g.path.length-1]&&(g.path=
g.path.substring(0,g.path.length-1));h=!0;for(var l in c.url)g.path+=h?"?":"&",g.path+=l+"="+encodeURIComponent(c.url[l]),h=!1}c&&c.user&&(g.auth=c.user+":"+c.password);f&&(g.headers.Authorization=f);var m=require("http");l=m;"https"==e.substring(0,5).toLowerCase()&&(l=require("https"),a||(g.port=443));l=l.request(g,function(a){if(200==a.statusCode){var h=fs.createWriteStream(d);a.pipe(h);h.on("finish",function(){h.end();b(d)});h.on("error",function(){h.end()})}else 302==a.statusCode?a.headers.location?
(delete c.url,m.getFile(a.headers.location,c,b,null,{encodeURL:!1}),a.destroy()):b&&b(null):401!=a.statusCode||f?b(null):(f=null,a.headers&&a.headers["www-authenticate"]&&"Digest "==a.headers["www-authenticate"].substr(0,7)?(f=require("x.crypt.js").DigestAuth(a.headers["www-authenticate"],g.path,c.user,c.password))?m.getFile(e,c,b,f):b&&b(null):b&&b(null))});l.on("error",function(a){XC.debugf(a);m._getFileFallback(e,c,b)});l.end()};
fs.readFileLine=function(e,c,b){fs.readFile(e,function(f,a){f=!1;a=a.toString("utf-8").split("\n");a[c-1]&&(b(null,a[c-1]),f=!0);f||b("failed",null)})};fs.readFileBinary=function(e,c,b,f){fs.open(e,"r",function(a,d){fs.fstat(d,function(a,e){a=e.size;c>=a?(fs.closeSync?fs.closeSync(d):fs.close(d),f(null,"")):(c+b>a&&(b=a-c),1024<b&&(b=1024),a=new Buffer(b),fs.read(d,a,0,b,c,function(a,b,c){b=c.toString("hex");fs.closeSync?fs.closeSync(d):fs.close(d);a?f("failed",null):f(null,b)}))})})};
fs.rmdirRecursiveSync=function(e){var c=[];fs.existsSync(e)&&(c=fs.readdirSync(e),c.forEach(function(b,c){b=e+"/"+b;fs.lstatSync(b).isDirectory()?fs.rmdirRecursiveSync(b):fs.unlinkSync(b)}),fs.rmdirSync(e))};fs.mkdirRecursiveSync=function(e){var c=require("path");fs.existsSync(c.dirname(e))||fs.mkdirRecursiveSync(c.dirname(e));fs.existsSync(e)||fs.mkdirSync(e)};fs.copyFileSync=function(e,c){var b=c.substring(0,c.lastIndexOf("/"));fs.mkdirRecursiveSync(b);fs.writeFileSync(c,fs.readFileSync(e))};
fs.dataPath=function(){var e=null;try{e=require("nw.gui")}catch(c){}return"object"==typeof nw&&null!==nw&&nw.App?nw.App.dataPath+require("path").sep+"..":e?e.App.dataPath:process.cwd()};if("undefined"===typeof localStorage||null===localStorage){localStorage=null;try{var ls=require("node-localstorage").LocalStorage;localStorage=new ls("./localstorage")}catch(e){}};
