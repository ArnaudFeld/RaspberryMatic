var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.hautau=xnm.aio.hautau||{};
xnm.aio.hautau.Gateway=function(){var d=function(b,a){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.hautau.Gateway");this.ip=b;this.port=a;this.port||(this.port=80);this.timeout=1E3;this._statesBuffer={};this._fifo=[]};d.DEVICETYPE_MAP={0:"general",1:"multisensor",2:"outputbox203v",4:"general",5:"ventra",6:"general",7:"general",8:"general",9:"drive",10:"general",11:"general",100:"general",101:"ska20cd",102:"drive",103:"hscd",104:"general",
106:"drive",107:"general",108:"general",255:"general"};d.prototype.executeCommandCreator=function(b,a,e){if(a&&a.value)if(b)if("undefined"==typeof b.address||null==b.address)e&&e(Error("device json format invali"));else switch(a.value){case "open":this._open(b.address,e);break;case "close":this._close(b.address,e);break;case "stop":this._stop(b.address,e);break;case "levelUp":this._setVentraLevel(b.address,"up",e);break;case "levelDown":this._setVentraLevel(b.address,"down",e);break;case "levelTo":this._setVentraLevel(b.address,
a.ext,e);break;case "keyboardOn":this._setVentraKeyboard(b.address,"on",e);break;case "keyboardOff":this._setVentraKeyboard(b.address,"off",e);break;case "lockOn":this._setHscdLock(b.address,"on",e);break;case "lockOff":this._setHscdLock(b.address,"off",e);break;default:e&&e(Error("command not exist"))}else e&&e(Error("device json is null"));else e&&e(Error("command json format invalid"))};d.prototype.getStatesCreator=function(b,a,e){for(var c={},h=0;h<a.length;h++)(b=a[h])&&b.device&&"undefined"!=
typeof b.device.address&&null!=b.device.address&&b.device.type&&(c[b.device.address]=b.device.type);var d=[],f=this,g=Object.keys(c),h=0,m=function(b,p){if(!b&&p){var q;q=g[h];if(p){for(var u=[],r=0;r<a.length;r++){var n=a[r];if(n&&n.id&&n.device&&n.device.address&&n.device.address==q&&n.status&&n.status.value){var t=p[n.status.value];"undefined"!=typeof t&&null!=t&&u.push({id:n.id,status:t})}}q=u}else q=[];q&&(d=d.concat(q))}h++;h<g.length?f._getDeviceStates(g[h],c[g[h]],m):e&&e(null,d)};this._getDeviceStates(g[h],
c[g[h]],m)};d.prototype.listDevices=function(b,a){var e=this,c=0,h=30;if("object"===typeof b&&null!==b){var d=Number(b.start),f=Number(b.end);!isNaN(d)&&0<=d&&255>=d&&(c=d);!isNaN(f)&&0<=f&&255>=f&&(h=f);h<c&&(h=c)}var g=c,m=0,l=[],p=function(b,d){b&&-3!=b.code?c==g&&5>m?(m++,e._ping(c,p)):a&&a(b,l):(!b&&d&&(d.sys="hautau",d.type=d.DeviceType,d.address=c,l.push(d)),c++,c>h?a&&a(null,l):e._ping(c,p))};this._ping(c,p)};d.prototype._getDeviceStates=function(b,a,e){var c=(new Date).getTime(),h=!1,k=this._statesBuffer[b];
k?k.timestamp&&3E3<c-k.timestamp&&(h=!0,k.timestamp=c):(h=!0,this._statesBuffer[b]={states:null,timestamp:c},k=this._statesBuffer[b]);a=d.DEVICETYPE_MAP[a];if("undefined"==typeof a||null==a)e&&e(Error("unknown device type"));else if(h){var f=this;switch(a){case "drive":this._getDriveStates(b,function(a,c){!a&&c&&(f._statesBuffer[b]={states:c,timestamp:(new Date).getTime()});e&&e(a,c)});break;case "multisensor":this._getMultiSensorStates(b,function(a,c){!a&&c&&(f._statesBuffer[b]={states:c,timestamp:(new Date).getTime()});
e&&e(a,c)});break;case "ska20cd":this._getSka20cdStates(b,function(a,c){!a&&c&&(f._statesBuffer[b]={states:c,timestamp:(new Date).getTime()});e&&e(a,c)});break;case "ventra":this._getVentraStates(b,function(a,c){!a&&c&&(f._statesBuffer[b]={states:c,timestamp:(new Date).getTime()});e&&e(a,c)});break;case "hscd":this._getHscdStates(b,function(a,c){!a&&c&&(f._statesBuffer[b]={states:c,timestamp:(new Date).getTime()});e&&e(a,c)});break;default:e&&e(null,null)}}else e&&e(null,k.states)};d.prototype._open=
function(b,a){this._executeRequest("/hautau/open",{adr:b},null,function(e,c){a&&a(e,c)})};d.prototype._close=function(b,a){this._executeRequest("/hautau/close",{adr:b},null,function(e,c){a&&a(e,c)})};d.prototype._stop=function(b,a){this._executeRequest("/hautau/stop",{adr:b},null,function(e,c){a&&a(e,c)})};d.prototype._getDriveStates=function(b,a){this._executeRequest("/hautau/drive",{adr:b,state:"show"},null,function(e,c){if(e)a&&a(e,c);else{var b={Closed:"yes"==c.Closed,Opened:"yes"==c.Opened,PowerCutoff:"yes"==
c.PowerCutoff,State:"yes"==c.Closed?"closed":"open"};a&&a(null,b)}})};d.prototype._getMultiSensorStates=function(b,a){this._executeRequest("/hautau/multisensor",{adr:b,state:"show"},null,function(e,c){e?a&&a(e,c):(c.Temperature=c.Temperature.toFixed(1),a&&a(null,c))})};d.prototype._getSka20cdStates=function(b,a){this._executeRequest("/hautau/ska20cd",{adr:b,state:"show"},null,function(e,c){if(e)a&&a(e,c);else{var b={Closed:"yes"==c.Closed,Opened:"yes"==c.Opened,PowerCutoff:"yes"==c.PowerCutoff,State:"yes"==
c.Closed?"closed":"open"};a&&a(null,b)}})};d.prototype._getVentraStates=function(b,a){this._executeRequest("/hautau/ventra",{adr:b,state:"show"},null,function(b,c){b?a&&a(b,c):(c.FilterChange="yes"==c.FilterChange,a&&a(null,c))})};d.prototype._setVentraLevel=function(b,a,e){var c=this;a||(a=0);this._executeRequest("/hautau/ventra",{adr:b,level:a},null,function(a,d){if(a)e&&e(a,d);else if("undefined"!=typeof d.Level&&null!=d.Level){var f=(new Date).getTime(),g=c._statesBuffer[b];g||(c._statesBuffer[b]=
{states:{},timestamp:f},g=this._statesBuffer[b]);g.states.Level=d.Level}})};d.prototype._setVentraKeyboard=function(b,a,e){var c=this;this._executeRequest("/hautau/ventra",{adr:b,keyboard:a},null,function(a,d){if(a)e&&e(a,d);else if("undefined"!=typeof d.Keyboard&&null!=d.Keyboard){var f=(new Date).getTime(),g=c._statesBuffer[b];g||(c._statesBuffer[b]={states:{},timestamp:f},g=this._statesBuffer[b]);g.states.Keyboard=d.Keyboard}})};d.prototype._getHscdStates=function(b,a){this._executeRequest("/hautau/hscd",
{adr:b,state:"show"},null,function(b,c){b?a&&a(b,c):(c.WindowDown="yes"==c.WindowDown,c.WindowClosed="yes"==c.WindowClosed,c.State=c.WindowClosed?"closed":"open",a&&a(null,c))})};d.prototype._setHscdLock=function(b,a,e){var c=this;this._executeRequest("/hautau/hscd",{adr:b,lock:a},null,function(a,d){if(a)e&&e(a,d);else if("undefined"!=typeof d.Lock&&null!=d.Lock){var f=(new Date).getTime(),g=c._statesBuffer[b];g||(c._statesBuffer[b]={states:{},timestamp:f},g=this._statesBuffer[b]);g.states.Lock=d.Lock}})};
d.prototype._ping=function(b,a){this._executeRequest("/hautau/ping",{adr:b},2E3,a)};d.prototype._executeRequest=function(b,a,e,c){var d=this._fifo.length;this._fifo.push({path:b,params:a,timeout:e,callback:c});0==d&&this._doNextRequest()};d.prototype._doNextRequest=function(){if(0!=this._fifo.length){var b=this._fifo[0],a=this;this._doJsonRequest(b.path,b.params,b.timeout,function(e,c){try{b.callback&&b.callback(e,c)}catch(d){}a._fifo.splice(0,1);a._doNextRequest()})}};d.prototype._doJsonRequest=
function(b,a,e,c){this._doRequest("GET",b,a,e,function(a,b){if(a)c&&c(a);else if(b)try{var e=JSON.parse(b);"ok"!=e.Result?(a=Error(e.Result?e.Result:"result param is empty"),a.code=-3,c&&c(a)):c&&c(null,e)}catch(d){d.code=-2,c&&c(d)}else a=Error("request empty"),a.code=-2,c&&c(a)})};d.prototype._doRequest=function(b,a,e,c,d){c||(c=this.timeout);var k=this;a="http://"+this.ip+":"+this.port+a;if(e){var f=[],g;for(g in e){var m=e[g];if("undefined"==typeof m||null==m)m="";f.push(g+"="+encodeURIComponent(m))}a+=
"?"+f.join("&")}this._logger.log("trace","send "+b+" to url:"+a);var l=d;$.ajax({url:a,type:b,timeout:c,dataType:"text",cache:!0,success:function(a){k._logger.log("trace","http request success:"+a);l&&(l(null,a),l=null)},error:function(a,c){var b="http request error:"+(a?a.status:"0")+"-"+c;k._logger.log("trace",b);l&&(b=Error(b),b.code=-1,l(b),l=null)}})};d.prototype.toJSON=function(){return{sys:"hautau",ip:this.ip,port:this.port}};d.prototype.equalsTo=function(b){return b&&b instanceof d?this.ip==
b.ip&&this.port==b.port:!1};d.parseJSON=function(b){return b.ip?new d(b.ip,b.port):null};return d}();
xnm.aio.hautau.DM=function(){var d=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};d.prototype=Error();d.prototype.name="HautauDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var b={general:{command:[{type:"enum",name:"open",ref:{value:"open"}},{type:"enum",name:"close",ref:{value:"close"}},{type:"enum",name:"stop",ref:{value:"stop"}}]},outputbox203v:{command:[{type:"enum",name:"open",ref:{value:"open"}},
{type:"enum",name:"close",ref:{value:"close"}},{type:"enum",name:"stop",ref:{value:"stop"}}]},multisensor:{status:[{type:"int",name:"co2",ref:{value:"CO2"}},{type:"float",name:"temperature",ref:{value:"Temperature"}},{type:"int",name:"humidity",ref:{value:"Humidity"}}]},drive:{command:[{type:"enum",name:"open",ref:{value:"open"}},{type:"enum",name:"close",ref:{value:"close"}},{type:"enum",name:"stop",ref:{value:"stop"}}],status:[{type:"enum",name:"power cutoff",ref:{value:"PowerCutoff",options:["true",
"false"]}},{type:"enum",name:"opened",ref:{value:"Opened",options:["true","false"]}},{type:"enum",name:"closed",ref:{value:"Closed",options:["true","false"]}},{type:"enum",name:"state",ref:{value:"State",options:["open","closed"]}}]},ska20cd:{command:[{type:"enum",name:"open",ref:{value:"open"}},{type:"enum",name:"close",ref:{value:"close"}},{type:"enum",name:"stop",ref:{value:"stop"}}],status:[{type:"enum",name:"power cutoff",ref:{value:"PowerCutoff",options:["true","false"]}},{type:"enum",name:"opened",
ref:{value:"Opened",options:["true","false"]}},{type:"enum",name:"closed",ref:{value:"Closed",options:["true","false"]}},{type:"enum",name:"state",ref:{value:"State",options:["open","closed"]}}]},ventra:{command:[{type:"int",name:"set level",ref:{value:"levelTo",ext:"%d",extMeta:"0-4"}},{type:"enum",name:"level up",ref:{value:"levelUp"}},{type:"enum",name:"level down",ref:{value:"levelDown"}}],status:[{type:"enum",name:"error",ref:{value:"Errors",options:"no temperature fan1 fan2 keyboard opened".split(" ")}},
{type:"enum",name:"change filter",ref:{value:"FilterChange",options:["true","false"]}},{type:"int",name:"filter percent",ref:{value:"FilterPercent",extMeta:"0-100"}},{type:"int",name:"level0 runtime",ref:{value:"RuntimeLevel0"}},{type:"int",name:"level1 runtime",ref:{value:"RuntimeLevel1"}},{type:"int",name:"level2 runtime",ref:{value:"RuntimeLevel2"}},{type:"int",name:"level3 runtime",ref:{value:"RuntimeLevel3"}},{type:"int",name:"level",ref:{value:"Level",extMeta:"0-4"}},{type:"enum",name:"keyboard",
ref:{value:"Keyboard",options:["on","off"]}}]},hscd:{command:[{type:"enum",name:"open",ref:{value:"open"}},{type:"enum",name:"close",ref:{value:"close"}},{type:"enum",name:"stop",ref:{value:"stop"}}],status:[{type:"enum",name:"error",ref:{value:"Errors",options:"no safety current keyboard sw cpu checksum ram watchdog stop safetystop pos speed vars phase".split(" ")}},{type:"enum",name:"lock",ref:{value:"Lock",options:["on","off"]}},{type:"enum",name:"window down",ref:{value:"WindowDown",options:["true",
"false"]}},{type:"enum",name:"window closed",ref:{value:"WindowClosed",options:["true","false"]}},{type:"enum",name:"window state",ref:{value:"State",options:["open","closed"]}}]}};return{SYS:"hautau",getGatewayType:function(){return[{sys:this.SYS,name:"HAUTAU WLAN-Box",port:80}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:0,name:"Rauchmeldezentrale (RAZK)"},{sys:this.SYS,type:1,name:"Multisensor MS"},{sys:this.SYS,type:2,name:"Output Box 230V"},{sys:this.SYS,type:4,name:"LSF"},{sys:this.SYS,
type:5,name:"Fensterl\u00fcfter Ventra 301"},{sys:this.SYS,type:6,name:"Primat kompakt"},{sys:this.SYS,type:7,name:"Small Master"},{sys:this.SYS,type:8,name:"Fensterl\u00fcfter Monitor"},{sys:this.SYS,type:9,name:"Primat kompakt 195"},{sys:this.SYS,type:10,name:"RWA Taster"},{sys:this.SYS,type:11,name:"Rauchmelder"},{sys:this.SYS,type:100,name:"Wlan Box"},{sys:this.SYS,type:101,name:"SKA 20 comfort drive"},{sys:this.SYS,type:102,name:"SM2/EM2 comfort drive"},{sys:this.SYS,type:103,name:"Atrium HS comfort drive"},
{sys:this.SYS,type:104,name:"Lamelle"},{sys:this.SYS,type:106,name:"Neu Primat kompakt 195"},{sys:this.SYS,type:107,name:"SBS comfort drive"},{sys:this.SYS,type:108,name:"Primat kompakt SOBINCO"}]},createGateway:function(a,b,c){b=d.ERROR_CODE;a?a.ip?c(null,a):c(new d(b.INVALID,"ip is invalid")):c(new d(b.INVALID,"info is invalid"))},updateGateway:function(a,b,c,h){a=d.ERROR_CODE;b?b.ip?h(null,b):h(new d(a.INVALID,"ip is invalid")):h(new d(a.INVALID,"update is invalid"))},deleteGateway:function(a,
b,c){c()},createDevice:function(a,b,c){var h=d.ERROR_CODE;if(a)if(a.gateway)if(null==a.address||"undefined"==typeof a.address)c(new d(h.INVALID,"address is invalid"));else if(null==a.type||"undefined"==typeof a.type)c(new d(h.INVALID,"type is invalid"));else{b=b.data.gateways;var k,f;for(k=0;k<b.length;k++)if(b[k].index===a.gateway){f=b[k];break}f?c(null,a):c(new d(h.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else c(new d(h.INVALID,"gateway is invalid"));else c(new d(h.INVALID,"info is invalid"))},
updateDevice:function(a,b,c){var h=d.ERROR_CODE;if(a)if(a.gateway)if(null==a.address||"undefined"==typeof a.address)c(new d(h.INVALID,"address is invalid"));else if(null==a.type||"undefined"==typeof a.type)c(new d(h.INVALID,"type is invalid"));else{b=b.data.gateways;var k,f;for(k=0;k<b.length;k++)if(b[k].index===a.gateway){f=b[k];break}f?c(null,a):c(new d(h.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else c(new d(h.INVALID,"gateway is invalid"));else c(new d(h.INVALID,"info is invalid"))},
deleteDevice:function(a,b,c){c()},applyUIFilter:function(a,b){var c=this,d=function(a,b,c){var e=[];a.forEach(function(a){if("root"==a.type){a=JSON.parse(JSON.stringify(a));var f=d(a.children,b,c);f&&0<f.length&&(a.children=f,e.push(a))}else{f=c.elems;if("*"==f)f=!0;else{for(var g=!1,k=0;k<f.length;k++)if(f[k]==a.type){g=!0;break}f=g}f&&(a=JSON.parse(JSON.stringify(a)),e.push(a))}});return e},k=function(a,b){var e=[],f=c.getCommandStatusMap(a);if(f){var g=[];switch(b.catagory){case "command":f.command&&
(g=d(f.command,a,b));break;case "status":f.status&&(g=d(f.status,a,b))}e=e.concat(g)}return e};if(!a.sys)return null;var f=JSON.parse(JSON.stringify(a)),g=null;switch(b.catagory){case "command":g=k(a,b);f.command=g;break;case "status":g=k(a,b);f.status=g;break;default:return null}return g&&0!=g.length?f:null},getCommandStatusMap:function(a){return a&&"undefined"!=typeof a.type&&null!=a.type?(a=xnm.aio.hautau.Gateway.DEVICETYPE_MAP[a.type])?b[a]:null:null}}}();
xnm.aio.hautau.Handler=function(){var d=function(){};d.prototype.Gateway=xnm.aio.hautau.Gateway;d.prototype.devicemanager=xnm.aio.hautau.DM;d.prototype.registModule=function(b){b.register(this.devicemanager.SYS,"hautau")};d.prototype.resolveGateway=function(b){return b?this.Gateway.parseJSON(b):null};d.prototype.getDeviceCommands=function(b,a){var e=this.devicemanager.applyUIFilter(b,{catagory:"command",elems:"*"}),e=e?e.command:[];a&&a(null,e)};d.prototype.getDeviceStatus=function(b,a){var e=this.devicemanager.applyUIFilter(b,
{catagory:"status",elems:"*"}),e=e?e.status:[];a&&a(null,e)};d.prototype.doCommand=function(b,a,e,c){(b=this.resolveGateway(b))?b.executeCommandCreator(a,e,function(a){c&&c(a)}):c&&c(Error("gateway json format invalid"))};d.prototype.doStatus=function(b,a,e,c,d){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:b,device:e,status:c}],function(a,b){a?d&&d(a):d&&d(null,b[0])}):d&&d(Error("device json format invalid"))};d.prototype.getDeviceList=function(b,a,d){(b=this.resolveGateway(b))?b.listDevices(a,
function(a,b){d&&d(a,b)}):d&&d(Error("gateway json format invalid"))};return d}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.hautau.Handler);
