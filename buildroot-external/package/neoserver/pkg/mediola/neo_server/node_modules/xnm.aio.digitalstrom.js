var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.digitalstrom=xnm.aio.digitalstrom||{},xnm.aio.digitalstrom.Server=function(){var e={0:"Broadcast",1:"Light",2:"Shading",3:"Heating",4:"Audio",5:"Video",6:"Security",7:"Access",8:"Joker",9:"Cooling",10:"Room ventilation",11:"Window",12:"Recirculation",48:"Temperature control",64:"Apartment ventilation"},t={0:"Preset 0",1:"Area 1 Off",2:"Area 2 Off",3:"Area 3 Off",4:"Area 4 Off",5:"Preset 1",6:"Area 1 On",7:"Area 2 On",8:"Area 3 On",9:"Area 4 On",10:"Area Stepping Continue",11:"Decrement",12:"Increment",13:"Minimum",14:"Maximum",15:"Stop",17:"Preset 2",18:"Preset 3",19:"Preset 4",20:"Preset 12",21:"Preset 13",22:"Preset 14",23:"Preset 22",24:"Preset 23",25:"Preset 24",26:"Preset 32",27:"Preset 33",28:"Preset 34",29:"Preset 42",30:"Preset 43",31:"Preset 44",32:"Preset 10",33:"Preset 11",34:"Preset 20",35:"Preset 21",36:"Preset 30",37:"Preset 31",38:"Preset 40",39:"Preset 41",40:"Auto Off",41:"Impulse",42:"Area 1 Decrement",43:"Area 1 Increment",44:"Area 2 Decrement",45:"Area 2 Increment",46:"Area 3 Decrement",47:"Area 3 Increment",48:"Area 4 Decrement",49:"Area 4 Increment",50:"Device Off",51:"Device On",52:"Area 1 Stop",53:"Area 2 Stop",54:"Area 3 Stop",55:"Area 4 Stop",56:"Sun protection"},n={64:"Auto Standby",65:"Panic",67:"Standby",68:"Deep Off",69:"Sleeping",70:"Wakeup",71:"Present",72:"Absent",73:"Door Bell",74:"Alarm",75:"Zone Active",76:"Fire",77:"Smoke",78:"Water",79:"Gas",80:"Bell 2",81:"Bell 3",82:"Bell 4",83:"Alarm 2",84:"Alarm 3",85:"Alarm 4",86:"Wind",87:"No Wind",88:"Rain",89:"No Rain",90:"Hail",91:"No Hail"},a=function a(e){this._server=e;};a.prototype._requestApplicationToken=function(e,t){this._doSystemRequest("requestApplicationToken",{applicationName:e},function(e,n){e?t&&t(e):t&&t(null,n.applicationToken);});},a.prototype._login=function(e,t,n){this._doSystemRequest("login",{user:e,password:t},function(e,t){e?n&&n(e):n&&n(null,t.token);});},a.prototype._enableToken=function(e,t,n){this._doSystemRequest("enableToken",{applicationToken:e,token:t},function(e){n&&n(e);});},a.prototype._loginApplication=function(e,t){e?this._doSystemRequest("loginApplication",{loginToken:e},function(e,n){e?t&&t(e):t&&t(null,n.token);}):t&&t(new Error("loginToken is empty"));},a.prototype._doSystemRequest=function(e,t,n){this._server._doJsonRequest("/system/"+e,t,function(e,t){e?n&&n(e):n&&n(null,t);});};var r=function r(e){this._server=e;};r.prototype._getName=function(e){this._doApartmentRequest("getName",null,function(t,n){t?e&&e(t):n?e&&e(null,n.name):e&&e(new Error("apartment getName result invalid"));});},r.prototype._getSensorValues=function(e){this._doApartmentRequest("getSensorValues",null,function(t,n){t?e&&e(t):n?e&&e(null,n):e&&e(new Error("apartment getSensorValues result invalid"));});},r.prototype._getTemperatureControlStatus=function(e){this._doApartmentRequest("getTemperatureControlStatus",null,function(t,n){t?e&&e(t):n?e&&e(null,n):e&&e(new Error("apartment getTemperatureControlStatus result invalid"));});},r.prototype._getStructure=function(e){this._doApartmentRequest("getStructure",null,function(t,n){t?e&&e(t):e&&e(null,n);});},r.prototype._callScene=function(e,t){e?void 0!==e.sceneNumber&&null!=e.sceneNumber?this._doApartmentRequest("callScene",e,function(e,n){e?t&&t(e):t&&t(null,n);}):t&&t(new Error("sceneNumber invalid")):t&&t(new Error("params invalid"));},r.prototype._doApartmentRequest=function(e,t,n){this._server._doJsonRequest("/apartment/"+e,t,function(e,t){e?n&&n(e):n&&n(null,t);});};var o=function o(e){this._server=e;};o.prototype._getReachableScenes=function(e,t,n){if(void 0!==e&&null!=e){if(void 0!==t&&null!=t){var a={id:e,groupID:t};this._doZoneRequest("getReachableScenes",a,n);}else n&&n(new Error("groupID invalid"));}else n&&n(new Error("id invalid"));},o.prototype._callScene=function(e,t,n){t?void 0!==t.sceneNumber&&null!=t.sceneNumber?void 0!==e&&null!=e?(t.id=e,this._doZoneRequest("callScene",t,n)):n&&n(new Error("id invalid")):n&&n(new Error("sceneNumber invalid")):n&&n(new Error("params invalid"));},o.prototype._doZoneRequest=function(e,t,n){this._server._doJsonRequest("/zone/"+e,t,function(e,t){e?n&&n(e):n&&n(null,t);});};var i=function i(e){this._server=e;};i.prototype._turnOn=function(e,t){this._doDeviceRequest("turnOn",e,t);},i.prototype._turnOff=function(e,t){this._doDeviceRequest("turnOff",e,t);},i.prototype._increaseValue=function(e,t){this._doDeviceRequest("increaseValue",e,t);},i.prototype._decreaseValue=function(e,t){this._doDeviceRequest("decreaseValue",e,t);},i.prototype._callScene=function(e,t){e?void 0!==e.sceneNumber&&null!=e.sceneNumber?this._doDeviceRequest("callScene",e,t):t&&t(new Error("sceneNumber invalid")):t&&t(new Error("params invalid"));},i.prototype._doDeviceRequest=function(e,t,n){t?void 0!==t.dsid&&null!=t.dsid||t.name?this._server._doJsonRequest("/device/"+e,t,function(e,t){e?n&&n(e):n&&n(null,t);}):n&&n(new Error("no dsid or name")):n&&n(new Error("params invalid"));};var s=function s(e){this._server=e;};s.prototype._getMeters=function(e){this._query("/apartment/dSMeters/*(*)",function(t,n){if(t)e&&e(t);else{var a=[];n&&n.dSMeters&&(a=n.dSMeters),e&&e(null,a);}});},s.prototype._getUsrEvent=function(e){this._query("/usr/events/*(*)",function(t,n){if(t)e&&e(t);else{var a=[];n&&n.events&&(a=n.events),e&&e(null,a);}});},s.prototype._getUsrDefinedStates=function(e){this._query("/usr/addon-states/system-addon-user-defined-states/*(*)",function(t,n){if(t)e&&e(t);else{var a=[];n&&n["system-addon-user-defined-states"]&&(a=n["system-addon-user-defined-states"]),e&&e(null,a);}});},s.prototype._query=function(e,t){this._doPropertyRequest("query",{query:e},function(e,n){e?t&&t(e):t&&t(null,n);});},s.prototype._query2=function(e,t){this._doPropertyRequest("query2",{query:e},function(e,n){e?t&&t(e):t&&t(null,n);});},s.prototype._doPropertyRequest=function(e,t,n){this._server._doJsonRequest("/property/"+e,t,function(e,t){e?n&&n(e):n&&n(null,t);});};var u=function u(e){this._server=e;};u.prototype._raise=function(e,t){e?e.name?this._doEventRequest("raise",e,t):t&&t(new Error("name invalid")):t&&t(new Error("params invalid"));},u.prototype._doEventRequest=function(e,t,n){t?void 0!==t.dsid&&null!=t.dsid||t.name?this._server._doJsonRequest("/event/"+e,t,function(e,t){e?n&&n(e):n&&n(null,t);}):n&&n(new Error("no dsid or name")):n&&n(new Error("params invalid"));};var l=function l(e,t,n){var l=require("x.logger.js");this._logger=l?l.getLogger("xnm.aio.digitalstrom.Server"):{log:function log(){}},this.ip=e,this.port=t,t||(this.port=8080),this.applicationToken=n,this.sessionToken=null,this._getSessionTokenCBs=[],this._system=new a(this),this._apartment=new r(this),this._zone=new o(this),this._device=new i(this),this._property=new s(this),this._event=new u(this);};return l.HEAT_CONTROL_MODE=["off","pid_control","zone_follower","fixed_value","manual"],l.HEAT_OP_MODE=["off","comfort","economy","not_used","night","holiday","cooling","cooling_off"],l.prototype._doRequest=function(e,t,n){if(e||(e="/"),t||(t={}),this.sessionToken&&(t.token=this.sessionToken),t)for(var a in e+="?",t)e+=a+"="+encodeURI(t[a])+"&";"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var r={host:this.ip,port:this.port,path:e,method:"GET",headers:{"Content-Type":'text/html; charset="UTF-8"',"Content-Length":0,Connection:"close",rejectUnauthorized:!1,requestCert:!0}},o=this;this._logger.log("trace","do https request:"+JSON.stringify(r));var i=require("https").request(r,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){o._logger.log("trace","receive https response:"+t+" with code:"+e.statusCode),n&&n(null,t,e.statusCode),n=null;});});i.on("error",function(e){o._logger.log("warn","do https request error:"+e.message),n&&n(e),n=null;}),i.setTimeout(1e4,function(){o._logger.log("warn","do https request timeout");var e=new Error("timeout");e.reason="timeout",n&&n(e),n=null;}),i.end();},l.prototype._doJsonRequest=function(e,t,n){var a=this,r=e;r||(r="/"),r="/json"+r,this._doRequest(r,t,function(r,o,i){if(r)n&&n(r);else if(403==i)a.getSessionToken(function(r){r?n&&n(r):a._doJsonRequest(e,t,n);});else try{var s=JSON.parse(o);if(!s.ok)return void(n&&n(new Error("json response error:"+s.message)));n&&n(null,s.result);}catch(e){n&&n(e);}});},l.prototype._getReachableScenes=function(e,t){var n=null,a=0,r=this,o=function o(i,s){!i&&s&&(n||(n={}),n[e[a].zoneID+"."+e[a].groupID]=s),++a>=e.length?t&&t(null,n):r._zone._getReachableScenes(e[a].zoneID,e[a].groupID,o);};this._zone._getReachableScenes(e[a].zoneID,e[a].groupID,o);},l.prototype.getSessionToken=function(e){if(this.applicationToken){var t=this._getSessionTokenCBs.length;if(e&&-1==this._getSessionTokenCBs.indexOf(e)&&this._getSessionTokenCBs.push(e),0==t){var n=this;this._system._loginApplication(this.applicationToken,function(t,a){if(t)e&&e(t);else{n.sessionToken=a;var r=n._getSessionTokenCBs;n._getSessionTokenCBs=[];for(var o=0;o<r.length;o++)r[o](null,a);}});}}else e&&e(new Error("applicationToken is empty"));},l.prototype.getDevices=function(t){var n=function n(e,t,_n){if(!_n)return null;var a=_n[e+"."+t];if(!a||!a.userSceneNames)return null;for(var r=null,o=0;o<a.userSceneNames.length;o++){var i=a.userSceneNames[o];i&&i.sceneNr&&i.sceneName&&(r||(r={}),r[i.sceneNr]=i.sceneName);}return r;},a=function a(e,t,n){if(!n)return null;var a=n[e+"."+t];return a?a.reachableScenes:null;},r=function r(e,t){if(!t||!t.zones)return null;for(var n=0;n<t.zones.length;n++){var a=t.zones[n];if(a&&a.id==e)return a.values;}return null;},o=function o(e,t){if(!t||!t.zones)return null;for(var n=0;n<t.zones.length;n++){var a=t.zones[n];if(a&&a.id==e&&0!=a.IsConfigured){var r=[];for(var o in a)"ControlMode"!=o&&"OperationMode"!=o&&"TemperatureValue"!=o&&"NominalValue"!=o&&"ControlValue"!=o||r.push(o);return r;}}return null;},i=this,s={apartment:null};this._apartment._getName(function(u,l){if(u)t&&t(u);else{l||(l="Apartment"),s.apartment={type:"apartment",name:l,meters:[],devices:[],zones:[],events:[],uds:[]};var p=0,c=function c(e){p++,e?(t&&t(e),t=null):4==p&&(t&&t(null,s),t=null);};i._apartment._getTemperatureControlStatus(function(t,u){i._apartment._getSensorValues(function(t,l){!t&&l&&l.outdoor&&(s.apartment.outdoor=l.outdoor),i._apartment._getStructure(function(t,p){if(t)c(t);else{var d=[];if(p&&p.apartment&&p.apartment.zones)for(var f=0;f<p.apartment.zones.length;f++)for(var m=p.apartment.zones[f],v=0;v<m.groups.length;v++){var g=m.groups[v];0!=g.id&&g.devices.length>0&&d.push({zoneID:m.id,groupID:g.id});}i._getReachableScenes(d,function(t,i){if(t)c(t);else{if(p&&p.apartment&&p.apartment.zones)for(var d=0;d<p.apartment.zones.length;d++){var f=p.apartment.zones[d],m={type:"zone",zoneID:f.id,name:f.name,groups:[]},v=r(f.id,l);v&&(m.sensorValues=v);var g=o(f.id,u);if(g&&(m.heating=g),0==f.id){f.name||(m.name="All Devices");for(var y=0;y<f.devices.length;y++){var h=f.devices[y],_={type:"device",name:h.name,dsid:h.id,zoneID:h.zoneID,groups:h.groups};s.apartment.devices.push(_);}}for(var S=0;S<f.groups.length;S++){var w=f.groups[S];if(0!=w.id&&w.applicationType&&w.devices.length>0){var N={type:"group",name:e[w.id],zoneID:f.id,groupID:w.id,applicationType:w.applicationType,reachableScenes:a(f.id,w.id,i),sceneNames:n(f.id,w.id,i)};m.groups.push(N);}}s.apartment.zones.push(m);}c();}});}});});}),i._property._getMeters(function(e,t){if(e)c(e);else{if(t)for(var n=0;n<t.length;n++)if(t[n].dSID){var a={type:"meter",name:t[n].name,dsid:t[n].dSID};s.apartment.meters.push(a);}c();}}),i._property._getUsrEvent(function(e,t){if(e)c(e);else{if(t)for(var n=0;n<t.length;n++)if(t[n].id){var a={type:"event",name:t[n].name,id:t[n].id};s.apartment.events.push(a);}c();}}),i._property._getUsrDefinedStates(function(e,t){if(e)c(e);else{if(t)for(var n=0;n<t.length;n++)if(t[n].name){var a={type:"uds",name:t[n].displayName,id:t[n].name,setName:t[n].setName,resetName:t[n].resetName};s.apartment.uds.push(a);}c();}});}});},l.prototype.registApplication=function(e,t,n){var a=this;this._system._requestApplicationToken("mediola",function(r,o){r?n&&n(r):a._system._login(e,t,function(e,t){e?n&&n(e):a._system._enableToken(o,t,function(e){n&&n(e,o);});});});},l.prototype.executeCommand=function(e,t,n){var a;if(e&&e.type){if(t&&t.value)switch(e.type){case"apartment":if("callScene"===t.value){if(a=parseInt(t.ext),isNaN(a)||a<0||a>128)return void(n&&n(new Error("scene number invalid")));this._apartment._callScene({sceneNumber:a},n);}else n&&n(new Error("unknown command:"+t.value));break;case"zone":if("callScene"===t.value){if(a=parseInt(t.ext),isNaN(a)||a<0||a>128)return void(n&&n(new Error("scene number invalid")));this._zone._callScene(e.zoneID,{sceneNumber:a},n);}else n&&n(new Error("unknown command:"+t.value));break;case"group":if("callScene"===t.value){if(a=parseInt(t.ext),isNaN(a)||a<0||a>128)return void(n&&n(new Error("scene number invalid")));this._zone._callScene(e.zoneID,{groupID:e.groupID,sceneNumber:a},n);}else n&&n(new Error("unknown command:"+t.value));break;case"device":switch(t.value){case"callScene":if(a=parseInt(t.ext),isNaN(a)||a<0||a>128)return void(n&&n(new Error("scene number invalid")));this._device._callScene({dsid:e.dsid,sceneNumber:a},n);break;case"turnOn":this._device._turnOn({dsid:e.dsid},n);break;case"turnOff":this._device._turnOff({dsid:e.dsid},n);break;case"decreaseValue":this._device._decreaseValue({dsid:e.dsid},n);break;case"increaseValue":this._device._increaseValue({dsid:e.dsid},n);break;default:n&&n(new Error("unknown command:"+t.value));}break;case"event":if("run"===t.value){if(!e.id)return void(n&&n(new Error("device id invalid")));this._event._raise({name:"highlevelevent",parameter:"id="+e.id},n);}else n&&n(new Error("unknown command:"+t.value));break;default:n&&n(new Error("unknown device type:"+e.type));}else n&&n(new Error("command format invalid"));}else n&&n(new Error("device format invalid"));},l.prototype.executeCommandCreator=function(e,a,r){if(a&&a.value){if(e&&e.type){var o={value:"callScene",ext:0},i=null;if("turnOn"==a.value||"turnOff"==a.value||"increaseValue"==a.value||"decreaseValue"==a.value||"run"==a.value)o.value=a.value;else if("callScene"==a.value){if(i=parseInt(a.ext),isNaN(i))return void(r&&r(new Error("callScene value invalid")));o.ext=i;}else if("doActivity"==a.value){if(!a.ext)return void(r&&r(new Error("doActivity value invalid")));var s=!1;for(var u in t)if(a.ext==t[u]){i=parseInt(u),s=!0;break;}if(!s)for(var u in n)if(a.ext==n[u]){i=parseInt(u),s=!0;break;}if(!s)return void(r&&r(new Error("unknown doActivity:"+a.ext)));o.ext=i;}else{if("doScene"!=a.value.substr(0,7))return void(r&&r(new Error("unknown command:"+a.value)));if(i=parseInt(a.value.substr(7)),isNaN(i))return void(r&&r(new Error("doScene value invalid")));o.ext=i;}var l=null;switch(e.type){case"apartment":case"zone":case"group":case"device":case"event":l=e;break;default:r&&r(new Error("unknown device type:"+e.type));}this.executeCommand(l,o,function(e){r&&r(e);});}else r&&r(new Error("device json invalid"));}else r&&r(new Error("command json invalid"));},l.prototype.getStatesCreator=function(e,t,n){var a=function a(e){return e.replace(/&apos;/g,"'").replace(/&quot;/g,'"').replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&");};if(t){if(0!=t.length){if(t){var r=[],o={},i={},s={},u={},p=this;this._property._getUsrDefinedStates(function(e,c){var d,f;if(!e&&c)for(d=0;d<c.length;d++)(f=c[d]).name&&(u[f.name]={stateTxt:1==f.value?a(f.setName):a(f.resetName),stateF:1==f.value?parseFloat(f.setName):parseFloat(f.resetName)});p._property._getMeters(function(e,a){var c,d,f;if(!e&&a)for(c=0;c<a.length;c++)(f=a[c]).dSID&&(o[f.dSID]=f);p._apartment._getSensorValues(function(e,a){if(!e&&a&&(a.outdoor&&(s=a.outdoor),a.zones))for(c=0;c<a.zones.length;c++){var m=a.zones[c];if(i[m.id]={},m.values)for(d=0;d<m.values.length;d++)for(var v in m.values[d])i[m.id][v]=m.values[d][v];}p._apartment._getTemperatureControlStatus(function(e,a){if(!e&&a&&a.zones)for(c=0;c<a.zones.length;c++){var p=a.zones[c];i[p.id]||(i[p.id]={}),void 0!==p.ControlMode&&null!=p.ControlMode&&(i[p.id].ControlMode=l.HEAT_CONTROL_MODE[p.ControlMode]),void 0!==p.OperationMode&&null!=p.OperationMode&&(i[p.id].OperationMode=l.HEAT_OP_MODE[p.OperationMode]),void 0!==p.TemperatureValue&&null!=p.TemperatureValue&&(i[p.id].TemperatureValue=p.TemperatureValue),void 0!==p.NominalValue&&null!=p.NominalValue&&(i[p.id].NominalValue=p.NominalValue),void 0!==p.ControlValue&&null!=p.ControlValue&&(i[p.id].ControlValue=p.ControlValue);}var d;for(c=0;c<t.length;c++)if(t[c]){var m=t[c].id,v=t[c].device,g=t[c].status;m&&g&&g.value&&v&&v.type&&("meter"==v.type&&v.dsid?(f=o[v.dsid])&&(d=f[g.value]):"uds"==v.type&&v.id?(f=u[v.id])&&(d=f[g.value]):"apartment"==v.type?(f=s[g.value])&&(d=f.value):"zone"==v.type&&v.zoneID&&(f=i[v.zoneID])&&(d=f[g.value]),void 0!==d&&null!=d||(d="?"),r.push({id:m,status:d}));}n&&n(null,r);});});});});}else n&&n(new Error("deviceList is null"));}else n&&n(null,[]);}else n&&n(new Error("deviceList is null"));},l.prototype.toJSON=function(){return{sys:"digitalstrom",ip:this.ip,port:this.port,token:this.applicationToken};},l.prototype.equalsTo=function(e){return!!e&&e instanceof l&&this.ip==e.ip&&this.port==e.port&&this.applicationToken==e.applicationToken;},l.GROUP_NAMES=e,l.GROUP_SCENE=t,l.NON_GROUP_SCENE=n,l.GROUP_DEFAULT_SCENES={1:[0,5,17,18,19,40],2:[0,5,15,17,18,19],3:[0,1,2,4,5],4:[0,5,17,18,19],5:[0,5,17,18,19],9:[6,7,8,10,11],10:[0,5,17,18,19,33,35,36,37],11:[0,5,17,18,19,33,35,36,37],12:[0,5,17,18,19,33,35,36,37],48:[0,1,2,4,5,6,7,8,10,11],64:[0,5,17,18,19,33,35,36,37]},l.GROUP_SPECIAL_SCENE_NAME={1:{0:"Off",40:"Fade Off"},2:{0:"Up",5:"Down"},3:{0:"Heating Off",1:"Heating Comfort",2:"Heating Economy",3:"Heating Not Used",4:"Heating Night"},4:{0:"Off"},5:{0:"Off"},9:{0:"Heating Off",1:"Heating Comfort",2:"Heating Economy",3:"Heating Not Used",4:"Heating Night",5:"Heating Holiday"},10:{0:"Off",5:"Level 1",17:"Level 2",18:"Level 3",19:"Level 4",33:"Automatic (air flow intensity)",35:"Auto (louver swing mode)",36:"Boost",37:"Noise Reduction"},48:{0:"Heating Off",1:"Heating Comfort",2:"Heating Economy",3:"Heating Not Used",4:"Heating Night",5:"Heating Holiday",6:"Cooling Off",7:"Cooling Comfort",8:"Cooling Economy",9:"Cooling Not Used",10:"Cooling Night",11:"Cooling Holiday"}},l;}(),xnm.aio.digitalstrom.DM=function(){var e=function e(_e,t){this.code=_e,this.message=t,this.stack=new Error().stack;};return(e.prototype=new Error()).name="DigitalStromDMError",e.prototype.code=0,e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"digitalstrom",getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"digitalSTROM"}];},getGatewayDeviceType:function getGatewayDeviceType(){return[];},createGateway:function createGateway(t,n,a){var r=e,o=e.ERROR_CODE;t?t.ip?a(null,t):a(new r(o.INVALID,"ip is invalid")):a(new r(o.INVALID,"info is invalid"));},updateGateway:function updateGateway(t,n,a,r){var o=e,i=e.ERROR_CODE;n?n.ip?n.username?n.password?r(null,n):r(new o(i.INVALID,"password is invalid")):r(new o(i.INVALID,"username is invalid")):r(new o(i.INVALID,"ip is invalid")):r(new o(i.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,n){n();},createDevice:function createDevice(t,n,a){var r=e,o=e.ERROR_CODE;if(t){if(t.gateway){if(t.type){if(n.data&&n.data.gateways&&0!==n.data.gateways.length){var i,s,u=n.data.gateways;for(i=0;i<u.length;i++)if(u[i].index===t.gateway){s=u[i];break;}s?a(null,t):a(new r(o.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else a(new r(o.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else a(new r(o.INVALID,"type is invalid"));}else a(new r(o.INVALID,"gateway is invalid"));}else a(new r(o.INVALID,"info is invalid"));},updateDevice:function updateDevice(t,n,a){var r=e,o=e.ERROR_CODE;if(t){if(t.gateway){if(t.type){if(n.data&&n.data.gateways&&0!==n.data.gateways.length){var i,s,u=n.data.gateways;for(i=0;i<u.length;i++)if(u[i].index===t.gateway){s=u[i];break;}s?a(null,t):a(new r(o.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else a(new r(o.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else a(new r(o.INVALID,"type is invalid"));}else a(new r(o.INVALID,"gateway is invalid"));}else a(new r(o.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,n){n();},applyUIFilter:function applyUIFilter(e,t){var n=this,a=function a(e,t){if("*"==e)return!0;for(var n=!1,a=0;a<e.length;a++)if(e[a]==t){n=!0;break;}return n;},r=function r(e,t){var r=[],o=null,i=n.getCommandStatusMap(e);return i&&(o=function(e,t,n){var r=[];switch(n.catagory){case"command":e.command&&e.command.forEach(function(e){if(a(n.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(a(n.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}});}return r;}(i,0,t),r=r.concat(o)),r;};if(!e||null==e.type||void 0===e.type)return null;var o=JSON.parse(JSON.stringify(e)),i=null;switch(t.catagory){case"command":i=r(e,t),o.command=i;break;case"status":i=r(e,t),o.status=i;break;default:return null;}return i&&0!=i.length?o:null;},getCommandStatusMap:function getCommandStatusMap(e){var t,n=function n(){var e=xnm.aio.digitalstrom.Server.GROUP_SCENE,t=[];for(var n in e)e[n]&&t.push(e[n]);return t;},a={command:[],status:[]};if(!e||!e.type)return null;if("event"==e.type)return a.command=[{type:"enum",name:"run",ref:{value:"run"}}],a;if("uds"==e.type)return a.status=[{type:"string",name:"state (string)",ref:{value:"stateTxt"}},{type:"float",name:"state (float)",ref:{value:"stateF"}}],a;switch(e.type){case"apartment":a.command=[{type:"enum",name:"Absent",ref:{value:"doScene72"}},{type:"enum",name:"Present",ref:{value:"doScene71"}},{type:"enum",name:"Door Bell",ref:{value:"doScene73"}},{type:"enum",name:"Rain",ref:{value:"doScene88"}},{type:"enum",name:"No Rain",ref:{value:"doScene89"}},{type:"enum",name:"Wind",ref:{value:"doScene86"}},{type:"enum",name:"No Wind",ref:{value:"doScene87"}},{type:"enum",name:"Hail",ref:{value:"doScene90"}},{type:"enum",name:"No Wind",ref:{value:"doScene91"}},{type:"enum",name:"Panic",ref:{value:"doScene65"}},{type:"enum",name:"Fire",ref:{value:"doScene76"}},{type:"enum",name:"Alarm 1",ref:{value:"doScene74"}},{type:"enum",name:"Alarm 2",ref:{value:"doScene83"}},{type:"enum",name:"Alarm 3",ref:{value:"doScene84"}},{type:"enum",name:"Alarm 4",ref:{value:"doScene85"}}];break;case"zone":a.command=[{type:"enum",name:"Standby",ref:{value:"doScene67"}},{type:"enum",name:"Deep off",ref:{value:"doScene68"}},{type:"enum",name:"Sleeping",ref:{value:"doScene69"}},{type:"enum",name:"Wake up",ref:{value:"doScene70"}}];break;case"group":var r=xnm.aio.digitalstrom.Server.GROUP_DEFAULT_SCENES[e.applicationType];if(r||(r=[]),e.reachableScenes)for(var o=0;o<e.reachableScenes.length;o++)-1==r.indexOf(e.reachableScenes[o])&&r.push(e.reachableScenes[o]);if(e.sceneNames)for(var i in e.sceneNames)-1==r.indexOf(parseInt(i))&&r.push(parseInt(i));for(var s=0;s<r.length;s++){var u=r[s],l=null;if(e.sceneNames&&(l=e.sceneNames[u]),!l){var p=xnm.aio.digitalstrom.Server.GROUP_SPECIAL_SCENE_NAME[e.applicationType];p&&(l=p[u]);}l||(l=xnm.aio.digitalstrom.Server.GROUP_SCENE[u]),l&&a.command.push({type:"enum",name:l,ref:{value:"doScene"+u}});}break;case"device":if(e.groups)for(var c=[],d=0;d<e.groups.length;d++){var f=[];switch(e.groups[d]){case 1:f=[{type:"enum",name:"on",ref:{value:"turnOn"}},{type:"enum",name:"off",ref:{value:"turnOff"}},{type:"enum",name:"up",ref:{value:"increaseValue"}},{type:"enum",name:"down",ref:{value:"decreaseValue"}}];break;case 2:f=[{type:"enum",name:"move down",ref:{value:"turnOn"}},{type:"enum",name:"move up",ref:{value:"turnOff"}},{type:"enum",name:"step down",ref:{value:"increaseValue"}},{type:"enum",name:"step up",ref:{value:"decreaseValue"}}];break;case 4:case 5:f=[{type:"enum",name:"on",ref:{value:"turnOn"}},{type:"enum",name:"off",ref:{value:"turnOff"}}];}for(var m=0;m<f.length;m++){var v=f[m];-1==c.indexOf(v.ref.value)&&(a.command.push(v),c.push(v.ref.value));}}}switch(e.type){case"apartment":case"zone":t=(t=n()).concat(function(){var e=xnm.aio.digitalstrom.Server.NON_GROUP_SCENE,t=[];for(var n in e)e[n]&&t.push(e[n]);return t;}()),a.command.push({type:"enum",name:"do activity",ref:{value:"doActivity",ext:"%e",extMeta:t}});break;case"group":case"device":t=n(),a.command.push({type:"enum",name:"do activity",ref:{value:"doActivity",ext:"%e",extMeta:t}});}a.command.push({type:"int",name:"call scene",ref:{value:"callScene",ext:"%d",extMeta:"0-127"}});var g=null;switch(e.type){case"apartment":if(e.outdoor)for(var i in e.outdoor)switch(i){case"temperature":a.status.push({type:"float",name:"temperature",ref:{value:"temperature"}});break;case"humidity":a.status.push({type:"float",name:"humidity",ref:{value:"humidity"}});break;case"windspeed":a.status.push({type:"float",name:"wind speed",ref:{value:"windspeed"}});break;case"winddirection":a.status.push({type:"float",name:"wind direction",ref:{value:"winddirection"}});break;case"gustspeed":a.status.push({type:"float",name:"gust speed",ref:{value:"gustspeed"}});break;case"gustdirection":a.status.push({type:"float",name:"gust direction",ref:{value:"gustdirection"}});break;case"precipitation":a.status.push({type:"float",name:"precipitation",ref:{value:"precipitation"}});break;case"airpressure":a.status.push({type:"float",name:"air pressure",ref:{value:"airpressure"}});}break;case"zone":var y=!1;if(e.sensorValues)for(o=0;o<e.sensorValues.length;o++)(g=e.sensorValues[o])&&(void 0!==g.TemperatureValue&&null!=g.TemperatureValue&&(y=!0,a.status.push({type:"float",name:"temperature",ref:{value:"TemperatureValue"}})),void 0!==g.HumidityValue&&null!=g.HumidityValue&&a.status.push({type:"float",name:"humidity",ref:{value:"HumidityValue"}}),void 0!==g.CO2ConcentrationValue&&null!=g.CO2ConcentrationValue&&a.status.push({type:"float",name:"co2",ref:{value:"CO2ConcentrationValue"}}),void 0!==g.BrightnessValue&&null!=g.BrightnessValue&&a.status.push({type:"float",name:"brightness",ref:{value:"BrightnessValue"}}));if(e.heating)for(o=0;o<e.heating.length;o++)switch(g=e.heating[o]){case"ControlMode":a.status.push({type:"enum",name:"control mode",ref:{value:"ControlMode",options:["off","pid_control","zone_follower","fixed_value","manual"]}});break;case"OperationMode":a.status.push({type:"enum",name:"operation mode",ref:{value:"OperationMode",options:["off","comfort","economy","not_used","night","holiday","cooling","cooling_off"]}});break;case"TemperatureValue":y||a.status.push({type:"float",name:"temperature",ref:{value:"TemperatureValue"}});break;case"NominalValue":a.status.push({type:"float",name:"target temperature",ref:{value:"NominalValue"}});break;case"ControlValue":a.status.push({type:"float",name:"control value",ref:{value:"ControlValue"}});}break;case"meter":a.status.push({type:"float",name:"power",ref:{value:"powerConsumption",unit:"W"}}),a.status.push({type:"float",name:"energy meter",ref:{value:"energyMeterValue",unit:"Wh"}});}return a;}};}(),xnm.aio.digitalstrom.Handler=function(){var e=function e(){};return e.prototype.Server=xnm.aio.digitalstrom.Server,e.prototype.devicemanager=xnm.aio.digitalstrom.DM,e.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"digitalstrom");},e.prototype.resolveGateway=function(e){return e&&e.ip&&e.token?new this.Server(e.ip,e.port,e.token):null;},e.prototype.getDeviceCommands=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),a=n?n.command:[];t&&t(null,a);},e.prototype.getDeviceStatus=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),a=n?n.status:[];t&&t(null,a);},e.prototype.doCommand=function(e,t,n,a){var r=this.resolveGateway(e);r?r.executeCommandCreator(t,n,function(e){a&&a(e);}):a&&a(new Error("gateway json format invalid"));},e.prototype.doStatus=function(e,t,n,a,r){var o=this.resolveGateway(t);if(o){var i=[{id:e,device:n,status:a}];o.getStatesCreator(null,i,function(e,t){e?r&&r(e):r&&r(null,t[0]);});}else r&&r(new Error("gateway json format invalid"));},e.prototype.getDeviceList=function(e,t){var n=this.resolveGateway(e);n?n.getDevices(function(e,n){t&&t(e,n);}):t&&t(new Error("gateway json format invalid"));},e.prototype.discover=function(e,t){var n=require("x.mdns.js");n.clearRecordBuffer(),n.discoverServiceWithTimeout("_http._tcp.local",e,function(e,n){if(e)t&&t(e);else{for(var a=[],r=0;r<n.length;r++){var o=n[r];if(o.target&&o.ip&&o.ip.length>0&&"dss.local"==o.target.toLowerCase()){var i=new xnm.aio.digitalstrom.Server(o.ip[0],8080);a.push(i);}}t&&t(e,a);}});},e.prototype.registApplication=function(e,t,n,a){if(!e||!e.ip)return null;new this.Server(e.ip,e.port).registApplication(t,n,function(e,t){a&&a(e,t);});},e;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.digitalstrom.Handler());