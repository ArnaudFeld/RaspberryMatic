var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.digitalstrom=xnm.aio.digitalstrom||{};
xnm.aio.digitalstrom.Server=function(){var h={0:"Broadcast",1:"Light",2:"Shading",3:"Heating",4:"Audio",5:"Video",6:"Security",7:"Access",8:"Joker",9:"Cooling",10:"Room ventilation",11:"Window",12:"Recirculation",48:"Temperature control",64:"Apartment ventilation"},d={0:"Preset 0",1:"Area 1 Off",2:"Area 2 Off",3:"Area 3 Off",4:"Area 4 Off",5:"Preset 1",6:"Area 1 On",7:"Area 2 On",8:"Area 3 On",9:"Area 4 On",10:"Area Stepping Continue",11:"Decrement",12:"Increment",13:"Minimum",14:"Maximum",15:"Stop",
17:"Preset 2",18:"Preset 3",19:"Preset 4",20:"Preset 12",21:"Preset 13",22:"Preset 14",23:"Preset 22",24:"Preset 23",25:"Preset 24",26:"Preset 32",27:"Preset 33",28:"Preset 34",29:"Preset 42",30:"Preset 43",31:"Preset 44",32:"Preset 10",33:"Preset 11",34:"Preset 20",35:"Preset 21",36:"Preset 30",37:"Preset 31",38:"Preset 40",39:"Preset 41",40:"Auto Off",41:"Impulse",42:"Area 1 Decrement",43:"Area 1 Increment",44:"Area 2 Decrement",45:"Area 2 Increment",46:"Area 3 Decrement",47:"Area 3 Increment",
48:"Area 4 Decrement",49:"Area 4 Increment",50:"Device Off",51:"Device On",52:"Area 1 Stop",53:"Area 2 Stop",54:"Area 3 Stop",55:"Area 4 Stop",56:"Sun protection"},f={64:"Auto Standby",65:"Panic",67:"Standby",68:"Deep Off",69:"Sleeping",70:"Wakeup",71:"Present",72:"Absent",73:"Door Bell",74:"Alarm",75:"Zone Active",76:"Fire",77:"Smoke",78:"Water",79:"Gas",80:"Bell 2",81:"Bell 3",82:"Bell 4",83:"Alarm 2",84:"Alarm 3",85:"Alarm 4",86:"Wind",87:"No Wind",88:"Rain",89:"No Rain",90:"Hail",91:"No Hail"},
g=function(b){this._server=b};g.prototype._requestApplicationToken=function(b,a){this._doSystemRequest("requestApplicationToken",{applicationName:b},function(c,b){c?a&&a(c):a&&a(null,b.applicationToken)})};g.prototype._login=function(b,a,c){this._doSystemRequest("login",{user:b,password:a},function(a,b){a?c&&c(a):c&&c(null,b.token)})};g.prototype._enableToken=function(b,a,c){this._doSystemRequest("enableToken",{applicationToken:b,token:a},function(a){c&&c(a)})};g.prototype._loginApplication=function(b,
a){b?this._doSystemRequest("loginApplication",{loginToken:b},function(c,b){c?a&&a(c):a&&a(null,b.token)}):a&&a(Error("loginToken is empty"))};g.prototype._doSystemRequest=function(b,a,c){this._server._doJsonRequest("/system/"+b,a,function(a,b){a?c&&c(a):c&&c(null,b)})};var e=function(b){this._server=b};e.prototype._getName=function(b){this._doApartmentRequest("getName",null,function(a,c){a?b&&b(a):c?b&&b(null,c.name):b&&b(Error("apartment getName result invalid"))})};e.prototype._getSensorValues=
function(b){this._doApartmentRequest("getSensorValues",null,function(a,c){a?b&&b(a):c?b&&b(null,c):b&&b(Error("apartment getSensorValues result invalid"))})};e.prototype._getTemperatureControlStatus=function(b){this._doApartmentRequest("getTemperatureControlStatus",null,function(a,c){a?b&&b(a):c?b&&b(null,c):b&&b(Error("apartment getTemperatureControlStatus result invalid"))})};e.prototype._getStructure=function(b){this._doApartmentRequest("getStructure",null,function(a,c){a?b&&b(a):b&&b(null,c)})};
e.prototype._callScene=function(b,a){b?"undefined"==typeof b.sceneNumber||null==b.sceneNumber?a&&a(Error("sceneNumber invalid")):this._doApartmentRequest("callScene",b,function(c,b){c?a&&a(c):a&&a(null,b)}):a&&a(Error("params invalid"))};e.prototype._doApartmentRequest=function(b,a,c){this._server._doJsonRequest("/apartment/"+b,a,function(a,b){a?c&&c(a):c&&c(null,b)})};var n=function(b){this._server=b};n.prototype._getReachableScenes=function(b,a,c){"undefined"==typeof b||null==b?c&&c(Error("id invalid")):
"undefined"==typeof a||null==a?c&&c(Error("groupID invalid")):this._doZoneRequest("getReachableScenes",{id:b,groupID:a},c)};n.prototype._callScene=function(b,a,c){a?"undefined"==typeof a.sceneNumber||null==a.sceneNumber?c&&c(Error("sceneNumber invalid")):"undefined"==typeof b||null==b?c&&c(Error("id invalid")):(a.id=b,this._doZoneRequest("callScene",a,c)):c&&c(Error("params invalid"))};n.prototype._doZoneRequest=function(b,a,c){this._server._doJsonRequest("/zone/"+b,a,function(a,b){a?c&&c(a):c&&c(null,
b)})};var k=function(b){this._server=b};k.prototype._turnOn=function(b,a){this._doDeviceRequest("turnOn",b,a)};k.prototype._turnOff=function(b,a){this._doDeviceRequest("turnOff",b,a)};k.prototype._increaseValue=function(b,a){this._doDeviceRequest("increaseValue",b,a)};k.prototype._decreaseValue=function(b,a){this._doDeviceRequest("decreaseValue",b,a)};k.prototype._callScene=function(b,a){b?"undefined"==typeof b.sceneNumber||null==b.sceneNumber?a&&a(Error("sceneNumber invalid")):this._doDeviceRequest("callScene",
b,a):a&&a(Error("params invalid"))};k.prototype._doDeviceRequest=function(b,a,c){a?"undefined"!=typeof a.dsid&&null!=a.dsid||a.name?this._server._doJsonRequest("/device/"+b,a,function(a,b){a?c&&c(a):c&&c(null,b)}):c&&c(Error("no dsid or name")):c&&c(Error("params invalid"))};var m=function(b){this._server=b};m.prototype._getMeters=function(b){this._query("/apartment/dSMeters/*(*)",function(a,c){if(a)b&&b(a);else{var d=[];c&&c.dSMeters&&(d=c.dSMeters);b&&b(null,d)}})};m.prototype._getUsrEvent=function(b){this._query("/usr/events/*(*)",
function(a,c){if(a)b&&b(a);else{var d=[];c&&c.events&&(d=c.events);b&&b(null,d)}})};m.prototype._getUsrDefinedStates=function(b){this._query("/usr/addon-states/system-addon-user-defined-states/*(*)",function(a,c){if(a)b&&b(a);else{var d=[];c&&c["system-addon-user-defined-states"]&&(d=c["system-addon-user-defined-states"]);b&&b(null,d)}})};m.prototype._query=function(b,a){this._doPropertyRequest("query",{query:b},function(c,b){c?a&&a(c):a&&a(null,b)})};m.prototype._query2=function(b,a){this._doPropertyRequest("query2",
{query:b},function(c,b){c?a&&a(c):a&&a(null,b)})};m.prototype._doPropertyRequest=function(b,a,c){this._server._doJsonRequest("/property/"+b,a,function(a,b){a?c&&c(a):c&&c(null,b)})};var l=function(b){this._server=b};l.prototype._raise=function(b,a){b?b.name?this._doEventRequest("raise",b,a):a&&a(Error("name invalid")):a&&a(Error("params invalid"))};l.prototype._doEventRequest=function(b,a,c){a?"undefined"!=typeof a.dsid&&null!=a.dsid||a.name?this._server._doJsonRequest("/event/"+b,a,function(a,b){a?
c&&c(a):c&&c(null,b)}):c&&c(Error("no dsid or name")):c&&c(Error("params invalid"))};var p=function(b,a,c){var d=require("x.logger.js");this._logger=d?d.getLogger("xnm.aio.digitalstrom.Server"):{log:function(){}};this.ip=b;this.port=a;a||(this.port=8080);this.applicationToken=c;this.sessionToken=null;this._getSessionTokenCBs=[];this._system=new g(this);this._apartment=new e(this);this._zone=new n(this);this._device=new k(this);this._property=new m(this);this._event=new l(this)};p.HEAT_CONTROL_MODE=
["off","pid_control","zone_follower","fixed_value","manual"];p.HEAT_OP_MODE="off comfort economy not_used night holiday cooling cooling_off".split(" ");p.prototype._doRequest=function(b,a,c){b||(b="/");a||(a={});this.sessionToken&&(a.token=this.sessionToken);if(a){b+="?";for(var d in a)b+=d+"="+encodeURI(a[d])+"&"}"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");b={host:this.ip,port:this.port,path:b,method:"GET",headers:{"Content-Type":'text/html; charset="UTF-8"',
"Content-Length":0,Connection:"close",rejectUnauthorized:!1,requestCert:!0}};var e=this;this._logger.log("trace","do https request:"+JSON.stringify(b));b=require("https").request(b,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){e._logger.log("trace","receive https response:"+b+" with code:"+a.statusCode);c&&c(null,b,a.statusCode);c=null})});b.on("error",function(a){e._logger.log("warn","do https request error:"+a.message);c&&c(a);c=null});b.setTimeout(1E4,
function(){e._logger.log("warn","do https request timeout");var a=Error("timeout");a.reason="timeout";c&&c(a);c=null});b.end()};p.prototype._doJsonRequest=function(b,a,c){var d=this,e=b;e||(e="/");this._doRequest("/json"+e,a,function(e,f,g){if(e)c&&c(e);else if(403==g)d.getSessionToken(function(e){e?c&&c(e):d._doJsonRequest(b,a,c)});else try{var n=JSON.parse(f);n.ok?c&&c(null,n.result):c&&c(Error("json response error:"+n.message))}catch(p){c&&c(p)}})};p.prototype._getReachableScenes=function(b,a){var c=
null,d=0,e=this,f=function(g,n){!g&&n&&(c||(c={}),c[b[d].zoneID+"."+b[d].groupID]=n);d++;d>=b.length?a&&a(null,c):e._zone._getReachableScenes(b[d].zoneID,b[d].groupID,f)};this._zone._getReachableScenes(b[d].zoneID,b[d].groupID,f)};p.prototype.getSessionToken=function(b){if(this.applicationToken){var a=this._getSessionTokenCBs.length;b&&-1==this._getSessionTokenCBs.indexOf(b)&&this._getSessionTokenCBs.push(b);if(0==a){var c=this;this._system._loginApplication(this.applicationToken,function(a,d){if(a)b&&
b(a);else{c.sessionToken=d;var e=c._getSessionTokenCBs;c._getSessionTokenCBs=[];for(var f=0;f<e.length;f++)e[f](null,d)}})}}else b&&b(Error("applicationToken is empty"))};p.prototype.getDevices=function(b){var a=this,c={apartment:null};this._apartment._getName(function(d,e){if(d)b&&b(d);else{e||(e="Apartment");c.apartment={type:"apartment",name:e,meters:[],devices:[],zones:[],events:[],uds:[]};var f=0,g=function(a){f++;a?(b&&b(a),b=null):4==f&&(b&&b(null,c),b=null)};a._apartment._getTemperatureControlStatus(function(b,
d){a._apartment._getSensorValues(function(b,e){!b&&e&&e.outdoor&&(c.apartment.outdoor=e.outdoor);a._apartment._getStructure(function(b,f){if(b)g(b);else{var n=[];if(f&&f.apartment&&f.apartment.zones)for(var p=0;p<f.apartment.zones.length;p++)for(var k=f.apartment.zones[p],m=0;m<k.groups.length;m++){var l=k.groups[m];0!=l.id&&0<l.devices.length&&n.push({zoneID:k.id,groupID:l.id})}a._getReachableScenes(n,function(a,b){if(a)g(a);else{if(f&&f.apartment&&f.apartment.zones)for(var n=0;n<f.apartment.zones.length;n++){var p=
f.apartment.zones[n],k={type:"zone",zoneID:p.id,name:p.name,groups:[]},m;a:{if(e&&e.zones)for(m=0;m<e.zones.length;m++){var l=e.zones[m];if(l&&l.id==p.id){m=l.values;break a}}m=null}m&&(k.sensorValues=m);a:{var l=p.id,v=d;if(v&&v.zones)for(var t=0;t<v.zones.length;t++)if((m=v.zones[t])&&m.id==l&&0!=m.IsConfigured){var l=[],u;for(u in m)"ControlMode"!=u&&"OperationMode"!=u&&"TemperatureValue"!=u&&"NominalValue"!=u&&"ControlValue"!=u||l.push(u);m=l;break a}m=null}m&&(k.heating=m);if(0==p.id)for(p.name||
(k.name="All Devices"),m=0;m<p.devices.length;m++)l=p.devices[m],c.apartment.devices.push({type:"device",name:l.name,dsid:l.id,zoneID:l.zoneID,groups:l.groups});for(m=0;m<p.groups.length;m++){var r=p.groups[m];if(0!=r.id&&r.applicationType&&0<r.devices.length){var l=h[r.id],v=p.id,t=r.id,A=r.applicationType,w;w=b?(w=b[p.id+"."+r.id])?w.reachableScenes:null:null;if(b)if((r=b[p.id+"."+r.id])&&r.userSceneNames){for(var x=null,y=0;y<r.userSceneNames.length;y++){var q=r.userSceneNames[y];q&&q.sceneNr&&
q.sceneName&&(x||(x={}),x[q.sceneNr]=q.sceneName)}r=x}else r=null;else r=null;k.groups.push({type:"group",name:l,zoneID:v,groupID:t,applicationType:A,reachableScenes:w,sceneNames:r})}}c.apartment.zones.push(k)}g()}})}})})});a._property._getMeters(function(a,b){if(a)g(a);else{if(b)for(var d=0;d<b.length;d++)b[d].dSID&&c.apartment.meters.push({type:"meter",name:b[d].name,dsid:b[d].dSID});g()}});a._property._getUsrEvent(function(a,b){if(a)g(a);else{if(b)for(var d=0;d<b.length;d++)b[d].id&&c.apartment.events.push({type:"event",
name:b[d].name,id:b[d].id});g()}});a._property._getUsrDefinedStates(function(a,b){if(a)g(a);else{if(b)for(var d=0;d<b.length;d++)b[d].name&&c.apartment.uds.push({type:"uds",name:b[d].displayName,id:b[d].name,setName:b[d].setName,resetName:b[d].resetName});g()}})}})};p.prototype.registApplication=function(b,a,c){var d=this;this._system._requestApplicationToken("mediola",function(e,f){e?c&&c(e):d._system._login(b,a,function(a,b){a?c&&c(a):d._system._enableToken(f,b,function(a){c&&c(a,f)})})})};p.prototype.executeCommand=
function(b,a,c){if(b&&b.type)if(a&&a.value)switch(b.type){case "apartment":switch(a.value){case "callScene":a=parseInt(a.ext);if(isNaN(a)||0>a||128<a){c&&c(Error("scene number invalid"));return}this._apartment._callScene({sceneNumber:a},c);break;default:c&&c(Error("unknown command:"+a.value))}break;case "zone":switch(a.value){case "callScene":a=parseInt(a.ext);if(isNaN(a)||0>a||128<a){c&&c(Error("scene number invalid"));return}this._zone._callScene(b.zoneID,{sceneNumber:a},c);break;default:c&&c(Error("unknown command:"+
a.value))}break;case "group":switch(a.value){case "callScene":a=parseInt(a.ext);if(isNaN(a)||0>a||128<a){c&&c(Error("scene number invalid"));return}this._zone._callScene(b.zoneID,{groupID:b.groupID,sceneNumber:a},c);break;default:c&&c(Error("unknown command:"+a.value))}break;case "device":switch(a.value){case "callScene":a=parseInt(a.ext);if(isNaN(a)||0>a||128<a){c&&c(Error("scene number invalid"));return}this._device._callScene({dsid:b.dsid,sceneNumber:a},c);break;case "turnOn":this._device._turnOn({dsid:b.dsid},
c);break;case "turnOff":this._device._turnOff({dsid:b.dsid},c);break;case "decreaseValue":this._device._decreaseValue({dsid:b.dsid},c);break;case "increaseValue":this._device._increaseValue({dsid:b.dsid},c);break;default:c&&c(Error("unknown command:"+a.value))}break;case "event":switch(a.value){case "run":if(!b.id){c&&c(Error("device id invalid"));return}this._event._raise({name:"highlevelevent",parameter:"id="+b.id},c);break;default:c&&c(Error("unknown command:"+a.value))}break;default:c&&c(Error("unknown device type:"+
b.type))}else c&&c(Error("command format invalid"));else c&&c(Error("device format invalid"))};p.prototype.executeCommandCreator=function(b,a,c){if(a&&a.value)if(b&&b.type){var e={value:"callScene",ext:0},g=null;if("turnOn"==a.value||"turnOff"==a.value||"increaseValue"==a.value||"decreaseValue"==a.value||"run"==a.value)e.value=a.value;else if("callScene"==a.value){g=parseInt(a.ext);if(isNaN(g)){c&&c(Error("callScene value invalid"));return}e.ext=g}else if("doActivity"==a.value){if(!a.ext){c&&c(Error("doActivity value invalid"));
return}var p=!1,m;for(m in d)if(a.ext==d[m]){g=parseInt(m);p=!0;break}if(!p)for(m in f)if(a.ext==f[m]){g=parseInt(m);p=!0;break}if(!p){c&&c(Error("unknown doActivity:"+a.ext));return}e.ext=g}else if("doScene"==a.value.substr(0,7)){g=parseInt(a.value.substr(7));if(isNaN(g)){c&&c(Error("doScene value invalid"));return}e.ext=g}else{c&&c(Error("unknown command:"+a.value));return}a=null;switch(b.type){case "apartment":case "zone":case "group":case "device":case "event":a=b;break;default:c&&c(Error("unknown device type:"+
b.type))}this.executeCommand(a,e,function(a){c&&c(a)})}else c&&c(Error("device json invalid"));else c&&c(Error("command json invalid"))};p.prototype.getStatesCreator=function(b,a,c){var d=function(a){return a.replace(/&apos;/g,"'").replace(/&quot;/g,'"').replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&")};if(a)if(0==a.length)c&&c(null,[]);else if(a){var e=[],f={},g={},m={},n={},k=this;this._property._getUsrDefinedStates(function(b,l){if(!b&&l){var h,q;for(h=0;h<l.length;h++)q=l[h],q.name&&
(n[q.name]={stateTxt:1==q.value?d(q.setName):d(q.resetName),stateF:1==q.value?parseFloat(q.setName):parseFloat(q.resetName)})}k._property._getMeters(function(b,d){if(!b&&d){var l,h,t;for(l=0;l<d.length;l++)t=d[l],t.dSID&&(f[t.dSID]=t)}k._apartment._getSensorValues(function(b,d){if(!b&&d&&(d.outdoor&&(m=d.outdoor),d.zones))for(l=0;l<d.zones.length;l++){var q=d.zones[l];g[q.id]={};if(q.values)for(h=0;h<q.values.length;h++)for(var z in q.values[h])g[q.id][z]=q.values[h][z]}k._apartment._getTemperatureControlStatus(function(b,
d){if(!b&&d&&d.zones)for(l=0;l<d.zones.length;l++){var k=d.zones[l];g[k.id]||(g[k.id]={});"undefined"!=typeof k.ControlMode&&null!=k.ControlMode&&(g[k.id].ControlMode=p.HEAT_CONTROL_MODE[k.ControlMode]);"undefined"!=typeof k.OperationMode&&null!=k.OperationMode&&(g[k.id].OperationMode=p.HEAT_OP_MODE[k.OperationMode]);"undefined"!=typeof k.TemperatureValue&&null!=k.TemperatureValue&&(g[k.id].TemperatureValue=k.TemperatureValue);"undefined"!=typeof k.NominalValue&&null!=k.NominalValue&&(g[k.id].NominalValue=
k.NominalValue);"undefined"!=typeof k.ControlValue&&null!=k.ControlValue&&(g[k.id].ControlValue=k.ControlValue)}var h;for(l=0;l<a.length;l++)if(a[l]){var k=a[l].id,q=a[l].device,r=a[l].status;if(k&&r&&r.value&&q&&q.type){if("meter"==q.type&&q.dsid)(t=f[q.dsid])&&(h=t[r.value]);else if("uds"==q.type&&q.id)(t=n[q.id])&&(h=t[r.value]);else if("apartment"==q.type){if(t=m[r.value])h=t.value}else"zone"==q.type&&q.zoneID&&(t=g[q.zoneID])&&(h=t[r.value]);if("undefined"==typeof h||null==h)h="?";e.push({id:k,
status:h})}}c&&c(null,e)})})})})}else c&&c(Error("deviceList is null"));else c&&c(Error("deviceList is null"))};p.prototype.toJSON=function(){return{sys:"digitalstrom",ip:this.ip,port:this.port,token:this.applicationToken}};p.prototype.equalsTo=function(b){return b&&b instanceof p?this.ip==b.ip&&this.port==b.port&&this.applicationToken==b.applicationToken:!1};p.GROUP_NAMES=h;p.GROUP_SCENE=d;p.NON_GROUP_SCENE=f;p.GROUP_DEFAULT_SCENES={1:[0,5,17,18,19,40],2:[0,5,15,17,18,19],3:[0,1,2,4,5],4:[0,5,17,
18,19],5:[0,5,17,18,19],9:[6,7,8,10,11],10:[0,5,17,18,19,33,35,36,37],11:[0,5,17,18,19,33,35,36,37],12:[0,5,17,18,19,33,35,36,37],48:[0,1,2,4,5,6,7,8,10,11],64:[0,5,17,18,19,33,35,36,37]};p.GROUP_SPECIAL_SCENE_NAME={1:{0:"Off",40:"Fade Off"},2:{0:"Up",5:"Down"},3:{0:"Heating Off",1:"Heating Comfort",2:"Heating Economy",3:"Heating Not Used",4:"Heating Night"},4:{0:"Off"},5:{0:"Off"},9:{0:"Heating Off",1:"Heating Comfort",2:"Heating Economy",3:"Heating Not Used",4:"Heating Night",5:"Heating Holiday"},
10:{0:"Off",5:"Level 1",17:"Level 2",18:"Level 3",19:"Level 4",33:"Automatic (air flow intensity)",35:"Auto (louver swing mode)",36:"Boost",37:"Noise Reduction"},48:{0:"Heating Off",1:"Heating Comfort",2:"Heating Economy",3:"Heating Not Used",4:"Heating Night",5:"Heating Holiday",6:"Cooling Off",7:"Cooling Comfort",8:"Cooling Economy",9:"Cooling Not Used",10:"Cooling Night",11:"Cooling Holiday"}};return p}();
xnm.aio.digitalstrom.DM=function(){var h=function(d,f){this.code=d;this.message=f;this.stack=Error().stack};h.prototype=Error();h.prototype.name="DigitalStromDMError";h.prototype.code=0;h.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"digitalstrom",getGatewayType:function(){return[{sys:this.SYS,name:"digitalSTROM"}]},getGatewayDeviceType:function(){return[]},createGateway:function(d,f,g){f=h.ERROR_CODE;d?d.ip?g(null,d):g(new h(f.INVALID,"ip is invalid")):
g(new h(f.INVALID,"info is invalid"))},updateGateway:function(d,f,g,e){d=h.ERROR_CODE;f?f.ip?f.username?f.password?e(null,f):e(new h(d.INVALID,"password is invalid")):e(new h(d.INVALID,"username is invalid")):e(new h(d.INVALID,"ip is invalid")):e(new h(d.INVALID,"update is invalid"))},deleteGateway:function(d,f,g){g()},createDevice:function(d,f,g){var e=h.ERROR_CODE;if(d)if(d.gateway)if(d.type)if(f.data&&f.data.gateways&&0!==f.data.gateways.length){f=f.data.gateways;var n,k;for(n=0;n<f.length;n++)if(f[n].index===
d.gateway){k=f[n];break}k?g(null,d):g(new h(e.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else g(new h(e.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else g(new h(e.INVALID,"type is invalid"));else g(new h(e.INVALID,"gateway is invalid"));else g(new h(e.INVALID,"info is invalid"))},updateDevice:function(d,f,g){var e=h.ERROR_CODE;if(d)if(d.gateway)if(d.type)if(f.data&&f.data.gateways&&0!==f.data.gateways.length){f=f.data.gateways;var n,k;for(n=0;n<f.length;n++)if(f[n].index===
d.gateway){k=f[n];break}k?g(null,d):g(new h(e.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else g(new h(e.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else g(new h(e.INVALID,"type is invalid"));else g(new h(e.INVALID,"gateway is invalid"));else g(new h(e.INVALID,"info is invalid"))},deleteDevice:function(d,f,g){g()},applyUIFilter:function(d,f){var g=this,e=function(d,b){if("*"==d)return!0;for(var a=!1,c=0;c<d.length;c++)if(d[c]==b){a=!0;break}return a},n=function(d,b,a){var c=
[];switch(a.catagory){case "command":d.command&&d.command.forEach(function(b){e(a.elems,b.type)&&(b=JSON.parse(JSON.stringify(b)),c.push(b))});break;case "status":d.status&&d.status.forEach(function(b){e(a.elems,b.type)&&(b=JSON.parse(JSON.stringify(b)),c.push(b))})}return c},k=function(d,b){var a=[],c=null;if(c=g.getCommandStatusMap(d))c=n(c,d,b),a=a.concat(c);return a};if(!d||null==d.type||"undefined"==typeof d.type)return null;var m=JSON.parse(JSON.stringify(d)),l=null;switch(f.catagory){case "command":l=
k(d,f);m.command=l;break;case "status":l=k(d,f);m.status=l;break;default:return null}return l&&0!=l.length?m:null},getCommandStatusMap:function(d){var f=function(){var a=xnm.aio.digitalstrom.Server.GROUP_SCENE,b=[],d;for(d in a)a[d]&&b.push(a[d]);return b},g=function(){var a=xnm.aio.digitalstrom.Server.NON_GROUP_SCENE,b=[],d;for(d in a)a[d]&&b.push(a[d]);return b},e={command:[],status:[]};if(!d||!d.type)return null;if("event"==d.type)return e.command=[{type:"enum",name:"run",ref:{value:"run"}}],e;
if("uds"==d.type)return e.status=[{type:"string",name:"state (string)",ref:{value:"stateTxt"}},{type:"float",name:"state (float)",ref:{value:"stateF"}}],e;switch(d.type){case "apartment":e.command=[{type:"enum",name:"Absent",ref:{value:"doScene72"}},{type:"enum",name:"Present",ref:{value:"doScene71"}},{type:"enum",name:"Door Bell",ref:{value:"doScene73"}},{type:"enum",name:"Rain",ref:{value:"doScene88"}},{type:"enum",name:"No Rain",ref:{value:"doScene89"}},{type:"enum",name:"Wind",ref:{value:"doScene86"}},
{type:"enum",name:"No Wind",ref:{value:"doScene87"}},{type:"enum",name:"Hail",ref:{value:"doScene90"}},{type:"enum",name:"No Wind",ref:{value:"doScene91"}},{type:"enum",name:"Panic",ref:{value:"doScene65"}},{type:"enum",name:"Fire",ref:{value:"doScene76"}},{type:"enum",name:"Alarm 1",ref:{value:"doScene74"}},{type:"enum",name:"Alarm 2",ref:{value:"doScene83"}},{type:"enum",name:"Alarm 3",ref:{value:"doScene84"}},{type:"enum",name:"Alarm 4",ref:{value:"doScene85"}}];break;case "zone":e.command=[{type:"enum",
name:"Standby",ref:{value:"doScene67"}},{type:"enum",name:"Deep off",ref:{value:"doScene68"}},{type:"enum",name:"Sleeping",ref:{value:"doScene69"}},{type:"enum",name:"Wake up",ref:{value:"doScene70"}}];break;case "group":var n=xnm.aio.digitalstrom.Server.GROUP_DEFAULT_SCENES[d.applicationType];n||(n=[]);if(d.reachableScenes)for(var k=0;k<d.reachableScenes.length;k++)-1==n.indexOf(d.reachableScenes[k])&&n.push(d.reachableScenes[k]);if(d.sceneNames)for(var m in d.sceneNames)-1==n.indexOf(parseInt(m))&&
n.push(parseInt(m));for(k=0;k<n.length;k++){var l=n[k],h=null;d.sceneNames&&(h=d.sceneNames[l]);if(!h){var b=xnm.aio.digitalstrom.Server.GROUP_SPECIAL_SCENE_NAME[d.applicationType];b&&(h=b[l])}h||(h=xnm.aio.digitalstrom.Server.GROUP_SCENE[l]);h&&e.command.push({type:"enum",name:h,ref:{value:"doScene"+l}})}break;case "device":if(d.groups)for(n=[],k=0;k<d.groups.length;k++){l=[];switch(d.groups[k]){case 1:l=[{type:"enum",name:"on",ref:{value:"turnOn"}},{type:"enum",name:"off",ref:{value:"turnOff"}},
{type:"enum",name:"up",ref:{value:"increaseValue"}},{type:"enum",name:"down",ref:{value:"decreaseValue"}}];break;case 2:l=[{type:"enum",name:"move down",ref:{value:"turnOn"}},{type:"enum",name:"move up",ref:{value:"turnOff"}},{type:"enum",name:"step down",ref:{value:"increaseValue"}},{type:"enum",name:"step up",ref:{value:"decreaseValue"}}];break;case 4:l=[{type:"enum",name:"on",ref:{value:"turnOn"}},{type:"enum",name:"off",ref:{value:"turnOff"}}];break;case 5:l=[{type:"enum",name:"on",ref:{value:"turnOn"}},
{type:"enum",name:"off",ref:{value:"turnOff"}}]}for(h=0;h<l.length;h++)b=l[h],-1==n.indexOf(b.ref.value)&&(e.command.push(b),n.push(b.ref.value))}}switch(d.type){case "apartment":case "zone":f=f();f=f.concat(g());e.command.push({type:"enum",name:"do activity",ref:{value:"doActivity",ext:"%e",extMeta:f}});break;case "group":case "device":f=f(),e.command.push({type:"enum",name:"do activity",ref:{value:"doActivity",ext:"%e",extMeta:f}})}e.command.push({type:"int",name:"call scene",ref:{value:"callScene",
ext:"%d",extMeta:"0-127"}});switch(d.type){case "apartment":if(d.outdoor)for(m in d.outdoor)switch(m){case "temperature":e.status.push({type:"float",name:"temperature",ref:{value:"temperature"}});break;case "humidity":e.status.push({type:"float",name:"humidity",ref:{value:"humidity"}});break;case "windspeed":e.status.push({type:"float",name:"wind speed",ref:{value:"windspeed"}});break;case "winddirection":e.status.push({type:"float",name:"wind direction",ref:{value:"winddirection"}});break;case "gustspeed":e.status.push({type:"float",
name:"gust speed",ref:{value:"gustspeed"}});break;case "gustdirection":e.status.push({type:"float",name:"gust direction",ref:{value:"gustdirection"}});break;case "precipitation":e.status.push({type:"float",name:"precipitation",ref:{value:"precipitation"}});break;case "airpressure":e.status.push({type:"float",name:"air pressure",ref:{value:"airpressure"}})}break;case "zone":g=!1;if(d.sensorValues)for(k=0;k<d.sensorValues.length;k++)if(m=d.sensorValues[k])"undefined"!=typeof m.TemperatureValue&&null!=
m.TemperatureValue&&(g=!0,e.status.push({type:"float",name:"temperature",ref:{value:"TemperatureValue"}})),"undefined"!=typeof m.HumidityValue&&null!=m.HumidityValue&&e.status.push({type:"float",name:"humidity",ref:{value:"HumidityValue"}}),"undefined"!=typeof m.CO2ConcentrationValue&&null!=m.CO2ConcentrationValue&&e.status.push({type:"float",name:"co2",ref:{value:"CO2ConcentrationValue"}}),"undefined"!=typeof m.BrightnessValue&&null!=m.BrightnessValue&&e.status.push({type:"float",name:"brightness",
ref:{value:"BrightnessValue"}});if(d.heating)for(k=0;k<d.heating.length;k++)switch(m=d.heating[k],m){case "ControlMode":e.status.push({type:"enum",name:"control mode",ref:{value:"ControlMode",options:["off","pid_control","zone_follower","fixed_value","manual"]}});break;case "OperationMode":e.status.push({type:"enum",name:"operation mode",ref:{value:"OperationMode",options:"off comfort economy not_used night holiday cooling cooling_off".split(" ")}});break;case "TemperatureValue":g||e.status.push({type:"float",
name:"temperature",ref:{value:"TemperatureValue"}});break;case "NominalValue":e.status.push({type:"float",name:"target temperature",ref:{value:"NominalValue"}});break;case "ControlValue":e.status.push({type:"float",name:"control value",ref:{value:"ControlValue"}})}break;case "meter":e.status.push({type:"float",name:"power",ref:{value:"powerConsumption",unit:"W"}}),e.status.push({type:"float",name:"energy meter",ref:{value:"energyMeterValue",unit:"Wh"}})}return e}}}();
xnm.aio.digitalstrom.Handler=function(){var h=function(){};h.prototype.Server=xnm.aio.digitalstrom.Server;h.prototype.devicemanager=xnm.aio.digitalstrom.DM;h.prototype.registModule=function(d){d.register(this.devicemanager.SYS,"digitalstrom")};h.prototype.resolveGateway=function(d){return d&&d.ip&&d.token?new this.Server(d.ip,d.port,d.token):null};h.prototype.getDeviceCommands=function(d,f){var g=this.devicemanager.applyUIFilter(d,{catagory:"command",elems:"*"}),g=g?g.command:[];f&&f(null,g)};h.prototype.getDeviceStatus=
function(d,f){var g=this.devicemanager.applyUIFilter(d,{catagory:"status",elems:"*"}),g=g?g.status:[];f&&f(null,g)};h.prototype.doCommand=function(d,f,g,e){(d=this.resolveGateway(d))?d.executeCommandCreator(f,g,function(d){e&&e(d)}):e&&e(Error("gateway json format invalid"))};h.prototype.doStatus=function(d,f,g,e,h){(f=this.resolveGateway(f))?f.getStatesCreator(null,[{id:d,device:g,status:e}],function(d,e){d?h&&h(d):h&&h(null,e[0])}):h&&h(Error("gateway json format invalid"))};h.prototype.getDeviceList=
function(d,f){var g=this.resolveGateway(d);g?g.getDevices(function(d,g){f&&f(d,g)}):f&&f(Error("gateway json format invalid"))};h.prototype.discover=function(d,f){var g=require("x.mdns.js");g.clearRecordBuffer();g.discoverServiceWithTimeout("_http._tcp.local",d,function(d,g){if(d)f&&f(d);else{for(var k=[],h=0;h<g.length;h++){var l=g[h];l.target&&l.ip&&0<l.ip.length&&"dss.local"==l.target.toLowerCase()&&(l=new xnm.aio.digitalstrom.Server(l.ip[0],8080),k.push(l))}f&&f(d,k)}})};h.prototype.registApplication=
function(d,f,g,e){if(!d||!d.ip)return null;(new this.Server(d.ip,d.port)).registApplication(f,g,function(d,f){e&&e(d,f)})};return h}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.digitalstrom.Handler);
