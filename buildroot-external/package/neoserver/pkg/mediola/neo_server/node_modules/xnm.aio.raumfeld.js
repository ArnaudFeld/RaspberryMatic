var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.raumfeld=xnm.aio.raumfeld||{};
xnm.aio.raumfeld.Player=function(){var d=function(){this._renderer=null};d.prototype.getIP=function(){return this._renderer?this._renderer.ip:null};d.prototype.setIP=function(a){this._renderer&&(this._renderer.ip=a)};d.prototype.getPort=function(){return this._renderer?this._renderer.port:null};d.prototype.setPort=function(a){this._renderer&&(this._renderer.port=a)};d.prototype.getUUID=function(){return this._renderer?this._renderer.uuid:null};d.prototype.executeCommandCreator=function(a,c,b){c&&
c.value?this._executeCommand(c.value,c.ext,function(a){b&&b(a)}):b&&b(Error("command value is empty"))};d.prototype.getStatesCreator=function(a,c,b){this._getStates(function(a,f){if(a)b&&b(a);else{for(var g=[],d=0;d<c.length;d++){var h=c[d];if(h&&h.id&&h.status)switch(h.status.value){case "muted":null!=f.muted&&"undefined"!=typeof f.muted&&g.push({id:h.id,status:f.muted});break;case "volume":null!=f.volume&&"undefined"!=typeof f.volume&&g.push({id:h.id,status:f.volume});break;case "playMode":f.playMode&&
g.push({id:h.id,status:f.playMode});break;case "playState":f.transportState&&g.push({id:h.id,status:f.transportState});break;case "duration":f.playInfo&&f.playInfo.duration&&g.push({id:h.id,status:f.playInfo.duration});break;case "durationS":f.playInfo&&"undefined"!=typeof f.playInfo.durationSec&&null!=f.playInfo.durationSec&&g.push({id:h.id,status:f.playInfo.durationSec});break;case "position":f.playInfo&&f.playInfo.position&&g.push({id:h.id,status:f.playInfo.position});break;case "positionS":f.playInfo&&
"undefined"!=typeof f.playInfo.positionSec&&null!=f.playInfo.positionSec&&g.push({id:h.id,status:f.playInfo.positionSec});break;case "artist":f.playInfo&&f.playInfo.trackMetaData&&f.playInfo.trackMetaData.artist?g.push({id:h.id,status:f.playInfo.trackMetaData.artist}):g.push({id:h.id,status:""});break;case "title":f.playInfo&&f.playInfo.trackMetaData&&f.playInfo.trackMetaData.title?g.push({id:h.id,status:f.playInfo.trackMetaData.title}):g.push({id:h.id,status:""});break;case "album":f.playInfo&&f.playInfo.trackMetaData&&
f.playInfo.trackMetaData.album?g.push({id:h.id,status:f.playInfo.trackMetaData.album}):g.push({id:h.id,status:""});break;case "eqLow":f.eq&&"undefined"!=typeof f.eq.eqLow&&null!=f.eq.eqLow&&g.push({id:h.id,status:parseFloat(f.eq.eqLow)});break;case "eqMid":f.eq&&"undefined"!=typeof f.eq.eqMid&&null!=f.eq.eqMid&&g.push({id:h.id,status:parseFloat(f.eq.eqMid)});break;case "eqHigh":f.eq&&"undefined"!=typeof f.eq.eqHigh&&null!=f.eq.eqHigh&&g.push({id:h.id,status:parseFloat(f.eq.eqHigh)});break;case "shuffle":f.playMode&&
f.playMode.shuffle&&g.push({id:h.id,status:f.playMode.shuffle});break;case "repeat":f.playMode&&f.playMode.repeat&&g.push({id:h.id,status:f.playMode.repeat})}}b&&b(null,g)}})};d.prototype.play=function(a,c,b){if(a&&c&&c["class"]&&c.id){var e=this;a.browseMetaData(c.id,function(f,g){if(f)b&&b(f);else if(0!=c["class"].indexOf("object.container")||c.res&&c.res.url){var d=null;if(c.res&&c.res.url)d=c.res.url;else{if(!g||!g.meta||!g.meta.res){b&&b(Error("resource url invalid"));return}d=g.meta.res}e._renderer.playResource({url:d},
g.result,b)}else a.uuid?e._renderer.playContainer({containerID:c.id,server_uuid:a.uuid},g.result,b):b&&b(Error("media server uuid invalid"))})}else b&&b(Error("play obj invalid"))};d.prototype.playFromContainer=function(a,c,b,e){if(a&&c&&c.id&&c.parentID)if(a.uuid){var f=this;a.browseMetaData(c.parentID,function(g,d){g?e&&e(g):f._renderer.playContainer({containerID:c.parentID,server_uuid:a.uuid,firstIdx:b},d.result,e)})}else e&&e(Error("media server uuid invalid"));else e&&e(Error("play obj invalid"))};
d.prototype.browser=function(a,c,b,e,f){a?(c||(c=0),b||(b=0),e||(e=0),a.browseChildren(c,b,e,null,function(a,b,c){f&&f(a,b,c)})):f&&f(Error("play obj invalid"))};d.prototype._executeCommand=function(a,c,b){if(this._renderer)switch(a){case "play":this._renderer.play(b);break;case "pause":this._renderer.pause(b);break;case "stop":this._renderer.stop(b);break;case "previous":this._renderer.previous(b);break;case "next":this._renderer.next(b);break;case "mute":this._renderer.mute(function(a){setTimeout(function(){b&&
b(a)},500)});break;case "unmute":this._renderer.unmute(function(a){setTimeout(function(){b&&b(a)},500)});break;case "toggleMute":this._renderer.toggleMute(function(a){setTimeout(function(){b&&b(a)},500)});break;case "volumeUp":this._renderer.volumeUp(b);break;case "volumeDown":this._renderer.volumeDown(b);break;case "setPlayMode":if(!c){b&&b(Error("play mode value invalid"));break}this._renderer.setPlayMode(c,b);break;case "seekTo":if("undefined"==typeof c||null==c){b&&b(Error("seek value invalid"));
break}this._renderer.seekRelTimeSec(c,b);break;case "setVolume":if("undefined"==typeof c||null==c){b&&b(Error("volume value invalid"));break}this._renderer.setVolume(c,b);break;case "shuffleToggle":this.shuffleToggle(b);break;case "repeatSwitch":this.repeatSwitch(b);break;default:b&&b(Error("unknown command"))}else b&&b(Error("renderer not initialized"))};d.prototype._getStates=function(a){if(this._renderer){var c=function(){e--;0==e&&a&&a(null,b)},b={},e=5;this._renderer.getPlayState(function(a,
e){a||(b.transportState=e);c()});this._renderer.getPlayInfo(function(a,e){a||(b.playInfo=e);c()});this._renderer.isMuted(function(a,e){a||(b.muted=e);c()});this._renderer.getVolume(function(a,e){a||(b.volume=e);c()});this.getPlayMode(function(a,e){a||(b.playMode=e);c()})}else a&&a(Error("renderer not initialized"))};d.prototype.getPlayMode=function(a){if(this._renderer){var c=this;this._renderer.getPlayMode(function(b,e){b?a&&a(b):a&&a(null,c._parsePlayMode(e))})}else a&&a(Error("renderer not initialized"))};
d.prototype.setPlayMode=function(a,c){this._renderer?(a=this._buildPlayMode(a),this._renderer.setPlayMode(a,c)):c&&c(Error("renderer not initialized"))};d.prototype._parsePlayMode=function(a){switch(a){case "NORMAL":return{shuffle:"off",repeat:"off"};case "REPEAT_ALL":return{shuffle:"off",repeat:"all"};case "REPEAT_ONE":return{shuffle:"off",repeat:"one"};case "RANDOM":return{shuffle:"on",repeat:"all"};case "SHUFFLE":return{shuffle:"on",repeat:"off"};default:return{shuffle:"off",repeat:"off"}}};d.prototype._buildPlayMode=
function(a){var c=a.shuffle;a=a.repeat;c||(c="off");a||(a="off");return"off"==c&&"off"==a?"NORMAL":"off"==c&&"all"==a?"REPEAT_ALL":"off"==c&&"one"==a?"REPEAT_ONE":"on"==c&&"off"==a?"SHUFFLE":"on"==c&&"all"==a?"RANDOM":"NORMAL"};d.prototype.shuffleToggle=function(a){if(this._renderer){var c=this;this.getPlayMode(function(b,e){b?a&&a(b):(e.shuffle="on"==e.shuffle?"off":"on",c.setPlayMode(e,a))})}else a&&a(Error("renderer not initialized"))};d.prototype.repeatSwitch=function(a){if(this._renderer){var c=
this;this.getPlayMode(function(b,e){b?a&&a(b):(e.repeat="off"==e.shuffle?"off"==e.repeat?"all":"all"==e.repeat?"one":"off":"off"==e.repeat?"all":"off",c.setPlayMode(e,a))})}else a&&a(Error("renderer not initialized"))};d.prototype.equalsTo=function(a){return a&&a instanceof d?this.getIP()==a.getIP()&&this.getPort()==a.getPort():!1};return d}();
xnm.aio.raumfeld.MasterPlayer=function(){var d=function(a,c,b){"undefined"!=typeof require&&require?(this._logger=require("x.logger.js").getLogger("xnm.aio.raumfeld.MasterDevice"),require("x.logger.js").setLevel("info","xnm.aio.raumfeld.MasterDevice")):this._logger={log:{}};this.ip=a;this.port=c;this.port||(this.port=47365);this.uuid=b;this._zonePlayer=this._zones=null;this._getInfoCbs=[];this._autoGetInfoTimeout=null};d.prototype.getIP=function(){return this.ip};d.prototype.getPort=function(){return this.port};
d.prototype.getUUID=function(){return this.uuid};d.prototype.executeCommandCreator=function(a,c,b){if(this._zonePlayer)this._zonePlayer.executeCommandCreator(a,c,b);else{var e=this;this.getInfos(function(f){f?b&&b(f):e._zonePlayer?e._zonePlayer.executeCommandCreator(a,c,b):b&&b(f)})}};d.prototype.getStatesCreator=function(a,c,b){if(this._zonePlayer)this._zonePlayer.getStatesCreator(a,c,b);else{var e=this;this.getInfos(function(f){f?b&&b(f):e._zonePlayer?e._zonePlayer.getStatesCreator(a,c,b):b&&b(f)})}};
d.prototype.play=function(a,c,b){if(this._zonePlayer)this._zonePlayer.play(a,c,b);else{var e=this;this.getInfos(function(f){f?b&&b(f):e._zonePlayer?e._zonePlayer.play(a,c,b):b&&b(f)})}};d.prototype.playFromContainer=function(a,c,b,e){if(this._zonePlayer)this._zonePlayer.playFromContainer(a,c,b,e);else{var f=this;this.getInfos(function(g){g?e&&e(g):f._zonePlayer?f._zonePlayer.playFromContainer(a,c,b,e):e&&e(g)})}};d.prototype.browser=function(a,c,b,e,f){if(this._zonePlayer)this._zonePlayer.browser(a,
c,b,e,f);else{var g=this;this.getInfos(function(d){d?f&&f(d):g._zonePlayer?g._zonePlayer.browser(a,c,b,e,f):f&&f(d)})}};d.prototype.getAllRoomInfo=function(a){if(this._zones){var c=[],b;for(b in this._zones.roomPlayers){var e=this._zones.roomPlayers[b];e&&c.push({uuid:e.getUUID(),name:e.getRoomName()})}a&&a(null,c)}else{var f=this;this.getInfos(function(b){b?a&&a(b):f._zones?f.getAllRoomInfo(a):a&&a(b)})}};d.prototype.getAllZoneInfo=function(a){if(this._zones){var c=[],b;for(b in this._zones.zonePlayers){var e=
this._zones.zonePlayers[b];e&&c.push({uuid:e.getUUID(),rooms:e.getRooms()})}a&&a(null,c)}else{var f=this;this.getInfos(function(b){b?a&&a(b):f.getAllZoneInfo(a)})}};d.prototype.getCurrentZone=function(a){if(this._zonePlayer)a&&a(null,this._zonePlayer);else{var c=this;this.getInfos(function(b){b?a&&a(b):this._zonePlayer?c.getCurrentZone(a):a&&a(Error("no current zone"))})}};d.prototype.setCurrentZone=function(a,c){if(a)if(this._zones){var b=this._zones.zonePlayers[a],e=null;b||(e=Error("no such zone"));
c&&c(e,b)}else{var f=this;this.getInfos(function(b){b?c&&c(b):f.setCurrentZone(a,c)})}else c&&c(Error("zone uuid invalid"))};d.prototype.addRoomToZone=function(a,c,b){var e="/"+this.uuid+"/connectRoomToZone?",e=e+("zoneUDN="+encodeURIComponent("uuid:"+c)),e=e+("&roomUDN="+encodeURIComponent("uuid:"+a)),f=this;this._doGetRequest(this.ip,47365,e,function(a){a?b&&b(a):f.getInfos(b)})};d.prototype.dropRoom=function(a,c){var b="/"+this.uuid+"/dropRoomJob?",b=b+("roomUDN="+encodeURIComponent("uuid:"+a)),
e=this;this._doGetRequest(this.ip,47365,b,function(a){a?c&&c(a):e.getInfos(c)})};d.prototype.getRoomPlayer=function(a){if(!a||!a.uuid)return null;this._zones||(this._zones={zonePlayers:{},roomPlayers:{},dedicatePlayers:{}});var c=this._zones.roomPlayers[a.uuid];if(c)return c;if(!a.port||!a.port||!a.zone_uuid)return null;c=new xnm.aio.raumfeld.RoomPlayer(a.ip,a.port,a.zone_uuid,a.uuid);c._isDummy=!0;return this._zones.roomPlayers[a.uuid]=c};d.prototype.getDiscoveredRoomPlayer=function(a){if(!a)return null;
this._zones||(this._zones={zonePlayers:{},roomPlayers:{},dedicatePlayers:{}});a=this._zones.roomPlayers[a];return!a||a._isDummy?null:a};d.prototype.getRoomPlayers=function(){if(!this._zones)return null;var a=[],c;for(c in this._zones.roomPlayers)a.push(this._zones.roomPlayers[c]);return a};d.prototype.getDedicatePlayer=function(a){if(!a||!a.uuid)return null;this._zones||(this._zones={zonePlayers:{},roomPlayers:{},dedicatePlayers:{}});var c=this._zones.dedicatePlayers[a.uuid];if(c)return c;if(!a.port||
!a.port)return null;c=new xnm.aio.raumfeld.DedicatePlayer(a.ip,a.port,a.uuid);c._isDummy=!0;return this._zones.dedicatePlayers[a.uuid]=c};d.prototype.getDiscoveredDedicatePlayer=function(a){if(!a)return null;this._zones||(this._zones={zonePlayers:{},roomPlayers:{},dedicatePlayers:{}});a=this._zones.dedicatePlayers[a];return!a||a._isDummy?null:a};d.prototype.getDedicatePlayers=function(a){if(!this._zones)return null;var c=[];for(a in this._zones.dedicatePlayers)c.push(this._zones.dedicatePlayers[a]);
return c};d.prototype.getInfos=function(a){var c=this._getInfoCbs.length;a&&-1==this._getInfoCbs.indexOf(a)&&this._getInfoCbs.push(a);if(0==c){this._autoGetInfoTimeout&&(clearTimeout(this._autoGetInfoTimeout),this._autoGetInfoTimeout=null);var b=this;this._getInfos(function(a,c,d){b._autoGetInfoTimeout=setTimeout(function(){b.getInfos(null)},5E3);var k=b._getInfoCbs;b._getInfoCbs=[];k.forEach(function(b){b&&b(a,c,d)})})}};d.prototype._getInfos=function(a){var c=this;this._listDevices(function(b,e){b?
a&&a(b):c._getZones(function(b,d){b?a&&a(b):(c._updateBufferedZones(d,e),a&&a(null,d,e))})})};d.prototype._getZones=function(a){this._doGetRequest(this.ip,47365,"/"+this.uuid+"/getZones",function(c,b){if(c)a&&a(c);else try{var e={},f=$($.parseXML(b));f.find("zone").each(function(){var a=$(this),b=a.attr("udn");b&&(e[b]={},a.find("room").each(function(){var a=$(this),c=a.attr("udn"),f=a.attr("name");c&&f&&(e[b][c]={name:f,renderer:{}},a.find("renderer").each(function(){var a=$(this),f=a.attr("udn"),
a=a.attr("name");f&&a&&(e[b][c].renderer[f]=a)}))}))});f.find("unassignedRooms").each(function(){var a=$(this);e.idle={};a.find("room").each(function(){var a=$(this),b=a.attr("udn"),c=a.attr("name");b&&c&&(e.idle[b]={name:c,renderer:{}},a.find("renderer").each(function(){var a=$(this),c=a.attr("udn"),a=a.attr("name");c&&a&&(e.idle[b].renderer[c]=a)}))})});a&&a(null,e)}catch(d){a&&a(d)}})};d.prototype._listDevices=function(a){this._doGetRequest(this.ip,47365,"/"+this.uuid+"/listDevices",function(c,
b){if(c)a&&a(c);else try{var e={};$($.parseXML(b)).find("device").each(function(){var a=$(this),b=a.attr("udn");b&&(e[b]={udn:b,type:a.attr("type"),location:a.attr("location"),name:a.text()},a=require("url").parse(a.attr("location")),e[b].ip=a.hostname,e[b].port=a.port)});a&&a(null,e)}catch(f){a&&a(f)}})};d.prototype._updateBufferedZones=function(a,c){var b=[],e=[],f=[];this._zones||(this._zones={zonePlayers:{},roomPlayers:{},dedicatePlayers:{}});for(var d in a){b.push(d);var k=a[d],h;if("idle"!=
d){var l=d.substr(5),m=c[d];m&&(this._zones.zonePlayers[l]?(h=this._zones.zonePlayers[l],h.setIP(m.ip),h.setPort(m.port)):(h=new xnm.aio.raumfeld.ZonePlayer(m.ip,m.port,l),this._zones.zonePlayers[l]=h))}h&&h.clearRoom();for(var v in k){e.push(v);var r=k[v],l=r.name,m=v.substr(5);h&&h.addRoom(m,l);var p;this._zones.roomPlayers[m]?p=this._zones.roomPlayers[m]:(p=new xnm.aio.raumfeld.RoomPlayer(null,null,null,m),this._zones.roomPlayers[m]=p);p.setZonePlayer(h);p.setRoomName(l);var r=r.renderer,t;for(t in r){f.push(t);
p=t.substr(5);var w=r[t],u=c[t],q;u&&(this._zones.dedicatePlayers[p]?(q=this._zones.dedicatePlayers[p],q.setIP(u.ip),q.setPort(u.port)):(q=new xnm.aio.raumfeld.DedicatePlayer(u.ip,u.port,p),this._zones.dedicatePlayers[p]=q),q.setName(w),q.setRoom(m,l))}}}for(var n in this._zones.zonePlayers)-1==b.indexOf("uuid:"+n)&&delete this._zones.zonePlayers[n];for(n in this._zones.roomPlayers)-1==e.indexOf("uuid:"+n)&&delete this._zones.roomPlayers[n];for(n in this._zones.dedicatePlayers)-1==f.indexOf("uuid:"+
n)&&delete this._zones.dedicatePlayers[n];if(!this._zonePlayer||!this._zones.zonePlayers[this._zonePlayer.getUUID()])for(n in this._zonePlayer=null,this._zones.zonePlayers)if(this._zones.zonePlayers[n]){this._zonePlayer=this._zones.zonePlayers[n];break}};d.prototype._doGetRequest=function(a,c,b,e){var f=this;a="http://"+a+":"+c+b;this._logger.log("trace","send get to url:"+a);var d=e;$.ajax({url:a,type:"GET",timeout:2E3,dataType:"text",cache:!0,success:function(a){f._logger.log("trace","http request success:"+
a);d&&(d(null,a),d=null)},error:function(a,b){var c="http request error:"+(a?a.status:"0")+"-"+b;f._logger.log("trace",c);d&&(d(Error(c)),d=null)}})};d.prototype.toJSON=function(){return{sys:"raumfeld",ip:this.getIP(),port:this.getPort(),uuid:this.getUUID(),type:"master",model:"Raumfeld"}};d.prototype.equalsTo=function(a){return a&&a instanceof d?this.getIP()==a.getIP()&&this.getPort()==a.getPort():!1};return d}();
xnm.aio.raumfeld.ZonePlayer=function(){var d=function(a,c,b){this._renderer=null;this.rooms={};a&&c&&(this._renderer=this._getRenderer(a,c,b))};d.prototype=new xnm.aio.raumfeld.Player;d.prototype.constructor=d;d.prototype.addRoom=function(a,c){this.rooms[a]=c};d.prototype.clearRoom=function(){this.rooms={}};d.prototype.getRooms=function(){return this.rooms};d.prototype.muteRoom=function(a,c){this._setRoomMute(0,a,1,c)};d.prototype.unmuteRoom=function(a,c){this._setRoomMute(0,a,0,c)};d.prototype.toggleMuteRoom=
function(a,c){var b=this;this.isRoomMuted(a,function(e,f){e?c&&c(e):b._setRoomMute(0,a,f?0:1,c)})};d.prototype.isRoomMuted=function(a,c){this._getRoomMute(0,a,function(a,e){a?c&&c(a):c&&c(null,"1"==e.muted)})};d.prototype.getRoomVolume=function(a,c){this._getRoomVolume(0,a,function(a,e){a?c&&c(a):c&&c(null,e.volume)})};d.prototype.setVolumeRoom=function(a,c,b){this._setRoomVolume(0,a,c,b)};d.prototype.volumeUpRoom=function(a,c){var b=this;this.getRoomVolume(a,function(e,f){if(e)c&&c(e);else{var d=
parseInt(f),d=d+5;100<d&&(d=100);b._setRoomVolume(0,a,d,c)}})};d.prototype.volumeDownRoom=function(a,c){var b=this;this.getRoomVolume(a,function(e,f){if(e)c&&c(e);else{var d=parseInt(f),d=d-5;0>d&&(d=0);b._setRoomVolume(0,a,d,c)}})};d.prototype.getPlayInfo=function(a){this._renderer?this._renderer.getPlayInfo(function(c,b){a&&a(c,b)}):a&&a(Error("no renderer"))};d.prototype._getRenderer=function(a,c,b){if(b){var e=require("xnm.aio.raumfeld.js");if(e.discovery&&e.discovery._mediaRenderer&&(e=e.discovery._mediaRenderer[b]))return e}e=
new (require("x.upnp.js").MediaRenderer);e.init(a,c,b,{avTransport:{type:"urn:schemas-upnp-org:service:AVTransport:1",url:"/TransportService/Control"},connectionManager:{type:"urn:schemas-upnp-org:service:ConnectionManager:1",url:"/ConnectionManager/Control"},renderingControl:{type:"urn:schemas-upnp-org:service:RenderingControl:1",url:"/RenderingService/Control"}});return e};d.prototype._getRoomVolume=function(a,c,b){this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),
this._renderer.renderingControl.type,"GetRoomVolume",{InstanceID:a,Room:"uuid:"+c},function(a,c){if(a)b&&b(a);else{var d={},k=c.find("CurrentVolume");0<k.length&&(d.volume=$(k[0]).text());b&&b(null,d)}})};d.prototype._setRoomVolume=function(a,c,b,e){this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"SetRoomVolume",{InstanceID:a,Room:"uuid:"+c,DesiredVolume:b},function(a){e&&e(a)})};d.prototype._getRoomMute=function(a,c,b){this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),
this._renderer.renderingControl.type,"GetRoomMute",{InstanceID:a,Room:"uuid:"+c},function(a,c){if(a)b&&b(a);else{var d={},k=c.find("CurrentMute");0<k.length&&(d.muted=$(k[0]).text());b&&b(null,d)}})};d.prototype._setRoomMute=function(a,c,b,e){this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"SetRoomMute",{InstanceID:a,Room:"uuid:"+c,DesiredMute:b},function(a){e&&e(a)})};d.prototype.equalsTo=function(a){return a&&a instanceof
d?this.getIP()==a.getIP()&&this.getPort()==a.getPort():!1};d.prototype.toJSON=function(){return{sys:"raumfeld",ip:this.getIP(),port:this.getPort(),uuid:this.getUUID(),type:"zone",model:"Raumfeld"}};return d}();
xnm.aio.raumfeld.RoomPlayer=function(){var d=function(a,c,b,e){this._zonePlayer=null;this.uuid=e;this.name=null;a&&c&&(this._zonePlayer=new xnm.aio.raumfeld.ZonePlayer(a,c,b))};d.prototype.setZonePlayer=function(a){this._zonePlayer=a};d.prototype.getUUID=function(){return this.uuid};d.prototype.setRoomName=function(a){this.name=a};d.prototype.getRoomName=function(){return this.name};d.prototype.executeCommandCreator=function(a,c,b){c&&c.value?this._executeCommand(c.value,c.ext,function(a){b&&b(a)}):
b&&b(Error("command value is empty"))};d.prototype.getStatesCreator=function(a,c,b){this._getStates(function(a,d){if(a)b&&b(a);else{for(var g=[],k=0;k<c.length;k++){var h=c[k];if(h&&h.id&&h.status)switch(h.status.value){case "muted":null!=d.muted&&"undefined"!=typeof d.muted&&g.push({id:h.id,status:d.muted});break;case "volume":null!=d.volume&&"undefined"!=typeof d.volume&&g.push({id:h.id,status:d.volume})}}b&&b(null,g)}})};d.prototype._executeCommand=function(a,c,b){if(this._zonePlayer)if(this.uuid)switch(a){case "mute":this._zonePlayer.muteRoom(this.uuid,
function(a){setTimeout(function(){b&&b(a)},500)});break;case "unmute":this._zonePlayer.unmuteRoom(this.uuid,function(a){setTimeout(function(){b&&b(a)},500)});break;case "toggleMute":this._zonePlayer.toggleMuteRoom(this.uuid,function(a){setTimeout(function(){b&&b(a)},500)});break;case "volumeUp":this._zonePlayer.volumeUpRoom(this.uuid,b);break;case "volumeDown":this._zonePlayer.volumeDownRoom(this.uuid,b);break;case "setVolume":if("undefined"==typeof c||null==c){b&&b(Error("volume value invalid"));
break}this._zonePlayer.setVolumeRoom(this.uuid,c,b);break;default:b&&b(Error("unknown command"))}else b&&b(Error("room uuid invalid"));else b&&b(Error("no zone play for this room"))};d.prototype._getStates=function(a){if(this._zonePlayer)if(this.uuid){var c=function(){e--;0==e&&a&&a(null,b)},b={},e=2;this._zonePlayer.isRoomMuted(this.uuid,function(a,e){a||(b.muted=e);c()});this._zonePlayer.getRoomVolume(this.uuid,function(a,e){a||(b.volume=e);c()})}else a&&a(Error("room uuid invalid"));else a&&a(Error("no zone play for this room"))};
d.prototype.equalsTo=function(a){return a&&a instanceof d&&this._zonePlayer&&a._zonePlayer?this._zonePlayer.getIP()==a._zonePlayer.getIP()&&this._zonePlayer.getPort()==a._zonePlayer.getPort():!1};d.prototype.toJSON=function(){return{sys:"raumfeld",ip:this._zonePlayer?this._zonePlayer.getIP():null,port:this._zonePlayer?this._zonePlayer.getPort():null,uuid:this.uuid,type:"room",model:"Raumfeld",zone_uuid:this._zonePlayer?this._zonePlayer.getUUID():null,server_uuid:null,name:this.name}};return d}();
xnm.aio.raumfeld.DedicatePlayer=function(){var d={},a=function(a,b,e){this.name=this.room=this._renderer=null;a&&b&&(this._renderer=this._getRenderer(a,b,e))};a.prototype=new xnm.aio.raumfeld.Player;a.prototype.constructor=a;a.prototype.setName=function(a){this.name=a};a.prototype.setRoom=function(a,b){this.room={};this.room[a]=b};a.prototype.getEqualizer=function(a){var b=this;this._getFilter(0,function(e,f){e?a&&a(e):(d[b._renderer.uuid]||(d[b._renderer.uuid]={}),d[b._renderer.uuid].eqLow=f.eqLow,
d[b._renderer.uuid].eqMid=f.eqMid,d[b._renderer.uuid].eqHigh=f.eqHigh,a&&a(null,f))})};a.prototype.setEqualizer=function(a,b){var e=this;this._setFilter(0,a,function(f){f?b&&b(f):(d[e._renderer.uuid]||(d[e._renderer.uuid]={}),d[e._renderer.uuid].eqLow=a.eqLow,d[e._renderer.uuid].eqMid=a.eqMid,d[e._renderer.uuid].eqHigh=a.eqHigh,b&&b(null))})};a.prototype._executeCommand=function(a,b,e){if(this._renderer)switch(a){case "eqLowTo":case "eqMidTo":case "eqHighTo":if("undefined"==typeof b||null==b){e&&
e(Error("equlizer value invalid"));break}var f=this,g=d[this._renderer.uuid];if(g&&g.eqLow&&g.eqMid&&g.eqHigh){g={eqLow:g.eqLow,eqMid:g.eqMid,eqHigh:g.eqHigh};-1536>b&&(b=-1536);1536<b&&(b=1536);switch(a){case "eqLowTo":g.eqLow=b;break;case "eqMidTo":g.eqMid=b;break;case "eqHighTo":g.eqHigh=b}this.setEqualizer(g,e)}else this.getEqualizer(function(d){d?e&&e(d):f._executeCommand(a,b,e)});break;default:xnm.aio.raumfeld.Player.prototype._executeCommand.call(this,a,b,e)}else e&&e(Error("renderer not initialized"))};
a.prototype._getStates=function(a){if(this._renderer){var b=function(){d--;0==d&&a&&a(null,e)},e={},d=3;this._renderer.isMuted(function(a,c){a||(e.muted=c);b()});this._renderer.getVolume(function(a,c){a||(e.volume=c);b()});this.getEqualizer(function(a,c){!a&&c&&(e.eq=c);b()})}else a&&a(Error("renderer not initialized"))};a.prototype._getRenderer=function(a,b,e){if(e){var d=require("xnm.aio.raumfeld.js");if(d.discovery&&d.discovery._mediaRenderer&&(d=d.discovery._mediaRenderer[e]))return d}d=new (require("x.upnp.js").MediaRenderer);
d.init(a,b,e,{avTransport:{type:"urn:schemas-upnp-org:service:AVTransport:1",url:"/AVTransport/ctrl"},connectionManager:{type:"urn:schemas-upnp-org:service:ConnectionManager:1",url:"/ConnectionManager/ctrl"},renderingControl:{type:"urn:schemas-upnp-org:service:RenderingControl:1",url:"/RenderingControl/ctrl"}});return d};a.prototype._getFilter=function(a,b){this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"GetFilter",{InstanceID:a},
function(a,c){if(a)b&&b(a);else{var d={},k=c.find("LowDB");0<k.length&&(d.eqLow=$(k[0]).text());k=c.find("MidDB");0<k.length&&(d.eqMid=$(k[0]).text());k=c.find("HighDB");0<k.length&&(d.eqHigh=$(k[0]).text());b&&b(null,d)}})};a.prototype._setFilter=function(a,b,d){this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"SetFilter",{InstanceID:a,LowDB:b.eqLow,MidDB:b.eqMid,HighDB:b.eqHigh},function(a){d&&d(a)})};a.prototype.equalsTo=
function(c){return c&&c instanceof a?this.getIP()==c.getIP()&&this.getPort()==c.getPort():!1};a.prototype.toJSON=function(){return{sys:"raumfeld",ip:this.getIP(),port:this.getPort(),uuid:this.getUUID(),type:"player",model:this._renderer?this._renderer.modelName:null,server_uuid:null,name:this.name,room:this.room}};return a}();
xnm.aio.raumfeld.Discovery=function(){var d=function(){"undefined"!=typeof require&&require?(this._logger=require("x.logger.js").getLogger("xnm.aio.raumfeld.Discovery"),require("x.logger.js").setLevel("info","xnm.aio.raumfeld.Discovery")):this._logger={log:{}};this._masterPlayer=this._upnpCB=null;this._mediaServer={};this._mediaRenderer={};this._searchRaumfeldCB=[];this._autoSearchTimeout=null;this.searchRaumfeld(null)};d.prototype.getPlayer=function(a){if(!a||!a.type||!a.uuid)return null;var c=null;
if("master"==a.type){if(!this._masterPlayer){if(!a.ip||!a.port)return null;this._masterPlayer=new xnm.aio.raumfeld.MasterPlayer(a.ip,a.port,a.uuid);this._masterPlayer._isDummy=!0}c=this._masterPlayer}else if("room"==a.type)c=this._masterPlayer.getRoomPlayer(a);else if("player"==a.type)c=this._masterPlayer.getDedicatePlayer(a);else return null;c&&!c._isDummy||this.searchRaumfeld(null);return c};d.prototype.getDiscoveredPlayer=function(a,c){if(!a||!c)return null;var b=null;if("master"==a)b=this._masterPlayer;
else if("room"==a)b=this._masterPlayer.getDiscoveredRoomPlayer(c);else if("player"==a)b=this._masterPlayer.getDiscoveredDedicatePlayer(c);else return null;b&&!b._isDummy||this.searchRaumfeld(null);return b};d.prototype.getBufferedMediaServers=function(){var a=[],c;for(c in this._mediaServer)if(this._mediaServer.hasOwnProperty(c)){var b=this._mediaServer[c];b.manufacturer&&-1!=b.manufacturer.indexOf("Raumfeld")&&(b._raumfeldMaster=!0);a.push(b)}return a};d.prototype.getBufferedPlayers=function(){if(!this._masterPlayer)return[];
var a=null,c;for(c in this._mediaServer)if(this._mediaServer.hasOwnProperty(c)){var b=this._mediaServer[c];if(b&&b.ip==this._masterPlayer.getIP()){a=b.uuid;break}}if(!a)return[];var d=[];d.push(this._masterPlayer.toJSON());(c=this._masterPlayer.getRoomPlayers())&&c.forEach(function(b){b&&(b=b.toJSON(),b.server_uuid=a,d.push(b))});var f=this;(c=this._masterPlayer.getDedicatePlayers())&&c.forEach(function(b){b=b.toJSON();var c=b.uuid;b.server_uuid=a;if(c=f._mediaRenderer[c])b.model=c.modelName;d.push(b)});
return d};d.prototype.searchRaumfeld=function(a){var c=this._searchRaumfeldCB.length;a&&-1==this._searchRaumfeldCB.indexOf(a)&&this._searchRaumfeldCB.push(a);if(0==c){this._autoSearchTimeout&&(clearTimeout(this._autoSearchTimeout),this._autoSearchTimeout=null);this._search();var b=this;setTimeout(function(){b._autoSearchTimeout=setTimeout(function(){b._logger.log("trace","auto search timeout, search again");b.searchRaumfeld(null)},3E4);var a=b._searchRaumfeldCB;b._searchRaumfeldCB=[];a.forEach(function(a){a&&
a()})},5E3)}};d.prototype._search=function(){if(!this._upnpCB){var a=this;this._upnpCB=function(b){a._findUpnpDevice(b)}}this._mediaServer={};this._mediaRenderer={};var c=require("x.upnp.js").getDiscoveryService();c.addCallback("upnp:rootdevice",this._upnpCB);c.discoverTarget("upnp:rootdevice")};d.prototype._findUpnpDevice=function(a){if(a){var c=a.uuid;switch(a.deviceType){case "urn:schemas-raumfeld-com:device:ConfigDevice:1":this._logger.log("trace","find raumfeld master");this._masterPlayer||(this._masterPlayer=
new xnm.aio.raumfeld.MasterPlayer(a.ip,0,a.uuid));this._masterPlayer._isDummy=!1;this._masterPlayer.ip=a.ip;this._masterPlayer.getInfos(null);break;case "urn:schemas-upnp-org:device:MediaServer:1":this._logger.log("trace","find media server:"+a.name+" @"+a.ip);this._mediaServer[c]=a;break;case "urn:schemas-upnp-org:device:MediaRenderer:1":this._logger.log("trace","find media renderer:"+a.name+" @"+a.ip),this._mediaRenderer[c]=a}}};return d}();
xnm.aio.raumfeld.DM=function(){var d={master:{command:[{type:"enum",name:"play",ref:{value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",
name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume",ref:{value:"setVolume",ext:"%d",extMeta:"0-100"}},{type:"int",name:"seek to (seconds)",ref:{value:"seekTo",ext:"%d"}},{type:"enum",name:"toggle shuffle",ref:{value:"shuffleToggle"}},{type:"enum",name:"switch repeat",ref:{value:"repeatSwitch"}}],status:[{type:"enum",name:"muted",ref:{value:"muted",options:["true","false"]}},{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-100"}},{type:"string",name:"play state",ref:{value:"playState",
options:"STOPPED PLAYING TRANSITIONING PAUSED_PLAYBACK PAUSED_RECORDING RECORDING NO_MEDIA_PRESENT".split(" ")}},{type:"string",name:"track duration",ref:{value:"duration"}},{type:"int",name:"track duration (seconds)",ref:{value:"durationS"}},{type:"string",name:"track position",ref:{value:"position"}},{type:"int",name:"track position (seconds)",ref:{value:"positionS"}},{type:"string",name:"artist",ref:{value:"artist"}},{type:"string",name:"title",ref:{value:"title"}},{type:"string",name:"album",
ref:{value:"album"}},{type:"enum",name:"shuffle state",ref:{value:"shuffle",options:["on","off"]}},{type:"enum",name:"repeat state",ref:{value:"repeat",options:["off","one","all"]}}]},room:{command:[{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume",ref:{value:"setVolume",
ext:"%d",extMeta:"0-100"}}],status:[{type:"enum",name:"muted",ref:{value:"muted",options:["true","false"]}},{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-100"}}]},player:{command:[{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume",ref:{value:"setVolume",
ext:"%d",extMeta:"0-100"}},{type:"int",name:"set equalizer low (db)",ref:{value:"eqLowTo",ext:"%d",extMeta:"-1536-1536"}},{type:"int",name:"set equalizer middel (db)",ref:{value:"eqMidTo",ext:"%d",extMeta:"-1536-1536"}},{type:"int",name:"set equalizer high (db)",ref:{value:"eqHighTo",ext:"%d",extMeta:"-1536-1536"}}],status:[{type:"enum",name:"muted",ref:{value:"muted",options:["true","false"]}},{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-100"}},{type:"int",name:"equalizer low (db)",ref:{value:"eqLow"}},
{type:"int",name:"equalizer middel (db)",ref:{value:"eqMid"}},{type:"int",name:"equalizer high (db)",ref:{value:"eqHigh"}}]}},a=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};a.prototype=Error();a.prototype.name="RaumfeldDMError";a.prototype.code=0;a.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"raumfeld",getIPDeviceType:function(){return[{sys:this.SYS,name:"Raumfeld"}]},createDevice:function(c,b,d){b=a.ERROR_CODE;c?c.type?
c.ip?c.port?d(null,c):d(new a(b.INVALID,"port is invalid")):d(new a(b.INVALID,"ip is invalid")):d(new a(b.INVALID,"type is invalid")):d(new a(b.INVALID,"info is invalid"))},updateDevice:function(c,b,d){b=a.ERROR_CODE;c?c.type?c.ip?c.port?d(null,c):d(new a(b.INVALID,"port is invalid")):d(new a(b.INVALID,"ip is invalid")):d(new a(b.INVALID,"type is invalid")):d(new a(b.INVALID,"info is invalid"))},deleteDevice:function(a,b,d){d()},applyUIFilter:function(a,b,d){var f=function(a,b){if("*"==a)return!0;
for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},g=function(a,b,c){var d=[];switch(c.catagory){case "command":a.command&&a.command.forEach(function(a){f(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))});break;case "status":a.status&&a.status.forEach(function(a){f(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))})}return d},k=function(a,b){var c=[],f=null;if(f=xnm.aio.raumfeld.DM.getCommandStatusMap(a,d))f=g(f,a,b),c=c.concat(f);return c};if(!a.sys)return null;
var h=JSON.parse(JSON.stringify(a)),l=null;switch(b.catagory){case "command":l=k(a,b);h.command=l;break;case "status":l=k(a,b);h.status=l;break;default:return null}return l&&0!=l.length?h:null},getCommandStatusMap:function(a,b){return a&&a.type?d[a.type]:null}}}();
xnm.aio.raumfeld.Handler=function(){var d=function(){this.discovery=new xnm.aio.raumfeld.Discovery};d.prototype.devicemanager=xnm.aio.raumfeld.DM;d.prototype.registModule=function(a){a.register(xnm.aio.raumfeld.DM.SYS,"raumfeld")};d.prototype.resolveDevice=function(a){return a?this.discovery.getPlayer(a):null};d.prototype.getDeviceCommands=function(a,c){var b=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}),b=b?b.command:[];c&&c(null,b)};d.prototype.getDeviceStatus=function(a,c){var b=
this.devicemanager.applyUIFilter(a,{catagory:"status",elems:"*"}),b=b?b.status:[];c&&c(null,b)};d.prototype.doCommand=function(a,c,b){var d=this.resolveDevice(a);d?d.executeCommandCreator(a,c,function(a){b&&b(a)}):b&&b(Error("device json format invalid"))};d.prototype.doStatus=function(a,c,b,d){var f=this.resolveDevice(c);f?f.getStatesCreator(null,[{id:a,device:c,status:b}],function(a,b){a?d&&d(a):d&&d(null,b[0])}):d&&d(Error("device json format invalid"))};d.prototype.discover=function(a){var c=
this;this.discovery.searchRaumfeld(function(){a&&a(null,c.discovery.getBufferedPlayers())})};d.prototype.getPlayer=function(a,c){if(a&&a.uuid&&a.type){var b=this.discovery.getDiscoveredPlayer(a.type,a.uuid);if(b)c&&c(null,b);else{var d=this;this.discovery.searchRaumfeld(function(){b=d.discovery.getDiscoveredPlayer(a.type,a.uuid);c&&c(null,b)})}}else c&&c(Error("device json invalid"))};d.prototype.getMediaServer=function(a){var c=this.discovery.getBufferedMediaServers();if(0==c.length){var b=this;
this.discovery.searchRaumfeld(function(){a&&a(null,b.discovery.getBufferedMediaServers())})}else a&&a(null,c)};return d}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.raumfeld.Handler);
