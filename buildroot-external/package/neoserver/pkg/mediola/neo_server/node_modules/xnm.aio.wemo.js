var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.wemo=xnm.aio.wemo||{};
xnm.aio.wemo.Switch=function(){var d=function(a,b,c,e){this.ip=a;this.port=b;this.uuid=c;this.type="switch";e&&(this.type=e);this.CommandHandler=null};d.prototype.switchTo=function(a,b){var c=new (require("x.upnp.js").Device),e=this;c.init(this.ip,this.port,this.uuid);c._doSOAPRequest(c.getURL("/upnp/control/basicevent1"),"urn:Belkin:service:basicevent:1","SetBinaryState",{BinaryState:a},function(c){c?b&&b(c):(c=0,"insight"==e.type&&(c=1E3),b&&setTimeout(b,c))})};d.prototype._getBinaryState=function(a){var b=
new (require("x.upnp.js").Device);b.init(this.ip,this.port,this.uuid);b._doSOAPRequest(b.getURL("/upnp/control/basicevent1"),"urn:Belkin:service:basicevent:1","GetBinaryState",{BinaryState:1},function(c,b){var f=null;if(b){var d=b.find("BinaryState");0<d.length&&(f=parseInt($(d[0]).text()),0==f?f="off":null!=f&&(f="on"))}a&&a(f)})};d.prototype._getInsightState=function(a){var b=new (require("x.upnp.js").Device);b.init(this.ip,this.port,this.uuid);b._doSOAPRequest(b.getURL("/upnp/control/insight1"),
"urn:Belkin:service:insight:1","GetInsightParams",null,function(c,b){var f=null;if(b){var d=b.find("InsightParams");0<d.length&&(d=$(d[0]).text().split("|"),11==d.length&&(f=(parseInt(d[7])/1E3).toFixed(1)))}a&&a(f)})};d.prototype.getState=function(a){var b=null,c=this;this._getBinaryState(function(e){e&&e?(b={state:e},"insight"==c.type?c._getInsightState(function(c){c&&(b.current=c);a&&a(b)}):a&&a(b)):a&&a(null)})};d.prototype.executeCommand=function(a,b,c){if("on"==b)this.switchTo(1,c);else if("off"==
b)this.switchTo(0,c);else if("toggle"==b){var e=this;this._getBinaryState(function(b){"off"==b?e.switchTo(1,c):e.switchTo(0,c)})}else c&&c()};d.prototype.getStates=function(a,b,c){var e=this;this.CommandHandler=a;this.getState(function(a){a&&b&&e.CommandHandler.setState?(e.CommandHandler.setState(b.id,a.state),a&&a.current&&e.CommandHandler.setState(b.id+":current",a.current)):a&&e.CommandHandler.receivedState&&e.CommandHandler.receivedState("wemo",e.ip+":"+e.port,a);c&&c(a)})};d.prototype.getStateValues=
function(a,b){return b};d.prototype.executeCommandCreator=function(a,b,c){b&&b.value?this.executeCommand(a,b.value,function(b){c&&c(b)}):c&&c(Error("command value is empty"))};d.prototype.getStatesCreator=function(a,b,c){this.getState(function(a){if(a){for(var d=[],k=0;k<b.length;k++){var g=b[k];if(g&&g.id&&g.status)switch(g.status.value){case "switchState":a.state&&d.push({id:g.id,status:a.state});break;case "powerState":a.current&&d.push({id:g.id,status:parseFloat(a.current)})}}c&&c(null,d)}else c&&
c(Error("get state error"))})};d.prototype.toJSON=function(){return{sys:xnm.aio.wemo.DM.SYS,type:this.type,ip:this.ip,port:this.port,uuid:this.uuid}};d.prototype.equalsTo=function(a){return a&&a instanceof d?this.ip==a.ip&&this.port==a.port:!1};d.parseJSON=function(a){return a.ip&&a.port?new d(a.ip,a.port,a.uuid,a.type):null};return d}();
xnm.aio.wemo.DM=function(){var d={"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"switch status",ref:{value:"switchState",options:["off","on"]}}]},insight:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"switch status",ref:{value:"switchState",options:["off",
"on"]}},{type:"float",name:"power status",ref:{value:"powerState",scale:"0.1"}}]}},a=function(a,c){this.code=a;this.message=c;this.stack=Error().stack};a.prototype=Error();a.prototype.name="WemoDMError";a.prototype.code=0;a.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"wemo",getIPDeviceType:function(){return[{sys:this.SYS,name:"Belkin WeMo"}]},createDevice:function(b,c,e){c=a.ERROR_CODE;b?b.type?b.ip?e(null,b):e(new a(c.INVALID,"ip is invalid")):
e(new a(c.INVALID,"type is invalid")):e(new a(c.INVALID,"info is invalid"))},updateDevice:function(b,c,e){c=a.ERROR_CODE;b?b.type?b.ip?e(null,b):e(new a(c.INVALID,"ip is invalid")):e(new a(c.INVALID,"type is invalid")):e(new a(c.INVALID,"info is invalid"))},deleteDevice:function(a,c,e){e()},applyUIFilter:function(a,c,e){var d=function(a,c){if("*"==a)return!0;for(var b=!1,e=0;e<a.length;e++)if(a[e]==c){b=!0;break}return b},k=function(a,c,b){var e=[];switch(b.catagory){case "command":a.command&&a.command.forEach(function(a){d(b.elems,
a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){d(b.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},g=function(a,c){var b=[],d=null;if(d=xnm.aio.wemo.DM.getCommandStatusMap(a,e))d=k(d,a,c),b=b.concat(d);return b};if(!a.sys)return null;var l=JSON.parse(JSON.stringify(a)),h=null;switch(c.catagory){case "command":h=g(a,c);l.command=h;break;case "status":h=g(a,c);l.status=h;break;default:return null}return h&&0!=
h.length?l:null},getCommandStatusMap:function(a,c){return a.type?d[a.type]:null}}}();
xnm.aio.wemo.Handler=function(){var d=function(){this.detectedDevices={}};d.prototype.discoverDevices=function(a){var b=require("x.upnp.js");if(b){var c=this;b.discoverDevices(function(b){if("wemo"==b.type){var d=new xnm.aio.wemo.Switch(b.ip,b.port,b.uuid);b.subtype&&(d.type=b.subtype);c.detectedDevices[b.uuid]=d;a(d)}})}};d.prototype.getStateValues=function(a,b){return(new xnm.aio.wemo.Switch).getStateValues(a,b)};d.prototype.getDeviceCommandList=function(a,b){var c=[];c.push({id:window.XC_Text.on,
cmd:"on"});c.push({id:window.XC_Text.off,cmd:"off"});return c};d.prototype.getDevice=function(a){return new xnm.aio.wemo.Switch(a.address,a.port,null,a.data)};d.prototype.devicemanager=xnm.aio.wemo.DM;d.prototype.registModule=function(a){a.register(xnm.aio.wemo.DM.SYS,"wemo")};d.prototype.resolveDevice=function(a){if(!a)return null;switch(a.type){case "switch":case "insight":return xnm.aio.wemo.Switch.parseJSON(a);default:return null}};d.prototype.getDeviceCommands=function(a,b){var c=xnm.aio.wemo.DM.applyUIFilter(a,
{catagory:"command",elems:"*"}),c=c?c.command:[];b&&b(null,c)};d.prototype.getDeviceStatus=function(a,b){var c=xnm.aio.wemo.DM.applyUIFilter(a,{catagory:"status",elems:"*"}),c=c?c.status:[];b&&b(null,c)};d.prototype.doCommand=function(a,b,c){var e=this.resolveDevice(a);e?e.executeCommandCreator(a,b,function(a){c&&c(a)}):c&&c(Error("device json format invalid"))};d.prototype.doStatus=function(a,b,c,e){var d=this.resolveDevice(b);d?d.getStatesCreator(null,[{id:a,device:b,status:c}],function(a,b){a?
e&&e(a):e&&e(null,b[0])}):e&&e(Error("device json format invalid"))};d.prototype.discoverWithTimeout=function(a,b){var c={};this.discoverDevices(function(a){a&&a.uuid&&!c[a.uuid]&&(c[a.uuid]=a)});setTimeout(function(){var a=[],d;for(d in c)c.hasOwnProperty(d)&&a.push(c[d]);b&&b(null,a)},a)};return d}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.wemo.Handler);
