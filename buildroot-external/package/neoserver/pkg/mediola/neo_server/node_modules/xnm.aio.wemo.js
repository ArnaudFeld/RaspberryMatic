var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.wemo=xnm.aio.wemo||{},xnm.aio.wemo.Switch=function(){var t=function t(_t,e,n,i){this.ip=_t,this.port=e,this.uuid=n,this.type="switch",i&&(this.type=i),this.CommandHandler=null;};return t.prototype.switchTo=function(t,e){var n=new(require("x.upnp.js").Device)(),i=this;n.init(this.ip,this.port,this.uuid),n._doSOAPRequest(n.getURL("/upnp/control/basicevent1"),"urn:Belkin:service:basicevent:1","SetBinaryState",{BinaryState:t},function(t){if(t)e&&e(t);else{var n=0;"insight"==i.type&&(n=1e3),e&&setTimeout(e,n);}});},t.prototype._getBinaryState=function(t){var e=new(require("x.upnp.js").Device)();e.init(this.ip,this.port,this.uuid),e._doSOAPRequest(e.getURL("/upnp/control/basicevent1"),"urn:Belkin:service:basicevent:1","GetBinaryState",{BinaryState:1},function(e,n){var i=null;if(n){var o=n.find("BinaryState");o.length>0&&(0==(i=parseInt($(o[0]).text()))?i="off":null!=i&&(i="on"));}t&&t(i);});},t.prototype._getInsightState=function(t){var e=new(require("x.upnp.js").Device)();e.init(this.ip,this.port,this.uuid),e._doSOAPRequest(e.getURL("/upnp/control/insight1"),"urn:Belkin:service:insight:1","GetInsightParams",null,function(e,n){var i=null;if(n){var o=n.find("InsightParams");if(o.length>0){var r=$(o[0]).text().split("|");11==r.length&&(i=(parseInt(r[7])/1e3).toFixed(1));}}t&&t(i);});},t.prototype.getState=function(t){var e=null,n=this;this._getBinaryState(function(i){i&&i?(e={state:i},"insight"==n.type?n._getInsightState(function(n){n&&(e.current=n),t&&t(e);}):t&&t(e)):t&&t(null);});},t.prototype.executeCommand=function(t,e,n){if("on"==e)this.switchTo(1,n);else if("off"==e)this.switchTo(0,n);else if("toggle"==e){var i=this;this._getBinaryState(function(t){"off"==t?i.switchTo(1,n):i.switchTo(0,n);});}else n&&n();},t.prototype.getStates=function(t,e,n){var i=this;this.CommandHandler=t,this.getState(function(t){t&&e&&i.CommandHandler.setState?(i.CommandHandler.setState(e.id,t.state),t&&t.current&&i.CommandHandler.setState(e.id+":current",t.current)):t&&i.CommandHandler.receivedState&&i.CommandHandler.receivedState("wemo",i.ip+":"+i.port,t),n&&n(t);});},t.prototype.getStateValues=function(t,e){return e;},t.prototype.executeCommandCreator=function(t,e,n){e&&e.value?this.executeCommand(t,e.value,function(t){n&&n(t);}):n&&n(new Error("command value is empty"));},t.prototype.getStatesCreator=function(t,e,n){this.getState(function(t){if(t){for(var i=[],o=0;o<e.length;o++){var r=e[o];if(r&&r.id&&r.status)switch(r.status.value){case"switchState":t.state&&i.push({id:r.id,status:t.state});break;case"powerState":t.current&&i.push({id:r.id,status:parseFloat(t.current)});}}n&&n(null,i);}else n&&n(new Error("get state error"));});},t.prototype.toJSON=function(){return{sys:xnm.aio.wemo.DM.SYS,type:this.type,ip:this.ip,port:this.port,uuid:this.uuid};},t.prototype.equalsTo=function(e){return!!e&&e instanceof t&&this.ip==e.ip&&this.port==e.port;},t.parseJSON=function(e){return e.ip&&e.port?new t(e.ip,e.port,e.uuid,e.type):null;},t;}(),xnm.aio.wemo.DM=function(){var t={"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"switch status",ref:{value:"switchState",options:["off","on"]}}]},insight:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"switch status",ref:{value:"switchState",options:["off","on"]}},{type:"float",name:"power status",ref:{value:"powerState",scale:"0.1"}}]}},e=function e(t,_e){this.code=t,this.message=_e,this.stack=new Error().stack;};return(e.prototype=new Error()).name="WemoDMError",e.prototype.code=0,e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"wemo",getIPDeviceType:function getIPDeviceType(){return[{sys:this.SYS,name:"Belkin WeMo"}];},createDevice:function createDevice(t,n,i){var o=e,r=e.ERROR_CODE;t?t.type?t.ip?i(null,t):i(new o(r.INVALID,"ip is invalid")):i(new o(r.INVALID,"type is invalid")):i(new o(r.INVALID,"info is invalid"));},updateDevice:function updateDevice(t,n,i){var o=e,r=e.ERROR_CODE;t?t.type?t.ip?i(null,t):i(new o(r.INVALID,"ip is invalid")):i(new o(r.INVALID,"type is invalid")):i(new o(r.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(t,e,n){n();},applyUIFilter:function applyUIFilter(t,e,n){var i=function i(t,e){if("*"==t)return!0;for(var n=!1,i=0;i<t.length;i++)if(t[i]==e){n=!0;break;}return n;},o=function o(t,e){var o=[],r=null,a=xnm.aio.wemo.DM.getCommandStatusMap(t,n);return a&&(r=function(t,e,n){var o=[];switch(n.catagory){case"command":t.command&&t.command.forEach(function(t){if(i(n.elems,t.type)){var e=JSON.parse(JSON.stringify(t));o.push(e);}});break;case"status":t.status&&t.status.forEach(function(t){if(i(n.elems,t.type)){var e=JSON.parse(JSON.stringify(t));o.push(e);}});}return o;}(a,0,e),o=o.concat(r)),o;};if(!t.sys)return null;var r=JSON.parse(JSON.stringify(t)),a=null;switch(e.catagory){case"command":a=o(t,e),r.command=a;break;case"status":a=o(t,e),r.status=a;break;default:return null;}return a&&0!=a.length?r:null;},getCommandStatusMap:function getCommandStatusMap(e,n){return e.type?t[e.type]:null;}};}(),xnm.aio.wemo.Handler=function(){var t=function t(){this.detectedDevices={};};return t.prototype.discoverDevices=function(t){var e=require("x.upnp.js");if(e){var n=this;e.discoverDevices(function(e){if("wemo"==e.type){var i=new xnm.aio.wemo.Switch(e.ip,e.port,e.uuid);e.subtype&&(i.type=e.subtype),n.detectedDevices[e.uuid]=i,t(i);}});}},t.prototype.getStateValues=function(t,e){return new xnm.aio.wemo.Switch().getStateValues(t,e);},t.prototype.getDeviceCommandList=function(t,e){var n=[];return n.push({id:window.XC_Text.on,cmd:"on"}),n.push({id:window.XC_Text.off,cmd:"off"}),n;},t.prototype.getDevice=function(t){return new xnm.aio.wemo.Switch(t.address,t.port,null,t.data);},t.prototype.devicemanager=xnm.aio.wemo.DM,t.prototype.registModule=function(t){t.register(xnm.aio.wemo.DM.SYS,"wemo");},t.prototype.resolveDevice=function(t){if(!t)return null;switch(t.type){case"switch":case"insight":return xnm.aio.wemo.Switch.parseJSON(t);default:return null;}},t.prototype.getDeviceCommands=function(t,e){var n=xnm.aio.wemo.DM.applyUIFilter(t,{catagory:"command",elems:"*"}),i=n?n.command:[];e&&e(null,i);},t.prototype.getDeviceStatus=function(t,e){var n=xnm.aio.wemo.DM.applyUIFilter(t,{catagory:"status",elems:"*"}),i=n?n.status:[];e&&e(null,i);},t.prototype.doCommand=function(t,e,n){var i=this.resolveDevice(t);i?i.executeCommandCreator(t,e,function(t){n&&n(t);}):n&&n(new Error("device json format invalid"));},t.prototype.doStatus=function(t,e,n,i){var o=this.resolveDevice(e);if(o){var r=[{id:t,device:e,status:n}];o.getStatesCreator(null,r,function(t,e){t?i&&i(t):i&&i(null,e[0]);});}else i&&i(new Error("device json format invalid"));},t.prototype.discoverWithTimeout=function(t,e){var n={};this.discoverDevices(function(t){t&&t.uuid&&!n[t.uuid]&&(n[t.uuid]=t);}),setTimeout(function(){var t=[];for(var i in n)n.hasOwnProperty(i)&&t.push(n[i]);e&&e(null,t);},t);},t;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.wemo.Handler());