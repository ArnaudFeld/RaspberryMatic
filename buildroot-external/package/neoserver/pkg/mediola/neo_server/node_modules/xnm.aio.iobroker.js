var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.iobroker=xnm.aio.iobroker||{};
xnm.aio.iobroker.SimpleAPI=function(){var d=function(b,c,a,e,g){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.iobroker.SimpleAPI");this.ip=b;this.port=c;this.port||(this.port=8087);this.username=a;this.password=e;this.https=g;this._getStatesCBs=[]};d.prototype.executeCommand=function(b,c,a){if(b&&b.id)if(c&&c.value)switch(c.value){case "setValue":if(void 0==c.ext||null==c.ext){a&&a(Error("value invalid"));break}this._set(b.id,
{value:c.ext},a);break;case "toggleValue":this._toggle(b.id,a);break;default:a&&a(Error("unknown command"))}else a&&a(Error("command invalid"));else a&&a(Error("device invalid"))};d.prototype.getStates=function(b,c){var a=this._getStatesCBs.length;this._getStatesCBs.push(c);if(!(0<a)){var e=this;this._states(null,function(a,c){var f=e._getStatesCBs,d=0,l=null;e._getStatesCBs=[];if(!a)if(b&&0!=b.length)for(l={},d=0;d<b.length;d++)c[b[d]]&&(l[b[d]]=c[b[d]].val);else l=c;for(d=0;d<f.length;d++)f[d]&&
f[d](a,l)})}};d.prototype.executeCommandCreator=function(b,c,a){c&&c.value?b&&b.id?(c=this._resolveCommand(b,c))?this.executeCommand(b,c,function(b){a&&a(b)}):a&&a(Error("unknown command")):a&&a(Error("device json invalid")):a&&a(Error("command json invalid"))};d.prototype._resolveCommand=function(b,c){if(!c)return null;if("setGenValue"==c.value){var a=c.ext;if("undefined"==typeof a||null==a)a="";return{value:"setValue",ext:a}}if("toggle"==c.value)return{value:"toggleValue",ext:a};if(!b.common||!c.value)return null;
switch(b.common.type){case "boolean":switch(c.value){case "on":case "press":case "longPress":case "stop":case "start":case "open":case "unlock":case "play":case "next":case "prev":case "pause":case "forward":case "reverse":case "fastforward":case "fastreverse":return{value:"setValue",ext:!0};case "off":case "lock":return{value:"setValue",ext:!1}}break;case "number":var a=b.common.min,e=b.common.max;switch(c.value){case "setValue":if("undefined"==typeof c.ext||null==c.ext)return null;var g=parseFloat(c.ext);
if(isNaN(g))return null;"undefined"==typeof a||null==a||isNaN(parseFloat(a))||g<parseFloat(a)&&(g=parseFloat(a));"undefined"==typeof e||null==e||isNaN(parseFloat(e))||g>parseFloat(e)&&(g=parseFloat(e));return{value:"setValue",ext:g};case "setRGB":return"undefined"==typeof c.ext||null==c.ext?null:{value:"setValue",ext:cparseInt(c.ext,16)}}break;case "string":return"undefined"==typeof c.ext||null==c.ext?null:{value:"setValue",ext:c.ext};default:return null}};d.prototype.getStatesCreator=function(b,
c,a){if(c)if(0==c.length)a&&a(null,[]);else{b=[];for(var e=0;e<c.length;e++){var g=c[e];g&&g.device&&g.device.id&&-1==b.indexOf(g.device.id)&&b.push(g.device.id)}var d=this;this.getStates(b,function(b,e){if(b)a&&a(b);else{for(var g=[],n=0;n<c.length;n++){var m=c[n];if(m&&m.id){var p=null;m.device&&m.device.id&&m.status&&(p=e[m.device.id],p=d._resolveState(m.device,m.status,p));if("undefined"==typeof p||null==p)p="?";g.push({id:m.id,status:p})}}a&&a(null,g)}})}else a&&a(Error("deviceList is null"))};
d.prototype._resolveState=function(b,c,a){if("undefined"==typeof a||null==a)return null;if(!c||!c.value||"genValue"==c.value)return a;if(!b||!b.common)return null;switch(b.common.type){case "boolean":switch(b.common.role){case "state":case "sensor.light":case "sensor.motion":case "sensor.rain":case "switch":case "switch.boost":case "switch.light":case "switch.comfort":case "media.mode.shuffle":case "media.mode.repeat":case "media.mute":return a?"on":"off";case "sensor.window":case "sensor.door":return a?
"open":"closed";case "sensor.lock":case "switch.lock":case "switch.lock.door":case "switch.lock.window":return a?"unlock":"lock";case "media.state":return a?"play":"stop";default:return a}case "number":switch(b.common.role){case "value.window":return b.common.states?b.common.states[a]:{0:"closed",1:"titled",2:"open"}[a];case "value.time":return parseInt(a);case "media.state":return b.common.states?b.common.states[a]:{0:"play",1:"stop",2:"pause"}[a];default:return b.common.states?b.common.states[a]:
parseFloat(a)}case "string":return a;default:return a}};d.prototype.getStateObjectTree=function(b){var c=[],a=this;this._objects("instance",null,function(e,g){if(e)b&&b(e);else{var d=0,f;for(f in g)d++,a._insertTree(c,{id:f,name:f,type:g[f].type,children:[]});a._logger.log("debug","Found "+d+" instances.");a._objects("device",null,function(e,g){if(e)b&&b(e);else{var d=0,f;for(f in g)d++,a._insertTree(c,{id:f,name:f,type:g[f].type,children:[]});a._logger.log("debug","Found "+d+" devices.");a._objects("channel",
null,function(e,g){if(e)b&&b(e);else{var d=0,f;for(f in g)d++,a._insertTree(c,{id:f,name:f,type:g[f].type,children:[]});a._logger.log("debug","Found "+d+" channels.");a._objects("state",null,function(e,g){if(e)b&&b(e);else{var d=0,f;for(f in g){d++;var m=g[f];a._insertTree(c,{sys:"iobroker",id:f,name:f,type:m.type,common:m.common})}a._logger.log("debug","Found "+d+" states.");a._logger.log("debug","Final tree has length of: "+c.length);b&&b(null,c)}})}})}})}})};d.prototype._insertTree=function(b,
c){if(b&&c){var a=c.name;"system.adapter."==a.substr(0,15)&&(a=a.substr(15),c.name=a);for(var e=0;e<b.length;e++){var g=b[e];if(g.name&&a.substr(0,g.name.length+1)==g.name+"."){c.name=a.substr(g.name.length+1);this._insertTree(g.children,c);return}}b.push(c)}};d.prototype.getAllAdapters=function(b){this._objects("adapter",null,function(b,a){console.log(b,a)})};d.prototype._objects=function(b,c,a){var e=null;if(b||c)e={};b&&(e.type=b);c&&(e.pattern=c);this._doRequest("GET","/objects",e,null,function(b,
c){a&&a(b,c)})};d.prototype._getBulk=function(b,c){this._doRequest("GET","/getBulk/"+encodeURIComponent(b.join(",")),null,null,function(a,b){c&&c(a,b)})};d.prototype._get=function(b,c){var a=null,a=isArray(b)?encodeURIComponent(b.join(",")):encodeURIComponent(b);this._doRequest("GET","/get/"+a,null,null,function(a,b){c&&c(a,b)})};d.prototype._set=function(b,c,a){this._doRequest("GET","/set/"+encodeURIComponent(b),c,null,function(b,c){a&&a(b,c)})};d.prototype._toggle=function(b,c){this._doRequest("GET",
"/toggle/"+encodeURIComponent(b),null,null,function(a,b){c&&c(a,b)})};d.prototype._states=function(b,c){var a=null;b&&(a={pattern:b});this._doRequest("GET","/states",a,null,function(a,b){c&&c(a,b)})};d.prototype._doRequest=function(b,c,a,e,d){c||(c="/");var h={};a&&(h=JSON.parse(JSON.stringify(a)));this.username&&(h.user=this.username,h.pass=this.password);a="";for(var f in h)h.hasOwnProperty(f)&&(a&&(a+="&"),a+=f+"="+encodeURIComponent(h[f]));a&&(c+="?"+a);b={host:this.ip,port:this.port,path:c,method:b,
headers:{Connection:"close","Content-Type":"application/json;  charset=UTF-8"}};e&&(b.headers["Content-Length"]=e.length);f=require("http");this.https&&(f=require("https"),"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"));this._logger.log("trace","do request:"+JSON.stringify(b));var k=this,l=d,n=f.request(b,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){k._logger.log("trace","receive code:"+a.statusCode+
" headers:"+JSON.stringify(a.headers)+" response:"+b);var c,e;if(200==a.statusCode)try{e=b?JSON.parse(b):{}}catch(d){c=d}else c=Error("http reponse:"+a.statusCode);l&&(l(c,e,a.statusCode),l=null)})});if(n.on)n.on("error",function(a){k._logger.log("trace","do request error:"+a.message);l&&(l(a),l=null)});n.setTimeout&&n.setTimeout(1E4,function(){k._logger.log("trace","do request timeout");n.abort();l&&(l(Error("timeout")),l=null)});e&&(this._logger.log("trace","do request send body:"+e),n.write(e));
n.end()};d.prototype.toJSON=function(){return{sys:"iobroker",ip:this.ip,port:this.port,username:this.username,password:this.password,https:this.https}};d.prototype.equalsTo=function(b){return b&&b instanceof d?this.ip==b.ip&&this.username==b.username&&this.password==b.password:!1};d.parseJSON=function(b){return b.ip?new d(b.ip,b.port,b.username,b.password,b.https):null};return d}();
xnm.aio.iobroker.DM=function(){var d=function(b,c){this.code=b;this.message=c;this.stack=Error().stack};d.prototype=Error();d.prototype.name="ioBrokerDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"ioBroker",getGatewayType:function(){return[{sys:this.SYS,name:"ioBroker"}]},createGateway:function(b,c,a){c=d.ERROR_CODE;b?b.ip?a(null,b):a(new d(c.INVALID,"ip is invalid")):a(new d(c.INVALID,"info is invalid"))},updateGateway:function(b,
c,a,e){b=d.ERROR_CODE;c?c.ip?e(null,c):e(new d(b.INVALID,"ip is invalid")):e(new d(b.INVALID,"update is invalid"))},deleteGateway:function(b,c,a){a()},createDevice:function(b,c,a){var e=d.ERROR_CODE;if(b)if(b.id)if(b.type)if(b.common)if(b.gateway){c=c.data.gateways;var g,h;for(g=0;g<c.length;g++)if(c[g].index===b.gateway){h=c[g];break}h?a&&a(null,b):a(new d(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else a(new d(e.INVALID,"gateway is invalid"));else a(new d(e.INVALID,"common is invalid"));
else a(new d(e.INVALID,"type is invalid"));else a(new d(e.INVALID,"id is invalid"));else a(new d(e.INVALID,"info is invalid"))},updateDevice:function(b,c,a){var e=d.ERROR_CODE;if(b)if(b.id)if(b.type)if(b.common)if(b.gateway){c=c.data.gateways;var g,h;for(g=0;g<c.length;g++)if(c[g].index===b.gateway){h=c[g];break}h?a(null,b):a(new d(e.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else a(new d(e.INVALID,"gateway is invalid"));else a(new d(e.INVALID,"common is invalid"));else a(new d(e.INVALID,
"type is invalid"));else a(new d(e.INVALID,"id is invalid"));else a(new d(e.INVALID,"info is invalid"))},deleteDevice:function(b,c,a){a()},applyUIFilter:function(b,c,a){var e=function(a,b){if("*"==a)return!0;for(var c=!1,e=0;e<a.length;e++)if(a[e]==b){c=!0;break}return c},d=function(a,b,c){var d=[];"command"==c.catagory?a.command&&a.command.forEach(function(a){e(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))}):"status"==c.catagory&&a.status&&a.status.forEach(function(a){e(c.elems,a.type)&&
(a=JSON.parse(JSON.stringify(a)),d.push(a))});return d},h=function(b,c){var e=[],f=null;if(f=xnm.aio.iobroker.DM.getCommandStatusMap(b,a))f=d(f,b,c),e=e.concat(f);return e};if(!b.sys)return null;var f=JSON.parse(JSON.stringify(b)),k=null;if("command"==c.catagory)k=h(b,c),f.command=k;else if("status"==c.catagory)k=h(b,c),f.status=k;else return null;return k&&0!=k.length?f:null},getCommandStatusMap:function(b,c){if(!b||"state"!=b.type||!b.common)return null;var a={command:[],status:[]},e=b.common.min,
d=b.common.max,h=b.common.unit,f=null;if(b.common.write)switch(a.command.push({type:"string",name:"set generic value",ref:{value:"setGenValue",ext:"%s"}}),b.common.type){case "boolean":switch(b.common.role){case "button":a.command.push({type:"enum",name:"press",ref:{value:"press"}});break;case "button.long":a.command.push({type:"enum",name:"long press",ref:{value:"longPress"}});break;case "button.stop":a.command.push({type:"enum",name:"stop",ref:{value:"stop"}});break;case "button.start":a.command.push({type:"enum",
name:"start",ref:{value:"start"}});break;case "button.open.door":case "button.open.window":a.command.push({type:"enum",name:"open",ref:{value:"open"}});break;case "switch.lock":case "switch.lock.door":case "switch.lock.window":a.command.push({type:"enum",name:"unlock",ref:{value:"unlock"}});a.command.push({type:"enum",name:"lock",ref:{value:"lock"}});a.command.push({type:"enum",name:"toggle",ref:{value:"toggle"}});break;case "media.state ":a.command.push({type:"enum",name:"play",ref:{value:"play"}});
a.command.push({type:"enum",name:"stop",ref:{value:"stop"}});a.command.push({type:"enum",name:"toggle",ref:{value:"toggle"}});break;default:a.command.push({type:"enum",name:"on",ref:{value:"on"}}),a.command.push({type:"enum",name:"off",ref:{value:"off"}}),a.command.push({type:"enum",name:"toggle",ref:{value:"toggle"}})}break;case "number":switch(b.common.role){case "level.temperature":f={type:"float",name:"set value",ref:{value:"setValue",ext:"%f",extMeta:"5.0-40.0"}};if("undefined"==typeof e||null==
e)e=5;if("undefined"==typeof d||null==d)d=40;f.ref.extMeta=e+"-"+d;h&&(f.ref.unit=h);a.command.push(f);break;case "level.color.red":case "level.color.green":case "level.color.blue":case "level.color.white":f={type:"float",name:"set value",ref:{value:"setValue",ext:"%f",extMeta:"0-255"}};if("undefined"==typeof e||null==e)e=0;if("undefined"==typeof d||null==d)d=255;f.ref.extMeta=e+"-"+d;h&&(f.ref.unit=h);a.command.push(f);break;case "level.color.rgb":f={type:"float",name:"set value",ref:{value:"setValue",
ext:"%f",extMeta:"0-16777215"}};if("undefined"==typeof e||null==e)e=0;if("undefined"==typeof d||null==d)d=16777215;f.ref.extMeta=e+"-"+d;h&&(f.ref.unit=h);a.command.push(f);f={type:"rgb",name:"set RGB",ref:{value:"setRGB",ext:"%s"}};a.command.push(f);break;default:f={type:"float",name:"set value",ref:{value:"setValue",ext:"%f",extMeta:"0-100"}};if("undefined"==typeof e||null==e)e=0;if("undefined"==typeof d||null==d)d=100;f.ref.extMeta=e+"-"+d;h&&(f.ref.unit=h);a.command.push(f)}break;case "string":a.command.push({type:"string",
name:"set value",ref:{value:"setValue",ext:"%s"}})}if(b.common.read||"undefined"==typeof b.common.read)switch(a.status.push({type:"string",name:"generic value",ref:{value:"genValue"}}),b.common.type){case "boolean":switch(b.common.role){case "state":case "sensor.light":case "sensor.motion":case "sensor.rain":case "switch":case "switch.boost":case "switch.light":case "switch.comfort":case "media.mode.shuffle":case "media.mode.repeat":case "media.mute":a.status.push({type:"enum",name:"state",ref:{value:"state",
options:["on","off"]}});break;case "sensor.window":case "sensor.door":a.status.push({type:"enum",name:"state",ref:{value:"state",options:["open","closed"]}});break;case "sensor.lock":case "switch.lock":case "switch.lock.door":case "switch.lock.window":a.status.push({type:"enum",name:"state",ref:{value:"state",options:["unlock","lock"]}});break;case "media.state":a.status.push({type:"enum",name:"state",ref:{value:"state",options:["play","stop"]}});break;default:a.status.push({type:"enum",name:"state",
ref:{value:"state",options:["true","false"]}})}break;case "number":switch(b.common.role){case "value.window":var f={type:"enum",name:"state",ref:{value:"state",options:[]}},k;for(k in b.common.states)b.common.states.hasOwnProperty(k)&&(e=b.common.states[k],"undefined"!=typeof e&&null!=e&&f.ref.options.push(e));0==f.ref.options.length&&(f.ref.options=["closed","tilted","open"]);a.status.push(f);break;case "value.time":a.status.push({type:"int",name:"state",ref:{value:"state"}});break;case "media.state":f=
{type:"enum",name:"state",ref:{value:"state",options:[]}};for(k in b.common.states)b.common.states.hasOwnProperty(k)&&(e=b.common.states[k],"undefined"!=typeof e&&null!=e&&f.ref.options.push(e));0==f.ref.options.length&&(f.ref.options=["play","stop","pause"]);a.status.push(f);break;default:if(b.common.states)for(k in f={type:"enum",name:"state",ref:{value:"state",options:[]}},b.common.states)b.common.states.hasOwnProperty(k)&&(e=b.common.states[k],"undefined"!=typeof e&&null!=e&&f.ref.options.push(e));
else{f={type:"float",name:"state",ref:{value:"state"}};if("undefined"!=typeof e&&null!=e&&"undefined"==typeof d||null!=d)f.ref.extMeta=e+"-"+d;h&&(f.ref.unit=h)}a.status.push(f)}break;case "string":a.status.push({type:"string",name:"state",ref:{value:"state"}})}return a}}}();
xnm.aio.iobroker.Handler=function(){var d=function(){};d.prototype.devicemanager=xnm.aio.iobroker.DM;d.prototype.SimpleAPI=xnm.aio.iobroker.SimpleAPI;d.prototype.registModule=function(b){b.register(this.devicemanager.SYS,"iobroker")};d.prototype.resolveGateway=function(b){return b?this.SimpleAPI.parseJSON(b):null};d.prototype.getDeviceCommands=function(b,c){var a=this.devicemanager.applyUIFilter(b,{catagory:"command",elems:"*"}),a=a?a.command:[];c&&c(null,a)};d.prototype.getDeviceStatus=function(b,
c){var a=this.devicemanager.applyUIFilter(b,{catagory:"status",elems:"*"}),a=a?a.status:[];c&&c(null,a)};d.prototype.doCommand=function(b,c,a,e){(b=this.resolveGateway(b))?b.executeCommandCreator(c,a,function(a){e&&e(a)}):e&&e(Error("gateway json format invalid"))};d.prototype.doStatus=function(b,c,a,e,d){(c=this.resolveGateway(c))?c.getStatesCreator(null,[{id:b,device:a,status:e}],function(a,b){a?d&&d(a):d&&d(null,b[0])}):d&&d(Error("gateway json format invalid"))};d.prototype.getDeviceList=function(b,
c){var a=this.resolveGateway(b);a?a.getStateObjectTree(function(a,b){c&&c(a,b)}):c&&c(Error("gateway json format invalid"))};return d}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.iobroker.Handler);
