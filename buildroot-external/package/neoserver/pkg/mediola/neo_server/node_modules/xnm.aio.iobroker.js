var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(c,b,a){c instanceof String&&(c=String(c));for(var d=c.length,e=0;e<d;e++){var f=c[e];if(b.call(a,f,e,c))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(c,b,a){c!=Array.prototype&&c!=Object.prototype&&(c[b]=a.value)};
$jscomp.getGlobal=function(c){return"undefined"!=typeof window&&window===c?c:"undefined"!=typeof global&&null!=global?global:c};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(c,b,a,d){if(b){a=$jscomp.global;c=c.split(".");for(d=0;d<c.length-1;d++){var e=c[d];e in a||(a[e]={});a=a[e]}c=c[c.length-1];d=a[c];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(a,c,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Array.prototype.find",function(c){return c?c:function(b,a){return $jscomp.findInternal(this,b,a).v}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.iobroker=xnm.aio.iobroker||{};
xnm.aio.iobroker.SimpleAPI=function(){var c=function(b,a,d,e,c){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.iobroker.SimpleAPI");this.ip=b;this.port=a;this.port||(this.port=8087);this.username=d;this.password=e;this.https=c};Zeptrion.prototype.getDevice=function(b,a,d,e){var c=this;$.ajax({url:"http://"+this.ip+"/zrap/net",method:"POST",data:{ssid:b,pw:a,enc:d},statusCode:{302:function(){c._reboot(function(a){e&&e(a)})}}})};
Zeptrion.prototype._reboot=function(b){$.ajax({url:"http://"+this.ip+"/zrap/sys",method:"POST",data:{cmd:"reboot"},statusCode:{302:function(){var a="Device is now in network: "+ssid;b&&b(a)}}})};Zeptrion.prototype.getState=function(b,a){this._doRequest("/zrap/chscan/ch"+b,function(d,e){d=$.parseXML(e);d=$(d).find("ch"+b);d=d[0]._children[0]._value;a&&a(d)})};Zeptrion.prototype.chScan=function(b){this._doRequest("GET","/zrap/chscan",null,function(a,d){if(a)b&&b(a);else try{var e=$($.parseXML(d));if(e){a=
{};var c=e.find("ch1 val");c&&0<c.length&&(a.ch1=$(c[0]).text());var h=e.find("ch2 val");h&&0<h.length&&(a.ch2=$(h[0]).text());var g=e.find("ch3 val");g&&0<g.length&&(a.ch3=$(g[0]).text());var l=e.find("ch4 val");l&&0<l.length&&(a.ch4=$(l[0]).text());b&&b(null,a)}else b&&b(Error("chscan response invalid"))}catch(k){b&&b(k)}})};Zeptrion.prototype.notify=function(b,a){this._doRequest("/zrap/chnotify/ch"+b,function(d,e){e=$.parseXML(e);b=$(e).find("ch"+b);e=b[0]._children[0]._value;var c={state:"?",
current:"?"};!d&&e&&(100==e?c.state="on":0==e?c.state="off":-1==e&&(c.state="?"),a&&a(c))})};Zeptrion.prototype.parseState=function(b,a){a=parseInt(a);switch(b){case "switch":return{state:0==a?"off":"on"};case "dimmer":return{state:a};default:return null}};c.prototype.executeCommand=function(b,a,d){a?b?this._doRequest("POST","/zrap/chctrl/ch"+a,"cmd="+b,function(a){a&&302==a.code&&(a=null);d&&d(a)}):d&&d(Error("command is null")):d&&d(Error("channel is null"))};c.prototype.executeCommandCreator=function(b,
a,d){if(a&&a.value)if(b&&b.id){var c=a.value;switch(a.value){case "recall_s":case "store_s":case "delete_s":if(!a.ext){d&&d(Error("command ext invalid"));return}c+=a.ext}this.executeCommand(c,b.address,function(a){d&&d(a)})}else d&&d(Error("device json invalid"));else d&&d(Error("command json invalid"))};Zeptrion.prototype.getStatesCreator=function(b,a,d){if(a)if(0==a.length)d&&d(null,[]);else{var c=this;this.chScan(function(b,e){if(b)d&&d(b);else{b=[];for(var f=0;f<a.length;f++)if(a[f].id){var h=
"?";if(a[f].status&&a[f].status.value&&a[f].device&&a[f].device.address){var k="ch"+a[f].device.address;e&&e[k]&&(k=c.parseState(a[f].device.type,e[k]))&&(h=k[a[f].status.value]);if("undefined"==typeof h||null==h)h="?"}b.push({id:a[f].id,status:h})}d&&d(null,b)}})}else d&&d(Error("deviceList is null"))};c.prototype._objects=function(b,a,d){var c=null;if(b||a)c={pattern:a,type:b};this._doRequest("GET","/objects",c,null,function(a,b){d&&d(a,b)})};c.prototype._getBulk=function(b,a){this._doRequest("GET",
"/getBulk/"+encodeURIComponent(b.join(",")),null,null,function(b,c){a&&a(b,c)})};c.prototype._get=function(b,a){var d=null;d=isArray(b)?encodeURIComponent(b.join(",")):encodeURIComponent(b);this._doRequest("GET","/get/"+d,null,null,function(b,d){a&&a(b,d)})};c.prototype._set=function(b,a,d){this._doRequest("GET","/set/"+encodeURIComponent(b),a,null,function(a,b){d&&d(a,b)})};c.prototype._toggle=function(b,a){this._doRequest("GET","/toggle/"+encodeURIComponent(b),null,null,function(b,c){a&&a(b,c)})};
c.prototype._states=function(b,a){var d=null;b&&(d={pattern:b});this._doRequest("GET","/states",d,null,function(b,d){a&&a(b,d)})};c.prototype._doRequest=function(b,a,d,c,f){a||(a="/");var e={};d&&(e=JSON.parse(JSON.stringify(d)));this.username&&(e.user=this.username,e.pass=this.password);d="";for(var g in e)e.hasOwnProperty(g)&&(d&&(d+="&"),d+=g+"="+encodeURIComponent(e[g]));d&&(a+="?"+d);b={host:this.ip,port:this.port,path:a,method:b,headers:{Connection:"close","Content-Type":"application/json;  charset=UTF-8"}};
c&&(b.headers["Content-Length"]=c.length);g=require("http");this.https&&(g=require("https"),"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"));this._logger.log("trace","do request:"+JSON.stringify(b));var l=this,k=f,m=g.request(b,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){l._logger.log("trace","receive code:"+a.statusCode+" headers:"+JSON.stringify(a.headers)+" response:"+b);if(200==a.statusCode)try{var d=
b?JSON.parse(b):{}}catch(q){var c=q}else c=Error("http reponse:"+a.statusCode);k&&(k(c,d,a.statusCode),k=null)})});if(m.on)m.on("error",function(a){l._logger.log("trace","do request error:"+a.message);k&&(k(a),k=null)});m.setTimeout&&m.setTimeout(2E3,function(){l._logger.log("trace","do request timeout");m.abort();k&&(k(Error("timeout")),k=null)});c&&(this._logger.log("trace","do request send body:"+c),m.write(c));m.end()};c.prototype.toJSON=function(){return{sys:"iobroker",ip:this.ip,port:this.port,
username:this.username,password:this.password,https:this.https}};c.prototype.equalsTo=function(b){return b&&b instanceof c?this.ip==b.ip&&this.username==b.username&&this.password==b.password:!1};c.parseJSON=function(b){return b.ip?new c(b.ip,b.port,b.username,b.password,b.https):null};return c}();
xnm.aio.iobroker.DM=function(){var c=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};c.prototype=Error();c.prototype.name="FellerDMError";c.prototype.code=0;c.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var b={"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"call scene",ref:{value:"recall_s",ext:"%d",extMeta:"1-4"}},
{type:"int",name:"store scene",ref:{value:"store_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"delete scene",ref:{value:"delete_s",ext:"%d",extMeta:"1-4"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["off","on"]}}]},dimmer:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"enum",name:"dim up",ref:{value:"dim_up"}},{type:"enum",name:"dim down",ref:{value:"dim_down"}},{type:"enum",name:"stop",
ref:{value:"stop"}},{type:"int",name:"call scene",ref:{value:"recall_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"store scene",ref:{value:"store_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"delete scene",ref:{value:"delete_s",ext:"%d",extMeta:"1-4"}}],status:[{type:"int",name:"state",ref:{value:"state",extMeta:"0-100"}}]},blind:{command:[{type:"enum",name:"move up",ref:{value:"move_open"}},{type:"enum",name:"move close",ref:{value:"move_close"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"int",
name:"call scene",ref:{value:"recall_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"store scene",ref:{value:"store_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"delete scene",ref:{value:"delete_s",ext:"%d",extMeta:"1-4"}}]}};return{SYS:"feller",getGatewayType:function(){return[{sys:this.SYS,name:"Feller Zeptrion",subtypes:[{id:"Switch",type:"switch"},{id:"Dimmer",type:"dimmer"},{id:"Blind",type:"blind"}]}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"switch",name:"Switch"},{sys:this.SYS,
type:"dimmer",name:"Dimmer"},{sys:this.SYS,type:"blind",name:"Blind"}]},createGateway:function(a,b,e){b=c.ERROR_CODE;a?a.ip?a.port?a.type?e(null,a):e(new c(b.INVALID,"type is invalid")):e(new c(b.INVALID,"port is invalid")):e(new c(b.INVALID,"ip is invalid")):e(new c(b.INVALID,"info is invalid"))},updateGateway:function(a,b,e,f){a=c.ERROR_CODE;b?b.ip?b.port?b.type?f(null,b):f(new c(a.INVALID,"type is invalid")):f(new c(a.INVALID,"port is invalid")):f(new c(a.INVALID,"ip is invalid")):f(new c(a.INVALID,
"update is invalid"))},deleteGateway:function(a,b,c){c()},createDevice:function(a,b,e){var d=c.ERROR_CODE;if(a)if(a.address)if(a.type)if(a.gateway){b=b.data.gateways;var h;for(h=0;h<b.length;h++)if(b[h].index===a.gateway){var g=b[h];break}g?e&&e(null,a):e(new c(d.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else e(new c(d.INVALID,"gateway is invalid"));else e(new c(d.INVALID,"type is invalid"));else e(new c(d.INVALID,"address is invalid"));else e(new c(d.INVALID,"info is invalid"))},
updateDevice:function(a,b,e){var d=c.ERROR_CODE;if(a)if(a.address)if(a.type)if(a.gateway){b=b.data.gateways;var h;for(h=0;h<b.length;h++)if(b[h].index===a.gateway){var g=b[h];break}g?e(null,a):e(new c(d.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else e(new c(d.INVALID,"gateway is invalid"));else e(new c(d.INVALID,"type is invalid"));else e(new c(d.INVALID,"address is invalid"));else e(new c(d.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){c()},applyUIFilter:function(a,b,
c){var d=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},e=function(a,b,c){var e=[];"command"==c.catagory?a.command&&a.command.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))}):"status"==c.catagory&&a.status&&a.status.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});return e},g=function(a,b){var d=[],f=xnm.aio.feller.DM.getCommandStatusMap(a,c);f&&(a=e(f,a,b),d=d.concat(a));return d};
if(!a.sys)return null;var l=JSON.parse(JSON.stringify(a)),k=null;if("command"==b.catagory)k=g(a,b),l.command=k;else if("status"==b.catagory)k=g(a,b),l.status=k;else return null;return k&&0!=k.length?l:null},getCommandStatusMap:function(a,c){return a.type?b[a.type]:null}}}();
xnm.aio.iobroker.Handler=function(){var c=function(){};c.prototype.devicemanager=xnm.aio.feller.DM;c.prototype.Zeptrion=xnm.aio.feller.Zeptrion;c.prototype.registModule=function(b){b.register(this.devicemanager.SYS,"feller")};c.prototype.resolveGateway=function(b){return b?this.Zeptrion.parseJSON(b):null};c.prototype.getDeviceCommands=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,{catagory:"command",elems:"*"}))?b.command:[];a&&a(null,b)};c.prototype.getDeviceStatus=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,
{catagory:"status",elems:"*"}))?b.status:[];a&&a(null,b)};c.prototype.doCommand=function(b,a,c,e){(b=this.resolveGateway(b))?b.executeCommandCreator(a,c,function(a){e&&e(a)}):e&&e(Error("gateway json format invalid"))};c.prototype.doStatus=function(b,a,c,e,f){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:b,device:c,status:e}],function(a,b){a?f&&f(a):f&&f(null,b[0])}):f&&f(Error("gateway json format invalid"))};c.prototype.discover=function(b,a){var c=this,e=require("x.mdns.js");e.clearRecordBuffer();
var f={},h=2;e.discoverServiceWithTimeout("_zapp._tcp.local",b,function(b,d){h--;if(b)a&&a(b);else{for(b=0;b<d.length;b++){var e=d[b];if(e.target&&e.ip&&0<e.ip.length){var g=e.target.toLowerCase(),l=g.indexOf("-"),n=g.indexOf(".");g=g.substring(l+1,n);f[g]=new c.Zeptrion(e.ip[0],null,e.info.type,g)}}if(0==h){d=[];for(var p in f)d.push(f[p]);a&&a(null,d)}}});e.discoverServiceWithTimeout("_http._tcp.local",b,function(b,d){h--;if(b)a&&a(b);else{for(b=0;b<d.length;b++){var e=d[b];if(e.target&&e.ip&&0<
e.ip.length){var g=e.target.toLowerCase();if("zapp"==g.substr(0,4)){var l=g.indexOf("-"),n=g.indexOf(".");g=g.substring(l+1,n);e=new c.Zeptrion(e.ip[0],null,e.info.type,g);f[g]||(f[g]=e)}}}if(0==h){d=[];for(var p in f)d.push(f[p]);a&&a(null,d)}}})};c.prototype.getDeviceList=function(b,a){b&&b.type?0==b.type.indexOf("3340-4")?a&&a(null,[{sys:"feller",address:1,type:""},{sys:"feller",address:2,type:""},{sys:"feller",address:3,type:""},{sys:"feller",address:4,type:""}]):0==b.type.indexOf("3340-2")?a&&
a(null,[{sys:"feller",address:1,type:""},{sys:"feller",address:2,type:""}]):a&&a(Error("unknow gateway type")):a&&a(Error("gateway json invalid"))};return c}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.feller.Handler);
