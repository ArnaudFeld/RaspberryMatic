var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.iobroker=xnm.aio.iobroker||{},xnm.aio.iobroker.SimpleAPI=function(){var SimpleAPI=function SimpleAPI(e,t,n,a,o){"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.iobroker.SimpleAPI"),this.ip=e,this.port=t,this.port||(this.port=8087),this.username=n,this.password=a,this.https=o,this._getStatesCBs=[];};return SimpleAPI.prototype.executeCommand=function(e,t,n){if(e&&e.id){if(t&&t.value)switch(t.value){case"setValue":if(null==t.ext||null==t.ext)return void(n&&n(new Error("value invalid")));this._set(e.id,{value:t.ext},n);break;case"toggleValue":this._toggle(e.id,n);break;default:n&&n(new Error("unknown command"));}else n&&n(new Error("command invalid"));}else n&&n(new Error("device invalid"));},SimpleAPI.prototype.getStates=function(e,t){var n=this._getStatesCBs.length;if(this._getStatesCBs.push(t),!(n>0)){var a=this,o=null;if(1===e.length)o=e[0];else if(e.length>1){e.sort(function(e,t){return e.length-t.length;});for(var s=e[0].split("."),r="",i=0,l=Math.min(s.length,8);i<l;){for(var u=r+s[i],c=!1,m=1;m<e.length;m++){if(0!==e[m].indexOf(u)){c=!0;break;}}if(c)break;r=u+".",i++;}r&&("."===r[r.length-1]&&(r=r.substr(0,r.length-1)),o=r+"*",XC.debugf("ioBroker states pattern: "+o));}this._states(o,function(t,n){var o=a._getStatesCBs,s=0,r=null;if(a._getStatesCBs=[],t)XC.debugf(t.message,"error");else if(e&&0!=e.length)for(r={},s=0;s<e.length;s++){n[e[s]]&&(r[e[s]]=n[e[s]].val);}else r=n;for(s=0;s<o.length;s++){o[s]&&o[s](t,r);}});}},SimpleAPI.prototype.executeCommandCreator=function(e,t,n){if(t&&t.value){if(e&&e.id){var a=this._resolveCommand(e,t);a?this.executeCommand(e,a,function(e){n&&n(e);}):n&&n(new Error("unknown command"));}else n&&n(new Error("device json invalid"));}else n&&n(new Error("command json invalid"));},SimpleAPI.prototype._resolveCommand=function(e,t){if(!t)return null;if("setGenValue"==t.value){var n=t.ext;return void 0!==n&&null!=n||(n=""),{value:"setValue",ext:n};}if("toggle"==t.value)return{value:"toggleValue"};if(!e.common)return null;if(!t.value)return null;switch(e.common.type){case"boolean":switch(t.value){case"on":case"press":case"longPress":case"stop":case"start":case"open":case"unlock":case"play":case"next":case"prev":case"pause":case"forward":case"reverse":case"fastforward":case"fastreverse":return{value:"setValue",ext:!0};case"off":case"lock":return{value:"setValue",ext:!1};}break;case"number":var a=e.common.min,o=e.common.max;switch(t.value){case"setValue":if(void 0===t.ext||null==t.ext)return null;var s=parseFloat(t.ext);return isNaN(s)?null:(void 0===a||null==a||isNaN(parseFloat(a))||s<parseFloat(a)&&(s=parseFloat(a)),void 0===o||null==o||isNaN(parseFloat(o))||s>parseFloat(o)&&(s=parseFloat(o)),{value:"setValue",ext:s});case"setRGB":return void 0===t.ext||null==t.ext?null:{value:"setValue",ext:cparseInt(t.ext,16)};}break;case"string":return void 0===t.ext||null==t.ext?null:{value:"setValue",ext:t.ext};default:return null;}},SimpleAPI.prototype.getStatesCreator=function(e,t,n){if(t){if(0!=t.length){for(var a=[],o=0;o<t.length;o++){var s=t[o];s&&s.device&&s.device.id&&-1==a.indexOf(s.device.id)&&a.push(s.device.id);}var r=this;this.getStates(a,function(e,a){if(e)n&&n(e);else{for(var o=[],s=0;s<t.length;s++){var i=t[s];if(i&&i.id){var l=null;i.device&&i.device.id&&i.status&&(l=a[i.device.id],l=r._resolveState(i.device,i.status,l)),void 0!==l&&null!=l||(l="?"),o.push({id:i.id,status:l});}}n&&n(null,o);}});}else n&&n(null,[]);}else n&&n(new Error("deviceList is null"));},SimpleAPI.prototype._resolveState=function(e,t,n){if(void 0===n||null==n)return null;if(!t||!t.value)return n;if("genValue"==t.value)return n;if(!e||!e.common)return null;switch(e.common.type){case"boolean":switch(e.common.role){case"state":case"sensor.light":case"sensor.motion":case"sensor.rain":case"switch":case"switch.boost":case"switch.light":case"switch.comfort":case"media.mode.shuffle":case"media.mode.repeat":case"media.mute":return n?"on":"off";case"sensor.window":case"sensor.door":return n?"open":"closed";case"sensor.lock":case"switch.lock":case"switch.lock.door":case"switch.lock.window":return n?"unlock":"lock";case"media.state":return n?"play":"stop";default:return n;}case"number":switch(e.common.role){case"value.window":return e.common.states?e.common.states[n]:{0:"closed",1:"titled",2:"open"}[n];case"value.time":return parseInt(n);case"media.state":return e.common.states?e.common.states[n]:{0:"play",1:"stop",2:"pause"}[n];default:return e.common.states?e.common.states[n]:parseFloat(n);}default:return n;}},SimpleAPI.prototype.getStateObjectTree=function(e){var t=[],n=this;this._objects("instance",null,function(a,o){if(a)e&&e(a);else{var s=0;for(var r in o){s++;var i={id:r,name:r,type:o[r].type,children:[]};n._insertTree(t,i);}n._logger.log("debug","Found "+s+" instances."),n._objects("device",null,function(a,o){if(a)e&&e(a);else{var s=0;for(var r in o){s++;var i={id:r,name:r,type:o[r].type,children:[]};n._insertTree(t,i);}n._logger.log("debug","Found "+s+" devices."),n._objects("channel",null,function(a,o){if(a)e&&e(a);else{var s=0;for(var r in o){s++;var i={id:r,name:r,type:o[r].type,children:[]};n._insertTree(t,i);}n._logger.log("debug","Found "+s+" channels."),n._objects("state",null,function(a,o){if(a)e&&e(a);else{var s=0;for(var r in o){s++;var i=o[r],l={sys:"iobroker",id:r,name:r,type:i.type,common:i.common};n._insertTree(t,l);}n._logger.log("debug","Found "+s+" states."),n._logger.log("debug","Final tree has length of: "+t.length),e&&e(null,t);}});}});}});}});},SimpleAPI.prototype._insertTree=function(e,t){if(e&&t){var n=t.name;"system.adapter."==n.substr(0,15)&&(n=n.substr(15),t.name=n);for(var a=0;a<e.length;a++){var o=e[a];if(o.name&&n.substr(0,o.name.length+1)==o.name+".")return t.name=n.substr(o.name.length+1),void this._insertTree(o.children,t);}e.push(t);}},SimpleAPI.prototype.getAllAdapters=function(e){this._objects("adapter",null,function(e,t){console.log(e,t);});},SimpleAPI.prototype._objects=function(e,t,n){var a=null;(e||t)&&(a={}),e&&(a.type=e),t&&(a.pattern=t),this._doRequest("GET","/objects",a,null,function(e,t){n&&n(e,t);});},SimpleAPI.prototype._getBulk=function(e,t){this._doRequest("GET","/getBulk/"+encodeURIComponent(e.join(",")),null,null,function(e,n){t&&t(e,n);});},SimpleAPI.prototype._get=function(e,t){var n=null;n=isArray(e)?encodeURIComponent(e.join(",")):encodeURIComponent(e),this._doRequest("GET","/get/"+n,null,null,function(e,n){t&&t(e,n);});},SimpleAPI.prototype._set=function(e,t,n){this._doRequest("GET","/set/"+encodeURIComponent(e),t,null,function(e,t){n&&n(e,t);});},SimpleAPI.prototype._toggle=function(e,t){this._doRequest("GET","/toggle/"+encodeURIComponent(e),null,null,function(e,n){t&&t(e,n);});},SimpleAPI.prototype._states=function(e,t){var n=null;e&&(n={pattern:e}),this._doRequest("GET","/states",n,null,function(e,n){t&&t(e,n);});},SimpleAPI.prototype._doRequest=function(e,t,n,a,o){var s=t;s||(s="/");var r={};n&&(r=JSON.parse(JSON.stringify(n))),this._logger.log("trace","do request: "+e+" "+t+"? "+r),this.username&&(r.user=this.username,r.pass=this.password);var i="";for(var l in r){r.hasOwnProperty(l)&&(i&&(i+="&"),i+=l+"="+encodeURIComponent(r[l]));}i&&(s+="?"+i);var u={host:this.ip,port:this.port,path:s,method:e,headers:{Connection:"close","Content-Type":"application/json; charset=utf-8"}};a&&(u.headers["Content-Length"]=a.length);var c=require("http");this.https&&(c=require("https"),"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"));var m=this,p=o,d=c.request(u,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){var n,a;if(m._logger.log("trace","receive code:"+e.statusCode+" headers:"+JSON.stringify(e.headers)+" response:"+t),200==e.statusCode)try{a=t?JSON.parse(t):{};}catch(e){n=e;}else n=new Error("http reponse:"+e.statusCode);p&&(p(n,a,e.statusCode),p=null);});});d.on&&d.on("error",function(e){m._logger.log("trace","do request error:"+e.message),p&&(p(e),p=null);}),d.setTimeout&&d.setTimeout(1e4,function(){m._logger.log("trace","do request timeout"),d.abort(),p&&(p(new Error("timeout")),p=null);}),a&&(this._logger.log("trace","do request send body:"+a),d.write(a)),d.end();},SimpleAPI.prototype.toJSON=function(){return{sys:"iobroker",ip:this.ip,port:this.port,username:this.username,password:this.password,https:this.https};},SimpleAPI.prototype.equalsTo=function(e){return!!e&&e instanceof SimpleAPI&&this.ip==e.ip&&this.username==e.username&&this.password==e.password;},SimpleAPI.parseJSON=function(e){return e.ip?new SimpleAPI(e.ip,e.port,e.username,e.password,e.https):null;},SimpleAPI;}(),xnm.aio.iobroker.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="ioBrokerDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"ioBroker",getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"ioBroker"}];},createGateway:function createGateway(e,t,n){var a=DMError,o=DMError.ERROR_CODE;e?e.ip?n(null,e):n(new a(o.INVALID,"ip is invalid")):n(new a(o.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,n,a){var o=DMError,s=DMError.ERROR_CODE;t?t.ip?a(null,t):a(new o(s.INVALID,"ip is invalid")):a(new o(s.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,n){n();},createDevice:function createDevice(e,t,n){var a=DMError,o=DMError.ERROR_CODE;if(e){if(e.id){if(e.type){if(e.common){if(e.gateway){var s,r,i=t.data.gateways;for(s=0;s<i.length;s++){if(i[s].index===e.gateway){r=i[s];break;}}r?n&&n(null,e):n(new a(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else n(new a(o.INVALID,"gateway is invalid"));}else n(new a(o.INVALID,"common is invalid"));}else n(new a(o.INVALID,"type is invalid"));}else n(new a(o.INVALID,"id is invalid"));}else n(new a(o.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,n){var a=DMError,o=DMError.ERROR_CODE;if(e){if(e.id){if(e.type){if(e.common){if(e.gateway){var s,r,i=t.data.gateways;for(s=0;s<i.length;s++){if(i[s].index===e.gateway){r=i[s];break;}}r?n(null,e):n(new a(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else n(new a(o.INVALID,"gateway is invalid"));}else n(new a(o.INVALID,"common is invalid"));}else n(new a(o.INVALID,"type is invalid"));}else n(new a(o.INVALID,"id is invalid"));}else n(new a(o.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,n){n();},applyUIFilter:function applyUIFilter(e,t,n){var _contains=function _contains(e,t){if("*"==e)return!0;for(var n=!1,a=0;a<e.length;a++){if(e[a]==t){n=!0;break;}}return n;},_filter=function _filter(e,t){var a=[],o=null,s=xnm.aio.iobroker.DM.getCommandStatusMap(e,n);return s&&(o=function(e,t,n){var a=[];return"command"==n.catagory?e.command&&e.command.forEach(function(e){if(_contains(n.elems,e.type)){var t=JSON.parse(JSON.stringify(e));a.push(t);}}):"status"==n.catagory&&e.status&&e.status.forEach(function(e){if(_contains(n.elems,e.type)){var t=JSON.parse(JSON.stringify(e));a.push(t);}}),a;}(s,0,t),a=a.concat(o)),a;};if(!e.sys)return null;var a=JSON.parse(JSON.stringify(e)),o=null;if("command"==t.catagory)o=_filter(e,t),a.command=o;else{if("status"!=t.catagory)return null;o=_filter(e,t),a.status=o;}return o&&0!=o.length?a:null;},getCommandStatusMap:function getCommandStatusMap(e,t){if(!e||"state"!=e.type||!e.common)return null;var n={command:[],status:[]},a=e.common.min,o=e.common.max,s=e.common.unit,r=null;if(e.common.write)switch(n.command.push({type:"string",name:"set generic value",ref:{value:"setGenValue",ext:"%s"}}),e.common.type){case"boolean":switch(e.common.role){case"button":n.command.push({type:"enum",name:"press",ref:{value:"press"}});break;case"button.long":n.command.push({type:"enum",name:"long press",ref:{value:"longPress"}});break;case"button.stop":n.command.push({type:"enum",name:"stop",ref:{value:"stop"}});break;case"button.start":n.command.push({type:"enum",name:"start",ref:{value:"start"}});break;case"button.open.door":case"button.open.window":n.command.push({type:"enum",name:"open",ref:{value:"open"}});break;case"switch.lock":case"switch.lock.door":case"switch.lock.window":n.command.push({type:"enum",name:"unlock",ref:{value:"unlock"}}),n.command.push({type:"enum",name:"lock",ref:{value:"lock"}}),n.command.push({type:"enum",name:"toggle",ref:{value:"toggle"}});break;case"media.state ":n.command.push({type:"enum",name:"play",ref:{value:"play"}}),n.command.push({type:"enum",name:"stop",ref:{value:"stop"}}),n.command.push({type:"enum",name:"toggle",ref:{value:"toggle"}});break;default:n.command.push({type:"enum",name:"on",ref:{value:"on"}}),n.command.push({type:"enum",name:"off",ref:{value:"off"}}),n.command.push({type:"enum",name:"toggle",ref:{value:"toggle"}});}break;case"number":switch(e.common.role){case"level.temperature":void 0!==a&&null!=a||(a=5),void 0!==o&&null!=o||(o=40),(r={type:"float",name:"set value",ref:{value:"setValue",ext:"%f",extMeta:"5.0-40.0"}}).ref.extMeta=a+"-"+o,s&&(r.ref.unit=s),n.command.push(r);break;case"level.color.red":case"level.color.green":case"level.color.blue":case"level.color.white":void 0!==a&&null!=a||(a=0),void 0!==o&&null!=o||(o=255),(r={type:"float",name:"set value",ref:{value:"setValue",ext:"%f",extMeta:"0-255"}}).ref.extMeta=a+"-"+o,s&&(r.ref.unit=s),n.command.push(r);break;case"level.color.rgb":void 0!==a&&null!=a||(a=0),void 0!==o&&null!=o||(o=16777215),(r={type:"float",name:"set value",ref:{value:"setValue",ext:"%f",extMeta:"0-16777215"}}).ref.extMeta=a+"-"+o,s&&(r.ref.unit=s),n.command.push(r),r={type:"rgb",name:"set RGB",ref:{value:"setRGB",ext:"%s"}},n.command.push(r);break;default:void 0!==a&&null!=a||(a=0),void 0!==o&&null!=o||(o=100),(r={type:"float",name:"set value",ref:{value:"setValue",ext:"%f",extMeta:"0-100"}}).ref.extMeta=a+"-"+o,s&&(r.ref.unit=s),n.command.push(r);}break;case"string":n.command.push({type:"string",name:"set value",ref:{value:"setValue",ext:"%s"}});}if(e.common.read||void 0===e.common.read)switch(n.status.push({type:"string",name:"generic value",ref:{value:"genValue"}}),e.common.type){case"boolean":switch(e.common.role){case"state":case"sensor.light":case"sensor.motion":case"sensor.rain":case"switch":case"switch.boost":case"switch.light":case"switch.comfort":case"media.mode.shuffle":case"media.mode.repeat":case"media.mute":n.status.push({type:"enum",name:"state",ref:{value:"state",options:["on","off"]}});break;case"sensor.window":case"sensor.door":n.status.push({type:"enum",name:"state",ref:{value:"state",options:["open","closed"]}});break;case"sensor.lock":case"switch.lock":case"switch.lock.door":case"switch.lock.window":n.status.push({type:"enum",name:"state",ref:{value:"state",options:["unlock","lock"]}});break;case"media.state":n.status.push({type:"enum",name:"state",ref:{value:"state",options:["play","stop"]}});break;default:n.status.push({type:"enum",name:"state",ref:{value:"state",options:["true","false"]}});}break;case"number":switch(e.common.role){case"value.window":for(var i in r={type:"enum",name:"state",ref:{value:"state",options:[]}},e.common.states){if(e.common.states.hasOwnProperty(i))void 0!==(l=e.common.states[i])&&null!=l&&r.ref.options.push(l);}0==r.ref.options.length&&(r.ref.options=["closed","tilted","open"]),n.status.push(r);break;case"value.time":n.status.push({type:"int",name:"state",ref:{value:"state"}});break;case"media.state":for(var i in r={type:"enum",name:"state",ref:{value:"state",options:[]}},e.common.states){if(e.common.states.hasOwnProperty(i))void 0!==(l=e.common.states[i])&&null!=l&&r.ref.options.push(l);}0==r.ref.options.length&&(r.ref.options=["play","stop","pause"]),n.status.push(r);break;default:if(e.common.states){for(var i in r={type:"enum",name:"state",ref:{value:"state",options:[]}},e.common.states){var l;if(e.common.states.hasOwnProperty(i))void 0!==(l=e.common.states[i])&&null!=l&&r.ref.options.push(l);}n.status.push(r);}else r={type:"float",name:"state",ref:{value:"state"}},(void 0!==a&&null!=a&&void 0===o||null!=o)&&(r.ref.extMeta=a+"-"+o),s&&(r.ref.unit=s),n.status.push(r);}break;case"string":n.status.push({type:"string",name:"state",ref:{value:"state"}});}return n;}};}(),xnm.aio.iobroker.Handler=function(){var Handler=function Handler(){};return Handler.prototype.devicemanager=xnm.aio.iobroker.DM,Handler.prototype.SimpleAPI=xnm.aio.iobroker.SimpleAPI,Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"iobroker");},Handler.prototype.resolveGateway=function(e){return e?this.SimpleAPI.parseJSON(e):null;},Handler.prototype.getDeviceCommands=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),a=n?n.command:[];t&&t(null,a);},Handler.prototype.getDeviceStatus=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),a=n?n.status:[];t&&t(null,a);},Handler.prototype.doCommand=function(e,t,n,a){var o=this.resolveGateway(e);o?o.executeCommandCreator(t,n,function(e){a&&a(e);}):a&&a(new Error("gateway json format invalid"));},Handler.prototype.doStatus=function(e,t,n,a,o){var s=this.resolveGateway(t);if(s){var r=[{id:e,device:n,status:a}];s.getStatesCreator(null,r,function(e,t){e?o&&o(e):o&&o(null,t[0]);});}else o&&o(new Error("gateway json format invalid"));},Handler.prototype.getDeviceList=function(e,t){var n=this.resolveGateway(e);n?n.getStateObjectTree(function(e,n){t&&t(e,n);}):t&&t(new Error("gateway json format invalid"));},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.iobroker.Handler());