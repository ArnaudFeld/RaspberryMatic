var x=x||{};x.hub=x.hub||{};x.hub.v6=x.hub.v6||{};
x.hub.v6.API=function(){var e=function(a){this._version="v1";this._handler=a};e.prototype.init=function(a,b){var d=this;a.addRoute("/api/"+this._version+"/command",function(c,a){d._handler.command(c.body,function(c,f){a.json(d._buildResponseJSON(c,f))})});a.addRoute("/api/"+this._version+"/state",function(c,a){d._handler.state(c.query,function(c,f){a.json(d._buildResponseJSON(c,f))})});b&&b()};e.prototype.handleTunnelReuqest=function(a,b){var d=a.pathname.split("/"),c=this;"state"==d[3]?this._handler.state(a.query,
function(a,g){b&&b(c._buildResponseJSON(a,g))}):"command"==d[3]?this._handler.command(a.body,function(a,g){b&&b(c._buildResponseJSON(a,g))}):b&&b(c._buildResponseJSON(Error("invalid request")))};e.prototype._buildResponseJSON=function(a,b){if(a){for((b=a.code+"")||(b="0");6>b.length;)b="0"+b;return{XC_ERR:{code:b,msg:a.message}}}return{XC_SUC:b?b:{}}};return{V1:e}}();
x.hub.v6.CentralUnit=function(){var e=function(a){this._api=new x.hub.v6.API.V1(this);this._server=a};e.prototype.init=function(a){this._api.init(this._server,a)};e.prototype.handleTunnelReuqest=function(a,b){this._api.handleTunnelReuqest(a,b)};e.prototype.command=function(a,b){};e.prototype.state=function(a,b){a&&"true"==a.force?this._updatesStates(a,b):b&&b(null,null)};e.prototype._updatesStates=function(a,b){a&&a.id?this._getStates(a.id,function(d,c){d?b&&b(d):c?(d={},d[a.id]={},a.key?d[a.id][a.key]=
c[a.key]:d[a.id]=c,b&&b(null,d)):b&&b(null,{})}):this._updateStatesAll(a.timeout,b)};e.prototype._updateStatesAll=function(a,b){a&&(a*=1E3);require("x.hub.commandman.js").commandHandler2.updateGeneralDeviceStates(a,b)};e.prototype._updateStates=function(a,b){require("x.hub.deviceman.js").deviceManager2.toGeneralDevice(a,function(d,c){if(d)b&&b(d);else if(c)if(c.states&&c.details&&c.details.states){d=[];for(var f in c.details.states){var g=c.details.states[f];g&&g.value&&d.push({id:f,value:g.value})}0==
d.length?b&&b(null,null):require("x.hub.commandman.js").commandHandler2.getStatesWithIdx(a,null,d,function(c){c&&c.data?b&&b(null,c.data):b&&b(Error("get device states error"))})}else b&&b(null,null);else b&&b(Error("can not find general device"))})};return e}();
x.hub.v6.Time=function(){var e=function(a){this._logger=require("x.logger.js").getLogger("x.hub.v6.Time");this._handler=a;this._writeRTCInterval=null;this._tz="8C";this._timezone="Europe/Berlin";this._ntpServers=["0.de.pool.ntp.org","1.de.pool.ntp.org","2.de.pool.ntp.org","3.de.pool.ntp.org"]};e.TimeZone_MAP=[{utc:0,dst:!1,zone:"Etc/UTC"},{utc:0,dst:!0,zone:"CET"},{utc:1,dst:!1,zone:"Etc/GMT-1"},{utc:1,dst:!0,zone:"Europe/Berlin"},{utc:2,dst:!1,zone:"Etc/GMT-2"},{utc:2,dst:!0,zone:"EET"},{utc:3,dst:!1,
zone:"Etc/GMT-3"},{utc:3,dst:!0,zone:"Asia/Tehran"},{utc:4,dst:!1,zone:"Etc/GMT-4"},{utc:4,dst:!0,zone:"Asia/Kabul"},{utc:5,dst:!1,zone:"Etc/GMT-5"},{utc:5,dst:!0,zone:"Etc/GMT-5"},{utc:6,dst:!1,zone:"Etc/GMT-6"},{utc:6,dst:!0,zone:"Etc/GMT-6"},{utc:7,dst:!1,zone:"Etc/GMT-7"},{utc:7,dst:!0,zone:"Asia/Hovd"},{utc:8,dst:!1,zone:"Etc/GMT-8"},{utc:8,dst:!0,zone:"Asia/Ulaanbaatar"},{utc:9,dst:!1,zone:"Etc/GMT-9"},{utc:9,dst:!0,zone:"Australia/Adelaide"},{utc:10,dst:!1,zone:"Etc/GMT-10"},{utc:10,dst:!0,
zone:"Australia/Sydney"},{utc:11,dst:!1,zone:"Etc/GMT-11"},{utc:11,dst:!0,zone:"Etc/GMT-11"},{utc:12,dst:!1,zone:"Etc/GMT-12"},{utc:12,dst:!0,zone:"Pacific/Auckland"},{utc:13,dst:!1,zone:"Etc/GMT-13"},{utc:13,dst:!0,zone:"Pacific/Apia"},{utc:14,dst:!1,zone:"Etc/GMT-14"},{utc:14,dst:!0,zone:"Etc/GMT-14"},{utc:-1,dst:!1,zone:"Etc/GMT+1"},{utc:-1,dst:!0,zone:"Etc/GMT+1"},{utc:-2,dst:!1,zone:"Etc/GMT+2"},{utc:-2,dst:!0,zone:"Etc/GMT+2"},{utc:-3,dst:!1,zone:"Etc/GMT+3"},{utc:-3,dst:!0,zone:"America/Sao_Paulo"},
{utc:-4,dst:!1,zone:"Etc/GMT+4"},{utc:-4,dst:!0,zone:"America/Santiago"},{utc:-5,dst:!1,zone:"Etc/GMT+5"},{utc:-5,dst:!0,zone:"America/New_York"},{utc:-6,dst:!1,zone:"Etc/GMT+6"},{utc:-6,dst:!0,zone:"CST6CDT"},{utc:-7,dst:!1,zone:"Etc/GMT+7"},{utc:-7,dst:!0,zone:"MST7MDT"},{utc:-8,dst:!1,zone:"Etc/GMT+8"},{utc:-8,dst:!0,zone:"PST8PDT"},{utc:-9,dst:!1,zone:"Etc/GMT+9"},{utc:-9,dst:!0,zone:"America/Anchorage"},{utc:-10,dst:!1,zone:"Etc/GMT+10"},{utc:-10,dst:!0,zone:"America/Adak"},{utc:-11,dst:!1,zone:"Etc/GMT+11"},
{utc:-11,dst:!0,zone:"Etc/GMT+11"}];e.TIMEZONE_SCRIPT="/etc/init.d/S00settimezone";e.TIMEZONE_CONF="/etc/timezone";e.NTP_SCRIPT="/etc/init.d/S49ntp";e.NTP_CONF="/etc/ntp.conf";e.WRITE_RTC_PERIOD=6E5;e.prototype.init=function(a){global.SYSTEM_ROOT&&(e.TIMEZONE_SCRIPT=SYSTEM_ROOT+e.TIMEZONE_SCRIPT,e.TIMEZONE_CONF=SYSTEM_ROOT+e.TIMEZONE_CONF,e.NTP_CONF=SYSTEM_ROOT+e.NTP_CONF,e.NTP_SCRIPT=SYSTEM_ROOT+e.NTP_SCRIPT);var b=this;if(localStorage){var d=localStorage.getItem("x.hub.Server.timezone");d&&(b._tz=
d)}this._writeRTCInterval=setInterval(function(){b._writeTimeToRTC()},e.WRITE_RTC_PERIOD);this._readNTPConf(function(){b._readTimezoneConf(function(){a&&a()})})};e.prototype.getNTPServers=function(a){a&&a(null,this._ntpServers)};e.prototype.setNTPServers=function(a,b){if(a&&a.length){var d=a.filter(function(c){return!!c});if(d&&d.length){var c=this;this._handler._sysConf.setValue("NTP",d.join(","),function(a){a?b&&b(a):c._restartNTPD(function(a){a?b&&b(a):(c._ntpServers=d,b&&b())})})}else b&&b(Error("invalid ntp servers"))}else b&&
b(Error("invalid ntp servers"))};e.prototype.getTimezoneEncoded=function(a){a&&a(null,this._tz)};e.prototype.setTimezoneEncoded=function(a,b){if(a){var d=this._decodeTimeZone(a);if(d){var c=this;this._handler._sysConf.setValue("TZ",d,function(f){f?b&&b(f):c._reloadTimeZone(function(f){f?b&&b(f):(localStorage&&localStorage.setItem("x.hub.Server.timezone",a),c._tz=a,c._timezone=d,b&&b())})})}else b&&b(Error("invalid timezone"))}else b&&b(Error("invalid timezone"))};e.prototype.setTime=function(a,b){if(a){var d=
a.year,c=a.month+"";1==c.length&&(c="0"+c);var f=a.date+"";1==f.length&&(f="0"+f);var g=a.hour+"";1==g.length&&(g="0"+g);a=a.minute+"";1==a.length&&(a="0"+a);d="date +%Y%m%d%H%M -s "+(d+c+f+g+a);c=require("child_process").exec;d=c(d);d.on("error",function(c){b&&(b(c),b=null)});d.on("close",function(c){b&&(b(0==c?null:Error("set system time failed")),b=null)})}else b&&b(Error("invalid time"))};e.prototype._restartNTPD=function(a){var b=require("child_process").exec;b=b(e.NTP_SCRIPT+" restart");b.stdout.on("data",
function(a){console.log(String(a))});b.on("error",function(b){a&&(a(b),a=null)});b.on("close",function(b){a&&(a(0==b?null:Error("restart ntpd failed")),a=null)})};e.prototype._readNTPConf=function(a){var b=this;require("fs").readFile(e.NTP_CONF,{encoding:"utf8"},function(d,c){if(!d&&c){d=[];c=c.split("\n");for(var f=0;f<c.length;f++){var g=c[f].trim();g&&"server"==g.substr(0,6)&&(g=g.split(" "),2<=g.length&&g[1]&&-1==d.indexOf(g[1])&&d.push(g[1]))}b._ntpServers=d}a()})};e.prototype._readTimezoneConf=
function(a){var b=this;require("fs").readFile(e.TIMEZONE_CONF,{encoding:"utf8"},function(d,c){!d&&c&&(b._timezone=c.trim());a()})};e.prototype._decodeTimeZone=function(a){a=parseInt(a,16);var b=0!=(a&128),d=(a&31)-11,c=null;e.TimeZone_MAP.forEach(function(a){a.utc==d&&a.dst==b&&(c=a.zone)});return c};e.prototype._reloadTimeZone=function(a){var b=require("child_process").exec;b=b(e.TIMEZONE_SCRIPT+" reload");b.stdout.on("data",function(a){console.log(String(a))});b.on("error",function(b){a&&(a(b),
a=null)});b.on("close",function(b){a&&(a(0==b?null:Error("reload timezone failed")),a=null)})};e.prototype._writeTimeToRTC=function(a){var b=Math.round((new Date).getTime()/1E3),d=new Buffer(4);d.writeInt32BE(b);var c=this;this._logger.log("trace","write time "+b+" to rtc "+d.toString("hex"));this._handler._stm.sendCommand(55,d,function(b){c._logger.log("trace","write time to rtc "+(b&&b.error?" failed:"+b.error:" success"));a&&a(b?b.error:null,b?b.data:null)})};return e}();
x.hub.v6.Network=function(){var e={calculate:function(a,b){var c=[];try{var f=this.toDecimal(a);var d=this.toDecimal(b)}catch(h){return null}if(d<f)return null;for(a=f;a<=d;){a=this.getOptimalRange(a,d);if(null===a)return null;c.push(a);a=a.ipHigh+1}return c},calculateSubnetMask:function(a,b){try{var c=this.toDecimal(a)}catch(l){return null}return this.getMaskRange(c,b)},calculateCIDRPrefix:function(a,b){var c=0;try{var f=this.toDecimal(a);var d=this.toDecimal(b)}catch(h){return null}for(a=0;32>a&&
(c=c+(1<<32-(a+1))>>>0,(d&c)>>>0===c);a++);return this.getMaskRange(f,a)},getOptimalRange:function(a,b){var c,f=null;for(c=32;0<=c;c--){var d=this.getMaskRange(a,c);if(d.ipLow===a&&d.ipHigh<=b)f=d;else break}return f},getMaskRange:function(a,b){var c=this.getPrefixMask(b),f=this.getMask(32-b),d=(a&c)>>>0;a=((a&c)>>>0)+f>>>0;return{ipLow:d,ipLowStr:this.toString(d),ipHigh:a,ipHighStr:this.toString(a),prefixMask:c,prefixMaskStr:this.toString(c),prefixSize:b,invertedMask:f,invertedMaskStr:this.toString(f),
invertedSize:32-b}},getPrefixMask:function(a){var c=0,b;for(b=0;b<a;b++)c+=1<<32-(b+1)>>>0;return c},getMask:function(a){var c=0,b;for(b=0;b<a;b++)c+=1<<b>>>0;return c},isIp:function(a){if("string"!==typeof a)return!1;a=a.match(/^([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/);if(null===a)return!1;for(var b=1;4>=b;b++){var c=parseInt(a[b],10);if(255<c||0>c)return!1}return!0},isDecimalIp:function(a){return"number"===typeof a&&0===a%1&&0<=a&&4294967295>=a},toDecimal:function(a){if("number"===
typeof a&&!0===this.isDecimalIp(a))return a;if(!1===this.isIp(a))throw Error("Not an IP address: "+a);a=a.split(".");return 256*(256*(256*+a[0]+ +a[1])+ +a[2])+ +a[3]},toString:function(a){if("string"===typeof a&&!0===this.isIp(a))return a;if(!1===this.isDecimalIp(a))throw Error("Not a numeric IP address: "+a);for(var b=a%256,c=3;0<c;c--)a=Math.floor(a/256),b=a%256+"."+b;return b}},a=function(b){this._file=b;this._file||(this._file=a.FILE);this._globalOptions=[];this._interfaceOptions={}};a.FILE=
"/etc/dhcpcd.conf";a.prototype.init=function(a){this._read(function(b){a&&a(b)})};a.prototype.getConfig=function(a){var b={dhcp:!0};if(!this._interfaceOptions||!this._interfaceOptions[a])return b;a=this._interfaceOptions[a];for(var c=0;c<a.length;c++){var d=a[c];if(d&&"static"==d.substr(0,6)){b.dhcp=!1;d=d.substr(6).trim();var k=d.indexOf("=");if(-1!=k){var h=d.substr(0,k);d=d.substr(k+1);switch(h){case "ip_address":h=d.split("/");1==h.length?(b.ip=h[0],b.subnet="255.255.255.0"):(d=e.calculateSubnetMask(h[0],
parseInt(h[1])),b.ip=h[0],b.subnet=d.prefixMaskStr);break;case "routers":b.router=d.split(" ");break;case "domain_name_servers":b.dns=d.split(" ")}}}}return b};a.prototype.setConfig=function(a,b,d){if(a&&b)if(b.dhcp||b.ip&&b.subnet&&b.router&&b.dns){if(b.dhcp)delete this._interfaceOptions[a];else{var c=e.calculateSubnetMask(b.ip,b.subnet);if(!c){d&&d(Error("invalid argument"));return}this._interfaceOptions[a]=["static ip_address="+b.ip+"/"+c.prefixSize,"static routers="+(Array.isArray(b.router)?b.router.join(" "):
b.router),"static domain_name_servers="+(Array.isArray(b.dns)?b.dns.join(" "):b.dns)]}this._write(function(a){d&&d(a)})}else d&&d(Error("invalid argument"));else d&&d(Error("invalid argument"))};a.prototype._read=function(a){var b=this;require("fs").readFile(this._file,{encoding:"utf8"},function(c,d){if(c)a(c);else{if(d){c=d.split("\n");d=null;for(var f=0;f<c.length;f++){var g=c[f].trim();g&&"#"!=g.charAt(0)&&(g=g.trim(),"interface"==g.substr(0,9)?d=g.substr(9).trim():d?(b._interfaceOptions[d]||(b._interfaceOptions[d]=
[]),b._interfaceOptions[d].push(g)):b._globalOptions.push(g))}}a()}})};a.prototype._write=function(a){var b="";this._globalOptions.forEach(function(a){b+=a+"\n\n"});for(var c in this._interfaceOptions){b+="interface "+c+"\n";for(var d=this._interfaceOptions[d],e=0;e<d.length;e++)b+="  "+d[e]+"\n";b+="\n"}require("fs").writeFile(this._file,b,function(b){a(b)})};var b=function(a){this._file=a;a||(this._file=b.FILE)};b.FILE="/etc/resolv.conf";b.prototype.getDns=function(a){require("fs").readFile(this._file,
{encoding:"utf8"},function(b,c){if(b)a&&a(b);else{b=[];c=c.split("\n");for(var d=0;d<c.length;d++){var f=c[d].trim();"#"!=f.charAt(0)&&"nameserver"==f.substr(0,10)&&(f=f.substr(10).trim(),b.push(f))}a&&a(null,b)}})};var d=function(a){this._logger=require("x.logger.js").getLogger("x.hub.v6.Network");this._handler=a;this._resolvConf=this._dhcpcdConf=null};d.DHCPCD_CONF="/etc/dhcpcd.conf";d.RESOLV_CONF="/etc/resolv.conf";d.SET_MAC_SCRIPT="/opt/scripts/set_mac_address.sh";d.prototype.init=function(c){global.SYSTEM_ROOT&&
(d.DHCPCD_CONF=global.SYSTEM_ROOT+d.DHCPCD_CONF,d.RESOLV_CONF=global.SYSTEM_ROOT+d.RESOLV_CONF,d.SET_MAC_SCRIPT=global.SYSTEM_ROOT+d.SET_MAC_SCRIPT);this._resolvConf=new b(d.RESOLV_CONF);this._dhcpcdConf=new a(d.DHCPCD_CONF);this._dhcpcdConf.init(c)};d.prototype.getNetwork=function(a){var b=this;this._getDNS(function(c,d){b._getRouter(function(c,f){c=require("os").networkInterfaces();var g={},l;for(l in c)if("lo"!=l.substr(0,2))for(var e=c[l],k=0;k<e.length;k++){var h=e[k];if(!h.internal&&"IPv4"==
h.family){h={ip:h.address,subnet:h.netmask,mac:h.mac};var m=b._dhcpcdConf.getConfig(l);(h.dhcp=m.dhcp)?(h.router=f?f[l]:null,h.dns=d):(h.router=m.router[0],h.dns=m.dns);g[l]=h}}a&&a(null,g)})})};d.prototype.setNetwork=function(a,b,d){if(b)if(1!=b.dhcp&&0!=b.dhcp)d&&d(Error("invalid argument"));else{a||(a="eth0");var c={};"eth0"==a&&(1==b.dhcp?c.ETH0_DHCP="true":0==b.dhcp&&(c.ETH0_DHCP="false",c.ETH0_IP=b.ip,c.ETH0_MASK=b.subnet,c.ETH0_ROUTER=b.router,c.ETH0_DNS=b.dns.join(",")));this._handler._sysConf.setValues(c,
function(a){d&&d(a)})}else d&&d(Error("invalid argument"))};d.prototype.setMAC=function(a,b){var c=require("child_process").exec;a=c(d.SET_MAC_SCRIPT+" "+a);a.stdout.on("data",function(a){console.log(String(a))});a.on("error",function(a){b&&(b(a),b=null)});a.on("close",function(a){b&&(b(0==a?null:Error("set mac address failed")),b=null)})};d.prototype.resetNetwork=function(a){this._handler._sysConf.setValues({ETH0_DHCP:"true"},function(b){a&&a(b)})};d.prototype._getDNS=function(a){this._resolvConf.getDns(a)};
d.prototype._getRouter=function(a){var b=require("child_process").exec;b=b("route -n");var c=null;b.stdout.on("data",function(a){c+=String(a)});b.on("error",function(b){a&&(a(b),a=null)});b.on("close",function(b){if(0==b){b={};for(var d=c.split("\n"),f=2;f<d.length;f++){var g=d[f].trim().split(" ").filter(function(a){return!!a});g.length&&"0.0.0.0"==g[0].trim()&&(b[g[7].trim()]=g[1].trim())}a&&(a(null,b),a=null)}else a&&(a(Error("exit with code:"+b)),a=null)})};return d}();
x.hub.v6.SystemConf=function(){var e=function(){this._conf={};this._writeCallbacks=[];this._writing=!1};e.FILE="/config/system.conf";e.prototype.init=function(a){global.SYSTEM_ROOT&&(e.FILE=SYSTEM_ROOT+e.FILE);this._readConf(function(){a&&a()})};e.prototype.getValue=function(a,b){if(void 0==a||null==a||"string"!=typeof a)b&&b(Error("invalid key"));else{a=this._conf[a];if(void 0==a||null==a)a="";b&&b(null,a)}};e.prototype.setValue=function(a,b,d){void 0==a||null==a||"string"!=typeof a?d&&d(Error("invalid key")):
void 0==b||null==b||"string"!=typeof b?d&&d(Error("invalid value")):(this._conf[a]=b,d&&this._writeCallbacks.push(d),this._writing||this._doNextWrite())};e.prototype.setValues=function(a,b){if(a){var d=0,c;for(c in a)if(void 0!=c&&null!=c&&"string"==typeof c){var f=a[c];void 0!=f&&null!=f&&"string"==typeof f&&(d++,this._conf[c]=f)}0==d?b&&b(Error("no valid entry")):(b&&this._writeCallbacks.push(b),this._writing||this._doNextWrite())}else b&&b(Error("invalid map"))};e.prototype.reset=function(a){this._conf=
{};a&&this._writeCallbacks.push(a);this._writing||this._doNextWrite()};e.prototype._doNextWrite=function(){var a=this._writeCallbacks;this._writeCallbacks=[];this._writing=!0;var b=this;this._writeConf(function(d){b._writing=!1;for(var c=0;c<a.length;c++){var f=a[c];try{f(d)}catch(g){}}b._writeCallbacks&&b._writeCallbacks.length&&b._doNextWrite()})};e.prototype._readConf=function(a){var b=this;this._readFile(function(d,c){if(!d&&c)for(d=c.split("\n"),c=0;c<d.length;c++){var f=d[c].trim();if(f){var g=
f.indexOf("=");if(-1!=g){var e=f.substr(0,g).trim();f=f.substr(g+1).trim();e&&(b._conf[e]=f)}}}a()})};e.prototype._writeConf=function(a){var b="",d;for(d in this._conf)b+=d+"="+this._conf[d]+"\n";this._writeFile(b,a)};e.prototype._readFile=function(a){require("fs").readFile(e.FILE,{encoding:"utf8"},function(b,d){a(b,d)})};e.prototype._writeFile=function(a,b){require("fs").writeFile(e.FILE,a,function(a){b(a)})};return e}();
x.hub.v6.STM=function(){var e=require("util"),a=require("events"),b=require("x.hub.v5.js").USBSerial;require("x.logger.js").setLevel("trace","x.hub.v6.STM");require("x.logger.js").setLevel("trace","x.hub.v5");var d=function(a,b){this._logger=require("x.logger.js").getLogger("x.hub.v6.STM.Serial");this._port=a?a:c.SERIAL_PORT;this._baudrate=b?b:c.SERIAL_BAUDRATE;this._stmUSBSerial=null;this._receiveBuffer=new Buffer([]);this._onData=null;this._useAck=!0;this._reqFifo=[];this.REQ_FIFO_MAX_LEN=5;this.ACK_TO=
200;this.RSP_TO=1E4;this.RSP_END_TO=2E3};e.inherits(d,b);d.prototype._openSTMUSB=function(a){if(this._stmUSBSerial)a&&a(!0);else{var b=this,c=a;a=require("xnm.aio.m10T.js");var d=this._baudrate,f=new a.STMUSBSerial;f.on("error",function(){b._logger.log("trace","st port error");try{b._stmUSBSerial.close()}catch(n){}b._stmUSBSerial=null;c&&c(!1);c=null});f.on("timeout",function(){b._logger.log("trace","st port timeout")});f.on("data",function(a){b._logger.log("trace","st data:"+a.toString("hex"));b._receiveBuffer=
Buffer.concat([b._receiveBuffer,a]);for(a=b._getNextDataPackage();a;){b._logger.log("trace","st package:"+a.toString("hex"));var c=a.slice(1,a.length-1);switch(a[0]){case 80:b._logger.log("info","receive st event:"+c.toString());b._sendAck();break;case 0:b._onNak();break;case 1:b._onAck();break;case 34:b._sendAck();b._onRspError(c);break;case 32:b._sendAck();b._onRsp(c);break;case 33:b._sendAck(),b._onRspEnd(c)}b._onData&&b._onData({type:a[0],data:c});a=b._getNextDataPackage()}});f.open(this._port,
function(){b._logger.log("trace","st connected");b._stmUSBSerial=f;c&&c(!0);c=null},d)}};var c=function(a,b,e,k){this._logger=require("x.logger.js").getLogger("x.hub.v6.STM");this._handler=a;this._pin=k?k:c.RESET_PIN;this._last_error=this._state=0;var f=this;this._serial=new d(b?b:c.SERIAL_PORT,e?e:c.SERIAL_BAUDRATE);this._serial.on("data",function(a){f._onData(a)})};e.inherits(c,a);c.SERIAL_PORT="/dev/ttyS0";c.SERIAL_BAUDRATE=230400;c.BOOT_PIN=4;c.RESET_PIN=5;c.MODE_SCRIPT="/opt/scripts/set_stm_mode.sh";
c.FIRMWARE_FILE="/opt/firmware/latest.bin";c.prototype.init=function(a){global.SYSTEM_ROOT&&(c.MODE_SCRIPT=SYSTEM_ROOT+c.MODE_SCRIPT,c.FIRMWARE_FILE=SYSTEM_ROOT+c.FIRMWARE_FILE);var b=this;this._state=1;this._serial._openSTMUSB(function(c){c?b._state=2:(b._state=0,b._last_error=1);a&&a(c)})};c.prototype.reset=function(a){if(4==this._state)a&&a(Error("stm is resetting"));else if(2!=this._state)a&&a(Error("stm has state:"+this._state));else{this._logger.log("trace","do stm factory reset");var b=this;
this._state=4;this._serial.reset(function(){b._serial.sendCommand(53,[],function(c){var d=null;if(!c||c.error)d=c?c.error:Error("reset stm failed");d?(b._logger.log("trace","do stm factory reset failed:"+d.message),a&&a(d)):setTimeout(function(){b._logger.log("trace","do stm factory reset success");b._state=2;a&&a()},2E3)})})}};c.prototype.reboot=function(a){if(3==this._state)a&&a(Error("stm is rebooting"));else if(2!=this._state)a&&a(Error("stm has state:"+this._state));else{this._logger.log("trace",
"reboot stm");var b=this;this._state=3;this._serial.reset(function(){b._setSTMMode("reboot",function(c){b._logger.log("trace","reboot stm "+(c?"failed:"+c.message:"success"));b._state=2;a&&a(c)})})}};c.prototype.flashFirmware=function(a,b){if(4==this._state)b&&b(Error("flash stm firmware proceess is running"));else if(0!=this._state&&2!=this._state)b&&b(Error("stm has state:"+this._state));else{a||(a=c.FIRMWARE_FILE);this._logger.log("trace","start to flash stm firmware:"+a);var d=this._state;this._state=
4;var f=this;this._serial.reset(function(){f._setSTMMode("bootloader",function(c){c?(f._logger.logger("trace","flash stm failed to enter bootloader mode:"+c.message),f._setSTMMode("reboot",function(){f._state=d;b&&b(c)})):f._flashFirmware(a,function(a){a?f._setSTMMode("reboot",function(){f._state=d;b&&b(a)}):(f._state=d,b&&b(null))})})})}};c.prototype.sendCommand=function(a,b,c){2!=this._state?(this._logger.log("trace","reject send stm command, stm connection state:"+this._state),c&&c({error:"stm connection state:"+
this._state})):this._serial.sendCommand(a,b,c)};c.prototype._onData=function(a){if(a&&a.type&&a.data&&80==a.type){a=a.data.toString();var b=null;8<a.length&&"{XC_EVT}"==a.substr(0,8)?(a=a.substr(8),b="EVT"):4<a.length&&"EVT:"==a.substr(0,4)?(a=a.substr(4),b="EVT"):4<a.length&&"STA:"==a.substr(0,4)&&(a=a.substr(4),b="STA");this.emit("event",a,b)}};c.prototype._setSTMMode=function(a,b){var d=require("child_process").exec;d=d(c.MODE_SCRIPT+" "+a);d.on("error",function(a){b&&(b(a),b=null)});d.on("close",
function(c){b&&(b(0==c?null:Error("set stm mode: "+a+" failed")),b=null)})};c.prototype._flashFirmware=function(a,b){var c=this;a=new (require("xnm.aio.m10T.js").STMUpdater)(a);this._logger.log("trace","flash stm with dfu-util");a.startDFUUpdate("dfu-util",function(a){b&&a&&(a.error?(c._logger.log("trace","flash stm failed:"+a.error),b(Error(a.error)),b=null):a.state&&(c._logger.log("trace","flash stm progress:"+a.state),c.emit("flash",{progress:a.state}),100==a.state&&(c._logger.log("trace","flash stm success"),
b(),b=null)))},null,"v6p")};return c}();
x.hub.v6.LED=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.v6.LED");this._rgb=[255,255,255];this._state=0;this._lastRGB=null};e.PROCESS="setlight";e.NAMED_PIPE="/tmp/rgb.cfg";e.prototype.init=function(){if(localStorage){var a=localStorage.getItem("x.hub.Server.led");a&&6==a.length&&a.match(/^([a-fA-F0-9]){6}/g)&&(this._rgb=[parseInt(a.substr(0,2),16),parseInt(a.substr(2,2),16),parseInt(a.substr(4,2),16)])}};e.prototype.saveColor=function(a,b,d,c){var e=this;this.setColor(a,
b,d,function(f){if(!f&&localStorage){e._rgb=[a,b,d];for(var g=(new Buffer(e._rgb)).toString("hex");6>g.length;)g="0"+g;localStorage.setItem("x.hub.Server.led",g)}c&&c(f)})};e.prototype.setColor=function(a,b,d,c){if(1<this._state)c&&c(Error("led state:"+this._state));else{var e=this;this._state=0;this._setColor(a,b,d,function(f){f||(e._lastRGB=[a,b,d]);c&&c(f)})}};e.prototype.blinkColor=function(a,b,d,c,e){if(1<this._state)e&&e(Error("led state:"+this._state));else{var f=this;this._state=1;this._blinkColor(a,
b,d,c,function(a){a?(f._state=0,f._setLastColor(function(){e&&e(a)})):e&&e()})}};e.prototype.stopBlinkColor=function(a){1!=this._state?a&&a():(this._state=0,this._setLastColor(function(b){a&&a(b)}))};e.prototype.startFlashSTM=function(a){if(2==this._state)a&&a();else if(2<this._state)a&&a(Error("led state:"+this._state));else{var b=this;this._state=2;this._blinkColor(255,255,0,50,function(d){d&&(b._state=0);a&&a(d)})}};e.prototype.stopFlashSTM=function(a){2!=this._state?a&&a():(this._state=0,this._setLastColor(function(b){a&&
a(b)}))};e.prototype.startSystemInit=function(a){if(3==this._state)a&&a();else if(3<this._state)a&&a(Error("led state:"+this._state));else{var b=this;this._state=3;this._blinkColor(255,255,255,1E3,function(d){d&&(b._state=0);a&&a(d)})}};e.prototype.stopSystemInit=function(a){3!=this._state?a&&a():(this._state=0,this._setLastColor(function(b){a&&a(b)}))};e.prototype._setLastColor=function(a){var b=this._lastRGB?this._lastRGB:this._rgb;this._setColor(b[0],b[1],b[2],a)};e.prototype._setColor=function(a,
b,d,c){a=this._buildCommand([1,a,b,d,0,0]);this._logger.log("trace","set color:"+a.toString("hex"));this._doCommand(a,function(a){c&&c(a)})};e.prototype._blinkColor=function(a,b,d,c,e){a=[1,a,b,d,0,0];0==c%1E3?a[4]=c/1E3:(a[4]=Math.floor(c/1E3),a[5]=Math.round(c%1E3/20));c=this._buildCommand(a);this._logger.log("trace","blink color:"+c.toString("hex"));this._doCommand(c,function(a){e&&e(a)})};e.prototype._buildCommand=function(a){var b=[170,a.length+3];b=b.concat(a);a=b[2];for(var d=3;d<b.length;d++)a^=
b[d];b.push(a);return new Buffer(b)};e.prototype._doCommand=function(a,b){var d=this;this._getPID(function(c,e){c?(d._logger.log("trace","get program pid error:"+c.message),b&&b(c)):e?d._write(a,b):(d._logger.log("trace","program not running"),b&&b(Error("program not running")))})};e.prototype._write=function(a,b){var d=require("fs"),c=this;d.access(e.NAMED_PIPE,d.F_OK,function(f){if(f)c._logger.log("warn","led control program not running"),b&&b(f);else{var g=d.createWriteStream(e.NAMED_PIPE);g.on("open",
function(){c._logger.log("trace","stream open and write bytes");g.end(a)});g.on("error",function(a){c._logger.log("trace","stream error:"+a.messae);g.__writeTO&&(clearTimeout(g.__writeTO),g.__writeTO=null);b&&(b(a),b=null);g.destroy()});g.on("close",function(){c._logger.log("trace","stream close");g.__writeTO&&(clearTimeout(g.__writeTO),g.__writeTO=null);b&&(b(),b=null)});g.__writeTO=setTimeout(function(){c._logger.log("trace","stream write timeout");b&&(b(Error("write timeout")),b=null);g.destroy()},
2E3)}})};e.prototype._getPID=function(a){var b=require("child_process").exec;b=b("pidof "+e.PROCESS);var d=null;b.stdout.on("data",function(a){d=String(a).trim()});b.on("error",function(b){a&&(a(b),a=null)});b.on("close",function(b){a&&(a(null,d),a=null)})};return e}();
x.hub.v6.ResetPin=function(){var e=function(a,b){this._logger=require("x.logger.js").getLogger("x.hub.v6.ResetPin");this._handler=a;this._pinID=b;this._pinID||(this._pinID=e.PIN);this._checkInterval=this._pressedTS=this._resetMode=this._pin=null};e.PIN=24;e.prototype.init=function(){this._logger.log("trace","init reset pin:"+this._pinID);if("PI-CM3+"==global.PLATFORM){var a=require("onoff").Gpio;(new a(this._pinID,"in","both")).unexport();this._pin=new a(this._pinID,"in","both");var b=this;this._pin.watch(function(a,
c){b._logger.log("trace","reset pin value:"+c);1==c?b._onPress():0==c&&b._onRelease()})}};e.prototype._checkResetPin=function(){var a=this._pin.readSync();this._logger.log("trace","check reset pin value:"+a);0==a?this._onRelease():(a=Date.now()-this._pressedTS,8E3<a?"reboot"!=this._resetMode&&(this._pressedTS=Date.now(),this._resetMode="reboot",this._onModeChange()):6E3<a?"factory"!=this._resetMode&&(this._resetMode="factory",this._onModeChange()):4E3<a?"passwords"!=this._resetMode&&(this._resetMode=
"passwords",this._onModeChange()):2E3<a&&"network"!=this._resetMode&&(this._resetMode="network",this._onModeChange()))};e.prototype._onPress=function(){this._logger.log("trace","reset pin pressed");this._resetMode="reboot";this._pressedTS=Date.now();this._checkInterval&&(clearInterval(this._checkInterval),this._checkInterval=null);var a=this;this._checkInterval=setInterval(function(){a._checkResetPin()},200);this._onModeChange()};e.prototype._onRelease=function(){this._logger.log("trace","reset pin released, reset mode:"+
this._resetMode);this._checkInterval&&(clearInterval(this._checkInterval),this._checkInterval=null);var a=this._resetMode;this._pressedTS=this._resetMode=null;var b=this,d=this._handler._hub;if(d)switch(a){case "reboot":d.restart();break;case "factory":case "passwords":case "network":d.reset(a,function(c,e){b._logger.log("trace",a+" reset finish, reboot:"+e);!c&&e&&d.restart()})}};e.prototype._onModeChange=function(){this._logger.log("trace","reset mode change to:"+this._resetMode);var a=require("x.hub.v6.js")._led;
switch(this._resetMode){case "reboot":a.setColor(0,0,0);break;case "network":a.setColor(0,255,0);break;case "passwords":a.setColor(255,255,0);break;case "factory":a.setColor(255,0,0)}};return e}();
x.hub.v6.Handler=function(){var e=function(){this._centralUnit=null;this._sysConf=new x.hub.v6.SystemConf;this._stm=new x.hub.v6.STM(this,global.STM?global.STM:null);this._led=new x.hub.v6.LED;this._resetPin=new x.hub.v6.ResetPin(this);this._network=new x.hub.v6.Network(this);this._time=new x.hub.v6.Time(this);this._hub=null};e.prototype.CentralUnit=x.hub.v6.CentralUnit;e.prototype.LED=x.hub.v6.LED;e.prototype.ResetPin=x.hub.v6.ResetPin;e.prototype.init=function(a,b){var d=this;this._hub=a;this._led.init();
this._resetPin.init();this._sysConf.init(function(){d._network.init();d._time.init();b&&b()});this._stm.init()};e.prototype.setIPData=function(a,b){var d=this,c=function(a,b){a.MAC?12==a.MAC.length&&a.MAC.match(/^([a-fA-F0-9]{2}){6}/g)?(a=a.MAC.substr(0,2)+":"+a.MAC.substr(2,2)+":"+a.MAC.substr(4,2)+":"+a.MAC.substr(6,2)+":"+a.MAC.substr(8,2)+":"+a.MAC.substr(10,2),d._network.setMAC(a,function(a){b(a,a?!1:!0)})):b(Error("invalid mac address ")):b(null,!1)},e=function(a,b){if(1!=a.DHCP&&0!=a.DHCP)b(null,
!1);else{var c={dhcp:!0};if(0==a.DHCP){if(!(a.IP&&a.SN&&a.GW&&a.DNS)){b(Error("invalid static ip settings"));return}c.dhcp=!1;c.ip=a.IP;c.subnet=a.SN;c.router=a.GW;c.dns=a.DNS.split(",")}d._network.setNetwork("eth0",c,function(a){b(a,a?!1:!0)})}},g=!1;(function(a,b){a.NTP?(a=a.NTP.split(","),d._time.setNTPServers(a,function(a){b(a,!1)})):b(null,!1)})(a,function(d,f){d?b&&b(d):(g=g||f,c(a,function(c,d){c?b&&b(c):(g=g||d,e(a,function(a,c){a?b&&b(a):(g=g||c,b&&b(null,g))}))}))})};e.prototype.setTZData=
function(a,b){a?this._time.setTimezoneEncoded(a,b):b&&b(Error("invalid timezone"))};e.prototype.reboot=function(a){console.log("REBOOT");if("PI-CM3+"!=global.PLATFORM)a&&a();else{var b=require("child_process").exec;b=b("reboot");b.on("error",function(b){a&&(a(b),a=null)});b.on("close",function(b){a&&(a(0==b?null:Error("system reboot failed")),a=null)})}};e.prototype.reset=function(a,b){var d=this;switch(a){case "network":this._network.resetNetwork(function(a){b&&b(a,a?!1:!0)});break;case "factory":this._stm.reset(function(a){a?
b&&b(a,a?!1:!0):d._sysConf.reset(function(a){b&&b(a,a?!1:!0)})});break;default:b&&b(Error("unknonw reset type: "+a))}};e.prototype.updateSTM=function(a,b,d){var c=this,e=function(a,b,d){var e=function(a){a&&a.progress&&b.write(a.progress+".")};c._led.startFlashSTM(function(){c._stm.on("flash",e);c._stm.flashFirmware(a,function(a){c._stm.removeListener("flash",e);a?b.write(JSON.stringify({XC_ERR:{code:"000000",msg:a.message}})):b.write(JSON.stringify({XC_SUC:{}}));b.end();c._led.stopFlashSTM(function(){d&&
d(a)})})})};a?this._saveTempFile("stm.bin",a,function(a,c){a?d&&d(a):e(c,b,d)}):e(null,b,d)};e.prototype._saveTempFile=function(a,b,d){var c=require("fs"),e=require("os"),g=require("path");e=e.tmpdir();var l=g.join(e,a);c.existsSync(g)&&c.unlinkSync(g);var k=c.createWriteStream(l);b.pipe(k);k.on("finish",function(){k.close(function(){d&&d(null,l)})});k.on("error",function(a){c.unlink(l);d&&d(a)})};return e}();
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.v6.Handler);
