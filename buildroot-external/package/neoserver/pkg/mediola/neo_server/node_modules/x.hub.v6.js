function _typeof(o){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o;}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o;},_typeof(o);}var x=x||{};x.hub=x.hub||{},x.hub.v6=x.hub.v6||{},x.hub.v6.API=function(){var e=function e(_e){this._version="v1",this._handler=_e;};return e.prototype.init=function(e,t){var r=this;e.addRoute("/api/"+this._version+"/command",function(e,t){r._handler.command(e.body,function(e,o){t.json(r._buildResponseJSON(e,o));});}),e.addRoute("/api/"+this._version+"/state",function(e,t){r._handler.state(e.query,function(e,o){t.json(r._buildResponseJSON(e,o));});}),t&&t();},e.prototype.handleTunnelReuqest=function(e,t){var r=e.pathname.split("/"),o=this;"state"==r[3]?this._handler.state(e.query,function(e,r){t&&t(o._buildResponseJSON(e,r));}):"command"==r[3]?this._handler.command(e.body,function(e,r){t&&t(o._buildResponseJSON(e,r));}):t&&t(o._buildResponseJSON(new Error("invalid request")));},e.prototype._buildResponseJSON=function(e,t){if(e){var r=e.code+"";for(r||(r="0");r.length<6;)r="0"+r;return{XC_ERR:{code:r,msg:e.message}};}return{XC_SUC:t||{}};},{V1:e};}(),x.hub.v6.CentralUnit=function(){var e=function e(_e2){this._api=new x.hub.v6.API.V1(this),this._server=_e2;};return e.prototype.init=function(e){this._api.init(this._server,e);},e.prototype.handleTunnelReuqest=function(e,t){this._api.handleTunnelReuqest(e,t);},e.prototype.command=function(e,t){},e.prototype.state=function(e,t){e&&"true"==e.force?this._updatesStates(e,t):t&&t(null,null);},e.prototype._updatesStates=function(e,t){e&&e.id?this._getStates(e.id,function(r,o){if(r)t&&t(r);else if(o){var n={};n[e.id]={},e.key?n[e.id][e.key]=o[e.key]:n[e.id]=o,t&&t(null,n);}else t&&t(null,{});}):this._updateStatesAll(e.timeout,t);},e.prototype._updateStatesAll=function(e,t){e&&(e*=1e3),require("x.hub.commandman.js").commandHandler2.updateGeneralDeviceStates(e,t);},e.prototype._updateStates=function(e,t){require("x.hub.deviceman.js").deviceManager2.toGeneralDevice(e,function(r,o){if(r)t&&t(r);else if(o){if(o.states&&o.details&&o.details.states){var n=[];for(var s in o.details.states){var i=o.details.states[s];i&&i.value&&n.push({id:s,value:i.value});}0!=n.length?require("x.hub.commandman.js").commandHandler2.getStatesWithIdx(e,null,n,function(e){e&&e.data?t&&t(null,e.data):t&&t(new Error("get device states error"));}):t&&t(null,null);}else t&&t(null,null);}else t&&t(new Error("can not find general device"));});},e;}(),x.hub.v6.Time=function(){var e=function e(t){this._logger=require("x.logger.js").getLogger("x.hub.v6.Time"),this._handler=t,this._writeRTCInterval=null,this._tz=e.DEFAULT_TZ,this._timezone=e.DEFAULT_TTIMEZONE,this._ntpServers=["0.de.pool.ntp.org","1.de.pool.ntp.org","2.de.pool.ntp.org","3.de.pool.ntp.org"];};return e.TimeZone_MAP=[{utc:0,dst:!1,zone:"Etc/UTC"},{utc:0,dst:!0,zone:"Europe/Dublin"},{utc:1,dst:!1,zone:"Etc/GMT-1"},{utc:1,dst:!0,zone:"Europe/Berlin"},{utc:2,dst:!1,zone:"Etc/GMT-2"},{utc:2,dst:!0,zone:"EET"},{utc:3,dst:!1,zone:"Etc/GMT-3"},{utc:3,dst:!0,zone:"Asia/Tehran"},{utc:4,dst:!1,zone:"Etc/GMT-4"},{utc:4,dst:!0,zone:"Asia/Kabul"},{utc:5,dst:!1,zone:"Etc/GMT-5"},{utc:5,dst:!0,zone:"Etc/GMT-5"},{utc:6,dst:!1,zone:"Etc/GMT-6"},{utc:6,dst:!0,zone:"Etc/GMT-6"},{utc:7,dst:!1,zone:"Etc/GMT-7"},{utc:7,dst:!0,zone:"Asia/Hovd"},{utc:8,dst:!1,zone:"Etc/GMT-8"},{utc:8,dst:!0,zone:"Asia/Ulaanbaatar"},{utc:9,dst:!1,zone:"Etc/GMT-9"},{utc:9,dst:!0,zone:"Australia/Adelaide"},{utc:10,dst:!1,zone:"Etc/GMT-10"},{utc:10,dst:!0,zone:"Australia/Sydney"},{utc:11,dst:!1,zone:"Etc/GMT-11"},{utc:11,dst:!0,zone:"Etc/GMT-11"},{utc:12,dst:!1,zone:"Etc/GMT-12"},{utc:12,dst:!0,zone:"Pacific/Auckland"},{utc:13,dst:!1,zone:"Etc/GMT-13"},{utc:13,dst:!0,zone:"Pacific/Apia"},{utc:14,dst:!1,zone:"Etc/GMT-14"},{utc:14,dst:!0,zone:"Etc/GMT-14"},{utc:-1,dst:!1,zone:"Etc/GMT+1"},{utc:-1,dst:!0,zone:"Etc/GMT+1"},{utc:-2,dst:!1,zone:"Etc/GMT+2"},{utc:-2,dst:!0,zone:"Etc/GMT+2"},{utc:-3,dst:!1,zone:"Etc/GMT+3"},{utc:-3,dst:!0,zone:"America/Sao_Paulo"},{utc:-4,dst:!1,zone:"Etc/GMT+4"},{utc:-4,dst:!0,zone:"America/Santiago"},{utc:-5,dst:!1,zone:"Etc/GMT+5"},{utc:-5,dst:!0,zone:"America/New_York"},{utc:-6,dst:!1,zone:"Etc/GMT+6"},{utc:-6,dst:!0,zone:"CST6CDT"},{utc:-7,dst:!1,zone:"Etc/GMT+7"},{utc:-7,dst:!0,zone:"MST7MDT"},{utc:-8,dst:!1,zone:"Etc/GMT+8"},{utc:-8,dst:!0,zone:"PST8PDT"},{utc:-9,dst:!1,zone:"Etc/GMT+9"},{utc:-9,dst:!0,zone:"America/Anchorage"},{utc:-10,dst:!1,zone:"Etc/GMT+10"},{utc:-10,dst:!0,zone:"America/Adak"},{utc:-11,dst:!1,zone:"Etc/GMT+11"},{utc:-11,dst:!0,zone:"Etc/GMT+11"}],e.DEFAULT_TZ="21",e.DEFAULT_TTIMEZONE="Europe/Berlin",e.TIMEZONE_SCRIPT="/etc/init.d/S00settimezone",e.TIMEZONE_CONF="/etc/timezone",e.NTP_SCRIPT="/etc/init.d/S49ntp",e.NTP_CONF="/etc/ntp.conf",e.WRITE_RTC_PERIOD=6e5,e.prototype.init=function(t){global.SYSTEM_ROOT&&(e.TIMEZONE_SCRIPT=SYSTEM_ROOT+e.TIMEZONE_SCRIPT,e.TIMEZONE_CONF=SYSTEM_ROOT+e.TIMEZONE_CONF,e.NTP_CONF=SYSTEM_ROOT+e.NTP_CONF,e.NTP_SCRIPT=SYSTEM_ROOT+e.NTP_SCRIPT);var r=this;if(localStorage){var o=localStorage.getItem("x.hub.Server.timezone");o&&(r._tz=o);}this._writeRTCInterval=setInterval(function(){var e=Math.round(new Date().getTime()/1e3);r._writeTimeToRTC(e);},e.WRITE_RTC_PERIOD),this._readNTPConf(function(){r._readTimezoneConf(function(){t&&t();});});},e.prototype.getNTPServers=function(e){e&&e(null,this._ntpServers);},e.prototype.setNTPServers=function(e,t){if(e&&e.length){var r=e.filter(function(e){return!!e;});if(r&&r.length){var o=this;this._handler._sysConf.setValue("NTP",r.join(","),function(e){e?t&&t(e):o._restartNTPD(function(e){e?t&&t(e):(o._ntpServers=r,t&&t());});});}else t&&t(new Error("invalid ntp servers"));}else t&&t(new Error("invalid ntp servers"));},e.prototype.getTimezoneSync=function(){return this._decodeTimeZone(this._tz);},e.prototype.getTimezoneEncoded=function(e){e&&e(null,this._tz);},e.prototype.setTimezoneEncoded=function(e,t){if(e){var r=this._decodeTimeZone(e);if(r){var o=this;this._handler._sysConf.setValue("TZ",r,function(n){n?t&&t(n):o._reloadTimeZone(function(n){n?t&&t(n):(localStorage&&localStorage.setItem("x.hub.Server.timezone",e),o._tz=e,o._timezone=r,o._handler._stm.sendCommand(16,"XC_FNC=setTZ&data="+e,function(e){t&&t(e?e.error:null);}));});});}else t&&t(new Error("invalid timezone"));}else t&&t(new Error("invalid timezone"));},e.prototype.setTime=function(e,t){if(e){var r=e.year,o=e.month+"";1==o.length&&(o="0"+o);var n=e.date+"";1==n.length&&(n="0"+n);var s=e.hour+"";1==s.length&&(s="0"+s);var i=e.minute+"";1==i.length&&(i="0"+i);var a=this;this._logger.log("trace","set system time: "+r+"-"+o+"-"+n+" "+s+":"+i),this._setSystemTime({year:r,month:o,date:n,hour:s,minute:i},function(e){if(a._logger.log("trace","set system time "+(e?"failed:"+e.message:"success")),e)t&&t(e);else{var r=new Date();r=Math.round(r.getTime()/1e3),a._logger.log("trace","set stm time: "+r),a._writeTimeToRTC(r,function(e){a._logger.log("trace","set stm time "+(e?"failed:"+e.message:"success")),t&&t(e);});}});}else t&&t(new Error("invalid time"));},e.prototype.restore=function(t,r,o){this._logger.log("trace","restore timezone");var n=require("fs"),s=require("path"),i=null,a=this,l=function l(){if(i){if(r&&"v5+"==r.backupType){var t=(31&(i=parseInt(i,16)))-11;i=0!=(128&i)?32:0,t<0&&(i|=16,t=0-t),(i=(i|=15&t).toString(16)).length<2&&(i="0"+i),a._logger.log("trace","convert v5+ timezone to v6+ format: "+i);try{a._logger.log("trace","overwrite v6+ format tz to "+c),n.writeFileSync(c,i.toUpperCase());}catch(t){a._logger.log("trace","overwrite v6+ format tz to "+c+" failed:"+t.message);}}}else i=e.DEFAULT_TZ;a.setTimezoneEncoded(i,o);},c=s.join(t,"data","localstorage","x.hub.Server.timezone");n.existsSync(c)?(this._logger.log("trace","read timezone from backup file: "+c),n.readFile(c,{encoding:"utf8"},function(e,t){a._logger.log("trace","read timezone from backup file"+(e?" failed:"+e.message:" success:"+t)),!e&&t&&(i=t),l();})):l();},e.prototype._setSystemTime=function(e,t){if("PI-CM3+"==global.PLATFORM){var r="date +%Y%m%d%H%M -s "+(e.year+e.month+e.date+e.hour+e.minute),o=(0,require("child_process").exec)(r);o.on("error",function(e){t&&(t(e),t=null);}),o.on("close",function(e){t&&(t(0==e?null:new Error("set system time failed")),t=null);});}else t&&t();},e.prototype._restartNTPD=function(t){var r=(0,require("child_process").exec)(e.NTP_SCRIPT+" restart");r.stdout.on("data",function(e){console.log(String(e));}),r.on("error",function(e){t&&(t(e),t=null);}),r.on("close",function(e){t&&(t(0==e?null:new Error("restart ntpd failed")),t=null);});},e.prototype._readNTPConf=function(t){var r=this;require("fs").readFile(e.NTP_CONF,{encoding:"utf8"},function(e,o){if(!e&&o){for(var n=[],s=o.split("\n"),i=0;i<s.length;i++){var a=s[i].trim();if(a&&"server"==a.substr(0,6)){var l=a.split(" ");l.length>=2&&l[1]&&-1==n.indexOf(l[1])&&n.push(l[1]);}}r._ntpServers=n;}t();});},e.prototype._readTimezoneConf=function(t){var r=this;require("fs").readFile(e.TIMEZONE_CONF,{encoding:"utf8"},function(e,o){!e&&o&&(r._timezone=o.trim()),t();});},e.prototype._decodeTimeZone=function(t){var r=0!=(32&(t=parseInt(t,16))),o=15&t;16&t&&(o=0-o),64&t&&(o-=.5);var n=null;return e.TimeZone_MAP.forEach(function(e){e.utc==o&&e.dst==r&&(n=e.zone);}),n;},e.prototype._reloadTimeZone=function(t){var r=(0,require("child_process").exec)(e.TIMEZONE_SCRIPT+" reload"),o=this;r.stdout.on("data",function(e){o._logger.log("trace","_reloadTimeZone:"+String(e));}),r.on("error",function(e){t&&(t(e),t=null);}),r.on("close",function(e){t&&(t(0==e?null:new Error("reload timezone failed")),t=null);});},e.prototype._writeTimeToRTC=function(e,t){var r=new Buffer(4);r.writeInt32BE(e);var o=this;this._logger.log("trace","write time "+e+" to stm "+r.toString("hex")),this._handler._stm.sendCommand(55,r,function(e){o._logger.log("trace","write time to stm "+(e&&e.error?" failed:"+e.error:" success")),t&&t(e?e.error:null,e?e.data:null);});},e;}(),x.hub.v6.Network=function(){var e={calculate:function calculate(e,t){var r,o,n,s=[];try{r=this.toDecimal(e),o=this.toDecimal(t);}catch(e){return null;}if(o<r)return null;for(n=r;n<=o;){var i=this.getOptimalRange(n,o);if(null===i)return null;s.push(i),n=i.ipHigh+1;}return s;},calculateSubnetMask:function calculateSubnetMask(e,t){var r;try{r=this.toDecimal(e);}catch(e){return null;}return this.getMaskRange(r,t);},calculateCIDRPrefix:function calculateCIDRPrefix(e,t){var r,o,n,s=0,i=0;try{r=this.toDecimal(e),o=this.toDecimal(t);}catch(e){return null;}for(n=0;n<32&&(o&(i=s+(1<<32-(n+1))>>>0))>>>0===i;n++)s=i;return this.getMaskRange(r,n);},getOptimalRange:function getOptimalRange(e,t){var r,o=null;for(r=32;r>=0;r--){var n=this.getMaskRange(e,r);if(!(n.ipLow===e&&n.ipHigh<=t))break;o=n;}return o;},getMaskRange:function getMaskRange(e,t){var r=this.getPrefixMask(t),o=this.getMask(32-t),n=(e&r)>>>0,s=((e&r)>>>0)+o>>>0;return{ipLow:n,ipLowStr:this.toString(n),ipHigh:s,ipHighStr:this.toString(s),prefixMask:r,prefixMaskStr:this.toString(r),prefixSize:t,invertedMask:o,invertedMaskStr:this.toString(o),invertedSize:32-t};},getPrefixMask:function getPrefixMask(e){var t,r=0;for(t=0;t<e;t++)r+=1<<32-(t+1)>>>0;return r;},getMask:function getMask(e){var t,r=0;for(t=0;t<e;t++)r+=1<<t>>>0;return r;},isIp:function isIp(e){if("string"!=typeof e)return!1;var t=e.match(/^([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/);if(null===t)return!1;for(var r=1;r<=4;r++){var o=parseInt(t[r],10);if(o>255||o<0)return!1;}return!0;},isDecimalIp:function isDecimalIp(e){return"number"==typeof e&&e%1==0&&e>=0&&e<=4294967295;},toDecimal:function toDecimal(e){if("number"==typeof e&&!0===this.isDecimalIp(e))return e;if(!1===this.isIp(e))throw new Error("Not an IP address: "+e);var t=e.split(".");return 256*(256*(256*+t[0]+ +t[1])+ +t[2])+ +t[3];},toString:function toString(e){if("string"==typeof e&&!0===this.isIp(e))return e;if(!1===this.isDecimalIp(e))throw new Error("Not a numeric IP address: "+e);for(var t=e%256,r=3;r>0;r--)t=(e=Math.floor(e/256))%256+"."+t;return t;}},t=function t(e){this._file=e,this._file||(this._file=t.FILE),this._globalOptions=[],this._interfaceOptions={};};t.FILE="/etc/dhcpcd.conf",t.prototype.init=function(e){this._read(function(t){e&&e(t);});},t.prototype.getConfig=function(t){var r={dhcp:!0};if(!this._interfaceOptions||!this._interfaceOptions[t])return r;for(var o=this._interfaceOptions[t],n=0;n<o.length;n++){var s=o[n];if(s&&"static"==s.substr(0,6)){r.dhcp=!1;var i=(s=s.substr(6).trim()).indexOf("=");if(-1!=i){var a=s.substr(0,i),l=s.substr(i+1);switch(a){case"ip_address":var c=l.split("/");if(1==c.length)r.ip=c[0],r.subnet="255.255.255.0";else{var u=e.calculateSubnetMask(c[0],parseInt(c[1]));r.ip=c[0],r.subnet=u.prefixMaskStr;}break;case"routers":r.router=l.split(" ");break;case"domain_name_servers":r.dns=l.split(" ");}}}}return r;},t.prototype.setConfig=function(t,r,o){if(t&&r){if(r.dhcp||r.ip&&r.subnet&&r.router&&r.dns){if(r.dhcp)delete this._interfaceOptions[t];else{var n=e.calculateSubnetMask(r.ip,r.subnet);if(!n)return void(o&&o(new Error("invalid argument")));this._interfaceOptions[t]=["static ip_address="+r.ip+"/"+n.prefixSize,"static routers="+(Array.isArray(r.router)?r.router.join(" "):r.router),"static domain_name_servers="+(Array.isArray(r.dns)?r.dns.join(" "):r.dns)];}this._write(function(e){o&&o(e);});}else o&&o(new Error("invalid argument"));}else o&&o(new Error("invalid argument"));},t.prototype._read=function(e){var t=this;require("fs").readFile(this._file,{encoding:"utf8"},function(r,o){if(r)e(r);else{if(o)for(var n=o.split("\n"),s=null,i=0;i<n.length;i++){var a=n[i].trim();a&&"#"!=a.charAt(0)&&("interface"==(a=a.trim()).substr(0,9)?s=a.substr(9).trim():s?(t._interfaceOptions[s]||(t._interfaceOptions[s]=[]),t._interfaceOptions[s].push(a)):t._globalOptions.push(a));}e();}});},t.prototype._write=function(e){var t="";for(var r in this._globalOptions.forEach(function(e){t+=e+"\n\n";}),this._interfaceOptions){t+="interface "+r+"\n";for(var o=this._interfaceOptions[o],n=0;n<o.length;n++){var s=o[n];t+="  "+s+"\n";}t+="\n";}require("fs").writeFile(this._file,t,function(t){e(t);});};var r=function r(e){this._file=e,e||(this._file=r.FILE);};r.FILE="/etc/resolv.conf",r.prototype.getDns=function(e){require("fs").readFile(this._file,{encoding:"utf8"},function(t,r){if(t)e&&e(t);else{for(var o=[],n=r.split("\n"),s=0;s<n.length;s++){var i=n[s].trim();if("#"!=i.charAt(0)&&"nameserver"==i.substr(0,10)){var a=i.substr(10).trim();o.push(a);}}e&&e(null,o);}});};var o=function o(e){this._logger=require("x.logger.js").getLogger("x.hub.v6.Network.Wifi"),this._file=e,e||(this._file=o.FILE),this._networks=[],this._wpaSocket=null,this._state=-2,this._initFinish=!1,this._scanCallback=null,this._scanTimeout=2e4,this._scanTo=null;};o.FILE="/config/wpa_supplicant.conf",o.SOCKET_PATH="/var/run/wpa_supplicant",o.prototype.init=function(e){var t=this;this._read(function(r,o){t._initFinish=!0,!r&&o&&(t._networks=o),e&&e(r),0==t._state&&t._checkInitWifiStatus();});},o.prototype.getFile=function(){return this._file;},o.prototype.reset=function(e){this._logger.log("trace","reset");var t=this;this._networks=[],this._write(function(r){t._logger.log("trace","reset "+(r?" failed: "+r.message:"success")),e&&e(r);});},o.prototype.restore=function(e,t){this._logger.log("trace","restore from:"+e);var r=require("fs"),o=require("fs-extra");try{r.existsSync(e+"/config/wpa_supplicant.conf")&&o.copySync(e+"/config/wpa_supplicant.conf",this._file),this._logger.log("trace","restore success"),t&&t();}catch(e){this._logger.log("trace","restore failed: "+e.message),t&&t(e);}},o.prototype.backup=function(e,t){this._logger.log("trace","backup to:"+e);var r=require("fs-extra"),o=this;r.copy(this._file,e+"/config/wpa_supplicant.conf",function(e){o._logger.log("trace","backup "+(e?"failed: "+e.message:"success")),t&&t(e);});},o.prototype.info=function(e,t){if(this._logger.log("trace","get wifi info"),this._wpaSocket){if(0==this._state){var r=this,o={};this._status(function(e,n){e?t&&t(e):(o.status={connected:!1},n&&("COMPLETED"==n.wpa_state&&(o.status.connected=!0),n.ssid&&(o.status.ssid=n.ssid)),o.networks=r._networks.map(function(e){var t=e.ssid;return'"'==t.charAt(0)?'"'==(t=t.substr(1)).charAt(t.length-1)&&(t=t.substr(0,t.length-1)):t=new Buffer(e.ssid,"hex").toString("utf8"),{ssid:t};}),o.status.connected?r._signalPoll(function(e,r){!e&&r&&(o.status.rssi=parseInt(r.RSSI)),t&&t(null,o);}):t&&t(null,o));});}else t&&t(new Error("current state not idle:"+this._state));}else t&&t(new Error("wlan not exist"));},o.prototype.scan=function(e,t){if(this._logger.log("trace","scan wifi on "+e),this._wpaSocket){if(0==this._state){var r=this;this._state=1,this._scanCallback=t,this._scan(function(e){e?(r._state=0,r._scanCallback=null,t&&t(e)):r._scanTo=setTimeout(function(){r._logger.log("trace","scan wifi timeout"),r._state=0,r._scanTo=null,r._scanCallback&&(r._scanCallback(new Error("scan wifi timeout")),r._scanCallback=null);},r._scanTimeout);});}else t&&t(new Error("current state not idle:"+this._state));}else t&&t(new Error("wlan not exist"));},o.prototype.connect=function(e,t,r){if(e&&t&&t.ssid&&t.password){if(this._logger.log("trace","connect wifi on "+e+" to "+t.ssid),this._wpaSocket){if(0==this._state){var o=this;this._state=2,this._logger.log("trace","calculate wpa passphrase"),this._wpaPassphrase(t.ssid,t.password,function(e,n){if(e)o._logger.log("trace","calculate wpa passphrase failed:"+e.message),o._state=0,r&&r(e);else{var s=new Buffer(t.ssid).toString("hex");o._networks=[{ssid:s,psk:n,id_str:'"'+t.ssid+'"'}],o._write(function(e){r&&r(e);});}});}else r&&r(new Error("current state not idle:"+this._state));}else r&&r(new Error("wlan not exist"));}else r&&r(new Error("invalid arguments"));},o.prototype.disconnect=function(e,t,r){e?(this._logger.log("trace","disconnect wifi on "+e),this._wpaSocket?0==this._state?(this._networks=[],this._write(function(e){r&&r(e);})):r&&r(new Error("current state not idle:"+this._state)):r&&r(new Error("wlan not exist"))):r&&r(new Error("invalid arguments"));},o.prototype.startWPAClient=function(e,t){if(this._logger.log("trace","start wpa client on "+e),this._wpaSocket)t&&t();else{var r=this;this._state=-1,this._checkWPADaemon(function(n){if(r._state=0,n)return r._logger.log("trace","wpa_supplicant not running"),void(t&&t(n));var s=new(require("wpa-client-socket"))(),i=o.SOCKET_PATH+"/"+e;s.on("data",function(e){r._onWPAData(e.toString("utf8"));}),s.bind(i),s.start(),r._wpaSocket=s,t&&t(),r._initFinish&&r._checkInitWifiStatus();});}},o.prototype._onWPAData=function(e){var t=e.trim();this._logger.log("trace","wpa data:"+t),"<"==t.charAt(0)&&">"==t.charAt(2)&&(t=t.substr(3));var r=this;"CTRL-EVENT-SCAN-RESULTS"==t.substr(0,23)?1==this._state&&this._scanResults(function(e,t){r._state=0,r._scanTo&&(clearTimeout(r._scanTo),r._scanTo=0),r._scanCallback&&(r._scanCallback(e,t),r._scanCallback=null);}):"CTRL-EVENT-CONNECTED"==t.substr(0,20)?require("x.hub.v6.js")._led.stopWifiDisconnect():"CTRL-EVENT-DISCONNECTED"==t.substr(0,23)&&require("x.hub.v6.js")._led.startWifiDisconnect();},o.prototype._status=function(e){this._logger.log("trace","do STATUS command");var t=this._wpaSocket.write("STATUS");this._logger.log("trace","STATUS command result:\n"+t.toString("utf8"));var r=t.toString("utf8");if(r){for(var o={},n=r.trim().split("\n"),s=0;s<n.length;s++){var i=n[s].trim();if(i){var a=i.indexOf("=");if(-1!=a){var l=i.substr(0,a),c=i.substr(a+1);l&&(o[l]="ssid"==l?this._ssid2utf8(c):c);}}}e(null,o);}else e(new Error("do STATUS command failed"));},o.prototype._scan=function(e){this._logger.log("trace","do SCAN command");var t=this._wpaSocket.write("SCAN");this._logger.log("trace","SCAN command result:\n"+t.toString()),"OK\n"!=t.toString()?e(new Error("do scan command failed")):e();},o.prototype._scanResults=function(e){this._logger.log("trace","do SCAN_RESULTS command");var t=this._wpaSocket.write("SCAN_RESULTS");this._logger.log("trace","SCAN_RESULTS command result:\n"+t.toString("utf8"));var r=t.toString("utf8");if(r){for(var o=[],n=r.trim().split("\n"),s=1;s<n.length;s++){var i=n[s].trim();if(i){var a=i.split("\t");if(a.length>=5&&a[4]){var l=a[4].trim();if(l=this._ssid2utf8(l).trim()){var c={bssid:a[0].trim(),frequency:parseInt(a[1].trim()),signal:parseInt(a[2].trim()),flags:a[3].trim(),ssid:l};o.push(c);}}}}e(null,o);}else e(new Error("do SCAN_RESULTS command failed"));},o.prototype._signalPoll=function(e){this._logger.log("trace","do SIGNAL_POLL command");var t=this._wpaSocket.write("SIGNAL_POLL");this._logger.log("trace","SIGNAL_POLL command result:\n"+t.toString("utf8"));var r=t.toString("utf8");if(r){for(var o={},n=r.trim().split("\n"),s=0;s<n.length;s++){var i=n[s].trim();if(i){var a=i.indexOf("=");if(-1!=a){var l=i.substr(0,a),c=i.substr(a+1);l&&(o[l]=c);}}}e(null,o);}else e(new Error("do SIGNAL_POLL command failed"));},o.prototype._checkInitWifiStatus=function(){var e=this;this._status(function(t,r){!t&&r&&"COMPLETED"!=r.wpa_state&&e._networks.length&&require("x.hub.v6.js")._led.startWifiDisconnect();});},o.prototype._wpaPassphrase=function(e,t,r){this._logger.log("trace","call wpa_passphrase wiht ssid:"+e+" password:********");var o=(0,require("child_process").exec)('wpa_passphrase "'+e+'" "'+t+'"'),n=this,s=null;o.stdout.on("data",function(e){s+=String(e);}),o.on("error",function(e){r&&(r(e),r=null);}),o.on("close",function(e){if(0==e){for(var t=null,o=s.split("\n"),i=0;i<o.length;i++){var a=o[i].trim();if(a&&"psk="==a.substr(0,4)){t=a.substr(4);break;}}n._logger.log("trace","call wpa_passphrase get psk:"+t),r&&(r(null,t),r=null);}else r&&(r(new Error("exit with code:"+e)),r=null);});},o.prototype._read=function(e){require("fs").readFile(this._file,{encoding:"utf8"},function(t,r){if(t)e(t);else{var o=[];if(r)for(var n=r.split("\n"),s=null,i=0;i<n.length;i++){var a=n[i].trim();if(a&&"#"!=a.charAt(0))if("network="==a.substr(0,8))s={};else if("}"==a)s&&o.push(s),s=null;else if(s){var l=a.split("="),c=l[0],u=l[1];c&&(s[c]=u);}}e(null,o);}});},o.prototype._write=function(e){var t="ctrl_interface=/var/run/wpa_supplicant\n";t+="update_config=1\n\n";for(var r=0;r<this._networks.length;r++){var o=this._networks[r];if(o){for(var n in t+="network={\n",o)t+="\t"+n+"="+o[n]+"\n";t+="}\n";}}require("fs").writeFile(this._file,t,function(t){e(t);});},o.prototype._checkWPADaemon=function(e){var t=0,r=this,o=function o(n,s){t++,n||!s?t>=10?e(new Error("no pid")):setTimeout(function(){r._getWpaSupplicantPID(o);},1e3):e();};this._getWpaSupplicantPID(o);},o.prototype._getWpaSupplicantPID=function(e){var t=(0,require("child_process").exec)("pidof wpa_supplicant"),r=null;t.stdout.on("data",function(e){r=String(e).trim();}),t.on("error",function(t){e&&(e(t),e=null);}),t.on("close",function(t){e&&(e(null,r),e=null);});},o.prototype._ssid2utf8=function(e){for(var t=[],r=0;r<e.length;)if("\\"==e.charAt(r)){if(r!=e.length-1){if("x"==e.charAt(r+1)){if(r+3>=e.length)r+=4;else{var o=e.charAt(r+2)+e.charAt(r+3),n=parseInt(o,16);isNaN(n)||t.push(n),r+=4;}}else t.push(e.charCodeAt(r+1)),r+=2;}else t.push(e.charCodeAt(r)),r++;}else t.push(e.charCodeAt(r)),r++;return new Buffer(t).toString("utf8");};var n=function n(e){this._logger=require("x.logger.js").getLogger("x.hub.v6.Network"),this._handler=e,this._dhcpcdConf=null,this._resolvConf=null,this._wifi=null,this._eth0=null,this._wlan0=null;};return n.DHCPCD_CONF="/etc/dhcpcd.conf",n.RESOLV_CONF="/etc/resolv.conf",n.WPA_SUPPLICANT_CONF="/config/wpa_supplicant.conf",n.SET_MAC_SCRIPT="/opt/scripts/set_mac_address.sh",n.prototype.init=function(e){global.SYSTEM_ROOT&&(n.DHCPCD_CONF=global.SYSTEM_ROOT+n.DHCPCD_CONF,n.RESOLV_CONF=global.SYSTEM_ROOT+n.RESOLV_CONF,n.WPA_SUPPLICANT_CONF=global.SYSTEM_ROOT+n.WPA_SUPPLICANT_CONF,n.SET_MAC_SCRIPT=global.SYSTEM_ROOT+n.SET_MAC_SCRIPT);var s=require("x.hub.eventbus.js");s.on("x.hub.peripheralman.ADD_WLAN",function(e){i._logger.log("debug","insert wlan usb stick: "+e.port),"wlan0"==e.port&&i._readMac(e.port,function(e,t){!e&&t&&(i._wlan0={mac:t}),i._wifi.startWPAClient("wlan0");});}),s.on("x.hub.peripheralman.REMOVE_WLAN",function(e){i._logger.log("debug","eject wlan usb stick: "+e.port),"wlan0"==e.port&&(i._wlan0=null);}),this._resolvConf=new r(n.RESOLV_CONF),this._dhcpcdConf=new t(n.DHCPCD_CONF),this._wifi=new o(n.WPA_SUPPLICANT_CONF);var i=this;this._readMac("eth0",function(t,r){!t&&r&&(i._eth0={mac:r}),i._dhcpcdConf.init(function(){i._wifi.init(e);});});},n.prototype.getMediolaMac=function(){return this._eth0?this._eth0.mac:null;},n.prototype.getNetwork=function(e){var t=this;this._getDNS(function(r,o){t._getRouter(function(r,n){var s=require("os").networkInterfaces(),i={};for(var a in s)if("lo"!=a.substr(0,2))for(var l=s[a],c=0;c<l.length;c++){var u=l[c];if(!u.internal&&"IPv4"==u.family){var f={ip:u.address,subnet:u.netmask,mac:u.mac},g=t._dhcpcdConf.getConfig(a);f.dhcp=g.dhcp,g.dhcp?(f.router=n?n[a]:null,f.dns=o):(f.router=g.router[0],f.dns=g.dns),i[a]=f;}}t._eth0&&!i.eth0&&(i.eth0={mac:t._eth0.mac}),t._wlan0&&!i.wlan0&&(i.wlan0={mac:t._wlan0.mac}),e&&e(null,i);});});},n.prototype.setNetwork=function(e,t,r){if(t){if(1==t.dhcp||0==t.dhcp){e||(e="eth0");var o={};"eth0"==e?1==t.dhcp?o.ETH0_DHCP="true":0==t.dhcp&&(o.ETH0_DHCP="false",o.ETH0_IP=t.ip,o.ETH0_MASK=t.subnet,o.ETH0_ROUTER=t.router,o.ETH0_DNS=t.dns.join(" ")):"wlan0"==e&&(1==t.dhcp?o.WLAN0_DHCP="true":0==t.dhcp&&(o.WLAN0_DHCP="false",o.WLAN0_IP=t.ip,o.WLAN0_MASK=t.subnet,o.WLAN0_ROUTER=t.router,o.WLAN0_DNS=t.dns.join(" "))),this._handler._sysConf.setValues(o,function(e){r&&r(e);});}else r&&r(new Error("invalid argument"));}else r&&r(new Error("invalid argument"));},n.prototype.setMAC=function(e,t){var r=(0,require("child_process").exec)(n.SET_MAC_SCRIPT+" "+e);r.stdout.on("data",function(e){console.log(String(e));}),r.on("error",function(e){t&&(t(e),t=null);}),r.on("close",function(e){t&&(t(0==e?null:new Error("set mac address failed")),t=null);});},n.prototype.scanWifi=function(e,t){if(this._wlan0){var r=this;this._logger.log("debug","scan wifi with options: "+JSON.stringify(e)),this._wifi.scan("wlan0",function(e,o){r._logger.log("debug","scan wifi "+(e?"failed: "+e.message:"success: "+JSON.stringify(o))),!e&&o&&(o=o.filter(function(e){return!(!e||!e.flags||-1!=e.flags.indexOf("EAP")||-1!=e.flags.indexOf("WEP"));})),t&&t(e,o);});}else t&&t(new Error("wlan not avaliable"));},n.prototype.connectWifi=function(e,t){if(this._wlan0){if(e&&e.ssid&&e.password){var r=!1;"true"!=e.dhcp&&"1"!=e.dhcp&&1!=e.dhcp||(r=!0);var o=this;this._logger.log("debug","connect to wifi to: "+e.ssid+(r?" (dhcp=true)":"")),this._wifi.connect("wlan0",e,function(e){o._logger.log("debug","connect wifi "+(e?"failed: "+e.message:"success")),e?t&&t(e):r?(o._logger.log("debug","enable dhcp of wlan0"),o._handler._sysConf.setValues({WLAN0_DHCP:"true"},function(e){o._logger.log("debug","enable dhcp of wlan0 "+(e?" failed: "+e.message:" success")),t&&t(e);})):t&&t();});}else t&&t(new Error("invalid arguments"));}else t&&t(new Error("wlan not avaliable"));},n.prototype.disconnectWifi=function(e,t){if(this._wlan0){var r=this;this._logger.log("debug","disconnect wifi"),this._wifi.disconnect("wlan0",e,function(e){r._logger.log("debug","disconnect wifi "+(e?"failed: "+e.message:"success")),t&&t(e);});}else t&&t(new Error("wlan not avaliable"));},n.prototype.getWifiInfo=function(e,t){if(this._wlan0){var r=this;this._logger.log("debug","get wifi info"),this._wifi.info(null,function(e,o){if(r._logger.log("debug","get wifi status "+(e?" failed:"+e.message:" success:"+JSON.stringify(o))),e)t&&t(e);else{var n=r._handler._sysConf.getValueSync("WLAN0_DHCP");if(o.config={wlan0:{dhcp:"true"==n||1==n||""==n}},!o.config.wlan0.dhcp){o.config.wlan0.ip=r._handler._sysConf.getValueSync("WLAN0_IP"),o.config.wlan0.subnet=r._handler._sysConf.getValueSync("WLAN0_MASK"),o.config.wlan0.router=r._handler._sysConf.getValueSync("WLAN0_ROUTER");var s=r._handler._sysConf.getValueSync("WLAN0_DNS");o.config.wlan0.dns=s?s.split(" "):[];}t&&t(e,o);}});}else t&&t(new Error("wlan not avaliable"));},n.prototype.resetNetwork=function(e){this._logger.log("debug","reset");var t=this;this._wifi.reset(function(r){if(r)return t._logger.log("debug","reset wifi failed: "+r.message),void(e&&e(r));t._handler._sysConf.setValues({ETH0_DHCP:"true",WLAN0_DHCP:"true"},function(r){r?t._logger.log("debug","reset to dhcp failed: "+r.message):t._logger.log("debug","reset success"),e&&e(r);});});},n.prototype.restore=function(e,t){this._logger.log("debug","restore from:"+e);var r=this;this._wifi.restore(e,function(e){r._logger.log("debug","restore "+(e?"failed: "+e.message:"success")),t&&t(e);});},n.prototype.backup=function(e,t){this._logger.log("debug","backup to:"+e);var r=this;this._wifi.backup(e,function(e){r._logger.log("debug","backup "+(e?"failed: "+e.message:"success")),t&&t(e);});},n.prototype._getDNS=function(e){this._resolvConf.getDns(e);},n.prototype._getRouter=function(e){var t=(0,require("child_process").exec)("route -n"),r=null;t.stdout.on("data",function(e){r+=String(e);}),t.on("error",function(t){e&&(e(t),e=null);}),t.on("close",function(t){if(0==t){for(var o={},n=r.split("\n"),s=2;s<n.length;s++){var i=n[s].trim().split(" ").filter(function(e){return!!e;});i.length&&"0.0.0.0"==i[0].trim()&&(o[i[7].trim()]=i[1].trim());}e&&(e(null,o),e=null);}else e&&(e(new Error("exit with code:"+t)),e=null);});},n.prototype._readMac=function(e,t){if("PI-CM3+"==global.PLATFORM){var r=this;this._logger.log("trace","read "+e+" mac"),require("fs").readFile("/sys/class/net/"+e+"/address",{encoding:"utf8"},function(o,n){var s;r._logger.log("trace","read "+e+" mac "+(o?" failed:"+o.message:" success:"+n)),n&&(s=(n=n.trim()).replace(/:/g,"-")),t(o,s);});}else t();},n;}(),x.hub.v6.SystemConf=function(){var e=function e(){this._conf={},this._writeCallbacks=[],this._writing=!1;};return e.FILE="/config/system.conf",e.prototype.init=function(t){global.SYSTEM_ROOT&&(e.FILE=SYSTEM_ROOT+e.FILE),this._readConf(function(){t&&t();});},e.prototype.getValueSync=function(e){if(null==e||null==e||"string"!=typeof e)throw new Error("invalid key");var t=this._conf[e];return null!=t&&null!=t||(t=""),t;},e.prototype.getValue=function(e,t){if(null!=e&&null!=e&&"string"==typeof e){var r=this._conf[e];null!=r&&null!=r||(r=""),t&&t(null,r);}else t&&t(new Error("invalid key"));},e.prototype.setValue=function(e,t,r){null!=e&&null!=e&&"string"==typeof e?null!=t&&null!=t&&"string"==typeof t?(this._conf[e]=t,r&&this._writeCallbacks.push(r),this._writing||this._doNextWrite()):r&&r(new Error("invalid value")):r&&r(new Error("invalid key"));},e.prototype.setValues=function(e,t){if(e){var r=0;for(var o in e)if(null!=o&&null!=o&&"string"==typeof o){var n=e[o];null!=n&&null!=n&&"string"==typeof n&&(r++,this._conf[o]=n);}0!=r?(t&&this._writeCallbacks.push(t),this._writing||this._doNextWrite()):t&&t(new Error("no valid entry"));}else t&&t(new Error("invalid map"));},e.prototype.reset=function(e){this._conf={},e&&this._writeCallbacks.push(e),this._writing||this._doNextWrite();},e.prototype.restore=function(t,r){var o=require("fs"),n=require("fs-extra");if(o.existsSync(t+"/config/system.conf"))try{n.copySync(t+"/config/system.conf",e.FILE);}catch(t){}r&&r();},e.prototype.backup=function(t,r){require("fs-extra").copy(e.FILE,t+"/config/system.conf",function(e){r&&r(e);});},e.prototype._doNextWrite=function(){var e=this._writeCallbacks;this._writeCallbacks=[],this._writing=!0;var t=this;this._writeConf(function(r){t._writing=!1;for(var o=0;o<e.length;o++){var n=e[o];try{n(r);}catch(e){}}t._writeCallbacks&&t._writeCallbacks.length&&t._doNextWrite();});},e.prototype._readConf=function(e){var t=this;this._readFile(function(r,o){if(!r&&o)for(var n=o.split("\n"),s=0;s<n.length;s++){var i=n[s].trim();if(i){var a=i.indexOf("=");if(-1!=a){var l=i.substr(0,a).trim(),c=i.substr(a+1).trim();l&&(t._conf[l]=c);}}}e();});},e.prototype._writeConf=function(e){var t="";for(var r in this._conf)t+=r+"="+this._conf[r]+"\n";this._writeFile(t,e);},e.prototype._readFile=function(t){require("fs").readFile(e.FILE,{encoding:"utf8"},function(e,r){t(e,r);});},e.prototype._writeFile=function(t,r){require("fs").writeFile(e.FILE,t,function(e){r(e);});},e;}(),x.hub.v6.Location=function(){var e=function e(t){this._logger=require("x.logger.js").getLogger("x.hub.v6.Location"),this._lat=e.DEFAULT_LATITUDE,this._long=e.DEFAULT_LONGITUDE,this._handler=t;};return e.DEFAULT_LATITUDE="020D",e.DEFAULT_LONGITUDE="0087",e.prototype.init=function(e){if(localStorage){var t=localStorage.getItem("x.hub.Server.geo.lat");t&&(self._lat=t);var r=localStorage.getItem("x.hub.Server.geo.long");r&&(self._long=r);}e&&e();},e.prototype.setLocation=function(e,t,r){if(this._logger.log("debug","set location lat="+e+" long="+t),e&&t){this._lat=e,this._long=t;var o=this;this._handler._stm.sendCommand(16,"XC_FNC=setLocation&lat="+e+"&long="+t,function(n){o._logger.log("debug","set location to stm lat="+e+" long="+t+" result:"+JSON.stringify(n)),localStorage&&(localStorage.setItem("x.hub.Server.geo.lat",e),localStorage.setItem("x.hub.Server.geo.long",t)),r&&r(n?n.error:null);});}else r&&r(new Error("invalid lat/long"));},e.prototype.getLocation=function(e){e&&e(null,this._lat,this._long);},e.prototype.restore=function(t,r,o){this._logger.log("trace","restore geo location");var n=require("fs"),s=require("path"),i=null,a=null,l=0,c=this,u=function u(){if(2==++l){if(r&&"v5+"==r.backupType){i&&a||(i="1392",a="035C");var t=parseInt(i,16);for(t=(t=Math.round(t/10)).toString(16);t.length<4;)t="0"+t;var s=parseInt(a,16);for(s=(s=Math.round(s/10)).toString(16);s.length<4;)s="0"+s;c._logger.log("trace","convert v5+ format to v6+ format: "+t+","+s),i=t,a=s;try{c._logger.log("trace","overwrite v6+ format latitude to "+f),n.writeFileSync(f,i.toUpperCase());}catch(t){c._logger.log("trace","overwrite v6+ format latitude to "+f+" failed:"+t.message);}try{c._logger.log("trace","overwrite v6+ format longitude to "+g),n.writeFileSync(g,a.toUpperCase());}catch(t){c._logger.log("trace","overwrite v6+ format longitude to "+g+" failed:"+t.message);}}else i&&a||(i=e.DEFAULT_LATITUDE,a=e.DEFAULT_LONGITUDE);c.setLocation(i,a,o);}},f=s.join(t,"data","localstorage","x.hub.Server.geo.lat");n.existsSync(f)?(this._logger.log("trace","read latitude from backup file: "+f),n.readFile(f,{encoding:"utf8"},function(e,t){c._logger.log("trace","read latitude from backup file"+(e?" failed:"+e.message:" success:"+t)),!e&&t&&(i=t),u();})):u();var g=s.join(t,"data","localstorage","x.hub.Server.geo.long");n.existsSync(g)?(this._logger.log("trace","read longitude from backup file: "+f),n.readFile(g,{encoding:"utf8"},function(e,t){c._logger.log("trace","read longitude from backup file"+(e?" failed:"+e.message:" success:"+t)),!e&&t&&(a=t),u();})):u();},e;}(),x.hub.v6.STM=function(){var e=require("util"),t=require("events"),r=require("x.hub.v5.js").USBSerial,o=function o(e,t){this._logger=require("x.logger.js").getLogger("x.hub.v6.STM.Serial"),this._port=e||n.SERIAL_PORT,this._baudrate=t||n.SERIAL_BAUDRATE,this._stmUSBSerial=null,this._receiveBuffer=new Buffer([]),this._onData=null,this._useAck=!0,this._reqFifo=[],this.REQ_FIFO_MAX_LEN=5,this.ACK_TO=200,this.RSP_TO=1e4,this.MAX_RSP_TO=3e4,this.RSP_END_TO=2e3;};e.inherits(o,r),o.prototype._openSTMUSB=function(e){if(this._stmUSBSerial)e&&e(!0);else{var t=this,r=e,o=require("xnm.aio.m10T.js"),n=this._baudrate,s=new o.STMUSBSerial();s.on("error",function(e){t._logger.log("error","st port error "+e.message);try{t._stmUSBSerial.close();}catch(e){}t._stmUSBSerial=null,r&&r(!1),r=null;}),s.on("timeout",function(){t._logger.log("trace","st port timeout");}),s.on("data",function(e){t._logger.log("trace","st data:"+e.toString("hex")),t._receiveBuffer=Buffer.concat([t._receiveBuffer,e]);for(var r=t._getNextDataPackage();r;){t._logger.log("trace","st package:"+r.toString("hex"));var o=r.slice(1,r.length-1);switch(r[0]){case 80:t._logger.log("info","receive st event:"+o.toString()),t._sendAck();break;case 0:t._onNak();break;case 1:t._onAck();break;case 34:t._sendAck(),t._onRspError(o);break;case 32:t._sendAck(),t._onRsp(o);break;case 33:t._sendAck(),t._onRspEnd(o);break;default:t._sendAck();}t._onData&&t._onData({type:r[0],data:o}),r=t._getNextDataPackage();}}),s.on("close",function(){t._logger.log("trace","on close ");}),s.open(this._port,function(){t._logger.log("trace","st connected"),t._stmUSBSerial=s,r&&r(!0),r=null;},n);}};var n=function n(e,t,r,s){this._logger=require("x.logger.js").getLogger("x.hub.v6.STM"),this._handler=e,this._pin=s||n.RESET_PIN,this._state=0,this._last_error=0;var i=this;this._serial=new o(t||n.SERIAL_PORT,r||n.SERIAL_BAUDRATE),this._serial.on("data",function(e){i._onData(e);}),this._resetCB=null,this._resetTO=null,this._flashCB=null,this._flashTO=null,this._enableStatesBuffer=!1,this._deviceStatesBuffer=null,this._deviceStatesBufferTimeout=10,this._deviceStatesBufferTO=null,this.retryCount=1;};return e.inherits(n,t),n.SERIAL_PORT="/dev/ttyS0",n.SERIAL_BAUDRATE=230400,n.BOOT_PIN=4,n.RESET_PIN=5,n.MODE_SCRIPT="/opt/scripts/set_stm_mode.sh",n.FIRMWARE_FILE="/opt/firmware/latest.bin",n.prototype.init=function(e){if(global.SYSTEM_ROOT&&(n.MODE_SCRIPT=SYSTEM_ROOT+n.MODE_SCRIPT,n.FIRMWARE_FILE=SYSTEM_ROOT+n.FIRMWARE_FILE),localStorage){var t=localStorage.getItem("x.hub.v6.STM.ENABLE_STATES_BUFFER");t&&"true"==t&&(this._enableStatesBuffer=!0);var r=localStorage.getItem("x.hub.v6.STM.STATES_BUFFER_TIMEOUT");r&&!isNaN(parseInt(r))&&(this._deviceStatesBufferTimeout=parseInt(r));}var o=this;this._state=1,this._serial._openSTMUSB(function(t){t?(o._state=2,o._checkPeriodically()):(o._state=0,o._last_error=1),e&&e(t);});},n.prototype.getSettings=function(e){e&&e(null,{enable_stm_states_buffer:this._enableStatesBuffer,stm_states_buffer_timeout:this._deviceStatesBufferTimeout});},n.prototype.setSettings=function(e,t){e?(null!=e.enable_stm_states_buffer&&void 0!==e.enable_stm_states_buffer&&(localStorage&&localStorage.setItem("x.hub.v6.STM.ENABLE_STATES_BUFFER",e.enable_stm_states_buffer),this._enableStatesBuffer=e.enable_stm_states_buffer),null!=e.stm_states_buffer_timeout&&void 0!==e.stm_states_buffer_timeout&&(localStorage&&localStorage.setItem("x.hub.v6.STM.STATES_BUFFER_TIMEOUT",e.stm_states_buffer_timeout),this._deviceStatesBufferTimeout=e.stm_states_buffer_timeout),t&&t()):t&&t();},n.prototype.reset=function(e){if(5!=this._state){if(2==this._state){this._logger.log("trace","do stm factory reset");var t=this;this._state=5,this._serial.reset(function(){t._serial.sendCommand(53,[],function(r){var o=null;if(r&&!r.error||(o=r?r.error:new Error("reset stm failed")),o)return t._logger.log("trace","do stm factory reset failed:"+o.message),void(e&&e(o));t._resetCB=function(){t._resetTO&&(clearTimeout(t._resetTO),t._resetTO=null),t._state=2,e&&e();},t._resetTO=setTimeout(function(){t._resetTO=null,t._state=2,e&&e(new Error("reset timeout"));},3e4);});});}else e&&e(new Error("stm has state:"+this._state));}else e&&e(new Error("stm is resetting"));},n.prototype.reboot=function(e){if(3!=this._state){if(2==this._state){this._logger.log("trace","reboot stm");var t=this;this._state=3,this._serial.reset(function(){t._setSTMMode("reboot",function(r){t._logger.log("trace","reboot stm "+(r?"failed:"+r.message:"success")),t._state=2,e&&e(r);});});}else e&&e(new Error("stm has state:"+this._state));}else e&&e(new Error("stm is rebooting"));},n.prototype.backup=function(e,t){var r=this,o=function o(e,t,_o){r.sendCommand(16,e,function(e){e&&e.data?e.error?_o(new Error("response error:"+e.data.toString())):require("fs").writeFile(t,e.data.toString(),function(e){_o(e);}):_o(new Error("invalid response"));});};r._logger.log("trace","backup get all"),o("XC_FNC=GetAll",e+"/all.json",function(n){r._logger.log("trace","backup get states"),o("XC_FNC=GetStates&config=1",e+"/states.json",function(n){if(n)return r._logger.log("warn","backup get states failed:"+n.message),void(t&&t(n));r._logger.log("trace","backup get si"),o("XC_FNC=GetSI",e+"/si.json",function(n){if(n)return r._logger.log("warn","backup get si failed:"+n.message),void(t&&t(n));r._logger.log("trace","backup get config (hmip)"),o("XC_FNC=GetConfig&sys=HmIP",e+"/conf_hmip.json",function(n){if(n)return r._logger.log("warn","backup get config (hmip) failed:"+n.message),void(t&&t(n));r._logger.log("trace","backup get sys (hmip)"),o("XC_FNC=GetSys&sys=HmIP",e+"/sys_hmip.json",function(e){e&&r._logger.log("warn","backup get sys (hmip) failed:"+e.message),t&&t(e);});});});});});},n.prototype.restore=function(e,t){if(6!=this._state){if(2==this._state){this._state=6;var r,o=this,n=function n(e,t){var r=function r(e,t){var r="XC_FNC=setRFM&data="+e.mode;e.type&&(r+="&type="+e.type),o._serial.sendCommand(16,r,function(e){t();});};!function(e,t){var r=require("fs-extra"),o=e+"/si.json";r.existsSync(o)?r.readFile(o,{encoding:"utf8"},function(e,r){if(e)t(e);else if(r)try{var o=JSON.parse(r);t(null,o);}catch(e){t(e);}else t(null,null);}):t();}(e,function(e,n){e?t(e):n&&0!=Object.keys(n).length?function(e,t){o._logger.log("trace","restore tz"),function(e,t){e.TZ?o._serial.sendCommand(16,"XC_FNC=setTZ&data="+e.TZ,function(e){t();}):t();}(e,function(n){n&&o._logger.log("warn","restore tz failed:"+n.message),o._logger.log("trace","restore geo location"),function(e,t){e.LAT&&e.LONG?o._serial.sendCommand(16,"XC_FNC=setLocation&lat="+e.LAT+"&long="+e.LONG,function(e){t();}):t();}(e,function(n){n&&o._logger.log("warn","restore geo location failed:"+n.message);var s={mode:e.RFM.substr(2,2),type:433};o._logger.log("trace","restore 433 sensor mode"),r(s,function(n){n&&o._logger.log("warn","restore 433 sensor mode failed:"+n.message),s={mode:e.RFM.substr(0,2)},o._logger.log("trace","restore 868 sensor mode"),r(s,function(r){r&&o._logger.log("warn","restore 868 sensor mode failed:"+r.message),o._logger.log("trace","restore elero address"),function(e,t){var r=null;e.ER&&"object"==_typeof(e.ER)&&"string"==typeof e.ER.ADR?r=e.ER.ADR:"string"==typeof e.EID&&(r=e.EID,isLegacy=!0),r?o._serial.sendCommand(16,"XC_FNC=setConfig&type=ER&adr="+r,function(e){t();}):t();}(e,function(r){r&&o._logger.log("warn","restore elero address failed:"+r.message),o._logger.log("trace","restore hm address"),function(e,t){var r=null;e.HM&&"object"==_typeof(e.HM)&&"string"==typeof e.HM.ADR?r=e.HM.ADR:"string"==typeof e.HMADR&&(r=e.HMADR),r?o._serial.sendCommand(16,"XC_FNC=setConfig&sys=HM&type=ADR&config="+r,function(e){t();}):t();}(e,function(e){e&&o._logger.log("warn","restore hm address failed:"+e.message),t();});});});});});});}(n,function(){t();}):t();});};o._logger.log("trace","reset stm for restore"),r=function r(_r){if(_r)return o._state=2,o._logger.log("warn","reset stm for restore failed:"+_r.message),void(t&&t(_r));o._logger.log("trace","restore system info"),n(e,function(r){r&&o._logger.log("warn","restore system info failed:"+r.message),o._logger.log("trace","restore tasks"),function(e,t){var r=function r(e,t){if(e.length){var n=e.pop();if("string"==typeof n.sys){var s="Add"+n.sys.charAt(0).toUpperCase()+n.sys.slice(1).toLowerCase();"sevent"===n.sys.toLowerCase()&&(s="AddSensorEvent"),n.XC_FNC=s,o._serial.sendCommand(17,JSON.stringify(n),function(o){r(e,t);});}else r(e,t);}else t();};!function(e,t){var r=require("fs-extra"),o=e+"/all.json";r.existsSync(o)?r.readFile(o,{encoding:"utf8"},function(e,r){if(e)t(e);else if(r)try{var o=JSON.parse(r);t(null,o);}catch(e){t(e);}else t(null,[]);}):t();}(e,function(e,o){e?t(e):o&&0!=o.length?r(o,function(){t();}):t();});}(e,function(r){r&&o._logger.log("warn","restore tasks failed:"+r.message),o._logger.log("trace","restore state devices"),function(e,t){var r=function r(e,t){if(e.length){var n=require("querystring"),s=e.pop();if("EVENT"!=s.type){if("HM"===s.type||"HMFHT"===s.type){if(String(s.adr).toUpperCase().startsWith("HMIP-"))return void r(e,t);var i=null;12==s.adr.length?(i=s.adr.substr(-4),s.adr=s.adr.substr(0,8)):i="FFFF",s.adr=i+s.adr,"HMFHT"===s.type&&delete s.state;}else"CF4"==s.type&&(s.adr="0001"+s.adr);var a=n.stringify(s);a="XC_FNC=AddSensor&"+a,o._serial.sendCommand(16,a,function(o){r(e,t);});}else r(e,t);}else t();};!function(e,t){var r=require("fs-extra"),o=e+"/states.json";r.existsSync(o)?r.readFile(o,{encoding:"utf8"},function(e,r){if(e)t(e);else if(r)try{var o=JSON.parse(r);t(null,o);}catch(e){t(e);}else t(null,[]);}):t();}(e,function(e,o){e?t(e):o&&0!=o.length?r(o,function(){t();}):t();});}(e,function(r){r&&o._logger.log("warn","restore state devices failed:"+r.message),o._logger.log("trace","restore config (hmip)"),function(e,t){!function(e,t){var r=require("fs-extra"),o=e+"/conf_hmip.json";r.existsSync(o)?r.readFile(o,{encoding:"utf8"},function(e,r){if(e)t(e);else if(r)try{var o=JSON.parse(r);t(null,o);}catch(e){t(e);}else t(null,null);}):t();}(e,function(e,r){e?t(e):r?function(e,t){var r=e;r.XC_FNC="setConfig",r.sys="HmIP",o._serial.sendCommand(17,JSON.stringify(r),function(e){e&&e.data?t(null,e.data.toString()):e&&e.error?t(new Error(e.error)):t(new Error("fail"));});}(r,t):t();});}(e,function(r){r&&o._logger.log("warn","restore config (hmip) failed:"+r.message),o._logger.log("trace","restore sys (hmip)"),function(e,t){var r=function r(e,t){if(e.length){var n=e.pop();if(n){var s=n;s.XC_FNC="addSensor",s.type&&"HmIP"==s.type||(s.type="HmIP"),o._serial.sendCommand(17,JSON.stringify(s),function(o){r(e,t);});}else r(e,t);}else t();};!function(e,t){var r=require("fs-extra"),o=e+"/sys_hmip.json";r.existsSync(o)?r.readFile(o,{encoding:"utf8"},function(e,r){if(e)t(e);else if(r)try{var o=JSON.parse(r);t(null,o);}catch(e){t(e);}else t(null,null);}):t();}(e,function(e,o){e?t(e):o&&0!=o.length?r(o,function(){t();}):t();});}(e,function(e){e&&o._logger.log("warn","restore sys (hmip) failed:"+e.message),o._state=2,t&&t();});});});});});},o._serial.reset(function(){o._serial.sendCommand(53,[],function(e){var t=null;e&&!e.error||(t=e?e.error:new Error("reset stm failed")),t?r(t):(o._resetCB=function(){o._resetTO&&(clearTimeout(o._resetTO),o._resetTO=null),r();},o._resetTO=setTimeout(function(){o._resetTO=null,r(new Error("reset timeout"));},3e4));});});}else t&&t(new Error("stm has state:"+this._state));}else t&&t(new Error("stm restore process is running"));},n.prototype.flashFirmware=function(e,t){if(4!=this._state){if(0==this._state||2==this._state){e||(e=n.FIRMWARE_FILE),this._logger.log("trace","start to flash stm firmware:"+e);var r=this._state;this._state=4;var o=this;this._serial.reset(function(){o._setSTMMode("bootloader",function(n){if(n)return o._logger.logger("trace","flash stm failed to enter bootloader mode:"+n.message),void o._setSTMMode("reboot",function(){o._state=r,t&&t(n);});o._flashFirmware(e,function(e){e?o._setSTMMode("reboot",function(){o._state=r,t&&t(e);}):(o._logger.log("trace","flash stm firmware finish success"),o._logger.log("trace","wait stm reboot"),o._flashCB=function(){o._logger.log("trace","stm reboot finish"),o._flashTO&&(clearTimeout(o._flashTO),o._flashTO=null),o._state=r,t&&t(void 0);},o._flashTO=setTimeout(function(){o._logger.log("trace","stm reboot timeout"),o._flashTO=null,o._state=r,t&&t(new Error("reboot timeout"));},1e4));});});});}else t&&t(new Error("stm has state:"+this._state));}else t&&t(new Error("flash stm firmware proceess is running"));},n.prototype.sendCommand=function(e,t,r){if(2!=this._state)return this._logger.log("trace","reject send stm command, stm connection state:"+this._state),void(r&&r({error:"stm connection state:"+this._state}));var o=this._isGetStatesReq(t),n=this._isExecuteCommandReq(t);if(o&&this._enableStatesBuffer&&this._deviceStatesBuffer)r&&r({data:this._deviceStatesBuffer});else{var s=this;this._serial.sendCommand(e,t,function(e){o?s._handleGetStatesRes(e):n&&s._handleExecuteCommandRes(e),r&&r(e);});}},n.prototype._onData=function(e){if(e&&e.type&&e.data)if(80==e.type){var t=e.data.toString(),r=null;t.length>8&&"{XC_EVT}"==t.substr(0,8)?(t=t.substr(8),r="EVT"):t.length>4&&"EVT:"==t.substr(0,4)?(t=t.substr(4),r="EVT"):t.length>4&&"STA:"==t.substr(0,4)&&(t=t.substr(4),r="STA"),this._clearDeviceStatesBuffer(),this.emit("event",t,r);}else if(87==e.type){if(5==this._state||6==this._state){if(this._resetCB){try{this._resetCB();}catch(e){}this._resetCB=null;}}else if(4==this._state&&this._flashCB){try{this._flashCB();}catch(e){}this._flashCB=null;}}else if(81==e.type||83==e.type){(l=(l=e.data.readUInt8(0)).toString(16)).length%2!=0&&(l="0"+l);var o=require("x.hub.commandman.js").commandHandlerV6,n=81==e.type?{legacycloudaction:l}:{cloudaction:l};o.executeCommandWithCommandInfo(n,function(){},"stm");}else if(69==e.type){var s=e.data.readUInt8(0),i=require("x.hub.v6.js")._led;s?i.startDutyCycle():i.stopDutyCycle();}else if(70==e.type){var a=e.data.readUInt8(1);switch(i=require("x.hub.v6.js")._led,a){case 0:i.setColor(0,0,0);break;case 1:i.setColor(0,255,0);break;case 2:i.setColor(0,0,255);break;case 3:i.setColor(255,0,0);break;case 4:i.setColor(255,255,0);break;case 5:i.setColor(255,255,255);break;case 6:i.setColor(255,0,255);break;case 7:i.setColor(0,255,255);}}else if(90==e.type){var l=e.data.readUInt8(0);require("x.hub.action.js").getActionManager().executeActionWithId(l,function(){});}else 145==e.type&&require("x.hub.m.enocean.js").sendToFGW14(e.data,function(e){});},n.prototype._setSTMMode=function(e,t){var r=(0,require("child_process").exec)(n.MODE_SCRIPT+" "+e);r.on("error",function(e){t&&(t(e),t=null);}),r.on("close",function(r){t&&(t(0==r?null:new Error("set stm mode: "+e+" failed with code "+r)),t=null);});},n.prototype._flashFirmware=function(e,t){var r=this,o=new(0,require("xnm.aio.m10T.js").STMUpdater)(e);this._logger.log("trace","flash stm with dfu-util"),o.startDFUUpdate("dfu-util",function(e){t&&e&&(e.error?(r._logger.log("trace","flash stm failed:"+e.error),t(new Error(e.error)),t=null):e.state&&(r._logger.log("trace","flash stm progress:"+e.state),r.emit("flash",{progress:e.state}),100==e.state&&(r._logger.log("trace","flash stm success"),t(),t=null)));},null,"v6p");},n.prototype._isGetStatesReq=function(e){if("string"!=typeof e)return!1;var t=e.toLowerCase();return-1!=t.indexOf("xc_fnc=getstates")||-1!=t.indexOf('"xc_fnc":"getstates"');},n.prototype._handleGetStatesRes=function(e){e&&!e.error&&e.data&&this._setDeviceStatesBuffer(e.data);},n.prototype._isExecuteCommandReq=function(e){if("string"!=typeof e)return!1;var t=e.toLowerCase();return-1!=t.indexOf("xc_fnc=sendsc")||-1!=t.indexOf('"xc_fnc":"sendsc"')||-1!=t.indexOf("xc_fnc=setvar")||-1!=t.indexOf('"xc_fnc":"setvar"')||-1!=t.indexOf("xc_fnc=sendgenericcmd")||-1!=t.indexOf('"xc_fnc":"sendgenericcmd"')||-1!=t.indexOf("xc_fnc=refreshsc")||-1!=t.indexOf('"xc_fnc":"refreshsc"')||-1!=t.indexOf("xc_fnc=refreshhm")||-1!=t.indexOf('"xc_fnc":"refreshhm"')||-1!=t.indexOf("xc_fnc=ingetstate")||-1!=t.indexOf('"xc_fnc":"ingetstate"')||-1!=t.indexOf("xc_fnc=refresh")||-1!=t.indexOf('"xc_fnc":"refresh"');},n.prototype._handleExecuteCommandRes=function(e){e&&!e.error&&this._clearDeviceStatesBuffer();},n.prototype._setDeviceStatesBuffer=function(e){this._deviceStatesBuffer=e,this._deviceStatesBufferTO&&clearTimeout(this._deviceStatesBufferTO);var t=this;this._deviceStatesBufferTO=setTimeout(function(){t._deviceStatesBuffer=null;},1e3*this._deviceStatesBufferTimeout);},n.prototype._clearDeviceStatesBuffer=function(){this._deviceStatesBufferTO&&(clearTimeout(this._deviceStatesBufferTO),this._deviceStatesBufferTO=null),this._deviceStatesBuffer=null;},n.prototype._checkPeriodically=function(){var _this=this;try{setInterval(function(){if(!_this._serial._stmUSBSerial._serialPort.isOpen&&_this.retryCount<6){if(3==_this._state)return;_this._logger.log("trace","reboot try : "+_this.retryCount),_this.reboot(function(e){e?_this.retryCount++:_this._logger.log("trace","rebooted because of state change");});}},6e4);}catch(e){this.retryCount++,this._logger.log("error",e);}},n;}(),x.hub.v6.LED=function(){var e=function e(){this._logger=require("x.logger.js").getLogger("x.hub.v6.LED"),this._rgb=[255,255,255],this._state=0,this._buffer=[];};return e.STATE_NORMAL=0,e.STATE_BLINK=1,e.STATE_WIFI_DISCONNECT=2,e.STATE_DUTY_CYCLE=3,e.STATE_FLASH_STM=4,e.STATE_INIT_SYSTEM=5,e.STATE_RESET_SYSTEM=6,e.PROCESS="setlight",e.NAMED_PIPE="/tmp/rgb.cfg",e.prototype.init=function(){if(localStorage){var e=localStorage.getItem("x.hub.Server.led");e&&6==e.length&&e.match(/^([a-fA-F0-9]){6}/g)&&(this._rgb=[parseInt(e.substr(0,2),16),parseInt(e.substr(2,2),16),parseInt(e.substr(4,2),16)]);}},e.prototype.saveColor=function(e,t,r,o){var n=this;this.setColor(e,t,r,function(s){if(!s&&localStorage){n._rgb=[e,t,r];for(var i=new Buffer(n._rgb).toString("hex");i.length<6;)i="0"+i;localStorage.setItem("x.hub.Server.led",i);}o&&o(s);});},e.prototype.setColor=function(t,r,o,n){if(this._state>e.STATE_BLINK)n&&n(new Error("led state:"+this._state));else{var s=this;this._state=e.STATE_NORMAL,this._buffer[e.STATE_BLINK]=null,this._setColor(t,r,o,function(i){i||(s._buffer[e.STATE_NORMAL]=[t,r,o]),n&&n(i);});}},e.prototype.blinkColor=function(t,r,o,n,s){if(this._state>e.STATE_BLINK)s&&s(new Error("led state:"+this._state));else{var i=this;this._state=e.STATE_BLINK,this._buffer[e.STATE_BLINK]=[t,r,o,n],this._blinkColor(t,r,o,n,function(t){t?(i._state=e.STATE_NORMAL,i._buffer[e.STATE_BLINK]=null,i._setLastColor(function(){s&&s(t);})):s&&s();});}},e.prototype.stopBlinkColor=function(t){this._state==e.STATE_BLINK?(this._state=e.STATE_NORMAL,this._buffer[e.STATE_BLINK]=null,this._setLastColor(function(e){t&&t(e);})):t&&t();},e.prototype.startWifiDisconnect=function(t){if(this._logger.log("trace","start wifi disconnect (state="+this._state+")"),this._state!=e.STATE_WIFI_DISCONNECT){if(this._buffer[e.STATE_WIFI_DISCONNECT]=!0,this._state>e.STATE_WIFI_DISCONNECT)t&&t(new Error("led state:"+this._state));else{var r=this;this._state=e.STATE_WIFI_DISCONNECT,this._blinkColor(255,255,0,1e3,function(o){o&&(r._state=e.STATE_NORMAL,r._buffer[e.STATE_WIFI_DISCONNECT]=null,r._setLastColor(t)),t&&t(o);});}}else t&&t();},e.prototype.stopWifiDisconnect=function(t){this._buffer[e.STATE_WIFI_DISCONNECT]=null,this._state==e.STATE_WIFI_DISCONNECT?(this._state=e.STATE_NORMAL,this._setLastColor(function(e){t&&t(e);})):t&&t();},e.prototype.startDutyCycle=function(t){if(this._logger.log("trace","start duty cycle"),this._state!=e.STATE_DUTY_CYCLE){if(this._buffer[e.STATE_DUTY_CYCLE]=!0,this._state>e.STATE_DUTY_CYCLE)t&&t(new Error("led state:"+this._state));else{var r=this;this._state=e.STATE_DUTY_CYCLE,this._blinkColor(255,0,0,500,function(o){o&&(r._state=e.STATE_NORMAL,r._buffer[e.STATE_DUTY_CYCLE]=null,r._setLastColor(t)),t&&t(o);});}}else t&&t();},e.prototype.stopDutyCycle=function(t){this._logger.log("trace","stop duty cycle"),this._buffer[e.STATE_DUTY_CYCLE]=null,this._state==e.STATE_DUTY_CYCLE?(this._state=e.STATE_NORMAL,this._setLastColor(function(e){t&&t(e);})):t&&t();},e.prototype.startFlashSTM=function(t){if(this._state!=e.STATE_FLASH_STM){if(this._state>e.STATE_FLASH_STM)t&&t(new Error("led state:"+this._state));else{var r=this;this._state=e.STATE_FLASH_STM,this._buffer[e.STATE_FLASH_STM]=!0,this._blinkColor(255,255,0,50,function(o){o&&(r._state=e.STATE_NORMAL,r._buffer[e.STATE_FLASH_STM]=null,r._setLastColor(t)),t&&t(o);});}}else t&&t();},e.prototype.stopFlashSTM=function(t){this._buffer[e.STATE_FLASH_STM]=null,this._state==e.STATE_FLASH_STM?(this._state=e.STATE_NORMAL,this._setLastColor(function(e){t&&t(e);})):t&&t();},e.prototype.startSystemInit=function(t){if(this._logger.log("trace","start system init"),this._state!=e.STATE_INIT_SYSTEM){if(this._state>e.STATE_INIT_SYSTEM)t&&t(new Error("led state:"+this._state));else{var r=this;this._state=e.STATE_INIT_SYSTEM,this._buffer[e.STATE_INIT_SYSTEM]=!0,this._blinkColor(255,255,255,1e3,function(o){o&&(r._state=e.STATE_NORMAL,r._buffer[e.STATE_INIT_SYSTEM]=null,r._setLastColor(t)),t&&t(o);});}}else t&&t();},e.prototype.stopSystemInit=function(t){this._logger.log("trace","stop system init"),this._state==e.STATE_INIT_SYSTEM?(this._state=e.STATE_NORMAL,this._buffer[e.STATE_INIT_SYSTEM]=null,this._setLastColor(function(e){t&&t(e);})):t&&t();},e.prototype.startResetSystem=function(t,r,o,n){if(this._state>e.STATE_RESET_SYSTEM)n&&n(new Error("led state:"+this._state));else{var s=this;this._state=e.STATE_RESET_SYSTEM,this._buffer[e.STATE_RESET_SYSTEM]=[t,r,o],this._setColor(t,r,o,function(t){t&&(s._state=e.STATE_NORMAL,s._buffer[e.STATE_RESET_SYSTEM]=null,s._setLastColor(n)),n&&n(t);});}},e.prototype.stopResetSystem=function(t){this._state>e.STATE_RESET_SYSTEM?t&&t(new Error("led state:"+this._state)):(this._state=e.STATE_NORMAL,this._buffer[e.STATE_RESET_SYSTEM]=null,this._setColor(0,0,0,function(e){t&&t(e);}));},e.prototype._setLastColor=function(t){this._buffer[e.STATE_INIT_SYSTEM]?this.startSystemInit(t):this._buffer[e.STATE_FLASH_STM]?this.startFlashSTM(t):this._buffer[e.STATE_DUTY_CYCLE]?this.startDutyCycle(t):this._buffer[e.STATE_WIFI_DISCONNECT]?this.startWifiDisconnect(t):this._buffer[e.STATE_BLINK]?this.blinkColor(this._buffer[1][0],this._buffer[1][1],this._buffer[1][2],this._buffer[1][3],t):this._buffer[e.STATE_NORMAL]?this.setColor(this._buffer[0][0],this._buffer[0][1],this._buffer[0][2],t):this.setColor(this._rgb[0],this._rgb[1],this._rgb[2],t);},e.prototype._setColor=function(e,t,r,o){var n=[1,e,t,r,0,0],s=this._buildCommand(n);this._logger.log("trace","set color:"+s.toString("hex")),this._doCommand(s,function(e){o&&o(e);});},e.prototype._blinkColor=function(e,t,r,o,n){var s=[1,e,t,r,0,0];o%1e3==0?s[4]=o/1e3:(s[4]=Math.floor(o/1e3),s[5]=Math.round(o%1e3/20));var i=this._buildCommand(s);this._logger.log("trace","blink color:"+i.toString("hex")),this._doCommand(i,function(e){n&&n(e);});},e.prototype._buildCommand=function(e){for(var t=[170,e.length+3],r=(t=t.concat(e))[2],o=3;o<t.length;o++)r^=t[o];return t.push(r),new Buffer(t);},e.prototype._doCommand=function(e,t){var r=this;this._getPID(function(o,n){return o?(r._logger.log("trace","get program pid error:"+o.message),void(t&&t(o))):n?void r._write(e,t):(r._logger.log("trace","program not running"),void(t&&t(new Error("program not running"))));});},e.prototype._write=function(t,r){var o=require("fs"),n=this;o.access(e.NAMED_PIPE,o.F_OK,function(s){if(s)return n._logger.log("warn","led control program not running"),void(r&&r(s));var i=o.createWriteStream(e.NAMED_PIPE);i.on("open",function(){n._logger.log("trace","stream open and write bytes"),i.end(t);}),i.on("error",function(e){n._logger.log("trace","stream error:"+e.messae),i.__writeTO&&(clearTimeout(i.__writeTO),i.__writeTO=null),r&&(r(e),r=null),i.destroy();}),i.on("close",function(){n._logger.log("trace","stream close"),i.__writeTO&&(clearTimeout(i.__writeTO),i.__writeTO=null),r&&(r(),r=null);}),i.__writeTO=setTimeout(function(){n._logger.log("trace","stream write timeout"),r&&(r(new Error("write timeout")),r=null),i.destroy();},2e3);});},e.prototype._getPID=function(t){var r=(0,require("child_process").exec)("pidof "+e.PROCESS),o=null;r.stdout.on("data",function(e){o=String(e).trim();}),r.on("error",function(e){t&&(t(e),t=null);}),r.on("close",function(e){t&&(t(null,o),t=null);});},e;}(),x.hub.v6.ResetPin=function(){var e=function e(t,r){this._logger=require("x.logger.js").getLogger("x.hub.v6.ResetPin"),this._handler=t,this._pinID=r,this._pinID||(this._pinID=e.PIN),this._pin=null,this._resetMode=null,this._pressedTS=null,this._checkInterval=null;};return e.PIN=24,e.prototype.init=function(){if(this._logger.log("trace","init reset pin:"+this._pinID),"PI-CM3+"==global.PLATFORM){var e=require("onoff").Gpio;new e(this._pinID,"in","both").unexport(),this._pin=new e(this._pinID,"in","both");var t=this;this._pin.watch(function(e,r){t._logger.log("trace","reset pin value:"+r),1==r?t._onPress():0==r&&t._onRelease();});}},e.prototype._checkResetPin=function(){var e=this._pin.readSync();if(this._logger.log("trace","check reset pin value:"+e),0==e)this._onRelease();else{var t=Date.now()-this._pressedTS;t>8e3?"reboot"!=this._resetMode&&(this._pressedTS=Date.now(),this._resetMode="reboot",this._onModeChange()):t>6e3?"factory"!=this._resetMode&&(this._resetMode="factory",this._onModeChange()):t>4e3?"passwords"!=this._resetMode&&(this._resetMode="passwords",this._onModeChange()):t>2e3&&"network"!=this._resetMode&&(this._resetMode="network",this._onModeChange());}},e.prototype._onPress=function(){this._logger.log("trace","reset pin pressed"),this._resetMode="reboot",this._pressedTS=Date.now(),this._checkInterval&&(clearInterval(this._checkInterval),this._checkInterval=null);var e=this;this._checkInterval=setInterval(function(){e._checkResetPin();},200),this._onModeChange();},e.prototype._onRelease=function(){this._logger.log("trace","reset pin released, reset mode:"+this._resetMode),this._checkInterval&&(clearInterval(this._checkInterval),this._checkInterval=null);var e=this._resetMode;this._resetMode=null,this._pressedTS=null;var t=this,r=this._handler._hub,o=require("x.hub.v6.js")._led;if(r)switch(e){case"reboot":r.restart();break;case"factory":case"passwords":case"network":r.reset(e,function(n,s){t._logger.log("trace",e+" reset finish, reboot:"+s),o.stopResetSystem(),!n&&s&&r.restart(1e3);});}},e.prototype._onModeChange=function(){this._logger.log("trace","reset mode change to:"+this._resetMode);var e=require("x.hub.v6.js")._led;switch(this._resetMode){case"reboot":e.startResetSystem(0,0,0);break;case"network":e.startResetSystem(0,255,0);break;case"passwords":e.startResetSystem(255,255,0);break;case"factory":e.startResetSystem(255,0,0);}},e;}(),x.hub.v6.Recovery=function(){var e=function e(){};return e.FILE="/config/.recoveryMode",e.prototype.init=function(t){global.SYSTEM_ROOT&&(e.FILE=SYSTEM_ROOT+e.FILE),t&&t();},e.prototype.createEmptyFile=function(e){this._writeProperties({},function(t){e&&e(t);});},e.prototype.setFirmwareUpdateUrl=function(e,t){var r=this;this._readProperties(function(o,n){o?t&&t(o):(n||(n={}),n.URL=e,r._writeProperties(n,function(e){t&&t(e);}));});},e.prototype._readProperties=function(t){var r=require("fs");r.existsSync(e.FILE)?r.readFile(e.FILE,{encoding:"utf8"},function(e,r){if(e)t&&t(e);else{var o={};if(r)for(var n=r.split("\n"),s=0;s<n.length;s++){var i=n[s].trim().split("="),a=i[0],l=i[1];o[a]=l;}t(null,o);}}):t(null,{});},e.prototype._writeProperties=function(t,r){var o=require("fs"),n=[];for(var s in t){var i=t[s];null!=i&&null!=i||(i=""),n.push(s+"="+i);}var a=n.length?n.join("\n"):"";o.writeFile(e.FILE,a,function(e){r(e);});},e;}(),x.hub.v6.ExtraInfo=function(){var e=function e(){this._logger=require("x.logger.js").getLogger("x.hub.v6.ExtraInfo");};return e.prototype.getInfo=function(e){var t=this,r={};this._logger.log("trace","get cpu temperature"),this._getCPUTemperature(function(o,n){t._logger.log("trace","get cpu temperature "+(o?"failed:"+o.message:"success:"+n)),o||(r.cpuTemp=n),t._logger.log("trace","get gpu temperature"),t._getGPUTemperature(function(o,s){t._logger.log("trace","get gpu temperature "+(o?"failed:"+o.message:"success:"+n)),o||(r.gpuTemp=s),e&&e(null,r);});});},e.prototype._getCPUTemperature=function(e){require("fs").readFile("/sys/class/thermal/thermal_zone0/temp",{encoding:"utf8"},function(t,r){if(t)e(t);else{var o=parseInt(r);isNaN(o)?e(new Error("invalid temperature")):e(null,o/1e3);}});},e.prototype._getGPUTemperature=function(e){var t=(0,require("child_process").exec)("vcgencmd measure_temp"),r=null,o=this;t.stdout.on("data",function(e){o._logger.log("trace","get gpu temperature:"+String(e));var t=String(e).trim();if("temp="==t.substr(0,5)){var n=t.substring(5,t.length-2);n=parseFloat(n),isNaN(n)||(r=n);}}),t.on("error",function(t){e&&(e(t),e=null);}),t.on("close",function(t){0==t?null!=r?e&&(e(null,r),e=null):e&&(e(new Error("invalid temperature")),e=null):e&&(e(new Error("read gpu temperature failed")),e=null);});},e;}(),x.hub.v6.ZwayServer=function(){var e=function e(){this._logger=require("x.logger.js").getLogger("x.hub.v6.ZwayServer"),this._state=0;};return e.SCRIPT="/srv/init.d/S01z-way-server",e.FOLDER="/srv/z-way-server",e.prototype.init=function(t){global.SYSTEM_ROOT&&(e.FOLDER=SYSTEM_ROOT+e.FOLDER,e.SCRIPT=SYSTEM_ROOT+e.SCRIPT),t&&t();},e.prototype._getConfigFolder=function(){return e.FOLDER+"/config";},e.prototype._getAutomationFolder=function(){return e.FOLDER+"/automation";},e.prototype._getAutomationStorageFolder=function(){return this._getAutomationFolder()+"/storage";},e.prototype.start=function(e){if(this._state)e&&e(new Error("current state is:"+this._state));else{var t=this;this._state=1,this._startAndCheck(3,1e3,function(r){t._state=0,e&&e(r);});}},e.prototype.stop=function(e){if(this._state)e&&e(new Error("current state is:"+this._state));else{var t=this;this._state=2,this._stopAndCheck(3,1e3,function(r){t._state=0,e&&e(r);});}},e.prototype.reset=function(e){if(this._state)e&&e(new Error("current state is:"+this._state));else{var t=this;this._state=3,this._logger.log("trace","reset z-way-server");var r=require("async"),o=!1;r.series([function(e){t._logger.log("trace","check z-way-server state"),t._isRunning(function(r,n){t._logger.log("trace","check z-way-server state "+(r?" failed:"+r.message:" running:"+n)),r||(o=n),e();});},function(e){o?(t._logger.log("trace","stop z-way-server"),t._stopAndCheck(3,1e3,function(t){e(t);})):e();},function(e){t._logger.log("trace","clear z-way-server folder"),t._reset(!1,e);},function(e){o?(t._logger.log("trace","start z-way-server"),t._startAndCheck(3,1e3,e)):e();}],function(r){t._state=0,e&&e(r);});}},e.prototype.restore=function(t,r,o){if(this._state)o&&o(new Error("current state is:"+this._state));else{var n=r?r.restoreUZB:null,s=this;this._state=5,this._logger.log("trace","retore zway data (restoreUZB="+n+") from:"+t+" to:"+e.FOLDER);var i=!1;require("async").series([function(e){if(r&&"v5+"==r.backupType){var o=require("fs");o.existsSync(t+"/zway/automation/storage")&&o.readdir(t+"/zway/automation/storage",function(r,n){if(r)e();else{if(n)for(var i=0;i<n.length;i++){var a=n[i];if(a&&"configjson-"==a.substr(0,11))try{s._logger.log("trace","v5+ backup, remove file:"+a),o.unlinkSync(t+"/zway/automation/storage/"+a);}catch(e){}}e();}});}else e();},function(e){s._logger.log("trace","check z-way-server state"),s._isRunning(function(t,r){s._logger.log("trace","check z-way-server state "+(t?" failed:"+t.message:" running:"+r)),t||(i=r),e();});},function(e){if(n){var r;if(s._logger.log("trace","retore uzb"),!require("fs").existsSync(t+"/zway/z-way-backup.zbk"))return s._logger.log("trace","retore uzb failed: no uzb backup file"),(r=new Error("no uzb backup file")).code=-311,void e(r);var o=require("x.hub.m.zway.js").getZway();if(!o)return s._logger.log("trace","retore uzb failed: z-way-server not running"),(r=new Error("z-way-server not running")).code=-312,void e(r);o.restore(t+"/zway/z-way-backup.zbk",!0,function(t){s._logger.log("trace","retore uzb "+(t?" failed:"+t.message:" success")),t&&!t.code&&(t.code=-313),e(t);});}else e();},function(e){i?(s._logger.log("trace","stop z-way-server"),s._stopAndCheck(3,1e3,function(t){s._logger.log("trace","stop z-way-server "+(t?" failed:"+t.message:" success")),t&&!t.code&&(t.code=-314),e(t);})):e();},function(e){s._logger.log("trace","clear z-way-server folder (restoreUZB="+n+")"),s._reset(n,function(t){s._logger.log("trace","clear z-way-server folder (restoreUZB="+n+")"+(t?" failed:"+t.message:" success")),t&&!t.code&&(t.code=-315),e(t);});},function(e){s._logger.log("trace","restore z-way-server folder (restoreUZB="+n+")"),s._restore(t,n,function(t){s._logger.log("trace","restore z-way-server folder (restoreUZB="+n+")"+(t?" failed:"+t.message:" success")),t&&!t.code&&(t.code=-316),e(t);});},function(e){i?(s._logger.log("trace","start z-way-server"),s._startAndCheck(3,1e3,function(t){s._logger.log("trace","start z-way-server "+(t?" failed:"+t.message:" success")),t&&!t.code&&(t.code=-317),e(t);})):e();}],function(e){s._state=0,o&&o(e);});}},e.prototype.backup=function(e,t,r){if(this._state)r&&r(new Error("current state is:"+this._state));else{this._state=4,this._logger.log("trace","backup zway data (backupUZB="+t+") to:"+e);var o=require("fs-extra"),n=this._getConfigFolder(),s=this._getAutomationStorageFolder();if(o.existsSync(n))try{o.copySync(n,e+"/zway/config");}catch(e){}if(o.existsSync(s))try{o.copySync(s,e+"/zway/automation/storage");}catch(e){}if(0==t)return this._state=0,void(r&&r());var i=require("x.hub.m.zway.js").getZway();if(!i&&!t)return this._state=0,void(r&&r());if(!i&&t)return this._state=0,void(r&&r(new Error("z-way-server not running")));var a=this;this._logger.log("trace","backup zwave usb stick"),i.backup(e+"/zway",function(e){a._logger.log("trace","backup zwave usb stick "+(e?" failed:"+e.message:" success")),a._state=0,r&&r(e);});}},e.prototype._startAndCheck=function(e,t,r){var o=this;this._start(function(n){if(n)r&&r(n);else{var s=0,i=function i(n,a){n?r&&r(n):a?r&&r():++s<e?setTimeout(function(){o._isRunning(i);},t):r&&r(new Error("z-way-server do not run after execute start command"));};setTimeout(function(){o._isRunning(i);},t);}});},e.prototype._stopAndCheck=function(e,t,r){var o=this;this._stop(function(n){if(n)r&&r(n);else{var s=0,i=function i(n,a){n?r&&r(n):a?++s<e?setTimeout(function(){o._isRunning(i);},t):r&&r(new Error("z-way-server still run after execute stop command")):r&&r();};setTimeout(function(){o._isRunning(i);},t);}});},e.prototype._isRunning=function(e){this._logger.log("trace","check z-way-server pid");var t=(0,require("child_process").exec)("pidof z-way-server"),r=this,o=null;t.stdout.on("data",function(e){r._logger.log("trace","get z-way-server pid out:"+String(e)),o=String(e);}),t.on("error",function(t){r._logger.log("trace","get z-way-server pid error:"+t.message),e&&(e(t),e=null);}),t.on("close",function(t){r._logger.log("trace","get z-way-server pid finish: code="+t),0!=t?1!=t?e&&(e(new Error("get z-way-server pid failed, return code:"+t)),e=null):e&&(e(null,!1),e=null):e&&(e(null,!!o),e=null);});},e.prototype._start=function(t){var r=e.SCRIPT+" start";this._logger.log("trace","start z-way-server with command:"+r);var o=(0,require("child_process").exec)(r),n=this;o.stdout.on("data",function(e){n._logger.log("trace","start z-way-server out:"+String(e));}),o.on("error",function(e){n._logger.log("trace","start z-way-server error:"+e.message),t&&(t(e),t=null);}),o.on("close",function(e){n._logger.log("trace","start z-way-server "+(0==e?"success":"failed")),0==e?t&&(t(0==e?null:new Error("start z-way-server failed")),t=null):t&&(t(new Error("start z-way-server failed, return code:"+e)),t=null);});},e.prototype._stop=function(t){var r=e.SCRIPT+" stop";this._logger.log("trace","stop z-way-server with command:"+r);var o=(0,require("child_process").exec)(r),n=this;o.stdout.on("data",function(e){n._logger.log("trace","stop z-way-server out:"+String(e));}),o.on("error",function(e){n._logger.log("trace","stop z-way-server error:"+e.message),t&&(t(e),t=null);}),o.on("close",function(e){n._logger.log("trace","stop z-way-server "+(0==e?"success":"failed")),t&&(t(0==e?null:new Error("stop z-way-server failed")),t=null);});},e.prototype._reset=function(e,t){var r=this._getConfigFolder(),o=this._getAutomationStorageFolder();e||this._logger.log("trace","clear z-way-server config folder:"+r),this._logger.log("trace","clear z-way-server automation storage folder:"+o);var n="rm -f "+r+"/zddx/*.xml && rm -f "+o+"/*.json";e&&(n="rm -f "+o+"/*.json");var s=(0,require("child_process").exec)(n),i=this;s.stdout.on("data",function(e){i._logger.log("trace","reset z-way-server out:"+String(e));}),s.on("error",function(e){i._logger.log("trace","reset z-way-server error:"+e.message),t&&(t(e),t=null);}),s.on("close",function(e){i._logger.log("trace","clear z-way-server config "+(0==e?"success":"failed")),t&&(t(0==e?null:new Error("clear z-way-server config failed")),t=null);});},e.prototype._restore=function(t,r,o){this._logger.log("trace","retore zway data (restoreUZB="+r+") from:"+t+" to:"+e.FOLDER);var n=require("fs"),s=require("fs-extra");if(!r&&n.existsSync(t+"/zway/config")&&n.existsSync(e.FOLDER)){this._logger.log("trace","copy zway data from:"+t+"/zway/config to:"+this._getConfigFolder());try{s.copySync(t+"/zway/config",this._getConfigFolder());}catch(t){}}if(n.existsSync(t+"/zway/automation/storage")&&n.existsSync(this._getAutomationFolder())){this._logger.log("trace","copy zway data from:"+t+"/zway/automation/storag to:"+this._getAutomationStorageFolder());try{s.copySync(t+"/zway/automation/storage",this._getAutomationStorageFolder());}catch(t){}}o&&o();},e;}(),x.hub.v6.Handler=function(){var e=function e(){this._logger=require("x.logger.js").getLogger("x.hub.v6.Handler"),this._centralUnit=null,this._recovery=new x.hub.v6.Recovery(),this._sysConf=new x.hub.v6.SystemConf(),this._stm=new x.hub.v6.STM(this,global.STM?global.STM:null),this._led=new x.hub.v6.LED(),this._resetPin=new x.hub.v6.ResetPin(this),this._network=new x.hub.v6.Network(this),this._time=new x.hub.v6.Time(this),this._location=new x.hub.v6.Location(this),this._zwayServer=new x.hub.v6.ZwayServer(this),this._extraInfo=new x.hub.v6.ExtraInfo(this),this._hub=null;};return e.prototype.CentralUnit=x.hub.v6.CentralUnit,e.prototype.LED=x.hub.v6.LED,e.prototype.ResetPin=x.hub.v6.ResetPin,e.prototype.init=function(e,t){var r=this;this._hub=e,this._led.init(),this._resetPin.init(),this._recovery.init(),this._sysConf.init(function(){r._network.init(),r._time.init(),t&&t();}),this._stm.init(),this._zwayServer.init();},e.prototype.setIPData=function(e,t){var r=this,o=!1;this._logger.log("trace","set ip data:"+JSON.stringify(e)),function(e,t){if(e.NTP){r._logger.log("trace","set ntp:"+e.NTP);var o=e.NTP.split(",");r._time.setNTPServers(o,function(e){t(e,!1);});}else t(null,!1);}(e,function(n,s){if(n)return r._logger.log("trace","set ntp failed:"+n.stack),void(t&&t(n));o=o||s,function(e,t){if(e.MAC){if(12==e.MAC.length&&e.MAC.match(/^([a-fA-F0-9]{2}){6}/g)){r._logger.log("trace","set mac:"+e.MAC);var o=e.MAC.substr(0,2)+":"+e.MAC.substr(2,2)+":"+e.MAC.substr(4,2)+":"+e.MAC.substr(6,2)+":"+e.MAC.substr(8,2)+":"+e.MAC.substr(10,2),n=new Buffer(e.MAC,"hex");r._logger.log("trace","set mac "+e.MAC+" on stm"),r._stm.sendCommand(57,n,function(n){if(n&&n.error)return r._logger.log("trace","set mac "+e.MAC+" on stm failed: "+n.error),void t(err,!1);r._logger.log("trace","set mac "+e.MAC+" on file"),r._network.setMAC(o,function(e){t(e,!e);});});}else t(new Error("invalid mac address"));}else t(null,!1);}(e,function(n,s){if(n)return r._logger.log("trace","set mac failed:"+n.stack),void(t&&t(n));o=o||s,function(e,t){if(1==e.DHCP||0==e.DHCP){var o={dhcp:!0};if(0==e.DHCP){if(!(e.IP&&e.SN&&e.GW&&e.DNS))return void t(new Error("invalid static ip settings"));o.dhcp=!1,o.ip=e.IP,o.subnet=e.SN,o.router=e.GW,o.dns=e.DNS.split(",");}r._logger.log("trace","set network eth0:"+JSON.stringify(o)),r._network.setNetwork("eth0",o,function(e){t(e,!e);});}else t(null,!1);}(e,function(e,n){if(e)return r._logger.log("trace","set network failed:"+e.stack),void(t&&t(e));o=o||n,r._logger.log("trace","set ip data finish (reboot="+o+")"),t&&t(null,o);});});});},e.prototype.setTZData=function(e,t){e?this._time.setTimezoneEncoded(e,function(e){t&&t(e);}):t&&t(new Error("invalid timezone"));},e.prototype.getTZData=function(e){this._time.getTimezoneEncoded(e);},e.prototype.setLocation=function(e,t,r){this._location.setLocation(e,t,r);},e.prototype.getLocation=function(e){this._location.getLocation(e);},e.prototype.getTimezoneSync=function(){return this._time.getTimezoneSync();},e.prototype.setTime=function(e,t){this._time.setTime(e,t);},e.prototype.reboot=function(e,t,r){if(this._logger.log("trace","reboot"),"PI-CM3+"==global.PLATFORM){var o=this;require("async").series([function(t){"recovery"==e?o._recovery.createEmptyFile(function(e){t(e);}):t();},function(e){t?setTimeout(function(){e();},t):e();},function(e){o._reboot(e);}],function(e){r&&r(e);});}else r&&r();},e.prototype._reboot=function(e){var t=(0,require("child_process").exec)("reboot");t.on("error",function(t){e&&(e(t),e=null);}),t.on("close",function(t){e&&(e(0==t?null:new Error("system reboot failed")),e=null);});},e.prototype.poweroff=function(e,t){if(this._logger.log("trace","power off"),"PI-CM3+"==global.PLATFORM){var r=this;require("async").series([function(t){e?setTimeout(function(){t();},e):t();},function(e){r._led.setColor(0,0,0,function(){e();});},function(e){r._poweroff(e);}],function(e){t&&t(e);});}else t&&t();},e.prototype._poweroff=function(e){var t=(0,require("child_process").exec)("poweroff");t.on("error",function(t){e&&(e(t),e=null);}),t.on("close",function(t){e&&(e(0==t?null:new Error("system poweroff failed")),e=null);});},e.prototype.reset=function(e,t){this._logger.log("trace","reset "+e);var r=this;switch(e){case"network":this._network.resetNetwork(function(e){t&&t(e,!e);});break;case"factory":this._logger.log("trace","reset stm"),this._stm.reset(function(e){r._logger.log("trace","reset stm "+(e?"failed:"+e.message:"success")),e?t&&t(e,!e):(r._logger.log("trace","reset z-way-server"),r._zwayServer.reset(function(e){r._logger.log("trace","reset z-way-server "+(e?"failed:"+e.message:"success")),e?t&&t(e,!e):(r._logger.log("trace","reset network"),r._network.resetNetwork(function(e){r._logger.log("trace","reset network "+(e?"failed:"+e.message:"success")),r._logger.log("trace","reset system.conf"),r._sysConf.reset(function(e){r._logger.log("trace","reset system.conf "+(e?"failed:"+e.message:"success")),t&&t(e,!e);});}));}));});break;default:t&&t(new Error("unknonw reset type: "+e));}},e.prototype.getSTM=function(){return this._stm;},e.prototype.updateSTM=function(e,t,r){var o=this,n=function n(e,t,r){var n=function n(e){e&&e.progress&&t.write(e.progress+".");};o._led.startFlashSTM(function(){o._stm.on("flash",n),o._stm.flashFirmware(e,function(e){o._stm.removeListener("flash",n),e?(t.write(JSON.stringify({XC_ERR:{code:"000000",msg:e.message}})),t.end()):(t.write(JSON.stringify({XC_SUC:{}})),t.end()),o._led.stopFlashSTM(function(){r&&r(e);});});});};e?this._saveTempFile("stm.bin",e,function(e,o){e?r&&r(e):n(o,t,r);}):n(null,t,r);},e.prototype._saveTempFile=function(e,t,r){var o=require("fs"),n=require("os"),s=require("path"),i=n.tmpdir(),a=s.join(i,e);o.existsSync(s)&&o.unlinkSync(s);var l=o.createWriteStream(a);t.pipe(l),l.on("finish",function(){l.close(function(){r&&r(null,a);});}),l.on("error",function(e){o.unlink(a),r&&r(e);});},e.prototype.backup=function(e,t,r){var o=this,n=null,s=require("x.crypt.js");e.query.enc&&"0"!=e.query.enc&&"false"!=e.query.enc&&(e.query.at?n=e.query.at:e.query.auth&&(n=s.MD5(unescape(encodeURI(e.query.auth+"_SALT!"))))),this._logger.log("trace","generate backup"+(n?" (encrypted)":""));var i=require("fs"),a=require("os").tmpdir(),l=require("path").join(a,"backup");if(i.existsSync(l))try{i.rmdirRecursiveSync(l);}catch(e){}try{this._logger.log("trace","create backup folder: "+l),i.mkdirSync(l);}catch(e){return t.status(500).json({code:-1,message:'create backup folder "'+l+'" failed:'+e.message}),this._logger.log("trace",'create backup folder "'+l+'" failed:'+e.message),void(r&&r(new Error('create backup folder "'+l+'" failed:'+e.message)));}this._logger.log("trace","assemble backup files"),this._backup(l,e.query,function(e){if(e)return t.status(500).json({code:e.code?e.code:-2,message:"assemble backup files failed:"+e.message}),o._logger.log("warn","assemble backup files failed:"+e.message),void(r&&r(e));o._logger.log("trace","compress backup files"),function(e,t,r){var n=require("fs-extra"),s=require("path"),i=require("os").tmpdir(),a=require("archiver"),l=new Date(),c=l.getFullYear()+"",u=l.getMonth()+1+"";1==u.length&&(u="0"+u);var f=l.getDate()+"";1==f.length&&(f="0"+f);var g=l.getHours()+"";1==g.length&&(g="0"+g);var _=l.getMinutes()+"";1==_.length&&(_="0"+_);var h=l.getSeconds()+"";1==h.length&&(h="0"+h);var d="backup_"+(c+u+f+g+_+h)+".xbp",p=s.join(i,d),m=n.createWriteStream(p),v=a("zip");m.on("close",function(){if(t){var e=require("crypto").createCipher("aes-256-cbc",t),o=n.createReadStream(p),s=n.createWriteStream(p+".enc");s.on("finish",function(){n.removeSync(p),r(null,p+".enc",d);}),o.pipe(e).pipe(s);}else r(null,p,d);}),m.on("error",function(e){o._logger.log("warn","write backup zip file failed:"+e.message),r(e);}),v.on("error",function(e){o._logger.log("warn","zip backup data failed:"+e.message),r(e);}),v.pipe(m),v.directory(e+"/","backup"),v.finalize();}(l,n,function(e,n,s){if(e)return t.status(500).json({code:-3,message:"compress backup files failed:"+e.message}),o._logger.log("warn","compress backup files failed:"+e.message),void(r&&r(e));o._logger.log("trace","return backup file:"+n),t.setHeader("Content-disposition","attachment; filename="+s),t.sendFile(n,null,function(e){require("fs-extra").removeSync(n),e?(o._logger.log("warn","return backup file failed:"+e.message),t.status(500).json({code:-4,message:"return backup file failed:"+e.message})):o._logger.log("trace","backup data finish"),r&&r(e);});});});},e.prototype._backup=function(e,t,r){var o=null;t&&("true"==t.backup_uzb||1==t.backup_uzb||"1"==t.backup_uzb?o=!0:"false"!=t.backup_uzb&&0!=t.backup_uzb&&"0"!=t.backup_uzb||(o=!1));var n=this;require("async").series([function(t){n._zwayServer?(n._logger.log("trace","backup zwave data"),n._zwayServer.backup(e,o,function(e){var r;n._logger.log("trace","backup zwave data "+(e?" failed:"+e.message:" success")),e&&((r=new Error("backup zwave data failed: "+e.message)).code=e.code?e.code:-210),t(r);})):t();},function(t){n._stm?(n._logger.log("trace","backup stm data"),n._stm.backup(e,function(e){var r;n._logger.log("trace","backup stm data "+(e?" failed:"+e.message:" success")),e&&((r=new Error("backup stm data failed: "+e.message)).code=e.code?e.code:-220),t(r);})):t();},function(t){n._network?(n._logger.log("trace","backup network config"),n._network.backup(e,function(e){var r;n._logger.log("trace","backup network config "+(e?" failed:"+e.message:" success")),e&&((r=new Error("backup network config failed: "+e.message)).code=e.code?e.code:-230),t(r);})):t();},function(t){n._sysConf?(n._logger.log("trace","backup system config"),n._sysConf.backup(e,function(e){var r;n._logger.log("trace","backup system config "+(e?" failed:"+e.message:" success")),e&&((r=new Error("backup system config failed: "+e.message)).code=e.code?e.code:-240),t(r);})):t();},function(t){var r=require("fs-extra"),o=require("path"),s=require("x.hub.fileman.js").fileManager.getUserRootDataPath();n._logger.log("trace","backup general data"),r.copy(s,o.join(e,"data"),{dereference:!0},function(s){if(s){n._logger.log("trace","backup general data failed:"+s.message);var i=new Error("backup system config failed: "+s.message);return i.code=s.code?s.code:-250,void t(i);}var a=o.join(e,"data","localstorage","x.hub.Server.lock");r.existsSync(a)&&r.removeSync(a),r.exists(o.join(e,"data","localstorage","x.hub.Server.pin"),function(s){s&&r.removeSync(o.join(e,"data","localstorage","x.hub.Server.pin")),r.exists(o.join(e,"data","localstorage","x.hub.Server.pwd"),function(s){if(!s)return n._logger.log("trace","backup general data success"),void t();r.remove(o.join(e,"data","localstorage","x.hub.Server.pwd"),function(e){var r;n._logger.log("trace","backup general data "+(e?" failed:"+e.message:" success")),e&&((r=new Error("backup general data failed: "+e.message)).code=e.code?e.code:-250),t(r);});});});});},function(t){n._logger.log("trace","backup plugins started ..."),require("./pluginmanager").backup(e,function(e,r){if(n._logger.log("trace","backup plugins finished!"),e){try{var o=JSON.stringify(e);}catch(t){e.messae&&(o=e.message),o="can not stringify error";}return n._logger.log("error",o),void t(e);}t(null,r);});}],function(e){r&&r(e);});},e.prototype.restore=function(e,t,r){var o=require("x.crypt.js"),n=null;e.query.key?n=e.query.key:e.query.at?n=e.query.at:e.query.auth&&(n=o.MD5(unescape(encodeURI(e.query.auth+"_SALT!"))));var s=this;this._logger.log("trace","restore backup"),function(e,t){var r=require("fs"),o=require("os").tmpdir(),n=require("path").join(o,"restore.zip");if(r.existsSync(n))try{r.unlinkSync(n);}catch(e){return void t(e);}var s=r.createWriteStream(n);e.pipe(s),s.on("finish",function(){s.close(function(){t(null,n);});}),s.on("error",function(e){r.unlink(n),t(e);});}(e,function(o,i){if(o)return s._logger.log("warn","download backup file failed: "+o.message),t.json({XC_ERR:{code:-1,msg:"donwload backup file failed:"+o.message}}),void(r&&r(o));s._logger.log("trace","extract backup data from: "+i),function(e,t,r){var o=require("fs"),n=require("fs-extra"),i=require("os").tmpdir(),a=require("path"),l=a.join(i,"restore"),c=a.join(l,"backup");if(n.existsSync(l))try{n.removeSync(l);}catch(e){return void r(e);}var u=require("adm-zip"),f=null;try{new u(e).extractAllTo(l,!0);}catch(e){s._logger.log("warn","backup file may be encrypted"),f="invalid backup file/password";}if(f){if(t){s._logger.log("trace","decrpyt backup file");var g=require("crypto").createDecipher("aes-256-cbc",t),_=o.createReadStream(e),h=o.createWriteStream(e+".dec.zip");g.on("error",function(){n.removeSync(e),n.removeSync(e+".dec.zip"),r(new Error(f));}),h.on("finish",function(){f=null;try{new u(e+".dec.zip").extractAllTo(l,!0);}catch(e){f="invalid backup file/password";}n.removeSync(e),n.removeSync(e+".dec.zip"),r(f?new Error(f):null,c);}),_.pipe(g).pipe(h);}else n.removeSync(e),r(new Error(f)),r=null;}else n.removeSync(e),r(null,c),r=null;}(i,n,function(o,n){if(o)return s._logger.log("warn","extract backup data failed: "+o.message),t.json({XC_ERR:{code:-2,msg:"extract backup data failed:"+o.message}}),void(r&&r(o));s._logger.log("trace","restore data from: "+n),s._restore(n,e.query,function(e){try{var o=require("fs-extra");o.removeSync(i),o.removeSync(n);}catch(e){}e?(s._logger.log("warn","restore data failed: "+e.message),t.json({XC_ERR:{code:e.code?e.code:-3,msg:"restore backup data failed:"+e.message}})):(s._logger.log("trace","restore data finish"),t.json({XC_SUC:{}}),s.reboot(null,1e3)),r&&r(e);});});});},e.prototype._restore=function(e,t,r){var o=null;t&&("true"==t.restore_uzb||1==t.restore_uzb||"1"==t.restore_uzb?o=!0:"false"!=t.restore_uzb&&0!=t.restore_uzb&&"0"!=t.restore_uzb||(o=!1));var n=!1,s=require("fs"),i=require("fs-extra"),a=require("path");s.existsSync(e+"/config/system.conf")||(n=!0);var l=this;require("async").series([function(t){l._zwayServer?(l._logger.log("trace","restore zwave data"),l._zwayServer.restore(e,{restoreUZB:o,backupType:n?"v5+":"v6+"},function(e){var r;l._logger.log("trace","restore zwave data"+(e?" failed:"+e.message:" success")),e&&((r=new Error("restore zwave data failed: "+e.message)).code=e.code?e.code:-310),t(r);})):t();},function(t){l._stm?(l._logger.log("trace","restore stm data"),l._stm.restore(e,function(e){var r;l._logger.log("trace","restore stm data"+(e?" failed:"+e.message:" success")),e&&((r=new Error("restore stm data failed: "+e.message)).code=e.code?e.code:-320),t(r);})):t();},function(t){l._logger.log("trace","restore location"),l._location.restore(e,{backupType:n?"v5+":"v6+"},function(e){var r;l._logger.log("trace","restore location "+(e?" failed:"+e.message:" success")),e&&((r=new Error("restore location failed: "+e.message)).code=e.code?e.code:-360),t(r);});},function(t){l._logger.log("trace","restore timezone"),l._time.restore(e,{backupType:n?"v5+":"v6+"},function(e){var r;l._logger.log("trace","restore timezone"+(e?" failed:"+e.message:" success")),e&&((r=new Error("restore timezone failed: "+e.message)).code=e.code?e.code:-370),t(r);});},function(t){if(n){l._logger.log("trace","remove v5+ cloud connection settings");var r=a.join(e,"data","localstorage","x.hub.v5.cloudKey"),o=a.join(e,"data","localstorage","x.hub.v5.cloudServer"),i=a.join(e,"data","localstorage","x.hub.v5.cloudPort");try{s.existsSync(r)&&(l._logger.log("trace","remove v5+ cloud key file: "+r),s.unlinkSync(r)),s.existsSync(o)&&(l._logger.log("trace","remove v5+ cloud server file: "+o),s.unlinkSync(o)),s.existsSync(i)&&(l._logger.log("trace","remove v5+ cloud port file: "+i),s.unlinkSync(i));}catch(e){}t();}else t();},function(t){if(l._network){if(n){var r=a.join(e,"data","localstorage","x.hub.v5.config");try{s.existsSync(r)&&(l._logger.log("trace","remove v5+ config file: "+r),s.unlinkSync(r));}catch(e){}t();}else l._logger.log("trace","restore network config"),l._network.restore(e,function(e){var r;l._logger.log("trace","restore network config"+(e?" failed:"+e.message:" success")),e&&((r=new Error("restore network config failed: "+e.message)).code=e.code?e.code:-340),t(r);});}else t();},function(t){var r=function r(e,t,_r2){l._logger.log("trace","move "+e+" to "+t),i.exists(e,function(o){if(!o)return l._logger.log("trace",e+" not exist"),void _r2();i.rename(e,t,function(o){o&&l._logger.log("trace","move "+e+" to "+t+" failed:"+o.message),_r2(o);});});};l._logger.log("trace","restore standard data");var o=require("x.hub.fileman.js").fileManager,n=o.getUserRootDataPath(),s=o.getTmpDir();!function(e,t,o){l._logger.log("trace","backup current lock,pin,pwd");var n=a.join(e,"localstorage","x.hub.Server.lock"),s=a.join(t,"x.hub.Server.lock"),i=a.join(e,"localstorage","x.hub.Server.pin"),c=a.join(t,"x.hub.Server.pin"),u=a.join(e,"localstorage","x.hub.Server.pwd"),f=a.join(t,"x.hub.Server.pwd");r(n,s,function(){r(i,c,function(){r(u,f,function(){o();});});});}(n,s,function(){!function(e,t){l._logger.log("trace","clear "+e),i.emptyDir(e,function(r){r&&l._logger.log("trace","clear "+e+" failed:"+r.message),t();});}(n,function(){i.copy(a.join(e,"data"),n,function(e){var o;l._logger.log("trace","restore standard data"+(e?" failed:"+e.message:" success")),e&&((o=new Error("restore standard data failed: "+e.message)).code=e.code?e.code:-330),function(e,t,o){l._logger.log("trace","restore current lock,pin,pwd");var n=a.join(e,"localstorage","x.hub.Server.lock"),s=a.join(t,"x.hub.Server.lock"),i=a.join(e,"localstorage","x.hub.Server.pin"),c=a.join(t,"x.hub.Server.pin"),u=a.join(e,"localstorage","x.hub.Server.pwd"),f=a.join(t,"x.hub.Server.pwd");r(s,n,function(){r(c,i,function(){r(f,u,function(){o();});});});}(n,s,function(){t(o);});});});});},function(t){l._sysConf?(l._logger.log("trace","restore system config"),l._sysConf.restore(e,function(e){var r;l._logger.log("trace","restore system config"+(e?" failed:"+e.message:" success")),e&&((r=new Error("restore system config failed: "+e.message)).code=e.code?e.code:-350),t(r);})):t();},function(t){l._logger.log("trace","restore plugins started ..."),require("./pluginmanager").restore(e,function(e,r){l._logger.log("trace","restore plugins finished!"),e?t(e):t(null,r);});}],function(e){r&&r(e);});},e.prototype.updateFirmware=function(e,t){var r=this;this._logger.log("trace","update firmware with url:"+e),function(e,t){if(e){var r=require("url").parse(e),o=80;if(!r.port||((0===(o=parseInt(r.port))||isNaN(o))&&(o=80),o>0&&o<65536)){"https:"==r.protocol&&80==o&&(o=443);var n={host:r.hostname,port:o,path:r.path,method:"HEAD"},s=require("https:"==r.protocol?"https":"http").request(n,function(e){t&&(200==e.statusCode?t():t(new Error("http response code:"+e.statusCode)),t=null);});s.setTimeout(5e3,function(){t&&(t(new Error("http timeout")),t=null);}),s.on("error",function(e){t&&(t(e),t=null);}),s.end();}else t(new Error("invalid port"));}else t(new Error("invalid firmware url"));}(e,function(o){r._logger.log("trace","check online firmware"+(o?" failed:"+o.message:" success")),o?t&&t(new Error("check online firmware failed:"+o.message)):(r._logger.log("trace","set reboot to recovery mode"),function(e,t){r._recovery.setFirmwareUpdateUrl(e,function(e){t(e);});}(e,function(e){r._logger.log("trace","save firmware url"+(e?" failed:"+e.message:" success")),t&&t(e?new Error("save firmware url failed:"+e.message):null,!e);}));});},e.prototype.getExtraInfo=function(e){this._extraInfo.getInfo(e);},e.prototype.getSTMSettings=function(e){this._stm.getSettings(e);},e;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.v6.Handler());