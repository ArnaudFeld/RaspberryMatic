var x=x||{};x.hub=x.hub||{};x.hub.v6=x.hub.v6||{};
x.hub.v6.API=function(){var g=function(a){this._version="v1";this._handler=a};g.prototype.init=function(a,b){var d=this;a.addRoute("/api/"+this._version+"/command",function(a,c){d._handler.command(a.body,function(f,h){c.json(d._buildResponseJSON(f,h))})});a.addRoute("/api/"+this._version+"/state",function(a,c){d._handler.state(a.query,function(f,h){c.json(d._buildResponseJSON(f,h))})});b&&b()};g.prototype.handleTunnelReuqest=function(a,b){var d=a.pathname.split("/"),e=this;"state"==d[3]?this._handler.state(a.query,
function(c,f){b&&b(e._buildResponseJSON(c,f))}):"command"==d[3]?this._handler.command(a.body,function(c,f){b&&b(e._buildResponseJSON(c,f))}):b&&b(e._buildResponseJSON(Error("invalid request")))};g.prototype._buildResponseJSON=function(a,b){if(a){for((b=a.code+"")||(b="0");6>b.length;)b="0"+b;return{XC_ERR:{code:b,msg:a.message}}}return{XC_SUC:b?b:{}}};return{V1:g}}();
x.hub.v6.CentralUnit=function(){var g=function(a){this._api=new x.hub.v6.API.V1(this);this._server=a};g.prototype.init=function(a){this._api.init(this._server,a)};g.prototype.handleTunnelReuqest=function(a,b){this._api.handleTunnelReuqest(a,b)};g.prototype.command=function(a,b){};g.prototype.state=function(a,b){a&&"true"==a.force?this._updatesStates(a,b):b&&b(null,null)};g.prototype._updatesStates=function(a,b){a&&a.id?this._getStates(a.id,function(d,e){d?b&&b(d):e?(d={},d[a.id]={},a.key?d[a.id][a.key]=
e[a.key]:d[a.id]=e,b&&b(null,d)):b&&b(null,{})}):this._updateStatesAll(a.timeout,b)};g.prototype._updateStatesAll=function(a,b){a&&(a*=1E3);require("x.hub.commandman.js").commandHandler2.updateGeneralDeviceStates(a,b)};g.prototype._updateStates=function(a,b){require("x.hub.deviceman.js").deviceManager2.toGeneralDevice(a,function(d,e){if(d)b&&b(d);else if(e)if(e.states&&e.details&&e.details.states){d=[];for(var c in e.details.states){var f=e.details.states[c];f&&f.value&&d.push({id:c,value:f.value})}0==
d.length?b&&b(null,null):require("x.hub.commandman.js").commandHandler2.getStatesWithIdx(a,null,d,function(c){c&&c.data?b&&b(null,c.data):b&&b(Error("get device states error"))})}else b&&b(null,null);else b&&b(Error("can not find general device"))})};return g}();
x.hub.v6.Time=function(){var g=function(a){this._logger=require("x.logger.js").getLogger("x.hub.v6.Time");this._handler=a;this._writeRTCInterval=null;this._tz="21";this._timezone="Europe/Berlin";this._ntpServers=["0.de.pool.ntp.org","1.de.pool.ntp.org","2.de.pool.ntp.org","3.de.pool.ntp.org"]};g.TimeZone_MAP=[{utc:0,dst:!1,zone:"Etc/UTC"},{utc:0,dst:!0,zone:"Europe/Dublin"},{utc:1,dst:!1,zone:"Etc/GMT-1"},{utc:1,dst:!0,zone:"Europe/Berlin"},{utc:2,dst:!1,zone:"Etc/GMT-2"},{utc:2,dst:!0,zone:"EET"},
{utc:3,dst:!1,zone:"Etc/GMT-3"},{utc:3,dst:!0,zone:"Asia/Tehran"},{utc:4,dst:!1,zone:"Etc/GMT-4"},{utc:4,dst:!0,zone:"Asia/Kabul"},{utc:5,dst:!1,zone:"Etc/GMT-5"},{utc:5,dst:!0,zone:"Etc/GMT-5"},{utc:6,dst:!1,zone:"Etc/GMT-6"},{utc:6,dst:!0,zone:"Etc/GMT-6"},{utc:7,dst:!1,zone:"Etc/GMT-7"},{utc:7,dst:!0,zone:"Asia/Hovd"},{utc:8,dst:!1,zone:"Etc/GMT-8"},{utc:8,dst:!0,zone:"Asia/Ulaanbaatar"},{utc:9,dst:!1,zone:"Etc/GMT-9"},{utc:9,dst:!0,zone:"Australia/Adelaide"},{utc:10,dst:!1,zone:"Etc/GMT-10"},
{utc:10,dst:!0,zone:"Australia/Sydney"},{utc:11,dst:!1,zone:"Etc/GMT-11"},{utc:11,dst:!0,zone:"Etc/GMT-11"},{utc:12,dst:!1,zone:"Etc/GMT-12"},{utc:12,dst:!0,zone:"Pacific/Auckland"},{utc:13,dst:!1,zone:"Etc/GMT-13"},{utc:13,dst:!0,zone:"Pacific/Apia"},{utc:14,dst:!1,zone:"Etc/GMT-14"},{utc:14,dst:!0,zone:"Etc/GMT-14"},{utc:-1,dst:!1,zone:"Etc/GMT+1"},{utc:-1,dst:!0,zone:"Etc/GMT+1"},{utc:-2,dst:!1,zone:"Etc/GMT+2"},{utc:-2,dst:!0,zone:"Etc/GMT+2"},{utc:-3,dst:!1,zone:"Etc/GMT+3"},{utc:-3,dst:!0,zone:"America/Sao_Paulo"},
{utc:-4,dst:!1,zone:"Etc/GMT+4"},{utc:-4,dst:!0,zone:"America/Santiago"},{utc:-5,dst:!1,zone:"Etc/GMT+5"},{utc:-5,dst:!0,zone:"America/New_York"},{utc:-6,dst:!1,zone:"Etc/GMT+6"},{utc:-6,dst:!0,zone:"CST6CDT"},{utc:-7,dst:!1,zone:"Etc/GMT+7"},{utc:-7,dst:!0,zone:"MST7MDT"},{utc:-8,dst:!1,zone:"Etc/GMT+8"},{utc:-8,dst:!0,zone:"PST8PDT"},{utc:-9,dst:!1,zone:"Etc/GMT+9"},{utc:-9,dst:!0,zone:"America/Anchorage"},{utc:-10,dst:!1,zone:"Etc/GMT+10"},{utc:-10,dst:!0,zone:"America/Adak"},{utc:-11,dst:!1,zone:"Etc/GMT+11"},
{utc:-11,dst:!0,zone:"Etc/GMT+11"}];g.TIMEZONE_SCRIPT="/etc/init.d/S00settimezone";g.TIMEZONE_CONF="/etc/timezone";g.NTP_SCRIPT="/etc/init.d/S49ntp";g.NTP_CONF="/etc/ntp.conf";g.WRITE_RTC_PERIOD=6E5;g.prototype.init=function(a){global.SYSTEM_ROOT&&(g.TIMEZONE_SCRIPT=SYSTEM_ROOT+g.TIMEZONE_SCRIPT,g.TIMEZONE_CONF=SYSTEM_ROOT+g.TIMEZONE_CONF,g.NTP_CONF=SYSTEM_ROOT+g.NTP_CONF,g.NTP_SCRIPT=SYSTEM_ROOT+g.NTP_SCRIPT);var b=this;if(localStorage){var d=localStorage.getItem("x.hub.Server.timezone");d&&(b._tz=
d)}this._writeRTCInterval=setInterval(function(){b._writeTimeToRTC()},g.WRITE_RTC_PERIOD);this._readNTPConf(function(){b._readTimezoneConf(function(){a&&a()})})};g.prototype.getNTPServers=function(a){a&&a(null,this._ntpServers)};g.prototype.setNTPServers=function(a,b){if(a&&a.length){var d=a.filter(function(c){return!!c});if(d&&d.length){var e=this;this._handler._sysConf.setValue("NTP",d.join(","),function(c){c?b&&b(c):e._restartNTPD(function(c){c?b&&b(c):(e._ntpServers=d,b&&b())})})}else b&&b(Error("invalid ntp servers"))}else b&&
b(Error("invalid ntp servers"))};g.prototype.getTimezoneSync=function(){return this._decodeTimeZone(this._tz)};g.prototype.getTimezoneEncoded=function(a){a&&a(null,this._tz)};g.prototype.setTimezoneEncoded=function(a,b){if(a){var d=this._decodeTimeZone(a);if(d){var e=this;this._handler._sysConf.setValue("TZ",d,function(c){c?b&&b(c):e._reloadTimeZone(function(c){c?b&&b(c):(localStorage&&localStorage.setItem("x.hub.Server.timezone",a),e._tz=a,e._timezone=d,b&&b())})})}else b&&b(Error("invalid timezone"))}else b&&
b(Error("invalid timezone"))};g.prototype.setTime=function(a,b){if(a){var d=a.year,e=a.month+"";1==e.length&&(e="0"+e);var c=a.date+"";1==c.length&&(c="0"+c);var f=a.hour+"";1==f.length&&(f="0"+f);a=a.minute+"";1==a.length&&(a="0"+a);d="date +%Y%m%d%H%M -s "+(d+e+c+f+a);e=require("child_process").exec;d=e(d);d.on("error",function(c){b&&(b(c),b=null)});d.on("close",function(c){b&&(b(0==c?null:Error("set system time failed")),b=null)})}else b&&b(Error("invalid time"))};g.prototype._restartNTPD=function(a){var b=
require("child_process").exec;b=b(g.NTP_SCRIPT+" restart");b.stdout.on("data",function(a){console.log(String(a))});b.on("error",function(b){a&&(a(b),a=null)});b.on("close",function(b){a&&(a(0==b?null:Error("restart ntpd failed")),a=null)})};g.prototype._readNTPConf=function(a){var b=this;require("fs").readFile(g.NTP_CONF,{encoding:"utf8"},function(d,e){if(!d&&e){d=[];e=e.split("\n");for(var c=0;c<e.length;c++){var f=e[c].trim();f&&"server"==f.substr(0,6)&&(f=f.split(" "),2<=f.length&&f[1]&&-1==d.indexOf(f[1])&&
d.push(f[1]))}b._ntpServers=d}a()})};g.prototype._readTimezoneConf=function(a){var b=this;require("fs").readFile(g.TIMEZONE_CONF,{encoding:"utf8"},function(d,e){!d&&e&&(b._timezone=e.trim());a()})};g.prototype._decodeTimeZone=function(a){a=parseInt(a,16);var b=0!=(a&32),d=a&15;a&16&&(d=0-d);a&64&&(d-=.5);var e=null;g.TimeZone_MAP.forEach(function(c){c.utc==d&&c.dst==b&&(e=c.zone)});return e};g.prototype._reloadTimeZone=function(a){var b=require("child_process").exec;b=b(g.TIMEZONE_SCRIPT+" reload");
b.stdout.on("data",function(a){console.log(String(a))});b.on("error",function(b){a&&(a(b),a=null)});b.on("close",function(b){a&&(a(0==b?null:Error("reload timezone failed")),a=null)})};g.prototype._writeTimeToRTC=function(a){var b=Math.round((new Date).getTime()/1E3),d=new Buffer(4);d.writeInt32BE(b);var e=this;this._logger.log("trace","write time "+b+" to rtc "+d.toString("hex"));this._handler._stm.sendCommand(55,d,function(c){e._logger.log("trace","write time to rtc "+(c&&c.error?" failed:"+c.error:
" success"));a&&a(c?c.error:null,c?c.data:null)})};return g}();
x.hub.v6.Network=function(){var g={calculate:function(c,f){var h=[];try{var a=this.toDecimal(c);var b=this.toDecimal(f)}catch(l){return null}if(b<a)return null;for(c=a;c<=b;){c=this.getOptimalRange(c,b);if(null===c)return null;h.push(c);c=c.ipHigh+1}return h},calculateSubnetMask:function(c,f){try{var a=this.toDecimal(c)}catch(k){return null}return this.getMaskRange(a,f)},calculateCIDRPrefix:function(c,f){var a=0;try{var b=this.toDecimal(c);var d=this.toDecimal(f)}catch(l){return null}for(c=0;32>c&&
(a=a+(1<<32-(c+1))>>>0,(d&a)>>>0===a);c++);return this.getMaskRange(b,c)},getOptimalRange:function(c,f){var a,b=null;for(a=32;0<=a;a--){var d=this.getMaskRange(c,a);if(d.ipLow===c&&d.ipHigh<=f)b=d;else break}return b},getMaskRange:function(c,f){var a=this.getPrefixMask(f),b=this.getMask(32-f),d=(c&a)>>>0;c=((c&a)>>>0)+b>>>0;return{ipLow:d,ipLowStr:this.toString(d),ipHigh:c,ipHighStr:this.toString(c),prefixMask:a,prefixMaskStr:this.toString(a),prefixSize:f,invertedMask:b,invertedMaskStr:this.toString(b),
invertedSize:32-f}},getPrefixMask:function(c){var f=0,a;for(a=0;a<c;a++)f+=1<<32-(a+1)>>>0;return f},getMask:function(c){var f=0,a;for(a=0;a<c;a++)f+=1<<a>>>0;return f},isIp:function(c){if("string"!==typeof c)return!1;c=c.match(/^([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/);if(null===c)return!1;for(var f=1;4>=f;f++){var a=parseInt(c[f],10);if(255<a||0>a)return!1}return!0},isDecimalIp:function(c){return"number"===typeof c&&0===c%1&&0<=c&&4294967295>=c},toDecimal:function(c){if("number"===
typeof c&&!0===this.isDecimalIp(c))return c;if(!1===this.isIp(c))throw Error("Not an IP address: "+c);c=c.split(".");return 256*(256*(256*+c[0]+ +c[1])+ +c[2])+ +c[3]},toString:function(c){if("string"===typeof c&&!0===this.isIp(c))return c;if(!1===this.isDecimalIp(c))throw Error("Not a numeric IP address: "+c);for(var f=c%256,a=3;0<a;a--)c=Math.floor(c/256),f=c%256+"."+f;return f}},a=function(c){this._file=c;this._file||(this._file=a.FILE);this._globalOptions=[];this._interfaceOptions={}};a.FILE=
"/etc/dhcpcd.conf";a.prototype.init=function(c){this._read(function(f){c&&c(f)})};a.prototype.getConfig=function(c){var f={dhcp:!0};if(!this._interfaceOptions||!this._interfaceOptions[c])return f;c=this._interfaceOptions[c];for(var a=0;a<c.length;a++){var b=c[a];if(b&&"static"==b.substr(0,6)){f.dhcp=!1;b=b.substr(6).trim();var d=b.indexOf("=");if(-1!=d){var e=b.substr(0,d);b=b.substr(d+1);switch(e){case "ip_address":e=b.split("/");1==e.length?(f.ip=e[0],f.subnet="255.255.255.0"):(b=g.calculateSubnetMask(e[0],
parseInt(e[1])),f.ip=e[0],f.subnet=b.prefixMaskStr);break;case "routers":f.router=b.split(" ");break;case "domain_name_servers":f.dns=b.split(" ")}}}}return f};a.prototype.setConfig=function(c,f,a){if(c&&f)if(f.dhcp||f.ip&&f.subnet&&f.router&&f.dns){if(f.dhcp)delete this._interfaceOptions[c];else{var h=g.calculateSubnetMask(f.ip,f.subnet);if(!h){a&&a(Error("invalid argument"));return}this._interfaceOptions[c]=["static ip_address="+f.ip+"/"+h.prefixSize,"static routers="+(Array.isArray(f.router)?f.router.join(" "):
f.router),"static domain_name_servers="+(Array.isArray(f.dns)?f.dns.join(" "):f.dns)]}this._write(function(c){a&&a(c)})}else a&&a(Error("invalid argument"));else a&&a(Error("invalid argument"))};a.prototype._read=function(c){var f=this;require("fs").readFile(this._file,{encoding:"utf8"},function(a,b){if(a)c(a);else{if(b){a=b.split("\n");b=null;for(var h=0;h<a.length;h++){var d=a[h].trim();d&&"#"!=d.charAt(0)&&(d=d.trim(),"interface"==d.substr(0,9)?b=d.substr(9).trim():b?(f._interfaceOptions[b]||(f._interfaceOptions[b]=
[]),f._interfaceOptions[b].push(d)):f._globalOptions.push(d))}}c()}})};a.prototype._write=function(c){var f="";this._globalOptions.forEach(function(c){f+=c+"\n\n"});for(var a in this._interfaceOptions){f+="interface "+a+"\n";for(var b=this._interfaceOptions[b],d=0;d<b.length;d++)f+="  "+b[d]+"\n";f+="\n"}require("fs").writeFile(this._file,f,function(f){c(f)})};var b=function(c){this._file=c;c||(this._file=b.FILE)};b.FILE="/etc/resolv.conf";b.prototype.getDns=function(c){require("fs").readFile(this._file,
{encoding:"utf8"},function(f,a){if(f)c&&c(f);else{f=[];a=a.split("\n");for(var b=0;b<a.length;b++){var h=a[b].trim();"#"!=h.charAt(0)&&"nameserver"==h.substr(0,10)&&(h=h.substr(10).trim(),f.push(h))}c&&c(null,f)}})};var d=function(c){this._logger=require("x.logger.js").getLogger("x.hub.v6.Network.Wifi");this._file=c;c||(this._file=d.FILE);this._networks=[];this._wpaSocket=null;this._state=-2;this._initFinish=!1;this._scanCallback=null;this._scanTimeout=2E4;this._scanTo=null};d.FILE="/config/wpa_supplicant.conf";
d.SOCKET_PATH="/var/run/wpa_supplicant";d.prototype.init=function(c){var f=this;this._read(function(a,b){f._initFinish=!0;!a&&b&&(f._networks=b);c&&c(a);0==f._state&&f._checkInitWifiStatus()})};d.prototype.getFile=function(){return this._file};d.prototype.reset=function(c){this._logger.log("trace","reset");var f=this;this._networks=[];this._write(function(a){f._logger.log("trace","reset "+(a?" failed: "+a.message:"success"));c&&c(a)})};d.prototype.restore=function(c,a){this._logger.log("trace","restore from:"+
c);var f=require("fs"),b=require("fs-extra");try{f.existsSync(c+"/config/wpa_supplicant.conf")&&b.copySync(c+"/config/wpa_supplicant.conf",this._file),this._logger.log("trace","restore success"),a&&a()}catch(m){this._logger.log("trace","restore failed: "+m.message),a&&a(m)}};d.prototype.backup=function(c,a){this._logger.log("trace","backup to:"+c);var f=this;require("fs-extra").copy(this._file,c+"/config/wpa_supplicant.conf",function(c){f._logger.log("trace","backup "+(c?"failed: "+c.message:"success"));
a&&a(c)})};d.prototype.info=function(c,a){this._logger.log("trace","get wifi info");if(this._wpaSocket)if(0!=this._state)a&&a(Error("current state not idle:"+this._state));else{var f=this,b={};this._status(function(c,h){c?a&&a(c):(b.status={connected:!1},h&&("COMPLETED"==h.wpa_state&&(b.status.connected=!0),h.ssid&&(b.status.ssid=h.ssid)),b.networks=f._networks.map(function(c){var a=c.ssid;'"'==a.charAt(0)?(a=a.substr(1),'"'==a.charAt(a.length-1)&&(a=a.substr(0,a.length-1))):a=(new Buffer(c.ssid,
"hex")).toString("utf8");return{ssid:a}}),b.status.connected?f._signalPoll(function(c,f){!c&&f&&(b.status.rssi=parseInt(f.RSSI));a&&a(null,b)}):a&&a(null,b))})}else a&&a(Error("wlan not exist"))};d.prototype.scan=function(c,a){this._logger.log("trace","scan wifi on "+c);if(this._wpaSocket)if(0!=this._state)a&&a(Error("current state not idle:"+this._state));else{var f=this;this._state=1;this._scanCallback=a;this._scan(function(c){c?(f._state=0,f._scanCallback=null,a&&a(c)):f._scanTo=setTimeout(function(){f._logger.log("trace",
"scan wifi timeout");f._state=0;f._scanTo=null;f._scanCallback&&(f._scanCallback(Error("scan wifi timeout")),f._scanCallback=null)},f._scanTimeout)})}else a&&a(Error("wlan not exist"))};d.prototype.connect=function(c,a,b){if(c&&a&&a.ssid&&a.password)if(this._logger.log("trace","connect wifi on "+c+" to "+a.ssid),this._wpaSocket)if(0!=this._state)b&&b(Error("current state not idle:"+this._state));else{var f=this;this._state=2;this._logger.log("trace","calculate wpa passphrase");this._wpaPassphrase(a.ssid,
a.password,function(c,h){c?(f._logger.log("trace","calculate wpa passphrase failed:"+c.message),f._state=0,b&&b(c)):(c=(new Buffer(a.ssid)).toString("hex"),f._networks=[{ssid:c,psk:h,id_str:'"'+a.ssid+'"'}],f._write(function(c){b&&b(c)}))})}else b&&b(Error("wlan not exist"));else b&&b(Error("invalid arguments"))};d.prototype.disconnect=function(c,a,b){c?(this._logger.log("trace","disconnect wifi on "+c),this._wpaSocket?0!=this._state?b&&b(Error("current state not idle:"+this._state)):(this._networks=
[],this._write(function(c){b&&b(c)})):b&&b(Error("wlan not exist"))):b&&b(Error("invalid arguments"))};d.prototype.startWPAClient=function(c,a){this._logger.log("trace","start wpa client on "+c);if(this._wpaSocket)a&&a();else{var f=this;this._state=-1;this._checkWPADaemon(function(b){f._state=0;if(b)f._logger.log("trace","wpa_supplicant not running"),a&&a(b);else{b=new (require("wpa-client-socket"));var h=d.SOCKET_PATH+"/"+c;b.on("data",function(c){f._onWPAData(c.toString("utf8"))});b.bind(h);b.start();
f._wpaSocket=b;a&&a();f._initFinish&&f._checkInitWifiStatus()}})}};d.prototype._onWPAData=function(c){c=c.trim();this._logger.log("trace","wpa data:"+c);"<"==c.charAt(0)&&">"==c.charAt(2)&&(c=c.substr(3));var a=this;"CTRL-EVENT-SCAN-RESULTS"==c.substr(0,23)?1==this._state&&this._scanResults(function(c,f){a._state=0;a._scanTo&&(clearTimeout(a._scanTo),a._scanTo=0);a._scanCallback&&(a._scanCallback(c,f),a._scanCallback=null)}):"CTRL-EVENT-CONNECTED"==c.substr(0,20)?require("x.hub.v6.js")._led.stopWifiDisconnect():
"CTRL-EVENT-DISCONNECTED"==c.substr(0,23)&&require("x.hub.v6.js")._led.startWifiDisconnect()};d.prototype._status=function(a){this._logger.log("trace","do STATUS command");var c=this._wpaSocket.write("STATUS");this._logger.log("trace","STATUS command result:\n"+c.toString("utf8"));var b=c.toString("utf8");if(b){c={};b=b.trim().split("\n");for(var d=0;d<b.length;d++){var e=b[d].trim();if(e){var g=e.indexOf("=");if(-1!=g){var n=e.substr(0,g);e=e.substr(g+1);n&&(c[n]="ssid"==n?this._ssid2utf8(e):e)}}}a(null,
c)}else a(Error("do STATUS command failed"))};d.prototype._scan=function(a){this._logger.log("trace","do SCAN command");var c=this._wpaSocket.write("SCAN");this._logger.log("trace","SCAN command result:\n"+c.toString());"OK\n"!=c.toString()?a(Error("do scan command failed")):a()};d.prototype._scanResults=function(a){this._logger.log("trace","do SCAN_RESULTS command");var c=this._wpaSocket.write("SCAN_RESULTS");this._logger.log("trace","SCAN_RESULTS command result:\n"+c.toString("utf8"));var b=c.toString("utf8");
if(b){c=[];b=b.trim().split("\n");for(var d=1;d<b.length;d++){var e=b[d].trim();if(e&&(e=e.split("\t"),5<=e.length&&e[4])){var g=e[4].trim();if(g=this._ssid2utf8(g).trim())e={bssid:e[0].trim(),frequency:parseInt(e[1].trim()),signal:parseInt(e[2].trim()),flags:e[3].trim(),ssid:g},c.push(e)}}a(null,c)}else a(Error("do SCAN_RESULTS command failed"))};d.prototype._signalPoll=function(a){this._logger.log("trace","do SIGNAL_POLL command");var c=this._wpaSocket.write("SIGNAL_POLL");this._logger.log("trace",
"SIGNAL_POLL command result:\n"+c.toString("utf8"));var b=c.toString("utf8");if(b){c={};b=b.trim().split("\n");for(var d=0;d<b.length;d++){var e=b[d].trim();if(e){var g=e.indexOf("=");if(-1!=g){var n=e.substr(0,g);e=e.substr(g+1);n&&(c[n]=e)}}}a(null,c)}else a(Error("do SIGNAL_POLL command failed"))};d.prototype._checkInitWifiStatus=function(){var a=this;this._status(function(c,b){!c&&b&&"COMPLETED"!=b.wpa_state&&a._networks.length&&require("x.hub.v6.js")._led.startWifiDisconnect()})};d.prototype._wpaPassphrase=
function(a,f,b){this._logger.log("trace","call wpa_passphrase wiht ssid:"+a+" password:********");var c=require("child_process").exec;a=c('wpa_passphrase "'+a+'" "'+f+'"');var h=this,d=null;a.stdout.on("data",function(a){d+=String(a)});a.on("error",function(a){b&&(b(a),b=null)});a.on("close",function(a){if(0==a){a=null;for(var c=d.split("\n"),f=0;f<c.length;f++){var e=c[f].trim();if(e&&"psk="==e.substr(0,4)){a=e.substr(4);break}}h._logger.log("trace","call wpa_passphrase get psk:"+a);b&&(b(null,a),
b=null)}else b&&(b(Error("exit with code:"+a)),b=null)})};d.prototype._read=function(a){require("fs").readFile(this._file,{encoding:"utf8"},function(c,b){if(c)a(c);else{c=[];if(b){b=b.split("\n");for(var f=null,h=0;h<b.length;h++){var d=b[h].trim();if(d&&"#"!=d.charAt(0))if("network="==d.substr(0,8))f={};else if("}"==d)f&&c.push(f),f=null;else if(f){var e=d.split("=");d=e[0];e=e[1];d&&(f[d]=e)}}}a(null,c)}})};d.prototype._write=function(a){var c="ctrl_interface=/var/run/wpa_supplicant\nupdate_config=1\n\n";
for(var b=0;b<this._networks.length;b++){var d=this._networks[b];if(d){c+="network={\n";for(var e in d)c+="\t"+e+"="+d[e]+"\n";c+="}\n"}}require("fs").writeFile(this._file,c,function(c){a(c)})};d.prototype._checkWPADaemon=function(a){var c=0,b=this,d=function(f,h){c++;!f&&h?a():10<=c?a(Error("no pid")):setTimeout(function(){b._getWpaSupplicantPID(d)},1E3)};this._getWpaSupplicantPID(d)};d.prototype._getWpaSupplicantPID=function(a){var c=require("child_process").exec;c=c("pidof wpa_supplicant");var b=
null;c.stdout.on("data",function(a){b=String(a).trim()});c.on("error",function(c){a&&(a(c),a=null)});c.on("close",function(c){a&&(a(null,b),a=null)})};d.prototype._ssid2utf8=function(a){for(var c=[],b=0;b<a.length;)if("\\"!=a.charAt(b))c.push(a.charCodeAt(b)),b++;else if(b==a.length-1)c.push(a.charCodeAt(b)),b++;else if("x"!=a.charAt(b+1))c.push(a.charCodeAt(b+1)),b+=2;else{if(!(b+3>=a.length)){var d=a.charAt(b+2)+a.charAt(b+3);d=parseInt(d,16);isNaN(d)||c.push(d)}b+=4}return(new Buffer(c)).toString("utf8")};
var e=function(a){this._logger=require("x.logger.js").getLogger("x.hub.v6.Network");this._handler=a;this._wlan0=this._eth0=this._wifi=this._resolvConf=this._dhcpcdConf=null};e.DHCPCD_CONF="/etc/dhcpcd.conf";e.RESOLV_CONF="/etc/resolv.conf";e.WPA_SUPPLICANT_CONF="/config/wpa_supplicant.conf";e.SET_MAC_SCRIPT="/opt/scripts/set_mac_address.sh";e.prototype.init=function(c){global.SYSTEM_ROOT&&(e.DHCPCD_CONF=global.SYSTEM_ROOT+e.DHCPCD_CONF,e.RESOLV_CONF=global.SYSTEM_ROOT+e.RESOLV_CONF,e.WPA_SUPPLICANT_CONF=
global.SYSTEM_ROOT+e.WPA_SUPPLICANT_CONF,e.SET_MAC_SCRIPT=global.SYSTEM_ROOT+e.SET_MAC_SCRIPT);var f=require("x.hub.eventbus.js");f.on("x.hub.peripheralman.ADD_WLAN",function(a){h._logger.log("debug","insert wlan usb stick: "+a.port);"wlan0"==a.port&&h._readMac(a.port,function(a,c){!a&&c&&(h._wlan0={mac:c});h._wifi.startWPAClient("wlan0")})});f.on("x.hub.peripheralman.REMOVE_WLAN",function(a){h._logger.log("debug","eject wlan usb stick: "+a.port);"wlan0"==a.port&&(h._wlan0=null)});this._resolvConf=
new b(e.RESOLV_CONF);this._dhcpcdConf=new a(e.DHCPCD_CONF);this._wifi=new d(e.WPA_SUPPLICANT_CONF);var h=this;this._readMac("eth0",function(a,b){!a&&b&&(h._eth0={mac:b});h._dhcpcdConf.init(function(){h._wifi.init(c)})})};e.prototype.getMediolaMac=function(){return this._eth0?this._eth0.mac:null};e.prototype.getNetwork=function(a){var c=this;this._getDNS(function(b,f){c._getRouter(function(b,d){b=require("os").networkInterfaces();var h={},e;for(e in b)if("lo"!=e.substr(0,2))for(var g=b[e],k=0;k<g.length;k++){var l=
g[k];if(!l.internal&&"IPv4"==l.family){l={ip:l.address,subnet:l.netmask,mac:l.mac};var m=c._dhcpcdConf.getConfig(e);(l.dhcp=m.dhcp)?(l.router=d?d[e]:null,l.dns=f):(l.router=m.router[0],l.dns=m.dns);h[e]=l}}c._eth0&&!h.eth0&&(h.eth0={mac:c._eth0.mac});c._wlan0&&!h.wlan0&&(h.wlan0={mac:c._wlan0.mac});a&&a(null,h)})})};e.prototype.setNetwork=function(a,b,d){if(b)if(1!=b.dhcp&&0!=b.dhcp)d&&d(Error("invalid argument"));else{a||(a="eth0");var c={};"eth0"==a?1==b.dhcp?c.ETH0_DHCP="true":0==b.dhcp&&(c.ETH0_DHCP=
"false",c.ETH0_IP=b.ip,c.ETH0_MASK=b.subnet,c.ETH0_ROUTER=b.router,c.ETH0_DNS=b.dns.join(" ")):"wlan0"==a&&(1==b.dhcp?c.WLAN0_DHCP="true":0==b.dhcp&&(c.WLAN0_DHCP="false",c.WLAN0_IP=b.ip,c.WLAN0_MASK=b.subnet,c.WLAN0_ROUTER=b.router,c.WLAN0_DNS=b.dns.join(" ")));this._handler._sysConf.setValues(c,function(a){d&&d(a)})}else d&&d(Error("invalid argument"))};e.prototype.setMAC=function(a,b){var c=require("child_process").exec;a=c(e.SET_MAC_SCRIPT+" "+a);a.stdout.on("data",function(a){console.log(String(a))});
a.on("error",function(a){b&&(b(a),b=null)});a.on("close",function(a){b&&(b(0==a?null:Error("set mac address failed")),b=null)})};e.prototype.scanWifi=function(a,b){if(this._wlan0){var c=this;this._logger.log("debug","scan wifi with options: "+JSON.stringify(a));this._wifi.scan("wlan0",function(a,f){c._logger.log("debug","scan wifi "+(a?"failed: "+a.message:"success: "+JSON.stringify(f)));!a&&f&&(f=f.filter(function(a){return a&&a.flags&&-1==a.flags.indexOf("EAP")&&-1==a.flags.indexOf("WEP")?!0:!1}));
b&&b(a,f)})}else b&&b(Error("wlan not avaliable"))};e.prototype.connectWifi=function(a,b){if(this._wlan0)if(a&&a.ssid&&a.password){var c=!1;if("true"==a.dhcp||"1"==a.dhcp||1==a.dhcp)c=!0;var f=this;this._logger.log("debug","connect to wifi to: "+a.ssid+(c?" (dhcp=true)":""));this._wifi.connect("wlan0",a,function(a){f._logger.log("debug","connect wifi "+(a?"failed: "+a.message:"success"));a?b&&b(a):c?(f._logger.log("debug","enable dhcp of wlan0"),f._handler._sysConf.setValues({WLAN0_DHCP:"true"},function(a){f._logger.log("debug",
"enable dhcp of wlan0 "+(a?" failed: "+a.message:" success"));b&&b(a)})):b&&b()})}else b&&b(Error("invalid arguments"));else b&&b(Error("wlan not avaliable"))};e.prototype.disconnectWifi=function(a,b){if(this._wlan0){var c=this;this._logger.log("debug","disconnect wifi");this._wifi.disconnect("wlan0",a,function(a){c._logger.log("debug","disconnect wifi "+(a?"failed: "+a.message:"success"));b&&b(a)})}else b&&b(Error("wlan not avaliable"))};e.prototype.getWifiInfo=function(a,b){if(this._wlan0){var c=
this;this._logger.log("debug","get wifi info");this._wifi.info(null,function(a,f){c._logger.log("debug","get wifi status "+(a?" failed:"+a.message:" success:"+JSON.stringify(f)));if(a)b&&b(a);else{var d=c._handler._sysConf.getValueSync("WLAN0_DHCP");f.config={wlan0:{dhcp:"true"==d||1==d||""==d}};f.config.wlan0.dhcp||(f.config.wlan0.ip=c._handler._sysConf.getValueSync("WLAN0_IP"),f.config.wlan0.subnet=c._handler._sysConf.getValueSync("WLAN0_MASK"),f.config.wlan0.router=c._handler._sysConf.getValueSync("WLAN0_ROUTER"),
d=c._handler._sysConf.getValueSync("WLAN0_DNS"),f.config.wlan0.dns=d?d.split(" "):[]);b&&b(a,f)}})}else b&&b(Error("wlan not avaliable"))};e.prototype.resetNetwork=function(a){this._logger.log("debug","reset");var c=this;this._wifi.reset(function(b){b?(c._logger.log("debug","reset wifi failed: "+b.message),a&&a(b)):c._handler._sysConf.setValues({ETH0_DHCP:"true",WLAN0_DHCP:"true"},function(b){b?c._logger.log("debug","reset to dhcp failed: "+b.message):c._logger.log("debug","reset success");a&&a(b)})})};
e.prototype.restore=function(a,b){this._logger.log("debug","restore from:"+a);var c=this;this._wifi.restore(a,function(a){c._logger.log("debug","restore "+(a?"failed: "+a.message:"success"));b&&b(a)})};e.prototype.backup=function(a,b){this._logger.log("debug","backup to:"+a);var c=this;this._wifi.backup(a,function(a){c._logger.log("debug","backup "+(a?"failed: "+a.message:"success"));b&&b(a)})};e.prototype._getDNS=function(a){this._resolvConf.getDns(a)};e.prototype._getRouter=function(a){var c=require("child_process").exec;
c=c("route -n");var b=null;c.stdout.on("data",function(a){b+=String(a)});c.on("error",function(c){a&&(a(c),a=null)});c.on("close",function(c){if(0==c){c={};for(var f=b.split("\n"),d=2;d<f.length;d++){var e=f[d].trim().split(" ").filter(function(a){return!!a});e.length&&"0.0.0.0"==e[0].trim()&&(c[e[7].trim()]=e[1].trim())}a&&(a(null,c),a=null)}else a&&(a(Error("exit with code:"+c)),a=null)})};e.prototype._readMac=function(a,b){if("PI-CM3+"!=global.PLATFORM)b();else{var c=this;this._logger.log("trace",
"read "+a+" mac");require("fs").readFile("/sys/class/net/"+a+"/address",{encoding:"utf8"},function(f,d){c._logger.log("trace","read "+a+" mac "+(f?" failed:"+f.message:" success:"+d));if(d){d=d.trim();var e=d.replace(/:/g,"-")}b(f,e)})}};return e}();
x.hub.v6.SystemConf=function(){var g=function(){this._conf={};this._writeCallbacks=[];this._writing=!1};g.FILE="/config/system.conf";g.prototype.init=function(a){global.SYSTEM_ROOT&&(g.FILE=SYSTEM_ROOT+g.FILE);this._readConf(function(){a&&a()})};g.prototype.getValueSync=function(a){if(void 0==a||null==a||"string"!=typeof a)throw Error("invalid key");a=this._conf[a];if(void 0==a||null==a)a="";return a};g.prototype.getValue=function(a,b){if(void 0==a||null==a||"string"!=typeof a)b&&b(Error("invalid key"));
else{a=this._conf[a];if(void 0==a||null==a)a="";b&&b(null,a)}};g.prototype.setValue=function(a,b,d){void 0==a||null==a||"string"!=typeof a?d&&d(Error("invalid key")):void 0==b||null==b||"string"!=typeof b?d&&d(Error("invalid value")):(this._conf[a]=b,d&&this._writeCallbacks.push(d),this._writing||this._doNextWrite())};g.prototype.setValues=function(a,b){if(a){var d=0,e;for(e in a)if(void 0!=e&&null!=e&&"string"==typeof e){var c=a[e];void 0!=c&&null!=c&&"string"==typeof c&&(d++,this._conf[e]=c)}0==
d?b&&b(Error("no valid entry")):(b&&this._writeCallbacks.push(b),this._writing||this._doNextWrite())}else b&&b(Error("invalid map"))};g.prototype.reset=function(a){this._conf={};a&&this._writeCallbacks.push(a);this._writing||this._doNextWrite()};g.prototype.restore=function(a,b){var d=require("fs"),e=require("fs-extra");if(d.existsSync(a+"/config/system.conf"))try{e.copySync(a+"/config/system.conf",g.FILE)}catch(c){}b&&b()};g.prototype.backup=function(a,b){require("fs-extra").copy(g.FILE,a+"/config/system.conf",
function(a){b&&b(a)})};g.prototype._doNextWrite=function(){var a=this._writeCallbacks;this._writeCallbacks=[];this._writing=!0;var b=this;this._writeConf(function(d){b._writing=!1;for(var e=0;e<a.length;e++){var c=a[e];try{c(d)}catch(f){}}b._writeCallbacks&&b._writeCallbacks.length&&b._doNextWrite()})};g.prototype._readConf=function(a){var b=this;this._readFile(function(d,e){if(!d&&e)for(d=e.split("\n"),e=0;e<d.length;e++){var c=d[e].trim();if(c){var f=c.indexOf("=");if(-1!=f){var h=c.substr(0,f).trim();
c=c.substr(f+1).trim();h&&(b._conf[h]=c)}}}a()})};g.prototype._writeConf=function(a){var b="",d;for(d in this._conf)b+=d+"="+this._conf[d]+"\n";this._writeFile(b,a)};g.prototype._readFile=function(a){require("fs").readFile(g.FILE,{encoding:"utf8"},function(b,d){a(b,d)})};g.prototype._writeFile=function(a,b){require("fs").writeFile(g.FILE,a,function(a){b(a)})};return g}();
x.hub.v6.STM=function(){var g=require("util"),a=require("events"),b=require("x.hub.v5.js").USBSerial,d=function(a,b){this._logger=require("x.logger.js").getLogger("x.hub.v6.STM.Serial");this._port=a?a:e.SERIAL_PORT;this._baudrate=b?b:e.SERIAL_BAUDRATE;this._stmUSBSerial=null;this._receiveBuffer=new Buffer([]);this._onData=null;this._useAck=!0;this._reqFifo=[];this.REQ_FIFO_MAX_LEN=5;this.ACK_TO=200;this.RSP_TO=1E4;this.RSP_END_TO=2E3};g.inherits(d,b);d.prototype._openSTMUSB=function(a){if(this._stmUSBSerial)a&&
a(!0);else{var c=this,b=a;a=require("xnm.aio.m10T.js");var d=this._baudrate,e=new a.STMUSBSerial;e.on("error",function(){c._logger.log("trace","st port error");try{c._stmUSBSerial.close()}catch(l){}c._stmUSBSerial=null;b&&b(!1);b=null});e.on("timeout",function(){c._logger.log("trace","st port timeout")});e.on("data",function(a){c._logger.log("trace","st data:"+a.toString("hex"));c._receiveBuffer=Buffer.concat([c._receiveBuffer,a]);for(a=c._getNextDataPackage();a;){c._logger.log("trace","st package:"+
a.toString("hex"));var b=a.slice(1,a.length-1);switch(a[0]){case 80:c._logger.log("info","receive st event:"+b.toString());c._sendAck();break;case 0:c._onNak();break;case 1:c._onAck();break;case 34:c._sendAck();c._onRspError(b);break;case 32:c._sendAck();c._onRsp(b);break;case 33:c._sendAck();c._onRspEnd(b);break;default:c._sendAck()}c._onData&&c._onData({type:a[0],data:b});a=c._getNextDataPackage()}});e.open(this._port,function(){c._logger.log("trace","st connected");c._stmUSBSerial=e;b&&b(!0);b=
null},d)}};var e=function(a,b,h,g){this._logger=require("x.logger.js").getLogger("x.hub.v6.STM");this._handler=a;this._pin=g?g:e.RESET_PIN;this._last_error=this._state=0;var c=this;this._serial=new d(b?b:e.SERIAL_PORT,h?h:e.SERIAL_BAUDRATE);this._serial.on("data",function(a){c._onData(a)});this._flashTO=this._flashCB=this._resetTO=this._resetCB=null};g.inherits(e,a);e.SERIAL_PORT="/dev/ttyS0";e.SERIAL_BAUDRATE=230400;e.BOOT_PIN=4;e.RESET_PIN=5;e.MODE_SCRIPT="/opt/scripts/set_stm_mode.sh";e.FIRMWARE_FILE=
"/opt/firmware/latest.bin";e.prototype.init=function(a){global.SYSTEM_ROOT&&(e.MODE_SCRIPT=SYSTEM_ROOT+e.MODE_SCRIPT,e.FIRMWARE_FILE=SYSTEM_ROOT+e.FIRMWARE_FILE);var c=this;this._state=1;this._serial._openSTMUSB(function(b){b?c._state=2:(c._state=0,c._last_error=1);a&&a(b)})};e.prototype.reset=function(a){if(5==this._state)a&&a(Error("stm is resetting"));else if(2!=this._state)a&&a(Error("stm has state:"+this._state));else{this._logger.log("trace","do stm factory reset");var c=this;this._state=5;
this._serial.reset(function(){c._serial.sendCommand(53,[],function(b){var f=null;if(!b||b.error)f=b?b.error:Error("reset stm failed");f?(c._logger.log("trace","do stm factory reset failed:"+f.message),a&&a(f)):(c._resetCB=function(){c._resetTO&&(clearTimeout(c._resetTO),c._resetTO=null);c._state=2;a&&a()},c._resetTO=setTimeout(function(){c._resetTO=null;c._state=2;a&&a(Error("reset timeout"))},3E4))})})}};e.prototype.reboot=function(a){if(3==this._state)a&&a(Error("stm is rebooting"));else if(2!=
this._state)a&&a(Error("stm has state:"+this._state));else{this._logger.log("trace","reboot stm");var c=this;this._state=3;this._serial.reset(function(){c._setSTMMode("reboot",function(b){c._logger.log("trace","reboot stm "+(b?"failed:"+b.message:"success"));c._state=2;a&&a(b)})})}};e.prototype.backup=function(a,b){var c=this,f=function(a,b,f){c.sendCommand(16,a,function(a){a&&a.data?a.error?f(Error("response error:"+a.data.toString())):require("fs").writeFile(b,a.data.toString(),function(a){f(a)}):
f(Error("invalid response"))})};c._logger.log("trace","backup get states");f("XC_FNC=GetStates&config=1",a+"/states.json",function(d){d?(c._logger.log("warn","backup get states failed:"+d.message),b&&b(d)):(c._logger.log("trace","backup get si"),f("XC_FNC=GetSI",a+"/si.json",function(d){d?(c._logger.log("warn","backup get si failed:"+d.message),b&&b(d)):(c._logger.log("trace","backup get config (hmip)"),f("XC_FNC=GetConfig&sys=HmIP",a+"/conf_hmip.json",function(d){d?(c._logger.log("warn","backup get config (hmip) failed:"+
d.message),b&&b(d)):(c._logger.log("trace","backup get sys (hmip)"),f("XC_FNC=GetSys&sys=HmIP",a+"/sys_hmip.json",function(a){a&&c._logger.log("warn","backup get sys (hmip) failed:"+a.message);b&&b(a)}))}))}))})};e.prototype.restore=function(a,b){if(6==this._state)b&&b(Error("stm restore process is running"));else if(2!=this._state)b&&b(Error("stm has state:"+this._state));else{this._state=6;var c=this,d=function(a,b){var d=function(a,b){if(a.length){var f=require("querystring"),e=a.pop();e&&e.type&&
e.adr&&"HMIP"!=e.adr.substr(0,4).toUpperCase()?(f=f.stringify(e),c._serial.sendCommand(16,"XC_FNC=AddSensor&"+f,function(c){d(a,b)})):d(a,b)}else b()};(function(a,b){var c=require("fs-extra");a+="/states.json";c.existsSync(a)?c.readFile(a,{encoding:"utf8"},function(a,c){if(a)b(a);else if(a=[],c)try{var d=JSON.parse(c);b(null,d)}catch(r){b(r)}else b(null,a)}):b()})(a,function(a,c){a?b(a):c&&0!=c.length?d(c,function(){b()}):b()})},f=function(a,b){var d=function(a,b){a.XC_FNC="setConfig";a.sys="HmIP";
c._serial.sendCommand(17,JSON.stringify(a),function(a){a&&a.data?b(null,a.data.toString()):a&&a.error?b(Error(a.error)):b(Error("fail"))})};(function(a,b){var c=require("fs-extra");a+="/conf_hmip.json";c.existsSync(a)?c.readFile(a,{encoding:"utf8"},function(a,c){if(a)b(a);else if(c)try{var d=JSON.parse(c);b(null,d)}catch(r){b(r)}else b(null,null)}):b()})(a,function(a,c){a?b(a):c?d(c,b):b()})},e=function(a,b){var d=function(a,b){if(a.length){var f=a.pop();f?(f.XC_FNC="addSensor",c._serial.sendCommand(17,
JSON.stringify(f),function(c){d(a,b)})):d(a,b)}else b()};(function(a,b){var c=require("fs-extra");a+="/sys_hmip.json";c.existsSync(a)?c.readFile(a,{encoding:"utf8"},function(a,c){if(a)b(a);else if(c)try{var d=JSON.parse(c);b(null,d)}catch(r){b(r)}else b(null,null)}):b()})(a,function(a,c){a?b(a):c&&0!=c.length?d(c,function(){b()}):b()})};c._logger.log("trace","reset stm for restore");(function(a){c._serial.reset(function(){c._serial.sendCommand(53,[],function(b){var d=null;if(!b||b.error)d=b?b.error:
Error("reset stm failed");d?a(d):(c._resetCB=function(){c._resetTO&&(clearTimeout(c._resetTO),c._resetTO=null);a()},c._resetTO=setTimeout(function(){c._resetTO=null;a(Error("reset timeout"))},3E4))})})})(function(h){h?(c._state=2,c._logger.log("warn","reset stm for restore failed:"+h.message),b&&b(h)):(c._logger.log("trace","restore state devices"),d(a,function(d){d&&c._logger.log("warn","restore state devices failed:"+d.message);c._logger.log("trace","restore config (hmip)");f(a,function(d){d&&c._logger.log("warn",
"restore config (hmip) failed:"+d.message);c._logger.log("trace","restore sys (hmip)");e(a,function(a){a&&c._logger.log("warn","restore sys (hmip) failed:"+a.message);c._state=2;b&&b()})})}))})}};e.prototype.flashFirmware=function(a,b){if(4==this._state)b&&b(Error("flash stm firmware proceess is running"));else if(0!=this._state&&2!=this._state)b&&b(Error("stm has state:"+this._state));else{a||(a=e.FIRMWARE_FILE);this._logger.log("trace","start to flash stm firmware:"+a);var c=this._state;this._state=
4;var d=this,f=function(a){d._logger.log("trace","wait stm reboot");d._flashCB=function(){d._logger.log("trace","stm reboot finish");d._flashTO&&(clearTimeout(d._flashTO),d._flashTO=null);d._state=c;b&&b(a)};d._flashTO=setTimeout(function(){d._logger.log("trace","stm reboot timeout");d._flashTO=null;d._state=c;b&&b(Error("reboot timeout"))},1E4)};this._serial.reset(function(){d._setSTMMode("bootloader",function(e){e?(d._logger.logger("trace","flash stm failed to enter bootloader mode:"+e.message),
d._setSTMMode("reboot",function(){d._state=c;b&&b(e)})):d._flashFirmware(a,function(a){a?d._setSTMMode("reboot",function(){d._state=c;b&&b(a)}):(d._logger.log("trace","flash stm firmware finish success"),f())})})})}};e.prototype.sendCommand=function(a,b,d){2!=this._state?(this._logger.log("trace","reject send stm command, stm connection state:"+this._state),d&&d({error:"stm connection state:"+this._state})):this._serial.sendCommand(a,b,d)};e.prototype._onData=function(a){if(a&&a.type&&a.data)if(80==
a.type){a=a.data.toString();var b=null;8<a.length&&"{XC_EVT}"==a.substr(0,8)?(a=a.substr(8),b="EVT"):4<a.length&&"EVT:"==a.substr(0,4)?(a=a.substr(4),b="EVT"):4<a.length&&"STA:"==a.substr(0,4)&&(a=a.substr(4),b="STA");this.emit("event",a,b)}else if(87==a.type)if(5==this._state||6==this._state){if(this._resetCB){try{this._resetCB()}catch(h){}this._resetCB=null}}else{if(4==this._state&&this._flashCB){try{this._flashCB()}catch(h){}this._flashCB=null}}else if(81==a.type||83==a.type)b=a.data.readUInt8(0),
b=b.toString(16),0!=b.length%2&&(b="0"+b),require("x.hub.commandman.js").commandHandlerV6.executeCommandWithCommandInfo(81==a.type?{legacycloudaction:b}:{cloudaction:b},function(){},"stm");else if(69==a.type)b=a.data.readUInt8(0),a=require("x.hub.v6.js")._led,b?a.startDutyCycle():a.stopDutyCycle();else if(70==a.type)switch(b=a.data.readUInt8(1),a=require("x.hub.v6.js")._led,b){case 0:a.setColor(0,0,0);break;case 1:a.setColor(0,255,0);break;case 2:a.setColor(0,0,255);break;case 3:a.setColor(255,0,
0);break;case 4:a.setColor(255,255,0);break;case 5:a.setColor(255,255,255);break;case 6:a.setColor(255,0,255);break;case 7:a.setColor(0,255,255)}};e.prototype._setSTMMode=function(a,b){var c=require("child_process").exec;c=c(e.MODE_SCRIPT+" "+a);c.on("error",function(a){b&&(b(a),b=null)});c.on("close",function(c){b&&(b(0==c?null:Error("set stm mode: "+a+" failed")),b=null)})};e.prototype._flashFirmware=function(a,b){var c=this;a=new (require("xnm.aio.m10T.js").STMUpdater)(a);this._logger.log("trace",
"flash stm with dfu-util");a.startDFUUpdate("dfu-util",function(a){b&&a&&(a.error?(c._logger.log("trace","flash stm failed:"+a.error),b(Error(a.error)),b=null):a.state&&(c._logger.log("trace","flash stm progress:"+a.state),c.emit("flash",{progress:a.state}),100==a.state&&(c._logger.log("trace","flash stm success"),b(),b=null)))},null,"v6p")};return e}();
x.hub.v6.LED=function(){var g=function(){this._logger=require("x.logger.js").getLogger("x.hub.v6.LED");this._rgb=[255,255,255];this._state=0;this._buffer=[]};g.STATE_NORMAL=0;g.STATE_BLINK=1;g.STATE_WIFI_DISCONNECT=2;g.STATE_DUTY_CYCLE=3;g.STATE_FLASH_STM=4;g.STATE_INIT_SYSTEM=5;g.STATE_RESET_SYSTEM=6;g.PROCESS="setlight";g.NAMED_PIPE="/tmp/rgb.cfg";g.prototype.init=function(){if(localStorage){var a=localStorage.getItem("x.hub.Server.led");a&&6==a.length&&a.match(/^([a-fA-F0-9]){6}/g)&&(this._rgb=
[parseInt(a.substr(0,2),16),parseInt(a.substr(2,2),16),parseInt(a.substr(4,2),16)])}};g.prototype.saveColor=function(a,b,d,e){var c=this;this.setColor(a,b,d,function(f){if(!f&&localStorage){c._rgb=[a,b,d];for(var h=(new Buffer(c._rgb)).toString("hex");6>h.length;)h="0"+h;localStorage.setItem("x.hub.Server.led",h)}e&&e(f)})};g.prototype.setColor=function(a,b,d,e){if(this._state>g.STATE_BLINK)e&&e(Error("led state:"+this._state));else{var c=this;this._state=g.STATE_NORMAL;this._buffer[g.STATE_BLINK]=
null;this._setColor(a,b,d,function(f){f||(c._buffer[g.STATE_NORMAL]=[a,b,d]);e&&e(f)})}};g.prototype.blinkColor=function(a,b,d,e,c){if(this._state>g.STATE_BLINK)c&&c(Error("led state:"+this._state));else{var f=this;this._state=g.STATE_BLINK;this._buffer[g.STATE_BLINK]=[a,b,d,e];this._blinkColor(a,b,d,e,function(a){a?(f._state=g.STATE_NORMAL,f._buffer[g.STATE_BLINK]=null,f._setLastColor(function(){c&&c(a)})):c&&c()})}};g.prototype.stopBlinkColor=function(a){this._state!=g.STATE_BLINK?a&&a():(this._state=
g.STATE_NORMAL,this._buffer[g.STATE_BLINK]=null,this._setLastColor(function(b){a&&a(b)}))};g.prototype.startWifiDisconnect=function(a){this._logger.log("trace","start wifi disconnect (state="+this._state+")");if(this._state==g.STATE_WIFI_DISCONNECT)a&&a();else if(this._buffer[g.STATE_WIFI_DISCONNECT]=!0,this._state>g.STATE_WIFI_DISCONNECT)a&&a(Error("led state:"+this._state));else{var b=this;this._state=g.STATE_WIFI_DISCONNECT;this._blinkColor(255,255,0,1E3,function(d){d&&(b._state=g.STATE_NORMAL,
b._buffer[g.STATE_WIFI_DISCONNECT]=null,b._setLastColor(a));a&&a(d)})}};g.prototype.stopWifiDisconnect=function(a){this._buffer[g.STATE_WIFI_DISCONNECT]=null;this._state!=g.STATE_WIFI_DISCONNECT?a&&a():(this._state=g.STATE_NORMAL,this._setLastColor(function(b){a&&a(b)}))};g.prototype.startDutyCycle=function(a){this._logger.log("trace","start duty cycle");if(this._state==g.STATE_DUTY_CYCLE)a&&a();else if(this._buffer[g.STATE_DUTY_CYCLE]=!0,this._state>g.STATE_DUTY_CYCLE)a&&a(Error("led state:"+this._state));
else{var b=this;this._state=g.STATE_DUTY_CYCLE;this._blinkColor(255,0,0,500,function(d){d&&(b._state=g.STATE_NORMAL,b._buffer[g.STATE_DUTY_CYCLE]=null,b._setLastColor(a));a&&a(d)})}};g.prototype.stopDutyCycle=function(a){this._logger.log("trace","stop duty cycle");this._buffer[g.STATE_DUTY_CYCLE]=null;this._state!=g.STATE_DUTY_CYCLE?a&&a():(this._state=g.STATE_NORMAL,this._setLastColor(function(b){a&&a(b)}))};g.prototype.startFlashSTM=function(a){if(this._state==g.STATE_FLASH_STM)a&&a();else if(this._state>
g.STATE_FLASH_STM)a&&a(Error("led state:"+this._state));else{var b=this;this._state=g.STATE_FLASH_STM;this._buffer[g.STATE_FLASH_STM]=!0;this._blinkColor(255,255,0,50,function(d){d&&(b._state=g.STATE_NORMAL,b._buffer[g.STATE_FLASH_STM]=null,b._setLastColor(a));a&&a(d)})}};g.prototype.stopFlashSTM=function(a){this._buffer[g.STATE_FLASH_STM]=null;this._state!=g.STATE_FLASH_STM?a&&a():(this._state=g.STATE_NORMAL,this._setLastColor(function(b){a&&a(b)}))};g.prototype.startSystemInit=function(a){this._logger.log("trace",
"start system init");if(this._state==g.STATE_INIT_SYSTEM)a&&a();else if(this._state>g.STATE_INIT_SYSTEM)a&&a(Error("led state:"+this._state));else{var b=this;this._state=g.STATE_INIT_SYSTEM;this._buffer[g.STATE_INIT_SYSTEM]=!0;this._blinkColor(255,255,255,1E3,function(d){d&&(b._state=g.STATE_NORMAL,b._buffer[g.STATE_INIT_SYSTEM]=null,b._setLastColor(a));a&&a(d)})}};g.prototype.stopSystemInit=function(a){this._logger.log("trace","stop system init");this._state!=g.STATE_INIT_SYSTEM?a&&a():(this._state=
g.STATE_NORMAL,this._buffer[g.STATE_INIT_SYSTEM]=null,this._setLastColor(function(b){a&&a(b)}))};g.prototype.startResetSystem=function(a,b,d,e){if(this._state>g.STATE_RESET_SYSTEM)e&&e(Error("led state:"+this._state));else{var c=this;this._state=g.STATE_RESET_SYSTEM;this._buffer[g.STATE_RESET_SYSTEM]=[a,b,d];this._setColor(a,b,d,function(a){a&&(c._state=g.STATE_NORMAL,c._buffer[g.STATE_RESET_SYSTEM]=null,c._setLastColor(e));e&&e(a)})}};g.prototype.stopResetSystem=function(a){this._state>g.STATE_RESET_SYSTEM?
a&&a(Error("led state:"+this._state)):(this._state=g.STATE_NORMAL,this._buffer[g.STATE_RESET_SYSTEM]=null,this._setColor(0,0,0,function(b){a&&a(b)}))};g.prototype._setLastColor=function(a){this._buffer[g.STATE_INIT_SYSTEM]?this.startSystemInit(a):this._buffer[g.STATE_FLASH_STM]?this.startFlashSTM(a):this._buffer[g.STATE_DUTY_CYCLE]?this.startDutyCycle(a):this._buffer[g.STATE_WIFI_DISCONNECT]?this.startWifiDisconnect(a):this._buffer[g.STATE_BLINK]?this.blinkColor(this._buffer[1][0],this._buffer[1][1],
this._buffer[1][2],this._buffer[1][3],a):this._buffer[g.STATE_NORMAL]?this.setColor(this._buffer[0][0],this._buffer[0][1],this._buffer[0][2],a):this.setColor(this._rgb[0],this._rgb[1],this._rgb[2],a)};g.prototype._setColor=function(a,b,d,e){a=this._buildCommand([1,a,b,d,0,0]);this._logger.log("trace","set color:"+a.toString("hex"));this._doCommand(a,function(a){e&&e(a)})};g.prototype._blinkColor=function(a,b,d,e,c){a=[1,a,b,d,0,0];0==e%1E3?a[4]=e/1E3:(a[4]=Math.floor(e/1E3),a[5]=Math.round(e%1E3/
20));e=this._buildCommand(a);this._logger.log("trace","blink color:"+e.toString("hex"));this._doCommand(e,function(a){c&&c(a)})};g.prototype._buildCommand=function(a){var b=[170,a.length+3];b=b.concat(a);a=b[2];for(var d=3;d<b.length;d++)a^=b[d];b.push(a);return new Buffer(b)};g.prototype._doCommand=function(a,b){var d=this;this._getPID(function(e,c){e?(d._logger.log("trace","get program pid error:"+e.message),b&&b(e)):c?d._write(a,b):(d._logger.log("trace","program not running"),b&&b(Error("program not running")))})};
g.prototype._write=function(a,b){var d=require("fs"),e=this;d.access(g.NAMED_PIPE,d.F_OK,function(c){if(c)e._logger.log("warn","led control program not running"),b&&b(c);else{var f=d.createWriteStream(g.NAMED_PIPE);f.on("open",function(){e._logger.log("trace","stream open and write bytes");f.end(a)});f.on("error",function(a){e._logger.log("trace","stream error:"+a.messae);f.__writeTO&&(clearTimeout(f.__writeTO),f.__writeTO=null);b&&(b(a),b=null);f.destroy()});f.on("close",function(){e._logger.log("trace",
"stream close");f.__writeTO&&(clearTimeout(f.__writeTO),f.__writeTO=null);b&&(b(),b=null)});f.__writeTO=setTimeout(function(){e._logger.log("trace","stream write timeout");b&&(b(Error("write timeout")),b=null);f.destroy()},2E3)}})};g.prototype._getPID=function(a){var b=require("child_process").exec;b=b("pidof "+g.PROCESS);var d=null;b.stdout.on("data",function(a){d=String(a).trim()});b.on("error",function(b){a&&(a(b),a=null)});b.on("close",function(b){a&&(a(null,d),a=null)})};return g}();
x.hub.v6.ResetPin=function(){var g=function(a,b){this._logger=require("x.logger.js").getLogger("x.hub.v6.ResetPin");this._handler=a;this._pinID=b;this._pinID||(this._pinID=g.PIN);this._checkInterval=this._pressedTS=this._resetMode=this._pin=null};g.PIN=24;g.prototype.init=function(){this._logger.log("trace","init reset pin:"+this._pinID);if("PI-CM3+"==global.PLATFORM){var a=require("onoff").Gpio;(new a(this._pinID,"in","both")).unexport();this._pin=new a(this._pinID,"in","both");var b=this;this._pin.watch(function(a,
e){b._logger.log("trace","reset pin value:"+e);1==e?b._onPress():0==e&&b._onRelease()})}};g.prototype._checkResetPin=function(){var a=this._pin.readSync();this._logger.log("trace","check reset pin value:"+a);0==a?this._onRelease():(a=Date.now()-this._pressedTS,8E3<a?"reboot"!=this._resetMode&&(this._pressedTS=Date.now(),this._resetMode="reboot",this._onModeChange()):6E3<a?"factory"!=this._resetMode&&(this._resetMode="factory",this._onModeChange()):4E3<a?"passwords"!=this._resetMode&&(this._resetMode=
"passwords",this._onModeChange()):2E3<a&&"network"!=this._resetMode&&(this._resetMode="network",this._onModeChange()))};g.prototype._onPress=function(){this._logger.log("trace","reset pin pressed");this._resetMode="reboot";this._pressedTS=Date.now();this._checkInterval&&(clearInterval(this._checkInterval),this._checkInterval=null);var a=this;this._checkInterval=setInterval(function(){a._checkResetPin()},200);this._onModeChange()};g.prototype._onRelease=function(){this._logger.log("trace","reset pin released, reset mode:"+
this._resetMode);this._checkInterval&&(clearInterval(this._checkInterval),this._checkInterval=null);var a=this._resetMode;this._pressedTS=this._resetMode=null;var b=this,d=this._handler._hub,e=require("x.hub.v6.js")._led;if(d)switch(a){case "reboot":d.restart();break;case "factory":case "passwords":case "network":d.reset(a,function(c,f){b._logger.log("trace",a+" reset finish, reboot:"+f);e.stopResetSystem();!c&&f&&d.restart()})}};g.prototype._onModeChange=function(){this._logger.log("trace","reset mode change to:"+
this._resetMode);var a=require("x.hub.v6.js")._led;switch(this._resetMode){case "reboot":a.startResetSystem(0,0,0);break;case "network":a.startResetSystem(0,255,0);break;case "passwords":a.startResetSystem(255,255,0);break;case "factory":a.startResetSystem(255,0,0)}};return g}();
x.hub.v6.Recovery=function(){var g=function(){};g.FILE="/config/.recoveryMode";g.prototype.init=function(a){global.SYSTEM_ROOT&&(g.FILE=SYSTEM_ROOT+g.FILE);a&&a()};g.prototype.createEmptyFile=function(a){this._writeProperties({},function(b){a&&a(b)})};g.prototype.setFirmwareUpdateUrl=function(a,b){var d=this;this._readProperties(function(e,c){e?b&&b(e):(c||(c={}),c.URL=a,d._writeProperties(c,function(a){b&&b(a)}))})};g.prototype._readProperties=function(a){var b=require("fs");b.existsSync(g.FILE)?
b.readFile(g.FILE,{encoding:"utf8"},function(b,e){if(b)a&&a(b);else{b={};if(e){e=e.split("\n");for(var c=0;c<e.length;c++){var d=e[c].trim().split("=");b[d[0]]=d[1]}}a(null,b)}}):a(null,{})};g.prototype._writeProperties=function(a,b){var d=require("fs"),e=[],c;for(c in a){var f=a[c];if(void 0==f||null==f)f="";e.push(c+"="+f)}a=e.length?e.join("\n"):"";d.writeFile(g.FILE,a,function(a){b(a)})};return g}();
x.hub.v6.ExtraInfo=function(){var g=function(){this._logger=require("x.logger.js").getLogger("x.hub.v6.ResetPin")};g.prototype.getInfo=function(a){var b=this,d={};this._logger.log("trace","get cpu temperature");this._getCPUTemperature(function(e,c){b._logger.log("trace","get cpu temperature "+(e?"failed:"+e.message:"success:"+c));e||(d.cpuTemp=c);b._logger.log("trace","get gpu temperature");b._getGPUTemperature(function(e,g){b._logger.log("trace","get gpu temperature "+(e?"failed:"+e.message:"success:"+
c));e||(d.gpuTemp=g);a&&a(null,d)})})};g.prototype._getCPUTemperature=function(a){require("fs").readFile("/sys/class/thermal/thermal_zone0/temp",{encoding:"utf8"},function(b,d){b?a(b):(b=parseInt(d),isNaN(b)?a(Error("invalid temperature")):a(null,b/1E3))})};g.prototype._getGPUTemperature=function(a){var b=require("child_process").exec;b=b("vcgencmd measure_temp");var d=null,e=this;b.stdout.on("data",function(a){e._logger.log("trace","get gpu temperature:"+String(a));a=String(a).trim();"temp="==a.substr(0,
5)&&(a=a.substring(5,a.length-2),a=parseFloat(a),isNaN(a)||(d=a))});b.on("error",function(b){a&&(a(b),a=null)});b.on("close",function(b){0!=b?a&&(a(Error("read gpu temperature failed")),a=null):null==d?a&&(a(Error("invalid temperature")),a=null):a&&(a(null,d),a=null)})};return g}();
x.hub.v6.ZwayServer=function(){var g=function(){this._logger=require("x.logger.js").getLogger("x.hub.v6.ZwayServer");this._state=0};g.SCRIPT="/srv/init.d/S01z-way-server";g.FOLDER="/srv/z-way-server";g.prototype.init=function(a){global.SYSTEM_ROOT&&(g.FOLDER=SYSTEM_ROOT+g.FOLDER,g.SCRIPT=SYSTEM_ROOT+g.SCRIPT);a&&a()};g.prototype._getConfigFolder=function(){return g.FOLDER+"/config"};g.prototype._getAutomationFolder=function(){return g.FOLDER+"/automation"};g.prototype._getAutomationStorageFolder=
function(){return this._getAutomationFolder()+"/storage"};g.prototype.start=function(a){if(this._state)a&&a(Error("current state is:"+this._state));else{var b=this;this._state=1;this._startAndCheck(3,1E3,function(d){b._state=0;a&&a(d)})}};g.prototype.stop=function(a){if(this._state)a&&a(Error("current state is:"+this._state));else{var b=this;this._state=2;this._stopAndCheck(3,1E3,function(d){b._state=0;a&&a(d)})}};g.prototype.reset=function(a){if(this._state)a&&a(Error("current state is:"+this._state));
else{var b=this;this._state=3;this._logger.log("trace","reset z-way-server");var d=!1;require("async").series([function(a){b._logger.log("trace","check z-way-server state");b._isRunning(function(c,e){b._logger.log("trace","check z-way-server state "+(c?" failed:"+c.message:" running:"+e));c||(d=e);a()})},function(a){d?(b._logger.log("trace","stop z-way-server"),b._stopAndCheck(3,1E3,function(b){a(b)})):a()},function(a){b._logger.log("trace","clear z-way-server folder");b._reset(!1,a)},function(a){d?
(b._logger.log("trace","start z-way-server"),b._startAndCheck(3,1E3,a)):a()}],function(d){b._state=0;a&&a(d)})}};g.prototype.restore=function(a,b,d){if(this._state)d&&d(Error("current state is:"+this._state));else{var e=this;this._state=5;this._logger.log("trace","retore zway data (restoreUZB="+b+") from:"+a+" to:"+g.FOLDER);var c=!1;require("async").series([function(a){e._logger.log("trace","check z-way-server state");e._isRunning(function(b,d){e._logger.log("trace","check z-way-server state "+(b?
" failed:"+b.message:" running:"+d));b||(c=d);a()})},function(c){if(b){e._logger.log("trace","retore uzb");var d;require("fs").existsSync(a+"/zway/z-way-backup.zbk")?(d=require("x.hub.m.zway.js").getZway())?d.restore(a+"/zway/z-way-backup.zbk",!0,function(a){e._logger.log("trace","retore uzb "+(a?" failed:"+a.message:" success"));a&&!a.code&&(a.code=-313);c(a)}):(e._logger.log("trace","retore uzb failed: z-way-server not running"),d=Error("z-way-server not running"),d.code=-312,c(d)):(e._logger.log("trace",
"retore uzb failed: no uzb backup file"),d=Error("no uzb backup file"),d.code=-311,c(d))}else c()},function(a){c?(e._logger.log("trace","stop z-way-server"),e._stopAndCheck(3,1E3,function(b){e._logger.log("trace","stop z-way-server "+(b?" failed:"+b.message:" success"));b&&!b.code&&(b.code=-314);a(b)})):a()},function(a){e._logger.log("trace","clear z-way-server folder (restoreUZB="+b+")");e._reset(b,function(c){e._logger.log("trace","clear z-way-server folder (restoreUZB="+b+")"+(c?" failed:"+c.message:
" success"));c&&!c.code&&(c.code=-315);a(c)})},function(c){e._logger.log("trace","restore z-way-server folder (restoreUZB="+b+")");e._restore(a,b,function(a){e._logger.log("trace","restore z-way-server folder (restoreUZB="+b+")"+(a?" failed:"+a.message:" success"));a&&!a.code&&(a.code=-316);c(a)})},function(a){c?(e._logger.log("trace","start z-way-server"),e._startAndCheck(3,1E3,function(b){e._logger.log("trace","start z-way-server "+(b?" failed:"+b.message:" success"));b&&!b.code&&(b.code=-317);
a(b)})):a()}],function(a){e._state=0;d&&d(a)})}};g.prototype.backup=function(a,b,d){if(this._state)d&&d(Error("current state is:"+this._state));else{this._state=4;this._logger.log("trace","backup zway data (backupUZB="+b+") to:"+a);var e=require("fs-extra"),c=this._getConfigFolder(),f=this._getAutomationStorageFolder();if(e.existsSync(c))try{e.copySync(c,a+"/zway/config")}catch(k){}if(e.existsSync(f))try{e.copySync(f,a+"/zway/automation/storage")}catch(k){}if(0==b)this._state=0,d&&d();else if((e=
require("x.hub.m.zway.js").getZway())||b)if(!e&&b)this._state=0,d&&d(Error("z-way-server not running"));else{var g=this;this._logger.log("trace","backup zwave usb stick");e.backup(a+"/zway",function(a){g._logger.log("trace","backup zwave usb stick "+(a?" failed:"+a.message:" success"));g._state=0;d&&d(a)})}else this._state=0,d&&d()}};g.prototype._startAndCheck=function(a,b,d){var e=this;this._start(function(c){if(c)d&&d(c);else{var f=0,g=function(c,h){c?d&&d(c):h?d&&d():(f++,f<a?setTimeout(function(){e._isRunning(g)},
b):d&&d(Error("z-way-server do not run after execute start command")))};setTimeout(function(){e._isRunning(g)},b)}})};g.prototype._stopAndCheck=function(a,b,d){var e=this;this._stop(function(c){if(c)d&&d(c);else{var f=0,g=function(c,h){c?d&&d(c):h?(f++,f<a?setTimeout(function(){e._isRunning(g)},b):d&&d(Error("z-way-server still run after execute stop command"))):d&&d()};setTimeout(function(){e._isRunning(g)},b)}})};g.prototype._isRunning=function(a){this._logger.log("trace","check z-way-server pid");
var b=require("child_process").exec;b=b("pidof z-way-server");var d=this,e=null;b.stdout.on("data",function(a){d._logger.log("trace","get z-way-server pid out:"+String(a));e=String(a)});b.on("error",function(b){d._logger.log("trace","get z-way-server pid error:"+b.message);a&&(a(b),a=null)});b.on("close",function(b){d._logger.log("trace","get z-way-server pid finish: code="+b);0==b?a&&(a(null,e?!0:!1),a=null):1==b?a&&(a(null,!1),a=null):a&&(a(Error("get z-way-server pid failed, return code:"+b)),
a=null)})};g.prototype._start=function(a){var b=g.SCRIPT+" start";this._logger.log("trace","start z-way-server with command:"+b);var d=require("child_process").exec;b=d(b);var e=this;b.stdout.on("data",function(a){e._logger.log("trace","start z-way-server out:"+String(a))});b.on("error",function(b){e._logger.log("trace","start z-way-server error:"+b.message);a&&(a(b),a=null)});b.on("close",function(b){e._logger.log("trace","start z-way-server "+(0==b?"success":"failed"));0!=b?a&&(a(Error("start z-way-server failed, return code:"+
b)),a=null):a&&(a(0==b?null:Error("start z-way-server failed")),a=null)})};g.prototype._stop=function(a){var b=g.SCRIPT+" stop";this._logger.log("trace","stop z-way-server with command:"+b);var d=require("child_process").exec;b=d(b);var e=this;b.stdout.on("data",function(a){e._logger.log("trace","stop z-way-server out:"+String(a))});b.on("error",function(b){e._logger.log("trace","stop z-way-server error:"+b.message);a&&(a(b),a=null)});b.on("close",function(b){e._logger.log("trace","stop z-way-server "+
(0==b?"success":"failed"));a&&(a(0==b?null:Error("stop z-way-server failed")),a=null)})};g.prototype._reset=function(a,b){var d=this._getConfigFolder(),e=this._getAutomationStorageFolder();a||this._logger.log("trace","clear z-way-server config folder:"+d);this._logger.log("trace","clear z-way-server automation storage folder:"+e);d="rm -f "+d+"/zddx/*.xml && rm -f "+e+"/*.json";a&&(d="rm -f "+e+"/*.json");a=require("child_process").exec;a=a(d);var c=this;a.stdout.on("data",function(a){c._logger.log("trace",
"reset z-way-server out:"+String(a))});a.on("error",function(a){c._logger.log("trace","reset z-way-server error:"+a.message);b&&(b(a),b=null)});a.on("close",function(a){c._logger.log("trace","clear z-way-server config "+(0==a?"success":"failed"));b&&(b(0==a?null:Error("clear z-way-server config failed")),b=null)})};g.prototype._restore=function(a,b,d){this._logger.log("trace","retore zway data (restoreUZB="+b+") from:"+a+" to:"+g.FOLDER);var e=require("fs"),c=require("fs-extra");if(!b&&e.existsSync(a+
"/zway/config")&&e.existsSync(g.FOLDER)){this._logger.log("trace","copy zway data from:"+a+"/zway/config to:"+this._getConfigFolder());try{c.copySync(a+"/zway/config",this._getConfigFolder())}catch(f){}}if(e.existsSync(a+"/zway/automation/storage")&&e.existsSync(this._getAutomationFolder())){this._logger.log("trace","copy zway data from:"+a+"/zway/automation/storag to:"+this._getAutomationStorageFolder());try{c.copySync(a+"/zway/automation/storage",this._getAutomationStorageFolder())}catch(f){}}d&&
d()};return g}();
x.hub.v6.Handler=function(){var g=function(){this._logger=require("x.logger.js").getLogger("x.hub.v6.Handler");this._centralUnit=null;this._recovery=new x.hub.v6.Recovery;this._sysConf=new x.hub.v6.SystemConf;this._stm=new x.hub.v6.STM(this,global.STM?global.STM:null);this._led=new x.hub.v6.LED;this._resetPin=new x.hub.v6.ResetPin(this);this._network=new x.hub.v6.Network(this);this._time=new x.hub.v6.Time(this);this._zwayServer=new x.hub.v6.ZwayServer(this);this._extraInfo=new x.hub.v6.ExtraInfo(this);this._hub=
null};g.prototype.CentralUnit=x.hub.v6.CentralUnit;g.prototype.LED=x.hub.v6.LED;g.prototype.ResetPin=x.hub.v6.ResetPin;g.prototype.init=function(a,b){var d=this;this._hub=a;this._led.init();this._resetPin.init();this._recovery.init();this._sysConf.init(function(){d._network.init();d._time.init();b&&b()});this._stm.init();this._zwayServer.init()};g.prototype.setIPData=function(a,b){var d=this,e=function(a,b){if(a.MAC)if(12==a.MAC.length&&a.MAC.match(/^([a-fA-F0-9]{2}){6}/g)){d._logger.log("trace",
"set mac:"+a.MAC);var c=a.MAC.substr(0,2)+":"+a.MAC.substr(2,2)+":"+a.MAC.substr(4,2)+":"+a.MAC.substr(6,2)+":"+a.MAC.substr(8,2)+":"+a.MAC.substr(10,2),e=new Buffer(a.MAC,"hex");d._logger.log("trace","set mac "+a.MAC+" on stm");d._stm.sendCommand(57,e,function(e){e&&e.error?(d._logger.log("trace","set mac "+a.MAC+" on stm failed: "+e.error),b(err,!1)):(d._logger.log("trace","set mac "+a.MAC+" on file"),d._network.setMAC(c,function(a){b(a,a?!1:!0)}))})}else b(Error("invalid mac address"));else b(null,
!1)},c=function(a,b){if(1!=a.DHCP&&0!=a.DHCP)b(null,!1);else{var c={dhcp:!0};if(0==a.DHCP){if(!(a.IP&&a.SN&&a.GW&&a.DNS)){b(Error("invalid static ip settings"));return}c.dhcp=!1;c.ip=a.IP;c.subnet=a.SN;c.router=a.GW;c.dns=a.DNS.split(",")}d._logger.log("trace","set network eth0:"+JSON.stringify(c));d._network.setNetwork("eth0",c,function(a){b(a,a?!1:!0)})}},f=!1;this._logger.log("trace","set ip data:"+JSON.stringify(a));(function(a,b){a.NTP?(d._logger.log("trace","set ntp:"+a.NTP),a=a.NTP.split(","),
d._time.setNTPServers(a,function(a){b(a,!1)})):b(null,!1)})(a,function(g,k){g?(d._logger.log("trace","set ntp failed:"+g.stack),b&&b(g)):(f=f||k,e(a,function(e,g){e?(d._logger.log("trace","set mac failed:"+e.stack),b&&b(e)):(f=f||g,c(a,function(a,c){a?(d._logger.log("trace","set network failed:"+a.stack),b&&b(a)):(f=f||c,d._logger.log("trace","set ip data finish (reboot="+f+")"),b&&b(null,f))}))}))})};g.prototype.setTZData=function(a,b){if(a){var d=this;this._time.setTimezoneEncoded(a,function(e){!d._stm||
e?b&&b(e):d._stm.sendCommand(16,"XC_FNC=setTZ&data="+a,function(c){localStorage&&localStorage.setItem("x.hub.Server.timezone",a);b&&b(c?c.error:null)})})}else b&&b(Error("invalid timezone"))};g.prototype.getTZData=function(a){this._time.getTimezoneEncoded(a)};g.prototype.setLocation=function(a,b,d){this._logger.log("debug","set location lat="+a+" long="+b);if(a&&b){var e=this;this._stm.sendCommand(16,"XC_FNC=setLocation&lat="+a+"&long="+b,function(c){e._logger.log("debug","set location to stm lat="+
a+" long="+b+" result:"+JSON.stringify(c));localStorage&&(localStorage.setItem("x.hub.Server.geo.lat",a),localStorage.setItem("x.hub.Server.geo.long",b));d&&d(c?c.error:null)})}else d&&d(Error("invalid arguments"))};g.prototype.getTimezoneSync=function(){return this._time.getTimezoneSync()};g.prototype.reboot=function(a,b,d){this._logger.log("trace","reboot");if("PI-CM3+"!=global.PLATFORM)d&&d();else{var e=this;require("async").series([function(b){"recovery"==a?e._recovery.createEmptyFile(function(a){b(a)}):
b()},function(a){b?setTimeout(function(){a()},b):a()},function(a){e._reboot(a)}],function(a){d&&d(a)})}};g.prototype._reboot=function(a){var b=require("child_process").exec;b=b("reboot");b.on("error",function(b){a&&(a(b),a=null)});b.on("close",function(b){a&&(a(0==b?null:Error("system reboot failed")),a=null)})};g.prototype.poweroff=function(a,b){this._logger.log("trace","power off");if("PI-CM3+"!=global.PLATFORM)b&&b();else{var d=this;require("async").series([function(b){a?setTimeout(function(){b()},
a):b()},function(a){d._led.setColor(0,0,0,function(){a()})},function(a){d._poweroff(a)}],function(a){b&&b(a)})}};g.prototype._poweroff=function(a){var b=require("child_process").exec;b=b("poweroff");b.on("error",function(b){a&&(a(b),a=null)});b.on("close",function(b){a&&(a(0==b?null:Error("system poweroff failed")),a=null)})};g.prototype.reset=function(a,b){this._logger.log("trace","reset "+a);var d=this;switch(a){case "network":this._network.resetNetwork(function(a){b&&b(a,a?!1:!0)});break;case "factory":this._logger.log("trace",
"reset stm");this._stm.reset(function(a){d._logger.log("trace","reset stm "+(a?"failed:"+a.message:"success"));a?b&&b(a,a?!1:!0):(d._logger.log("trace","reset z-way-server"),d._zwayServer.reset(function(a){d._logger.log("trace","reset z-way-server "+(a?"failed:"+a.message:"success"));a?b&&b(a,a?!1:!0):(d._logger.log("trace","reset network"),d._network.resetNetwork(function(a){d._logger.log("trace","reset network "+(a?"failed:"+a.message:"success"));d._logger.log("trace","reset system.conf");d._sysConf.reset(function(a){d._logger.log("trace",
"reset system.conf "+(a?"failed:"+a.message:"success"));b&&b(a,a?!1:!0)})}))}))});break;default:b&&b(Error("unknonw reset type: "+a))}};g.prototype.updateSTM=function(a,b,d){var e=this,c=function(a,b,c){var d=function(a){a&&a.progress&&b.write(a.progress+".")};e._led.startFlashSTM(function(){e._stm.on("flash",d);e._stm.flashFirmware(a,function(a){e._stm.removeListener("flash",d);a?b.write(JSON.stringify({XC_ERR:{code:"000000",msg:a.message}})):b.write(JSON.stringify({XC_SUC:{}}));b.end();e._led.stopFlashSTM(function(){c&&
c(a)})})})};a?this._saveTempFile("stm.bin",a,function(a,e){a?d&&d(a):c(e,b,d)}):c(null,b,d)};g.prototype._saveTempFile=function(a,b,d){var e=require("fs"),c=require("os"),f=require("path");c=c.tmpdir();var g=f.join(c,a);e.existsSync(f)&&e.unlinkSync(f);var k=e.createWriteStream(g);b.pipe(k);k.on("finish",function(){k.close(function(){d&&d(null,g)})});k.on("error",function(a){e.unlink(g);d&&d(a)})};g.prototype.backup=function(a,b,d){var e=this,c=function(a,b,c){var d=require("fs-extra"),f=require("path"),
g=require("os").tmpdir(),h=require("archiver"),k=new Date,l=k.getFullYear()+"",m=k.getMonth()+1+"";1==m.length&&(m="0"+m);var n=k.getDate()+"";1==n.length&&(n="0"+n);var t=k.getHours()+"";1==t.length&&(t="0"+t);var u=k.getMinutes()+"";1==u.length&&(u="0"+u);k=k.getSeconds()+"";1==k.length&&(k="0"+k);var w="backup_"+(l+m+n+t+u+k)+".xbp",q=f.join(g,w);f=d.createWriteStream(q);h=h("zip");f.on("close",function(){if(b){var a=require("crypto").createCipher("aes-256-cbc",b),e=d.createReadStream(q),f=d.createWriteStream(q+
".enc");f.on("finish",function(){d.removeSync(q);c(null,q+".enc",w)});e.pipe(a).pipe(f)}else c(null,q,w)});f.on("error",function(a){e._logger.log("warn","write backup zip file failed:"+a.message);c(a)});h.on("error",function(a){e._logger.log("warn","zip backup data failed:"+a.message);c(a)});h.pipe(f);h.directory(a+"/","backup");h.finalize()},f=null,g=require("x.crypt.js");a.query.enc&&"0"!=a.query.enc&&"false"!=a.query.enc&&(a.query.at?f=a.query.at:a.query.auth&&(f=g.MD5(unescape(encodeURI(a.query.auth+
"_SALT!")))));this._logger.log("trace","generate backup"+(f?" (encrypted)":""));g=require("fs");var k=require("os").tmpdir(),m=require("path").join(k,"backup");if(g.existsSync(m))try{g.rmdirRecursiveSync(m)}catch(l){}try{this._logger.log("trace","create backup folder: "+m),g.mkdirSync(m)}catch(l){b.status(500).json({code:-1,message:'create backup folder "'+m+'" failed:'+l.message});this._logger.log("trace",'create backup folder "'+m+'" failed:'+l.message);d&&d(Error('create backup folder "'+m+'" failed:'+
l.message));return}this._logger.log("trace","assemble backup files");this._backup(m,a.query,function(a){a?(b.status(500).json({code:a.code?a.code:-2,message:"assemble backup files failed:"+a.message}),e._logger.log("warn","assemble backup files failed:"+a.message),d&&d(a)):(e._logger.log("trace","compress backup files"),c(m,f,function(a,c,f){a?(b.status(500).json({code:-3,message:"compress backup files failed:"+a.message}),e._logger.log("warn","compress backup files failed:"+a.message),d&&d(a)):(e._logger.log("trace",
"return backup file:"+c),b.setHeader("Content-disposition","attachment; filename="+f),b.sendFile(c,null,function(a){require("fs-extra").removeSync(c);a?(e._logger.log("warn","return backup file failed:"+a.message),b.status(500).json({code:-4,message:"return backup file failed:"+a.message})):e._logger.log("trace","backup data finish");d&&d(a)}))}))})};g.prototype._backup=function(a,b,d){var e=null;if(b)if("true"==b.backup_uzb||1==b.backup_uzb||"1"==b.backup_uzb)e=!0;else if("false"==b.backup_uzb||
0==b.backup_uzb||"0"==b.backup_uzb)e=!1;var c=this;require("async").series([function(b){c._zwayServer?(c._logger.log("trace","backup zwave data"),c._zwayServer.backup(a,e,function(a){c._logger.log("trace","backup zwave data "+(a?" failed:"+a.message:" success"));if(a){var d=Error("backup zwave data failed: "+a.message);d.code=a.code?a.code:-210}b(d)})):b()},function(b){c._stm?(c._logger.log("trace","backup stm data"),c._stm.backup(a,function(a){c._logger.log("trace","backup stm data "+(a?" failed:"+
a.message:" success"));if(a){var d=Error("backup stm data failed: "+a.message);d.code=a.code?a.code:-220}b(d)})):b()},function(b){c._network?(c._logger.log("trace","backup network config"),c._network.backup(a,function(a){c._logger.log("trace","backup network config "+(a?" failed:"+a.message:" success"));if(a){var d=Error("backup network config failed: "+a.message);d.code=a.code?a.code:-230}b(d)})):b()},function(b){c._sysConf?(c._logger.log("trace","backup system config"),c._sysConf.backup(a,function(a){c._logger.log("trace",
"backup system config "+(a?" failed:"+a.message:" success"));if(a){var d=Error("backup system config failed: "+a.message);d.code=a.code?a.code:-240}b(d)})):b()},function(b){var d=require("fs-extra"),e=require("path"),f=require("x.hub.fileman.js").fileManager.getUserRootDataPath();c._logger.log("trace","backup general data");d.copy(f,e.join(a,"data"),function(f){if(f){c._logger.log("trace","backup general data failed:"+f.message);var g=Error("backup system config failed: "+f.message);g.code=f.code?
f.code:-250;b(g)}else d.exists(e.join(a,"data","localstorage","x.hub.Server.pwd"),function(f){f?d.remove(e.join(a,"data","localstorage","x.hub.Server.pwd"),function(a){c._logger.log("trace","backup general data "+(a?" failed:"+a.message:" success"));if(a){var d=Error("backup general data failed: "+a.message);d.code=a.code?a.code:-250}b(d)}):(c._logger.log("trace","backup general data success"),b())})})}],function(a){d&&d(a)})};g.prototype.restore=function(a,b,d){var e=function(a,b,c){var d=require("fs"),
e=require("fs-extra"),f=require("os").tmpdir(),h=require("path"),k=h.join(f,"restore"),l=h.join(k,"backup");if(e.existsSync(k))try{e.removeSync(k)}catch(v){c(v);return}var m=require("adm-zip"),p=null;try{(new m(a)).extractAllTo(k,!0)}catch(v){g._logger.log("warn","backup file may be encrypted"),p="invalid backup file/password"}p?b?(g._logger.log("trace","decrpyt backup file"),b=require("crypto").createDecipher("aes-256-cbc",b),f=d.createReadStream(a),d=d.createWriteStream(a+".dec.zip"),b.on("error",
function(){e.removeSync(a);e.removeSync(a+".dec.zip");c(Error(p))}),d.on("finish",function(){p=null;try{(new m(a+".dec.zip")).extractAllTo(k,!0)}catch(v){p="invalid backup file/password"}e.removeSync(a);e.removeSync(a+".dec.zip");c(p?Error(p):null,l)}),f.pipe(b).pipe(d)):(e.removeSync(a),c(Error(p)),c=null):(e.removeSync(a),c(null,l),c=null)},c=require("x.crypt.js"),f=null;a.query.key?f=a.query.key:a.query.at?f=a.query.at:a.query.auth&&(f=c.MD5(unescape(encodeURI(a.query.auth+"_SALT!"))));var g=this;
this._logger.log("trace","restore backup");(function(a,b){var c=require("fs"),d=require("os").tmpdir(),e=require("path").join(d,"restore.zip");if(c.existsSync(e))try{c.unlinkSync(e)}catch(y){b(y);return}var f=c.createWriteStream(e);a.pipe(f);f.on("finish",function(){f.close(function(){b(null,e)})});f.on("error",function(a){c.unlink(e);b(a)})})(a,function(c,h){c?(g._logger.log("warn","download backup file failed: "+c.message),b.json({XC_ERR:{code:-1,msg:"donwload backup file failed:"+c.message}}),
d&&d(c)):(g._logger.log("trace","extract backup data from: "+h),e(h,f,function(c,e){c?(g._logger.log("warn","extract backup data failed: "+c.message),b.json({XC_ERR:{code:-2,msg:"extract backup data failed:"+c.message}}),d&&d(c)):(g._logger.log("trace","restore data from: "+e),g._restore(e,a.query,function(a){try{var c=require("fs-extra");c.removeSync(h);c.removeSync(e)}catch(y){}a?(g._logger.log("warn","restore data failed: "+a.message),b.json({XC_ERR:{code:a.code?a.code:-3,msg:"restore backup data failed:"+
a.message}})):(g._logger.log("trace","restore data finish"),b.json({XC_SUC:{}}),g.reboot(null,1E3));d&&d(a)}))}))})};g.prototype._restore=function(a,b,d){var e=null;if(b)if("true"==b.restore_uzb||1==b.restore_uzb||"1"==b.restore_uzb)e=!0;else if("false"==b.restore_uzb||0==b.restore_uzb||"0"==b.restore_uzb)e=!1;var c=this;require("async").series([function(b){c._zwayServer?(c._logger.log("trace","restore zwave data"),c._zwayServer.restore(a,e,function(a){c._logger.log("trace","restore zwave data "+
(a?" failed:"+a.message:" success"));if(a){var d=Error("restore zwave data failed: "+a.message);d.code=a.code?a.code:-310}b(d)})):b()},function(b){c._stm?(c._logger.log("trace","restore stm data"),c._stm.restore(a,function(a){c._logger.log("trace","restore stm data "+(a?" failed:"+a.message:" success"));if(a){var d=Error("restore stm data failed: "+a.message);d.code=a.code?a.code:-320}b(d)})):b()},function(b){c._logger.log("trace","restore general data");var d=require("fs-extra"),e=require("path"),
f=require("x.hub.fileman.js").fileManager.getUserRootDataPath();d.copy(e.join(a,"data"),f,function(a){c._logger.log("trace","restore standard data "+(a?" failed:"+a.message:" success"));if(a){var d=Error("restore standard data failed: "+a.message);d.code=a.code?a.code:-330}b(d)})},function(b){c._network?(c._logger.log("trace","restore network config"),c._network.restore(a,function(a){c._logger.log("trace","restore network config "+(a?" failed:"+a.message:" success"));if(a){var d=Error("restore network config failed: "+
a.message);d.code=a.code?a.code:-340}b(d)})):b()},function(b){c._sysConf?(c._logger.log("trace","restore system config"),c._sysConf.restore(a,function(a){c._logger.log("trace","restore system config "+(a?" failed:"+a.message:" success"));if(a){var d=Error("restore system config failed: "+a.message);d.code=a.code?a.code:-350}b(d)})):b()}],function(a){d&&d(a)})};g.prototype.updateFirmware=function(a,b){var d=this,e=function(a,b){d._recovery.setFirmwareUpdateUrl(a,function(a){b(a)})};this._logger.log("trace",
"update firmware with url:"+a);(function(a,b){if(a){a=require("url").parse(a);var c=80;if(a.port){c=parseInt(a.port);if(0===c||isNaN(c))c=80;if(!(0<c&&65536>c)){b(Error("invalid port"));return}}"https:"==a.protocol&&80==c&&(c=443);c={host:a.hostname,port:c,path:a.path,method:"HEAD"};a=require("https:"==a.protocol?"https":"http").request(c,function(a){b&&(200==a.statusCode?b():b(Error("http response code:"+a.statusCode)),b=null)});a.setTimeout(5E3,function(){b&&(b(Error("http timeout")),b=null)});
a.on("error",function(a){b&&(b(a),b=null)});a.end()}else b(Error("invalid firmware url"))})(a,function(c){d._logger.log("trace","check online firmware"+(c?" failed:"+c.message:" success"));c?b&&b(Error("check online firmware failed:"+c.message)):(d._logger.log("trace","set reboot to recovery mode"),e(a,function(a){d._logger.log("trace","save firmware url"+(a?" failed:"+a.message:" success"));b&&b(a?Error("save firmware url failed:"+a.message):null,a?!1:!0)}))})};g.prototype.getExtraInfo=function(a){this._extraInfo.getInfo(a)};
return g}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.v6.Handler);
