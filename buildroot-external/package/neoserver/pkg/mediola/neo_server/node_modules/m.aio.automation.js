var m=m||{};m.aio=m.aio||{};m.aio.automation=m.aio.automation||{};m.aio.automation.Logger=null;
m.aio.automation.Task=function(){var a=function(c){this._id=c.id&&0<c.id?c.id:0;this._name=c.name;this._active=c.active?!0:!1;this._triggers=[];this._actions=[];var a;if(c.triggers)for(a=0;a<c.triggers.length;a++){var e=m.aio.automation.Trigger.parse(c.triggers[a]);e&&this._triggers.push(e)}if(c.actions)for(a=0;a<c.actions.length;a++)(e=m.aio.automation.Action.parse(c.actions[a]))&&this._actions.push(e)};a.prototype.added=function(){var a=this;this._triggers.forEach(function(b){b.added(a)});this._actions.forEach(function(b){b.added(a)})};
a.prototype.deleted=function(){var a=this;this._triggers.forEach(function(b){b.deleted(a)});this._actions.forEach(function(b){b.deleted(a)})};a.prototype.toJSON=function(){var a=[];this._triggers.forEach(function(b){a.push(b.toJSON())});var b=[];this._actions.forEach(function(a){b.push(a.toJSON())});return{id:this._id,name:this._name,active:this._active,triggers:a,actions:b}};a.parse=function(c){return c.name?new a(c):null};return a}();
m.aio.automation.Trigger=function(){var a=function(a){this._id=a.id&&0<a.id?a.id:0;this._active=a.active?!0:!1;this._condition=this._input=null;a.input&&(this._input=m.aio.automation.Input.parse(a.input));a.condition&&(this._condition=m.aio.automation.Contidion.parse(a.condition))};a.prototype.added=function(a){var b;this._input&&this._input.type&&(b=m.aio.automation.Inputhandler.getHandler(this._input.type))&&b.added&&"function"==typeof b.added&&b.added(a._id,this._id,this._input)};a.prototype.deleted=
function(a){var b;this._input&&this._input.type&&(b=m.aio.automation.Inputhandler.getHandler(this._input.type))&&b.deleted&&"function"==typeof b.deleted&&b.deleted(a._id,this._id,this._input)};a.prototype.toJSON=function(){return{id:this._id,active:this._active,input:this._input?this._input.toJSON():null,condition:this._condition?this._condition.toJSON():null}};a.parse=function(c){return c.input?new a(c):null};return a}();
m.aio.automation.Action=function(){var a=function(a){this._id=a.id&&0<a.id?a.id:0;this._active=a.active?!0:!1;this._output=null;a.output&&(this._output=m.aio.automation.Output.parse(a.output))};a.prototype.added=function(a){var b;this._output&&this._output.type&&(b=m.aio.automation.Inputhandler.getHandler(this._output.type))&&b.added&&"function"==typeof b.added&&b.added(a._id,this._id,this._output)};a.prototype.deleted=function(a){};a.prototype.toJSON=function(){return{id:this._id,active:this._active,
output:this._output?this._output.toJSON():null}};a.parse=function(c){return c.output?new a(c):null};return a}();m.aio.automation.Output=function(){var a=function(a){this.type=a.type};a.parse=function(a){if(!a.type)return null;var b=m.aio.automation.Outputhandler.getHandler(a.type);return b&&b.parse&&"function"==typeof b.parse?b.parse(a):null};return a}();
m.aio.automation.Input=function(){var a=function(a){this.type=a.type};a.parse=function(a){if(!a.type)return null;var b=m.aio.automation.Inputhandler.getHandler(a.type);return b&&b.parse&&"function"==typeof b.parse?b.parse(a):null};return a}();m.aio.automation.Contidion=function(){var a=function(a){this.type=a.type};a.parse=function(a){if(!a.type)return null;var b=m.aio.automation.Conditionhandler.getHandler(a.type);return b&&b.parse&&"function"==typeof b.parse?b.parse(a):null};return a}();
m.aio.automation.OPERATION={CREATE:"post",READ:"get",UPDATE:"put",DELETE:"delete"};m.aio.automation.Outputhandler={_handlers:{},getHandler:function(a){return a?this._handlers[a]?this._handlers[a].handler:null:null}};m.aio.automation.Conditionhandler={_handlers:{},getHandler:function(a){return a?this._handlers[a]?this._handlers[a].handler:null:null}};m.aio.automation.Inputhandler={_handlers:{},getHandler:function(a){return a?this._handlers[a]?this._handlers[a].handler:null:null}};
m.aio.automation.Actionhandler={execute:function(a,c,b,e,d){if(a)if(b)if(b=b.split("/"),"action"!=b[0])d&&d(Error("path invalid"));else switch(c){case m.aio.automation.OPERATION.CREATE:if(1!=b.length){d&&d(Error("path invalid"));break}this._createAction(a,e,d);break;case m.aio.automation.OPERATION.READ:1==b.length?this._readActions(a,d):this._readAction(a,b[1],d);break;case m.aio.automation.OPERATION.UPDATE:if(2!=b.length){d&&d(Error("path invalid"));break}this._updateAction(a,b[1],e,d);break;case m.aio.automation.OPERATION.DELETE:if(2!=
b.length){d&&d(Error("path invalid"));break}this._deleteAction(a,b[1],d);break;default:d&&d(Error("no such operation"))}else d&&d(Error("path invalid"));else d&&d(Error("task invalid"))},_findAction:function(a,c){for(var b=c.length;b--;)if(c[b]&&c[b]._id==a)return c[b];return null},_createAction:function(a,c,b){var e=m.aio.automation.Action.parse(c);if(e){c=1;for(var d=-1,f=0;f<a._actions.length;f++){if(a._actions[f]._id!=c){d=f;break}c++}e._id=c;d=-1==d?a._actions.length:d;a._actions.splice(d,0,
e);this._saveTasks(function(c){c?a._actions.splice(d,1):e.added(a);b&&b(c,c?null:e.toJSON())})}else b&&b(Error("data invalid"))},_readActions:function(a,c){for(var b=[],e=0;e<a._actions.length;e++){var d=a._actions[e]?a._actions[e].toJSON():null;d&&b.push(d)}c&&c(null,b)},_readAction:function(a,c,b){a=this._findAction(c,a._actions);b&&b(a?null:Error("no such actoin"),a?a.toJSON():null)},_updateAction:function(a,c,b,e){for(var d,f=a._actions.length;f--;)if(a._actions[f]&&a._actions[f]._id==c){d=a._actions[f];
break}if(d){var g=m.aio.automation.Action.parse(b);g?g._id&&g._id==d._id?(a._actions.splice(f,1,g),this._saveTasks(function(b){b?a._actions.splice(f,1,d):(d.deleted(a),g.added(a));e&&e(b,b?null:g.toJSON())})):e&&e(Error("new action id invalid")):e&&e(Error("data invalid"))}else e&&e(Error("no such action"))},_deleteAction:function(a,c,b){for(var e=a._actions.length,d;e--;)if(a._actions[e]&&a._actions[e]._id==c){d=a._actions[e];break}d?(a._actions.splice(e,1),this._saveTasks(function(c){c?a._actions.splice(e,
0,d):d.deleted(a);b&&b(c)})):b&&b(Error("no such action"))},_saveTasks:function(a){m.aio.automation.Manager.saveDatabase(a)},fireAction:function(a,c){if(a&&a._active&&a._output&&a._output.type){var b=m.aio.automation.Outputhandler.getHandler(a._output.type);b&&b.execute&&"function"==typeof b.execute?b.execute(a._output,function(){c&&c()}):c&&c()}else c&&c()}};
m.aio.automation.Triggerhandler={execute:function(a,c,b,e,d){if(a)if(b)if(b=b.split("/"),"trigger"!=b[0])d&&d(Error("path invalid"));else switch(c){case m.aio.automation.OPERATION.CREATE:if(1!=b.length){d&&d(Error("path invalid"));break}this._createTrigger(a,e,d);break;case m.aio.automation.OPERATION.READ:1==b.length?this._readTriggers(a,d):this._readTrigger(a,b[1],d);break;case m.aio.automation.OPERATION.UPDATE:if(2!=b.length){d&&d(Error("path invalid"));break}this._updateTrigger(a,b[1],e,d);break;
case m.aio.automation.OPERATION.DELETE:if(2!=b.length){d&&d(Error("path invalid"));break}this._deleteTrigger(a,b[1],d);break;default:d&&d(Error("no such operation"))}else d&&d(Error("path invalid"));else d&&d(Error("task invalid"))},_findTrigger:function(a,c){for(var b=c.length;b--;)if(c[b]&&c[b]._id==a)return c[b];return null},_createTrigger:function(a,c,b){var e=m.aio.automation.Trigger.parse(c);if(e){c=1;for(var d=-1,f=0;f<a._triggers.length;f++){if(a._triggers[f]._id!=c){d=f;break}c++}e._id=c;
d=-1==d?a._triggers.length:d;a._triggers.splice(d,0,e);this._saveTasks(function(c){c?a._triggers.splice(d,1):e.added(a);b&&b(c,c?null:e.toJSON())})}else b&&b(Error("data invalid"))},_readTriggers:function(a,c){for(var b=[],e=0;e<a._triggers.length;e++){var d=a._triggers[e]?a._triggers[e].toJSON():null;d&&b.push(d)}c&&c(null,b)},_readTrigger:function(a,c,b){a=this._findTrigger(c,a._triggers);b&&b(a?null:Error("no such trigger"),a?a.toJSON():null)},_updateTrigger:function(a,c,b,e){for(var d,f=a._triggers.length;f--;)if(a._triggers[f]&&
a._triggers[f]._id==c){d=a._triggers[f];break}if(d){var g=m.aio.automation.Trigger.parse(b);g?g._id&&g._id==d._id?(a._triggers.splice(f,1,g),this._saveTasks(function(b){b?a._triggers.splice(f,1,d):(d.deleted(a),g.added(a));e&&e(b,b?null:g.toJSON())})):e&&e(Error("new trigger id invalid")):e&&e(Error("data invalid"))}else e&&e(Error("no such trigger"))},_deleteTrigger:function(a,c,b){for(var e=a._triggers.length,d;e--;)if(a._triggers[e]&&a._triggers[e]._id==c){d=a._triggers[e];break}d?(a._triggers.splice(e,
1),this._saveTasks(function(c){c?a._triggers.splice(e,0,d):d.deleted(a);b&&b(c)})):b&&b(Error("no such trigger"))},_saveTasks:function(a){m.aio.automation.Manager.saveDatabase(a)},fireTrigger:function(a,c,b){var e=this._findTrigger(c,a._triggers);e&&e._active&&(e._condition&&e._condition.match&&"function"==typeof e._condition.match?e._condition.match(b,function(b){b&&(m.aio.automation.Logger.log("trace","fire trigger "+c+" in task "+a._id),m.aio.automation.Taskhandler.fireTask(a._id))}):(m.aio.automation.Logger.log("trace",
"fire trigger "+c+" in task "+a._id),m.aio.automation.Taskhandler.fireTask(a._id)))}};
m.aio.automation.Taskhandler={_firedTask:{},execute:function(a,c,b,e,d){if(a)if(b)if(a=b.split("/"),"task"!=a[0])d&&d(Error("path invalid"));else{var f=this;if(2<a.length){if(!a[1]||!a[1].match(/^\d+$/)){d&&d(Error("path invalid"));return}b=this._findTask(a[1],m.aio.automation.Manager._tasks);if(!b){d&&d(Error("no such task"));return}a.splice(0,2);switch(a[0]){case "trigger":m.aio.automation.Triggerhandler.execute(b,c,a.join("/"),e,function(a,b){a?d&&d(a):f._saveTasks(function(a){d&&d(a,b)})});return;
case "action":m.aio.automation.Actionhandler.execute(b,c,a.join("/"),e,function(a,b){a?d&&d(a):f._saveTasks(function(a){d&&d(a,b)})});return;default:d&&d(Error("path invalid"));return}}switch(c){case m.aio.automation.OPERATION.CREATE:if(1!=a.length){d&&d(Error("path invalid"));break}this._createTask(e,d);break;case m.aio.automation.OPERATION.READ:1==a.length?this._readTasks(d):this._readTask(a[1],d);break;case m.aio.automation.OPERATION.UPDATE:if(2!=a.length){d&&d(Error("path invalid"));break}this._updateTask(a[1],
e,d);break;case m.aio.automation.OPERATION.DELETE:if(2!=a.length){d&&d(Error("path invalid"));break}this._deleteTask(a[1],d);break;default:d&&d(Error("no such operation"))}}else d&&d(Error("path invalid"));else d&&d(Error("tasks invalid"))},_findTask:function(a,c){for(var b=c.length;b--;)if(c[b]&&c[b]._id==a)return c[b];return null},_saveTasks:function(a){m.aio.automation.Manager.saveDatabase(a)},_createTask:function(a,c){var b=m.aio.automation.Manager._tasks,e=m.aio.automation.Task.parse(a);if(e)if(e._name){for(var d=
1,f=-1,g,h=0;h<b.length;h++)if(b[h]._id==d?d++:-1==f&&(f=h),b[h]&&b[h]._name==e._name){g=b[h];break}g?c&&c(Error("another task has the same name")):(e._id=d,f=-1==f?b.length:f,b.splice(f,0,e),this._saveTasks(function(a){a?b.splice(f,1):e.added();c&&c(a,a?null:e.toJSON())}))}else c&&c(Error("new task name invalid"));else c&&c(Error("data invalid"))},_readTasks:function(a){for(var c=m.aio.automation.Manager._tasks,b=[],e=0;e<c.length;e++){var d=c[e]?c[e].toJSON():null;d&&b.push(d)}a&&a(null,b)},_readTask:function(a,
c){var b=this._findTask(a,m.aio.automation.Manager._tasks);c&&c(b?null:Error("no such task"),b?b.toJSON():null)},_updateTask:function(a,c,b){var e=m.aio.automation.Manager._tasks,d=this._findTask(a,e);if(d)if(a=m.aio.automation.Task.parse(c))if(a._id&&a._id==d._id){c=e.length;for(var f;c--;)if(e[c]&&e[c]._id!=d._id&&e[c]._name!=a._name){f=e[c];break}if(f)b&&b(Error("another task has the same name"));else{var g=d._name,h=d._active;d._name=a._name;d._active=a._active;this._saveTasks(function(a){a&&
(d._name=g,d._active=h);b&&b(a,a?null:d.toJSON())})}}else b&&b(Error("new task id invalid"));else b&&b(Error("data invalid"));else b&&b(Error("no such task"))},_deleteTask:function(a,c){for(var b=m.aio.automation.Manager._tasks,e=b.length,d;e--;)if(b[e]&&b[e]._id==a){d=b[e];break}d?(m.aio.automation.Manager._tasks.splice(e,1),this._saveTasks(function(a){a?m.aio.automation.Manager._tasks.splice(e,0,d):d.deleted();c&&c(a)})):c&&c(Error("no such task"))},tasks2json:function(a){var c=[];a.forEach(function(a){a&&
c.push(a.toJSON())});return c},json2tasks:function(a){var c=[];a.forEach(function(a){(a=m.aio.automation.Task.parse(a))&&c.push(a)});return c},getInputs:function(a){var c=[];m.aio.automation.Manager._tasks.forEach(function(b){b&&b._triggers&&b._triggers.forEach(function(e){e&&e._input&&e._input.type==a&&c.push({taskId:b._id,triggerId:e._id,input:e._input})})});return c},fireTask:function(a){var c=this._findTask(a,m.aio.automation.Manager._tasks);if(c&&c._active){var b=(new Date).getTime(),e=this._firedTask[c._id];
if(!e||1E3<Math.abs(b-e))this._firedTask[c._id]=b,m.aio.automation.Logger.log("trace","fire task "+a),this._executeNextAction(0,c._actions)}},_executeNextAction:function(a,c){if(c&&0!=c.length&&!(c.length<a+1)){var b=c[a],e=this;b?m.aio.automation.Actionhandler.fireAction(b,function(){a+=1;e._executeNextAction(a,c)}):(a+=1,this._executeNextAction(a,c))}}};
m.aio.automation.Devicehandler={DEVICE:"device_db",DEVICE_INFO:"deviceinfo.xml",_folder:null,_fm:null,_dm:null,init:function(a,c,b){this._fm=a;this._folder=c;this._dm=require("m.aio.devicemanager.js");this._loadDeviceManager(function(){b&&b()})},uploadDevice:function(a,c){var b=this,e=require("fs-extra"),d=this._getDevicePath();e.writeFile(d,JSON.stringify(a),function(a){a?c&&c(a):(b._dm.handlers=[],b._loadDeviceManager(function(a){c&&c(a)}))})},uploadDeviceinfo:function(a,c){var b=this,e=require("fs-extra"),
d=this._getDeviceinfoPath();e.writeFile(d,a,function(a){a?c&&c(a):(b._dm.handlers=[],b._loadDeviceManager(function(a){c&&c(a)}))})},_loadDeviceManager:function(a){var c=this;this._dm._loadTenant({index:1,getFolderPath:function(){var a=require("path");return c._fm.getUserRootDataPath()+a.sep+c._folder}},function(b){a&&a(b)})},_getDevicePath:function(){return this._getFilePath(this.DEVICE)},_getDeviceinfoPath:function(){return this._getFilePath(this.DEVICE_INFO)},_getFilePath:function(a){if(!this._fm)return null;
var c=require("path");return this._fm.getUserRootDataPath()+c.sep+this._folder+c.sep+a},getDevices:function(a,c){this._dm.execute("readWithoutLicense",1,"device",a,c)},getGateway:function(a,c){this._dm?this._dm.execute("readWithoutLicense",1,"gateway",{filter:"prop","info.sys":a},function(a,e){c&&c(a,e)}):c&&c(Error("device manager is null"))}};
m.aio.automation.Manager={FOLDER:"automation",DB:"db",_modules:[],_fm:null,_tasks:[],init:function(a,c){if(a&&a.fileManager){m.aio.automation.Logger=require("x.logger.js").getLogger("m.aio.automation");var b=this;this._fm=a.fileManager;if(a.modules)for(var e=0;e<a.modules.length;e++){var d=a.modules[e];d&&d.dir&&d.handler&&d.handler.init&&"function"==typeof d.handler.init&&(this._modules.push({id:e+1,dir:d.dir,handler:d.handler}),d.handler.init(e+1,this))}(e=this._getDbPath())?require("fs-extra").ensureFile(e,
function(a){a?c&&c(a):m.aio.automation.Devicehandler.init(b._fm,b.FOLDER,function(){b.loadDatabase(function(){b._modules.forEach(function(a){a&&a.handler&&a.handler.initFinish&&"function"==typeof a.handler.initFinish&&a.handler.initFinish()});c&&c()})})}):c&&c(Error("database file invalid"))}else c&&c(Error("argument error"))},saveDatabase:function(a){var c=this._getDbPath();if(c){var b=require("fs"),e=m.aio.automation.Taskhandler.tasks2json(this._tasks);b.writeFile(c,JSON.stringify(e),function(b){a&&
a(b)})}else a&&a(Error("database file invalid"))},loadDatabase:function(a){var c=this._getDbPath();if(c){var b=this;require("fs").readFile(c,{encoding:"utf8"},function(c,d){if(c)a&&a(c);else{if(d)try{var f=JSON.parse(d);Array.isArray(f)&&(f=m.aio.automation.Taskhandler.json2tasks(f))&&(b._tasks=f)}catch(g){}a&&a()}})}else a&&a(Error("database file invalid"))},_getDbPath:function(){if(!this._fm)return null;var a=require("path");return this._fm.getUserRootDataPath()+a.sep+this.FOLDER+a.sep+this.DB},
_getModule:function(a){for(var c=0;c<this._modules.length;c++)if(this._modules[c]&&this._modules[c].id==a)return this._modules[c];return null},registInputHandler:function(a,c,b,e){if(!(a&&c&&b&&e)||m.aio.automation.Inputhandler._handlers[c])return!1;m.aio.automation.Inputhandler._handlers[c]={id:a,handler:b,ui:e};return!0},registConditionHandler:function(a,c,b,e){if(!(a&&c&&b&&e)||m.aio.automation.Conditionhandler._handlers[c])return!1;m.aio.automation.Conditionhandler._handlers[c]={id:a,handler:b,
ui:e};return!0},registOutputHandler:function(a,c,b,e){if(!(a&&c&&b&&e)||m.aio.automation.Outputhandler._handlers[c])return!1;m.aio.automation.Outputhandler._handlers[c]={id:a,handler:b,ui:e};return!0},getInputs:function(a){return m.aio.automation.Taskhandler.getInputs(a)},fireTrigger:function(a,c,b){(a=m.aio.automation.Taskhandler._findTask(a,this._tasks))&&m.aio.automation.Triggerhandler.fireTrigger(a,c,b)}};
m.aio.automation.Handler=function(){var a=function(){};a.prototype.init=function(a,b){a&&a.fileManager?m.aio.automation.Manager.init(a,b):b&&b(Error("invalid params"))};a.prototype.execute=function(a,b,e,d){m.aio.automation.Taskhandler.execute(m.aio.automation.Manager._tasks,a,b,e,d)};a.prototype.getUiJs=function(a,b){if(!b)return null;var e,d,f=require("path");switch(a){case "input":d=m.aio.automation.Inputhandler._handlers[b];break;case "output":d=m.aio.automation.Outputhandler._handlers[b];break;
case "condition":d=m.aio.automation.Conditionhandler._handlers[b]}return d&&d.id&&d.handler&&d.ui?(e=m.aio.automation.Manager._getModule(d.id))&&e.dir?e.dir+f.sep+d.ui:null:null};a.prototype.listUiJs=function(){var a={input:[],condition:[],output:[]},b,e;for(e in m.aio.automation.Inputhandler._handlers)m.aio.automation.Inputhandler._handlers.hasOwnProperty(e)&&(b=m.aio.automation.Inputhandler._handlers[e])&&b.ui&&a.input.push({type:e,js:"/js/automation/input/"+e+"/ui.js"});for(e in m.aio.automation.Conditionhandler._handlers)m.aio.automation.Conditionhandler._handlers.hasOwnProperty(e)&&
(b=m.aio.automation.Conditionhandler._handlers[e])&&b.ui&&a.condition.push({type:e,js:"/js/automation/condition/"+e+"/ui.js"});for(e in m.aio.automation.Outputhandler._handlers)m.aio.automation.Outputhandler._handlers.hasOwnProperty(e)&&(b=m.aio.automation.Outputhandler._handlers[e])&&b.ui&&a.output.push({type:e,js:"/js/automation/output/"+e+"/ui.js"});return a};a.prototype.uploadDevice=function(a,b){m.aio.automation.Devicehandler.uploadDevice(a,b)};a.prototype.uploadDeviceinfo=function(a,b){m.aio.automation.Devicehandler.uploadDeviceinfo(a,
b)};a.prototype.onHttpGetInput=function(a,b,e,d,f){var g=f;if(f=m.aio.automation.Manager.getInputs("http"))for(var h=f.length,k=0;k<f.length;k++)f[k].input&&f[k].input.test(f[k],{path:a,query:b,username:e,password:d},function(a){h--;a&&g&&(g(),g=null);0==h&&g&&g(Error("no matched http input"))})};a.prototype.getDevices=function(a,b){m.aio.automation.Devicehandler.getDevices(a,b)};a.prototype.getGateway=function(a,b){m.aio.automation.Devicehandler.getGateway(a,b)};return a}();
"undefined"!=typeof module&&(module.exports=new m.aio.automation.Handler);
