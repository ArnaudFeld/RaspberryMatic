var x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.netatmo=x.hub.m.netatmo||{};x.hub.m.netatmo.MODULE=require("xnm.aio.netatmo.js");
x.hub.m.netatmo.Monitor=function(){var d=function(a){this._logger=require("x.logger.js").getLogger("x.hub.m.netatmo.Monitor.["+a.refreshToken.substr("6")+"...]");this._running=!1;this._gateway=a;this._devices={};this._status={}};d.prototype.start=function(a){this._logger.log("debug","start monitor");this._running||(this._running=!0,this._getAllStatus());a&&a()};d.prototype.addStateDevice=function(a,b){if(a){switch(a.type){case "NAMain":case "NHC":case "NAPlug":case "room":case "home":var c=a.address;
break;default:c=a.module}c&&(this._devices[c]=a)}b&&b()};d.prototype._getAllStatus=function(){var a=this;this._logger.log("trace","get all status");this._gateway.getAllStatus(function(b,c){b?a._logger.log("trace","get all status error:"+b.message):c&&(a._logger.log("trace","get all status response:"+JSON.stringify(c)),a._receiveStatus(c));a._running&&setTimeout(function(){a._getAllStatus()},1E4)})};d.prototype._receiveStatus=function(a){a=JSON.parse(JSON.stringify(a));for(var b in a){var c=a[b],g=
this._status[b];if(c&&g&&this._devices[b])for(var d in c){var f=c[d],h=g[d];"undefined"!=typeof h&&null!=h&&"undefined"!=typeof f&&null!=f&&h!=f&&this._produceEvent(this._devices[b],d,h,f)}}this._status=a};d.prototype._produceEvent=function(a,b,c,d){try{this._logger.log("debug","state ["+b+"] changed from '"+c+"' to '"+d+"' for device:"+JSON.stringify(a));var g=require("x.hub.eventbus.js");b={key:b,value:d,oldvalue:c,changed:!0};g.emit("status",{module:"netatmo",device:a,gateway:this._gateway.toJSON(),
data:b})}catch(f){}};return d}();
x.hub.m.netatmo.Handler=function(){var d=function(){this._clouds={};this._monitors={}};d.prototype.init=function(a){a&&a()};d.prototype.getSystems=function(){return["netatmo"]};d.prototype.addStateDevice=function(a,b){a&&a.gateway?this._startMonitor(a.gateway,function(c,d){c?b&&b({error:c}):(a=JSON.parse(JSON.stringify(a)),delete a.gateway,d.addStateDevice(a,function(a){b&&b({error:a})}))}):b&&b({error:Error("gateway is null")})};d.prototype.getState=function(a,b,c){if(a&&a.gateway){var d=x.hub.m.netatmo.MODULE.resolveGateway(a.gateway);
if(d){var e=d.refreshToken;this._clouds[e]||(this._clouds[e]=d);d=this._clouds[e];a=JSON.parse(JSON.stringify(a));delete a.gateway;d.getStatesCreator(null,[{id:"xhub",device:a,status:{value:b}}],function(a,b){var d=null;b&&b[0]&&(d=b[0].status);c&&c({error:a,data:{value:d}})})}else c&&c({error:Error("gateway invalid")})}else c&&c({error:Error("gateway is null")})};d.prototype.executeCommand=function(a,b,c){if(a&&a.gateway){var d=x.hub.m.netatmo.MODULE.resolveGateway(a.gateway);if(d){var e=d.refreshToken;
this._clouds[e]||(this._clouds[e]=d);d=this._clouds[e];a=JSON.parse(JSON.stringify(a));delete a.gateway;d.executeCommandCreator(a,b,function(a){c&&c({error:a})})}else c&&c({error:Error("gateway invalid")})}else c&&c({error:Error("gateway is null")})};d.prototype.checkDeviceMatch=function(a,b){return b&&b.device&&a&&a.device&&b.device.type==a.device.type?"NAMain"==b.device.type||"NHC"==b.device.type||"NAPlug"==b.device.type||"room"==b.device.type||"home"==b.device.type?b.device.address==a.device.address:
b.device.module==a.device.module:!1};d.prototype._startMonitor=function(a,b){if(a&&a.refreshToken){var c=x.hub.m.netatmo.MODULE.resolveGateway(a);c?(a=c.refreshToken,this._clouds[a]||(this._clouds[a]=c),c=this._clouds[a],this._monitors[a]?b&&b(null,this._monitors[a]):(c=new x.hub.m.netatmo.Monitor(c),this._monitors[a]=c,c.start(),b&&b(null,c))):b&&b({error:Error("gateway invalid")})}else b&&b(Error("gateway format invalid"))};return d}();
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.netatmo.Handler);
