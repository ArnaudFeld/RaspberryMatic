var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.max=xnm.aio.max||{};xnm.aio.max.Task=function(a,c,b){this.type=a;this.data=c;this.callback=b;this._taskFinishCallback=null};
xnm.aio.max.Task.prototype.run=function(a,c){if(a){this._taskFinishCallback=c;var b=this,d="",e=!1,f=!1,g={};a._connect({_onSocketData:function(c){for(d+=c;0<(c=d.indexOf("\r\n"));){var k=a._evalBlock(g,d.substr(0,c));k&&k.l&&(f=!0);k&&k.s&&(e=!0);d=d.substr(c+2)}"command"==b.type&&e?(b._finish(null,null,1500),a._disconnect()):f&&("command"==b.type?b._executeCommand(a,b.data,g)||(b._finish(Error("execute command invalid")),a._disconnect()):("status"==b.type?(c=b._resolveStatus(b.data,g),b._finish(null,
c)):b._finish(null,g),a._disconnect()))},_onSocketTimeout:function(){b._finish(Error("socket data timeout"));a._disconnect()},_onSocketError:function(a){b._finish(a)},_onSocketClose:function(){}},function(a){a&&b._finish(a)})}else c&&c(Error("cube is null"))};
xnm.aio.max.Task.prototype._executeCommand=function(a,c,b){var d=c.device;c=c.command;if(d&&c&&(b=a._getDeviceByAddress(b,d.address))){switch(c.value){case "temp":d=c.ext;break;default:d=c.value}if(null!=d&&"undefined"!=typeof d)return b=a._buidCommand(b,d),a._sendMessage(b),!0}};
xnm.aio.max.Task.prototype._resolveStatus=function(a,c){var b={},d;for(d in c)if(c.hasOwnProperty(d)&&c[d]&&c[d].devices&&0<c[d].devices.length)for(var e=c[d].devices,f=0;f<e.length;f++)e[f]&&e[f].address&&e[f].state&&(b[e[f].address]=e[f].state);var g;d=[];for(e=0;e<a.length;e++)if(a[e]&&a[e].id&&a[e].device&&a[e].status){var h=a[e].device.address;if(h&&b[h]){switch(a[e].status.value){case "tempC":(g=b[h].current)&&(g=parseFloat(g).toFixed(1));break;case "temp":(g=b[h].val)&&(g=parseFloat(g).toFixed(1));
break;case "state":"switch"==a[e].device.data?(g=b[h].val,g=parseFloat(g),g=15>=g?"off":"on"):g=b[h].val;break;case "mode":g=b[h].mode;break;case "battery":g=b[h].battery,g="OK"==g?"ok":"low"==g?"low_bat":null}f=null;a[e].status.extra&&"battery"==a[e].status.extra&&"low"==b[h].battery&&(f="battery");null!=g&&"undefined"!=typeof g&&(h={id:a[e].id,status:g},f&&(h.info=f),d.push(h))}}return d};
xnm.aio.max.Task.prototype._finish=function(a,c,b){if(this.callback){var d=this.callback;b?setTimeout(function(){d(a,c)},b):d(a,c);this.callback=null}this._taskFinishCallback&&(this._taskFinishCallback(a),this._taskFinishCallback=null)};xnm.aio.max.Cube=function(a,c,b){var d=require("x.logger.js");this._logger=d?d.getLogger("xnm.aio.max.Cube"):{log:function(){}};this.ip=a;this.port=c;this.port||(this.port=62910);this.uuid=b;this._socket=null;this._tasks=[]};xnm.aio.max.Cube.SO_TIMEOUT=1E3;
xnm.aio.max.Cube.prototype.executeCommandCreator=function(a,c,b){a=new xnm.aio.max.Task("command",{device:a,command:c},b);c=0==this._tasks.length;this._tasks.push(a);c&&this._doNextTask()};xnm.aio.max.Cube.prototype.getStatesCreator=function(a,c,b){c?0==c.length?b&&b(null,[]):(a=new xnm.aio.max.Task("status",c,b),c=0==this._tasks.length,this._tasks.push(a),c&&this._doNextTask()):b&&b(Error("deviceList is null"))};
xnm.aio.max.Cube.prototype.getDevices=function(a){a=new xnm.aio.max.Task("devices",null,a);var c=0==this._tasks.length;this._tasks.push(a);c&&this._doNextTask()};xnm.aio.max.Cube.prototype._doNextTask=function(){if(0!=this._tasks.length){var a=this,c=this._tasks[0];c.run(this,function(){a._removeTask(c);a._doNextTask()})}};xnm.aio.max.Cube.prototype._removeTask=function(a){for(var c=-1,b=0;b<this._tasks.length;b++)if(this._tasks[b]===a){c=b;break}-1!=c&&this._tasks.splice(c,1)};
xnm.aio.max.Cube.prototype._getDeviceByAddress=function(a,c){for(var b in a)if(a.hasOwnProperty(b))for(var d=0;d<a[b].devices.length;d++)if(a[b].devices[d].address==c)return a[b].devices[d];return null};
xnm.aio.max.Cube.prototype._evalState=function(a,c,b){if(a=this._getDeviceByAddress(a,c))if(a.state={val:"?"},2<b.length&&b[1]&16&&!(b[1]&8)&&b[1]&2){if(4==a.type&&3==b.length)a.state=b[2]&2?{val:"open"}:{val:"closed"};else if((1==a.type||2==a.type||3==a.type)&&8<=b.length){c="auto";switch(b[2]&3){case 0:c="auto";break;case 1:c="manu";break;case 2:c="vacation";break;case 3:c="boost"}var d=((b[4]&63)/2).toFixed(1);a.state={val:d,mode:c,valve:b[3]};9==b.length&&(delete a.state.valve,a.state.current=
(((b[4]>>7&1)<<8|b[8])/10).toFixed(1))}a.state.battery=b[2]&128?"low":"OK"}};xnm.aio.max.Cube.prototype._evalLData=function(a,c){for(var b=new Buffer(c,"base64"),d=0;d<b.length;){var e=b[d];if(0==e)break;var f=XC.getHexVal(b[d+1],2)+XC.getHexVal(b[d+2],2)+XC.getHexVal(b[d+3],2),g=b.slice(d+4,d+e+1);this._evalState(a,f,g);d+=e+1}return{l:a}};
xnm.aio.max.Cube.prototype._evalMData=function(a,c){var b;b=c.split(",");if(3==b.length){var d=new Buffer(b[2],"base64");if(86==d[0]&&2==d[1]){var e=d[2],f=3;for(b=0;b<e;b++){var g=a[d[f]]={},h=d[f+1];g.name=d.slice(f+2,f+2+h).toString();g.address=XC.getHexVal(d[f+2+h],2)+XC.getHexVal(d[f+3+h],2)+XC.getHexVal(d[f+4+h],2);g.devices=[];f=f+5+h}e=d[f];for(b=0;b<e;b++)g={},g.type=d[f+1],g.address=XC.getHexVal(d[f+2],2)+XC.getHexVal(d[f+3],2)+XC.getHexVal(d[f+4],2),f+=5,g.serial=d.slice(f,f+10).toString(),
h=d[f+10],g.name=d.slice(f+11,f+11+h).toString(),g.room=d[f+11+h],a[d[f+11+h]]||(a[d[f+11+h]]={},a[d[f+11+h]].devices=[]),a[d[f+11+h]].devices.push(g),f=f+11+h}}};xnm.aio.max.Cube.prototype._evalCData=function(a,c){var b=c.split(",");if(2==b.length&&(b=new Buffer(b[1],"base64"),210==b[0])){var d=XC.getHexVal(b[1],2)+XC.getHexVal(b[2],2)+XC.getHexVal(b[3],2);if(d=this._getDeviceByAddress(a,d))d.comfort=(b[18]/2).toFixed(1),d.eco=(b[19]/2).toFixed(1)}};
xnm.aio.max.Cube.prototype._evalBlock=function(a,c){if(2<c.length){if("M:"==c.substr(0,2))return this._evalMData(a,c.substr(2));if("L:"==c.substr(0,2))return this._evalLData(a,c.substr(2));if("C:"==c.substr(0,2))return this._evalCData(a,c.substr(2));if("H:"==c.substr(0,2)){var b=c.split(",");11==b.length&&(this.uuid=b[0])}else if("S:"==c.substr(0,2))return{s:c}}};
xnm.aio.max.Cube.prototype._connect=function(a,c){if(a){this._socket&&(this._socket.end(),this._socket=null);var b=this,d={port:this.port,host:this.ip},e=require("net").connect(d);e.setTimeout(xnm.aio.max.Cube.SO_TIMEOUT);e.setEncoding("utf8");e.on("connect",function(){b._logger.log("trace","connect to max cube:"+b.ip);b._socket=e;c()});e.on("data",function(c){b._logger.log("trace","receive from max cube:"+b.ip+" data:"+c);a._onSocketData(c)});e.on("error",function(d){b._socket?(b._logger.log("trace",
"max cube:"+b.ip+" error:"+d.message),e.destroy(),a._onSocketError(d)):(b._logger.log("trace","max cube:"+b.ip+" connection error:"+d.message),c(d))});e.on("timeout",function(){b._socket?(b._logger.log("trace","max cube:"+b.ip+" data timeout"),a._onSocketTimeout()):(b._logger.log("trace","max cube:"+b.ip+" connection timeout"),e.destroy&&e.destroy(),c(Error("timeout")))});e.on("close",function(){b._logger.log("trace","max cube:"+b.ip+" close socket");a._onSocketClose()});e._doConnect&&"function"==
typeof e._doConnect&&e._doConnect();return e}c&&c(Error("handler is null"))};xnm.aio.max.Cube.prototype._disconnect=function(){this._socket&&(this._socket.end(),this._socket=null)};
xnm.aio.max.Cube.prototype._buidCommand=function(a,c){if(!c||!a||!a.address||null==a.room||"undefined"==typeof a.room)return null;var b=[0,4,64,0,0,0,0,0,0,0,0];b[6]=parseInt(a.address.substr(0,2),16);b[7]=parseInt(a.address.substr(2,2),16);b[8]=parseInt(a.address.substr(4,2),16);b[9]=a.room;"auto"==c?b[10]=0:"manu"==c?b[10]=64:"boost"==c?b[10]=192:"on"==c?b[10]=114:"off"==c?b[10]=94:(b[10]=Math.round(2*parseFloat(c)),9>b[10]&&(b[10]=9),60<b[10]&&(b[10]=60),a.state&&"manu"==a.state.mode&&(b[10]+=
64));return"s:"+(new Buffer(b)).toString("base64")+"\r\n"};xnm.aio.max.Cube.prototype._sendMessage=function(a){this._socket&&(this._logger.log("trace","send to max cube "+this.ip+": "+a),this._socket.write(a,"utf8"))};xnm.aio.max.Cube.prototype.toJSON=function(){return{sys:xnm.aio.max.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid}};xnm.aio.max.Cube.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.max.Cube?this.ip==a.ip&&this.port==a.port:!1};
xnm.aio.max.Discovery=function(){this.Cubes={};this.callback=null;this._sockets=[];var a=require("os");require("dgram");if(a&&a.networkInterfaces){var a=a.networkInterfaces(),c;for(c in a)if(a.hasOwnProperty(c))for(var b=a[c],d=0;d<b.length;d++)this._addDiscoverSocket(23272,b[d])}else this._addDiscoverSocket(23272,null)};
xnm.aio.max.Discovery.prototype._receivedData=function(a,c){c=c.toString("hex");c=new Buffer(c,"hex");if(26==c.length){var b=new xnm.aio.max.Cube(a);b.uuid=(new Buffer(c.slice(8,18))).toString();this.Cubes[b.uuid]=b;this.callback&&this.callback(this.Cubes[b.uuid])}};
xnm.aio.max.Discovery.prototype._addDiscoverSocket=function(a,c){var b=this,d=require("dgram"),e;try{e=d.createSocket({reuseAddr:!0,type:"udp4"})}catch(f){e=d.createSocket("udp4")}e.on("listening",function(){e.setBroadcast(!0)});e.on("message",function(a,c){b._receivedData(c.address,a)});c?"IPv4"==c.family&&0==c.internal&&(e.bind(a,c.address),this._sockets.push(e)):(e.bind(a),this._sockets.push(e))};
xnm.aio.max.Discovery.prototype._sendDiscoveryMessages=function(){for(var a=new Buffer([101,81,51,77,97,120,42,0,42,42,42,42,42,42,42,42,42,42,73]),c=0;c<this._sockets.length;c++)this._sockets[c].send(a,0,a.length,23272,"255.255.255.255")};xnm.aio.max.Discovery.prototype.discoverCubes=function(a){a&&(this.Cubes={});this._sendDiscoveryMessages()};xnm.aio.max.DMError=function(a,c){this.code=a;this.message=c;this.stack=Error().stack};xnm.aio.max.DMError.prototype=Error();
xnm.aio.max.DMError.prototype.name="MaxDMError";xnm.aio.max.DMError.prototype.code=0;xnm.aio.max.DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};
xnm.aio.max.DM={SYS:"max",MAP:{"switch":{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"enum",name:"battery",ref:{value:"battery",options:["ok","low_bat"]}}]},thermo:{command:[{type:"enum",name:"auto",ref:{value:"auto"}},{type:"enum",name:"manu",ref:{value:"manu"}},{type:"enum",name:"boost",ref:{value:"boost"}},{type:"float",name:"temperature",ref:{value:"temp",ext:"%f",
extMeta:"4.5-30",scale:"0.5"}}],status:[{type:"enum",name:"mode",ref:{value:"mode",options:["auto","manu","boost","vacation"]}},{type:"enum",name:"battery",ref:{value:"battery",options:["ok","low_bat"]}},{type:"float",name:"temperature",ref:{value:"temp",extMeta:"4.5-30",scale:"0.5"}}]},wallthermo:{command:[{type:"enum",name:"auto",ref:{value:"auto"}},{type:"enum",name:"manu",ref:{value:"manu"}},{type:"enum",name:"boost",ref:{value:"boost"}},{type:"float",name:"temperature",ref:{value:"temp",ext:"%f",
extMeta:"4.5-30",scale:"0.5"}}],status:[{type:"enum",name:"mode",ref:{value:"mode",options:["auto","manu","boost","vacation"]}},{type:"enum",name:"battery",ref:{value:"battery",options:["ok","low_bat"]}},{type:"float",name:"temperature",ref:{value:"temp",extMeta:"4.5-30",scale:"0.5"}},{type:"float",name:"current temperature",ref:{value:"tempC",extMeta:"4.5-30",scale:"0.5"}}]},contact:{status:[{type:"enum",name:"state",ref:{value:"state",options:["open","closed"]}},{type:"enum",name:"battery",ref:{value:"battery",
options:["ok","low_bat"]}}]}},getGatewayType:function(){return[{sys:this.SYS,name:"MAX! Cube",port:62910}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:1,name:"Switch"},{sys:this.SYS,type:1,name:"Thermostat"},{sys:this.SYS,type:2,name:"Thermostat Plus"},{sys:this.SYS,type:3,name:"Wall Thermostat"},{sys:this.SYS,type:4,name:"Shutter contact"},{sys:this.SYS,type:5,name:"Push Button"}]},createGateway:function(a,c,b){c=xnm.aio.max.DMError;var d=xnm.aio.max.DMError.ERROR_CODE;a?a.ip?b(null,
a):b(new c(d.INVALID,"ip is invalid")):b(new c(d.INVALID,"info is invalid"))},updateGateway:function(a,c,b,d){a=xnm.aio.max.DMError;b=xnm.aio.max.DMError.ERROR_CODE;c?c.ip?d(null,c):d(new a(b.INVALID,"ip is invalid")):d(new a(b.INVALID,"update is invalid"))},deleteGateway:function(a,c,b){b()},createDevice:function(a,c,b){var d=xnm.aio.max.DMError,e=xnm.aio.max.DMError.ERROR_CODE;if(a)if(a.gateway)if(null==a.address||"undefined"==typeof a.address)b(new d(e.INVALID,"address is invalid"));else if(null==
a.type||"undefined"==typeof a.type)b(new d(e.INVALID,"type is invalid"));else if(null==a.room||"undefined"==typeof a.room)b(new d(e.INVALID,"room is invalid"));else if(c.data&&c.data.gateways&&0!==c.data.gateways.length){c=c.data.gateways;var f,g;for(f=0;f<c.length;f++)if(c[f].index===a.gateway){g=c[f];break}g?b(null,a):b(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else b(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else b(new d(e.INVALID,"gateway is invalid"));
else b(new d(e.INVALID,"info is invalid"))},updateDevice:function(a,c,b){var d=xnm.aio.max.DMError,e=xnm.aio.max.DMError.ERROR_CODE;if(a)if(a.gateway)if(null==a.address||"undefined"==typeof a.address)b(new d(e.INVALID,"address is invalid"));else if(null==a.type||"undefined"==typeof a.type)b(new d(e.INVALID,"type is invalid"));else if(null==a.room||"undefined"==typeof a.room)b(new d(e.INVALID,"room is invalid"));else if(c.data&&c.data.gateways&&0!==c.data.gateways.length){c=c.data.gateways;var f,g;
for(f=0;f<c.length;f++)if(c[f].index===a.gateway){g=c[f];break}g?b(null,a):b(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else b(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else b(new d(e.INVALID,"gateway is invalid"));else b(new d(e.INVALID,"info is invalid"))},deleteDevice:function(a,c,b){b()},applyUIFilter:function(a,c){var b=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},d=function(a,c,d){var e=[];switch(d.catagory){case "command":a.command&&
a.command.forEach(function(a){b(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){b(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},e=function(a,b){var c=[],e=null,e=null,e=a.type;"string"==typeof e&&(e=parseInt(e));switch(e){case 1:e=a.data&&"switch"==a.data?xnm.aio.max.DM.MAP["switch"]:xnm.aio.max.DM.MAP.thermo;break;case 2:e=xnm.aio.max.DM.MAP.thermo;break;case 3:e=xnm.aio.max.DM.MAP.wallthermo;break;
case 4:e=xnm.aio.max.DM.MAP.contact;break;default:return null}if(!e)return null;e=JSON.parse(JSON.stringify(e));if(e.status)for(var f=0;f<e.status.length;f++)"battery"!=e.status[f].ref.value&&(e.status[f].ref.extra="battery");e&&(e=d(e,a,b),c=c.concat(e));return c};if(!a||null==a.type||"undefined"==typeof a.type)return null;var f=JSON.parse(JSON.stringify(a)),g=null;switch(c.catagory){case "command":g=e(a,c);f.command=g;break;case "status":g=e(a,c);f.status=g;break;default:return null}return g&&0!=
g.length?f:null}};xnm.aio.max.Handler=function(){this._Discovery=null};xnm.aio.max.Handler.prototype.Cube=xnm.aio.max.Cube;xnm.aio.max.Handler.prototype.discoverCubes=function(a){this._disConCbs||(this._disConCbs=[]);this._Discovery||this._createDiscovery();a&&-1==this._getIndex(a,this._disConCbs)&&this._disConCbs.push(a);this._Discovery.discoverCubes()};xnm.aio.max.Handler.prototype.getDetectedCubes=function(){this._Discovery||this._createDiscovery();return this._Discovery.Cubes};
xnm.aio.max.Handler.prototype.discoverCubeWithTimeout=function(a,c){if(c&&a){this._disTimeCbs||(this._disTimeCbs=[]);this._Discovery||this._createDiscovery();var b=this,d=this._disTimeCbs.length;c&&-1==this._getIndex(c,this._disTimeCbs)&&this._disTimeCbs.push(c);setTimeout(function(){var a=b._getIndex(c,b._disTimeCbs);-1!=a&&-2!=a&&b._disTimeCbs.splice(a,1);var a=b.getDetectedCubes(),d=[],g;for(g in a)a.hasOwnProperty(g)&&a[g]&&d.push(a[g]);c(null,d)},1E3*a);this._Discovery.discoverCubes(d?!0:!1)}};
xnm.aio.max.Handler.prototype._discoverCb=function(a){if(this._disConCbs)for(var c=0;c<this._disConCbs.length;c++)if(this._disConCbs[c])this._disConCbs[c](a)};xnm.aio.max.Handler.prototype._createDiscovery=function(){if(!this._Discovery){this._Discovery=new xnm.aio.max.Discovery;var a=this;this._Discovery.callback=function(c){a._discoverCb(c)}}};xnm.aio.max.Handler.prototype._getIndex=function(a,c){if(!a||!c)return-2;for(var b=0;b<c.length;b++)if(a===c[b])return b;return-1};
xnm.aio.max.Handler.prototype.devicemanager=xnm.aio.max.DM;xnm.aio.max.Handler.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"max")};xnm.aio.max.Handler.prototype.resolveGateway=function(a){return a&&a.ip?new xnm.aio.max.Cube(a.ip,a.port,a.uuid):null};xnm.aio.max.Handler.prototype.getDeviceCommands=function(a,c){var b=xnm.aio.max.DM.applyUIFilter(a,{catagory:"command",elems:"*"}),b=b?b.command:[];c&&c(null,b)};
xnm.aio.max.Handler.prototype.getDeviceStatus=function(a,c){var b=xnm.aio.max.DM.applyUIFilter(a,{catagory:"status",elems:"*"}),b=b?b.status:[];c&&c(null,b)};xnm.aio.max.Handler.prototype.doCommand=function(a,c,b,d){(a=this.resolveGateway(a))?a.executeCommandCreator(c,b,function(a){d&&d(a)}):d&&d(Error("gateway json format invalid"))};
xnm.aio.max.Handler.prototype.doStatus=function(a,c,b,d,e){(c=this.resolveGateway(c))?c.getStatesCreator(null,[{id:a,device:b,status:d}],function(a,b){a?e&&e(a):e&&e(null,b[0])}):e&&e(Error("gateway json format invalid"))};
xnm.aio.max.Handler.prototype.getDeviceList=function(a,c){var b=this.resolveGateway(a);b?b.getDevices(function(a,b){if(a)c&&c(a);else{var f=[];if(b)for(var g in b)if(b.hasOwnProperty(g)&&b[g]){if(b[g].devices){var h=[];b[g].devices.forEach(function(a){if(a){a.sys=xnm.aio.max.DM.SYS;var b=a.type;null!=b&&"undefiend"!=typeof b&&(b=parseInt(b));switch(b){case 1:a.data="thermo";break;case 2:a.data="thermoplus";break;case 3:a.data="wallthermo";break;case 4:a.data="contact";break;case 5:a.data="button";
break;default:return}h.push(a)}});b[g].devices=h}f.push(b[g])}c&&c(null,f)}}):c&&c(Error("gateway json format invalid"))};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.max.Handler);
