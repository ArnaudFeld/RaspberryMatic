var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.pioneer=xnm.aio.pioneer||{};
xnm.aio.pioneer.AVReceiver=function(){var l=[1,2,3,4,5],d=function(a,b,c,e){this._taskBuffer=a;this._avr=b;this._datapoints=c;this._callback=e};d.prototype.run=function(){this._avr._logger.log("debug","run status task: "+JSON.stringify(this._datapoints));var a=this,b={},c=0,e=function(f,d){if(f&&4!=f.errorCode&&5!=f.errorCode)1==f.errorCode||2==f.errorCode||3==f.errorCode?a._taskBuffer._finishAllTask(f):a._taskBuffer._finishLastTask(f);else{var g=a._datapoints[c],h=null,k=g.indexOf(":");0<k&&(h=g.substr(0,
k),g=g.substr(k+1));k="?";d&&(h||null==d[g]||"undefined"==typeof d[g]?h&&d[h]&&null!=d[h][g]&&"undefined"!=typeof d[h][g]&&(k=d[h][g]):k=d[g]);b[a._datapoints[c]]=k;c+=1;c<a._datapoints.length?(g=a._avr._getStateQuest(a._datapoints[c]),a._avr._doStateReq(g,e)):a._taskBuffer._finishLastTask(null,b)}},f=this._avr._getStateQuest(this._datapoints[c]);this._avr._doStateReq(f,e)};d.prototype.merge=function(a){if(a&&a._datapoints)if(this._datapoints){a=this._datapoints.concat(a._datapoints);for(var b=0;b<
a.length;++b)for(var c=b+1;c<a.length;++c)a[b]===a[c]&&a.splice(c,1);this._datapoints=a}else this._datapoints=a._datapoints};var k=function(a,b,c,e){this._taskBuffer=a;this._avr=b;this._commandTxt=c;this._callback=e};k.prototype.run=function(){this._avr._logger.log("debug","run command task: "+this._commandTxt);var a=this,b=this._avr._getCommandQuest(this._commandTxt);this._avr._doCommandReq(b,function(b){!b||1!=b.errorCode&&2!=b.errorCode&&3!=b.errorCode?a._taskBuffer._finishLastTask(b):a._taskBuffer._finishAllTask(b)})};
var g=function(a){this._avr=a;this._buffer=[]};g.prototype.executeTask=function(a){if(0==this._buffer.length)this._buffer.push(a),this._doNextTask();else{if(!(a instanceof k)&&a instanceof d){var b=[];if(1<this._buffer.length){for(var c=1;c<this._buffer.length;c++)this._buffer[c]&&this._buffer[c]instanceof d&&(b.push(c),a.merge(this._buffer[c]));for(c=0;c<b.length;c++)this._buffer.splice(b[c],1)}}this._buffer.push(a)}};g.prototype._doNextTask=function(){0!=this._buffer.length&&this._buffer[0].run()};
g.prototype._finishLastTask=function(a,b){if(0<this._buffer.length){var c=this._buffer[0];c&&c._callback&&(c._callback(a,b),c._callback=null);this._buffer.splice(0,1)}this._doNextTask()};g.prototype._finishAllTask=function(a){var b=this._buffer;this._buffer=[];for(var c=0;c<b.length;c++)b[c]&&b[c]._callback&&(b[c]._callback(a),b[c]._callback=null)};var f=function(a){this._avr=a;this._buffer=[];this._bufferEmptyTo=null};f.prototype.RESPONSE_TO=500;f.prototype.sendPacket=function(a,b,c){if(a){var e=
this._buffer.length;this._buffer.push({packet:a,ignoreRsp:b,callback:c});this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null);0==e&&this._sendNextPacket()}else c&&c(Error("ISCP message is null"))};f.prototype._sendNextPacket=function(){if(0!=this._buffer.length){var a=this,b=this._buffer[0];this._avr._sendPacket(b.packet,function(c){c?(c.errorCode=l[0],a._finishAllPacket(c)):b.ignoreRsp?a._finishLastPacket():b.timeout=setTimeout(function(){a._avr._logger.log("warn","packet response timeout");
var b=Error("packet reponse timeout");b.errorCode=l[3];a._finishLastPacket(b)},a.RESPONSE_TO)})}};f.prototype._finishLastPacket=function(a,b){0<this._buffer.length&&(this._buffer[0]&&(this._buffer[0].timeout&&(clearTimeout(this._buffer[0].timeout),this._buffer[0].timeout=null),this._buffer[0].callback&&(this._buffer[0].callback(a,b),this._buffer[0].callback=null)),this._buffer.splice(0,1));if(0==this._buffer.length){var c=this;this._bufferEmptyTo=setTimeout(function(){c._bufferEmptyTo=null;0==c._buffer.length&&
c._avr._disconnect()},500)}else this._sendNextPacket()};f.prototype._finishAllPacket=function(a){var b=this._buffer;this._buffer=[];this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null);for(var c=0;c<b.length;c++)b[c]&&(b[c].timeout&&(clearTimeout(b[c].timeout),b[c].timeout=null),b[c].callback&&(b[c].callback(a),b[c].callback=null))};f.prototype._onSocketData=function(a){a=new Buffer(a);a=a.toString("hex");a=new Buffer(a,"hex");var b=a.toString();if(0<this._buffer.length&&
this._buffer[0]&&this._buffer[0].packet)if("?"==this._buffer[0].packet.substr(0,1)){a=b.split("\r");-1!=b.indexOf("\n")&&(a=b.split("\n"));for(var b=this._avr._getRspPrefix(this._buffer[0].packet),c=!1,e="",f=0;f<a.length;f++)if(b&&a[f]&&0==a[f].indexOf(b)){this._finishLastPacket(null,a[f].trim());break}else 0==a[f].indexOf("E")&&(c=!0,e=a[f]);c&&(a=Error("pioneer response error code:"+e),a.errorCode=l[4],this._finishLastPacket(a))}else this._finishLastPacket(null,b)};f.prototype._onSocketTimeout=
function(){};f.prototype._onSocketError=function(a){a.errorCode=l[1];this._finishAllPacket(a)};f.prototype._onSocketClose=function(a){a=Error("socket closed");a.errorCode=l[2];this._finishAllPacket(a)};var h=function(a,b,c,e,d){this._ip=a;this._port=b;this._port||(this._port=23);this._uuid=c;this._name=e;this._model=d;this._logger=require("x.logger.js").getLogger("xnm.aio.pioneer.AVReceiver");this._socket=null;this._taskBuffer=new g(this);this._packetBuffer=new f(this)};h.prototype.executeCommandCreator=
function(a,b,c){if(b&&b.value)if("openNative"==b.value)window&&window.XC&&window.XC.callHost&&window.XCHost.getType&&("iOS"==window.XCHost.getType()?window.XC.callHost("SYSTEM","startApp",{scheme:"icontrolav5://"}):"Android"==window.XCHost.getType()&&window.XC.callHost("SYSTEM","startApp",{scheme:"jp.pioneer.avsoft.android.icontrolav2014"})),c&&c();else{a="";b.path&&b.path[0]&&"global"!=b.path[0]&&(a=b.path[0]+":");var e=a+b.value;if("setTo"==b.value||"tuner"==b.value){if(null==b.ext||"undefined"==
typeof b.ext){c&&c(Error("command setTo ext format invalid"));return}e+=b.ext}else if("audioMode"==b.value){if(!b.ext){c&&c(Error("command audioMode ext format invalid"));return}e=a+b.ext}else if("setInput"==b.value){if(!b.ext){c&&c(Error("command setInput ext format invalid"));return}e=a+b.ext}else if("setTone"==b.value){if(!b.ext){c&&c(Error("command setTone ext format invalid"));return}e+=b.ext}else if("bassTo"==b.value||"trebleTo"==b.value){if(null==b.ext||"undefined"==typeof b.ext){c&&c(Error("command ext format invalid"));
return}e+=b.ext}else if("customCMD"==b.value){if(!b.ext){c&&c(Error("command customCMD ext format invalid"));return}e=a+b.ext}this._executeCommand(e,function(a){a?c&&c(a):b.path&&b.path[0]&&"mainzone"==b.path[0]&&("on"==b.value||"off"==b.value||"toggle"==b.value)?setTimeout(function(){c&&c()},5E3):c&&c()})}else c&&c(Error("command json format invalid"))};h.prototype.getStatesCreator=function(a,b,c){a=function(a,b){for(var c=0;c<b.length;c++)if(b[c]===a)return!0;return!1};for(var e=[],f=[],d=0;d<b.length;d++)if(b[d]&&
b[d].id&&b[d].status&&b[d].status.value){var g="";b[d].status.path&&b[d].status.path[0]&&"global"!=b[d].status.path[0]&&(g=b[d].status.path[0]+":");var h=b[d].status.value;e.push({id:b[d].id,datapoint:g+h});a(g+h,f)||f.push(g+h)}this._getStates(f,function(a,b){if(a)c&&c(a);else{for(var f=[],d=0;d<e.length;d++){var g="?",h=e[d].id,k=e[d].datapoint;b&&null!=b[k]&&"undefined"!=typeof b[k]&&(g=b[k]);f.push({id:h,status:g})}c&&c(null,f)}})};h.prototype.executeCommand=function(a,b){this._executeCommand(a,
b)};h.prototype.getStates=function(a){var b=Object.keys(h.STATUS_DPT_QUEST);this._getStates(b,function(b,e){a&&a(b,e)})};h.prototype._executeCommand=function(a,b){this._logger.log("debug","execute command: "+a);var c=new k(this._taskBuffer,this,a,b);this._taskBuffer.executeTask(c)};h.prototype._getStates=function(a,b){this._logger.log("debug","get states: "+JSON.stringify(a));var c=new d(this._taskBuffer,this,a,b);this._taskBuffer.executeTask(c)};h.prototype._getCommandQuest=function(a){console.log("pionner",
a);var b=a,c=null,e=a.indexOf(":");0<e&&(c=a.substr(0,e),a=a.substr(e+1));if("on"==a)b="zoneHD"==c?"ZEO":"zone3"==c?"BPO":"zone2"==c?"APO":"PO";else if("off"==a)b="zoneHD"==c?"ZEF":"zone3"==c?"BPF":"zone2"==c?"APF":"PF";else if("toggle"==a)b="zoneHD"==c?"ZEZ":"zone3"==c?"BPZ":"zone2"==c?"APZ":"PZ";else if("mute"==a)b="zoneHD"==c?"HZMO":"zone3"==c?"Z3MO":"zone2"==c?"Z2MO":"MO";else if("unmute"==a)b="zoneHD"==c?"HZMF":"zone3"==c?"Z3MF":"zone2"==c?"Z2MF":"MF";else if("toggleMute"==a)b="zoneHD"==c?"HZMZ":
"zone3"==c?"Z3MZ":"zone2"==c?"Z2MZ":"MZ";else if("volumeUp"==a)b="zoneHD"==c?"HZU":"zone3"==c?"YU":"zone2"==c?"ZU":"VU";else if("volumeDown"==a)b="zoneHD"==c?"HZD":"zone3"==c?"YD":"zone2"==c?"ZD":"VD";else if("BD"==a||"DVD"==a||"SAT/CBL"==a||"DVR/BDR"==a||"HDMI1"==a||"HDMI2"==a||"HDMI3"==a||"HDMI4"==a||"HDMI5"==a||"HDMI6"==a||"HDMI7"==a||"NETRADIO"==a||"Spotify"==a||"MEDIASERVER"==a||"FAVORITES"==a||"iPod/USB"==a||"TV"==a||"TUNER"==a||"BTAUDIO"==a||"CD"==a){switch(a){case "BD":b="25";break;case "DVD":b=
"04";break;case "SAT/CBL":b="06";break;case "DVR/BDR":b="15";break;case "HDMI1":b="19";break;case "HDMI2":b="20";break;case "HDMI3":b="21";break;case "HDMI4":b="22";break;case "HDMI5":b="23";break;case "HDMI6":b="24";break;case "HDMI7":b="34";break;case "NETRADIO":b="38";break;case "Spotify":b="53";break;case "MEDIASERVER":b="44";break;case "FAVORITES":b="45";break;case "iPod/USB":b="17";break;case "TV":b="05";break;case "TUNER":b="02";break;case "BTAUDIO":b="33";break;case "CD":b="01"}b="zoneHD"==
c?b+"ZEA":"zone3"==c?b+"ZT":"zone2"==c?b+"ZS":b+"FN"}else if("AUTO"==a||"MOVIE"==a||"MUSIC"==a||"GAME"==a||"ALC"==a||"DIRECT"==a||"PURE_DIRECT"==a||"F.S.SURR_FOCUS"==a||"DRAMA"==a||"ACTION"==a||"CLASSICAL"==a||"ROCK/POP"==a||"EXT_STEREO"==a||"ADV_GAME"==a||"SPORT"==a)"AUTO"==a?b="0006SR":"MOVIE"==a?b="0101SR":"MUSIC"==a?b="0041SR":"GAME"==a?b="0118SR":"ALC"==a?b="0151SR":"DIRECT"==a?b="0007SR":"PURE_DIRECT"==a?b="0008SR":"F.S.SURR_FOCUS"==a?b="0003SR":"DRAMA"==a?b="0103SR":"ACTION"==a?b="0101SR":
"CLASSICAL"==a?b="0107SR":"ROCK/POP"==a?b="0110SR":"EXT_STEREO"==a?b="0041SR":"ADV_GAME"==a?b="0118SR":"SPORT"==a&&(b="0117SR");else if("play"==a)switch(c){case "net":b="10NW"}else if("pause"==a)switch(c){case "net":b="11NW"}else if("stop"==a)switch(c){case "net":b="20NW"}else if("previous"==a)switch(c){case "net":b="12NW"}else if("next"==a)switch(c){case "net":b="13NW"}else if("enter"==a)switch(c){case "net":b="30NW"}else if("return"==a)switch(c){case "net":b="31NW"}else if("up"==a)switch(c){case "net":b=
"26NW"}else if("down"==a)switch(c){case "net":b="27NW"}else if("right"==a)switch(c){case "net":b="28NW"}else if("left"==a)switch(c){case "net":b="29NW"}else if(0==a.indexOf("setTone"))switch(a=a.replace(/setTone/g,""),c){case "mainzone":"ON"==a?b="1TO":"BYPASS"==a&&(b="0TO")}else if(0==a.indexOf("tuner"))a=a.replace(/tuner/g,""),b="Up"==a?"TPI":"Down"==a?"TPD":2==a.length?a.charAt(0)+"0"+a.charAt(1)+"PR":3==a.length?a+"PR":a.charAt(0)+"TP";else if(0==a.indexOf("bass"))if(a=a.replace(/bass/g,""),"Up"==
a)switch(c){case "mainzone":b="BI"}else if("Down"==a)switch(c){case "mainzone":b="BD"}else{a=a.replace(/To/g,"");a=a.replace(/%/g,"");a=parseInt(a);-6>a?a=-6:6<a&&(a=6);for(a=(6-a).toString();2>a.length;)a="0"+a;b=a+"BA"}else if(0==a.indexOf("treble"))if(a=a.replace(/treble/g,""),"Up"==a)switch(c){case "mainzone":b="TI"}else if("Down"==a)switch(c){case "mainzone":b="TD"}else{a=a.replace(/To/g,"");a=a.replace(/%/g,"");a=parseInt(a);-6>a?a=-6:6<a&&(a=6);a=6-a;for(a=a.toString();2>a.length;)a="0"+a;
b=a+"TR"}else if(0==a.indexOf("setTo")||/^\d+$/.test(a))if(0==a.indexOf("setTo")&&(a=a.replace(/setTo/g,"")),a=a.replace(/%/g,""),"zone2"==c||"zone3"==c||"zoneHD"==c){b="ZV";"zone3"==c?b="YV":"zoneHD"==c&&(b="HZV");a=parseInt(a);-81>a?a=-81:0<a&&(a=0);a+=81;for(a=a.toString();2>a.length;)a="0"+a;b=a+b}else{a=parseFloat(a);-80.5>a?a=-80.5:12<a&&(a=12);a=(a+80.5)/.5;for(a=a.toString();3>a.length;)a="0"+a;b=a+"VL"}console.log("cmd",b);return b};h.STATUS_DPT_QUEST={audioMode:"?S","mainzone:power":"?P",
"mainzone:volume":"?V","mainzone:mute":"?M","mainzone:input":"?F","mainzone:tone":"?TO","mainzone:bass":"?BA","mainzone:treble":"?TR","zone2:power":"?AP","zone2:volume":"?ZV","zone2:mute":"?Z2M","zone2:input":"?ZS","zone3:power":"?BP","zone3:volume":"?YV","zone3:mute":"?Z3M","zone3:input":"?ZT","zoneHD:power":"?ZEP","zoneHD:volume":"?HZV","zoneHD:mute":"?HZM","zoneHD:input":"?ZEA"};h.prototype._getStateQuest=function(a){return a?h.STATUS_DPT_QUEST[a]:null};h.STATUS_RSP_PREFIX={"?S":"SR","?V":"VOL",
"?P":"PWR","?M":"MUT","?F":"FN","?TO":"TO","?BA":"BA","?TR":"TR","?AP":"APR","?ZV":"ZV","?ZS":"Z2F","?Z2M":"Z2MUT","?BP":"BPR","?YV":"YV","?ZT":"Z3F","?Z3M":"Z3MUT","?ZEP":"ZEP","?HZV":"XV","?HZM":"HZMUT","?ZEA":"ZEA"};h.prototype._getRspPrefix=function(a){return a?h.STATUS_RSP_PREFIX[a]:null};h.prototype._buildData=function(a){for(var b=[],c=0;c<a.length;c++)b.push(a.charCodeAt(c));b.push(13);return new Buffer(b)};h.prototype._resolveStatus=function(a){var b=function(a){if("string"==typeof a&&a)for(;"0"==
a.charAt(0)&&1<a.length;)a=a.substr(1);return parseInt(a)},c={mainzone:{},zone2:{},zone3:{},zoneHD:{}},e;if(0==a.indexOf("VOL"))c.mainzone.volume=.5*b(a.substr(3,3))-80.5;else if(0==a.indexOf("BA"))c.mainzone.bass=6-b(a.substr(2,2));else if(0==a.indexOf("TR"))c.mainzone.treble=6-b(a.substr(2,2));else if(0==a.indexOf("ZV")||0==a.indexOf("YV")||0==a.indexOf("XV"))e=c.zone2,0==a.indexOf("YV")?e=c.zone3:0==a.indexOf("XV")&&(e=c.zoneHD),e.volume=b(a.substr(2,2))-81;else if(0==a.indexOf("PWR")||0==a.indexOf("APR")||
0==a.indexOf("BPR")||0==a.indexOf("ZEP"))e=c.mainzone,0==a.indexOf("APR")?e=c.zone2:0==a.indexOf("BPR")?e=c.zone3:0==a.indexOf("ZEP")&&(e=c.zoneHD),"0"==a.substr(3,1)?e.power="on":e.power="off";else if(0==a.indexOf("MUT")||0==a.indexOf("Z2MUT")||0==a.indexOf("Z3MUT")||0==a.indexOf("HZMUT"))e=c.mainzone,b=a.substr(3,1),0==a.indexOf("Z2MUT")?(e=c.zone2,b=a.substr(5,1)):0==a.indexOf("Z3MUT")?(e=c.zone3,b=a.substr(5,1)):0==a.indexOf("HZMUT")&&(e=c.zoneHD,b=a.substr(5,1)),e.mute="0"==b?"on":"off";else if(0==
a.indexOf("SR"))switch(a=a.trim(),a.substr(2)){case "0006":c.audioMode="AUTO";break;case "0101":c.audioMode="MOVIE";break;case "0041":c.audioMode="MUSIC";break;case "0118":c.audioMode="GAME";break;case "0151":c.audioMode="ALC";break;case "0007":c.audioMode="DIRECT";break;case "0008":c.audioMode="PURE_DIRECT";break;case "0003":c.audioMode="F.S.SURR_FOCUS";break;case "0103":c.audioMode="DRAMA";break;case "0107":c.audioMode="CLASSICAL";break;case "0110":c.audioMode="ROCK/POP";break;case "0117":c.audioMode=
"SPORT"}else if(0==a.indexOf("FN")||0==a.indexOf("Z2F")||0==a.indexOf("Z3F")||0==a.indexOf("ZEA"))switch(e=c.mainzone,b=a.substr(2),0==a.indexOf("Z2F")?(e=c.zone2,b=a.substr(3)):0==a.indexOf("Z3F")?(e=c.zone3,b=a.substr(3)):0==a.indexOf("ZEA")&&(e=c.zoneHD,b=a.substr(3)),b){case "25":e.input="BD";break;case "04":e.input="DVD";break;case "06":e.input="SAT/CBL";break;case "15":e.input="DVR/BDR";break;case "19":e.input="HDMI1";break;case "20":e.input="HDMI2";break;case "21":e.input="HDMI3";break;case "22":e.input=
"HDMI4";break;case "23":e.input="HDMI5";break;case "24":e.input="HDMI6";break;case "34":e.input="HDMI7";break;case "38":e.input="NETRADIO";break;case "53":e.input="Spotify";break;case "44":e.input="MEDIASERVER";break;case "45":e.input="FAVORITES";break;case "17":e.input="iPod/USB";break;case "05":e.input="TV";break;case "01":e.input="CD";break;case "02":e.input="TUNER";break;case "33":e.input="BTAUDIO"}else 0==a.indexOf("TO")&&(e=c.mainzone,"0"==a.substr(2,1)?e.tone="BYPASS":"1"==a.substr(2,1)&&(e.tone=
"ON"));return c};h.prototype._doCommandReq=function(a,b){this._packetBuffer.sendPacket(a,!0,b)};h.prototype._doStateReq=function(a,b){var c=this;this._packetBuffer.sendPacket(a,!1,function(a,f){if(a)b(a);else{var d=c._resolveStatus(f);b(null,d)}})};h.prototype._sendPacket=function(a,b){if(this._socket){this._logger.log("trace","send packet:"+a);var c=this._buildData(a);this._socket.write(c,"binary");b()}else{var e=this;this._connect(function(c){c?b(c):e._sendPacket(a,b)})}};h.prototype._connect=function(a){this._socket&&
(this._socket.end(),this._socket=null);var b=this,c={port:this._port,host:this._ip},e=require("net").connect(c);e.setTimeout(1E3);e.__connected=!1;e.on("connect",function(){b._logger.log("trace","connect to pioneer avr:"+b._ip);e.__connected=!0;b._socket=e;a()});e.on("data",function(a){b._logger.log("trace","receive from pioneer avr "+(e.__disconnected?"(closed)":"")+":"+b._ip+" data:"+a);e.__disconnected||b._packetBuffer._onSocketData(a)});e.on("error",function(c){e.__connected?(b._logger.log("trace",
"pioneer avr"+(e.__disconnected?"(closed)":"")+":"+b._ip+" error:"+c.message),e.destroy(),e.__disconnected||(e.__disconnected=!0,b._socket=null,b._packetBuffer._onSocketError(c))):(b._logger.log("trace","pioneer avr:"+b._ip+" connection error:"+c.message),a(c))});e.on("timeout",function(){e.__connected?(b._logger.log("trace","pioneer avr"+(e.__disconnected?"(closed)":"")+":"+b._ip+" data timeout"),e.__disconnected||b._packetBuffer._onSocketTimeout()):(b._logger.log("trace","pioneer avr:"+b._ip+" connection timeout"),
e.destroy&&e.destroy(),a(Error("timeout")))});e.on("close",function(){b._logger.log("trace","pioneer avr"+(e.__disconnected?"(closed)":"")+":"+b._ip+" close socket");e.__disconnected||(e.__disconnected=!0,b._socket=null,b._packetBuffer._onSocketClose(e))});e._doConnect&&"function"==typeof e._doConnect&&e._doConnect();return e};h.prototype._disconnect=function(){this._logger.log("debug","disconnect socket");this._socket&&(this._socket.__disconnected=!0,this._socket.end(),this._socket=null)};h.prototype.toJSON=
function(){var a={sys:xnm.aio.pioneer.DM.SYS,type:"avr",ip:this._ip,port:this._port,uuid:this._uuid};this._name&&(a.name=this._name);this._model&&(a.model=this._model);return a};h.prototype.equalsTo=function(a){return a&&a instanceof h?this._ip==a._ip&&this._port==a._port:!1};h.parseJSON=function(a){return a.ip?new h(a.ip,a.port,a.uuid,a.name,a.model):null};return h}();
xnm.aio.pioneer.DM=function(){var l=function(d,g){this.code=d;this.message=g;this.stack=Error().stack};l.prototype=Error();l.prototype.name="PioneerDMError";l.prototype.code=0;l.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var d={avr:{command:[{type:"root",name:"global",value:"global",children:[{type:"enum",name:"open pioneer iControlAV5",ref:{value:"openNative"}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",
ref:{value:"tunerDown"}},{type:"enum",name:"set tuner to preset",ref:{value:"tuner",ext:"%e",extMeta:"A1 A2 A3 A4 A5 A6 A7 A8 A9 B1 B2 B3 B4 B5 B6 B7 B8 B9 C1 C2 C3 C4 C5 C6 C7 C8 C9 D1 D2 D3 D4 D5 D6 D7 D8 D9 E1 E2 E3 E4 E5 E6 E7 E8 E9 F1 F2 F3 F4 F5 F6 F7 F8 F9 G1 G2 G3 G4 G5 G6 G7 G8 G9".split(" ")}},{type:"enum",name:"set listening mode",ref:{value:"audioMode",ext:"%e",extMeta:"MOVIE MUSIC GAME AUTO ALC DIRECT PURE_DIRECT F.S.SURR_FOCUS DRAMA CLASSICAL ROCK/POP SPORT".split(" ")}},{type:"string",
name:"custom command",ref:{value:"customCMD",ext:"%s"}}]},{type:"root",name:"NET Radio",value:"net",children:[{type:"enum",name:"play",ref:{path:["global"],value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}},{type:"enum",name:"enter",ref:{value:"enter"}},{type:"enum",name:"return",ref:{value:"return"}},{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",
name:"down",ref:{value:"down"}},{type:"enum",name:"left",ref:{value:"left"}},{type:"enum",name:"right",ref:{value:"right"}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"float",name:"volume to",ref:{value:"setTo",unit:"db",
ext:"%f",extMeta:"-80.5-12.0",scale:"0.5"}},{type:"enum",name:"set tone",ref:{value:"setTone",ext:"%e",extMeta:["BYPASS","ON"]}},{type:"enum",name:"bass up",ref:{value:"bassUp"}},{type:"enum",name:"bass down",ref:{value:"bassDown"}},{type:"int",name:"bass to",ref:{value:"bassTo",unit:"db",ext:"%d",extMeta:"-6-6",scale:"1"}},{type:"enum",name:"treble up",ref:{value:"trebleUp"}},{type:"enum",name:"treble down",ref:{value:"trebleDown"}},{type:"int",name:"treble to",ref:{value:"trebleTo",unit:"db",ext:"%d",
extMeta:"-6-6",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"BD DVD SAT/CBL DVR/BDR HDMI1 HDMI2 HDMI3 HDMI4 HDMI5 HDMI6 HDMI7 NETRADIO Spotify MEDIASERVER FAVORITES iPod/USB TV TUNER BTAUDIO CD".split(" ")}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",
name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"volume to",ref:{value:"setTo",ext:"%d",extMeta:"-81-0",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",
extMeta:"BD DVD SAT/CBL DVR/BDR HDMI1 HDMI2 HDMI3 HDMI4 HDMI5 HDMI6 HDMI7 NETRADIO Spotify MEDIASERVER FAVORITES iPod/USB TV TUNER BTAUDIO CD".split(" ")}}]},{type:"root",name:"zone 3",value:"zone3",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"volume to",
ref:{value:"setTo",ext:"%d",extMeta:"-81-0",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"BD DVD SAT/CBL DVR/BDR HDMI1 HDMI2 HDMI3 HDMI4 HDMI5 HDMI6 HDMI7 NETRADIO Spotify MEDIASERVER FAVORITES iPod/USB TV TUNER BTAUDIO CD".split(" ")}}]},{type:"root",name:"zone HD",value:"zoneHD",children:[{type:"enum",name:"power on",
ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"volume to",ref:{value:"setTo",ext:"%d",extMeta:"-81-0",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"set input",
ref:{value:"setInput",ext:"%e",extMeta:"BD DVD SAT/CBL DVR/BDR HDMI1 HDMI2 HDMI3 HDMI4 HDMI5 HDMI6 HDMI7 NETRADIO Spotify MEDIASERVER FAVORITES iPod/USB TV TUNER BTAUDIO CD".split(" ")}}]}],status:[{type:"root",name:"global",value:"global",children:[{type:"enum",name:"listening mode",ref:{value:"audioMode",options:["MOVIE","MUSIC","GAME","AUTO"]}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"float",name:"volume",ref:{value:"volume",unit:"db",extMeta:"-80.5-12.0",scale:"0.5"}},
{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:"BD DVD SAT/CBL DVR/BDR HDMI1 HDMI2 HDMI3 HDMI4 HDMI5 HDMI6 HDMI7 NETRADIO Spotify MEDIASERVER FAVORITES iPod/USB TV TUNER BTAUDIO CD".split(" ")}},{type:"enum",name:"tone",ref:{value:"tone",options:["ON","BYPASS"]}},{type:"int",name:"bass",ref:{value:"bass",unit:"db",extMeta:"-6-6",scale:"1"}},{type:"int",name:"treble",
ref:{value:"treble",unit:"db",extMeta:"-6-6",scale:"1"}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"-81-0",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:"BD DVD SAT/CBL DVR/BDR HDMI1 HDMI2 HDMI3 HDMI4 HDMI5 HDMI6 HDMI7 NETRADIO Spotify MEDIASERVER FAVORITES iPod/USB TV TUNER BTAUDIO CD".split(" ")}}]},
{type:"root",name:"zone 3",value:"zone3",children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"-81-0",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:"BD DVD SAT/CBL DVR/BDR HDMI1 HDMI2 HDMI3 HDMI4 HDMI5 HDMI6 HDMI7 NETRADIO Spotify MEDIASERVER FAVORITES iPod/USB TV TUNER BTAUDIO CD".split(" ")}}]},{type:"root",name:"zone HD",value:"zoneHD",
children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"-81-0",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:"BD DVD SAT/CBL DVR/BDR HDMI1 HDMI2 HDMI3 HDMI4 HDMI5 HDMI6 HDMI7 NETRADIO Spotify MEDIASERVER FAVORITES iPod/USB TV TUNER BTAUDIO CD".split(" ")}}]}]}};return{SYS:"pioneer",getIPDeviceType:function(){return[{sys:this.SYS,name:"Pioneer AV Receiver",
type:"avr"}]},createDevice:function(d,g,f){g=l.ERROR_CODE;d?d.ip?f(null,d):f(new l(g.INVALID,"ip is invalid")):f(new l(g.INVALID,"info is invalid"))},updateDevice:function(d,g,f){g=l.ERROR_CODE;d?d.ip?f(null,d):f(new l(g.INVALID,"ip is invalid")):f(new l(g.INVALID,"info is invalid"))},deleteDevice:function(d,g,f){f()},applyUIFilter:function(d,g,f){var h=function(a,b,c){var d=[];a.forEach(function(a){if("root"==a.type){a=JSON.parse(JSON.stringify(a));var e=h(a.children,b,c);e&&0<e.length&&(a.children=
e,d.push(a))}else{e=c.elems;if("*"==e)e=!0;else{for(var f=!1,g=0;g<e.length;g++)if(e[g]==a.type){f=!0;break}e=f}e&&(a=JSON.parse(JSON.stringify(a)),d.push(a))}});return d},a=function(a,b){var c=[],d=xnm.aio.pioneer.DM.getCommandStatusMap(a,f);if(d){var g=[];switch(b.catagory){case "command":d.command&&(g=h(d.command,a,b));break;case "status":d.status&&(g=h(d.status,a,b))}c=c.concat(g)}return c};if(!d.sys)return null;var b=JSON.parse(JSON.stringify(d)),c=null;switch(g.catagory){case "command":c=a(d,
g);b.command=c;break;case "status":c=a(d,g);b.status=c;break;default:return null}return c&&0!=c.length?b:null},getCommandStatusMap:function(k){return k&&k.type?d[k.type]:null}}}();
xnm.aio.pioneer.Handler=function(){var l=function(){this.detected={}};l.prototype.devicemanager=xnm.aio.pioneer.DM;l.prototype.AVReceiver=xnm.aio.pioneer.AVReceiver;l.prototype.registModule=function(d){d.register(xnm.aio.pioneer.DM.SYS,"pioneer")};l.prototype.resolveDevice=function(d){if(!d)return null;switch(d.type){case "avr":return xnm.aio.pioneer.AVReceiver.parseJSON(d);default:return null}};l.prototype.getDeviceCommands=function(d,k){var g=xnm.aio.pioneer.DM.applyUIFilter(d,{catagory:"command",
elems:"*"}),g=g?g.command:[];k&&k(null,g)};l.prototype.getDeviceStatus=function(d,k){var g=xnm.aio.pioneer.DM.applyUIFilter(d,{catagory:"status",elems:"*"}),g=g?g.status:[];k&&k(null,g)};l.prototype.doCommand=function(d,k,g){var f=this.resolveDevice(d);f?f.executeCommandCreator(d,k,function(d){g&&g(d)}):g&&g(Error("device json format invalid"))};l.prototype.doStatus=function(d,k,g,f){var h=this.resolveDevice(k);h?h.getStatesCreator(null,[{id:d,device:k,status:g}],function(a,b){a?f&&f(a):f&&f(null,
b[0])}):f&&f(Error("device json format invalid"))};l.prototype.getDeviceCommandList=function(d,k,g){var f=[];if(k)f.push({id:window.XC_Text.on,cmd:"on"}),f.push({id:window.XC_Text.off,cmd:"off"});else if(g&&"avr"==d.type){d=[];d.push({id:"on",cmd:"on"});d.push({id:"off",cmd:"off"});d.push({id:"toggle",cmd:"toggle"});d.push({id:"volumeDown",cmd:"volumeDown"});d.push({id:"volumeUp",cmd:"volumeUp"});d.push({id:"set volume",cmd:"setTo",step:"1",max:"80"});d.push({id:"mute",cmd:"mute"});d.push({id:"unmute",
cmd:"unmute"});d.push({id:"toggleMute",cmd:"toggleMute"});d.push({id:"CBLSAT",cmd:"CBLSAT"});d.push({id:"BDDVD",cmd:"BDDVD"});d.push({id:"STRMBOX",cmd:"STRMBOX"});d.push({id:"GAME",cmd:"GAME"});d.push({id:"AUX",cmd:"AUX"});d.push({id:"PC",cmd:"PC"});d.push({id:"CD",cmd:"CD"});d.push({id:"TV",cmd:"TV"});d.push({id:"NET",cmd:"NET"});d.push({id:"BLUETOOTH",cmd:"BLUETOOTH"});d.push({id:"FM",cmd:"FM"});d.push({id:"AM",cmd:"AM"});d.push({id:"tunerUp",cmd:"tunerUp"});d.push({id:"tunerDown",cmd:"tunerDown"});
d.push({id:"set tuner to",cmd:"tuner",step:"1",min:"1",max:"40"});cl=d.length;for(k=0;k<cl;k++)g=JSON.parse(JSON.stringify(d[k])),g.ch="mainzone",f.push(g),g=JSON.parse(JSON.stringify(d[k])),g.ch="zone2",f.push(g);f.push({id:"MOVIE",cmd:"MOVIE"});f.push({id:"MUSIC",cmd:"MUSIC"});f.push({id:"GAME",cmd:"GAME"});f.push({id:"STEREO",cmd:"STEREO"});f.push({id:"play",cmd:"play"});f.push({id:"pause",cmd:"pause"});f.push({id:"stop",cmd:"stop"});f.push({id:"previous",cmd:"previous"});f.push({id:"next",cmd:"next"})}return f};
l.prototype.discover=function(d){var k=require("x.upnp.js");if(k){var g=this;k.discoverDevicesWithTimeout(3E3,function(f){if(f.manufacturer&&-1!=f.manufacturer.toLowerCase().indexOf("pioneer")&&f.modelName&&(-1!=f.modelName.toLowerCase().indexOf("vsx")||-1!=f.modelName.toLowerCase().indexOf("sc"))){var h=f.modelName,a=h.indexOf("/");-1!=a&&(h=h.substr(0,a));h=new xnm.aio.pioneer.AVReceiver(f.ip,0,f.uuid,f.name,h);g.detected[f.uuid]=h;d(h)}})}};l.prototype.discoverWithTimeout=function(d,k){var g={};
this.discover(function(d){d&&d._uuid&&!g[d._uuid]&&(g[d._uuid]=d)});setTimeout(function(){var d=[],h;for(h in g)g.hasOwnProperty(h)&&d.push(g[h]);k&&k(null,d)},d)};return l}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.pioneer.Handler);
