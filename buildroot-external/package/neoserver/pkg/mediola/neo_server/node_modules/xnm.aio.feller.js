var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.feller=xnm.aio.feller||{};
xnm.aio.feller.Zeptrion=function(){var c=function(b,a,d,f){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.feller.Zeptrion");this.ip=b;this.port=a;this.port||(this.port=80);this.type=d;this.uuid=f;this.CommandHandler=null};c.prototype.getDevice=function(b,a,d,f){var e=this;$.ajax({url:"http://"+this.ip+"/zrap/net",method:"POST",data:{ssid:b,pw:a,enc:d},statusCode:{302:function(){e._reboot(function(a){f&&f(a)})}}})};c.prototype._doRequest=
function(b,a,d,f){var e=this;a="http://"+this.ip+":"+this.port+a;this._logger.log("trace","send "+b+" to url:"+a+" data:"+d);var c=f;$.ajax({url:a,type:b,timeout:1E4,data:d,dataType:"text",cache:!0,success:function(a){e._logger.log("trace","http request success:"+a);c&&(c(null,a),c=null)},error:function(a,d){var b="http request error:"+(a?a.status:"0")+"-"+d;e._logger.log("trace",b);b=Error(b);b.code=a?a.status:0;c&&(c(b),c=null)}})};c.prototype._reboot=function(b){$.ajax({url:"http://"+this.ip+"/zrap/sys",
method:"POST",data:{cmd:"reboot"},statusCode:{302:function(){var a="Device is now in network: "+ssid;b&&b(a)}}})};c.prototype.getState=function(b,a){this._doRequest("/zrap/chscan/ch"+b,function(d,f){var e=$.parseXML(f),e=$(e).find("ch"+b),e=e[0]._children[0]._value;a&&a(e)})};c.prototype.chScan=function(b){this._doRequest("GET","/zrap/chscan",null,function(a,d){if(a)b&&b(a);else try{var f=$($.parseXML(d));if(f){var e={},c=f.find("ch1 val");c&&0<c.length&&(e.ch1=$(c[0]).text());var m=f.find("ch2 val");
m&&0<m.length&&(e.ch2=$(m[0]).text());var l=f.find("ch3 val");l&&0<l.length&&(e.ch3=$(l[0]).text());var g=f.find("ch4 val");g&&0<g.length&&(e.ch4=$(g[0]).text());b&&b(null,e)}else b&&b(Error("chscan response invalid"))}catch(k){b&&b(k)}})};c.prototype.notify=function(b,a){this._doRequest("/zrap/chnotify/ch"+b,function(d,f){var e=$.parseXML(f);b=$(e).find("ch"+b);var e=b[0]._children[0]._value,c={state:"?",current:"?"};!d&&e&&(100==e?c.state="on":0==e?c.state="off":-1==e&&(c.state="?"),a&&a(c))})};
c.prototype.parseState=function(b,a){var d=parseInt(a);switch(b){case "switch":return{state:0==d?"off":"on"};case "dimmer":return{state:d};default:return null}};c.prototype.executeCommand=function(b,a,d){a?b?this._doRequest("POST","/zrap/chctrl/ch"+a,"cmd="+b,function(a){a&&302==a.code&&(a=null);d&&d(a)}):d&&d(Error("command is null")):d&&d(Error("channel is null"))};c.prototype.executeCommandCreator=function(b,a,d){if(a&&a.value)if(b&&b.address){var c=a.value;switch(a.value){case "recall_s":case "store_s":case "delete_s":if(!a.ext){d&&
d(Error("command ext invalid"));return}c+=a.ext}this.executeCommand(c,b.address,function(a){d&&d(a)})}else d&&d(Error("device json invalid"));else d&&d(Error("command json invalid"))};c.prototype.getStatesCreator=function(b,a,d){if(a)if(0==a.length)d&&d(null,[]);else{var c=this;this.chScan(function(b,h){if(b)d&&d(b);else{for(var m=[],l=0;l<a.length;l++)if(a[l].id){var g="?";if(a[l].status&&a[l].status.value&&a[l].device&&a[l].device.address){var k="ch"+a[l].device.address;h&&h[k]&&(k=c.parseState(a[l].device.type,
h[k]))&&(g=k[a[l].status.value]);if("undefined"==typeof g||null==g)g="?"}m.push({id:a[l].id,status:g})}d&&d(null,m)}})}else d&&d(Error("deviceList is null"))};c.prototype.toJSON=function(){return{sys:"feller",ip:this.ip,port:this.port,type:this.type,uuid:this.uuid}};c.prototype.equalsTo=function(b){return b&&b instanceof xnm.aio.feller.Zeptrion?this.ip==b.ip:!1};c.parseJSON=function(b){return b.ip&&b.type?new c(b.ip,b.port,b.type,b.uuid):null};return c}();
xnm.aio.feller.DM=function(){var c=function(a,d){this.code=a;this.message=d;this.stack=Error().stack};c.prototype=Error();c.prototype.name="FellerDMError";c.prototype.code=0;c.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var b={"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"call scene",ref:{value:"recall_s",ext:"%d",extMeta:"1-4"}},
{type:"int",name:"store scene",ref:{value:"store_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"delete scene",ref:{value:"delete_s",ext:"%d",extMeta:"1-4"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["off","on"]}}]},dimmer:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"enum",name:"dim up",ref:{value:"dim_up"}},{type:"enum",name:"dim down",ref:{value:"dim_down"}},{type:"enum",name:"stop",
ref:{value:"stop"}},{type:"int",name:"call scene",ref:{value:"recall_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"store scene",ref:{value:"store_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"delete scene",ref:{value:"delete_s",ext:"%d",extMeta:"1-4"}}],status:[{type:"int",name:"state",ref:{value:"state",extMeta:"0-100"}}]},blind:{command:[{type:"enum",name:"move up",ref:{value:"move_open"}},{type:"enum",name:"move close",ref:{value:"move_close"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"int",
name:"call scene",ref:{value:"recall_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"store scene",ref:{value:"store_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"delete scene",ref:{value:"delete_s",ext:"%d",extMeta:"1-4"}}]}};return{SYS:"feller",getGatewayType:function(){return[{sys:this.SYS,name:"Feller Zeptrion",subtypes:[{id:"Switch",type:"switch"},{id:"Dimmer",type:"dimmer"},{id:"Blind",type:"blind"}]}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"switch",name:"Switch"},{sys:this.SYS,
type:"dimmer",name:"Dimmer"},{sys:this.SYS,type:"blind",name:"Blind"}]},createGateway:function(a,d,b){d=c.ERROR_CODE;a?a.ip?a.port?a.type?b(null,a):b(new c(d.INVALID,"type is invalid")):b(new c(d.INVALID,"port is invalid")):b(new c(d.INVALID,"ip is invalid")):b(new c(d.INVALID,"info is invalid"))},updateGateway:function(a,d,b,e){a=c.ERROR_CODE;d?d.ip?d.port?d.type?e(null,d):e(new c(a.INVALID,"type is invalid")):e(new c(a.INVALID,"port is invalid")):e(new c(a.INVALID,"ip is invalid")):e(new c(a.INVALID,
"update is invalid"))},deleteGateway:function(a,d,b){b()},createDevice:function(a,d,b){var e=c.ERROR_CODE;if(a)if(a.address)if(a.type)if(a.gateway){d=d.data.gateways;var h,m;for(h=0;h<d.length;h++)if(d[h].index===a.gateway){m=d[h];break}m?b&&b(null,a):b(new c(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else b(new c(e.INVALID,"gateway is invalid"));else b(new c(e.INVALID,"type is invalid"));else b(new c(e.INVALID,"address is invalid"));else b(new c(e.INVALID,"info is invalid"))},updateDevice:function(a,
b,f){var e=c.ERROR_CODE;if(a)if(a.address)if(a.type)if(a.gateway){b=b.data.gateways;var h,m;for(h=0;h<b.length;h++)if(b[h].index===a.gateway){m=b[h];break}m?f(null,a):f(new c(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else f(new c(e.INVALID,"gateway is invalid"));else f(new c(e.INVALID,"type is invalid"));else f(new c(e.INVALID,"address is invalid"));else f(new c(e.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){c()},applyUIFilter:function(a,b,c){var e=function(a,b){if("*"==
a)return!0;for(var d=!1,c=0;c<a.length;c++)if(a[c]==b){d=!0;break}return d},h=function(a,b,c){var d=[];"command"==c.catagory?a.command&&a.command.forEach(function(a){e(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))}):"status"==c.catagory&&a.status&&a.status.forEach(function(a){e(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))});return d},m=function(a,b){var d=[],e=null;if(e=xnm.aio.feller.DM.getCommandStatusMap(a,c))e=h(e,a,b),d=d.concat(e);return d};if(!a.sys)return null;
var l=JSON.parse(JSON.stringify(a)),g=null;if("command"==b.catagory)g=m(a,b),l.command=g;else if("status"==b.catagory)g=m(a,b),l.status=g;else return null;return g&&0!=g.length?l:null},getCommandStatusMap:function(a,d){return a.type?b[a.type]:null}}}();
xnm.aio.feller.Handler=function(){var c=function(){};c.prototype.devicemanager=xnm.aio.feller.DM;c.prototype.Zeptrion=xnm.aio.feller.Zeptrion;c.prototype.registModule=function(b){b.register(this.devicemanager.SYS,"feller")};c.prototype.resolveGateway=function(b){return b?this.Zeptrion.parseJSON(b):null};c.prototype.getDeviceCommands=function(b,a){var d=this.devicemanager.applyUIFilter(b,{catagory:"command",elems:"*"}),d=d?d.command:[];a&&a(null,d)};c.prototype.getDeviceStatus=function(b,a){var d=
this.devicemanager.applyUIFilter(b,{catagory:"status",elems:"*"}),d=d?d.status:[];a&&a(null,d)};c.prototype.doCommand=function(b,a,d,c){(b=this.resolveGateway(b))?b.executeCommandCreator(a,d,function(a){c&&c(a)}):c&&c(Error("gateway json format invalid"))};c.prototype.doStatus=function(b,a,c,f,e){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:b,device:c,status:f}],function(a,b){a?e&&e(a):e&&e(null,b[0])}):e&&e(Error("gateway json format invalid"))};c.prototype.discover=function(b,a){var c=
this,f=require("x.mdns.js");f.clearRecordBuffer();var e={},h=2;f.discoverServiceWithTimeout("_zapp._tcp.local",b,function(b,f){h--;if(b)a&&a(b);else{for(var g=0;g<f.length;g++){var k=f[g];if(k.target&&k.ip&&0<k.ip.length){var n=k.target.toLowerCase(),q=n.indexOf("-"),r=n.indexOf("."),n=n.substring(q+1,r);e[n]=new c.Zeptrion(k.ip[0],null,k.info.type,n)}}if(0==h){var g=[],p;for(p in e)g.push(e[p]);a&&a(null,g)}}});f.discoverServiceWithTimeout("_http._tcp.local",b,function(b,f){h--;if(b)a&&a(b);else{for(var g=
0;g<f.length;g++){var k=f[g];if(k.target&&k.ip&&0<k.ip.length){var n=k.target.toLowerCase();if("zapp"==n.substr(0,4)){var q=n.indexOf("-"),r=n.indexOf("."),n=n.substring(q+1,r),k=new c.Zeptrion(k.ip[0],null,k.info.type,n);e[n]||(e[n]=k)}}}if(0==h){var g=[],p;for(p in e)g.push(e[p]);a&&a(null,g)}}})};c.prototype.getDeviceList=function(b,a){b&&b.type?0==b.type.indexOf("3340-4")?a&&a(null,[{sys:"feller",address:1,type:""},{sys:"feller",address:2,type:""},{sys:"feller",address:3,type:""},{sys:"feller",
address:4,type:""}]):0==b.type.indexOf("3340-2")?a&&a(null,[{sys:"feller",address:1,type:""},{sys:"feller",address:2,type:""}]):a&&a(Error("unknow gateway type")):a&&a(Error("gateway json invalid"))};return c}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.feller.Handler);
