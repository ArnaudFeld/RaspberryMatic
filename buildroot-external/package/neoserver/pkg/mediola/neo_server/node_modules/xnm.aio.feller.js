var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,c,b){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var f=a[e];if(c.call(b,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,b){a!=Array.prototype&&a!=Object.prototype&&(a[c]=b.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,c,b,d){if(c){b=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in b||(b[e]={});b=b[e]}a=a[a.length-1];d=b[a];c=c(d);c!=d&&null!=c&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:c})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(c,b){return $jscomp.findInternal(this,c,b).v}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.feller=xnm.aio.feller||{};
xnm.aio.feller.Zeptrion=function(){var a=function(c,b,d,a){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.feller.Zeptrion");this.ip=c;this.port=b;this.port||(this.port=80);this.type=d;this.uuid=a;this.CommandHandler=null};a.prototype.getDevice=function(c,b,d,a){var e=this;$.ajax({url:"http://"+this.ip+"/zrap/net",method:"POST",data:{ssid:c,pw:b,enc:d},statusCode:{302:function(){e._reboot(function(b){a&&a(b)})}}})};a.prototype._doRequest=
function(c,b,d,a){var e=this;b="http://"+this.ip+":"+this.port+b;this._logger.log("trace","send "+c+" to url:"+b+" data:"+d);var g=a;$.ajax({url:b,type:c,timeout:1E4,data:d,dataType:"text",cache:!0,success:function(b){e._logger.log("trace","http request success:"+b);g&&(g(null,b),g=null)},error:function(b,c){c="http request error:"+(b?b.status:"0")+"-"+c;e._logger.log("trace",c);c=Error(c);c.code=b?b.status:0;g&&(g(c),g=null)}})};a.prototype._reboot=function(c){$.ajax({url:"http://"+this.ip+"/zrap/sys",
method:"POST",data:{cmd:"reboot"},statusCode:{302:function(){var b="Device is now in network: "+ssid;c&&c(b)}}})};a.prototype.getState=function(c,b){this._doRequest("/zrap/chscan/ch"+c,function(d,a){d=$.parseXML(a);d=$(d).find("ch"+c);d=d[0]._children[0]._value;b&&b(d)})};a.prototype.chScan=function(c){this._doRequest("GET","/zrap/chscan",null,function(b,d){if(b)c&&c(b);else try{var a=$($.parseXML(d));if(a){b={};var f=a.find("ch1 val");f&&0<f.length&&(b.ch1=$(f[0]).text());var g=a.find("ch2 val");
g&&0<g.length&&(b.ch2=$(g[0]).text());var h=a.find("ch3 val");h&&0<h.length&&(b.ch3=$(h[0]).text());var l=a.find("ch4 val");l&&0<l.length&&(b.ch4=$(l[0]).text());c&&c(null,b)}else c&&c(Error("chscan response invalid"))}catch(k){c&&c(k)}})};a.prototype.notify=function(c,b){this._doRequest("/zrap/chnotify/ch"+c,function(a,e){e=$.parseXML(e);c=$(e).find("ch"+c);e=c[0]._children[0]._value;var d={state:"?",current:"?"};!a&&e&&(100==e?d.state="on":0==e?d.state="off":-1==e&&(d.state="?"),b&&b(d))})};a.prototype.parseState=
function(c,b){b=parseInt(b);switch(c){case "switch":return{state:0==b?"off":"on"};case "dimmer":return{state:b};default:return null}};a.prototype.executeCommand=function(c,b,a){b?c?this._doRequest("POST","/zrap/chctrl/ch"+b,"cmd="+c,function(b){b&&302==b.code&&(b=null);a&&a(b)}):a&&a(Error("command is null")):a&&a(Error("channel is null"))};a.prototype.executeCommandCreator=function(a,b,d){if(b&&b.value)if(a&&a.address){var c=b.value;switch(b.value){case "recall_s":case "store_s":case "delete_s":if(!b.ext){d&&
d(Error("command ext invalid"));return}c+=b.ext}this.executeCommand(c,a.address,function(b){d&&d(b)})}else d&&d(Error("device json invalid"));else d&&d(Error("command json invalid"))};a.prototype.getStatesCreator=function(a,b,d){if(b)if(0==b.length)d&&d(null,[]);else{var c=this;this.chScan(function(a,e){if(a)d&&d(a);else{a=[];for(var f=0;f<b.length;f++)if(b[f].id){var g="?";if(b[f].status&&b[f].status.value&&b[f].device&&b[f].device.address){var k="ch"+b[f].device.address;e&&e[k]&&(k=c.parseState(b[f].device.type,
e[k]))&&(g=k[b[f].status.value]);if("undefined"==typeof g||null==g)g="?"}a.push({id:b[f].id,status:g})}d&&d(null,a)}})}else d&&d(Error("deviceList is null"))};a.prototype.toJSON=function(){return{sys:"feller",ip:this.ip,port:this.port,type:this.type,uuid:this.uuid}};a.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.feller.Zeptrion?this.ip==a.ip:!1};a.parseJSON=function(c){return c.ip&&c.type?new a(c.ip,c.port,c.type,c.uuid):null};return a}();
xnm.aio.feller.DM=function(){var a=function(b,a){this.code=b;this.message=a;this.stack=Error().stack};a.prototype=Error();a.prototype.name="FellerDMError";a.prototype.code=0;a.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var c={"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"call scene",ref:{value:"recall_s",ext:"%d",extMeta:"1-4"}},
{type:"int",name:"store scene",ref:{value:"store_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"delete scene",ref:{value:"delete_s",ext:"%d",extMeta:"1-4"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["off","on"]}}]},dimmer:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"enum",name:"dim up",ref:{value:"dim_up"}},{type:"enum",name:"dim down",ref:{value:"dim_down"}},{type:"enum",name:"stop",
ref:{value:"stop"}},{type:"int",name:"call scene",ref:{value:"recall_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"store scene",ref:{value:"store_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"delete scene",ref:{value:"delete_s",ext:"%d",extMeta:"1-4"}}],status:[{type:"int",name:"state",ref:{value:"state",extMeta:"0-100"}}]},blind:{command:[{type:"enum",name:"move up",ref:{value:"move_open"}},{type:"enum",name:"move close",ref:{value:"move_close"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"int",
name:"call scene",ref:{value:"recall_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"store scene",ref:{value:"store_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"delete scene",ref:{value:"delete_s",ext:"%d",extMeta:"1-4"}}]}};return{SYS:"feller",getGatewayType:function(){return[{sys:this.SYS,name:"Feller Zeptrion",subtypes:[{id:"Switch",type:"switch"},{id:"Dimmer",type:"dimmer"},{id:"Blind",type:"blind"}]}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"switch",name:"Switch"},{sys:this.SYS,
type:"dimmer",name:"Dimmer"},{sys:this.SYS,type:"blind",name:"Blind"}]},createGateway:function(b,c,e){c=a.ERROR_CODE;b?b.ip?b.port?b.type?e(null,b):e(new a(c.INVALID,"type is invalid")):e(new a(c.INVALID,"port is invalid")):e(new a(c.INVALID,"ip is invalid")):e(new a(c.INVALID,"info is invalid"))},updateGateway:function(b,c,e,f){b=a.ERROR_CODE;c?c.ip?c.port?c.type?f(null,c):f(new a(b.INVALID,"type is invalid")):f(new a(b.INVALID,"port is invalid")):f(new a(b.INVALID,"ip is invalid")):f(new a(b.INVALID,
"update is invalid"))},deleteGateway:function(b,a,c){c()},createDevice:function(b,c,e){var d=a.ERROR_CODE;if(b)if(b.address)if(b.type)if(b.gateway){c=c.data.gateways;var g;for(g=0;g<c.length;g++)if(c[g].index===b.gateway){var h=c[g];break}h?e&&e(null,b):e(new a(d.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else e(new a(d.INVALID,"gateway is invalid"));else e(new a(d.INVALID,"type is invalid"));else e(new a(d.INVALID,"address is invalid"));else e(new a(d.INVALID,"info is invalid"))},
updateDevice:function(b,c,e){var d=a.ERROR_CODE;if(b)if(b.address)if(b.type)if(b.gateway){c=c.data.gateways;var g;for(g=0;g<c.length;g++)if(c[g].index===b.gateway){var h=c[g];break}h?e(null,b):e(new a(d.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else e(new a(d.INVALID,"gateway is invalid"));else e(new a(d.INVALID,"type is invalid"));else e(new a(d.INVALID,"address is invalid"));else e(new a(d.INVALID,"info is invalid"))},deleteDevice:function(b,a,c){c()},applyUIFilter:function(b,a,
c){var d=function(b,a){if("*"==b)return!0;for(var c=!1,d=0;d<b.length;d++)if(b[d]==a){c=!0;break}return c},e=function(b,a,c){var e=[];"command"==c.catagory?b.command&&b.command.forEach(function(b){d(c.elems,b.type)&&(b=JSON.parse(JSON.stringify(b)),e.push(b))}):"status"==c.catagory&&b.status&&b.status.forEach(function(b){d(c.elems,b.type)&&(b=JSON.parse(JSON.stringify(b)),e.push(b))});return e},h=function(b,a){var d=[],f=xnm.aio.feller.DM.getCommandStatusMap(b,c);f&&(b=e(f,b,a),d=d.concat(b));return d};
if(!b.sys)return null;var l=JSON.parse(JSON.stringify(b)),k=null;if("command"==a.catagory)k=h(b,a),l.command=k;else if("status"==a.catagory)k=h(b,a),l.status=k;else return null;return k&&0!=k.length?l:null},getCommandStatusMap:function(b,a){return b.type?c[b.type]:null}}}();
xnm.aio.feller.Handler=function(){var a=function(){};a.prototype.devicemanager=xnm.aio.feller.DM;a.prototype.Zeptrion=xnm.aio.feller.Zeptrion;a.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"feller")};a.prototype.resolveGateway=function(a){return a?this.Zeptrion.parseJSON(a):null};a.prototype.getDeviceCommands=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};a.prototype.getDeviceStatus=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,
{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)};a.prototype.doCommand=function(a,b,d,e){(a=this.resolveGateway(a))?a.executeCommandCreator(b,d,function(b){e&&e(b)}):e&&e(Error("gateway json format invalid"))};a.prototype.doStatus=function(a,b,d,e,f){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:d,status:e}],function(b,a){b?f&&f(b):f&&f(null,a[0])}):f&&f(Error("gateway json format invalid"))};a.prototype.discover=function(a,b){var c=this,e=require("x.mdns.js");e.clearRecordBuffer();
var f={},g=2;e.discoverServiceWithTimeout("_zapp._tcp.local",a,function(a,d){g--;if(a)b&&b(a);else{for(a=0;a<d.length;a++){var e=d[a];if(e.target&&e.ip&&0<e.ip.length){var h=e.target.toLowerCase(),l=h.indexOf("-"),m=h.indexOf(".");h=h.substring(l+1,m);f[h]=new c.Zeptrion(e.ip[0],null,e.info.type,h)}}if(0==g){d=[];for(var n in f)d.push(f[n]);b&&b(null,d)}}});e.discoverServiceWithTimeout("_http._tcp.local",a,function(a,d){g--;if(a)b&&b(a);else{for(a=0;a<d.length;a++){var e=d[a];if(e.target&&e.ip&&0<
e.ip.length){var h=e.target.toLowerCase();if("zapp"==h.substr(0,4)){var l=h.indexOf("-"),m=h.indexOf(".");h=h.substring(l+1,m);e=new c.Zeptrion(e.ip[0],null,e.info.type,h);f[h]||(f[h]=e)}}}if(0==g){d=[];for(var n in f)d.push(f[n]);b&&b(null,d)}}})};a.prototype.getDeviceList=function(a,b){a&&a.type?0==a.type.indexOf("3340-4")?b&&b(null,[{sys:"feller",address:1,type:""},{sys:"feller",address:2,type:""},{sys:"feller",address:3,type:""},{sys:"feller",address:4,type:""}]):0==a.type.indexOf("3340-2")?b&&
b(null,[{sys:"feller",address:1,type:""},{sys:"feller",address:2,type:""}]):b&&b(Error("unknow gateway type")):b&&b(Error("gateway json invalid"))};return a}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.feller.Handler);
