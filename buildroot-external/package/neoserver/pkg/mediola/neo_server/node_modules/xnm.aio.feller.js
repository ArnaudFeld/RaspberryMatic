var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.feller=xnm.aio.feller||{},xnm.aio.feller.Zeptrion=function(){var e=function e(_e,t,n,a){"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.feller.Zeptrion"),this.ip=_e,this.port=t,this.port||(this.port=80),this.type=n,this.uuid=a,this.CommandHandler=null;};return e.prototype.getDevice=function(e,t,n,a){var r=this,i="http://"+this.ip+"/zrap/net";$.ajax({url:i,method:"POST",data:{ssid:e,pw:t,enc:n},statusCode:{302:function _(){r._reboot(function(e){a&&a(e);});}}});},e.prototype._doRequest=function(e,t,n,a){var r=this,i="http://"+this.ip+":"+this.port+t;this._logger.log("trace","send "+e+" to url:"+i+" data:"+n);var s=a;$.ajax({url:i,type:e,timeout:1e4,data:n,dataType:"text",cache:!0,success:function success(e){r._logger.log("trace","http request success:"+e),s&&(s(null,e),s=null);},error:function error(e,t){var n="http request error:"+(e?e.status:"0")+"-"+t;r._logger.log("trace",n);var a=new Error(n);a.code=e?e.status:0,s&&(s(a),s=null);}});},e.prototype._reboot=function(e){$.ajax({url:"http://"+this.ip+"/zrap/sys",method:"POST",data:{cmd:"reboot"},statusCode:{302:function _(){var t="Device is now in network: "+ssid;e&&e(t);}}});},e.prototype.getState=function(e,t){this._doRequest("/zrap/chscan/ch"+e,function(n,a){var r=$.parseXML(a),i=$(r).find("ch"+e);i=i[0]._children[0]._value;var s={state:"?",current:"?"};!n&&i&&(100==i?s.state="on":0==i?s.state="off":-1==i&&(s.state="?")),t&&t(i);});},e.prototype.chScan=function(e){this._doRequest("GET","/zrap/chscan",null,function(t,n){if(t)e&&e(t);else try{var a=$($.parseXML(n));if(!a)return void(e&&e(new Error("chscan response invalid")));var r={},i=a.find("ch1 val");i&&i.length>0&&(r.ch1=$(i[0]).text());var s=a.find("ch2 val");s&&s.length>0&&(r.ch2=$(s[0]).text());var o=a.find("ch3 val");o&&o.length>0&&(r.ch3=$(o[0]).text());var l=a.find("ch4 val");l&&l.length>0&&(r.ch4=$(l[0]).text()),e&&e(null,r);}catch(t){e&&e(t);}});},e.prototype.notify=function(e,t){this._doRequest("/zrap/chnotify/ch"+e,function(n,a){var r=$.parseXML(a),i=(e=$(r).find("ch"+e))[0]._children[0]._value,s={state:"?",current:"?"};!n&&i&&(100==i?s.state="on":0==i?s.state="off":-1==i&&(s.state="?"),t&&t(s));});},e.prototype.parseState=function(e,t){var n=parseInt(t);switch(e){case"switch":return{state:0==n?"off":"on"};case"dimmer":return{state:n};default:return null;}},e.prototype.executeCommand=function(e,t,n){if(t){if(e){var a="/zrap/chctrl/ch"+t,r="cmd="+e;this._doRequest("POST",a,r,function(e){e&&302==e.code&&(e=null),n&&n(e);});}else n&&n(new Error("command is null"));}else n&&n(new Error("channel is null"));},e.prototype.executeCommandCreator=function(e,t,n){if(t&&t.value){if(e&&e.address){var a=t.value;switch(t.value){case"recall_s":case"store_s":case"delete_s":if(!t.ext)return void(n&&n(new Error("command ext invalid")));a+=t.ext;}this.executeCommand(a,e.address,function(e){n&&n(e);});}else n&&n(new Error("device json invalid"));}else n&&n(new Error("command json invalid"));},e.prototype.getStatesCreator=function(e,t,n){if(t){if(0!=t.length){var a=this;this.chScan(function(e,r){if(e)n&&n(e);else{for(var i=[],s=0;s<t.length;s++)if(t[s].id){var o="?";if(t[s].status&&t[s].status.value&&t[s].device&&t[s].device.address){var l="ch"+t[s].device.address;if(r&&r[l]){var u=a.parseState(t[s].device.type,r[l]);u&&(o=u[t[s].status.value]);}void 0!==o&&null!=o||(o="?");}i.push({id:t[s].id,status:o});}n&&n(null,i);}});}else n&&n(null,[]);}else n&&n(new Error("deviceList is null"));},e.prototype.toJSON=function(){return{sys:"feller",ip:this.ip,port:this.port,type:this.type,uuid:this.uuid};},e.prototype.equalsTo=function(e){return!!e&&e instanceof xnm.aio.feller.Zeptrion&&this.ip==e.ip;},e.parseJSON=function(t){return t.ip&&t.type?new e(t.ip,t.port,t.type,t.uuid):null;},e;}(),xnm.aio.feller.DM=function(){var e=function e(_e2,t){this.code=_e2,this.message=t,this.stack=new Error().stack;};(e.prototype=new Error()).name="FellerDMError",e.prototype.code=0,e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var t={"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"call scene",ref:{value:"recall_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"store scene",ref:{value:"store_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"delete scene",ref:{value:"delete_s",ext:"%d",extMeta:"1-4"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["off","on"]}}]},dimmer:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"enum",name:"dim up",ref:{value:"dim_up"}},{type:"enum",name:"dim down",ref:{value:"dim_down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"int",name:"call scene",ref:{value:"recall_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"store scene",ref:{value:"store_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"delete scene",ref:{value:"delete_s",ext:"%d",extMeta:"1-4"}}],status:[{type:"int",name:"state",ref:{value:"state",extMeta:"0-100"}}]},blind:{command:[{type:"enum",name:"move up",ref:{value:"move_open"}},{type:"enum",name:"move close",ref:{value:"move_close"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"int",name:"call scene",ref:{value:"recall_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"store scene",ref:{value:"store_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"delete scene",ref:{value:"delete_s",ext:"%d",extMeta:"1-4"}}]}};return{SYS:"feller",getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"Feller Zeptrion",subtypes:[{id:"Switch",type:"switch"},{id:"Dimmer",type:"dimmer"},{id:"Blind",type:"blind"}]}];},getGatewayDeviceType:function getGatewayDeviceType(){return[{sys:this.SYS,type:"switch",name:"Switch"},{sys:this.SYS,type:"dimmer",name:"Dimmer"},{sys:this.SYS,type:"blind",name:"Blind"}];},createGateway:function createGateway(t,n,a){var r=e,i=e.ERROR_CODE;t?t.ip?t.port?t.type?a(null,t):a(new r(i.INVALID,"type is invalid")):a(new r(i.INVALID,"port is invalid")):a(new r(i.INVALID,"ip is invalid")):a(new r(i.INVALID,"info is invalid"));},updateGateway:function updateGateway(t,n,a,r){var i=e,s=e.ERROR_CODE;n?n.ip?n.port?n.type?r(null,n):r(new i(s.INVALID,"type is invalid")):r(new i(s.INVALID,"port is invalid")):r(new i(s.INVALID,"ip is invalid")):r(new i(s.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,n){n();},createDevice:function createDevice(t,n,a){var r=e,i=e.ERROR_CODE;if(t){if(t.address){if(t.type){if(t.gateway){var s,o,l=n.data.gateways;for(s=0;s<l.length;s++)if(l[s].index===t.gateway){o=l[s];break;}o?a&&a(null,t):a(new r(i.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else a(new r(i.INVALID,"gateway is invalid"));}else a(new r(i.INVALID,"type is invalid"));}else a(new r(i.INVALID,"address is invalid"));}else a(new r(i.INVALID,"info is invalid"));},updateDevice:function updateDevice(t,n,a){var r=e,i=e.ERROR_CODE;if(t){if(t.address){if(t.type){if(t.gateway){var s,o,l=n.data.gateways;for(s=0;s<l.length;s++)if(l[s].index===t.gateway){o=l[s];break;}o?a(null,t):a(new r(i.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else a(new r(i.INVALID,"gateway is invalid"));}else a(new r(i.INVALID,"type is invalid"));}else a(new r(i.INVALID,"address is invalid"));}else a(new r(i.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,n){n();},applyUIFilter:function applyUIFilter(e,t,n){var a=function a(e,t){if("*"==e)return!0;for(var n=!1,a=0;a<e.length;a++)if(e[a]==t){n=!0;break;}return n;},r=function r(e,t){var r=[],i=null,s=xnm.aio.feller.DM.getCommandStatusMap(e,n);return s&&(i=function(e,t,n){var r=[];return"command"==n.catagory?e.command&&e.command.forEach(function(e){if(a(n.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}}):"status"==n.catagory&&e.status&&e.status.forEach(function(e){if(a(n.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}}),r;}(s,0,t),r=r.concat(i)),r;};if(!e.sys)return null;var i=JSON.parse(JSON.stringify(e)),s=null;if("command"==t.catagory)s=r(e,t),i.command=s;else{if("status"!=t.catagory)return null;s=r(e,t),i.status=s;}return s&&0!=s.length?i:null;},getCommandStatusMap:function getCommandStatusMap(e,n){return e.type?t[e.type]:null;}};}(),xnm.aio.feller.Handler=function(){var e=function e(){};return e.prototype.devicemanager=xnm.aio.feller.DM,e.prototype.Zeptrion=xnm.aio.feller.Zeptrion,e.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"feller");},e.prototype.resolveGateway=function(e){return e?this.Zeptrion.parseJSON(e):null;},e.prototype.getDeviceCommands=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),a=n?n.command:[];t&&t(null,a);},e.prototype.getDeviceStatus=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),a=n?n.status:[];t&&t(null,a);},e.prototype.doCommand=function(e,t,n,a){var r=this.resolveGateway(e);r?r.executeCommandCreator(t,n,function(e){a&&a(e);}):a&&a(new Error("gateway json format invalid"));},e.prototype.doStatus=function(e,t,n,a,r){var i=this.resolveGateway(t);if(i){var s=[{id:e,device:n,status:a}];i.getStatesCreator(null,s,function(e,t){e?r&&r(e):r&&r(null,t[0]);});}else r&&r(new Error("gateway json format invalid"));},e.prototype.discover=function(e,t){var n=this,a=require("x.mdns.js");a.clearRecordBuffer();var r={},i=2;a.discoverServiceWithTimeout("_zapp._tcp.local",e,function(e,a){if(i--,e)t&&t(e);else{for(var s=0;s<a.length;s++){var o=a[s];if(o.target&&o.ip&&o.ip.length>0){var l=o.target.toLowerCase(),u=l.indexOf("-"),p=l.indexOf("."),c=l.substring(u+1,p),f=o.info.type,d=o.ip[0];r[c]=new n.Zeptrion(d,null,f,c);}}if(0==i){var v=[];for(var y in r)v.push(r[y]);t&&t(null,v);}}}),a.discoverServiceWithTimeout("_http._tcp.local",e,function(e,a){if(i--,e)t&&t(e);else{for(var s=0;s<a.length;s++){var o=a[s];if(o.target&&o.ip&&o.ip.length>0){var l=o.target.toLowerCase();if("zapp"==l.substr(0,4)){var u=l.indexOf("-"),p=l.indexOf("."),c=l.substring(u+1,p),f=o.info.type,d=o.ip[0],v=new n.Zeptrion(d,null,f,c);r[c]||(r[c]=v);}}}if(0==i){var y=[];for(var m in r)y.push(r[m]);t&&t(null,y);}}});},e.prototype.getDeviceList=function(e,t){e&&e.type?0==e.type.indexOf("3340-4")?t&&t(null,[{sys:"feller",address:1,type:""},{sys:"feller",address:2,type:""},{sys:"feller",address:3,type:""},{sys:"feller",address:4,type:""}]):0==e.type.indexOf("3340-2")?t&&t(null,[{sys:"feller",address:1,type:""},{sys:"feller",address:2,type:""}]):t&&t(new Error("unknow gateway type")):t&&t(new Error("gateway json invalid"));},e;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.feller.Handler());