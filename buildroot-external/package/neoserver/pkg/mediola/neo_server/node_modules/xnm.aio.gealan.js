var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.gealan=xnm.aio.gealan||{},xnm.aio.gealan.Fan=function(){var t={_stateTimeout:10,_errorTimeout:5,_buffer:{},getFanStates:function getFanStates(t){var e=this._buffer[t];e||(this._buffer[t]={},e=this._buffer[t]);var n=e.fan;if(!n)return e.fan={},void(n=e.fan);var a=n.time,r=Math.round(new Date().getTime()/1e3);return!a||r-a>this._stateTimeout||null==n.states&&r-a>this._errorTimeout?void 0:n.states;},setFanStates:function setFanStates(t,e){var n=this._buffer[t];n||(this._buffer[t]={},n=this._buffer[t]);var a=n.fan;a||(n.fan={},a=n.fan);var r=Math.round(new Date().getTime()/1e3);a.states=e,a.time=r;},getFilterStates:function getFilterStates(t){var e=this._buffer[t];e||(this._buffer[t]={},e=this._buffer[t]);var n=e.filter;if(!n)return e.filter={},void(n=e.filter);var a=n.time,r=Math.round(new Date().getTime()/1e3);return!a||r-a>this._stateTimeout||null==n.states&&r-a>this._errorTimeout?void 0:n.states;},setFilterStates:function setFilterStates(t,e){var n=this._buffer[t];n||(this._buffer[t]={},n=this._buffer[t]);var a=n.filter;a||(n.filter={},a=n.filter);var r=Math.round(new Date().getTime()/1e3);a.states=e,a.time=r;}},e=function e(t,_e,n,a){if(this._logger=require("x.logger.js").getLogger("xnm.aio.gealan.Fan"),this._ip=t,this._port=_e,this._port||(this._port=443),80==this._port&&(this._port=443),this._username=n,this._password=a,this._timeout=5e3,this._readMainCallbacks=[],this._readAmbientsCallbacks=[],this._readFilterCallbacks=[],this._readLogCallbacks=[],this._readFanCallbacks=[],this._readWlanScanCallbacks=[],this._readCounterCallbacks=[],this._httpReqBuffer=[],this._configUdpServerInterval=null,"undefined"!=typeof process&&null!=process&&process.env){var r=require("https");this._keepAliveAgent=new r.Agent({keepAlive:!0,maxSockets:1});}};return e.prototype.executeCommandCreator=function(t,e,n){var a;if(e&&e.value)switch(e.value){case"on":this._setOn(n);break;case"off":this._setStandBy(n);break;case"setLevel":if(a=parseInt(e.ext),isNaN(a))return void(n&&n(new Error("level value invalid")));switch(a){case 0:this._setStandBy(n);break;case 1:this._setLevel1(n);break;case 2:this._setLevel2(n);break;case 3:this._setLevel3(n);break;case 4:this._setLevel4(n);break;case 5:this._setLevel5(n);break;default:n&&n(new Error("level value out of range"));}break;case"automatic":this._setAutomatic(n);break;case"manual":this._setManual(n);break;case"nextLevel":this._setNextLevel(n);break;case"previousLevel":this._setPreviousLevel(n);break;case"nightIn":if(a=parseInt(e.ext),isNaN(a))return void(n&&n(new Error("night in value invalid")));switch(a){case 1:this._setNightIn1(n);break;case 2:this._setNightIn2(n);break;case 3:this._setNightIn3(n);break;default:n&&n(new Error("night in value out of range"));}break;case"nightOut":if(a=parseInt(e.ext),isNaN(a))return void(n&&n(new Error("night out value invalid")));switch(a){case 1:this._setNightOut1(n);break;case 2:this._setNightOut2(n);break;case 3:this._setNightOut3(n);break;default:n&&n(new Error("night out value out of range"));}break;case"resetFilter":this._resetFilter(calllback);break;case"resetError":this._resetError(calllback);}else n&&n(new Error("command value is empty"));},e.prototype.getStatesCreator=function(t,e,n){for(var a=this,r=function r(t,e,n){var r,o,s=[];switch(t){case"main":a.getMainStates(function(t,a){if(t)n(t);else{for(r=0;r<e.length;r++)if((o=e[r])&&o.id&&o.status)switch(o.status.value){case"tempIn":case"tempOut":case"humIn":case"humOut":case"sleepMode":s.push({id:o.id,status:a[o.status.value]});}n(null,s);}});break;case"general":a.getGeneralStates(function(t,a){if(t)n(t);else{for(r=0;r<e.length;r++)if((o=e[r])&&o.id&&o.status)switch(o.status.value){case"level":case"mode":case"stateNr":case"stateNrInt":case"error":case"errorNr":case"nightSpeed":case"filterReplace":case"logEntries":case"humidityNr":case"freezeNr":case"usageMode":case"nightModeState":s.push({id:o.id,status:a[o.status.value]});}n(null,s);}});break;case"ambients":a.getAmbientsStates(function(t,a){if(t)n(t);else{for(r=0;r<e.length;r++)if((o=e[r])&&o.id&&o.status)switch(o.status.value){case"temp1":case"temp2":case"temp3":case"temp4":case"hum1":case"hum2":s.push({id:o.id,status:a[o.status.value]});}n(null,s);}});break;case"filter":a.getFilterStates(function(t,a){if(t)n(t);else{for(r=0;r<e.length;r++)if((o=e[r])&&o.id&&o.status)switch(o.status.value){case"elapsed":case"remaining":s.push({id:o.id,status:a?a[o.status.value]:"?"});}n(null,s);}});break;case"fan":a.getFanStates(function(t,a){if(t)n(t);else{for(r=0;r<e.length;r++)if((o=e[r])&&o.id&&o.status)switch(o.status.value){case"targetRSIn":case"currentRSIn":case"targetRSOut":case"currentRSOut":case"maxRS":case"minRS":s.push({id:o.id,status:a?a[o.status.value]:"?"});}n(null,s);}});}},o=[],s=0;s<e.length;s++){var i=e[s];if(i&&i.id&&i.status&&i.status.value)switch(i.status.value){case"tempIn":case"tempOut":case"humIn":case"humOut":case"sleepMode":-1==o.indexOf("main")&&o.push("main");break;case"level":case"mode":case"stateNr":case"stateNrInt":case"error":case"errorNr":case"nightSpeed":case"filterReplace":case"logEntries":case"humidityNr":case"freezeNr":case"usageMode":case"nightModeState":-1==o.indexOf("general")&&o.push("general");break;case"temp1":case"temp2":case"temp3":case"temp4":case"hum1":case"hum2":-1==o.indexOf("ambients")&&o.push("ambients");break;case"elapsed":case"remaining":-1==o.indexOf("filter")&&o.push("filter");break;case"targetRSIn":case"currentRSIn":case"targetRSOut":case"currentRSOut":case"maxRS":case"minRS":-1==o.indexOf("fan")&&o.push("fan");}}if(0!=o.length){var u=0,l=[],c=function c(a,s){u++,!a&&s&&(l=l.concat(s),void 0!==t&&null!=t&&void 0!==t.reportStates&&null!=t.reportStates&&t.reportStates(null,s)),u<o.length?r(o[u],e,c):n&&n(null,l);};r(o[u],e,c);}else n&&n(null,[]);},e.prototype.getMainStates=function(t){var e=this;this._readMain(function(n,a){if(n)t&&t(n);else{var r=e._resolveMainStates(a);t&&t(null,r);}});},e.prototype._resolveMainStates=function(t){var e={};return e.tempIn=parseInt(t.TempIn)/100,e.tempOut=parseInt(t.TempOut)/100,e.humIn=parseInt(t.HumidityIn)/100,e.humOut=parseInt(t.HumidityOut)/100,e.sleepMode="yes"==t.SleepMode,e;},e.prototype.getGeneralStates=function(t){var e=this;this._readStatus(function(n,a){if(n)t&&t(n);else{var r=e._resolveGeneralStates(a);t&&t(null,r);}});},e.prototype._resolveGeneralStates=function(t){var e={};return e.stateNr=parseInt(t.StateNr),e.stateNr<=5?(e.level=e.stateNr,e.mode="MANUAL"):(e.level="",e.mode=t.State),10==e.stateNr?(e.error=t.Error,e.errorNr=t.ErrorNr):(e.error="",e.errorNr=""),7==e.stateNr||8==e.stateNr?e.nightSpeed=parseInt(t.NightSpeed):e.nightSpeed="",e.stateNrInt=parseInt(t.StateNrInternal),e.logEntries=parseInt(t.LOGEntries),e.filterReplace="yes"==t.ReplaceFilter,e.humidityNr=parseInt(t.StateOfHumidityNr),e.freezeNr=parseInt(t.StateOfFreezeNr),e.usageMode=parseInt(t.UsageMode),e.nightModeState=parseInt(t.NightModeState),e;},e.prototype.getAmbientsStates=function(t){var e=this;this._readAmbients(function(n,a){if(n)t&&t(n);else{var r=e._resolveAmbientsStates(a);t&&t(null,r);}});},e.prototype._resolveAmbientsStates=function(t){var e={};return e.temp1=parseInt(t.Temp1)/100,e.temp2=parseInt(t.Temp2)/100,e.temp3=parseInt(t.Temp3)/100,e.temp4=parseInt(t.Temp4)/100,e.hum1=parseInt(t.Humidity1)/100,e.hum2=parseInt(t.Humidity2)/100,e;},e.prototype.getFilterStates=function(e){var n=t.getFilterStates(this._ip);if(void 0!==n)return null!=n&&(n=this._resolveFilterStates(n)),void(e&&e(null,n));var a=this;this.readFilter(function(n,r){t.setFilterStates(a._ip,n?null:r);var o=a._resolveFilterStates(r);e&&e(null,o);});},e.prototype._resolveFilterStates=function(t){var e={};return e.elapsed=parseInt(t.Elapsed),e.remaining=parseInt(t.Remaining),e;},e.prototype.getFanStates=function(e){var n=t.getFanStates(this._ip);if(void 0!==n)return null!=n&&(n=this._resolveFanStates(n)),void(e&&e(null,n));var a=this;this.readFan(function(n,r){t.setFanStates(a._ip,n?null:r);var o=a._resolveFanStates(r);e&&e(null,o);});},e.prototype._resolveFanStates=function(t){var e={};return e.targetRSIn=parseInt(t.TargetRotationSpeedIN),e.currentRSIn=parseInt(t.ActualRotationSpeedIN),e.targetRSOut=parseInt(t.TargetRotationSpeedOUT),e.currentRSOut=parseInt(t.ActualRotationSpeedOUT),e.maxRS=parseInt(t.MaxRotationSpeed),e.minRS=parseInt(t.MinRotationSpeed),e;},e.prototype.configUdpServer=function(t,e,n){t||(t="255.255.255.255"),e||(e=1903);var a=this;this.setUdpServer(t,e,function(r){r?n&&n(r):(a._configUdpServerInterval&&clearInterval(a._configUdpServerInterval),a._configUdpServerInterval=setInterval(function(){a.setUdpServer(t,e);},6e5),n&&n());});},e.prototype.setStandBy=function(t){this._setStandBy(t);},e.prototype._setStandBy=function(t){this._doRequest("POST","/CommandSET_STANDBY.cmd",null,function(e){t&&t(e);});},e.prototype.setOn=function(t){this._setOn(t);},e.prototype._setOn=function(t){this._doRequest("POST","/CommandSET_ON.cmd",null,function(e){t&&t(e);});},e.prototype.setLevel1=function(t){this._setLevel1(t);},e.prototype._setLevel1=function(t){this._doRequest("POST","/CommandSET_LEVEL1.cmd",null,function(e){t&&t(e);});},e.prototype.setLevel2=function(t){this._setLevel2(t);},e.prototype._setLevel2=function(t){this._doRequest("POST","/CommandSET_LEVEL2.cmd",null,function(e){t&&t(e);});},e.prototype.setLevel3=function(t){this._setLevel3(t);},e.prototype._setLevel3=function(t){this._doRequest("POST","/CommandSET_LEVEL3.cmd",null,function(e){t&&t(e);});},e.prototype.setLevel4=function(t){this._setLevel4(t);},e.prototype._setLevel4=function(t){this._doRequest("POST","/CommandSET_LEVEL4.cmd",null,function(e){t&&t(e);});},e.prototype.setLevel5=function(t){this._setLevel5(t);},e.prototype._setLevel5=function(t){this._doRequest("POST","/CommandSET_LEVEL5.cmd",null,function(e){t&&t(e);});},e.prototype.setAutomatic=function(t){this._setAutomatic(t);},e.prototype._setAutomatic=function(t){this._doRequest("POST","/CommandSET_AUTOMATIC.cmd",null,function(e){t&&t(e);});},e.prototype.setManual=function(t){this._setManual(t);},e.prototype._setManual=function(t){this._doRequest("POST","/CommandSET_MANUAL.cmd",null,function(e){t&&t(e);});},e.prototype.setNextLevel=function(t){this._setNextLevel(t);},e.prototype._setNextLevel=function(t){this._doRequest("POST","/CommandSET_NEXT_LEVEL.cmd",null,function(e){t&&t(e);});},e.prototype.setPreviousLevel=function(t){this._setPreviousLevel(t);},e.prototype._setPreviousLevel=function(t){this._doRequest("POST","/CommandSET_PREV_LEVEL.cmd",null,function(e){t&&t(e);});},e.prototype.setNightIn1=function(t){this._setNightIn1(t);},e.prototype._setNightIn1=function(t){this._doRequest("POST","/CommandSET_N_IN1.cmd",null,function(e){t&&t(e);});},e.prototype.setNightIn2=function(t){this._setNightIn2(t);},e.prototype._setNightIn2=function(t){this._doRequest("POST","/CommandSET_N_IN2.cmd",null,function(e){t&&t(e);});},e.prototype.setNightIn3=function(t){this._setNightIn3(t);},e.prototype._setNightIn3=function(t){this._doRequest("POST","/CommandSET_N_IN3.cmd",null,function(e){t&&t(e);});},e.prototype.setNightOut1=function(t){this._setNightOut1(t);},e.prototype._setNightOut1=function(t){this._doRequest("POST","/CommandSET_N_OUT1.cmd",null,function(e){t&&t(e);});},e.prototype.setNightOut2=function(t){this._setNightOut2(t);},e.prototype._setNightOut2=function(t){this._doRequest("POST","/CommandSET_N_OUT2.cmd",null,function(e){t&&t(e);});},e.prototype.setNightOut3=function(t){this._setNightOut3(t);},e.prototype._setNightOut3=function(t){this._doRequest("POST","/CommandSET_N_OUT3.cmd",null,function(e){t&&t(e);});},e.prototype._resetFilter=function(t){this._doRequest("POST","/CommandRESET_FILTER.cmd",null,function(e){t&&t(e);});},e.prototype.readMainA=function(t){this._readMain(function(e,n){t&&t(e,n);});},e.prototype.readMainB=function(t){this._asyncRead("_readMainCallbacks","_cmdReadMain","_readMain",t);},e.prototype._cmdReadMain=function(t){this._doRequest("POST","/CommandREAD_MAIN.cmd",null,function(e){t&&t(e);});},e.prototype._readMain=function(t){this._doRequestXML("GET","/CmdResultREAD_MAIN.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_MAIN response invalid"));});},e.prototype.readStatus=function(t){this._readStatus(function(e,n){t&&t(e,n);});},e.prototype._readStatus=function(t){this._doRequestXML("GET","/CmdResultREAD_STATUS.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_STATUS response invalid"));});},e.prototype.readSoftware=function(t){this._readSoftware(function(e,n){t&&t(e,n);});},e.prototype._readSoftware=function(t){this._doRequestXML("GET","/CmdResultREAD_SOFTWARE.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_SOFTWARE response invalid"));});},e.prototype.readAmbientsA=function(t){this._readAmbients(function(e,n){t&&t(e,n);});},e.prototype.readAmbientsB=function(t){this._asyncRead("_readAmbientsCallbacks","_cmdReadAmbients","_readAmbients",t);},e.prototype._cmdReadAmbients=function(t){this._doRequest("POST","/CommandREAD_AMBIENTS.cmd",null,function(e){t&&t(e);});},e.prototype._readAmbients=function(t){this._doRequestXML("GET","/CmdResultREAD_AMBIENTS.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_AMBIENTS response invalid"));});},e.prototype.readFilter=function(t){this._asyncRead("_readFilterCallbacks","_cmdReadFilter","_readFilter",t);},e.prototype.readFilter2=function(t){this._readFilter(function(e,n){t&&t(e,n);});},e.prototype._cmdReadFilter=function(t){this._doRequest("GET","/CommandREAD_FILTER.cmd",null,function(e){t&&t(e);});},e.prototype._readFilter=function(t){this._doRequestXML("GET","/CmdResultREAD_FILTER.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_FILTER response invalid"));});},e.prototype.readLog=function(t,e){var n=this._readLogCallbacks.length;if(e&&-1==this._readLogCallbacks.indexOf(e)&&this._readLogCallbacks.push(e),0==n){var a=this,r=function r(t,e){var n=a._readLogCallbacks;a._readLogCallbacks=[];for(var r=0;r<n.length;r++)try{n[r](t,e);}catch(t){}};this._cmdParameterReadLog(t,function(e){if(e)r(e);else{var n=0,o=function o(e,s){e?r(e):"yes"!=s.ready?n>50?r(new Error("result not ready")):(n++,setTimeout(function(){a._readLog(t,o);},500)):r(null,s);};a._readLog(t,o);}});}},e.prototype._cmdParameterReadLog=function(t,e){this._doRequest("POST","/CommandPARAMETER_READ_LOG"+t+".cmd",null,function(t){e&&e(t);});},e.prototype._readLog=function(t,e){this._doRequestXML("GET","/CmdResultPARAMETER_READ_LOG"+t+".cmd",null,function(t,n){t?e&&e(t):n&&n.State?e&&e(null,n.State):e&&e(new Error("PARAMETER_READ_LOG response invalid"));});},e.prototype.readFan=function(t){this._asyncRead("_readFanCallbacks","_cmdReadFan","_readFan",t);},e.prototype._cmdReadFan=function(t){this._doRequest("POST","/CommandREAD_FAN.cmd",null,function(e){t&&t(e);});},e.prototype._readFan=function(t){this._doRequestXML("GET","/CmdResultREAD_FAN.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_FAN response invalid"));});},e.prototype.readWlanScan=function(t){this._asyncRead("_readWlanScanCallbacks","_cmdReadWlanScan","_readWlanScan",t);},e.prototype._cmdReadWlanScan=function(t){this._doRequest("POST","/CommandREAD_WLANSCAN.cmd",null,function(e){t&&t(e);});},e.prototype._readWlanScan=function(t){this._doRequestXML("GET","/CmdResultREAD_WLANSCAN.cmd",null,function(e,n){e?t&&t(e):n&&n.WiFi?t&&t(null,n.WiFi):t&&t(new Error("READ_WLANSCAN response invalid"));});},e.prototype.readIpMac=function(t){this._readIpMac(function(e,n){t&&t(e,n);});},e.prototype._readIpMac=function(t){this._doRequestXML("GET","/CmdResultREAD_IPMAC.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("CmdResultREAD_IPMAC.cmd response invalid"));});},e.prototype.readWifiSettings=function(t){this._readWifiSettings(function(e,n){t&&t(e,n);});},e.prototype._readWifiSettings=function(t){this._doRequestXML("GET","/CmdResultREAD_WIFISETTINGS.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_MAIN response invalid"));});},e.prototype.readSignal=function(t){this._readSignal(function(e,n){t&&t(e,n);});},e.prototype._readSignal=function(t){this._doRequestXML("GET","/CmdResultREAD_SIGNAL.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_SIGNAL response invalid"));});},e.prototype.readLED=function(t){this._readLED(function(e,n){t&&t(e,n);});},e.prototype._readLED=function(t){this._doRequestXML("GET","/CmdResultREAD_LED.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_LED response invalid"));});},e.prototype.readCommon=function(t){this._readCommon(function(e,n){t&&t(e,n);});},e.prototype._readCommon=function(t){this._doRequestXML("GET","/CmdResultREAD_COMMON.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_COMMON response invalid"));});},e.prototype.readCounter=function(t){this._asyncRead("_readCounterCallbacks","_cmdReadCounter","_readCounter",t);},e.prototype._cmdReadCounter=function(t){this._doRequest("GET","/CommandREAD_COUNTER.cmd",null,function(e){t&&t(e);});},e.prototype._readCounter=function(t){this._doRequestXML("GET","/CmdResultREAD_COUNTER.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_COUNTER response invalid"));});},e.prototype.readSerial=function(t){this._readSerial(function(e,n){t&&t(e,n);});},e.prototype._readSerial=function(t){this._doRequest("GET","/CmdResultREAD_SERIALNR.cmd",null,function(e,n){t&&t(e,n);});},e.prototype.readName=function(t){this._readName(function(e,n){t&&t(e,n);});},e.prototype._readName=function(t){this._doRequest("GET","/CmdResultREAD_NAME.cmd",null,function(e,n){t&&t(e,n);});},e.prototype.changeName=function(t,e){this._cmdParamChangeName(t,function(t){e&&e(t);});},e.prototype._cmdParamChangeName=function(t,e){this._doRequest("POST","/CommandPARAMETER_CHANGE_NAME"+t+".cmd",null,function(t){e&&e(t);});},e.prototype.setWlanOff=function(t,e){this._cmdParamWlanOff(t,function(t){e&&e(t);});},e.prototype._cmdParamWlanOff=function(t,e){this._doRequest("POST","/CommandPARAMETER_WLAN_OFF"+t+".cmd",null,function(t){e&&e(t);});},e.prototype.selectSTA=function(t,e,n){var a=this;this._cmdParamChooseWlanNet(t,function(t){t?n&&n(t):a._cmdParamChooseWlanPwd(e,function(t){t?n&&n(t):a._cmdSelectSTA(function(t){n&&n(t);});});});},e.prototype._cmdParamChooseWlanNet=function(t,e){this._doRequest("POST","/CommandPARAMETER_CHOOSEWLANNET"+t+".cmd",null,function(t){e&&e(t);});},e.prototype._cmdParamChooseWlanPwd=function(t,e){this._doRequest("POST","/CommandPARAMETER_CHOOSEWLANPWD"+t+".cmd",null,function(t){e&&e(t);});},e.prototype._cmdSelectSTA=function(t){this._doRequest("POST","/CommandSELECT_STA.cmd",null,function(e){t&&t(e);});},e.prototype.setLedTimeout=function(t,e){this._cmdParamLedTimeout(t,function(t){e&&e(t);});},e.prototype._cmdParamLedTimeout=function(t,e){this._doRequest("POST","/CommandPARAMETER_LED_TIMEOUT"+t+".cmd",null,function(t){e&&e(t);});},e.prototype.setLedIntensity=function(t,e){this._cmdParamLedIntensity(t,function(t){e&&e(t);});},e.prototype._cmdParamLedIntensity=function(t,e){this._doRequest("POST","/CommandPARAMETER_LED_INTENSITY"+t+".cmd",null,function(t){e&&e(t);});},e.prototype.setLedReverseDirection=function(t,e){this._cmdParamLedReverseDirection(t?"yes":"no",function(t){e&&e(t);});},e.prototype._cmdParamLedReverseDirection=function(t,e){this._doRequest("POST","/CommandPARAMETER_LED_REVERSE_DIRECTION"+t+".cmd",null,function(t){e&&e(t);});},e.prototype.setExtKeyActive=function(t,e){this._cmdParamExtkeyActive(t?"yes":"no",function(t){e&&e(t);});},e.prototype._cmdParamExtkeyActive=function(t,e){this._doRequest("POST","/CommandPARAMETER_EXTKEY_ACTIVE"+t+".cmd",null,function(t){e&&e(t);});},e.prototype.setUdpServer=function(t,e,n){this._cmdParamUdpServer(t,e,function(t){n&&n(t);});},e.prototype._cmdParamUdpServer=function(t,e,n){this._doRequest("POST","/CommandPARAMETER_UDP_SERVER"+t+":"+e+".cmd",null,function(t){n&&n(t);});},e.prototype.identify=function(t,e,n){this._cmdParamIdentify(t,e,function(t){n&&n(t);});},e.prototype._cmdParamIdentify=function(t,e,n){this._doRequest("POST","/CommandPARAMETER_IDENTIFY"+t+"_"+e+".cmd",null,function(t){n&&n(t);});},e.prototype.startTestRGBs=function(t,e){this._cmdParamTestRGBs(t,1,function(t){e&&e(t);});},e.prototype.stopTestRGBs=function(t){this._cmdParamTestRGBs("ffffff",0,function(e){t&&t(e);});},e.prototype._cmdParamTestRGBs=function(t,e,n){this._doRequest("POST","/CommandPARAMETER_TESTRGBS"+t+"_"+e+".cmd",null,function(t){n&&n(t);});},e.prototype.resetError=function(t){this._resetError(function(e){t&&t(e);});},e.prototype._resetError=function(t){this._doRequest("POST","/CommandRESET_ERROR.cmd",null,function(e){t&&t(e);});},e.prototype.quitError=function(t){this._cmdQuitError(function(e){t&&t(e);});},e.prototype._cmdQuitError=function(t){this._doRequest("POST","/CommandQUIT_ERROR.cmd",null,function(e){t&&t(e);});},e.prototype.restart=function(t){this._cmdRestart(function(e){t&&t(e);});},e.prototype._cmdRestart=function(t){this._doRequest("POST","/CommandRESTART.cmd",null,function(e){t&&t(e);});},e.prototype.resetWlan=function(t){this._cmdResetWlan(function(e){t&&t(e);});},e.prototype._cmdResetWlan=function(t){this._doRequest("POST","/CommandRESET_WLAN.cmd",null,function(e){t&&t(e);});},e.prototype.resetData=function(t){this._cmdResetData(function(e){t&&t(e);});},e.prototype._cmdResetData=function(t){this._doRequest("POST","/CommandRESET_DATA.cmd",null,function(e){t&&t(e);});},e.prototype.saveStampStartup=function(t,e){var n=t.getFullYear()+"";n=n.substr(2,2);var a=t.getMonth()+1+"";a.length<2&&(a="0"+a);var r=t.getDate()+"";r.length<2&&(r="0"+r);var o=t.getHours()+"";o.length<2&&(o="0"+o);var s=t.getMinutes()+"";s.length<2&&(s="0"+s),this._cmdParamStampStartup(n,a,r,o,s,function(t){e&&e(t);});},e.prototype._cmdParamStampStartup=function(t,e,n,a,r,o){this._doRequest("POST","/CommandPARAMETER_STAMP_STARTUP"+t+e+n+a+r+".cmd",null,function(t){o&&o(t);});},e.prototype.changeAPPwd=function(t,e){this._cmdParamChangeAppwd(t,function(t){e&&e(t);});},e.prototype._cmdParamChangeAppwd=function(t,e){this._doRequest("POST","/CommandPARAMETER_CHANGE_APPWD"+t+".cmd",null,function(t){e&&e(t);});},e.prototype._asyncRead=function(t,e,n,a){var r=this[t].length;if(a&&-1==this[t].indexOf(a)&&this[t].push(a),0==r){var o=this,s=function s(e,n){var a=o[t];o[t]=[];for(var r=0;r<a.length;r++)try{a[r](e,n);}catch(t){}};this[e](function(t){if(t)s(t);else{var e=0,a=function a(t,r){t?s(t):"yes"!=r.ready?e>50?s(new Error("result not ready")):(e++,setTimeout(function(){o[n](a);},500)):s(null,r);};o[n](a);}});}},e.prototype._doRequestXML=function(t,e,n,a){var r=this;this._doRequest(t,e,n,function(t,e){if(t)a&&a(t);else{var n=null;e&&(n=r._xml2json(e))&&n["?xml-stylesheet"]&&(n=n["?xml-stylesheet"]),a&&a(null,n);}});},e.prototype._xml2json=function(t){var e=function e(t){var n={};return t.children().each(function(){var t,a=$(this),r=a.prop("tagName");t=0==a.children().length?a.text():e(a);var o=n[r];void 0===o||null==o?n[r]=t:Array.isArray(o)?o.push(t):n[r]=[o,t];}),n;};try{var n,a=$($.parseXML(t));if(!(n=a.getRootNode?a.getRootNode():$(a.children()[0])))return null;var r=n.prop("tagName"),o=e(n),s={};return s[r]=o,s;}catch(t){return null;}},e.prototype._doRequest=function(t,e,n,a){var r=this._httpReqBuffer.length;this._httpReqBuffer.push({method:t,path:e,data:n,callback:a}),0==r&&this._doNextHttpReq();},e.prototype._doNextHttpReq=function(){if(0!=this._httpReqBuffer.length){var t=this._httpReqBuffer[0],e=this;this._doRequestHttp(t.method,t.path,t.data,function(n,a){t.callback&&t.callback(n,a),e._httpReqBuffer.splice(0,1),e._doNextHttpReq();});}},e.prototype._doRequestHttp=function(t,e,n,a){var r="https://"+this._ip+":"+this._port+e;this._logger.log("trace","send "+t+" to url: "+r+" data:"+n);var o={host:this._ip,port:this._port,path:e,method:t,headers:{}};(this._username||this._password)&&(o.auth=(this._username?this._username:"")+":"+(this._password?this._password:""),o.headers.Authorization="Basic "+new Buffer((this._username?this._username:"")+":"+(this._password?this._password:"")).toString("base64"));var s=this,i=a,u=require("https");"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0",o.agent=this._keepAliveAgent);var l=u.request(o,function(t){t.setEncoding("utf-8");var e="";t.on("data",function(t){e+=t;}),t.on("end",function(){if(s._logger.log("trace",r+" response "+t.statusCode+": "+e),200==t.statusCode)i&&i(null,e);else{var n=new Error("http response "+t.statusCode);i&&i(n);}i=null;});});l.setTimeout(this._timeout,function(){s._logger.log("trace","http request "+r+" timeout"),i&&(i(new Error("http request timeout")),i=null),l.abort();}),l.on("error",function(t){s._logger.log("trace","http request "+r+" error:"+t.message),i&&(i(t),i=null);}),n&&l.write(n),l.end();},e.prototype._doRequestAjax=function(t,e,n,a){var r=this,o="http://"+this._ip+":"+this._port+e;this._logger.log("trace","send "+t+" to url:"+o+" data:"+n);var s=a;$.ajax({url:o,type:t,timeout:this._timeout,data:n,dataType:"text",cache:!1,username:this._username,password:this._password,success:function success(t){r._logger.log("trace","http request success:"+t),s&&(s(null,t),s=null);},error:function error(t,e){var n="http request error:"+(t?t.status:"0")+"-"+e;r._logger.log("trace",n),s&&(s(new Error(n)),s=null);}});},e.prototype.toJSON=function(){return{sys:"gealan",ip:this._ip,port:this._port,username:this._username,password:this._password};},e.prototype.equalsTo=function(t){return!!t&&t instanceof e&&this._ip==t._ip&&this._port==t._port;},e.parseJSON=function(t){return t&&t.ip?new e(t.ip,t.port,t.username,t.password):null;},e;}(),xnm.aio.gealan.UdpListener=function(){var t=function t(_t){this._logger=require("x.logger.js").getLogger("xnm.aio.gealan.EventListener"),this._port=_t,this._port||(this._port=1903),this._state=0,this._socket=null,this._callbacks=[],this._listeners=[];};return t.prototype.start=function(t){if(2!=this._state){if(1!=this._state){var e=this;this._state=1,this._logger.log("debug","start listen to port "+this._port),this._startUdpListener(this._port,function(t,n){t?(e._state=0,e._logger.log("debug","failed to listen to port "+e._port+":"+t.message)):(e._state=2,e._socket=n,e._logger.log("debug","listen to port "+e._port+" success"));var a=e._callbacks;e._callbacks=[];for(var r=0;r<a.length;r++)a[r](t);});}else t&&-1==this._callbacks.indexOf(t)&&this._callbacks.push(t);}else t&&t();},t.prototype.stop=function(t){if(0!=this._state){if(1==this._state)return this._socket&&(this._socket.close(),this._socket=null),this._state=0,void(t&&t());this._socket&&(this._socket.close(),this._socket=null),this._state=0,t&&t();}else t&&t();},t.prototype.addListener=function(t){t&&-1==this._listeners.indexOf(t)&&this._listeners.push(t);},t.prototype.removeListener=function(t){if(t){var e=this._listeners.indexOf(t);-1!=e&&this._listeners.splice(e,1);}},t.prototype._startUdpListener=function(t,e){var n=this,a=e,r=require("dgram").createSocket({type:"udp4",reuseAddr:!0});r.on("listening",function(){r.setBroadcast&&r.setBroadcast(!0),n._logger.log("trace","udp listener started at port:"+t),a&&(a(null,r),a=null);}),r.on("error",function(e){a?(n._logger.log("trace","bind udp listener at port:"+t+" error:"+e.stack),a(e),a=null):(n._logger.log("trace","udp listener at port:"+t+" error:"+e.stack),n.stop());}),r.on("message",function(e,a){var r=e.toString();n._logger.log("trace","receive udp message at port:"+t+" from:"+a.address+" data:"+r);var o,s=r.split(" ");o="Status"==s[0]&&"changed"==s[1]?{key:"Status changed",value:s[2]}:"new"==s[0]&&"IP"==s[1]?{key:"new IP",value:s[2]}:{key:s[0],value:s[1]};for(var i=0;i<n._listeners.length;i++)try{n._listeners[i](o,a);}catch(t){}}),r.bind(t);},t;}(),xnm.aio.gealan.DM=function(){var t={command:[{type:"int",name:"set level",ref:{value:"setLevel",ext:"%d",extMeta:"0-5"}},{type:"enum",name:"automatic",ref:{value:"automatic"}},{type:"enum",name:"manual",ref:{value:"manual"}},{type:"enum",name:"next level",ref:{value:"nextLevel"}},{type:"enum",name:"previous level",ref:{value:"previousLevel"}},{type:"enum",name:"reset filter",ref:{value:"resetFilter"}},{type:"enum",name:"reset error",ref:{value:"resetError"}}],status:[{type:"int",name:"temperature inside",ref:{value:"tempIn",ext:"%d"}},{type:"int",name:"temperature outside",ref:{value:"tempOut",ext:"%d"}},{type:"int",name:"humidity inside",ref:{value:"humIn",ext:"%d"}},{type:"int",name:"humidity outside",ref:{value:"humOut",ext:"%d"}},{type:"int",name:"level",ref:{value:"level",ext:"%d",extMeta:"0-5"}},{type:"enum",name:"mode",ref:{value:"mode",options:["MANUAL","AUTOMATIC","NIGHT_IN","NIGHT_OUT","FLAP_CLOSED","ERROR","FROST_PROTECTION","MOISTURE_PROTECTION"]}},{type:"int",name:"state no.",ref:{value:"stateNr",ext:"%d",extMeta:"0-12"}},{type:"int",name:"state no. (internal)",ref:{value:"stateNrInt",ext:"%d"}},{type:"string",name:"error message",ref:{value:"error",ext:"%s"}},{type:"int",name:"error no.",ref:{value:"errorNr",ext:"%d"}},{type:"int",name:"night speed",ref:{value:"nightSpeed",ext:"%d",extMeta:"1-3"}},{type:"enum",name:"replace filter",ref:{value:"filterReplace",options:["true","false"]}},{type:"enum",name:"sleep mode",ref:{value:"sleepMode",options:["true","false"]}},{type:"int",name:"log entries",ref:{value:"logEntries",ext:"%d"}},{type:"int",name:"humidity no.",ref:{value:"humidityNr",ext:"%d"}},{type:"int",name:"freeze no.",ref:{value:"freezeNr",ext:"%d"}},{type:"int",name:"usage mode",ref:{value:"usageMode",ext:"%d"}},{type:"int",name:"night mode state",ref:{value:"nightModeState",ext:"%d"}},{type:"int",name:"temperature exhaust air (outside)",ref:{value:"temp1",ext:"%d"}},{type:"int",name:"temperature supply air (inside)",ref:{value:"temp2",ext:"%d"}},{type:"int",name:"temperature supply air (outside)",ref:{value:"temp3",ext:"%d"}},{type:"int",name:"temperature exhaust air (inside)",ref:{value:"temp4",ext:"%d"}},{type:"int",name:"humidity supply air (outside)",ref:{value:"hum1",ext:"%d"}},{type:"int",name:"humidity exhaust air (inside)",ref:{value:"hum2",ext:"%d"}},{type:"int",name:"filter elapsed time",ref:{value:"elapsed",ext:"%d"}},{type:"int",name:"filter remaining time",ref:{value:"remaining",ext:"%d"}},{type:"int",name:"target rotation speed in",ref:{value:"targetRSIn",ext:"%d"}},{type:"int",name:"actual rotation speed in",ref:{value:"currentRSIn",ext:"%d"}},{type:"int",name:"target rotation speed out",ref:{value:"targetRSOut",ext:"%d"}},{type:"int",name:"actual rotation speed out",ref:{value:"currentRSOut",ext:"%d"}},{type:"int",name:"max rotation speed",ref:{value:"maxRS",ext:"%d"}},{type:"int",name:"min rotation speed",ref:{value:"minRS",ext:"%d"}}]},e=function e(t,_e2){this.code=t,this.message=_e2,this.stack=new Error().stack;};return(e.prototype=new Error()).name="GealanDMError",e.prototype.code=0,e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"gealan",getIPDeviceType:function getIPDeviceType(){return[{sys:this.SYS,name:"Gealan Fan"}];},createDevice:function createDevice(t,n,a){var r=e,o=e.ERROR_CODE;t?t.type?t.ip?a(null,t):a(new r(o.INVALID,"ip is invalid")):a(new r(o.INVALID,"type is invalid")):a(new r(o.INVALID,"info is invalid"));},updateDevice:function updateDevice(t,n,a){var r=e,o=e.ERROR_CODE;t?t.type?t.ip?a(null,t):a(new r(o.INVALID,"ip is invalid")):a(new r(o.INVALID,"type is invalid")):a(new r(o.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(t,e,n){n();},applyUIFilter:function applyUIFilter(t,e,n){var a=this,r=function r(t,e){if("*"==t)return!0;for(var n=!1,a=0;a<t.length;a++)if(t[a]==e){n=!0;break;}return n;},o=function o(t,e){var o=[],s=null,i=a.getCommandStatusMap(t,n);return i&&(s=function(t,e,n){var a=[];switch(n.catagory){case"command":t.command&&t.command.forEach(function(t){if(r(n.elems,t.type)){var e=JSON.parse(JSON.stringify(t));a.push(e);}});break;case"status":t.status&&t.status.forEach(function(t){if(r(n.elems,t.type)){var e=JSON.parse(JSON.stringify(t));a.push(e);}});}return a;}(i,0,e),o=o.concat(s)),o;};if(!t.sys)return null;var s=JSON.parse(JSON.stringify(t)),i=null;switch(e.catagory){case"command":i=o(t,e),s.command=i;break;case"status":i=o(t,e),s.status=i;break;default:return null;}return i&&0!=i.length?s:null;},getCommandStatusMap:function getCommandStatusMap(e,n){return t;}};}(),xnm.aio.gealan.Handler=function(){var t=function t(){this._udpListener=new xnm.aio.gealan.UdpListener(1903);};return t.prototype.devicemanager=xnm.aio.gealan.DM,t.prototype.Fan=xnm.aio.gealan.Fan,t.prototype.registModule=function(t){t.register("gealan","gealan");},t.prototype.resolveDevice=function(t){return this.Fan.parseJSON(t);},t.prototype.getDeviceCommands=function(t,e){var n=this.devicemanager.applyUIFilter(t,{catagory:"command",elems:"*"}),a=n?n.command:[];e&&e(null,a);},t.prototype.getDeviceStatus=function(t,e){var n=this.devicemanager.applyUIFilter(t,{catagory:"status",elems:"*"}),a=n?n.status:[];e&&e(null,a);},t.prototype.doCommand=function(t,e,n){var a=this.resolveDevice(t);a?a.executeCommandCreator(t,e,function(t){n&&n(t);}):n&&n(new Error("device json format invalid"));},t.prototype.doStatus=function(t,e,n,a){var r=this.resolveDevice(e);if(r){var o=[{id:t,device:e,status:n}];r.getStatesCreator(null,o,function(t,e){t?a&&a(t):a&&a(null,e[0]);});}else a&&a(new Error("device json format invalid"));},t.prototype.getUdpListener=function(){return this._udpListener;},t;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.gealan.Handler());