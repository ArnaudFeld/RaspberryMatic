var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,c,d){a instanceof String&&(a=String(a));for(var b=a.length,e=0;e<b;e++){var f=a[e];if(c.call(d,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,d){a!=Array.prototype&&a!=Object.prototype&&(a[c]=d.value)};$jscomp.getGlobal=function(a){a=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,a];for(var c=0;c<a.length;++c){var d=a[c];if(d&&d.Math==Math)return d}return globalThis};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(a,c,d,b){if(c){d=$jscomp.global;a=a.split(".");for(b=0;b<a.length-1;b++){var e=a[b];e in d||(d[e]={});d=d[e]}a=a[a.length-1];b=d[a];c=c(b);c!=b&&null!=c&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:c})}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,d){return $jscomp.findInternal(this,a,d).v}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.fritz=xnm.aio.fritz||{};
xnm.aio.fritz.SessionCache={_cache:{},STATE_TO:5E3,setSessionID:function(a,c){if(a){var d=this._cache[a];d||(this._cache[a]={},d=this._cache[a]);d.sessionID=c}},getSessionID:function(a){return a?this._cache[a]?this._cache[a].sessionID:null:null}};
xnm.aio.fritz.Box=function(a,c,d,b){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.fritz.Box");this.ip=a;this.port=b;this.protocol="http";a&&"http://"==a.substr(0,7)?this.ip=a.substr(7):a&&"https://"==a.substr(0,8)&&(this.ip=a.substr(8),this.protocol="https");this.port||(this.port="https"==this.protocol?443:80);this.password=c;this.user="";d&&(this.user=d);this.CommandHandler=null};
xnm.aio.fritz.Box.prototype._doRequest=function(a,c){if("https"==this.protocol)this._doRequest2(a,c);else{var d=this;a=this.protocol+"://"+this.ip+":"+this.port+a;this._cachedSessionID()&&(a+="&sid="+this._cachedSessionID());this._logger.log("trace","send req to url:"+a);var b=c;$.ajax({url:a,type:"GET",timeout:4E3,dataType:"text",success:function(a){d._logger.log("trace","http request success:"+a);b&&(b(null,a,200),b=null)},error:function(a,c){c="http request error:"+(a?a.status:"0")+"-"+c;d._logger.log("trace",
c);b&&(b(Error(c),a?a.responseText:null,a?a.status:null),b=null)}})}};
xnm.aio.fritz.Box.prototype._doRequest2=function(a,c){var d=this;this._cachedSessionID()&&(a+="&sid="+this._cachedSessionID());var b=c;c={host:this.ip,port:this.port,path:a,method:"GET"};this._logger.log("trace","send ("+this.protocol+") req to:"+JSON.stringify(c));var e="";a=require("http");"https"==this.protocol&&(a=require("https"),"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),c.port||(c.port=443));var f=a.request(c,function(a){a.on("data",
function(a){e+=a});a.on("end",function(){var c=null;200==a.statusCode?d._logger.log("trace","http request success:"+e):(d._logger.log("trace","http request error:"+a.statusCode+"-"+e),c=Error("request failed with status code:"+a.statusCode));b&&b(c,e,a.statusCode);b=null})});f.setTimeout&&f.setTimeout(6E4,function(){f.abort()});if(f.on&&"function"==typeof f.on)f.on("error",function(a){a||(a=Error("http request error"));d._logger.log("trace","http request error:"+a.message);b&&b(a);b=null});f.end()};
xnm.aio.fritz.Box.prototype._sendRequest=function(a,c){var d=this;this._doRequest(a,function(b,e,f){b&&403==f?(d._setSessionID(null),d._getSessionID(function(b,e){b?(d._logger.log("trace","create new session error:"+b.message),c&&c(b)):(d._setSessionID(e),d._sendRequest(a,c))})):c&&c(b,e)})};xnm.aio.fritz.Box.prototype._setSessionID=function(a){return xnm.aio.fritz.SessionCache.setSessionID(this.ip,a)};xnm.aio.fritz.Box.prototype._cachedSessionID=function(){return xnm.aio.fritz.SessionCache.getSessionID(this.ip)};
xnm.aio.fritz.Box.prototype._getSessionID=function(a){var c=this;this._logger.log("trace","create new session");this._doRequest("/login_sid.lua",function(d,b){if(d)a&&a(d);else try{var e=$($.parseXML(b));if(e){var f=null;d=null;var g=e.find("SID");g&&(f=$(g[0]).text());(g=e.find("Challenge"))&&(d=$(g[0]).text());if("0000000000000000"!=f)a&&a(null,f);else if(d){f=null;var h=require("x.crypt.js"),k=d+"-"+h.MD5(d+"-"+c.password,!0);c._doRequest("/login_sid.lua?username="+c.user+"&response="+k,function(b,
c){if(b)a&&a(b);else try{var d=$($.parseXML(c));if(d){var e=d.find("SID");e&&(f=$(e[0]).text());"0000000000000000"==f&&(f=null)}f||(b=Error("session challenge fail"));a&&a(b,f)}catch(m){a&&a(m)}})}}}catch(l){a&&a(l)}})};xnm.aio.fritz.Box.prototype.getDevices=function(a){this._sendRequest("/webservices/homeautoswitch.lua?switchcmd=getswitchlist",function(c,d){var b=[];if(!c&&d)for(b=d.split(","),c=0;c<b.length;c++)b[c]=$.trim(b[c]);a&&a(b)})};
xnm.aio.fritz.Box.prototype.getDevices2=function(a){this._sendRequest("/webservices/homeautoswitch.lua?switchcmd=getdevicelistinfos",function(c,d){var b=[];!c&&d&&(c=$($.parseXML(d)),c.find("device").each(function(){var a=$(this),c=a.attr("identifier");if(c){var d=a.find("name"),h="";d&&d[0]&&(h=$(d[0]).text());c=c.replace(" ","");d=a.attr("productname");a=a.attr("functionbitmask");var k="Comet DECT"==d?"thermo":"switch";c={sys:"fritz",name:h,type:"fritz_dect",typeName:d,bitmask:parseInt(a),address:c,
data:k};b.push(c)}}),c.find("group").each(function(){var a=$(this),c=a.attr("identifier");if(c){var d=a.find("name"),h="";d&&d[0]&&(h=$(d[0]).text());c=c.replace(" ","");(d=a.attr("productname"))||(d="Group");a=a.attr("functionbitmask");c={sys:"fritz",name:h,type:"fritz_dect",typeName:d,bitmask:parseInt(a),address:c,data:"group"};b.push(c)}}));a&&a(b)})};
xnm.aio.fritz.Box.prototype.getState=function(a,c){var d=this;this._sendRequest("/webservices/homeautoswitch.lua?ain="+a.address+"&switchcmd=getswitchstate",function(b,e){var f={state:"?",current:"?"};!b&&e&&(e=$.trim(e),"0"==e?f.state="off":"1"==e&&(f.state="on"));d._sendRequest("/webservices/homeautoswitch.lua?ain="+a.address+"&switchcmd=getswitchpower",function(b,e){!b&&e&&(e=$.trim(e),f.current=(parseFloat(e)/1E3).toFixed(1));if(d.CommandHandler&&d.CommandHandler.setState){b=d.getStateValues(a.subtype,
f);for(var g in b)"state"==g?d.CommandHandler.setState(a.id,b[g]):d.CommandHandler.setState(a.id+":"+g,b[g])}else d.CommandHandler&&d.CommandHandler.receivedState&&d.CommandHandler.receivedState("fritz",a.address,f);c&&c(f)})})};
xnm.aio.fritz.Box.prototype.getState2=function(a){var c=this;c._sendRequest("/webservices/homeautoswitch.lua?switchcmd=getdevicelistinfos",function(d,b){var e={};!d&&b&&(b=$($.parseXML(b)),b.find("device").each(function(){var a=$(this),b=a.attr("identifier");b&&(b=b.replace(" ",""),(a=c._parseState2(a))&&(e[b]=a))}),b.find("group").each(function(){var a=$(this),b=a.attr("identifier");b&&(a=c._parseState2(a))&&(e[b]=a)}));a&&a(d,e)})};
xnm.aio.fritz.Box.prototype._parseState2=function(a){var c={},d=!1,b,e=a.find("present");if(e&&e[0])switch(d=!0,e=$(e[0]).text(),e){case "1":c.connected="true";break;case "0":c.connected="false";break;default:c.connected="?"}if((e=a.find("switch"))&&e[0]){d=!0;if((b=$(e[0]).find("state"))&&b[0])switch(b=$(b[0]).text(),b){case "1":c.state="on";break;case "0":c.state="off";break;default:c.state="?"}if((b=$(e[0]).find("mode"))&&b[0])switch(b=$(b[0]).text(),b){case "auto":c.switchMode="auto";break;case "manuell":c.switchMode=
"manu";break;default:c.switchMode="?"}}(e=a.find("powermeter"))&&e[0]&&(d=!0,(b=$(e[0]).find("power"))&&b[0]&&(b=$(b[0]).text(),c.current=b?(parseInt(b)/1E3).toFixed(2):"?"),(b=$(e[0]).find("energy"))&&b[0]&&(b=$(b[0]).text(),c.energy=b?parseInt(b):"?"));(e=a.find("temperature"))&&e[0]&&(d=!0,(b=$(e[0]).find("celsius"))&&b[0]&&(b=$(b[0]).text(),c.tempC=b?(parseInt(b)/10).toFixed(1):"?"));(e=a.find("hkr"))&&e[0]&&(d=!0,(b=$(e[0]).find("tsoll"))&&b[0]&&((b=$(b[0]).text())?(b=parseInt(b),c.temp=254==
b?28.5:253==b?7.5:(b/2).toFixed(1)):c.temp="?"),(b=$(e[0]).find("komfort"))&&b[0]&&((b=$(b[0]).text())?(b=parseInt(b),c.comfort=254==b?28.5:253==b?7.5:(b/2).toFixed(1)):c.comfort="?"),(b=$(e[0]).find("absenk"))&&b[0]&&((b=$(b[0]).text())?(b=parseInt(b),c.absenk=254==b?28.5:253==b?7.5:(b/2).toFixed(1)):c.absenk="?"),(b=$(e[0]).find("batterylow"))&&b[0]&&((b=$(b[0]).text())?(b=parseInt(b),c.batlow=1==b?!0:!1):c.batlow="?"),(b=$(e[0]).find("battery"))&&b[0]&&((b=$(b[0]).text())?(b=parseInt(b),c.battery=
b):c.battery="?"));return d?c:null};
xnm.aio.fritz.Box.prototype.executeCommand=function(a,c,d){switch(c){case "on":var b="setswitchon";break;case "off":b="setswitchoff";break;case "toggle":b="setswitchtoggle";break;case "thermoOn":b="sethkrtsoll&param=254";break;case "thermoOff":b="sethkrtsoll&param=253";break;default:0==c.indexOf("temp")&&(b=c.replace("temp",""),b=parseFloat(b),b=7.5>=b||253==b?"sethkrtsoll&param=253":28.5<=b||254==b?"sethkrtsoll&param=254":"sethkrtsoll&param="+2*b)}b?this._sendRequest("/webservices/homeautoswitch.lua?ain="+a.address+
"&switchcmd="+b,function(a){d&&setTimeout(function(){d(a)},250)}):d&&d(Error("no such command "+c))};xnm.aio.fritz.Box.prototype.getStates=function(a,c){this.CommandHandler=a;for(a=0;a<c.length;a++)this.getState(c[a])};xnm.aio.fritz.Box.prototype.getStateValues=function(a,c){return c};xnm.aio.fritz.Box.prototype.getDeviceName=function(a,c){this._logger.log("trace","get device name:"+a);this._sendRequest("/webservices/homeautoswitch.lua?ain="+a+"&switchcmd=getswitchname",function(a,b){c&&c(a,b)})};
xnm.aio.fritz.Box.prototype.executeCommandCreator=function(a,c,d){if(a&&a.address&&c&&c.value){var b=c.value;if("temp"==c.value){if(!c.ext){d&&d(Error("parameter ext invalid"));return}b+=c.ext}this.executeCommand(a,b,function(){d&&d()})}else d&&d(Error("parameter invalid"))};
xnm.aio.fritz.Box.prototype.getStatesCreator=function(a,c,d){c?0==c.length?d&&d(null,[]):this.getState2(function(a,e){if(a)d&&d(a);else{a=[];for(var b=0;b<c.length;b++)if(c[b]&&c[b].id){var g="?";c[b].device&&c[b].device.address&&c[b].status&&c[b].status.value&&e&&e[c[b].device.address]&&(g=e[c[b].device.address][c[b].status.value],"undefined"==typeof g||null==g)&&(g="?");a.push({id:c[b].id,status:g})}d&&d(null,a)}}):d&&d(Error("deviceList is null"))};
xnm.aio.fritz.Box.prototype.toJSON=function(){return{sys:"fritz",ip:this.ip,port:this.port,username:this.user,password:this.password}};xnm.aio.fritz.Box.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.fritz.Box?this.protocol==a.protocol&&this.ip==a.ip&&this.port==a.port&&this.user==a.user&&this.password==a.password:!1};
xnm.aio.fritz.DM=function(){var a=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};a.prototype=Error();a.prototype.name="FritzDMError";a.prototype.code=0;a.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var c={fritz_dect:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},
{type:"float",name:"current power",ref:{value:"current"}}]},hkr:{command:[{type:"float",name:"set temperature",ref:{value:"temp",ext:"%f",extMeta:"7.5-28.5",scale:"0.5"}},{type:"enum",name:"thermostat on",ref:{value:"thermoOn"}},{type:"enum",name:"thermostat off",ref:{value:"thermoOff"}}],status:[{type:"float",name:"set temperature",ref:{value:"temp",ext:"%f",extMeta:"7.5-28.5",scale:"0.5"}},{type:"float",name:"comfort temperature",ref:{value:"comfort",ext:"%f",extMeta:"7.5-28.5",scale:"0.5"}},{type:"float",
name:"spar temperature",ref:{value:"absenk",ext:"%f",extMeta:"7.5-28.5",scale:"0.5"}},{type:"enum",name:"battery low",ref:{value:"batlow",options:["true","false"]}}]},temp:{status:[{type:"float",name:"current temperature",ref:{value:"tempC",scale:"0.1"}}]},powermeter:{status:[{type:"float",name:"energy",ref:{value:"energy"}},{type:"float",name:"current power",ref:{value:"current"}}]},"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",
name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"enum",name:"switch mode",ref:{value:"switchMode",options:["auto","manu"]}}]},error:{status:[{type:"enum",name:"connected",ref:{value:"connected",options:["true","false"]}}]}};return{SYS:"fritz",getGatewayType:function(){return[{sys:this.SYS,name:"FRITZ!Box",port:80}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"fritz_dect",name:"FRITZ! Smart Home"}]},createGateway:function(c,
b,e){b=a.ERROR_CODE;c?c.ip?e(null,c):e(new a(b.INVALID,"ip is invalid")):e(new a(b.INVALID,"info is invalid"))},updateGateway:function(c,b,e,f){c=a.ERROR_CODE;b?b.ip?f(null,b):f(new a(c.INVALID,"ip is invalid")):f(new a(c.INVALID,"update is invalid"))},deleteGateway:function(a,b,c){c()},createDevice:function(c,b,e){var d=a.ERROR_CODE;if(c)if(c.gateway)if(null==c.address||"undefined"==typeof c.address)e(new a(d.INVALID,"address is invalid"));else if(null==c.type||"undefined"==typeof c.type)e(new a(d.INVALID,
"type is invalid"));else if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var g;for(g=0;g<b.length;g++)if(b[g].index===c.gateway){var h=b[g];break}h?e(null,c):e(new a(d.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else e(new a(d.NOT_FOUND,"gateway with index "+c.gateway+" not exists"));else e(new a(d.INVALID,"gateway is invalid"));else e(new a(d.INVALID,"info is invalid"))},updateDevice:function(c,b,e){var d=a.ERROR_CODE;if(c)if(c.gateway)if(null==c.address||
"undefined"==typeof c.address)e(new a(d.INVALID,"address is invalid"));else if(null==c.type||"undefined"==typeof c.type)e(new a(d.INVALID,"type is invalid"));else if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var g;for(g=0;g<b.length;g++)if(b[g].index===c.gateway){var h=b[g];break}h?e(null,c):e(new a(d.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else e(new a(d.NOT_FOUND,"gateway with index "+c.gateway+" not exists"));else e(new a(d.INVALID,"gateway is invalid"));
else e(new a(d.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){c()},applyUIFilter:function(a,b){var c=this,d=function(a,b,c){var e=[];a.forEach(function(a){if("root"==a.type){a=JSON.parse(JSON.stringify(a));var f=d(a.children,b,c);f&&0<f.length&&(a.children=f,e.push(a))}else{f=c.elems;if("*"==f)f=!0;else{for(var g=!1,h=0;h<f.length;h++)if(f[h]==a.type){g=!0;break}f=g}f&&(a=JSON.parse(JSON.stringify(a)),e.push(a))}});return e},g=function(a,b){var e=[],f=c.getCommandStatusMap(a);if(f){var g=
[];switch(b.catagory){case "command":f.command&&(g=d(f.command,a,b));break;case "status":f.status&&(g=d(f.status,a,b))}e=e.concat(g)}return e};if(!a.sys)return null;var h=JSON.parse(JSON.stringify(a)),k=null;switch(b.catagory){case "command":k=g(a,b);h.command=k;break;case "status":k=g(a,b);h.status=k;break;default:return null}return k&&0!=k.length?h:null},getCommandStatusMap:function(a){if(!a||!a.type)return null;var b=parseInt(a.bitmask),d=[];b?(b&64&&d.push("hkr"),b&128&&d.push("powermeter"),b&
256&&d.push("temp"),b&512&&d.push("switch")):d.push(a.type);if(0==d.length)return null;var f={command:[],status:[]};d.forEach(function(a){c[a]&&(c[a].command&&(f.command=f.command.concat(c[a].command)),c[a].status&&(f.status=f.status.concat(c[a].status)))});if(0<f.command.length||0<f.status.length)f.status=f.status.concat(c.error.status);return f}}}();xnm.aio.fritz.Handler=function(){};xnm.aio.fritz.Handler.prototype.Box=xnm.aio.fritz.Box;
xnm.aio.fritz.Handler.prototype.getStateValues=function(a,c){return(new xnm.aio.fritz.Box).getStateValues(a.type,c)};xnm.aio.fritz.Handler.prototype.getDeviceCommandList=function(a,c){a=[];a.push({id:window.XC_Text.on,cmd:"on"});a.push({id:window.XC_Text.off,cmd:"off"});return a};xnm.aio.fritz.Handler.prototype.devicemanager=xnm.aio.fritz.DM;xnm.aio.fritz.Handler.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"fritz")};
xnm.aio.fritz.Handler.prototype.resolveGateway=function(a){return a&&a.ip?new xnm.aio.fritz.Box(a.ip,a.password,a.username,a.port):null};xnm.aio.fritz.Handler.prototype.getDeviceCommands=function(a,c){a=(a=xnm.aio.fritz.DM.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];c&&c(null,a)};xnm.aio.fritz.Handler.prototype.getDeviceStatus=function(a,c){a=(a=xnm.aio.fritz.DM.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];c&&c(null,a)};
xnm.aio.fritz.Handler.prototype.doCommand=function(a,c,d,b){(a=this.resolveGateway(a))?a.executeCommandCreator(c,d,function(a){b&&b(a)}):b&&b(Error("gateway json format invalid"))};xnm.aio.fritz.Handler.prototype.doStatus=function(a,c,d,b,e){(c=this.resolveGateway(c))?c.getStatesCreator(null,[{id:a,device:d,status:b}],function(a,b){a?e&&e(a):e&&e(null,b[0])}):e&&e(Error("gateway json format invalid"))};
xnm.aio.fritz.Handler.prototype.getDeviceList=function(a,c){(a=this.resolveGateway(a))?a.getDevices2(function(a){c&&c(null,a)}):c&&c(Error("gateway json format invalid"))};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.fritz.Handler);
