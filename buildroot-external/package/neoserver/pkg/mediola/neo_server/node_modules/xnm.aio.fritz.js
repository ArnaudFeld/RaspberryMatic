var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(f,h,b){f instanceof String&&(f=String(f));for(var d=f.length,a=0;a<d;a++){var c=f[a];if(h.call(b,c,a,f))return{i:a,v:c}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(f,h,b){f!=Array.prototype&&f!=Object.prototype&&(f[h]=b.value)};$jscomp.getGlobal=function(f){f=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,f];for(var h=0;h<f.length;++h){var b=f[h];if(b&&b.Math==Math)return b}return globalThis};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(f,h,b,d){if(h){b=$jscomp.global;f=f.split(".");for(d=0;d<f.length-1;d++){var a=f[d];a in b||(b[a]={});b=b[a]}f=f[f.length-1];d=b[f];h=h(d);h!=d&&null!=h&&$jscomp.defineProperty(b,f,{configurable:!0,writable:!0,value:h})}};$jscomp.polyfill("Array.prototype.find",function(f){return f?f:function(f,b){return $jscomp.findInternal(this,f,b).v}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.fritz=xnm.aio.fritz||{};
xnm.aio.fritz.SessionCache={_cache:{},STATE_TO:5E3,setSessionID:function(f,h){if(f){var b=this._cache[f];b||(this._cache[f]={},b=this._cache[f]);b.sessionID=h}},getSessionID:function(f){return f?this._cache[f]?this._cache[f].sessionID:null:null}};
xnm.aio.fritz.Box=function(){function f(d,a){var c=360,l=-1,e=null,g;for(g in h){var b=h[g];var k=Math.abs(d-b.hue);k<c&&(c=k,l=b.hue,e=g)}b=h[e];return[l,a>b.sat[0]?b.sat[0]:a>b.sat[1]?b.sat[1]:a>b.sat[2]?b.sat[2]:0]}var h={red:{hue:358,sat:[180,112,54],val:[255,255,255]},orange:{hue:35,sat:[214,140,72],val:[252,252,255]},yellow:{hue:52,sat:[153,102,51],val:[255,255,255]},lime:{hue:92,sat:[123,79,38],val:[248,250,252]},green:{hue:120,sat:[160,82,38],val:[220,232,242]},turquoise:{hue:160,sat:[145,
84,41],val:[235,242,248]},cyan:{hue:195,sat:[179,118,59],val:[255,255,255]},lightblue:{hue:212,sat:[169,110,56],val:[252,252,255]},blue:{hue:225,sat:[204,135,67],val:[255,255,255]},purple:{hue:266,sat:[169,110,54],val:[250,250,252]},magenta:{hue:296,sat:[140,92,46],val:[250,252,255]},pink:{hue:335,sat:[180,107,51],val:[255,248,250]}},b=function(d,a,c,b){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.fritz.Box");this.ip=d;this.port=
b;this.protocol="http";d&&"http://"==d.substr(0,7)?this.ip=d.substr(7):d&&"https://"==d.substr(0,8)&&(this.ip=d.substr(8),this.protocol="https");this.port||(this.port="https"==this.protocol?443:80);this.password=a;this.user="";c&&(this.user=c);this.CommandHandler=null};b.prototype._doRequest=function(d,a){var c=this;this._cachedSessionID()&&(d+="&sid="+this._cachedSessionID());var b=a;a={host:this.ip,port:this.port,path:d,method:"GET"};this._logger.log("trace","send ("+this.protocol+") req to:"+JSON.stringify(a));
var e="";d=require("http");"https"==this.protocol&&(d=require("https"),"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),a.port||(a.port=443));var g=d.request(a,function(a){a.on("data",function(c){e+=c});a.on("end",function(){var d=null;200==a.statusCode?c._logger.log("trace","http request success:"+e):(c._logger.log("trace","http request error:"+a.statusCode+"-"+e),d=Error("request failed with status code:"+a.statusCode));b&&b(d,e,a.statusCode);
b=null})});g.setTimeout&&g.setTimeout(6E4,function(){g.abort()});if(g.on&&"function"==typeof g.on)g.on("error",function(a){a||(a=Error("http request error"));c._logger.log("trace","http request error:"+a.message);b&&b(a);b=null});g.end()};b.prototype._sendRequest=function(d,a){var c=this;this._doRequest(d,function(b,e,g){b&&403==g?(c._setSessionID(null),c._getSessionID(function(e,b){e?(c._logger.log("trace","create new session error:"+e.message),a&&a(e)):(c._setSessionID(b),c._sendRequest(d,a))})):
a&&a(b,e)})};b.prototype._setSessionID=function(d){return xnm.aio.fritz.SessionCache.setSessionID(this.ip,d)};b.prototype._cachedSessionID=function(){return xnm.aio.fritz.SessionCache.getSessionID(this.ip)};b.prototype._getSessionID=function(d){var a=this;this._logger.log("trace","create new session");this._doRequest("/login_sid.lua",function(c,b){if(c)d&&d(c);else try{var e=$($.parseXML(b));if(e){var g=null;c=null;var l=e.find("SID");l&&(g=$(l[0]).text());(l=e.find("Challenge"))&&(c=$(l[0]).text());
if("0000000000000000"!=g)d&&d(null,g);else if(c){g=null;var k=require("x.crypt.js"),f=c+"-"+k.MD5(c+"-"+a.password,!0);a._doRequest("/login_sid.lua?username="+a.user+"&response="+f,function(c,a){if(c)d&&d(c);else try{var e=$($.parseXML(a));if(e){var b=e.find("SID");b&&(g=$(b[0]).text());"0000000000000000"==g&&(g=null)}g||(c=Error("session challenge fail"));d&&d(c,g)}catch(p){d&&d(p)}})}}}catch(n){d&&d(n)}})};b.prototype._getDeviceInfos=function(d){var a=this;a._sendRequest("/webservices/homeautoswitch.lua?switchcmd=getdevicelistinfos",
function(c,b){c?d&&d(c):(c=[],b&&(b=$($.parseXML(b)),c=a._resolveDevices(b)),d&&d(null,c))})};b.prototype._resolveDevices=function(d){var a=this,c=[];d.find("device").each(function(){var d=$(this);(d=a._resolveDevice(d))&&c.push(d)});d.find("group").each(function(){var d=$(this);(d=a._resolveGroup(d))&&c.push(d)});return c};b.prototype._resolveDevice=function(d){var a=d.attr("identifier");if(!a)return null;var c=d.find("name"),b="";c&&c[0]&&(b=$(c[0]).text());a=a.replace(" ","");c=d.attr("productname");
var e=d.attr("functionbitmask");e=parseInt(e);var g=null;if(e&1){if(!(e&8192))return null;var f=d.find("etsiunitinfo");if(f&&f[0]){g={};var k=$(f[0]).find("unittype");g.unittype=k&&k[0]?$(k[0]).text():null;f=$(f[0]).find("interfaces");g.interfaces=f&&f[0]?$(f[0]).text().split(","):null}}f="Comet DECT"==c?"thermo":"switch";"FRITZ!DECT 500"==c&&(f="colorlight");a={sys:"fritz",name:b,type:"fritz_dect",typeName:c,bitmask:parseInt(e),address:a,data:f,etsiunitinfo:g};a.states=this._resolveStates(a,d);return a};
b.prototype._resolveGroup=function(d){var a=d.attr("identifier");if(!a)return null;var c=d.find("name"),b="";c&&c[0]&&(b=$(c[0]).text());a=a.replace(" ","");(c=d.attr("productname"))||(c="Group");var e=d.attr("functionbitmask");a={sys:"fritz",name:b,type:"fritz_dect",typeName:c,bitmask:parseInt(e),address:a,data:"group"};a.states=this._resolveStates(a,d);return a};b.prototype._resolveStates=function(d,a){var c={},b=!1,e,g=a.find("present");if(g&&g[0])switch(b=!0,g=$(g[0]).text(),g){case "1":c.connected=
"true";break;case "0":c.connected="false";break;default:c.connected="?"}if((g=a.find("switch"))&&g[0]){b=!0;if((e=$(g[0]).find("state"))&&e[0])switch(e=$(e[0]).text(),e){case "1":c.state="on";break;case "0":c.state="off";break;default:c.state="?"}if((e=$(g[0]).find("mode"))&&e[0])switch(e=$(e[0]).text(),e){case "auto":c.switchMode="auto";break;case "manuell":c.switchMode="manu";break;default:c.switchMode="?"}}(g=a.find("powermeter"))&&g[0]&&(b=!0,(e=$(g[0]).find("power"))&&e[0]&&(e=$(e[0]).text(),
c.current=e?(parseInt(e)/1E3).toFixed(2):"?"),(e=$(g[0]).find("energy"))&&e[0]&&(e=$(e[0]).text(),c.energy=e?parseInt(e):"?"));(g=a.find("temperature"))&&g[0]&&(b=!0,(e=$(g[0]).find("celsius"))&&e[0]&&(e=$(e[0]).text(),c.tempC=e?(parseInt(e)/10).toFixed(1):"?"));(g=a.find("hkr"))&&g[0]&&(b=!0,(e=$(g[0]).find("tsoll"))&&e[0]&&((e=$(e[0]).text())?(e=parseInt(e),c.temp=254==e?28.5:253==e?7.5:(e/2).toFixed(1)):c.temp="?"),(e=$(g[0]).find("komfort"))&&e[0]&&((e=$(e[0]).text())?(e=parseInt(e),c.comfort=
254==e?28.5:253==e?7.5:(e/2).toFixed(1)):c.comfort="?"),(e=$(g[0]).find("absenk"))&&e[0]&&((e=$(e[0]).text())?(e=parseInt(e),c.absenk=254==e?28.5:253==e?7.5:(e/2).toFixed(1)):c.absenk="?"),(e=$(g[0]).find("batterylow"))&&e[0]&&((e=$(e[0]).text())?(e=parseInt(e),c.batlow=1==e?!0:!1):c.batlow="?"),(e=$(g[0]).find("battery"))&&e[0]&&((e=$(e[0]).text())?(e=parseInt(e),c.battery=e):c.battery="?"));if((g=a.find("simpleonoff"))&&g[0]&&(b=!0,(e=$(g[0]).find("state"))&&e[0]))switch(e=$(e[0]).text(),e){case "1":c.state=
"on";break;case "0":c.state="off";break;default:c.state="?"}(g=a.find("levelcontrol"))&&g[0]&&(b=!0,(e=$(g[0]).find("levelpercentage"))&&e[0]&&(e=$(e[0]).text(),e=parseInt(e),"colorlight"==d.data?c.brightness=e:c.level=e));if((g=a.find("colorcontrol"))&&g[0])if(b=!0,d=e=$(g[0]).attr("current_mode"),c.colormode=1==d?"color":4==d?"color_temperature":"unknonw",1==d?c.colortemperature=null:(e=$(g[0]).find("temperature"))&&e[0]&&(e=$(e[0]).text(),c.colortemperature=parseInt(e)),4==d)c.rgb="";else{if((e=
$(g[0]).find("hue"))&&e[0]){e=$(e[0]).text();var f=parseInt(e);f/=360}if((e=$(g[0]).find("saturation"))&&e[0]){e=$(e[0]).text();var k=parseInt(e);k/=255}e=this._HSVToRGB(f,k,c.brightness/100);g=("0"+parseInt(e[0]).toString(16)).slice(-2);g+=("0"+parseInt(e[1]).toString(16)).slice(-2);g+=("0"+parseInt(e[2]).toString(16)).slice(-2);c.rgb=g}b&&"off"==c.state&&"undefined"!=typeof c.brightness&&null!=c.brightness&&(c.brightness=0);return b?c:null};b.prototype.getDevices=function(d){this._getDeviceInfos(function(a,
c){var b=[];if(!a&&c)for(a=0;a<c.length;a++){var e=c[a];delete e.states;b.push(e)}d&&d(b)})};b.prototype.getStates=function(d){this._getDeviceInfos(function(a,c){var b={};if(c)for(var e=0;e<c.length;e++){var g=c[e];g.address&&g.states&&(b[g.address]=g.states)}d&&d(a,b)})};b.prototype.executeCommand=function(d,a,c){var b=a;a.value&&(b=a.value);var e=this;switch(b){case "on":var g="colorlight"==d.type?"setsimpleonoff&onoff=1":d.bitmask&&parseInt(d.bitmask)&32768?"setsimpleonoff&onoff=1":"setswitchon";
break;case "off":g="colorlight"==d.type?"setsimpleonoff&onoff=0":d.bitmask&&parseInt(d.bitmask)&32768?"setsimpleonoff&onoff=0":"setswitchoff";break;case "toggle":g="colorlight"==d.type?"setsimpleonoff&onoff=2":"setswitchtoggle";break;case "up":this.getStates(function(a,b){a?c&&c(a):b&&b[d.address]?(a=b[d.address].brightness,"undefined"==typeof a||null==a||isNaN(parseInt(a))?c&&c(Error("invalid brightness state")):(a=parseInt(a),a+=5,100<a&&(a=100),e.executeCommand(d,{value:"brightness",ext:a},c))):
c&&c(Error("get device states failed"))});return;case "down":this.getStates(function(a,b){a?c&&c(a):b&&b[d.address]?(a=b[d.address].brightness,"undefined"==typeof a||null==a||isNaN(parseInt(a))?c&&c(Error("invalid brightness state")):(a=parseInt(a),a-=5,0>a&&(a=0),e.executeCommand(d,{value:"brightness",ext:a},c))):c&&c(Error("get device states failed"))});return;case "brightness":"undefined"!=typeof a.ext&&null!=a.ext?(b=parseInt(a.ext),isNaN(b)||(0>b&&(b=0),100<b&&(b=100)),0!=b?(g="setlevelpercentage&level="+
b,this._sendRequest("/webservices/homeautoswitch.lua?ain="+d.address+"&switchcmd="+g,function(a){a?c&&c(a):e.executeCommand(d,{value:"on"},c)})):this.executeCommand(d,{value:"off"},c)):c&&c(Error("invalid command "+a));return;case "rgb":if("undefined"!=typeof a.ext&&null!=a.ext&&6==a.ext.length){b=parseInt(a.ext.substr(0,2),16);var h=parseInt(a.ext.substr(2,2),16);a=parseInt(a.ext.substr(4,2),16);a=this._RGBToHSV(b,h,a);a=f(Math.round(a[0]),Math.round(255*a[1]));g=0==a[1]?"setcolortemperature&temperature=4200&duration=0":
"setcolor&hue="+a[0]+"&saturation="+a[1]+"&duration=0";this._sendRequest("/webservices/homeautoswitch.lua?ain="+d.address+"&switchcmd="+g,function(a){a?c&&c(a):e.executeCommand(d,{value:"on"},c)})}else c&&c(Error("invalid command "+a));return;case "colortemperature":"undefined"!=typeof a.ext&&null!=a.ext&&(b=parseInt(a.ext),isNaN(b)||(2700>b&&(b=2700),6500<b&&(b=6500)),g="setcolortemperature&temperature="+(6200<b?6500:5600<b?5900:5E3<b?5300:4500<b?4700:4E3<b?4200:3600<b?3800:3200<b?3400:2850<b?3E3:
2700)+"&duration=0");break;case "thermoOn":g="sethkrtsoll&param=254";break;case "thermoOff":g="sethkrtsoll&param=253";break;case "tempUp":this.getStates(function(a,b){a?c&&c(a):b&&b[d.address]?(a=b[d.address].temp,!a||isNaN(parseFloat(a))?c&&c(Error("invalid setpoint state")):(a=parseFloat(a),a+=.5,28.5<a&&(a=28.5),g="sethkrtsoll&param="+2*a,e._sendRequest("/webservices/homeautoswitch.lua?ain="+d.address+"&switchcmd="+g,function(a){c&&setTimeout(function(){c(a)},250)}))):c&&c(Error("get device states failed"))});
return;case "tempDown":this.getStates(function(a,b){a?c&&c(a):b&&b[d.address]?(a=b[d.address].temp,!a||isNaN(parseFloat(a))?c&&c(Error("invalid setpoint state")):(a=parseFloat(a),a-=.5,7.5>a&&(a=7.5),g="sethkrtsoll&param="+2*a,e._sendRequest("/webservices/homeautoswitch.lua?ain="+d.address+"&switchcmd="+g,function(a){c&&setTimeout(function(){c(a)},250)}))):c&&c(Error("get device states failed"))});return;default:0==a.indexOf("temp")&&(g=a.replace("temp",""),g=parseFloat(g),g=7.5>=g||253==g?"sethkrtsoll&param=253":
28.5<=g||254==g?"sethkrtsoll&param=254":"sethkrtsoll&param="+2*g)}g?this._sendRequest("/webservices/homeautoswitch.lua?ain="+d.address+"&switchcmd="+g,function(a){c&&setTimeout(function(){c(a)},250)}):c&&c(Error("no such command "+a))};b.prototype.executeCommandCreator=function(b,a,c){if(b&&b.address&&a&&a.value){var d=a.value;if("temp"==a.value){if(!a.ext){c&&c(Error("parameter ext invalid"));return}d+=a.ext}else if("brightness"==a.value||"colortemperature"==a.value||"rgb"==a.value)d=a;this.executeCommand(b,
d,function(){c&&c()})}else c&&c(Error("parameter invalid"))};b.prototype.getStatesCreator=function(b,a,c){a?0==a.length?c&&c(null,[]):this.getStates(function(b,d){if(b)c&&c(b);else{b=[];for(var e=0;e<a.length;e++)if(a[e]&&a[e].id){var f="?";a[e].device&&a[e].device.address&&a[e].status&&a[e].status.value&&d&&d[a[e].device.address]&&(f=d[a[e].device.address][a[e].status.value],"undefined"==typeof f||null==f)&&(f="?");b.push({id:a[e].id,status:f})}c&&c(null,b)}}):c&&c(Error("deviceList is null"))};
b.prototype._RGBToHSV=function(b,a,c){b/=255;a/=255;c/=255;var d=Math.min(b,Math.min(a,c)),e=Math.max(b,Math.max(a,c));return d==e?[0,0,d]:[60*((b==d?3:c==d?1:5)-(b==d?a-c:c==d?b-a:c-b)/(e-d)),(e-d)/e,e]};b.prototype._HSVToRGB=function(b,a,c){var d=Math.floor(6*b),e=6*b-d;b=c*(1-a);var g=c*(1-e*a);a=c*(1-(1-e)*a);switch(d%6){case 0:var f=c;var h=a;var m=b;break;case 1:f=g;h=c;m=b;break;case 2:f=b;h=c;m=a;break;case 3:f=b;h=g;m=c;break;case 4:f=a;h=b;m=c;break;case 5:f=c,h=b,m=g}return[Math.round(255*
f),Math.round(255*h),Math.round(255*m)]};b.prototype.toJSON=function(){return{sys:"fritz",ip:this.ip,port:this.port,username:this.user,password:this.password}};b.prototype.equalsTo=function(b){return b&&b instanceof xnm.aio.fritz.Box?this.protocol==b.protocol&&this.ip==b.ip&&this.port==b.port&&this.user==b.user&&this.password==b.password:!1};return b}();
xnm.aio.fritz.DM=function(){var f=function(b,d){this.code=b;this.message=d;this.stack=Error().stack};f.prototype=Error();f.prototype.name="FritzDMError";f.prototype.code=0;f.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var h={fritz_dect:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},
{type:"float",name:"current power",ref:{value:"current"}}]},hkr:{command:[{type:"float",name:"set temperature",ref:{value:"temp",ext:"%f",extMeta:"7.5-28.5",scale:"0.5"}},{type:"enum",name:"temperature up",ref:{value:"tempUp"}},{type:"enum",name:"temperature down",ref:{value:"tempDown"}},{type:"enum",name:"thermostat on",ref:{value:"thermoOn"}},{type:"enum",name:"thermostat off",ref:{value:"thermoOff"}}],status:[{type:"float",name:"set temperature",ref:{value:"temp",ext:"%f",extMeta:"7.5-28.5",scale:"0.5"}},
{type:"float",name:"comfort temperature",ref:{value:"comfort",ext:"%f",extMeta:"7.5-28.5",scale:"0.5"}},{type:"float",name:"spar temperature",ref:{value:"absenk",ext:"%f",extMeta:"7.5-28.5",scale:"0.5"}},{type:"enum",name:"battery low",ref:{value:"batlow",options:["true","false"]}}]},temp:{status:[{type:"float",name:"current temperature",ref:{value:"tempC",scale:"0.1"}}]},powermeter:{status:[{type:"float",name:"energy",ref:{value:"energy"}},{type:"float",name:"current power",ref:{value:"current"}}]},
"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"enum",name:"switch mode",ref:{value:"switchMode",options:["auto","manu"]}}]},error:{status:[{type:"enum",name:"connected",ref:{value:"connected",options:["true","false"]}}]},simpleswitch:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},
{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}}]},brightness:{command:[{type:"enum",name:"brightness up",ref:{value:"up"}},{type:"enum",name:"brightness down",ref:{value:"down"}},{type:"int",name:"brightness",ref:{value:"brightness",ext:"%d",extMeta:"0-100"}}],status:[{type:"int",name:"brightness",ref:{value:"brightness",extMeta:"0-100"}}]},colortemperature:{command:[{type:"int",name:"color temperature",ref:{value:"colortemperature",
ext:"%d",extMeta:"2700-6500",scale:"100"}}],status:[{type:"int",name:"color temperature",ref:{value:"colortemperature",extMeta:"2700-6500"}}]},color:{command:[{type:"rgb",name:"rgb color",ref:{value:"rgb",ext:"%s"}}],status:[{type:"string",name:"rgb color",ref:{value:"rgb",ext:"%s"}}]},colormode:{status:[{type:"enum",name:"color mode",ref:{value:"colormode",options:["color","color_temperature","unknown"]}}]}};return{SYS:"fritz",getGatewayType:function(){return[{sys:this.SYS,name:"FRITZ!Box",port:80}]},
getGatewayDeviceType:function(){return[{sys:this.SYS,type:"fritz_dect",name:"FRITZ! Smart Home"}]},createGateway:function(b,d,a){d=f.ERROR_CODE;b?b.ip?a(null,b):a(new f(d.INVALID,"ip is invalid")):a(new f(d.INVALID,"info is invalid"))},updateGateway:function(b,d,a,c){b=f.ERROR_CODE;d?d.ip?c(null,d):c(new f(b.INVALID,"ip is invalid")):c(new f(b.INVALID,"update is invalid"))},deleteGateway:function(b,d,a){a()},createDevice:function(b,d,a){var c=f.ERROR_CODE;if(b)if(b.gateway)if(null==b.address||"undefined"==
typeof b.address)a(new f(c.INVALID,"address is invalid"));else if(null==b.type||"undefined"==typeof b.type)a(new f(c.INVALID,"type is invalid"));else if(d.data&&d.data.gateways&&0!==d.data.gateways.length){d=d.data.gateways;var h;for(h=0;h<d.length;h++)if(d[h].index===b.gateway){var e=d[h];break}e?a(null,b):a(new f(c.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else a(new f(c.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));else a(new f(c.INVALID,"gateway is invalid"));else a(new f(c.INVALID,
"info is invalid"))},updateDevice:function(b,d,a){var c=f.ERROR_CODE;if(b)if(b.gateway)if(null==b.address||"undefined"==typeof b.address)a(new f(c.INVALID,"address is invalid"));else if(null==b.type||"undefined"==typeof b.type)a(new f(c.INVALID,"type is invalid"));else if(d.data&&d.data.gateways&&0!==d.data.gateways.length){d=d.data.gateways;var h;for(h=0;h<d.length;h++)if(d[h].index===b.gateway){var e=d[h];break}e?a(null,b):a(new f(c.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else a(new f(c.NOT_FOUND,
"gateway with index "+b.gateway+" not exists"));else a(new f(c.INVALID,"gateway is invalid"));else a(new f(c.INVALID,"info is invalid"))},deleteDevice:function(b,d,a){a()},applyUIFilter:function(b,d){var a=this,c=function(a,b,d){var e=[];a.forEach(function(a){if("root"==a.type){a=JSON.parse(JSON.stringify(a));var g=c(a.children,b,d);g&&0<g.length&&(a.children=g,e.push(a))}else{g=d.elems;if("*"==g)g=!0;else{for(var f=!1,h=0;h<g.length;h++)if(g[h]==a.type){f=!0;break}g=f}g&&(a=JSON.parse(JSON.stringify(a)),
e.push(a))}});return e},f=function(b,d){var e=[],g=a.getCommandStatusMap(b);if(g){var f=[];switch(d.catagory){case "command":g.command&&(f=c(g.command,b,d));break;case "status":g.status&&(f=c(g.status,b,d))}e=e.concat(f)}return e};if(!b.sys)return null;var e=JSON.parse(JSON.stringify(b)),g=null;switch(d.catagory){case "command":g=f(b,d);e.command=g;break;case "status":g=f(b,d);e.status=g;break;default:return null}return g&&0!=g.length?e:null},getCommandStatusMap:function(b){if(!b||!b.type)return null;
var d=parseInt(b.bitmask),a=[];d?(d&64&&a.push("hkr"),d&128&&a.push("powermeter"),d&256&&a.push("temp"),d&512&&a.push("switch"),d&32768&&a.push("simpleswitch"),d&65536&&a.push("brightness"),d&131072&&(a.push("colortemperature"),a.push("color"),a.push("colormode"))):"colorlight"==b.type?a=["simpleswitch","brightness","colortemperature","color","colormode"]:a.push(b.type);if(0==a.length)return null;var c={command:[],status:[]};a.forEach(function(a){h[a]&&(h[a].command&&(c.command=c.command.concat(h[a].command)),
h[a].status&&(c.status=c.status.concat(h[a].status)))});if(0<c.command.length||0<c.status.length)c.status=c.status.concat(h.error.status);return c},toGeneralDevice:function(b,d){var a=d=!1,c=!1,f=!1,e=!1,g=parseInt(b.bitmask);g?(g&64&&(e=!0),g&128&&(a=!0),g&256&&(f=!0),g&512&&(d=!0),g&32768&&(d=!0),g&131072&&(c=!0)):"switch"==b.data?d=!0:"thermo"==b.data?e=!0:"colorlight"==b.data&&(c=!0);b=null;c?b={type:"dimmer",commands:{on:{},off:{},toggle:{},up:{},down:{},brightness:{value:{type:"INT",min:0,max:100,
step:1}},colorTemperature:{value:{type:"INT",min:2700,max:6500,step:100}},color:{type:"RGB"}},states:{state:{values:["on","off"]},brightness:{min:0,max:100,unit:"%"},colorTemperature:{min:2700,max:6500}},details:{commands:{on:{value:"on"},off:{value:"off"},toggle:{value:"toggle"},up:{value:"up"},down:{value:"down"},brightness:{value:"brightness",ext:"%d"},colorTemperature:{value:"colortemperature",ext:"%d",extMeta:"2700-6500",scale:"100"},color:{value:"rgb",ext:"%s"}},states:{state:{value:"state"},
brightness:{value:"brightness"},colorTemperature:{value:"colortemperature"}}}}:e?b={type:"heater",commands:{up:{},down:{},tempTo:{value:{type:"FLOAT",min:7.5,max:28.5,step:.5}}},states:{setpoint:{type:"FLOAT",min:6,max:30,step:.5,unit:"\u00b0C"},temperature:{type:"FLOAT"}},details:{commands:{up:{value:"tempUp"},down:{value:"tempDown"},tempTo:{value:"temp",ext:"%f"}},states:{setpoint:{value:"temp"},temperature:{value:"tempC"}}}}:d?(b={type:"switch",commands:{on:{},off:{},toggle:{}},states:{state:{values:["on",
"off"]}},details:{commands:{on:{value:"on"},off:{value:"off"},toggle:{value:"toggle"}},states:{state:{value:"state"}}}},a&&(b.states.power={type:"FLOAT"},b.states.consumption={type:"FLOAT"},b.details.states.power={value:"current"},b.details.states.consumption={value:"energy"})):f&&(b={type:"temperature",states:{temperature:{type:"FLOAT"}},details:{states:{temperature:{value:"tempC"}}}});return b}}}();
xnm.aio.fritz.Handler=function(){var f=function(){};f.prototype.Box=xnm.aio.fritz.Box;f.prototype.devicemanager=xnm.aio.fritz.DM;f.prototype.registModule=function(f){f.register(this.devicemanager.SYS,"fritz")};f.prototype.resolveGateway=function(f){return f&&f.ip?new xnm.aio.fritz.Box(f.ip,f.password,f.username,f.port):null};f.prototype.getDeviceCommands=function(f,b){f=(f=xnm.aio.fritz.DM.applyUIFilter(f,{catagory:"command",elems:"*"}))?f.command:[];b&&b(null,f)};f.prototype.getDeviceStatus=function(f,
b){f=(f=xnm.aio.fritz.DM.applyUIFilter(f,{catagory:"status",elems:"*"}))?f.status:[];b&&b(null,f)};f.prototype.doCommand=function(f,b,d,a){(f=this.resolveGateway(f))?f.executeCommandCreator(b,d,function(b){a&&a(b)}):a&&a(Error("gateway json format invalid"))};f.prototype.doStatus=function(f,b,d,a,c){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:f,device:d,status:a}],function(a,b){a?c&&c(a):c&&c(null,b[0])}):c&&c(Error("gateway json format invalid"))};f.prototype.getDeviceList=function(f,
b){(f=this.resolveGateway(f))?f.getDevices(function(d){b&&b(null,d)}):b&&b(Error("gateway json format invalid"))};return f}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.fritz.Handler);
