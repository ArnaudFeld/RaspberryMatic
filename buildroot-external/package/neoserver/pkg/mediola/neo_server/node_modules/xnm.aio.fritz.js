var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.fritz=xnm.aio.fritz||{};xnm.aio.fritz.SessionCache={_cache:{},STATE_TO:5E3,setSessionID:function(b,d){if(b){var c=this._cache[b];c||(this._cache[b]={},c=this._cache[b]);c.sessionID=d}},getSessionID:function(b){return b?this._cache[b]?this._cache[b].sessionID:null:null}};
xnm.aio.fritz.Box=function(b,d,c,a){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.fritz.Box");this.ip=b;this.port=a;this.protocol="http";b&&"http://"==b.substr(0,7)?this.ip=b.substr(7):b&&"https://"==b.substr(0,8)&&(this.ip=b.substr(8),this.protocol="https");this.port||(this.port="https"==this.protocol?443:80);this.password=d;this.user="";c&&(this.user=c);this.CommandHandler=null};
xnm.aio.fritz.Box.prototype._doRequest=function(b,d){if("https"==this.protocol)this._doRequest2(b,d);else{var c=this,a=this.protocol+"://"+this.ip+":"+this.port+b;this._cachedSessionID()&&(a+="&sid="+this._cachedSessionID());this._logger.log("trace","send req to url:"+a);var e=d;$.ajax({url:a,type:"GET",timeout:4E3,dataType:"text",success:function(a){c._logger.log("trace","http request success:"+a);e&&(e(null,a,200),e=null)},error:function(a,b){var d="http request error:"+(a?a.status:"0")+"-"+b;c._logger.log("trace",
d);e&&(e(Error(d),a?a.responseText:null,a?a.status:null),e=null)}})}};
xnm.aio.fritz.Box.prototype._doRequest2=function(b,d){var c=this,a=b;this._cachedSessionID()&&(a+="&sid="+this._cachedSessionID());var e=d,a={host:this.ip,port:this.port,path:a,method:"GET"};this._logger.log("trace","send ("+this.protocol+") req to:"+JSON.stringify(a));var f="",g=require("http");"https"==this.protocol&&(g=require("https"),"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),a.port||(a.port=443));var h=g.request(a,function(a){a.on("data",
function(a){f+=a});a.on("end",function(){var b=null;200==a.statusCode?c._logger.log("trace","http request success:"+f):(c._logger.log("trace","http request error:"+a.statusCode+"-"+f),b=Error("request failed with status code:"+a.statusCode));e&&e(b,f,a.statusCode);e=null})});h.setTimeout&&h.setTimeout(6E4,function(){h.abort()});if(h.on&&"function"==typeof h.on)h.on("error",function(a){a||(a=Error("http request error"));c._logger.log("trace","http request error:"+a.message);e&&e(a);e=null});h.end()};
xnm.aio.fritz.Box.prototype._sendRequest=function(b,d){var c=this;this._doRequest(b,function(a,e,f){a&&403==f?(c._setSessionID(null),c._getSessionID(function(a,e){a?(c._logger.log("trace","create new session error:"+a.message),d&&d(a)):(c._setSessionID(e),c._sendRequest(b,d))})):d&&d(a,e)})};xnm.aio.fritz.Box.prototype._setSessionID=function(b){return xnm.aio.fritz.SessionCache.setSessionID(this.ip,b)};xnm.aio.fritz.Box.prototype._cachedSessionID=function(){return xnm.aio.fritz.SessionCache.getSessionID(this.ip)};
xnm.aio.fritz.Box.prototype._getSessionID=function(b){var d=this;this._logger.log("trace","create new session");this._doRequest("/login_sid.lua",function(c,a){if(c)b&&b(c);else try{var e=$($.parseXML(a));if(e){var f=null,g=null,h=e.find("SID");h&&(f=$(h[0]).text());(h=e.find("Challenge"))&&(g=$(h[0]).text());if("0000000000000000"!=f)b&&b(null,f);else if(g){var f=null,k=require("x.crypt.js"),l=g+"-"+k.MD5(g+"-"+d.password,!0);d._doRequest("/login_sid.lua?username="+d.user+"&response="+l,function(a,
c){if(a)b&&b(a);else try{var d=$($.parseXML(c));if(d){var e=d.find("SID");e&&(f=$(e[0]).text());"0000000000000000"==f&&(f=null)}f||(a=Error("session challenge fail"));b&&b(a,f)}catch(g){b&&b(g)}})}}}catch(m){b&&b(m)}})};xnm.aio.fritz.Box.prototype.getDevices=function(b){this._sendRequest("/webservices/homeautoswitch.lua?switchcmd=getswitchlist",function(d,c){var a=[];if(!d&&c)for(var a=c.split(","),e=0;e<a.length;e++)a[e]=$.trim(a[e]);b&&b(a)})};
xnm.aio.fritz.Box.prototype.getDevices2=function(b){this._sendRequest("/webservices/homeautoswitch.lua?switchcmd=getdevicelistinfos",function(d,c){var a=[];if(!d&&c){var e=$($.parseXML(c));e.find("device").each(function(){var c=$(this),b=c.attr("identifier");if(b){var d=c.find("name"),e="";d&&d[0]&&(e=$(d[0]).text());var b=b.replace(" ",""),d=c.attr("productname"),c=c.attr("functionbitmask"),l="Comet DECT"==d?"thermo":"switch",b={sys:"fritz",name:e,type:"fritz_dect",typeName:d,bitmask:parseInt(c),
address:b,data:l};a.push(b)}});e.find("group").each(function(){var c=$(this),b=c.attr("identifier");if(b){var d=c.find("name"),e="";d&&d[0]&&(e=$(d[0]).text());b=b.replace(" ","");(d=c.attr("productname"))||(d="Group");c=c.attr("functionbitmask");b={sys:"fritz",name:e,type:"fritz_dect",typeName:d,bitmask:parseInt(c),address:b,data:"group"};a.push(b)}})}b&&b(a)})};
xnm.aio.fritz.Box.prototype.getState=function(b,d){var c=this;this._sendRequest("/webservices/homeautoswitch.lua?ain="+b.address+"&switchcmd=getswitchstate",function(a,e){var f={state:"?",current:"?"};!a&&e&&(e=$.trim(e),"0"==e?f.state="off":"1"==e&&(f.state="on"));c._sendRequest("/webservices/homeautoswitch.lua?ain="+b.address+"&switchcmd=getswitchpower",function(a,e){!a&&e&&(e=$.trim(e),f.current=(parseFloat(e)/1E3).toFixed(1));if(c.CommandHandler&&c.CommandHandler.setState){var k=c.getStateValues(b.subtype,
f),l;for(l in k)"state"==l?c.CommandHandler.setState(b.id,k[l]):c.CommandHandler.setState(b.id+":"+l,k[l])}else c.CommandHandler&&c.CommandHandler.receivedState&&c.CommandHandler.receivedState("fritz",b.address,f);d&&d(f)})})};
xnm.aio.fritz.Box.prototype.getState2=function(b){var d=this;d._sendRequest("/webservices/homeautoswitch.lua?switchcmd=getdevicelistinfos",function(c,a){var e={};if(!c&&a){var f=$($.parseXML(a));f.find("device").each(function(){var a=$(this),c=a.attr("identifier");c&&(c=c.replace(" ",""),(a=d._parseState2(a))&&(e[c]=a))});f.find("group").each(function(){var a=$(this),c=a.attr("identifier");c&&(a=d._parseState2(a))&&(e[c]=a)})}b&&b(c,e)})};
xnm.aio.fritz.Box.prototype._parseState2=function(b){var d={},c=!1,a,e=b.find("present");if(e&&e[0])switch(c=!0,e=$(e[0]).text(),e){case "1":d.connected="true";break;case "0":d.connected="false";break;default:d.connected="?"}if((e=b.find("switch"))&&e[0]){c=!0;if((a=$(e[0]).find("state"))&&a[0])switch(a=$(a[0]).text(),a){case "1":d.state="on";break;case "0":d.state="off";break;default:d.state="?"}if((a=$(e[0]).find("mode"))&&a[0])switch(a=$(a[0]).text(),a){case "auto":d.switchMode="auto";break;case "manuell":d.switchMode=
"manu";break;default:d.switchMode="?"}}(e=b.find("powermeter"))&&e[0]&&(c=!0,(a=$(e[0]).find("power"))&&a[0]&&(a=$(a[0]).text(),d.current=a?(parseInt(a)/1E3).toFixed(2):"?"),(a=$(e[0]).find("energy"))&&a[0]&&(a=$(a[0]).text(),d.energy=a?parseInt(a):"?"));(e=b.find("temperature"))&&e[0]&&(c=!0,(a=$(e[0]).find("celsius"))&&a[0]&&(a=$(a[0]).text(),d.tempC=a?(parseInt(a)/10).toFixed(1):"?"));(e=b.find("hkr"))&&e[0]&&(c=!0,(a=$(e[0]).find("tsoll"))&&a[0]&&((a=$(a[0]).text())?(a=parseInt(a),d.temp=254==
a?28.5:253==a?7.5:(a/2).toFixed(1)):d.temp="?"),(a=$(e[0]).find("komfort"))&&a[0]&&((a=$(a[0]).text())?(a=parseInt(a),d.comfort=254==a?28.5:253==a?7.5:(a/2).toFixed(1)):d.comfort="?"),(a=$(e[0]).find("absenk"))&&a[0]&&((a=$(a[0]).text())?(a=parseInt(a),d.absenk=254==a?28.5:253==a?7.5:(a/2).toFixed(1)):d.absenk="?"),(a=$(e[0]).find("batterylow"))&&a[0]&&((a=$(a[0]).text())?(a=parseInt(a),d.batlow=1==a?!0:!1):d.batlow="?"));return c?d:null};
xnm.aio.fritz.Box.prototype.executeCommand=function(b,d,c){var a;switch(d){case "on":a="setswitchon";break;case "off":a="setswitchoff";break;case "toggle":a="setswitchtoggle";break;case "thermoOn":a="sethkrtsoll&param=254";break;case "thermoOff":a="sethkrtsoll&param=253";break;default:0==d.indexOf("temp")&&(a=d.replace("temp",""),a=parseFloat(a),a=7.5>=a||253==a?"sethkrtsoll&param=253":28.5<=a||254==a?"sethkrtsoll&param=254":"sethkrtsoll&param="+2*a)}a?this._sendRequest("/webservices/homeautoswitch.lua?ain="+
b.address+"&switchcmd="+a,function(a){c&&setTimeout(function(){c(a)},250)}):c&&c(Error("no such command "+d))};xnm.aio.fritz.Box.prototype.getStates=function(b,d){this.CommandHandler=b;for(var c=0;c<d.length;c++)this.getState(d[c])};xnm.aio.fritz.Box.prototype.getStateValues=function(b,d){return d};
xnm.aio.fritz.Box.prototype.getDeviceName=function(b,d){this._logger.log("trace","get device name:"+b);this._sendRequest("/webservices/homeautoswitch.lua?ain="+b+"&switchcmd=getswitchname",function(c,a){d&&d(c,a)})};xnm.aio.fritz.Box.prototype.executeCommandCreator=function(b,d,c){if(b&&b.address&&d&&d.value){var a=d.value;if("temp"==d.value){if(!d.ext){c&&c(Error("parameter ext invalid"));return}a+=d.ext}this.executeCommand(b,a,function(){c&&c()})}else c&&c(Error("parameter invalid"))};
xnm.aio.fritz.Box.prototype.getStatesCreator=function(b,d,c){d?0==d.length?c&&c(null,[]):this.getState2(function(a,b){if(a)c&&c(a);else{for(var f=[],g=0;g<d.length;g++)if(d[g]&&d[g].id){var h="?";d[g].device&&d[g].device.address&&d[g].status&&d[g].status.value&&b&&b[d[g].device.address]&&(h=b[d[g].device.address][d[g].status.value],"undefined"==typeof h||null==h)&&(h="?");f.push({id:d[g].id,status:h})}c&&c(null,f)}}):c&&c(Error("deviceList is null"))};
xnm.aio.fritz.Box.prototype.toJSON=function(){return{sys:"fritz",ip:this.ip,port:this.port,username:this.user,password:this.password}};xnm.aio.fritz.Box.prototype.equalsTo=function(b){return b&&b instanceof xnm.aio.fritz.Box?this.protocol==b.protocol&&this.ip==b.ip&&this.port==b.port&&this.user==b.user&&this.password==b.password:!1};
xnm.aio.fritz.DM=function(){var b=function(c,a){this.code=c;this.message=a;this.stack=Error().stack};b.prototype=Error();b.prototype.name="FritzDMError";b.prototype.code=0;b.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var d={fritz_dect:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},
{type:"float",name:"current power",ref:{value:"current"}}]},hkr:{command:[{type:"float",name:"set temperature",ref:{value:"temp",ext:"%f",extMeta:"7.5-28.5",scale:"0.5"}},{type:"enum",name:"thermostat on",ref:{value:"thermoOn"}},{type:"enum",name:"thermostat off",ref:{value:"thermoOff"}}],status:[{type:"float",name:"set temperature",ref:{value:"temp",ext:"%f",extMeta:"7.5-28.5",scale:"0.5"}},{type:"float",name:"comfort temperature",ref:{value:"comfort",ext:"%f",extMeta:"7.5-28.5",scale:"0.5"}},{type:"float",
name:"spar temperature",ref:{value:"absenk",ext:"%f",extMeta:"7.5-28.5",scale:"0.5"}},{type:"enum",name:"battery low",ref:{value:"batlow",options:["true","false"]}}]},temp:{status:[{type:"float",name:"current temperature",ref:{value:"tempC",scale:"0.1"}}]},powermeter:{status:[{type:"float",name:"energy",ref:{value:"energy"}},{type:"float",name:"current power",ref:{value:"current"}}]},"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",
name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"enum",name:"switch mode",ref:{value:"switchMode",options:["auto","manu"]}}]},error:{status:[{type:"enum",name:"connected",ref:{value:"connected",options:["true","false"]}}]}};return{SYS:"fritz",getGatewayType:function(){return[{sys:this.SYS,name:"FRITZ!Box",port:80}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"fritz_dect",name:"FRITZ! Smart Home"}]},createGateway:function(c,
a,d){a=b.ERROR_CODE;c?c.ip?d(null,c):d(new b(a.INVALID,"ip is invalid")):d(new b(a.INVALID,"info is invalid"))},updateGateway:function(c,a,d,f){c=b.ERROR_CODE;a?a.ip?f(null,a):f(new b(c.INVALID,"ip is invalid")):f(new b(c.INVALID,"update is invalid"))},deleteGateway:function(c,a,b){b()},createDevice:function(c,a,d){var f=b.ERROR_CODE;if(c)if(c.gateway)if(null==c.address||"undefined"==typeof c.address)d(new b(f.INVALID,"address is invalid"));else if(null==c.type||"undefined"==typeof c.type)d(new b(f.INVALID,
"type is invalid"));else if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var g,h;for(g=0;g<a.length;g++)if(a[g].index===c.gateway){h=a[g];break}h?d(null,c):d(new b(f.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else d(new b(f.NOT_FOUND,"gateway with index "+c.gateway+" not exists"));else d(new b(f.INVALID,"gateway is invalid"));else d(new b(f.INVALID,"info is invalid"))},updateDevice:function(c,a,d){var f=b.ERROR_CODE;if(c)if(c.gateway)if(null==c.address||"undefined"==
typeof c.address)d(new b(f.INVALID,"address is invalid"));else if(null==c.type||"undefined"==typeof c.type)d(new b(f.INVALID,"type is invalid"));else if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var g,h;for(g=0;g<a.length;g++)if(a[g].index===c.gateway){h=a[g];break}h?d(null,c):d(new b(f.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else d(new b(f.NOT_FOUND,"gateway with index "+c.gateway+" not exists"));else d(new b(f.INVALID,"gateway is invalid"));else d(new b(f.INVALID,
"info is invalid"))},deleteDevice:function(c,a,b){b()},applyUIFilter:function(c,a){var b=this,d=function(a,c,b){var e=[];a.forEach(function(a){if("root"==a.type){a=JSON.parse(JSON.stringify(a));var g=d(a.children,c,b);g&&0<g.length&&(a.children=g,e.push(a))}else{g=b.elems;if("*"==g)g=!0;else{for(var h=!1,l=0;l<g.length;l++)if(g[l]==a.type){h=!0;break}g=h}g&&(a=JSON.parse(JSON.stringify(a)),e.push(a))}});return e},g=function(a,c){var g=[],h=b.getCommandStatusMap(a);if(h){var k=[];switch(c.catagory){case "command":h.command&&
(k=d(h.command,a,c));break;case "status":h.status&&(k=d(h.status,a,c))}g=g.concat(k)}return g};if(!c.sys)return null;var h=JSON.parse(JSON.stringify(c)),k=null;switch(a.catagory){case "command":k=g(c,a);h.command=k;break;case "status":k=g(c,a);h.status=k;break;default:return null}return k&&0!=k.length?h:null},getCommandStatusMap:function(c){if(!c||!c.type)return null;var a=parseInt(c.bitmask),b=[];a?(a&64&&b.push("hkr"),a&128&&b.push("powermeter"),a&256&&b.push("temp"),a&512&&b.push("switch")):b.push(c.type);
if(0==b.length)return null;var f={command:[],status:[]};b.forEach(function(a){d[a]&&(d[a].command&&(f.command=f.command.concat(d[a].command)),d[a].status&&(f.status=f.status.concat(d[a].status)))});if(0<f.command.length||0<f.status.length)f.status=f.status.concat(d.error.status);return f}}}();xnm.aio.fritz.Handler=function(){};xnm.aio.fritz.Handler.prototype.Box=xnm.aio.fritz.Box;xnm.aio.fritz.Handler.prototype.getStateValues=function(b,d){return(new xnm.aio.fritz.Box).getStateValues(b.type,d)};
xnm.aio.fritz.Handler.prototype.getDeviceCommandList=function(b,d){var c=[];c.push({id:window.XC_Text.on,cmd:"on"});c.push({id:window.XC_Text.off,cmd:"off"});return c};xnm.aio.fritz.Handler.prototype.devicemanager=xnm.aio.fritz.DM;xnm.aio.fritz.Handler.prototype.registModule=function(b){b.register(this.devicemanager.SYS,"fritz")};xnm.aio.fritz.Handler.prototype.resolveGateway=function(b){return b&&b.ip?new xnm.aio.fritz.Box(b.ip,b.password,b.username,b.port):null};
xnm.aio.fritz.Handler.prototype.getDeviceCommands=function(b,d){var c=xnm.aio.fritz.DM.applyUIFilter(b,{catagory:"command",elems:"*"}),c=c?c.command:[];d&&d(null,c)};xnm.aio.fritz.Handler.prototype.getDeviceStatus=function(b,d){var c=xnm.aio.fritz.DM.applyUIFilter(b,{catagory:"status",elems:"*"}),c=c?c.status:[];d&&d(null,c)};xnm.aio.fritz.Handler.prototype.doCommand=function(b,d,c,a){(b=this.resolveGateway(b))?b.executeCommandCreator(d,c,function(b){a&&a(b)}):a&&a(Error("gateway json format invalid"))};
xnm.aio.fritz.Handler.prototype.doStatus=function(b,d,c,a,e){(d=this.resolveGateway(d))?d.getStatesCreator(null,[{id:b,device:c,status:a}],function(a,b){a?e&&e(a):e&&e(null,b[0])}):e&&e(Error("gateway json format invalid"))};xnm.aio.fritz.Handler.prototype.getDeviceList=function(b,d){var c=this.resolveGateway(b);c?c.getDevices2(function(a){d&&d(null,a)}):d&&d(Error("gateway json format invalid"))};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.fritz.Handler);
