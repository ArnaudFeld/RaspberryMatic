var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.cams=x.hub.m.cams||{};x.hub.m.cams.CAMS_MODULE=require("xnm.aio.cams.js");
x.hub.m.cams.DoorBirdMonitor=function(){var c=function(a,b){this._id=this._gentId();this._logger=require("x.logger.js").getLogger("x.hub.m.cams.DoorBirdMonitor.["+this._id+"]");this._handler=b;this._doorbird=a;this._callbacks=[];this._running=!1;this._reconnectTO=this._req=null;this.reconnTimeout=5;this.dataTimeout=30;this._doorbirdInfo=this._ring=this._motion=this._dataTO=null};c.prototype._gentId=function(){return((new Date).getTime()/1E3|0).toString(16)+"xx".replace(/[x]/g,function(){return(16*
Math.random()|0).toString(16)}).toLowerCase()};c.prototype.start=function(){this._logger.log("debug","start monitor:"+this._doorbird.ip);if(!this._running){var a=this;this._running=!0;this._getDoorBirdInfo(function(b,d){if(b)a.onClose(b);else a._doorbirdInfo=d,a._supportUdpMonitor()?a._addToUdpMonitor():a._startHttpMonitor()})}};c.prototype.stop=function(a){this._logger.log("debug","stop monitor:"+this._doorbird.ip);this._running?0<this._callbacks.length?a&&a(null,!1):(this._running=!1,this._supportUdpMonitor()?
this._removeFromUdpMonitor():this._stopHttpMonitor(),a&&a(null,!0)):a&&a(null,!0)};c.prototype.addCallback=function(a){-1==this._callbacks.indexOf(a)&&this._callbacks.push(a)};c.prototype.removeCallback=function(a){a=this._callbacks.indexOf(a);-1!=a&&this._callbacks.splice(a,1)};c.prototype._start=function(){var a=this;this._getDoorBirdInfo(function(b,d){if(b)a.onClose(b);else a._doorbirdInfo=d,a._supportUdpMonitor()?a._addToUdpMonitor():a._startHttpMonitor()})};c.prototype._startHttpMonitor=function(){this._logger.log("debug",
"start monitor for:"+this._doorbird.ip);var a=this._doorbird.ip,b=this._doorbird.port,d=a.indexOf(":");-1==d||b||(b=a.substr(d+1));b||(b=80);var e=this;this._logger.log("trace","send to url:"+("http://"+a+":"+b+"/bha-api/monitor.cgi?ring=doorbell,motionsensor"));b={host:a,port:b,path:"/bha-api/monitor.cgi?ring=doorbell,motionsensor",method:"GET",headers:{}};d=this._doorbird.username;var c=this._doorbird.password;d&&(b.headers.Authorization="Basic "+(new Buffer(d+":"+c)).toString("base64"));var k=
!1,f=!1,g=require("http").request(b,function(b){b.setEncoding("utf-8");b.on("data",function(b){k=!0;e._dataTO&&(clearTimeout(e._dataTO),e._dataTO=null);e._dataTO=setTimeout(function(){e._logger.log("warn","monitor data timeout:"+a);g.abort();f||(f=!0,e.onClose(Error("data timeout")))},1E3*e.dataTimeout);e.onData(b)});b.on("end",function(){var a;509==b.statusCode?a=Error("door bird busy"):200!=b.statusCode&&(a=Error("door bird monitor reutrn http:"+b.statusCode));f||(f=!0,e.onClose(a))})});g.setTimeout(2E3,
function(){k||(g.abort(),f||(f=!0,e.onClose(Error("connection timeout"))))});g.on("error",function(a){f||(f=!0,e.onClose(a))});g.end();this._req=g};c.prototype._stopHttpMonitor=function(){this._req&&this._req.abort()};c.prototype._reconnect=function(){this._logger.log("trace","reconnect monitor:"+this._doorbird.ip+" in "+this.reconnTimeout+" s");this._reconnectTO&&(clearTimeout(this._reconnectTO),this._reconnectTO=null);var a=this;this._reconnectTO=setTimeout(function(){a._start()},1E3*this.reconnTimeout)};
c.prototype._getDoorBirdInfo=function(a){this._logger.log("debug","get info for:"+this._doorbird.ip);var b=this._doorbird.ip,d=this._doorbird.port,e=b.indexOf(":");-1==e||d||(d=b.substr(e+1));d||(d=80);this._logger.log("trace","send to url:"+("http://"+b+":"+d+"/bha-api/info.cgi"));b={host:b,port:d,path:"/bha-api/info.cgi",method:"GET",headers:{}};d=this._doorbird.username;e=this._doorbird.password;d&&(b.headers.Authorization="Basic "+(new Buffer(d+":"+e)).toString("base64"));var c=a;a=require("http").request(b,
function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){var d;509==a.statusCode?d=Error("door bird busy"):200!=a.statusCode&&(d=Error("door bird info reutrn http:"+a.statusCode));if(d)c&&c(d),c=null;else try{var e=JSON.parse(b);e&&e.BHA&&1==e.BHA.RETURNCODE&&e.BHA.VERSION?c&&c(null,e.BHA):c&&c(Error("invalid info response"));c=null}catch(l){c&&c(l),c=null}})});a.setTimeout(2E3,function(){c&&c(Error("timeout"));c=null});a.on("error",function(a){c&&c(a);c=null});
a.end()};c.prototype._supportUdpMonitor=function(){if(!this._doorbirdInfo||!this._doorbirdInfo.VERSION)return!1;var a=this._doorbirdInfo.VERSION[0];if(!a)return!1;var b=a["DEVICE-TYPE"];if(!b)return!1;b=b.replace("DoorBird","").trim();a=a.FIRMWARE;if(!a)return!1;a=parseInt(a);b=b.substr(0,3);return"D10"==b&&99<=a||"D20"==b&&99<=a||"D21"==b&&108<=a||"B10"==b&&99<=a?!0:!1};c.prototype._addToUdpMonitor=function(){this._handler.getDoorBirdHandler().addDoorBird(this._doorbird,this)};c.prototype._removeFromUdpMonitor=
function(){this._handler.getDoorBirdHandler().removeDoorBird(this._doorbird,this)};c.prototype.onData=function(a){this._logger.log("trace","receive notify:"+a);var b=a.indexOf("doorbell:"),d=null,c=null;-1!=b&&(d=a.substr(b+9,1),d="H"==d?!0:!1);b=a.indexOf("motionsensor:");-1!=b&&(c=a.substr(b+13,1),c="H"==c?!0:!1);a=require("x.hub.eventbus.js");c!=this._motion&&null!=c&&(b={key:"motion",value:c,oldvalue:this._motion,changed:!0},a.emit("status",{module:"cams",device:this._doorbird,data:b}),this._motion=
c);d!=this._ring&&null!=d&&(b={key:"ring",value:d,oldvalue:this._ring,changed:!0},a.emit("status",{module:"cams",device:this._doorbird,data:b}),this._ring=d)};c.prototype.onClose=function(a){this._logger.log("debug","monitor closed:"+this._doorbird.ip+(a?" err: "+a.message:""));this._running&&this._reconnect()};c.prototype.onUdpEvent=function(a){this._logger.log("trace","receive udp event: "+JSON.stringify(a)+" for:"+this._doorbird.ip);require("x.hub.eventbus.js");"motionsensor"==a.event||"motion"==
a.event?(a={key:"motion",value:!0,oldvalue:!1,changed:!0},this._invokeCallback({module:"cams",device:this._doorbird,data:a})):"101"==a.event?(a={key:"ring",value:!0,oldvalue:!1,changed:!0},this._invokeCallback({module:"cams",device:this._doorbird,data:a}),a={key:"ring1",value:!0,oldvalue:!1,changed:!0},this._invokeCallback({module:"cams",device:this._doorbird,data:a})):"102"==a.event?(a={key:"ring",value:!0,oldvalue:!1,changed:!0},this._invokeCallback({module:"cams",device:this._doorbird,data:a}),
a={key:"ring2",value:!0,oldvalue:!1,changed:!0},this._invokeCallback({module:"cams",device:this._doorbird,data:a})):"102"==a.event&&(a={key:"ring",value:!0,oldvalue:!1,changed:!0},this._invokeCallback({module:"cams",device:this._doorbird,data:a}),a={key:"ring3",value:!0,oldvalue:!1,changed:!0},this._invokeCallback({module:"cams",device:this._doorbird,data:a}))};c.prototype._invokeCallback=function(a){for(var b=0;b<this._callbacks.length;b++){var c=this._callbacks[b];if(c&&c.onEvent)try{c.onEvent(a)}catch(e){}}};
return c}();
x.hub.m.cams.Handler=function(){var c=function(){this._doorBirdMonitors={};this._doorBirdHandler=x.hub.m.cams.CAMS_MODULE.getDoorBirdHandler()};util.inherits(c,EventEmitter);c.prototype.init=function(a){this._doorBirdHandler.startUdpMonitor();a&&a()};c.prototype.getSystems=function(){return["cam"]};c.prototype.addStateDevice=function(a,b,c){!a||"system"!=a.type||"doorbird"!=a.manufacturer&&"doorbird"!=a.type||"doorbird"!=a.model?b&&b({error:Error("device json format invalid")}):this._startDoorBirdMonitor(a,function(a){b&&
b({error:a})},c)};c.prototype.removeStateDevice=function(a,b,c){!a||"system"!=a.type||"doorbird"!=a.manufacturer&&"doorbird"!=a.type||"doorbird"!=a.model?b&&b({error:Error("device json format invalid")}):this._stopDoorBirdMonitor(a,function(a){b&&b({error:a})},c)};c.prototype.getAllStates=function(){return[]};c.prototype.getStates=function(a){return null};c.prototype.getState=function(a,b,c){require("x.hub.commandman.js").commandHandler.getStateLegacy(a,null,{value:b},c)};c.prototype.executeCommand=
function(a,b,c){require("x.hub.commandman.js").commandHandler.executeCommandLegacy(a,null,b,c)};c.prototype.checkDeviceMatch=function(a,b){return b&&b.device&&a&&a.device&&b.device.manufacturer==a.device.manufacturer&&b.device.model==a.device.model?b.device.ip==a.device.ip:!1};c.prototype.getDoorBirdHandler=function(){return this._doorBirdHandler};c.prototype._startDoorBirdMonitor=function(a,b,c){if(a&&a.ip){var d=a.ip;this._doorBirdMonitors[d]?(c&&c.callback&&this._doorBirdMonitors[d].addCallback(c.callback),
b&&b(null,this._doorBirdMonitors[d])):x.hub.m.cams.CAMS_MODULE.resolveDevice(a)?(a=new x.hub.m.cams.DoorBirdMonitor(a,this),this._doorBirdMonitors[d]=a,c&&c.callback&&a.addCallback(c.callback),a.start(),b&&b(null,a)):b&&b(Error("doorbird json format invalid"))}else b&&b(Error("harmony hub format invalid"))};c.prototype._stopDoorBirdMonitor=function(a,b,c){if(a&&a.ip){var d=this,h=a.ip;(a=this._doorBirdMonitors[h])?(c&&c.callback&&a.removeCallback(c.callback),a.stop(function(a,c){!a&&c&&delete d._doorBirdMonitors[h];
b&&b(a,c)})):b&&b(null)}else b&&b(Error("harmony hub format invalid"))};return c}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.cams.Handler);
