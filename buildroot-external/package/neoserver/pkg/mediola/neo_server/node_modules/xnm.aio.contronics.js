var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.contronics=xnm.aio.contronics||{},xnm.aio.contronics.ExecEngine=function(e,n,t,i){var o=require("x.logger.js");this._logger=o?o.getLogger("xnm.aio.contronics.ExecEngine"):{log:function log(){}},this.ip=e,this.port=n,(!this.port||this.port<0)&&(this.port=2110),this.user=t,this.password=i,this._sessionID=-1,this._sessionTimeout=null,this._statusBuffer=null;},xnm.aio.contronics.ExecEngine.prototype._doRequest2=function(e,n){if(e&&"string"==typeof e){this._logger.log("trace","[_doRequest2] do request: "+e);var t={host:this.ip,port:this.port,path:"/RPC2",method:"POST",headers:{"Content-Type":"text/xml","Content-length":e.length,"User-Agent":"mediola",Connection:"keep-alive"}},i=n,o=require("http"),s=this,r=o.request(t,function(e){e.setEncoding("utf-8");var n=e.statusCode,t="";e.on("data",function(e){t+=e;}),e.on("end",function(){s._logger.log("debug","[_doRequest2] response status code: "+n),s._logger.log("trace","[_doRequest2] response data: "+t),200==n?i&&(i(null,t),i=null):i&&(i(new Error("http request error: "+n),t),i=null);});});r.setTimeout(6e4,function(){s._logger.log("warn","[_doRequest2] http request timeout"),r.abort();}),r.on("error",function(e){s._logger.log("warn","[_doRequest2] http request error: "+e.message),i&&(i(e),i=null);}),e&&r.write(e),r.end();}else n&&n(new Error("data invalid"));},xnm.aio.contronics.ExecEngine.prototype._doRequestAjax=function(e,n){if(e&&"string"==typeof e){var t=this,i="http://"+this.ip+":"+this.port+"/RPC2";this._logger.log("trace","[_doRequestAjax] send POST to url: "+i+" data: "+e);var o=n;$.ajax({url:i,type:"POST",timeout:6e4,headers:{"Content-Type":"text/xml","Content-length":e.length,"User-Agent":"mediola",Connection:"keep-alive"},data:e,dataType:"text",cache:!0,success:function success(e){t._logger.log("trace","[_doRequestAjax] http request success: "+e),o&&(o(null,e),o=null);},error:function error(e,n){var i="http request error:"+(e?e.status:"0")+"-"+n;t._logger.log("trace","[_doRequestAjax] "+i),o&&(o(new Error(i)),o=null);}});}else n&&n(new Error("data invalid"));},xnm.aio.contronics.ExecEngine.prototype._doXmlRpcReq=function(e,n,t){var i=require("x.xmlrpc.js"),o=this,s=function s(e,n){if(e)return xnm.aio.contronics.SessionBuffer.sessionHttpError(o.ip),void(t&&t(e));xnm.aio.contronics.SessionBuffer.sessionHttpOK(o.ip);try{var s=i.deserializeRsp(n);s.error?t&&t(new Error("xmlrpc fault "+s.error.faultCode+":"+s.error.faultString)):s.params&&s.params[0]?t&&t(null,s.params[0]):t&&t(new Error("xmlrpc response error"));}catch(e){o._logger.log("error","[_doXmlRpcReq] "+e.message),t&&t(e);}};try{var r=i.serializeReq(e,n);"undefined"!=typeof ARN&&ARN.isAndroid()?this._doRequestAjax(r,s):this._doRequest2(r,s);}catch(e){this._logger.log("error","[_doXmlRpcReq] "+e.message),t&&t(e);}},xnm.aio.contronics.ExecEngine.prototype._execReq=function(e,n){this._logger.log("trace","[_execReq] execute requeset param: "+JSON.stringify(e));var t=this;this._doXmlRpcReq("appreq",e,function(i,o){if(i)n&&n(i);else{if(t._logger.log("trace","[_execReq] get response param: "+JSON.stringify(o)+" for req: "+JSON.stringify(e)),o&&null!=o[0]&&void 0!==o[0])return"*ERROR"==o[0]?((i=new Error("ExecEngine api error"))._errorCode=1,void(n&&n(i))):"*ERROR ID"==o[0]?((i=new Error("ExecEngine invalid session id"))._errorCode=2,void(n&&n(i))):void(n&&n(null,o[0]));n&&n(new Error("ExecEngine response format invalid"));}});},xnm.aio.contronics.ExecEngine.prototype._doExecReq=function(e,n){var t=this;this._execReq(e,function(i,o){i?2==i._errorCode?(t._logger.log("debug","[_doExecReq] session invalid"),xnm.aio.contronics.SessionBuffer.removeSession(t.ip),t.signon(function(i,o){i?n&&n(i):(e[0]=o,31==e[1]&&(e[1]=24),t._doExecReq(e,n));})):n&&n(i):n&&n(null,o);});},xnm.aio.contronics.ExecEngine.prototype._signon=function(e){this._logger.log("debug","signon");var n=[0,1];if(this.user&&null!=this.password&&void 0!==this.password){var t=this._encodeCred(this.user,this.password);n.push(t);}var i=this;this._doExecReq(n,function(n,t){var o;t?(o=parseInt(t),i._logger.log("debug","signon: "+o),o<=0&&(n||((n=new Error("can not acquire session id"))._errorCode=3))):n||(i._logger.log("debug","signon return invalid response"),n=new Error("invalid response")),e&&e(n,n?null:o);});},xnm.aio.contronics.ExecEngine.prototype._signoff=function(e,n){this._logger.log("debug","signoff:"+e),this._doExecReq([e,2],function(e,t){n&&n(e,t);});},xnm.aio.contronics.ExecEngine.prototype._getDeviceList=function(e,n){var t=this;this._logger.log("debug","getDeviceList: "+e),this._doExecReq([e,8],function(i,o){if(i)n&&n(i);else if(o){var s=[];o.split("%06").forEach(function(e){if(e){var n=e.split("%07");if(n.length>=5){for(var t={name:n[0],systemLabel:n[1],moduleLabel:n[2],moduleID:n[3],objects:[]},i=4;i<n.length;i++)if(n[i]){var o=n[i].split("%08");if(10==o.length){4!=i||t.name||(t.name=o[0]);var r={name:o[0],label:o[1],group:o[2],art:o[3],type:o[4],min:o[5],max:o[6],valueInfo:o[7],ioInfo:o[8],deviceCode:o[9]};t.objects.push(r);}}s.push(t);}}}),t._logger.log("debug","finish getDeviceList: "+e),n&&n(null,s);}else n&&n(null,[]);});},xnm.aio.contronics.ExecEngine.prototype._getDeviceGroup=function(e,n){this._doExecReq([e,9],function(e,t){e?n&&n(e):n&&n(null,t);});},xnm.aio.contronics.ExecEngine.prototype._getAllDeviceValue=function(e,n){this._logger.log("debug","getAllDeviceValue: "+e);var t=require("x.xmlrpc.js");this._doExecReq([e,24],function(e,i){if(e)n&&n(e);else if(i){for(var o={},s=i.split("%06"),r=0;r<s.length;r++)if(s[r]){var a=s[r].indexOf("=");if(!(a<=0)){var c=s[r].substr(0,a),u=s[r].substr(a+1);c&&(o[c]=t._unescapeXml(u));}}n&&n(null,o);}else n&&n(null,{});});},xnm.aio.contronics.ExecEngine.prototype._getIncDeviceValue=function(e,n){this._logger.log("debug","getIncDeviceValue: "+e);var t=require("x.xmlrpc.js");this._doExecReq([e,31],function(e,i){if(e)n&&n(e);else if(i){for(var o={},s=i.split("%06"),r=0;r<s.length;r++)if(s[r]){var a=s[r].indexOf("=");if(!(a<=0)){var c=s[r].substr(0,a),u=s[r].substr(a+1);c&&(o[c]=t._unescapeXml(u));}}n&&n(null,o);}else n&&n(null,{});});},xnm.aio.contronics.ExecEngine.prototype._changeValue=function(e,n,t,i){this._logger.log("debug","_changeValue: "+e);var o=n+(null==t||void 0===t?"":"="+t);this._doExecReq([e,64,o],function(e,n){i&&i(e,n);});},xnm.aio.contronics.ExecEngine.prototype._encodeCred=function(e,n){var t=function t(e){for(var n=[],t=0;t<e.length;t++)n.push(e.charCodeAt(t));return n;},i=t(e);i.push(127);var o=t(n);return function(e){for(var n=e[e.length-1]<<1,t=[],i=1;i<5;i++){var o=Math.floor(220*Math.random())+32;t.push(o);}var s=function(e,n){if(!e)return n;n=function(e){for(var n=[],t=e.length-1;t>=0;t--)n.push(e[t]);return n;}(n);for(var t,i,o=[],s=0;s<n.length;s++)i=(t=n[s])^e,t>31&&i>31?o.push(i):o.push(t);return o;}(n,e=t.concat(e));return s[s.length-2]=n,function(e){for(var n,t=e.length,i="",o=0;o<t;o++)(n=e[o])<64?i=i+"1"+String.fromCharCode(n+64):n>191?i=i+"2"+String.fromCharCode(n-128):n>127?i=i+"3"+String.fromCharCode(n-64):i+=String.fromCharCode(n);return i;}(s);}(i=i.concat(o));},xnm.aio.contronics.ExecEngine.prototype.signon=function(e){var n=xnm.aio.contronics.SessionBuffer.getSessionID(this.ip);if(n)e&&e(null,n);else{var t=this;this._signon(function(n,i){!n&&i&&xnm.aio.contronics.SessionBuffer.addSession(t.ip,i,t),e&&e(n,n?null:i);});}},xnm.aio.contronics.ExecEngine.prototype.signoff=function(e){var n=xnm.aio.contronics.SessionBuffer.getSessionID(this.ip);n?(xnm.aio.contronics.SessionBuffer.removeSession(this.ip),this._signoff(n,function(n){e&&e(n);})):e&&e();},xnm.aio.contronics.ExecEngine.prototype.getDeviceList=function(e){var n=xnm.aio.contronics.SessionBuffer.getSessionID(this.ip);if(n)xnm.aio.contronics.SessionBuffer.refreshSession(this.ip),this._getDeviceList(n,e);else{var t=this;this.signon(function(n){n?e&&e(n):t.getDeviceList(e);});}},xnm.aio.contronics.ExecEngine.prototype._executeCommand=function(e,n,t){var i=xnm.aio.contronics.SessionBuffer.getSessionID(this.ip);if(i)xnm.aio.contronics.SessionBuffer.refreshSession(this.ip),this._changeValue(i,e,n,function(e){t&&t(e);});else{var o=this;this.signon(function(i){i?t&&t(i):o._executeCommand(e,n,t);});}},xnm.aio.contronics.ExecEngine.prototype._getStates=function(e){var n=xnm.aio.contronics.SessionBuffer.getSessionID(this.ip),t=xnm.aio.contronics.SessionBuffer.getStates(this.ip),i=xnm.aio.contronics.SessionBuffer.getStatesTimestamp(this.ip),o=this;n?!t||function(e){return!e||new Date().getTime()-e.getTime()>6500;}(i)?(xnm.aio.contronics.SessionBuffer.refreshSession(this.ip),this._getAllDeviceValue(n,function(n,t){n?e&&e(n):(xnm.aio.contronics.SessionBuffer.setStates(o.ip,t),e&&e(null,t));})):(xnm.aio.contronics.SessionBuffer.refreshSession(this.ip),this._getIncDeviceValue(n,function(n,t){n?e&&e(n):(xnm.aio.contronics.SessionBuffer.addStates(o.ip,t),e&&e(null,xnm.aio.contronics.SessionBuffer.getStates(o.ip)));})):this.signon(function(n){n?e&&e(n):o._getStates(e);});},xnm.aio.contronics.ExecEngine.prototype.executeCommandCreator=function(e,n,t){if(e&&e.name&&e.art&&"string"==typeof e.art&&n){if(null!=n.value&&void 0!==n.value){var i,o=e.name;switch(e.art.toLowerCase()){case"u":var s=-1;if(e.valueInfo)for(var r=e.valueInfo.split(";"),a=0;a<r.length;a++)if(r[a]==n.value){s=a;break;}i=-1==s?n.value:s;break;case"n":case"s":if(null==n.ext||void 0===n.ext)return void(t&&t(new Error("comamnd ext invalid")));i=n.ext;break;case"m":i=null;break;default:return void(t&&t(new Error("device art do not supported")));}this._executeCommand(o,i,t);}else t&&t(new Error("comamnd value invalid"));}else t&&t(new Error("execute comamnd argument invalid"));},xnm.aio.contronics.ExecEngine.prototype.getStatesCreator=function(e,n,t){n?this._getStates(function(e,i){if(e)t&&t(e);else{for(var o=[],s=0;s<n.length;s++)if(n[s].id&&n[s].device&&n[s].status){var r=n[s].device.name,a=n[s].device.art,c=n[s].device.valueInfo;if(r){var u=i[r];if(null!=u&&void 0!==u)if("N"==a)"0"==c?o.push({id:n[s].id,status:parseInt(u)}):o.push({id:n[s].id,status:parseFloat(u)});else if("U"==a&&c){var f=c.split(";"),l=parseInt(u);f[l]?o.push({id:n[s].id,status:f[l]}):o.push({id:n[s].id,status:u});}else o.push({id:n[s].id,status:u});}}t&&t(null,o);}}):t&&t(new Error("deviceList is null"));},xnm.aio.contronics.ExecEngine.prototype.equalsTo=function(e){return!!e&&e instanceof xnm.aio.contronics.ExecEngine&&this.ip==e.ip&&this.port==e.port&&this.user==e.user&&this.password==e.password;},xnm.aio.contronics.DMError=function(e,n){this.code=e,this.message=n,this.stack=new Error().stack;},xnm.aio.contronics.DMError.prototype=new Error(),xnm.aio.contronics.DMError.prototype.name="ContronicsDMError",xnm.aio.contronics.DMError.prototype.code=0,xnm.aio.contronics.DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},xnm.aio.contronics.DM={SYS:"execengine",getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"Contronics ExecEngine",port:2110}];},createGateway:function createGateway(e,n,t){var i=xnm.aio.contronics.DMError,o=xnm.aio.contronics.DMError.ERROR_CODE;e?e.ip?t(null,e):t(new i(o.INVALID,"ip is invalid")):t(new i(o.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,n,t,i){var o=xnm.aio.contronics.DMError,s=xnm.aio.contronics.DMError.ERROR_CODE;n?n.ip?i(null,n):i(new o(s.INVALID,"ip is invalid")):i(new o(s.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,n,t){t();},createDevice:function createDevice(e,n,t){var i=xnm.aio.contronics.DMError,o=xnm.aio.contronics.DMError.ERROR_CODE;if(e){if(null!=e.art&&void 0!==e.art){if(e.name){if(e.gateway){if(n.data&&n.data.gateways&&0!==n.data.gateways.length){var s,r,a=n.data.gateways;for(s=0;s<a.length;s++)if(a[s].index===e.gateway){r=a[s];break;}r?t(null,e):t(new i(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else t(new i(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else t(new i(o.INVALID,"gateway is invalid"));}else t(new i(o.INVALID,"name is invalid"));}else t(new i(o.INVALID,"art is invalid"));}else t(new i(o.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,n,t){var i=xnm.aio.contronics.DMError,o=xnm.aio.contronics.DMError.ERROR_CODE;if(e){if(null!=e.art&&void 0!==e.art){if(e.name){if(e.gateway){var s,r,a=n.data.gateways;for(s=0;s<a.length;s++)if(a[s].index===e.gateway){r=a[s];break;}r?t(null,e):t(new i(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else t(new i(o.INVALID,"gateway is invalid"));}else t(new i(o.INVALID,"catagory is invalid"));}else t(new i(o.INVALID,"address is invalid"));}else t(new i(o.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,n,t){t();},applyUIFilter:function applyUIFilter(e,n){var t=function t(e,n){if("*"==e)return!0;for(var t=!1,i=0;i<e.length;i++)if(e[i]==n){t=!0;break;}return t;},i=function i(e,n){var i=[];if(!e.art||"string"!=typeof e.art)return null;var o=!0,s=!0;if(e.ioInfo)switch(parseInt(e.ioInfo)){case 1:s=!1;break;case 2:o=!1;}var r=0,a=null,c=null;switch(e.art.toLowerCase()){case"u":var u;if(a={},e.valueInfo&&(u=e.valueInfo.split(";")),s&&u)for(a.command=[],r=0;r<u.length;r++)u[r]&&a.command.push({type:"enum",name:u[r],ref:{value:u[r]}});if(o){if(a.status=[],c={type:"enum",name:"status",ref:{value:"status"}},u)for(c.ref.options=[],r=0;r<u.length;r++)u[r]&&c.ref.options.push(u[r]);a.status.push(c);}break;case"n":var f=0;e.valueInfo&&parseInt(e.valueInfo)>0&&(f=e.valueInfo);var l,g,p=null,m=null;null!=e.min&&void 0!==e.min&&(p=f?parseFloat(e.min):parseInt(e.min)),null!=e.max&&void 0!==e.max&&(m=f?parseFloat(e.max):parseInt(e.max)),null==p||null==m||isNaN(p)||isNaN(m)||(l=p+"-"+m),f&&(g=""+1/Math.pow(10,f)),a={},s&&(c={type:f?"float":"int",name:"set value",ref:{value:"set value",ext:f?"%f":"%d"}},l&&(c.ref.extMeta=l),g&&(c.ref.scale=g),a.command=[c]),o&&(c={type:f?"float":"int",name:"state",ref:{value:"state"}},l&&(c.ref.extMeta=l),g&&(c.ref.scale=g),a.status=[c]);break;case"s":a={},s&&(c={type:"string",name:"set value",ref:{value:"set value",ext:"%s"}},a.command=[c]),o&&(c={type:"string",name:"state",ref:{value:"state"}},a.status=[c]);break;case"m":a={},s&&(c={type:"enum",name:"execute",ref:{value:"execute"}},a.command=[c]);}return a&&(c=function(e,n,i){var o=[];switch(i.catagory){case"command":e.command&&e.command.forEach(function(e){if(t(i.elems,e.type)){var n=JSON.parse(JSON.stringify(e));o.push(n);}});break;case"status":e.status&&e.status.forEach(function(e){if(t(i.elems,e.type)){var n=JSON.parse(JSON.stringify(e));o.push(n);}});}return o;}(a,0,n),i=i.concat(c)),i;};if(!e.art)return null;var o=JSON.parse(JSON.stringify(e)),s=null;switch(n.catagory){case"command":s=i(e,n),o.command=s;break;case"status":s=i(e,n),o.status=s;break;default:return null;}return s&&0!=s.length?o:null;}},xnm.aio.contronics.SessionBuffer={MAX_HTTP_ERROR_COUNT:5,_sessionBuffer:{},_statesBuffer:{},addSession:function addSession(e,n,t){this._sessionBuffer[e]&&this.removeSession(e);var i=this._createSessionTimeout(t);this._sessionBuffer[e]={sessionID:n,engine:t,timeout:i,httpError:0};},getSessionID:function getSessionID(e){return this._sessionBuffer[e]?this._sessionBuffer[e].sessionID:0;},removeSession:function removeSession(e){this._sessionBuffer[e]&&this._sessionBuffer[e].timeout&&clearInterval(this._sessionBuffer[e].timeout),delete this._sessionBuffer[e],delete this._statesBuffer[e];},refreshSession:function refreshSession(e){if(this._sessionBuffer[e]){null!=this._sessionBuffer[e].timeout&&clearInterval(this._sessionBuffer[e].timeout);var n=this._sessionBuffer[e].engine;n&&(this._sessionBuffer[e].timeout=this._createSessionTimeout(n));}},sessionHttpError:function sessionHttpError(e){this._sessionBuffer[e]&&(this._sessionBuffer[e].httpError+=1,this._sessionBuffer[e].httpError>=this.MAX_HTTP_ERROR_COUNT&&this.removeSession(e));},sessionHttpOK:function sessionHttpOK(e){this._sessionBuffer[e]&&(this._sessionBuffer[e].httpError=0);},removeAllSessions:function removeAllSessions(){for(var e in this._sessionBuffer)this._sessionBuffer.hasOwnProperty(e)&&this._sessionBuffer[e]&&this._sessionBuffer[e].timeout&&clearInterval(this._sessionBuffer[e].timeout);this._sessionBuffer={},this._statesBuffer={};},_createSessionTimeout:function _createSessionTimeout(e){return setInterval(function(){e._getStates();},3e3);},getStates:function getStates(e){return this._statesBuffer[e]?this._statesBuffer[e].states:null;},getStatesTimestamp:function getStatesTimestamp(e){return this._statesBuffer[e]?this._statesBuffer[e].timestamp:null;},removeStates:function removeStates(e){this._statesBuffer[e]&&delete this._statesBuffer[e].states;},setStates:function setStates(e,n){this._statesBuffer[e]={states:n,timestamp:new Date()};},addStates:function addStates(e,n){if(this._statesBuffer[e]||(this._statesBuffer[e]={}),this._statesBuffer[e].states){if(this._statesBuffer[e].timestamp=new Date(),n)for(var t in n)n.hasOwnProperty(t)&&(this._statesBuffer[e].states[t]=n[t]);}else this._statesBuffer[e]={states:n,timestamp:new Date()};},finalize:function finalize(e){var n=[];for(var t in this._sessionBuffer)if(this._sessionBuffer.hasOwnProperty(t)){var i=this._sessionBuffer[t];i&&i.engine&&n.push(i.engine);}if(0!=n.length)for(var o=0,s=0;s<n.length;s++)n[s].signoff(function(){++o==n.length&&e&&e();});else e&&e();}},xnm.aio.contronics.Handler=function(){},xnm.aio.contronics.Handler.prototype.ExecEngine=xnm.aio.contronics.ExecEngine,xnm.aio.contronics.Handler.prototype.devicemanager=xnm.aio.contronics.DM,xnm.aio.contronics.Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"contronics");},xnm.aio.contronics.Handler.prototype.resolveGateway=function(e){return e.ip?new xnm.aio.contronics.ExecEngine(e.ip,e.port,e.username,e.password):null;},xnm.aio.contronics.Handler.prototype.getDeviceCommands=function(e,n){var t=xnm.aio.contronics.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),i=t?t.command:[];n&&n(null,i);},xnm.aio.contronics.Handler.prototype.getDeviceStatus=function(e,n){var t=xnm.aio.contronics.DM.applyUIFilter(e,{catagory:"status",elems:"*"}),i=t?t.status:[];n&&n(null,i);},xnm.aio.contronics.Handler.prototype.doCommand=function(e,n,t,i){var o=this.resolveGateway(e);o?o.executeCommandCreator(n,t,function(e){i&&i(e);}):i&&i(new Error("gateway json format invalid"));},xnm.aio.contronics.Handler.prototype.doStatus=function(e,n,t,i,o){var s=this.resolveGateway(n);if(s){var r=[{id:e,device:t,status:i}];s.getStatesCreator(null,r,function(e,n){e?o&&o(e):o&&o(null,n[0]);});}else o&&o(new Error("gateway json format invalid"));},xnm.aio.contronics.Handler.prototype.getDeviceList=function(e,n){var t=this.resolveGateway(e);t?t.getDeviceList(function(e,i){t.signoff(function(){n&&n(e,i);});}):n&&n(new Error("gateway json format invalid"));},xnm.aio.contronics.Handler.prototype.finalize=function(e){var n=e;setTimeout(function(){n&&(n(),n=null);},3e3),xnm.aio.contronics.SessionBuffer.finalize(function(){n&&(n(),n=null);});},xnm.aio.contronics.Handler.prototype.pause=function(e){this.finalize(e);},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.contronics.Handler());