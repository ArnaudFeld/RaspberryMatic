var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.sms=xnm.aio.sms||{};
xnm.aio.sms.Handler=function(){var k="http://webservice.aio-control.com/smsservice",m={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(a){var b="",c,d,g,f,l,h,e=0;for(a=m._utf8_encode(a);e<a.length;)c=a.charCodeAt(e++),d=a.charCodeAt(e++),g=a.charCodeAt(e++),f=c>>2,c=(c&3)<<4|d>>4,l=(d&15)<<2|g>>6,h=g&63,isNaN(d)?l=h=64:isNaN(g)&&(h=64),b=b+this._keyStr.charAt(f)+this._keyStr.charAt(c)+this._keyStr.charAt(l)+this._keyStr.charAt(h);return b},decode:function(a){var b=
"",c,d,g,f,l,e=0;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");e<a.length;)c=this._keyStr.indexOf(a.charAt(e++)),d=this._keyStr.indexOf(a.charAt(e++)),f=this._keyStr.indexOf(a.charAt(e++)),l=this._keyStr.indexOf(a.charAt(e++)),c=c<<2|d>>4,d=(d&15)<<4|f>>2,g=(f&3)<<6|l,b+=String.fromCharCode(c),64!=f&&(b+=String.fromCharCode(d)),64!=l&&(b+=String.fromCharCode(g));return b=m._utf8_decode(b)},_utf8_encode:function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?
b+=String.fromCharCode(d):(127<d&&2048>d?b+=String.fromCharCode(d>>6|192):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128)),b+=String.fromCharCode(d&63|128))}return b},_utf8_decode:function(a){for(var b="",c=0,d=c1=c2=0;c<a.length;)d=a.charCodeAt(c),128>d?(b+=String.fromCharCode(d),c++):191<d&&224>d?(c2=a.charCodeAt(c+1),b+=String.fromCharCode((d&31)<<6|c2&63),c+=2):(c2=a.charCodeAt(c+1),c3=a.charCodeAt(c+2),b+=String.fromCharCode((d&15)<<12|(c2&63)<<6|c3&63),c+=3);return b}},
e=function(){};e.prototype.setURL=function(a){k=a};e.prototype.registAllUndeliveredPurchase=function(a,b){var c=this;this._getUndeliveredPurchase(function(d,g){if(d)b&&b(d);else if(g&&0!=g.length){for(var f=[],e=0;e<g.length;e++){var h=g[e];if(c._isSmsPurchase(h)){var k=c._getSmsCount(h);k&&(h.smsTotalCount=k,h.sid=a,f.push(h))}else f.push(h)}0>=f.length?b&&b():c._registSmsPurchases(f,function(a){a?b&&b(a):c._purchasesDelivered(f,function(a){b&&b(a)})})}else b&&b()})};e.prototype.getSmsInfo=function(a,
b){var c=require("url").parse(k),c={host:c.hostname,port:c.port,path:c.path+"/gatewaysmsinfo?sid="+a,method:"GET",headers:{"Content-Type":'text/plain; charset="utf-8"',Connection:"close"}},c=require("http").request(c,function(a){a.setEncoding("utf-8");var c="";a.on("data",function(a){c+=a});a.on("end",function(){var f;if(200!=a.statusCode)f=Error("http response:"+a.statusCode),b&&b(f);else if(c)try{f=JSON.parse(c),b&&b(null,f)}catch(e){b&&b(e)}else f=Error("server response is empty"),b&&b(f)})});
c.setTimeout&&c.setTimeout(1E4);if(c.on)c.on("error",function(a){b&&b(a?a:Error("http error"))});c.end()};e.prototype.setSmsActive=function(a,b,c){var d=require("url").parse(k);a={host:d.hostname,port:d.port,path:d.path+"/activatesms?sid="+a+"&active="+b,method:"GET",headers:{"Content-Type":'text/plain; charset="utf-8"',Connection:"close"}};a=require("http").request(a,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){var d;200!=a.statusCode&&(d=Error("http response:"+
a.statusCode));c&&c(d,b)})});a.setTimeout&&a.setTimeout(1E4);if(a.on)a.on("error",function(a){c&&c(a?a:Error("http error"))});a.end()};e.prototype._getUndeliveredPurchase=function(a){XC.callHost("inapppurchase","getUndeliveredPurchase",null,function(b){b?b.error?a&&a(Error(b.error)):b.value?a&&a(null,b.value):a&&a(null,[]):a&&a(Error("result is null"))})};e.prototype._registSmsPurchases=function(a,b){var c=this._encrypt2base64(JSON.stringify(a)),d=require("url").parse(k);XC.debugf("registAllSmsPurchase ud:"+
JSON.stringify(d));d={host:d.hostname,port:d.port,path:d.path+"/consume",method:"POST",headers:{"Content-Type":'text/plain; charset="utf-8"',Connection:"close"}};d=require("http").request(d,function(a){a.setEncoding("utf-8");var c="";a.on("data",function(a){c+=a});a.on("end",function(){var d;200!=a.statusCode&&(d=Error("http response:"+a.statusCode));b&&b(d,c)})});d.setTimeout&&d.setTimeout(1E4);if(d.on)d.on("error",function(a){b&&b(a?a:Error("http error"))});d.write(c);d.end()};e.prototype._encrypt2base64=
function(a){var b=require("x.crypt.js");a=m.encode(a);for(var c="",d=0,e=a.length,f;d<e;d+=1)f=a.charCodeAt(d),c+=f.toString(16);a=b.AES.h2a(c);b.AES.setSize(128);c=b.AES.h2a("CB1CC15198F09B7D9EA80892A870399E");d=b.AES.h2a("D0648681F88076B43CE216E0686A02DD");a=b.AES.encrypt(a,c,d);return b.AES.a2h(a)};e.prototype._purchasesDelivered=function(a,b){var c=a.length;if(c)for(var d=null,e=0;e<a.length;e++)this._purchaseDelivered(a[e].orderId,function(a){c--;d||(d=a);0==c&&b&&b(d)});else b&&b()};e.prototype._purchaseDelivered=
function(a,b){a?XC.callHost("inapppurchase","purchaseDelivered",{orderId:a},function(a){a?a.error?b&&b(Error(a.error)):b&&b(null,a.value):b&&b(Error("result is null"))}):b&&b(Error("order id is empty"))};e.prototype._isSmsPurchase=function(a){return a&&a.productId?"android.test.purchased"==a.productId?!0:0<=a.productId.indexOf(".sms."):!1};e.prototype._getSmsCount=function(a){if(!a||!a.productId)return 0;if("android.test.purchased"==a.productId)return 50;a=a.productId;var b=a.indexOf(".sms.");if(0>
b||b+5>=a.length)return 0;a=a.substr(b+5);return parseInt(a)};return e}();module&&(module.exports=new xnm.aio.sms.Handler);
