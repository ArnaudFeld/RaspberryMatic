var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.sms=xnm.aio.sms||{};
xnm.aio.sms.Handler=function(){var k="http://webservice.aio-control.com/smsservice",l={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(a){var b="",c=0;for(a=l._utf8_encode(a);c<a.length;){var d=a.charCodeAt(c++);var g=a.charCodeAt(c++);var f=a.charCodeAt(c++);var h=d>>2;d=(d&3)<<4|g>>4;var e=(g&15)<<2|f>>6;var m=f&63;isNaN(g)?e=m=64:isNaN(f)&&(m=64);b=b+this._keyStr.charAt(h)+this._keyStr.charAt(d)+this._keyStr.charAt(e)+this._keyStr.charAt(m)}return b},
decode:function(a){var b="",c=0;for(a=a.replace(/[^A-Za-z0-9\+\/=]/g,"");c<a.length;){var d=this._keyStr.indexOf(a.charAt(c++));var g=this._keyStr.indexOf(a.charAt(c++));var f=this._keyStr.indexOf(a.charAt(c++));var h=this._keyStr.indexOf(a.charAt(c++));d=d<<2|g>>4;g=(g&15)<<4|f>>2;var e=(f&3)<<6|h;b+=String.fromCharCode(d);64!=f&&(b+=String.fromCharCode(g));64!=h&&(b+=String.fromCharCode(e))}return b=l._utf8_decode(b)},_utf8_encode:function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=
a.charCodeAt(c);128>d?b+=String.fromCharCode(d):(127<d&&2048>d?b+=String.fromCharCode(d>>6|192):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128)),b+=String.fromCharCode(d&63|128))}return b},_utf8_decode:function(a){var b="",c=0;for(c1=c2=0;c<a.length;){var d=a.charCodeAt(c);128>d?(b+=String.fromCharCode(d),c++):191<d&&224>d?(c2=a.charCodeAt(c+1),b+=String.fromCharCode((d&31)<<6|c2&63),c+=2):(c2=a.charCodeAt(c+1),c3=a.charCodeAt(c+2),b+=String.fromCharCode((d&15)<<12|(c2&63)<<
6|c3&63),c+=3)}return b}},e=function(){};e.prototype.setURL=function(a){k=a};e.prototype.registAllUndeliveredPurchase=function(a,b){var c=this;this._getUndeliveredPurchase(function(d,g){if(d)b&&b(d);else if(g&&0!=g.length){var f=[];for(d=0;d<g.length;d++){var h=g[d];if(c._isSmsPurchase(h)){var e=c._getSmsCount(h);e&&(h.smsTotalCount=e,h.sid=a,f.push(h))}else f.push(h)}0>=f.length?b&&b():c._registSmsPurchases(f,function(a){a?b&&b(a):c._purchasesDelivered(f,function(a){b&&b(a)})})}else b&&b()})};e.prototype.getSmsInfo=
function(a,b){var c=require("url").parse(k);a={host:c.hostname,port:c.port,path:c.path+"/gatewaysmsinfo?sid="+a,method:"GET",headers:{"Content-Type":'text/plain; charset="utf-8"',Connection:"close"}};a=require("http").request(a,function(a){a.setEncoding("utf-8");var c="";a.on("data",function(a){c+=a});a.on("end",function(){if(200!=a.statusCode){var d=Error("http response:"+a.statusCode);b&&b(d)}else if(c)try{d=JSON.parse(c),b&&b(null,d)}catch(h){b&&b(h)}else d=Error("server response is empty"),b&&
b(d)})});a.setTimeout&&a.setTimeout(1E4);if(a.on)a.on("error",function(a){b&&b(a?a:Error("http error"))});a.end()};e.prototype.setSmsActive=function(a,b,c){var d=require("url").parse(k);a={host:d.hostname,port:d.port,path:d.path+"/activatesms?sid="+a+"&active="+b,method:"GET",headers:{"Content-Type":'text/plain; charset="utf-8"',Connection:"close"}};a=require("http").request(a,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){var d;200!=a.statusCode&&
(d=Error("http response:"+a.statusCode));c&&c(d,b)})});a.setTimeout&&a.setTimeout(1E4);if(a.on)a.on("error",function(a){c&&c(a?a:Error("http error"))});a.end()};e.prototype._getUndeliveredPurchase=function(a){XC.callHost("inapppurchase","getUndeliveredPurchase",null,function(b){b?b.error?a&&a(Error(b.error)):b.value?a&&a(null,b.value):a&&a(null,[]):a&&a(Error("result is null"))})};e.prototype._registSmsPurchases=function(a,b){a=this._encrypt2base64(JSON.stringify(a));var c=require("url").parse(k);
XC.debugf("registAllSmsPurchase ud:"+JSON.stringify(c));c={host:c.hostname,port:c.port,path:c.path+"/consume",method:"POST",headers:{"Content-Type":'text/plain; charset="utf-8"',Connection:"close"}};c=require("http").request(c,function(a){a.setEncoding("utf-8");var c="";a.on("data",function(a){c+=a});a.on("end",function(){var d;200!=a.statusCode&&(d=Error("http response:"+a.statusCode));b&&b(d,c)})});c.setTimeout&&c.setTimeout(1E4);if(c.on)c.on("error",function(a){b&&b(a?a:Error("http error"))});
c.write(a);c.end()};e.prototype._encrypt2base64=function(a){var b=require("x.crypt.js");a=l.encode(a);for(var c="",d=0,e=a.length,f;d<e;d+=1)f=a.charCodeAt(d),c+=f.toString(16);a=b.AES.h2a(c);b.AES.setSize(128);c=b.AES.h2a("CB1CC15198F09B7D9EA80892A870399E");d=b.AES.h2a("D0648681F88076B43CE216E0686A02DD");a=b.AES.encrypt(a,c,d);return b.AES.a2h(a)};e.prototype._purchasesDelivered=function(a,b){var c=a.length;if(c)for(var d=null,e=0;e<a.length;e++)this._purchaseDelivered(a[e].orderId,function(a){c--;
d||(d=a);0==c&&b&&b(d)});else b&&b()};e.prototype._purchaseDelivered=function(a,b){a?XC.callHost("inapppurchase","purchaseDelivered",{orderId:a},function(a){a?a.error?b&&b(Error(a.error)):b&&b(null,a.value):b&&b(Error("result is null"))}):b&&b(Error("order id is empty"))};e.prototype._isSmsPurchase=function(a){return a&&a.productId?"android.test.purchased"==a.productId?!0:0<=a.productId.indexOf(".sms."):!1};e.prototype._getSmsCount=function(a){if(!a||!a.productId)return 0;if("android.test.purchased"==
a.productId)return 50;a=a.productId;var b=a.indexOf(".sms.");if(0>b||b+5>=a.length)return 0;a=a.substr(b+5);return parseInt(a)};return e}();module&&(module.exports=new xnm.aio.sms.Handler);
