var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.rwe=xnm.aio.rwe||{};
xnm.aio.rwe.Cache={STATUS_EXPIRE_TO:3E5,_cache:{},_statusBuffer:{},_stateMachine:{},_centralBuffer:{},_getCache:function(b){return b?this._cache[b]:null},_ensureCache:function(b){if(!b)return null;this._cache[b]||(this._cache[b]={});return this._cache[b]},_getStateMachine:function(b){return b?this._stateMachine[b]:null},_ensureStateMachine:function(b){if(!b)return null;this._stateMachine[b]||(this._stateMachine[b]={state:0,loginCallbacks:[]});return this._stateMachine[b]},_getStateBuffer:function(b){return b?
this._statusBuffer[b]:null},_ensureStateBuffer:function(b){if(!b)return null;this._statusBuffer[b]||(this._statusBuffer[b]={});return this._statusBuffer[b]},setSessionID:function(b,a){if(!b)return null;var c=this._ensureCache(b);if(!c)return null;c.sessionID=a},getSessionID:function(b){return b?(b=this._getCache(b))?b.sessionID:null:null},setCurrentConfig:function(b,a){if(!b)return null;var c=this._ensureCache(b);if(!c)return null;c.currentConfig=a},getCurrentConfig:function(b){return b?(b=this._getCache(b))?
b.currentConfig:null:null},setVersion:function(b,a){if(!b)return null;var c=this._ensureCache(b);if(!c)return null;c.version=a},getVersion:function(b){return b?(b=this._getCache(b))&&b.version?b.version:"1.70":null},setStateMachineState:function(b,a){if(b){var c=this._ensureStateMachine(b);c&&(c.state=a?a:0)}},getStateMachineState:function(b){return b?(b=this._getStateMachine(b))&&b.state?b.state:0:null},addLoginCallback:function(b,a){if(!b||!a)return null;var c=this._ensureStateMachine(b);c&&(c.loginCallbacks||
(c.loginCallbacks=[]),c.loginCallbacks.push(a))},getLoginCallbacks:function(b){return b?(b=this._getStateMachine(b))?b.loginCallbacks:null:null},clearLoginCallbacks:function(b){if(!b)return null;if(b=this._getStateMachine(b))b.loginCallbacks=[]},setCentral:function(b,a){if(!b)return null;this._centralBuffer[b]=a},getCentral:function(b){return this._centralBuffer[b]},setStatusBuffer:function(b,a){if(!b)return null;var c=this._ensureStateBuffer(b);if(c){var f=this;null==c.timer&&(c.timer=setInterval(function(){var a=
f.getCentral(b);a&&a.refreshStates()},2E3));c.status=a;c.timestamp=(new Date).getTime()}},getStatusBuffer:function(b){if(!b)return null;var a=(new Date).getTime(),c=this._ensureStateBuffer(b);if(!c.status)return c.status={},c.timestamp=a,null;if(c.timestamp&&-c.timestamp>this.STATUS_EXPIRE_TO)return c.timestamp=a,null;var f=this;null==c.timer&&(c.timer=setInterval(function(){var a=f.getCentral(b);a&&a.refreshStates()},2E3));return c.status},updateStatusBuffer:function(b,a){if(!b||!a)return null;var c=
this._ensureStateBuffer(b);c.status||(c.status={});var f=!1,d;for(d in a)a.hasOwnProperty(d)&&a[d]&&(f=!0,c.status[d]=a[d]);f&&(c.timestamp=(new Date).getTime())},getSingleBufferedStatus:function(b,a){if(!b||!a)return null;var c=this._ensureStateBuffer(b);return c.status?c.status[a]:null},finalize:function(b){var a=(new Date).getTime()-24E4,c;for(c in this._statusBuffer)if(this._statusBuffer.hasOwnProperty(c)){var f=this._statusBuffer[c];f&&(f.timer&&(clearInterval(f.timer),f.timer=null),f.timestamp=
a)}b&&b()}};
xnm.aio.rwe.Central=function(){var b=function(a,c,f,d){this._logger=require("x.logger.js").getLogger("xnm.aio.rwe.Central");this.ip=a;this.port=c;c||(this.port=443);this.user=f;this.password=d;this._clientID=this._generateGUID();this.CommandHandler=null};b.DEVICE_TYPE_LIST="SwitchActuator DimmerActuator RollerShutterActuator RoomHumiditySensor RoomTemperatureSensor RoomTemperatureActuator AlarmActuator WindowDoorSensor SmokeDetectionSensor GenericActuator".split(" ");b.prototype._getSessionID=function(){return xnm.aio.rwe.Cache.getSessionID(this.ip)};
b.prototype._setSessionID=function(a){return xnm.aio.rwe.Cache.setSessionID(this.ip,a)};b.prototype._getCurrentConfig=function(){return xnm.aio.rwe.Cache.getCurrentConfig(this.ip)};b.prototype._setCurrentConfig=function(a){return xnm.aio.rwe.Cache.setCurrentConfig(this.ip,a)};b.prototype._getVersion=function(){return xnm.aio.rwe.Cache.getVersion(this.ip)};b.prototype._setVersion=function(a){return xnm.aio.rwe.Cache.setVersion(this.ip,a)};b.prototype._getStateMachineState=function(){return xnm.aio.rwe.Cache.getStateMachineState(this.ip)};
b.prototype._setStateMachineState=function(a){xnm.aio.rwe.Cache.setStateMachineState(this.ip,a)};b.prototype._addLoginCallback=function(a){xnm.aio.rwe.Cache.addLoginCallback(this.ip,a)};b.prototype._getLoginCallbacks=function(){return xnm.aio.rwe.Cache.getLoginCallbacks(this.ip)};b.prototype._clearLoginCallbacks=function(){xnm.aio.rwe.Cache.clearLoginCallbacks(this.ip)};b.prototype._setBufferedCentral=function(){xnm.aio.rwe.Cache.setCentral(this.ip,this)};b.prototype._getStatusBuffer=function(){return xnm.aio.rwe.Cache.getStatusBuffer(this.ip)};
b.prototype._setStatusBuffer=function(a){xnm.aio.rwe.Cache.setStatusBuffer(this.ip,a)};b.prototype._updateStatusBuffer=function(a){xnm.aio.rwe.Cache.updateStatusBuffer(this.ip,a)};b.prototype._getSingleBufferedStatus=function(a){return xnm.aio.rwe.Cache.getSingleBufferedStatus(this.ip,a)};b.prototype._generateGUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var c=16*Math.random()|0;return("x"==a?c:c&3|8).toString(16)})};b.prototype._parseDeviceData=function(a){var c=
{},f={},d={},h={};a.find("LC").each(function(){var a=$(this),c=a.find("Name"),a=a.find("Id");c&&a&&(f[$(a[0]).text()]={name:$(c[0]).text(),devices:{}})});a.find("BD").each(function(){var a=$(this).find("Id");a&&(d[$(a[0]).text()]={address:$(a[0]).text(),channels:{}})});a.find("LD").each(function(){var a=$(this),c=a.attr("xsi:type");if(c){var d=a.attr("Name"),f=a.attr("LCID"),b=a.find("BDId"),b=b&&0<b.length?$(b[0]).text():null,e=a.find("UDvIds");e=e&&0<e.length?(e=$(e[0]).find("guid"))&&0<e.length?
$(e[0]).text():null:null;var g=a.find("Id"),g=g&&0<g.length?$(g[0]).text():null,c={name:d,type:c,address:g,bid:b,udvid:e,lid:f};(a=a.find("ActCls"))&&0<a.length&&(c.data=$(a[0]).text());h[g]=c}});for(var g in h)if(h.hasOwnProperty(g)&&(a=h[g],a.type&&-1!=b.DEVICE_TYPE_LIST.indexOf(a.type)&&a.lid&&f[a.lid]))if("GenericActuator"==a.type&&a.address)f[a.lid].devices[a.address]={address:a.address,channels:{}},e=f[a.lid].devices[a.address],delete a.bid,delete a.udvid,delete a.lid,e.channels[a.address]=
a;else{var k=a.bid;!k&&a.udvid&&h[a.udvid]&&h[a.udvid].bid&&(k=h[a.udvid].bid);if(k&&d[k]&&a.address){var e=f[a.lid].devices[k];e||(f[a.lid].devices[k]=d[k],e=f[a.lid].devices[k]);delete a.bid;delete a.udvid;delete a.lid;e.channels[a.address]=a}}c.data=f;return c};b.prototype._parseMessageData=function(a){var c={},f={};a.find("MessageContainer").each(function(){var a=$(this),c=a.attr("State");if(a=a.find("Message")){var a=$(a[0]),b=a.attr("Id"),k=a.attr("Type"),e=a.attr("TimeStamp");if(b&&k&&e){f[b]=
{type:k,time:e,read:"Read"==c};var l={};a.find("MessageParameter").each(function(){var a=$(this),c=a.attr("Key"),a=a.attr("Value");c&&a&&(l[c]=a)});f[b].params=l}}});c.data=f;return c};b.prototype._parseDeviceStateData=function(a){var c={},f={};a.find("LogicalDeviceState").each(function(){var a=$(this),c=a.attr("LID"),b=a.attr("xsi:type");if(c&&b){var k=null;if("SwitchActuatorState"==b){var k={state:"?"},e=a.attr("IsOn");"True"==e?k.state="on":"False"==e&&(k.state="off")}else if("DimmerActuatorState"==
b)k={state:"?"},e=a.attr("DmLvl")||"0","string"==typeof e&&0<e.length&&(k.state=parseInt(e));else if("RollerShutterActuatorState"==b)k={state:"?"},(a=a.find("ShutterLevel"))&&0<a.length&&(k.state=parseInt($(a[0]).text())||0);else if("RoomHumiditySensorState"==b)k={state:"?"},e=a.attr("Humidity"),"string"==typeof e&&0<e.length&&(k.state=e);else if("RoomTemperatureSensorState"==b)k={state:"?"},e=a.attr("Temperature"),"string"==typeof e&&0<e.length&&(k.state=parseFloat(e).toFixed(1));else if("RoomTemperatureActuatorState"==
b)k={state:"?"},e=a.attr("PtTmp"),"string"==typeof e&&0<e.length&&(k.state=parseFloat(e).toFixed(1)),e=a.attr("OpnMd"),"string"==typeof e&&0<e.length&&(k.mode=e.toLowerCase());else if("AlarmActuatorState"==b)k={state:"?"},(e=a.attr("IsOn"))&&(e=e.toLowerCase()),"true"==e?k.state="on":"false"==e&&(k.state="off");else if("WindowDoorSensorState"==b)k={state:"?"},(a=a.find("IsOpen"))&&0<a.length&&((e=$(a[0]).text())&&(e=e.toLowerCase()),"true"==e?k.state="open":"false"==e&&(k.state="closed"));else if("SmokeDetectionSensorState"==
b)k={state:"?"},(a=a.find("IsSmokeAlarm"))&&0<a.length&&((e=$(a[0]).text())&&(e=e.toLowerCase()),"true"==e?k.state="on":"false"==e&&(k.state="off"));else if("GenericDeviceState"==b){var k={state:"?"},l=a.find("Ppt");if(l&&0<l.length){l=$(l[0]);a=l.attr("xsi:type");e=l.attr("Name");l=l.attr("Value");if("undefined"==typeof l||null==l)l="?";"string"==typeof a&&0<a.length&&"string"==typeof e&&0<e.length&&"string"==typeof l&&("BooleanProperty"==a?(k.state=l.toLowerCase(),b="BooleanProperty:Value"):(k.state=
l,b=a+":"+e))}}k&&(f[c]={state:k,type:b})}});c.data=f;return c};b.prototype._parseResult=function(a){var c={};a=$($($.parseXML(a)).children()[0]);if(!a)return c.error="invalid reponse",c;if("NotificationList"==a.prop("tagName"))c=this._parseDeviceStateData(a);else switch(a.attr("xsi:type")){case "AuthenticationErrorResponse":c.error=a.attr("Error");break;case "VersionMismatchErrorResponse":var f=a.attr("Version");this._setVersion(f);c.error="VersionMismatch";break;case "AcknowledgeResponse":c.data=
{result:"ok"};break;case "ControlResultResponse":"Ok"==a.attr("Result")?c.data={result:"ok"}:c.error=a.attr("Result");break;case "LoginResponse":(f=a.attr("SessionId"))&&this._setSessionID(f);(a=a.attr("CurrentConfigurationVersion"))&&this._setCurrentConfig(a);c.data={sessionID:f,currentConfig:a};break;case "GetEntitiesResponse":c=this._parseDeviceData(a);break;case "GetAllLogicalDeviceStatesResponse":"Ok"==a.attr("Result")?c=this._parseDeviceStateData(a):c.error=a.attr("Result");break;case "MessageListResponse":c=
this._parseMessageData(a);break;default:a.attr("Error")?c.error=a.attr("Error"):c.error="unknown response type:"+a.attr("xsi:type")}return c};b.prototype._doRequest=function(a,c,f,d){var b;a||(a="/cmd");if("object"==typeof f&&f&&f.body)b=f.body;else{b='<BaseRequest xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" Version="'+this._getVersion()+'" RequestId="'+this._generateGUID()+'" ';var g=this._getSessionID();g&&(b+='SessionId="'+g+'" ');b=(g=this._getCurrentConfig())?b+('BasedOnConfigVersion="'+
g+'" '):b+'BasedOnConfigVersion="0" ';for(var k in c)b+=k+'="'+c[k]+'" ';b=f&&0<f.length?b+(">"+f+"</BaseRequest>"):b+"/>"}k={};"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0",k=require("constants"));k={host:this.ip,port:this.port,path:a,method:"POST",headers:{Referer:"https://smarthome.blob.core.windows.net/silverlight/latest/application/RWE.SmartHome.UI.Shell.xap",ClientId:this._clientID,"Content-Type":"text/xml; charset=UTF-8","cache-control":"no-cache",
pragma:"no-cache","User-Agent":"Java/1.7.0_07",Accept:"text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2",Connection:"close","Content-Length":b.length},rejectUnauthorized:!1,secureOptions:k.SSL_OP_NO_TLSv1,strictSSL:!1,secureProtocol:"TLSv1_client_method"};this._logger.log("trace","do request:"+JSON.stringify(k));var e=this,l=d,m=require("https").request(k,function(b){b.setEncoding("utf-8");var h="";b.on("data",function(a){h+=a});b.on("end",function(){e._logger.log("trace","receive code:"+b.statusCode+
" headers:"+JSON.stringify(b.headers)+" response:"+h);var g,k;if(200==b.statusCode)try{if((k=e._parseResult(h))&&"VersionMismatch"==k.error){e._doRequest(a,c,f,d);return}}catch(m){console.error(m),g=m}l&&(l(g,k,b),l=null)})});if(m.on)m.on("error",function(a){e._logger.log("trace","do request error:"+a.message);l&&(l(a),l=null)});m.setTimeout&&m.setTimeout(6E4,function(){e._logger.log("trace","do request timeout");m.abort();l&&(l(Error("timeout")),l=null)});this._logger.log("trace","do request send body:"+
b);m.write(b);m.end()};b.prototype._sendRequest=function(a,c,f,b){var h=this,g=this._getSessionID(),k=this._getCurrentConfig();g&&k?this._doRequest(a,c,f,function(e,g,k){e?b&&b(e):k&&401==k.statusCode?(h._logger.log("debug","http request error with code:"+k.statusCode),h._setSessionID(null),h._setCurrentConfig(null),h._sendRequest(a,c,f,b)):k&&200!=k.statusCode?(e=Error("http request error with code:"+k.statusCode),b&&b(e)):!g||"IllegalSessionId"!=g.error&&"ConfigurationOutOfDate"!=g.error?(g&&g.error&&
(h._logger.log("debug","send request response error:"+g.error),e||(e=Error(g.error))),b&&b(e,g?g.data:g)):(h._logger.log("debug","send request response error:"+g.error),h._setSessionID(null),h._setCurrentConfig(null),h._sendRequest(a,c,f,b))}):this._login(function(e){e?b&&b(e):h._sendRequest(a,c,f,b)})};b.prototype._login=function(a){this._logger.log("debug","LoginRequest");if(this.user&&this.password){if(this._addLoginCallback(a),1!=this._getStateMachineState()){this._setStateMachineState(1);a=require("x.crypt.js");
a=(new Buffer(a.SHA256(this.password),"hex")).toString("base64");var c=this;this._doRequest(null,{"xsi:type":"LoginRequest",UserName:this.user,Password:a},null,function(a,b,h){var g=c._getLoginCallbacks();c._clearLoginCallbacks();a?c._logger.log("debug","login error:"+a.message):h&&200!=h.statusCode?(c._logger.log("debug","login http error:"+h.statusCode),a=Error("login http request error with code:"+h.statusCode)):b&&b.error&&(c._logger.log("debug","login response error:"+b.error),a=Error(b.error));
a?(c._setStateMachineState(0),g&&g.forEach(function(c){c&&c(a)})):c._subscribeNotification(function(a){a?(c._setStateMachineState(0),g&&g.forEach(function(c){c&&c(a)})):(c._logger.log("debug","login success:"+JSON.stringify(b)),c._setStateMachineState(2),c._setBufferedCentral(),g&&g.forEach(function(a){a&&a(null,b?b.data:b)}))})})}}else a&&a(Error("username or password in null"))};b.prototype._subscribeNotification=function(a){this._logger.log("debug","NotificationRequest");var c=this;this._sendRequest(null,
{"xsi:type":"NotificationRequest"},"<Action>Subscribe</Action><NotificationType>DeviceStateChanges</NotificationType>",function(b,d){b&&c._logger.log("debug","NotificationRequest error:"+b.message);d&&c._logger.log("debug","NotificationRequest response:"+JSON.stringify(d));a&&a(b,d)})};b.prototype._getUpd=function(a){this._logger.log("debug","Get Update Notification");var c=this;this._sendRequest("/upd",null,{body:"upd"},function(b,d){b&&c._logger.log("debug","Update Notification error:"+b.message);
d&&c._logger.log("debug","Update Notification response:"+JSON.stringify(d));a&&a(b,d)})};b.prototype._getEntities=function(a){this._logger.log("debug","GetEntitiesRequest");var c=this;this._sendRequest(null,{"xsi:type":"GetEntitiesRequest"},"<EntityType>Configuration</EntityType>",function(b,d){b&&c._logger.log("debug","GetEntitiesRequest error:"+b.message);d&&c._logger.log("debug","GetEntitiesRequest response:"+JSON.stringify(d));a&&a(b,d)})};b.prototype._getDeviceStates=function(a){this._logger.log("debug",
"_getDeviceStates");var c=this._getStatusBuffer();if(c)console.log("status buffer",c),a&&a(null,c);else{this._logger.log("debug","GetAllLogicalDeviceStatesRequest");var b=this;this._sendRequest(null,{"xsi:type":"GetAllLogicalDeviceStatesRequest"},null,function(c,h){c?(b._logger.log("debug","GetAllLogicalDeviceStatesRequest error:"+c.message),b._setStatusBuffer(null),a&&a(c)):(h&&(b._logger.log("debug","GetAllLogicalDeviceStatesRequest response:"+JSON.stringify(h)),b._setStatusBuffer(h)),a&&a(null,
h))})}};b.prototype._getDeviceState=function(a,c){this._getDeviceStates(function(b,d){if(b)c&&c(b);else{var h=null;d&&d[a]&&(h=d[a].state);c&&c(null,h)}})};b.prototype._addSpecialTypesFromStates=function(a,c){for(var b in a){var d=[],h=a[b],g;for(g in h.devices){var k=h.devices[g],e;for(e in k.channels){var l=k.channels[e];l.data&&"Generic"!=l.data||!c[e]||(c[e].type&&-1==c[e].type.indexOf(":")&&"Generic"==l.data?d.push(g):l.data=c[e].type)}}for(k=0;k<d.length;k++)d[k]&&delete h.devices[d[k]]}return a};
b.prototype.getDevices=function(a){var c=this;this._getEntities(function(b,d){b?a&&a(b):c._getDeviceStates(function(b,f){if(b)a&&a(b);else{var k=c._addSpecialTypesFromStates(d,f);a&&a(null,k)}})})};b.prototype.getMessages=function(a){this._doRequest(null,{"xsi:type":"GetMessageListRequest"},null,function(c){a&&(c&&c.data?a&&a(c.data):a&&a(null))})};b.prototype.executeCommand=function(a,c,b){if(a&&a.channels){var d=null,h=null;if("on"==c||"off"==c||"toggle"==c)h="SwitchActuator";else if("auto"==c||
"manu"==c||"tempOff"==c||0==c.indexOf("tempTo"))h="RoomTemperatureActuator";else if("dimUp"==c||"dimDown"==c||0==c.indexOf("dimTo"))h="DimmerActuator";else if("moveUp"==c||"moveDown"==c||0==c.indexOf("moveTo"))h="RollerShutterActuator";else if("alarmOn"==c||"alarmOff"==c||"alarmToggle"==c)h="AlarmActuator";else if("boolTrue"==c||"boolFalse"==c||"boolToggle"==c||0==c.indexOf("numTo"))h="GenericActuator";if(h){for(var g in a.channels)if(a.channels.hasOwnProperty(g)&&a.channels[g]&&a.channels[g].type==
h){d=a.channels[g];break}d?this._executeCommand(d,c,b):b&&b(Error("device has no channel:"+h))}else b&&b(Error("unknown command"))}else b&&b(Error("device format invalid"))};b.prototype._executeCommand=function(a,c,b){if(a&&a.type&&a.address)if("undefined"==typeof c||null==c)b&&b(Error("command invalid"));else{var d=this,h=null,g=null,k=!0;switch(a.type){case "SwitchActuator":switch(c){case "on":g="True";break;case "off":g="False";break;case "toggle":k=!1,this._getDeviceState(a.address,function(c,
e){c||!e?(c||(c=Error("current state rsp of switch is invalid")),b&&b(c)):"off"==e.state?d._executeCommand(a,"on",b):d._executeCommand(a,"off",b)})}g&&(h='<ActuatorStates><LogicalDeviceState xsi:type="SwitchActuatorState" LID="'+a.address+'" IsOn="'+g+'" /></ActuatorStates>');break;case "DimmerActuator":switch(c){case "dimUp":case "dimDown":k=!1;this._getDeviceState(a.address,function(e,h){if(e||!h)e||(e=Error("current state rsp of dimmer is invalid")),b&&b(e);else{var g=parseInt(h.state);isNaN(g)?
b&&b(Error("current dimmer state invalid")):(g="dimUp"==c?g+5:g-5,d._executeCommand(a,"dimTo"+g,b))}});break;default:0==c.indexOf("dimTo")&&(g=parseInt(c.replace(/dimTo/g,"")),0>g&&(g=0),100<g&&(g=100))}"undefined"!=typeof g&&null!=g&&(h='<ActuatorStates><LogicalDeviceState xsi:type="DimmerActuatorState" LID="'+a.address+'" DmLvl="'+g+'" /></ActuatorStates>');break;case "RollerShutterActuator":switch(c){case "moveUp":case "moveDown":k=!1;this._getDeviceState(a.address,function(e,g){if(e||!g)e||(e=
Error("current state rsp of blind is invalid")),b&&b(e);else{var h=parseInt(g.state);isNaN(h)?b&&b(Error("current blind state invalid")):(h="moveUp"==c?h+5:h-5,d._executeCommand(a,"moveTo"+h,b))}});break;default:0==c.indexOf("moveTo")&&(g=parseInt(c.replace(/moveTo/g,"")),0>g&&(g=0),100<g&&(g=100))}"undefined"!=typeof g&&null!=g&&(h='<ActuatorStates><LogicalDeviceState xsi:type="RollerShutterActuatorState" LID="'+a.address+'" ><ShutterLevel>'+g+"</ShutterLevel></LogicalDeviceState></ActuatorStates>");
break;case "RoomTemperatureActuator":switch(c){case "manu":h='<ActuatorStates><LogicalDeviceState xsi:type="RoomTemperatureActuatorState" LID="'+a.address+'" OpnMd="Manu" /></ActuatorStates>';break;case "auto":h='<ActuatorStates><LogicalDeviceState xsi:type="RoomTemperatureActuatorState" LID="'+a.address+'" OpnMd="Auto" /></ActuatorStates>';break;case "tempOff":h='<ActuatorStates><LogicalDeviceState xsi:type="RoomTemperatureActuatorState" LID="'+a.address+'" PtTmp="6.0" /></ActuatorStates>';break;
default:0==c.indexOf("tempTo")&&(g=c.replace(/tempTo/g,""),g=(parseFloat(g)/2).toFixed(1),h='<ActuatorStates><LogicalDeviceState xsi:type="RoomTemperatureActuatorState" LID="'+a.address+'" PtTmp="'+g+'" /></ActuatorStates>')}break;case "AlarmActuator":switch(c){case "alarmOn":g="True";break;case "alarmOff":g="False";break;case "alarmToggle":k=!1,this._getDeviceState(a.address,function(c,e){c?b&&b(c):e&&"off"==e.state?d._executeCommand(a,"alarmOn",b):d._executeCommand(a,"alarmOff",b)})}g&&(h='<ActuatorStates><LogicalDeviceState xsi:type="AlarmActuatorState" LID="'+
a.address+'" IsOn="'+g+'" /></ActuatorStates>');break;case "GenericActuator":var e=null,l=null,g=null;if(a.data){var m=a.data.split(":");if(2==m.length)if(e=m[0],l=m[1],"on"==c||"true"==c||"boolTrue"==c)g="True";else if("off"==c||"false"==c||"boolFalse"==c)g="False";else if(0==c.indexOf("numTo"))g=c.replace(/numTo/g,""),g=parseFloat(g),(m=this._buildCMDStatus(a,c))&&this._updateStatusBuffer(m);else if("boolToggle"==c){k=!1;this._getDeviceState(a.address,function(c,e){c||!e?(c||(c=Error("current state rsp of switch is invalid")),
b&&b(c)):"false"==e.state?d._executeCommand(a,"true",b):d._executeCommand(a,"false",b)});break}}e&&l&&null!=g&&(h='<ActuatorStates><LogicalDeviceState xsi:type="GenericDeviceState" LID="'+a.address+'"><Ppts><Ppt xsi:type="'+e+'" Name="'+l+'" Value="'+g+'" /></Ppts></LogicalDeviceState></ActuatorStates>')}k&&(h?this._sendRequest(null,{"xsi:type":"SetActuatorStatesRequest"},h,function(e){if(!e){var h=d._buildCMDStatus(a,c);h&&d._updateStatusBuffer(h)}b&&b(e)}):b&&b(Error("unknow command")))}else b&&
b(Error("channel format invalid"))};b.prototype._buildCMDStatus=function(a,c){if(!(a&&a.address&&a.type&&c))return null;var b=null,d;switch(a.type){case "SwitchActuator":if("on"==c||"off"==c)b={},b[a.address]={state:{state:c},type:"SwitchActuatorState"};break;case "DimmerActuator":0==c.indexOf("dimTo")&&(b={},d=parseInt(c.replace(/dimTo/g,"")),0>d&&(d=0),100<d&&(d=100),b[a.address]={state:{state:""+d},type:"DimmerActuatorState"});break;case "RollerShutterActuator":0==c.indexOf("moveTo")&&(b={},d=
parseInt(c.replace(/moveTo/g,"")),0>d&&(d=0),100<d&&(d=100),b[a.address]={state:{state:""+d},type:"RollerShutterActuatorState"});break;case "RoomTemperatureActuator":if("auto"==c||"manu"==c)b={},b[a.address]={state:{mode:c},type:"RoomTemperatureActuatorState"},(d=this._getSingleBufferedStatus(a.address))&&d.state&&(b[a.address].state.state=d.state.state);else if("tempOff"==c||0==c.indexOf("tempTo"))b={},"tempOff"==c?d="6.0":(d=c.replace(/tempTo/g,""),d=(parseFloat(d)/2).toFixed(1)),b[a.address]={state:{state:d},
type:"RoomTemperatureActuatorState"},(d=this._getSingleBufferedStatus(a.address))&&d.state&&(b[a.address].state.mode=d.state.mode);break;case "AlarmActuator":if("alarmOn"==c||"alarmOff"==c)b={},b[a.address]={state:{state:"alarmOn"==c?"on":"off"},type:"AlarmActuatorState"};break;case "GenericActuator":"boolTrue"==c||"boolFalse"==c?(b={},b[a.address]={state:{state:"boolTrue"==c?"true":"false"},type:a.data}):0==c.indexOf("numTo")&&(b={},d=parseFloat(c.replace(/numTo/g,"")),b[a.address]={state:{state:""+
d},type:a.data});break;default:return null}return b};b.prototype.getStates=function(a,c,b){var d=this;this.CommandHandler=a;this._getDeviceStates(function(a,g){for(var k=0;k<c.length;k++)if(g&&g[c[k].address]){var e=c[k],l=g[c[k].address].state,m=d.getStateValues(e.subtype,l);if(d.CommandHandler&&d.CommandHandler.setState)for(var n in m)"state"==n?d.CommandHandler.setState(e.id,m[n]):d.CommandHandler.setState(e.id+":"+n,m[n]);else d.CommandHandler&&d.CommandHandler.receivedState&&d.CommandHandler.receivedState("rwe",
e.address,l);if(b)for(n in m);}b&&b(a,g)})};b.prototype.getStateValues=function(a,c){return c};b.prototype.executeCommandCreator=function(a,c,b){if(a)if(c&&c.value){var d=c.value;if("tempAuto"==c.value)d="auto";else if("tempManu"==c.value)d="manu";else if("tempTo"==c.value){if("undefined"==typeof c.ext||null==c.ext){b&&b(Error("command setTo ext format invalid"));return}d=parseFloat(c.ext);d=c.value+2*d}else if("dimTo"==c.value){if("undefined"==typeof c.ext||null==c.ext){b&&b(Error("command dimTo ext format invalid"));
return}d=c.value+c.ext}else if("moveTo"==c.value){if("undefined"==typeof c.ext||null==c.ext){b&&b(Error("command dimTo ext format invalid"));return}d=c.value+c.ext}else if("numTo"==c.value){if("undefined"==typeof c.ext||null==c.ext){b&&b(Error("command numTo ext format invalid"));return}d=c.value+c.ext}this.executeCommand(a,d,function(a){b&&b(a)})}else b&&b(Error("command json format invalid"));else b&&b(Error("device json format invalid"))};b.prototype.getStatesCreator=function(a,c,b){if(c)if(0==
c.length)b&&b(null,[]);else{var d=this;this.getStates(a,[],function(a,g){var k=[];if(g)for(var e=0;e<c.length;e++)if(c[e]&&c[e].id){var l="?",m=d._findStatusChannel(c[e].device,c[e].status);m&&m.address&&c[e].status&&c[e].status.value&&g[m.address]&&(l=d._resolveState(m,c[e].status,g[m.address]));if("undefined"==typeof l||null==l)l="?";k.push({id:c[e].id,status:l})}b&&b(null,k)})}else b&&b(Error("deviceList is null"))};b.prototype.refreshStates=function(){var a=this;this._getUpd(function(c,b){!c&&
b&&a._updateStatusBuffer(b)})};b.prototype._findStatusChannel=function(a,c){if(!(a&&a.channels&&c&&c.value))return null;var b=null,d=null;switch(c.value){case "switchState":d="SwitchActuator";break;case "dimLevel":d="DimmerActuator";break;case "blindPos":d="RollerShutterActuator";break;case "humState":d="RoomHumiditySensor";break;case "tempState":d="RoomTemperatureSensor";break;case "tempMode":case "setTempState":d="RoomTemperatureActuator";break;case "alarmState":d="AlarmActuator";break;case "contactState":d=
"WindowDoorSensor";break;case "smokeState":d="SmokeDetectionSensor";break;case "boolState":case "numState":case "stringState":d="GenericActuator";break;default:return null}if(!d)return null;for(var h in a.channels)if(a.channels.hasOwnProperty(h)&&a.channels[h]&&a.channels[h].type==d){b=a.channels[h];break}return b};b.prototype._resolveState=function(a,b,f){if(!(a&&a.type&&b&&b.value&&f&&f.type&&f.state))return null;var d=null;switch(a.type){case "SwitchActuator":"SwitchActuatorState"==f.type&&(d=
f.state.state);break;case "DimmerActuator":"DimmerActuatorState"==f.type&&(d=parseInt(f.state.state));break;case "RollerShutterActuator":"RollerShutterActuatorState"==f.type&&(d=parseInt(f.state.state));break;case "RoomHumiditySensor":"RoomHumiditySensorState"==f.type&&(d=parseFloat(f.state.state).toFixed(1));break;case "RoomTemperatureSensor":"RoomTemperatureSensorState"==f.type&&(d=parseFloat(f.state.state).toFixed(1));break;case "RoomTemperatureActuator":"RoomTemperatureActuatorState"==f.type&&
("setTempState"==b.value?d=parseFloat(f.state.state).toFixed(1):"tempMode"==b.value&&(d=f.state.mode));break;case "AlarmActuator":"AlarmActuatorState"==f.type&&(d=f.state.state);break;case "WindowDoorSensor":"WindowDoorSensorState"==f.type&&(d=f.state.state);break;case "SmokeDetectionSensor":"SmokeDetectionSensorState"==f.type&&(d=f.state.state);break;case "GenericActuator":f.type==a.data&&(d=f.state.state);break;default:return null}return d};b.prototype.toJSON=function(){return{sys:"rwe",ip:this.ip,
port:this.port,username:this.user,password:this.password}};b.prototype.equalsTo=function(a){return a&&a instanceof b?this.ip==a.ip&&this.port==a.port&&this.user==a.user&&this.password==a.password:!1};return b}();
xnm.aio.rwe.DM=function(){var b=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};b.prototype=Error();b.prototype.name="RWEDMError";b.prototype.code=0;b.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"rwe",MAP:{SwitchActuator:{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"switch status",ref:{value:"switchState",
options:["on","off"]}}]},DimmerActuator:{command:[{type:"enum",name:"dim down",ref:{value:"dimUp"}},{type:"enum",name:"dim up",ref:{value:"dimDown"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d"}}],status:[{type:"int",name:"dim level",ref:{value:"dimLevel"}}]},RollerShutterActuator:{command:[{type:"enum",name:"move down",ref:{value:"moveUp"}},{type:"enum",name:"move up",ref:{value:"moveDown"}},{type:"int",name:"move to",ref:{value:"moveTo",ext:"%d"}}],status:[{type:"int",name:"blind position",
ref:{value:"blindPos"}}]},RoomHumiditySensor:{status:[{type:"float",name:"humidity",ref:{value:"humState"}}]},RoomTemperatureSensor:{status:[{type:"float",name:"temperature",ref:{value:"tempState"}}]},RoomTemperatureActuator:{command:[{type:"enum",name:"auto mode",ref:{value:"tempAuto"}},{type:"enum",name:"manual mode",ref:{value:"tempManu"}},{type:"enum",name:"thermostat off",ref:{value:"tempOff"}},{type:"float",name:"set temperature",ref:{value:"tempTo",ext:"%f",extMeta:"6.0-30.0",scale:"0.5"}}],
status:[{type:"enum",name:"thermostat mode",ref:{value:"tempMode",options:["auto","manu"]}},{type:"float",name:"target temperature",ref:{value:"setTempState"}}]},AlarmActuator:{command:[{type:"enum",name:"alarm off",ref:{value:"alarmOff"}},{type:"enum",name:"alarm on",ref:{value:"alarmOn"}},{type:"enum",name:"alarm toggle",ref:{value:"alarmToggle"}}],status:[{type:"enum",name:"alarm status",ref:{value:"alarmState",options:["on","off"]}}]},WindowDoorSensor:{status:[{type:"enum",name:"contact status",
ref:{value:"contactState",options:["open","closed"]}}]},SmokeDetectionSensor:{status:[{type:"enum",name:"smoke alarm status",ref:{value:"smokeState",options:["on","off"]}}]},GenericActuator:{BooleanProperty:{command:[{type:"enum",name:"set true",ref:{value:"boolTrue"}},{type:"enum",name:"set false",ref:{value:"boolFalse"}},{type:"enum",name:"boolean toggle",ref:{value:"boolToggle"}}],status:[{type:"enum",name:"boolean state",ref:{value:"boolState",options:["true","false"]}}]},NumericProperty:{command:[{type:"float",
name:"set numeric value",ref:{value:"numTo",ext:"%f"}}],status:[{type:"float",name:"numberic state",ref:{value:"numState",options:["true","false"]}}]}}},getGatewayType:function(){return[{sys:this.SYS,name:"RWE / innogy SmartHome",port:443}]},getGatewayDeviceType:function(){return[]},createGateway:function(a,c,f){c=b.ERROR_CODE;a?a.ip?a.username?a.password?f(null,a):f(new b(c.INVALID,"password is invalid")):f(new b(c.INVALID,"username is invalid")):f(new b(c.INVALID,"ip is invalid")):f(new b(c.INVALID,
"info is invalid"))},updateGateway:function(a,c,f,d){a=b.ERROR_CODE;c?c.ip?c.username?c.password?d(null,c):d(new b(a.INVALID,"password is invalid")):d(new b(a.INVALID,"username is invalid")):d(new b(a.INVALID,"ip is invalid")):d(new b(a.INVALID,"update is invalid"))},deleteGateway:function(a,b,f){f()},createDevice:function(a,c,f){var d=b.ERROR_CODE;if(a)if(a.gateway)if(a.address)if(a.type)if(c.data&&c.data.gateways&&0!==c.data.gateways.length){c=c.data.gateways;var h,g;for(h=0;h<c.length;h++)if(c[h].index===
a.gateway){g=c[h];break}g?f(null,a):f(new b(d.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else f(new b(d.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else f(new b(d.INVALID,"type is invalid"));else f(new b(d.INVALID,"address is invalid"));else f(new b(d.INVALID,"gateway is invalid"));else f(new b(d.INVALID,"info is invalid"))},updateDevice:function(a,c,f){var d=b.ERROR_CODE;if(a)if(a.gateway)if(a.address)if(a.type)if(c.data&&c.data.gateways&&0!==c.data.gateways.length){c=
c.data.gateways;var h,g;for(h=0;h<c.length;h++)if(c[h].index===a.gateway){g=c[h];break}g?f(null,a):f(new b(d.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else f(new b(d.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else f(new b(d.INVALID,"type is invalid"));else f(new b(d.INVALID,"address is invalid"));else f(new b(d.INVALID,"gateway is invalid"));else f(new b(d.INVALID,"info is invalid"))},deleteDevice:function(a,b,f){f()},applyUIFilter:function(a,b){var f=this,d=function(a,
b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},h=function(a,b,c){var e=[];switch(c.catagory){case "command":a.command&&a.command.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},g=function(a,b){var c=[],d=null;if(d=f.getCommandStatusMap(a))d=h(d,a,b),c=c.concat(d);return c};if(!a)return null;
var k=JSON.parse(JSON.stringify(a)),e=null;switch(b.catagory){case "command":e=g(a,b);k.command=e;break;case "status":e=g(a,b);k.status=e;break;default:return null}return e&&0!=e.length?k:null},getCommandStatusMap:function(a){if(!a||!a.channels)return null;var b={command:[],status:[]},f;for(f in a.channels){var d=a.channels[f];if(d&&d.type&&this.MAP[d.type]){var h=this.MAP[d.type];if("GenericActuator"==d.type&&d.data&&(d=d.data.split(":"),2<=d.length&&h[d[0]]))return h[d[0]];h&&h.command&&(b.command=
b.command.concat(h.command));h&&h.status&&(b.status=b.status.concat(h.status))}}return b}}}();
xnm.aio.rwe.Handler=function(){var b=function(){};b.prototype.Central=xnm.aio.rwe.Central;b.prototype.devicemanager=xnm.aio.rwe.DM;b.prototype.discoverCentrals=function(a,b){var f=require("x.mdns.js");f.clearRecordBuffer();f.discoverServiceWithTimeout("_http._tcp.local",a,function(a,f){if(a)b&&b(a);else{for(var g=[],k=0;k<f.length;k++){var e=f[k];e.target&&e.ip&&0<e.ip.length&&0==e.target.indexOf("SMARTHOME")&&(e=new xnm.aio.rwe.Central(e.ip[0]),g.push(e))}b&&b(null,g)}})};b.prototype.registModule=
function(a){a.register(this.devicemanager.SYS,"rwe")};b.prototype.resolveGateway=function(a){return a&&a.ip?new this.Central(a.ip,a.port,a.username,a.password):null};b.prototype.getDeviceCommands=function(a,b){var f=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}),f=f?f.command:[];b&&b(null,f)};b.prototype.getDeviceStatus=function(a,b){var f=this.devicemanager.applyUIFilter(a,{catagory:"status",elems:"*"}),f=f?f.status:[];b&&b(null,f)};b.prototype.doCommand=function(a,b,f,d){(a=
this.resolveGateway(a))?a.executeCommandCreator(b,f,function(a){d&&d(a)}):d&&d(Error("gateway json format invalid"))};b.prototype.doStatus=function(a,b,f,d,h){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:f,status:d}],function(a,b){a?h&&h(a):h&&h(null,b[0])}):h&&h(Error("gateway json format invalid"))};b.prototype.getDeviceList=function(a,b){var f=this.resolveGateway(a);f?f.getDevices(function(a,f){b&&b(a,f)}):b&&b(Error("gateway json format invalid"))};b.prototype.getStateValues=
function(a,b){return(new xnm.aio.rwe.Central).getStateValues(a.type,b)};b.prototype.getDeviceCommandList=function(a,b,f){var d=[];b?(d.push({id:window.XC_Text.on,cmd:"on"}),d.push({id:window.XC_Text.off,cmd:"off"})):f&&("SwitchActuator"==a.type?(d.push({id:"on",cmd:"on"}),d.push({id:"off",cmd:"off"}),d.push({id:"toggle",cmd:"toggle"})):"DimmerActuator"==a.type?(d.push({id:"off",cmd:"dimTo0"}),d.push({id:"dimTo",cmd:"dimTo",step:"1",min:"0",max:"100"})):"RollerShutterActuator"==a.type?(d.push({id:"moveUp",
cmd:"moveTo0"}),d.push({id:"moveDown",cmd:"moveTo100"}),d.push({id:"moveTo",cmd:"moveTo",step:"1",min:"0",max:"100"})):"RoomTemperatureActuator"==a.type?(d.push({id:"setTo",cmd:"tempTo",step:"0.5",min:"6.5",max:"30",fact:"2"}),d.push({id:"off",cmd:"tempTo12"}),d.push({id:"setAuto",cmd:"auto"}),d.push({id:"setManu",cmd:"manu"})):"GenericActuator"==a.type&&("BooleanProperty:Value"==a.data?(d.push({id:"true",cmd:"true"}),d.push({id:"false",cmd:"false"})):"NumericProperty:Brightness"==a.data&&(d.push({id:"off",
cmd:"setTo0"}),d.push({id:"setTo",cmd:"setTo",step:"1",min:"0",max:"100"}))));return d};b.prototype.finalize=function(a){var b=a;setTimeout(function(){b&&(b(),b=null)},3E3);xnm.aio.rwe.Cache.finalize(function(){b&&(b(),b=null)})};b.prototype.pause=function(a){this.finalize(a)};return b}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.rwe.Handler);
