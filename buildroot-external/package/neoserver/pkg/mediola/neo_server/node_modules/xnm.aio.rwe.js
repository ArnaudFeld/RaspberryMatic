var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,c,b){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var h=a[e];if(c.call(b,h,e,a))return{i:e,v:h}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,b){a!=Array.prototype&&a!=Object.prototype&&(a[c]=b.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,c,b,d){if(c){b=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in b||(b[e]={});b=b[e]}a=a[a.length-1];d=b[a];c=c(d);c!=d&&null!=c&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:c})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(c,b){return $jscomp.findInternal(this,c,b).v}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.rwe=xnm.aio.rwe||{};
xnm.aio.rwe.Cache={STATUS_EXPIRE_TO:3E5,_cache:{},_statusBuffer:{},_stateMachine:{},_centralBuffer:{},_getCache:function(a){return a?this._cache[a]:null},_ensureCache:function(a){if(!a)return null;this._cache[a]||(this._cache[a]={});return this._cache[a]},_getStateMachine:function(a){return a?this._stateMachine[a]:null},_ensureStateMachine:function(a){if(!a)return null;this._stateMachine[a]||(this._stateMachine[a]={state:0,loginCallbacks:[]});return this._stateMachine[a]},_getStateBuffer:function(a){return a?
this._statusBuffer[a]:null},_ensureStateBuffer:function(a){if(!a)return null;this._statusBuffer[a]||(this._statusBuffer[a]={});return this._statusBuffer[a]},setSessionID:function(a,c){if(!a)return null;a=this._ensureCache(a);if(!a)return null;a.sessionID=c},getSessionID:function(a){return a?(a=this._getCache(a))?a.sessionID:null:null},setCurrentConfig:function(a,c){if(!a)return null;a=this._ensureCache(a);if(!a)return null;a.currentConfig=c},getCurrentConfig:function(a){return a?(a=this._getCache(a))?
a.currentConfig:null:null},setVersion:function(a,c){if(!a)return null;a=this._ensureCache(a);if(!a)return null;a.version=c},getVersion:function(a){return a?(a=this._getCache(a))&&a.version?a.version:"1.70":null},setStateMachineState:function(a,c){a&&(a=this._ensureStateMachine(a))&&(a.state=c?c:0)},getStateMachineState:function(a){return a?(a=this._getStateMachine(a))&&a.state?a.state:0:null},addLoginCallback:function(a,c){if(!a||!c)return null;if(a=this._ensureStateMachine(a))a.loginCallbacks||(a.loginCallbacks=
[]),a.loginCallbacks.push(c)},getLoginCallbacks:function(a){return a?(a=this._getStateMachine(a))?a.loginCallbacks:null:null},clearLoginCallbacks:function(a){if(!a)return null;if(a=this._getStateMachine(a))a.loginCallbacks=[]},setCentral:function(a,c){if(!a)return null;this._centralBuffer[a]=c},getCentral:function(a){return this._centralBuffer[a]},setStatusBuffer:function(a,c){if(!a)return null;var b=this._ensureStateBuffer(a);if(b){var d=this;null==b.timer&&(b.timer=setInterval(function(){var b=
d.getCentral(a);b&&b.refreshStates()},2E3));b.status=c;b.timestamp=(new Date).getTime()}},getStatusBuffer:function(a){if(!a)return null;var c=(new Date).getTime(),b=this._ensureStateBuffer(a);if(!b.status)return b.status={},b.timestamp=c,null;if(b.timestamp&&-b.timestamp>this.STATUS_EXPIRE_TO)return b.timestamp=c,null;var d=this;null==b.timer&&(b.timer=setInterval(function(){var b=d.getCentral(a);b&&b.refreshStates()},2E3));return b.status},updateStatusBuffer:function(a,c){if(!a||!c)return null;a=
this._ensureStateBuffer(a);a.status||(a.status={});var b=!1,d;for(d in c)c.hasOwnProperty(d)&&c[d]&&(b=!0,a.status[d]=c[d]);b&&(a.timestamp=(new Date).getTime())},getSingleBufferedStatus:function(a,c){if(!a||!c)return null;a=this._ensureStateBuffer(a);return a.status?a.status[c]:null},finalize:function(a){var c=(new Date).getTime()-24E4,b;for(b in this._statusBuffer)if(this._statusBuffer.hasOwnProperty(b)){var d=this._statusBuffer[b];d&&(d.timer&&(clearInterval(d.timer),d.timer=null),d.timestamp=
c)}a&&a()}};
xnm.aio.rwe.Central=function(){var a=function(c,b,d,a){this._logger=require("x.logger.js").getLogger("xnm.aio.rwe.Central");this.ip=c;this.port=b;b||(this.port=443);this.user=d;this.password=a;this._clientID=this._generateGUID();this.CommandHandler=null};a.DEVICE_TYPE_LIST="SwitchActuator DimmerActuator RollerShutterActuator RoomHumiditySensor RoomTemperatureSensor RoomTemperatureActuator AlarmActuator WindowDoorSensor SmokeDetectionSensor GenericActuator".split(" ");a.prototype._getSessionID=function(){return xnm.aio.rwe.Cache.getSessionID(this.ip)};
a.prototype._setSessionID=function(c){return xnm.aio.rwe.Cache.setSessionID(this.ip,c)};a.prototype._getCurrentConfig=function(){return xnm.aio.rwe.Cache.getCurrentConfig(this.ip)};a.prototype._setCurrentConfig=function(c){return xnm.aio.rwe.Cache.setCurrentConfig(this.ip,c)};a.prototype._getVersion=function(){return xnm.aio.rwe.Cache.getVersion(this.ip)};a.prototype._setVersion=function(c){return xnm.aio.rwe.Cache.setVersion(this.ip,c)};a.prototype._getStateMachineState=function(){return xnm.aio.rwe.Cache.getStateMachineState(this.ip)};
a.prototype._setStateMachineState=function(c){xnm.aio.rwe.Cache.setStateMachineState(this.ip,c)};a.prototype._addLoginCallback=function(c){xnm.aio.rwe.Cache.addLoginCallback(this.ip,c)};a.prototype._getLoginCallbacks=function(){return xnm.aio.rwe.Cache.getLoginCallbacks(this.ip)};a.prototype._clearLoginCallbacks=function(){xnm.aio.rwe.Cache.clearLoginCallbacks(this.ip)};a.prototype._setBufferedCentral=function(){xnm.aio.rwe.Cache.setCentral(this.ip,this)};a.prototype._getStatusBuffer=function(){return xnm.aio.rwe.Cache.getStatusBuffer(this.ip)};
a.prototype._setStatusBuffer=function(c){xnm.aio.rwe.Cache.setStatusBuffer(this.ip,c)};a.prototype._updateStatusBuffer=function(c){xnm.aio.rwe.Cache.updateStatusBuffer(this.ip,c)};a.prototype._getSingleBufferedStatus=function(c){return xnm.aio.rwe.Cache.getSingleBufferedStatus(this.ip,c)};a.prototype._generateGUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var b=16*Math.random()|0;return("x"==c?b:b&3|8).toString(16)})};a.prototype._parseDeviceData=function(c){var b=
{},d={},e={},h={};c.find("LC").each(function(){var b=$(this),c=b.find("Name");b=b.find("Id");c&&b&&(d[$(b[0]).text()]={name:$(c[0]).text(),devices:{}})});c.find("BD").each(function(){var b=$(this).find("Id");b&&(e[$(b[0]).text()]={address:$(b[0]).text(),channels:{}})});c.find("LD").each(function(){var b=$(this),c=b.attr("xsi:type");if(c){var d=b.attr("Name"),a=b.attr("LCID"),e=b.find("BDId");e=e&&0<e.length?$(e[0]).text():null;var g=b.find("UDvIds");g=g&&0<g.length?(g=$(g[0]).find("guid"))&&0<g.length?
$(g[0]).text():null:null;var f=b.find("Id");f=f&&0<f.length?$(f[0]).text():null;c={name:d,type:c,address:f,bid:e,udvid:g,lid:a};(b=b.find("ActCls"))&&0<b.length&&(c.data=$(b[0]).text());h[f]=c}});for(var g in h)if(h.hasOwnProperty(g)&&(c=h[g],c.type&&-1!=a.DEVICE_TYPE_LIST.indexOf(c.type)&&c.lid&&d[c.lid]))if("GenericActuator"==c.type&&c.address)d[c.lid].devices[c.address]={address:c.address,channels:{}},k=d[c.lid].devices[c.address],delete c.bid,delete c.udvid,delete c.lid,k.channels[c.address]=
c;else{var f=c.bid;!f&&c.udvid&&h[c.udvid]&&h[c.udvid].bid&&(f=h[c.udvid].bid);if(f&&e[f]&&c.address){var k=d[c.lid].devices[f];k||(d[c.lid].devices[f]=e[f],k=d[c.lid].devices[f]);delete c.bid;delete c.udvid;delete c.lid;k.channels[c.address]=c}}b.data=d;return b};a.prototype._parseMessageData=function(c){var b={},d={};c.find("MessageContainer").each(function(){var b=$(this),c=b.attr("State");if(b=b.find("Message")){b=$(b[0]);var a=b.attr("Id"),f=b.attr("Type"),k=b.attr("TimeStamp");if(a&&f&&k){d[a]=
{type:f,time:k,read:"Read"==c};var l={};b.find("MessageParameter").each(function(){var b=$(this),c=b.attr("Key");b=b.attr("Value");c&&b&&(l[c]=b)});d[a].params=l}}});b.data=d;return b};a.prototype._parseDeviceStateData=function(c){var b={},d={};c.find("LogicalDeviceState").each(function(){var b=$(this),c=b.attr("LID"),a=b.attr("xsi:type");if(c&&a){var f=null;if("SwitchActuatorState"==a){f={state:"?"};var k=b.attr("IsOn");"True"==k?f.state="on":"False"==k&&(f.state="off")}else if("DimmerActuatorState"==
a)f={state:"?"},k=b.attr("DmLvl")||"0","string"==typeof k&&0<k.length&&(f.state=parseInt(k));else if("RollerShutterActuatorState"==a)f={state:"?"},(b=b.find("ShutterLevel"))&&0<b.length&&(f.state=parseInt($(b[0]).text())||0);else if("RoomHumiditySensorState"==a)f={state:"?"},k=b.attr("Humidity"),"string"==typeof k&&0<k.length&&(f.state=k);else if("RoomTemperatureSensorState"==a)f={state:"?"},k=b.attr("Temperature"),"string"==typeof k&&0<k.length&&(f.state=parseFloat(k).toFixed(1));else if("RoomTemperatureActuatorState"==
a)f={state:"?"},k=b.attr("PtTmp"),"string"==typeof k&&0<k.length&&(f.state=parseFloat(k).toFixed(1)),k=b.attr("OpnMd"),"string"==typeof k&&0<k.length&&(f.mode=k.toLowerCase());else if("AlarmActuatorState"==a)f={state:"?"},(k=b.attr("IsOn"))&&(k=k.toLowerCase()),"true"==k?f.state="on":"false"==k&&(f.state="off");else if("WindowDoorSensorState"==a)f={state:"?"},(b=b.find("IsOpen"))&&0<b.length&&((k=$(b[0]).text())&&(k=k.toLowerCase()),"true"==k?f.state="open":"false"==k&&(f.state="closed"));else if("SmokeDetectionSensorState"==
a)f={state:"?"},(b=b.find("IsSmokeAlarm"))&&0<b.length&&((k=$(b[0]).text())&&(k=k.toLowerCase()),"true"==k?f.state="on":"false"==k&&(f.state="off"));else if("GenericDeviceState"==a){f={state:"?"};var l=b.find("Ppt");if(l&&0<l.length){l=$(l[0]);b=l.attr("xsi:type");k=l.attr("Name");l=l.attr("Value");if("undefined"==typeof l||null==l)l="?";"string"==typeof b&&0<b.length&&"string"==typeof k&&0<k.length&&"string"==typeof l&&("BooleanProperty"==b?(f.state=l.toLowerCase(),a="BooleanProperty:Value"):(f.state=
l,a=b+":"+k))}}f&&(d[c]={state:f,type:a})}});b.data=d;return b};a.prototype._parseResult=function(c){var b={};c=$($($.parseXML(c)).children()[0]);if(!c)return b.error="invalid reponse",b;if("NotificationList"==c.prop("tagName"))b=this._parseDeviceStateData(c);else switch(c.attr("xsi:type")){case "AuthenticationErrorResponse":b.error=c.attr("Error");break;case "VersionMismatchErrorResponse":var a=c.attr("Version");this._setVersion(a);b.error="VersionMismatch";break;case "AcknowledgeResponse":b.data=
{result:"ok"};break;case "ControlResultResponse":"Ok"==c.attr("Result")?b.data={result:"ok"}:b.error=c.attr("Result");break;case "LoginResponse":(a=c.attr("SessionId"))&&this._setSessionID(a);(c=c.attr("CurrentConfigurationVersion"))&&this._setCurrentConfig(c);b.data={sessionID:a,currentConfig:c};break;case "GetEntitiesResponse":b=this._parseDeviceData(c);break;case "GetAllLogicalDeviceStatesResponse":"Ok"==c.attr("Result")?b=this._parseDeviceStateData(c):b.error=c.attr("Result");break;case "MessageListResponse":b=
this._parseMessageData(c);break;default:c.attr("Error")?b.error=c.attr("Error"):b.error="unknown response type:"+c.attr("xsi:type")}return b};a.prototype._doRequest=function(c,b,a,e){c||(c="/cmd");if("object"==typeof a&&a&&a.body)var d=a.body;else{d='<BaseRequest xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" Version="'+this._getVersion()+'" RequestId="'+this._generateGUID()+'" ';var g=this._getSessionID();g&&(d+='SessionId="'+g+'" ');d=(g=this._getCurrentConfig())?d+('BasedOnConfigVersion="'+
g+'" '):d+'BasedOnConfigVersion="0" ';for(var f in b)d+=f+'="'+b[f]+'" ';d=a&&0<a.length?d+(">"+a+"</BaseRequest>"):d+"/>"}f={};"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0",f=require("constants"));f={host:this.ip,port:this.port,path:c,method:"POST",headers:{Referer:"https://smarthome.blob.core.windows.net/silverlight/latest/application/RWE.SmartHome.UI.Shell.xap",ClientId:this._clientID,"Content-Type":"text/xml; charset=UTF-8","cache-control":"no-cache",
pragma:"no-cache","User-Agent":"Java/1.7.0_07",Accept:"text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2",Connection:"close","Content-Length":d.length},rejectUnauthorized:!1,secureOptions:f.SSL_OP_NO_TLSv1,strictSSL:!1,secureProtocol:"TLSv1_client_method"};this._logger.log("trace","do request:"+JSON.stringify(f));var k=this,l=e,m=require("https").request(f,function(d){d.setEncoding("utf-8");var f="";d.on("data",function(b){f+=b});d.on("end",function(){k._logger.log("trace","receive code:"+d.statusCode+
" headers:"+JSON.stringify(d.headers)+" response:"+f);var h;if(200==d.statusCode)try{if((h=k._parseResult(f))&&"VersionMismatch"==h.error){k._doRequest(c,b,a,e);return}}catch(p){console.error(p);var g=p}l&&(l(g,h,d),l=null)})});if(m.on)m.on("error",function(b){k._logger.log("trace","do request error:"+b.message);l&&(l(b),l=null)});m.setTimeout&&m.setTimeout(6E4,function(){k._logger.log("trace","do request timeout");m.abort();l&&(l(Error("timeout")),l=null)});this._logger.log("trace","do request send body:"+
d);m.write(d);m.end()};a.prototype._sendRequest=function(c,b,a,e){var d=this,g=this._getSessionID(),f=this._getCurrentConfig();g&&f?this._doRequest(c,b,a,function(f,g,h){f?e&&e(f):h&&401==h.statusCode?(d._logger.log("debug","http request error with code:"+h.statusCode),d._setSessionID(null),d._setCurrentConfig(null),d._sendRequest(c,b,a,e)):h&&200!=h.statusCode?(f=Error("http request error with code:"+h.statusCode),e&&e(f)):!g||"IllegalSessionId"!=g.error&&"ConfigurationOutOfDate"!=g.error?(g&&g.error&&
(d._logger.log("debug","send request response error:"+g.error),f||(f=Error(g.error))),e&&e(f,g?g.data:g)):(d._logger.log("debug","send request response error:"+g.error),d._setSessionID(null),d._setCurrentConfig(null),d._sendRequest(c,b,a,e))}):this._login(function(f){f?e&&e(f):d._sendRequest(c,b,a,e)})};a.prototype._login=function(c){this._logger.log("debug","LoginRequest");if(this.user&&this.password){if(this._addLoginCallback(c),1!=this._getStateMachineState()){this._setStateMachineState(1);c=require("x.crypt.js");
c=(new Buffer(c.SHA256(this.password),"hex")).toString("base64");var b=this;this._doRequest(null,{"xsi:type":"LoginRequest",UserName:this.user,Password:c},null,function(c,a,h){var d=b._getLoginCallbacks();b._clearLoginCallbacks();c?b._logger.log("debug","login error:"+c.message):h&&200!=h.statusCode?(b._logger.log("debug","login http error:"+h.statusCode),c=Error("login http request error with code:"+h.statusCode)):a&&a.error&&(b._logger.log("debug","login response error:"+a.error),c=Error(a.error));
c?(b._setStateMachineState(0),d&&d.forEach(function(b){b&&b(c)})):b._subscribeNotification(function(c){c?(b._setStateMachineState(0),d&&d.forEach(function(b){b&&b(c)})):(b._logger.log("debug","login success:"+JSON.stringify(a)),b._setStateMachineState(2),b._setBufferedCentral(),d&&d.forEach(function(b){b&&b(null,a?a.data:a)}))})})}}else c&&c(Error("username or password in null"))};a.prototype._subscribeNotification=function(c){this._logger.log("debug","NotificationRequest");var b=this;this._sendRequest(null,
{"xsi:type":"NotificationRequest"},"<Action>Subscribe</Action><NotificationType>DeviceStateChanges</NotificationType>",function(a,e){a&&b._logger.log("debug","NotificationRequest error:"+a.message);e&&b._logger.log("debug","NotificationRequest response:"+JSON.stringify(e));c&&c(a,e)})};a.prototype._getUpd=function(c){this._logger.log("debug","Get Update Notification");var b=this;this._sendRequest("/upd",null,{body:"upd"},function(a,e){a&&b._logger.log("debug","Update Notification error:"+a.message);
e&&b._logger.log("debug","Update Notification response:"+JSON.stringify(e));c&&c(a,e)})};a.prototype._getEntities=function(c){this._logger.log("debug","GetEntitiesRequest");var b=this;this._sendRequest(null,{"xsi:type":"GetEntitiesRequest"},"<EntityType>Configuration</EntityType>",function(a,e){a&&b._logger.log("debug","GetEntitiesRequest error:"+a.message);e&&b._logger.log("debug","GetEntitiesRequest response:"+JSON.stringify(e));c&&c(a,e)})};a.prototype._getDeviceStates=function(c){this._logger.log("debug",
"_getDeviceStates");var b=this._getStatusBuffer();if(b)console.log("status buffer",b),c&&c(null,b);else{this._logger.log("debug","GetAllLogicalDeviceStatesRequest");var a=this;this._sendRequest(null,{"xsi:type":"GetAllLogicalDeviceStatesRequest"},null,function(b,d){b?(a._logger.log("debug","GetAllLogicalDeviceStatesRequest error:"+b.message),a._setStatusBuffer(null),c&&c(b)):(d&&(a._logger.log("debug","GetAllLogicalDeviceStatesRequest response:"+JSON.stringify(d)),a._setStatusBuffer(d)),c&&c(null,
d))})}};a.prototype._getDeviceState=function(c,b){this._getDeviceStates(function(a,e){a?b&&b(a):(a=null,e&&e[c]&&(a=e[c].state),b&&b(null,a))})};a.prototype._addSpecialTypesFromStates=function(c,b){for(var a in c){var e=[],h=c[a],g;for(g in h.devices){var f=h.devices[g],k;for(k in f.channels){var l=f.channels[k];l.data&&"Generic"!=l.data||!b[k]||(b[k].type&&-1==b[k].type.indexOf(":")&&"Generic"==l.data?e.push(g):l.data=b[k].type)}}for(f=0;f<e.length;f++)e[f]&&delete h.devices[e[f]]}return c};a.prototype.getDevices=
function(c){var b=this;this._getEntities(function(a,e){a?c&&c(a):b._getDeviceStates(function(a,d){a?c&&c(a):(a=b._addSpecialTypesFromStates(e,d),c&&c(null,a))})})};a.prototype.getMessages=function(c){this._doRequest(null,{"xsi:type":"GetMessageListRequest"},null,function(b){c&&(b&&b.data?c&&c(b.data):c&&c(null))})};a.prototype.executeCommand=function(c,b,a){if(c&&c.channels){var d=null,h=null;if("on"==b||"off"==b||"toggle"==b)h="SwitchActuator";else if("auto"==b||"manu"==b||"tempOff"==b||0==b.indexOf("tempTo"))h=
"RoomTemperatureActuator";else if("dimUp"==b||"dimDown"==b||0==b.indexOf("dimTo"))h="DimmerActuator";else if("moveUp"==b||"moveDown"==b||0==b.indexOf("moveTo"))h="RollerShutterActuator";else if("alarmOn"==b||"alarmOff"==b||"alarmToggle"==b)h="AlarmActuator";else if("boolTrue"==b||"boolFalse"==b||"boolToggle"==b||0==b.indexOf("numTo"))h="GenericActuator";if(h){for(var g in c.channels)if(c.channels.hasOwnProperty(g)&&c.channels[g]&&c.channels[g].type==h){d=c.channels[g];break}d?this._executeCommand(d,
b,a):a&&a(Error("device has no channel:"+h))}else a&&a(Error("unknown command"))}else a&&a(Error("device format invalid"))};a.prototype._executeCommand=function(c,b,a){if(c&&c.type&&c.address)if("undefined"==typeof b||null==b)a&&a(Error("command invalid"));else{var d=this,h=null,g=null,f=!0;switch(c.type){case "SwitchActuator":switch(b){case "on":g="True";break;case "off":g="False";break;case "toggle":f=!1,this._getDeviceState(c.address,function(b,e){b||!e?(b||(b=Error("current state rsp of switch is invalid")),
a&&a(b)):"off"==e.state?d._executeCommand(c,"on",a):d._executeCommand(c,"off",a)})}g&&(h='<ActuatorStates><LogicalDeviceState xsi:type="SwitchActuatorState" LID="'+c.address+'" IsOn="'+g+'" /></ActuatorStates>');break;case "DimmerActuator":switch(b){case "dimUp":case "dimDown":f=!1;this._getDeviceState(c.address,function(e,f){e||!f?(e||(e=Error("current state rsp of dimmer is invalid")),a&&a(e)):(e=parseInt(f.state),isNaN(e)?a&&a(Error("current dimmer state invalid")):(e="dimUp"==b?e+5:e-5,d._executeCommand(c,
"dimTo"+e,a)))});break;default:0==b.indexOf("dimTo")&&(g=parseInt(b.replace(/dimTo/g,"")),0>g&&(g=0),100<g&&(g=100))}"undefined"!=typeof g&&null!=g&&(h='<ActuatorStates><LogicalDeviceState xsi:type="DimmerActuatorState" LID="'+c.address+'" DmLvl="'+g+'" /></ActuatorStates>');break;case "RollerShutterActuator":switch(b){case "moveUp":case "moveDown":f=!1;this._getDeviceState(c.address,function(e,f){e||!f?(e||(e=Error("current state rsp of blind is invalid")),a&&a(e)):(e=parseInt(f.state),isNaN(e)?
a&&a(Error("current blind state invalid")):(e="moveUp"==b?e+5:e-5,d._executeCommand(c,"moveTo"+e,a)))});break;default:0==b.indexOf("moveTo")&&(g=parseInt(b.replace(/moveTo/g,"")),0>g&&(g=0),100<g&&(g=100))}"undefined"!=typeof g&&null!=g&&(h='<ActuatorStates><LogicalDeviceState xsi:type="RollerShutterActuatorState" LID="'+c.address+'" ><ShutterLevel>'+g+"</ShutterLevel></LogicalDeviceState></ActuatorStates>");break;case "RoomTemperatureActuator":switch(b){case "manu":h='<ActuatorStates><LogicalDeviceState xsi:type="RoomTemperatureActuatorState" LID="'+
c.address+'" OpnMd="Manu" /></ActuatorStates>';break;case "auto":h='<ActuatorStates><LogicalDeviceState xsi:type="RoomTemperatureActuatorState" LID="'+c.address+'" OpnMd="Auto" /></ActuatorStates>';break;case "tempOff":h='<ActuatorStates><LogicalDeviceState xsi:type="RoomTemperatureActuatorState" LID="'+c.address+'" PtTmp="6.0" /></ActuatorStates>';break;default:0==b.indexOf("tempTo")&&(g=b.replace(/tempTo/g,""),g=(parseFloat(g)/2).toFixed(1),h='<ActuatorStates><LogicalDeviceState xsi:type="RoomTemperatureActuatorState" LID="'+
c.address+'" PtTmp="'+g+'" /></ActuatorStates>')}break;case "AlarmActuator":switch(b){case "alarmOn":g="True";break;case "alarmOff":g="False";break;case "alarmToggle":f=!1,this._getDeviceState(c.address,function(b,e){b?a&&a(b):e&&"off"==e.state?d._executeCommand(c,"alarmOn",a):d._executeCommand(c,"alarmOff",a)})}g&&(h='<ActuatorStates><LogicalDeviceState xsi:type="AlarmActuatorState" LID="'+c.address+'" IsOn="'+g+'" /></ActuatorStates>');break;case "GenericActuator":var k=null,l=null;g=null;if(c.data){var m=
c.data.split(":");if(2==m.length)if(k=m[0],l=m[1],"on"==b||"true"==b||"boolTrue"==b)g="True";else if("off"==b||"false"==b||"boolFalse"==b)g="False";else if(0==b.indexOf("numTo"))g=b.replace(/numTo/g,""),g=parseFloat(g),(m=this._buildCMDStatus(c,b))&&this._updateStatusBuffer(m);else if("boolToggle"==b){f=!1;this._getDeviceState(c.address,function(b,e){b||!e?(b||(b=Error("current state rsp of switch is invalid")),a&&a(b)):"false"==e.state?d._executeCommand(c,"true",a):d._executeCommand(c,"false",a)});
break}}k&&l&&null!=g&&(h='<ActuatorStates><LogicalDeviceState xsi:type="GenericDeviceState" LID="'+c.address+'"><Ppts><Ppt xsi:type="'+k+'" Name="'+l+'" Value="'+g+'" /></Ppts></LogicalDeviceState></ActuatorStates>')}f&&(h?this._sendRequest(null,{"xsi:type":"SetActuatorStatesRequest"},h,function(e){if(!e){var f=d._buildCMDStatus(c,b);f&&d._updateStatusBuffer(f)}a&&a(e)}):a&&a(Error("unknow command")))}else a&&a(Error("channel format invalid"))};a.prototype._buildCMDStatus=function(c,b){if(!(c&&c.address&&
c.type&&b))return null;var a=null;switch(c.type){case "SwitchActuator":if("on"==b||"off"==b)a={},a[c.address]={state:{state:b},type:"SwitchActuatorState"};break;case "DimmerActuator":0==b.indexOf("dimTo")&&(a={},b=parseInt(b.replace(/dimTo/g,"")),0>b&&(b=0),100<b&&(b=100),a[c.address]={state:{state:""+b},type:"DimmerActuatorState"});break;case "RollerShutterActuator":0==b.indexOf("moveTo")&&(a={},b=parseInt(b.replace(/moveTo/g,"")),0>b&&(b=0),100<b&&(b=100),a[c.address]={state:{state:""+b},type:"RollerShutterActuatorState"});
break;case "RoomTemperatureActuator":if("auto"==b||"manu"==b)a={},a[c.address]={state:{mode:b},type:"RoomTemperatureActuatorState"},(b=this._getSingleBufferedStatus(c.address))&&b.state&&(a[c.address].state.state=b.state.state);else if("tempOff"==b||0==b.indexOf("tempTo"))a={},"tempOff"==b?b="6.0":(b=b.replace(/tempTo/g,""),b=(parseFloat(b)/2).toFixed(1)),a[c.address]={state:{state:b},type:"RoomTemperatureActuatorState"},(b=this._getSingleBufferedStatus(c.address))&&b.state&&(a[c.address].state.mode=
b.state.mode);break;case "AlarmActuator":if("alarmOn"==b||"alarmOff"==b)a={},a[c.address]={state:{state:"alarmOn"==b?"on":"off"},type:"AlarmActuatorState"};break;case "GenericActuator":"boolTrue"==b||"boolFalse"==b?(a={},a[c.address]={state:{state:"boolTrue"==b?"true":"false"},type:c.data}):0==b.indexOf("numTo")&&(a={},b=parseFloat(b.replace(/numTo/g,"")),a[c.address]={state:{state:""+b},type:c.data});break;default:return null}return a};a.prototype.getStates=function(c,b,a){var d=this;this.CommandHandler=
c;this._getDeviceStates(function(c,e){for(var f=0;f<b.length;f++)if(e&&e[b[f].address]){var g=b[f],h=e[b[f].address].state,m=d.getStateValues(g.subtype,h);if(d.CommandHandler&&d.CommandHandler.setState)for(var n in m)"state"==n?d.CommandHandler.setState(g.id,m[n]):d.CommandHandler.setState(g.id+":"+n,m[n]);else d.CommandHandler&&d.CommandHandler.receivedState&&d.CommandHandler.receivedState("rwe",g.address,h);if(a)for(n in m);}a&&a(c,e)})};a.prototype.getStateValues=function(c,b){return b};a.prototype.executeCommandCreator=
function(c,b,a){if(c)if(b&&b.value){var e=b.value;if("tempAuto"==b.value)e="auto";else if("tempManu"==b.value)e="manu";else if("tempTo"==b.value){if("undefined"==typeof b.ext||null==b.ext){a&&a(Error("command setTo ext format invalid"));return}e=parseFloat(b.ext);e=b.value+2*e}else if("dimTo"==b.value){if("undefined"==typeof b.ext||null==b.ext){a&&a(Error("command dimTo ext format invalid"));return}e=b.value+b.ext}else if("moveTo"==b.value){if("undefined"==typeof b.ext||null==b.ext){a&&a(Error("command dimTo ext format invalid"));
return}e=b.value+b.ext}else if("numTo"==b.value){if("undefined"==typeof b.ext||null==b.ext){a&&a(Error("command numTo ext format invalid"));return}e=b.value+b.ext}this.executeCommand(c,e,function(b){a&&a(b)})}else a&&a(Error("command json format invalid"));else a&&a(Error("device json format invalid"))};a.prototype.getStatesCreator=function(a,b,d){if(b)if(0==b.length)d&&d(null,[]);else{var c=this;this.getStates(a,[],function(a,e){a=[];if(e)for(var f=0;f<b.length;f++)if(b[f]&&b[f].id){var g="?",h=
c._findStatusChannel(b[f].device,b[f].status);h&&h.address&&b[f].status&&b[f].status.value&&e[h.address]&&(g=c._resolveState(h,b[f].status,e[h.address]));if("undefined"==typeof g||null==g)g="?";a.push({id:b[f].id,status:g})}d&&d(null,a)})}else d&&d(Error("deviceList is null"))};a.prototype.refreshStates=function(){var a=this;this._getUpd(function(b,c){!b&&c&&a._updateStatusBuffer(c)})};a.prototype._findStatusChannel=function(a,b){if(!(a&&a.channels&&b&&b.value))return null;var c=null;switch(b.value){case "switchState":b=
"SwitchActuator";break;case "dimLevel":b="DimmerActuator";break;case "blindPos":b="RollerShutterActuator";break;case "humState":b="RoomHumiditySensor";break;case "tempState":b="RoomTemperatureSensor";break;case "tempMode":case "setTempState":b="RoomTemperatureActuator";break;case "alarmState":b="AlarmActuator";break;case "contactState":b="WindowDoorSensor";break;case "smokeState":b="SmokeDetectionSensor";break;case "boolState":case "numState":case "stringState":b="GenericActuator";break;default:return null}if(!b)return null;
for(var e in a.channels)if(a.channels.hasOwnProperty(e)&&a.channels[e]&&a.channels[e].type==b){c=a.channels[e];break}return c};a.prototype._resolveState=function(a,b,d){if(!(a&&a.type&&b&&b.value&&d&&d.type&&d.state))return null;var c=null;switch(a.type){case "SwitchActuator":"SwitchActuatorState"==d.type&&(c=d.state.state);break;case "DimmerActuator":"DimmerActuatorState"==d.type&&(c=parseInt(d.state.state));break;case "RollerShutterActuator":"RollerShutterActuatorState"==d.type&&(c=parseInt(d.state.state));
break;case "RoomHumiditySensor":"RoomHumiditySensorState"==d.type&&(c=parseFloat(d.state.state).toFixed(1));break;case "RoomTemperatureSensor":"RoomTemperatureSensorState"==d.type&&(c=parseFloat(d.state.state).toFixed(1));break;case "RoomTemperatureActuator":"RoomTemperatureActuatorState"==d.type&&("setTempState"==b.value?c=parseFloat(d.state.state).toFixed(1):"tempMode"==b.value&&(c=d.state.mode));break;case "AlarmActuator":"AlarmActuatorState"==d.type&&(c=d.state.state);break;case "WindowDoorSensor":"WindowDoorSensorState"==
d.type&&(c=d.state.state);break;case "SmokeDetectionSensor":"SmokeDetectionSensorState"==d.type&&(c=d.state.state);break;case "GenericActuator":d.type==a.data&&(c=d.state.state);break;default:return null}return c};a.prototype.toJSON=function(){return{sys:"rwe",ip:this.ip,port:this.port,username:this.user,password:this.password}};a.prototype.equalsTo=function(c){return c&&c instanceof a?this.ip==c.ip&&this.port==c.port&&this.user==c.user&&this.password==c.password:!1};return a}();
xnm.aio.rwe.DM=function(){var a=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};a.prototype=Error();a.prototype.name="RWEDMError";a.prototype.code=0;a.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"rwe",MAP:{SwitchActuator:{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"switch status",ref:{value:"switchState",
options:["on","off"]}}]},DimmerActuator:{command:[{type:"enum",name:"dim down",ref:{value:"dimUp"}},{type:"enum",name:"dim up",ref:{value:"dimDown"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d"}}],status:[{type:"int",name:"dim level",ref:{value:"dimLevel"}}]},RollerShutterActuator:{command:[{type:"enum",name:"move down",ref:{value:"moveUp"}},{type:"enum",name:"move up",ref:{value:"moveDown"}},{type:"int",name:"move to",ref:{value:"moveTo",ext:"%d"}}],status:[{type:"int",name:"blind position",
ref:{value:"blindPos"}}]},RoomHumiditySensor:{status:[{type:"float",name:"humidity",ref:{value:"humState"}}]},RoomTemperatureSensor:{status:[{type:"float",name:"temperature",ref:{value:"tempState"}}]},RoomTemperatureActuator:{command:[{type:"enum",name:"auto mode",ref:{value:"tempAuto"}},{type:"enum",name:"manual mode",ref:{value:"tempManu"}},{type:"enum",name:"thermostat off",ref:{value:"tempOff"}},{type:"float",name:"set temperature",ref:{value:"tempTo",ext:"%f",extMeta:"6.0-30.0",scale:"0.5"}}],
status:[{type:"enum",name:"thermostat mode",ref:{value:"tempMode",options:["auto","manu"]}},{type:"float",name:"target temperature",ref:{value:"setTempState"}}]},AlarmActuator:{command:[{type:"enum",name:"alarm off",ref:{value:"alarmOff"}},{type:"enum",name:"alarm on",ref:{value:"alarmOn"}},{type:"enum",name:"alarm toggle",ref:{value:"alarmToggle"}}],status:[{type:"enum",name:"alarm status",ref:{value:"alarmState",options:["on","off"]}}]},WindowDoorSensor:{status:[{type:"enum",name:"contact status",
ref:{value:"contactState",options:["open","closed"]}}]},SmokeDetectionSensor:{status:[{type:"enum",name:"smoke alarm status",ref:{value:"smokeState",options:["on","off"]}}]},GenericActuator:{BooleanProperty:{command:[{type:"enum",name:"set true",ref:{value:"boolTrue"}},{type:"enum",name:"set false",ref:{value:"boolFalse"}},{type:"enum",name:"boolean toggle",ref:{value:"boolToggle"}}],status:[{type:"enum",name:"boolean state",ref:{value:"boolState",options:["true","false"]}}]},NumericProperty:{command:[{type:"float",
name:"set numeric value",ref:{value:"numTo",ext:"%f"}}],status:[{type:"float",name:"numberic state",ref:{value:"numState",options:["true","false"]}}]}}},getGatewayType:function(){return[{sys:this.SYS,name:"RWE / innogy SmartHome",port:443}]},getGatewayDeviceType:function(){return[]},createGateway:function(c,b,d){b=a.ERROR_CODE;c?c.ip?c.username?c.password?d(null,c):d(new a(b.INVALID,"password is invalid")):d(new a(b.INVALID,"username is invalid")):d(new a(b.INVALID,"ip is invalid")):d(new a(b.INVALID,
"info is invalid"))},updateGateway:function(c,b,d,e){c=a.ERROR_CODE;b?b.ip?b.username?b.password?e(null,b):e(new a(c.INVALID,"password is invalid")):e(new a(c.INVALID,"username is invalid")):e(new a(c.INVALID,"ip is invalid")):e(new a(c.INVALID,"update is invalid"))},deleteGateway:function(a,b,d){d()},createDevice:function(c,b,d){var e=a.ERROR_CODE;if(c)if(c.gateway)if(c.address)if(c.type)if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var h;for(h=0;h<b.length;h++)if(b[h].index===
c.gateway){var g=b[h];break}g?d(null,c):d(new a(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else d(new a(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"));else d(new a(e.INVALID,"type is invalid"));else d(new a(e.INVALID,"address is invalid"));else d(new a(e.INVALID,"gateway is invalid"));else d(new a(e.INVALID,"info is invalid"))},updateDevice:function(c,b,d){var e=a.ERROR_CODE;if(c)if(c.gateway)if(c.address)if(c.type)if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=
b.data.gateways;var h;for(h=0;h<b.length;h++)if(b[h].index===c.gateway){var g=b[h];break}g?d(null,c):d(new a(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else d(new a(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"));else d(new a(e.INVALID,"type is invalid"));else d(new a(e.INVALID,"address is invalid"));else d(new a(e.INVALID,"gateway is invalid"));else d(new a(e.INVALID,"info is invalid"))},deleteDevice:function(a,b,d){d()},applyUIFilter:function(a,b){var c=this,e=function(b,
a){if("*"==b)return!0;for(var c=!1,d=0;d<b.length;d++)if(b[d]==a){c=!0;break}return c},h=function(b,a,c){var d=[];switch(c.catagory){case "command":b.command&&b.command.forEach(function(b){e(c.elems,b.type)&&(b=JSON.parse(JSON.stringify(b)),d.push(b))});break;case "status":b.status&&b.status.forEach(function(b){e(c.elems,b.type)&&(b=JSON.parse(JSON.stringify(b)),d.push(b))})}return d},g=function(b,a){var d=[],e=c.getCommandStatusMap(b);e&&(b=h(e,b,a),d=d.concat(b));return d};if(!a)return null;var f=
JSON.parse(JSON.stringify(a)),k=null;switch(b.catagory){case "command":k=g(a,b);f.command=k;break;case "status":k=g(a,b);f.status=k;break;default:return null}return k&&0!=k.length?f:null},getCommandStatusMap:function(a){if(!a||!a.channels)return null;var b={command:[],status:[]},c;for(c in a.channels){var e=a.channels[c];if(e&&e.type&&this.MAP[e.type]){var h=this.MAP[e.type];if("GenericActuator"==e.type&&e.data&&(e=e.data.split(":"),2<=e.length&&h[e[0]]))return h[e[0]];h&&h.command&&(b.command=b.command.concat(h.command));
h&&h.status&&(b.status=b.status.concat(h.status))}}return b}}}();
xnm.aio.rwe.Handler=function(){var a=function(){};a.prototype.Central=xnm.aio.rwe.Central;a.prototype.devicemanager=xnm.aio.rwe.DM;a.prototype.discoverCentrals=function(a,b){var c=require("x.mdns.js");c.clearRecordBuffer();c.discoverServiceWithTimeout("_http._tcp.local",a,function(a,c){if(a)b&&b(a);else{a=[];for(var d=0;d<c.length;d++){var e=c[d];e.target&&e.ip&&0<e.ip.length&&0==e.target.indexOf("SMARTHOME")&&(e=new xnm.aio.rwe.Central(e.ip[0]),a.push(e))}b&&b(null,a)}})};a.prototype.registModule=
function(a){a.register(this.devicemanager.SYS,"rwe")};a.prototype.resolveGateway=function(a){return a&&a.ip?new this.Central(a.ip,a.port,a.username,a.password):null};a.prototype.getDeviceCommands=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};a.prototype.getDeviceStatus=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)};a.prototype.doCommand=function(a,b,d,e){(a=this.resolveGateway(a))?
a.executeCommandCreator(b,d,function(b){e&&e(b)}):e&&e(Error("gateway json format invalid"))};a.prototype.doStatus=function(a,b,d,e,h){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:d,status:e}],function(b,a){b?h&&h(b):h&&h(null,a[0])}):h&&h(Error("gateway json format invalid"))};a.prototype.getDeviceList=function(a,b){(a=this.resolveGateway(a))?a.getDevices(function(a,c){b&&b(a,c)}):b&&b(Error("gateway json format invalid"))};a.prototype.getStateValues=function(a,b){return(new xnm.aio.rwe.Central).getStateValues(a.type,
b)};a.prototype.getDeviceCommandList=function(a,b,d){var c=[];b?(c.push({id:window.XC_Text.on,cmd:"on"}),c.push({id:window.XC_Text.off,cmd:"off"})):d&&("SwitchActuator"==a.type?(c.push({id:"on",cmd:"on"}),c.push({id:"off",cmd:"off"}),c.push({id:"toggle",cmd:"toggle"})):"DimmerActuator"==a.type?(c.push({id:"off",cmd:"dimTo0"}),c.push({id:"dimTo",cmd:"dimTo",step:"1",min:"0",max:"100"})):"RollerShutterActuator"==a.type?(c.push({id:"moveUp",cmd:"moveTo0"}),c.push({id:"moveDown",cmd:"moveTo100"}),c.push({id:"moveTo",
cmd:"moveTo",step:"1",min:"0",max:"100"})):"RoomTemperatureActuator"==a.type?(c.push({id:"setTo",cmd:"tempTo",step:"0.5",min:"6.5",max:"30",fact:"2"}),c.push({id:"off",cmd:"tempTo12"}),c.push({id:"setAuto",cmd:"auto"}),c.push({id:"setManu",cmd:"manu"})):"GenericActuator"==a.type&&("BooleanProperty:Value"==a.data?(c.push({id:"true",cmd:"true"}),c.push({id:"false",cmd:"false"})):"NumericProperty:Brightness"==a.data&&(c.push({id:"off",cmd:"setTo0"}),c.push({id:"setTo",cmd:"setTo",step:"1",min:"0",max:"100"}))));
return c};a.prototype.finalize=function(a){var b=a;setTimeout(function(){b&&(b(),b=null)},3E3);xnm.aio.rwe.Cache.finalize(function(){b&&(b(),b=null)})};a.prototype.pause=function(a){this.finalize(a)};return a}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.rwe.Handler);
