var x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.mbus=x.hub.m.mbus||{};x.hub.m.mbus.MODULE=require("xnm.aio.mbus.js");
x.hub.m.mbus.Monitor=function(){var c={sendSTAEvent:function(a){var b=require("x.hub.eventbus.js");b.emit("gatewayevent",a,{address:"MBUS"},"STA");b.emit("udpevent",a,"STA")}},b=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.mbus.Monitor");this._bus=this._port=null;this._statesBuffer={}};b.DEFAULT_PORT="/dev/mediolabus";b.prototype.start=function(a){this._port=a;this._port||(this._port=b.DEFAULT_PORT);this._logger.log("info","start monitor port:"+this._port);if(null==this._bus){var d=
this;this._bus=new x.hub.m.mbus.MODULE.MediolaBus(this._port);this._bus.on("data",function(a){d._logger.log("trace","receive mbus data:"+JSON.stringify(a));d._onData(a)});this._bus.on("error",function(a){d._logger.log("warn","mbus error:"+a.message)});this._bus.open()}};b.prototype.stop=function(){this._bus.on("data",null);this._bus.on("error",null);this._bus.close();this._bus=null};b.prototype.executeCommand=function(a,b,e){this._bus?a&&a.address&&a.type&&a.data?b&&b.command?(this._logger.log("trace",
'execute command "'+b.command+'" for device '+JSON.stringify(a)),this._bus.executeCommand(a,b.command),e&&e()):e&&e(Error("invalid command")):e&&e(Error("invalid device")):e&&e(Error("mbus not connect"))};b.prototype.getBufferedStates=function(){return this._statesBuffer};b.prototype.updateStates=function(a,b){this._logger.log("trace","update state for devices "+JSON.stringify(a));this._bus.updateStates(a);b&&b()};b.prototype._onData=function(a){if(a&&a.source){var b={states:a,timestamp:(new Date).getTime()};
this._statesBuffer[a.source]=b;c.sendSTAEvent({type:"MBUS",adr:a.source,state:a})}};return b}();
x.hub.m.mbus.Handler=function(){var c=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.mbus.Handler");this._monitor=null};c.prototype.init=function(b){var a=this,d=require("x.hub.eventbus.js");d.on("x.hub.peripheralman.ADD_MBUS",function(b){a._logger.log("debug","mbus usb connected");a._logger.log("info","start mbus monitor");a._start()});d.on("x.hub.peripheralman.REMOVE_MBUS",function(b){a._logger.log("debug","mbus usb disconnected");a._logger.log("info","stop mbus monitor");a._stop()});
global.MBUS_PORT&&"A20"!=global.PLATFORM&&"PI-CM3+"!=global.PLATFORM&&(this._logger.log("info","connect mbus usb:"+global.MBUS_PORT),this._start());b&&b()};c.prototype._start=function(){this._monitor||(this._monitor=new x.hub.m.mbus.Monitor,this._monitor.start(global.MBUS_PORT))};c.prototype._stop=function(){this._monitor&&(this._monitor.stop(),this._monitor=null)};c.prototype.getSystems=function(){return["mbus"]};c.prototype.getAllStatesLegacy=function(b){if(this._monitor){var a=[],d=this._monitor.getBufferedStates();
if(d)for(var c in d)a.push({type:"MBUS",adr:c,state:d[c].states});b&&b({data:a})}else b&&b({data:[]})};c.prototype.executeCommandLegacy=function(b,a){this._monitor?b&&b.address&&b.subtype&&b.data&&b.command?this._monitor.executeCommand({address:b.address,type:b.subtype,data:b.data},{command:b.command},function(b){a&&a({error:b})}):a&&a({error:Error("command invalid")}):a&&a({error:Error("mbus module not running")})};c.prototype.updateStates=function(b,a){this._monitor?b&&b.length?this._monitor.updateStates(b,
function(b){a&&a({error:b})}):a&&a({error:Error("no address")}):a&&a({error:Error("mbus module not running")})};c.prototype.dummyMbusMessage=function(b,a){b?this._monitor?(this._monitor._onData(b),a&&a()):a&&a({error:{message:"mbus module not running"}}):a&&a({error:{message:"invalid message"}})};return c}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.mbus.Handler);
