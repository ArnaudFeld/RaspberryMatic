var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.onkyo=xnm.aio.onkyo||{};xnm.aio.onkyo.AVReceiverBuffer={getAVR:function(h,d){return h&&d?this[h+":"+d]:null},setAVR:function(h){if(!h||!h.getIp())return null;this[h.getIp()+":"+h.getPort()]=h}};
xnm.aio.onkyo.AVReceiver=function(){var h=[1,2,3,4],d=function(a,b,c,l){this._taskBuffer=a;this._avr=b;this._datapoints=c;this._callback=l};d.prototype.run=function(){this._avr._logger.log("debug","run status task: "+JSON.stringify(this._datapoints));var a=this,b={},c=0,l=function(f,d){if(!f||1!=f.errorCode&&2!=f.errorCode&&3!=f.errorCode){var e=a._datapoints[c],g=null,n=e.indexOf(":");0<n&&(g=e.substr(0,n),e=e.substr(n+1));n="?";"frontTone"==e?d&&(null!=d.mainzone.frontBass&&"undefined"!=typeof d.mainzone.frontBass&&
(b["mainzone:frontBass"]=d.mainzone.frontBass),null!=d.mainzone.frontTreble&&"undefined"!=typeof d.mainzone.frontTreble&&(b["mainzone:frontTreble"]=d.mainzone.frontTreble)):(d&&(g||null==d[e]||"undefined"==typeof d[e]?g&&d[g]&&null!=d[g][e]&&"undefined"!=typeof d[g][e]&&(n=d[g][e]):n=d[e]),b[a._datapoints[c]]=n);c+=1;c<a._datapoints.length?(e=a._avr._getStateQuest(a._datapoints[c]),a._avr._doStateReq(e,l)):a._taskBuffer._finishLastTask(null,b)}else a._taskBuffer._finishAllTask(f)},f=this._avr._getStateQuest(this._datapoints[c]);
f?this._avr._doStateReq(f,l):l(Error("unknow status"))};d.prototype.merge=function(a){if(a&&a._datapoints)if(this._datapoints){a=this._datapoints.concat(a._datapoints);for(var b=0;b<a.length;++b)for(var c=b+1;c<a.length;++c)a[b]===a[c]&&a.splice(c,1);this._datapoints=a}else this._datapoints=a._datapoints};var g=function(a,b,c,l){this._taskBuffer=a;this._avr=b;this._commandTxt=c;this._callback=l};g.prototype.run=function(){this._avr._logger.log("debug","run command task: "+this._commandTxt);var a=
this,b=this._commandTxt,c=null,l=b.indexOf(":");0<l&&(c=b.substr(0,l),b=b.substr(l+1));var d=null;"toggle"==b?(d=this._avr._getStateQuest(c+":power"),this._avr._doStateReq(d,function(b,l){if(b)1==b.errorCode||2==b.errorCode||3==b.errorCode?a._taskBuffer._finishAllTask(b):a._taskBuffer._finishLastTask(b);else{var f="on";l&&l[c]&&"on"==l[c].power&&(f="off");d=a._avr._getCommandQuest(c+":"+f);a._avr._doCommandReq(d,function(b){!b||1!=b.errorCode&&2!=b.errorCode&&3!=b.errorCode?a._taskBuffer._finishLastTask(b):
a._taskBuffer._finishAllTask(b)})}})):(d=this._avr._getCommandQuest(this._commandTxt),this._avr._doCommandReq(d,function(b){!b||1!=b.errorCode&&2!=b.errorCode&&3!=b.errorCode?a._taskBuffer._finishLastTask(b):a._taskBuffer._finishAllTask(b)}))};var e=function(a){this._avr=a;this._buffer=[]};e.prototype.executeTask=function(a){if(0==this._buffer.length)this._buffer.push(a),this._doNextTask();else if(a instanceof g)1<this._buffer.length&&this._buffer[this._buffer.length-1]&&this._buffer[this._buffer.length-
1]instanceof d?this._buffer.splice(this._buffer.length-1,0,a):this._buffer.push(a);else{if(a instanceof d){var b=[];if(1<this._buffer.length){for(var c=1;c<this._buffer.length;c++)this._buffer[c]&&this._buffer[c]instanceof d&&(b.push(c),a.merge(this._buffer[c]));for(c=0;c<b.length;c++)this._buffer.splice(b[c],1)}}this._buffer.push(a)}};e.prototype._doNextTask=function(){0!=this._buffer.length&&this._buffer[0].run()};e.prototype._finishLastTask=function(a,b){if(0<this._buffer.length){var c=this._buffer[0];
c&&c._callback&&(c._callback(a,b),c._callback=null);this._buffer.splice(0,1)}this._doNextTask()};e.prototype._finishAllTask=function(a){var b=this._buffer;this._buffer=[];for(var c=0;c<b.length;c++)b[c]&&b[c]._callback&&(b[c]._callback(a),b[c]._callback=null)};var f=function(a){this._avr=a;this._buffer=[];this._bufferEmptyTo=null};f.prototype.RESPONSE_TO=1E3;f.prototype.PACKET_IDLE_TO=6E4;f.prototype.sendPacket=function(a,b,c){if(a){var l=this._buffer.length;this._buffer.push({packet:a,ignoreRsp:b,
callback:c});this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null);0==l&&this._sendNextPacket()}else c&&c(Error("ISCP message is null"))};f.prototype._sendNextPacket=function(){if(0!=this._buffer.length){var a=this,b=this._buffer[0];this._avr._sendPacket(b.packet,function(c){c?(c.errorCode=h[0],a._finishAllPacket(c)):b.ignoreRsp?a._finishLastPacket():b.timeout=setTimeout(function(){a._avr._logger.log("warn","packet response timeout");var b=Error("packet reponse timeout");
b.errorCode=h[3];a._finishLastPacket(b)},a.RESPONSE_TO)})}};f.prototype._finishLastPacket=function(a,b){0<this._buffer.length&&(this._buffer[0]&&(this._buffer[0].timeout&&(clearTimeout(this._buffer[0].timeout),this._buffer[0].timeout=null),this._buffer[0].callback&&(this._buffer[0].callback(a,b),this._buffer[0].callback=null)),this._buffer.splice(0,1));if(0==this._buffer.length){var c=this;this._bufferEmptyTo=setTimeout(function(){c._bufferEmptyTo=null;0==c._buffer.length&&c._avr._disconnect()},this.PACKET_IDLE_TO)}else this._sendNextPacket()};
f.prototype._finishAllPacket=function(a){var b=this._buffer;this._buffer=[];this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null);for(var c=0;c<b.length;c++)b[c]&&(b[c].timeout&&(clearTimeout(b[c].timeout),b[c].timeout=null),b[c].callback&&(b[c].callback(a),b[c].callback=null))};f.prototype._onSocketData=function(a){a=new Buffer(a);a=a.toString("hex");a=new Buffer(a,"hex");12<a.length&&(a=a.slice(18,18+(a[11]-2)).toString().trim(),a=a.replace(/[\x1a]/g,""),this._avr&&this._avr._datapointBuffer&&
this._avr._datapointBuffer.updateDpt(a),0<this._buffer.length&&this._buffer[0]&&this._buffer[0].packet&&this._buffer[0].packet.substr(0,3)==a.substr(0,3)&&this._finishLastPacket(null,a))};f.prototype._onSocketTimeout=function(){};f.prototype._onSocketError=function(a){a.errorCode=h[1];this._finishAllPacket(a)};f.prototype._onSocketClose=function(a){a=Error("socket closed");a.errorCode=h[2];this._finishAllPacket(a)};var p=function(){this._buffer={}};p.prototype.EXPIRE_TO=3E3;p.prototype.updateDpt=
function(a){if(a&&3<a.length){var b=a.substr(0,3);this._buffer[b]={status:a,timestamp:(new Date).getTime()}}};p.prototype.getDpt=function(a){if(a&&3<a.length&&(a=a.substr(0,3),this._buffer[a])){if(!this._buffer[a].timestamp)return delete this._buffer[a],null;var b=(new Date).getTime(),c=b-this._buffer[a].timestamp;return c>this.EXPIRE_TO||0>c?(this._buffer[a].timestamp=b,null):null==this._buffer[a].status||"undefined"==typeof this._buffer[a].status?(delete this._buffer[a],null):this._buffer[a].status}return null};
p.prototype.delDpt=function(a){a&&3<a.length&&(a=a.substr(0,3),"AMT"!=a?delete this._buffer[a]:this._buffer[a].timestamp=(new Date).getTime())};p.prototype.refreshDptTime=function(){var a=(new Date).getTime(),b;for(b in this._buffer)this._buffer.hasOwnProperty(b)&&(this._buffer[b].timestamp=a)};var k=function(a,b,c,l,d){this._ip=a;this._port=b;this._port||(this._port=60128);this._uuid=c;this._logger=require("x.logger.js").getLogger("xnm.aio.onkyo.AVReceiver");this._model=l;this._name=d;this._socket=
null;this._taskBuffer=new e(this);this._packetBuffer=new f(this);this._datapointBuffer=new p};k.prototype.getIp=function(){return this._ip};k.prototype.getPort=function(){return this._port};k.prototype.executeCommandCreator=function(a,b,c){if(b&&b.value)if("openNative"==b.value)window&&window.XC&&window.XC.callHost&&window.XCHost.getType&&("iOS"==window.XCHost.getType()?window.XC.callHost("SYSTEM","startApp",{scheme:"onkyo-remote3://"}):"Android"==window.XCHost.getType()&&window.XC.callHost("SYSTEM",
"startApp",{scheme:"com.onkyo.jp.onkyoremote"})),c&&c();else{a="";b.path&&b.path[0]&&"global"!=b.path[0]&&(a=b.path[0]+":");var l=a+b.value;if("setTo"==b.value||"tuner"==b.value||"frontBassTo"==b.value||"frontTrebleTo"==b.value){if(null==b.ext||"undefined"==typeof b.ext){c&&c(Error("command setTo ext format invalid"));return}l+=b.ext}else if("audioMode"==b.value){if(!b.ext){c&&c(Error("command audioMode ext format invalid"));return}l+=b.ext}else if("setInput"==b.value){if(!b.ext){c&&c(Error("command setInput ext format invalid"));
return}l=a+b.ext}else if("customCMD"==b.value){if(!b.ext){c&&c(Error("command customCMD ext format invalid"));return}l=a+b.ext}var d=this;this._executeCommand(l,function(a){if(a)c&&c(a);else if("on"==b.value||"off"==b.value||"toggle"==b.value)setTimeout(function(){c&&c()},4E3);else{if("mute"==b.value||"unmute"==b.value||"toggleMute"==b.value){if(b.path&&b.path[0]&&"mainzone"==b.path[0]){d._datapointBuffer&&d._datapointBuffer.refreshDptTime();setTimeout(function(){c&&c()},3E3);return}}else if("volumeUp"==
b.value||"volumeDown"==b.value){setTimeout(function(){c&&c()},100);return}c&&c(a)}})}else c&&c(Error("command json format invalid"))};k.prototype.getStatesCreator=function(a,b,c){a=function(a,b){for(var c=0;c<b.length;c++)if(b[c]===a)return!0;return!1};for(var d=[],f=[],e=0;e<b.length;e++)if(b[e]&&b[e].id&&b[e].status&&b[e].status.value){var g="";b[e].status.path&&b[e].status.path[0]&&"global"!=b[e].status.path[0]&&(g=b[e].status.path[0]+":");var h=b[e].status.value;d.push({id:b[e].id,datapoint:g+
h});if("frontBass"==h||"frontTreble"==h)h="frontTone";a(g+h,f)||f.push(g+h)}this._getStates(f,function(a,b){if(a)c&&c(a);else{for(var f=[],e=0;e<d.length;e++){var g="?",h=d[e].id,n=d[e].datapoint;b&&null!=b[n]&&"undefined"!=typeof b[n]&&(g=b[n]);f.push({id:h,status:g})}c&&c(null,f)}})};k.prototype.executeCommand=function(a,b){this._executeCommand(a,b)};k.prototype.getStates=function(a){var b=Object.keys(k.STATUS_DPT_QUEST);this._getStates(b,function(b,d){a&&a(b,d)})};k.prototype._executeCommand=function(a,
b){this._logger.log("debug","execute command: "+a);var c=new g(this._taskBuffer,this,a,b);this._taskBuffer.executeTask(c)};k.prototype._getStates=function(a,b){this._logger.log("debug","get states: "+JSON.stringify(a));var c=new d(this._taskBuffer,this,a,b);this._taskBuffer.executeTask(c)};k.prototype._getCommandQuest=function(a){var b,c=a;b=null;var d=a.indexOf(":");0<d&&(b=a.substr(0,d),a=a.substr(d+1));if("on"==a)c="zone2"==b?"ZPW01":"zone3"==b?"PW301":"PWR01";else if("off"==a)c="zone2"==b?"ZPW00":
"zone3"==b?"PW300":"PWR00";else if("mute"==a)c="zone2"==b?"ZMT01":"zone3"==b?"MT301":"AMT01";else if("unmute"==a)c="zone2"==b?"ZMT00":"zone3"==b?"MT300":"AMT00";else if("toggleMute"==a)c="zone2"==b?"ZMTTG":"zone3"==b?"MT3TG":"AMTTG";else if("volumeDown"==a)c="zone2"==b?"ZVLDOWN":"zone3"==b?"VL3DOWN":"MVLDOWN";else if("volumeUp"==a)c="zone2"==b?"ZVLUP":"zone3"==b?"VL3UP":"MVLUP";else if("BDDVD"==a||"BD/DVD"==a)c="zone2"==b?"SLZ10":"zone3"==b?"SL310":"SLI10";else if("STRMBOX"==a||"STRM BOX"==a)c="zone2"==
b?"SLZ11":"zone3"==b?"SL311":"SLI11";else if("CBLSAT"==a||"CBL/SAT"==a)c="zone2"==b?"SLZ01":"zone3"==b?"SL301":"SLI01";else if("PC"==a)c="zone2"==b?"SLZ05":"zone3"==b?"SL305":"SLI05";else if("GAME"==a)c="zone2"==b?"SLZ02":"zone3"==b?"SL302":"SLI02";else if("AUX"==a)c="zone2"==b?"SLZ03":"zone2"==b?"SL303":"SLI03";else if("CD"==a)c="zone2"==b?"SLZ23":"zone3"==b?"SL323":"SLI23";else if("TV"==a)c="zone2"==b?"SLZ12":"zone3"==b?"SL312":"SLI12";else if("FM"==a)c="zone2"==b?"SLZ24":"zone3"==b?"SL324":"SLI24";
else if("AM"==a)c="zone2"==b?"SLZ25":"zone3"==b?"SL325":"SLI25";else if("NET"==a)c="zone2"==b?"SLZ2B":"zone3"==b?"SL32B":"SLI2B";else if("BLUETOOTH"==a)c="zone2"==b?"SLZ2E":"zone3"==b?"SL32E":"SLI2E";else if("Optical"==a)c="zone2"==b?"SLZ44":"zone3"==b?"SL344":"SLI44";else if(0==a.indexOf("audioMode")){if(a=a.replace(/audioMode/g,""),"STEREO"==a||"MOVIE"==a||"MUSIC"==a||"GAME"==a)"STEREO"==a&&(a="00"),c="LMD"+a}else if("play"==a)c="NTCPLAY";else if("pause"==a)c="NTCPAUSE";else if("stop"==a)c="NTCSTOP";
else if("previous"==a)c="NTCTRDN";else if("next"==a)c="NTCTRUP";else if("frontBassUp"==a)c="TFRBUP";else if("frontBassDown"==a)c="TFRBDOWN";else if("frontTrebleUp"==a)c="TFRTUP";else if("frontTrebleDown"==a)c="TFRTDOWN";else if(0==a.indexOf("frontBassTo"))0==a.indexOf("frontBassTo")&&(a=a.replace(/frontBassTo/g,"")),a=a.replace(/%/g,""),a=parseInt(a),b=!1,0>a&&(b=!0,a=0-a),0>a&&(a=0),10<a&&(a=10),a=a.toString(16).toUpperCase(),c="TFRB"+(b?"-"+a:"+"+a);else if(0==a.indexOf("frontTrebleTo"))0==a.indexOf("frontTrebleTo")&&
(a=a.replace(/frontTrebleTo/g,"")),a=a.replace(/%/g,""),a=parseInt(a),b=!1,0>a&&(b=!0,a=0-a),0>a&&(a=0),10<a&&(a=10),a=a.toString(16).toUpperCase(),a=b?"-"+a:"+"+a,c="TFRT"+a;else if(0==a.indexOf("tuner"))a=a.replace(/tuner/g,""),"Up"==a?c="zone2"==b?"PRZUP":"zone3"==b?"PR3UP":"PRSUP":"Down"==a?c="zone2"==b?"PRZDOWN":"zone3"==b?"PR3DOWN":"PRSDOWN":(a=parseInt(a),0>a?a=0:40<a&&(a=40),c="zone2"==b?"PRZ"+XC.getHexVal(a,2):"zone3"==b?"PR3"+XC.getHexVal(a,2):"PRS"+XC.getHexVal(a,2));else if(0==a.indexOf("setTo")||
/^\d+$/.test(a))0==a.indexOf("setTo")&&(a=a.replace(/setTo/g,"")),a=a.replace(/%/g,""),"zone2"==b?(a=parseInt(a),0>a?a=0:100<a&&(a=100),c="ZVL"+XC.getHexVal(a,2)):"zone3"==b?(a=parseInt(a),0>a?a=0:100<a&&(a=100),c="VL3"+XC.getHexVal(a,2)):(a=parseInt(a),0>a?a=0:100<a&&(a=100),c="MVL"+XC.getHexVal(a,2));return c};k.STATUS_DPT_QUEST={"mainzone:power":"PWRQSTN","mainzone:volume":"MVLQSTN","mainzone:mute":"AMTQSTN","mainzone:audioMode":"LMDQSTN","mainzone:input":"SLIQSTN","mainzone:frontTone":"TFRQSTN",
"zone2:power":"ZPWQSTN","zone2:volume":"ZVLQSTN","zone2:mute":"ZMTQSTN","zone2:input":"SLZQSTN","zone3:power":"PW3QSTN","zone3:volume":"VL3QSTN","zone3:mute":"MT3QSTN","zone3:input":"SL3QSTN"};k.LMD_MAP={"00":"Stereo","01":"Direct","02":"SURROUND","03":"Game-RPG","04":"THX","05":"Game-Action","06":"Game-Rock","07":"MONO MOVIE","08":"Orchestra","09":"Unplugged","0A":"Studio-Mix","0B":"TV Logic","0C":"All Ch Stereo","0D":"Theater-Dimensional","0E":"Game-Sports","0F":"Mono",11:"Pure Audio",12:"MULTIPLEX",
13:"Full Mono",14:"DOLBY VIRTUAL",15:"DTS Surround Sensation",16:"Audyssey DSX","1F":"Whole House Mode",23:"Stage",25:"Action",26:"Music","2E":"Sports",40:"Straight Decode*1",41:"Dolby EX*2",42:"THX Cinema",43:"THX Surround EX",44:"THX Music",45:"THX Games",50:"THX U2/S2/I/S Cinema/Cinema2",51:"THX U2/S2/I/S Music",52:"THX U2/S2/I/S Games",80:"Dolby Surround",81:"PLII/PLIIx Music",82:"DTS Neo:6 Cinema",83:"DTS Neo:6 Music",84:"PLII/PLIIx THX Cinema",85:"Neo:6/Neo:X THX Cinema",86:"PLII/PLIIx Game",
87:"Neural Surr*3",88:"Neural THX/Neural Surround",89:"PLII/PLIIx THX Games","8A":"Neo:6/Neo:X THX Games","8B":"PLII/PLIIx THX Music","8C":"Neo:6/Neo:X THX Music","8D":"Neural THX Cinema","8E":"Neural THX Music","8F":"Neural THX Games",90:"PLIIz Height",91:"Neo:6 Cinema DTS Surround Sensation",92:"Neo:6 Music DTS Surround Sensation",93:"Neural Digital Music",94:"PLIIz Height + THX Cinema",95:"PLIIz Height + THX Music",96:"PLIIz Height + THX Games",97:"PLIIz Height + THX U2/S2 Cinema",98:"PLIIz Height + THX U2/S2 Music",
99:"PLIIz Height + THX U2/S2 Games","9A":"Neo:X Game",A0:"PLIIx/PLII Movie + Audyssey DSX",A1:"PLIIx/PLII Music + Audyssey DSX",A2:"PLIIx/PLII Game + Audyssey DSX",A3:"Neo:6 Cinema + Audyssey DSX",A4:"Neo:6 Music + Audyssey DSX",A5:"Neural Surround + Audyssey DSX",A6:"Neural Digital Music + Audyssey DSX",A7:"Dolby EX + Audyssey DSX"};k.prototype._getStateQuest=function(a){return a?k.STATUS_DPT_QUEST[a]:null};k.prototype._buildData=function(a){var b=[73,83,67,80,0,0,0,16,0,0,0,8,1,0,0,0,33,49],c=2+
a.length+1&4294967295;b[8]=c>>24&255;b[9]=c>>16&255;b[9]=c>>8&255;b[11]=c&255;for(c=0;c<a.length;c++)b.push(a.charCodeAt(c));b.push(13);return new Buffer(b)};k.prototype._resolveStatus=function(a){var b={mainzone:{},zone2:{},zone3:{}};if(0==a.indexOf("MVL"))a.substr(3).match(/[0-9A-Fa-f]{2}/g)&&(b.mainzone.volume=parseInt(a.substr(3),16));else if(0==a.indexOf("PWR"))"00"==a.substr(3)?b.mainzone.power="off":"01"==a.substr(3)&&(b.mainzone.power="on");else if(0==a.indexOf("AMT"))"00"==a.substr(3)?b.mainzone.mute=
"off":"01"==a.substr(3)&&(b.mainzone.mute="on");else if(0==a.indexOf("LMD"))a=a.substr(3).trim(),k.LMD_MAP[a]&&(b.mainzone.audioMode=k.LMD_MAP[a]);else if(0==a.indexOf("TFR")){if(a=a.substr(3),6==a.length){var c=parseInt(a.substr(2,1),16),d="-"==a.charAt(1);d&&(c=0-c);var e=parseInt(a.substr(5,1),16);(d="-"==a.charAt(4))&&(e=0-e);b.mainzone.frontBass=c;b.mainzone.frontTreble=e}}else if(0==a.indexOf("ZVL"))a.substr(3).match(/[0-9A-Fa-f]{2}/g)&&(b.zone2.volume=parseInt(a.substr(3),16));else if(0==a.indexOf("ZPW"))"00"==
a.substr(3)?b.zone2.power="off":"01"==a.substr(3)&&(b.zone2.power="on");else if(0==a.indexOf("ZMT"))"00"==a.substr(3)?b.zone2.mute="off":"01"==a.substr(3)&&(b.zone2.mute="on");else if(0==a.indexOf("VL3"))a.substr(3).match(/[0-9A-Fa-f]{2}/g)&&(b.zone3.volume=parseInt(a.substr(3),16));else if(0==a.indexOf("PW3"))"00"==a.substr(3)?b.zone3.power="off":"01"==a.substr(3)&&(b.zone3.power="on");else if(0==a.indexOf("MT3"))"00"==a.substr(3)?b.zone3.mute="off":"01"==a.substr(3)&&(b.zone3.mute="on");else if(0==
a.indexOf("SLI")||0==a.indexOf("SLZ")||0==a.indexOf("SL3"))c=b.mainzone,0==a.indexOf("SLZ")?c=b.zone2:0==a.indexOf("SL3")&&(c=b.zone3),"10"==a.substr(3)?c.input="BD/DVD":"11"==a.substr(3)?c.input="STRM BOX":"01"==a.substr(3)?c.input="CBL/SAT":"05"==a.substr(3)?c.input="PC":"02"==a.substr(3)?c.input="GAME":"03"==a.substr(3)?c.input="AUX":"23"==a.substr(3)?c.input="CD":"12"==a.substr(3)?c.input="TV":"24"==a.substr(3)?c.input="FM":"25"==a.substr(3)?c.input="AM":"2B"==a.substr(3)?c.input="NET":"2E"==
a.substr(3)?c.input="BLUETOOTH":"44"==a.substr(3)&&(c.input="Optical");return b};k.prototype._doCommandReq=function(a,b){this._datapointBuffer&&this._datapointBuffer.delDpt(a);this._packetBuffer.sendPacket(a,!0,b)};k.prototype._doStateReq=function(a,b){var c=this;if(this._datapointBuffer){var d=this._datapointBuffer.getDpt(a);if(d){d=this._resolveStatus(d);b(null,d);return}}this._packetBuffer.sendPacket(a,!1,function(a,d){if(a)b(a);else{var e=c._resolveStatus(d);b(null,e)}})};k.prototype._sendPacket=
function(a,b){if(this._socket){this._logger.log("trace","send ISCP message:"+a);var c=this._buildData(a);this._socket.write(c,"binary");b()}else{var d=this;this._connect(function(c){c?b(c):d._sendPacket(a,b)})}};k.prototype._connect=function(a){this._socket&&(this._socket.end(),this._socket=null);var b=this,c={port:this._port,host:this._ip},d=require("net").connect(c);d.setTimeout(2E3);d.__connected=!1;d.on("connect",function(){b._logger.log("trace","connect to onkyo avr:"+b._ip);d.__connected=!0;
b._socket=d;a()});d.on("data",function(a){b._logger.log("trace","receive from onkyo avr "+(d.__disconnected?"(closed)":"")+":"+b._ip+" data:"+a);d.__disconnected||b._packetBuffer._onSocketData(a)});d.on("error",function(c){d.__connected?(b._logger.log("trace","onkyo avr"+(d.__disconnected?"(closed)":"")+":"+b._ip+" error:"+c.message),d.destroy(),d.__disconnected||(d.__disconnected=!0,b._socket=null,b._packetBuffer._onSocketError(c))):(b._logger.log("trace","onkyo avr:"+b._ip+" connection error:"+
c.message),a(c))});d.on("timeout",function(){d.__connected?(b._logger.log("trace","onkyo avr"+(d.__disconnected?"(closed)":"")+":"+b._ip+" data timeout"),d.__disconnected||b._packetBuffer._onSocketTimeout()):(b._logger.log("trace","onkyo avr:"+b._ip+" connection timeout"),d.destroy&&d.destroy(),a(Error("timeout")))});d.on("close",function(){b._logger.log("trace","onkyo avr"+(d.__disconnected?"(closed)":"")+":"+b._ip+" close socket");d.__disconnected||(d.__disconnected=!0,b._socket=null,b._packetBuffer._onSocketClose(d))});
d._doConnect&&"function"==typeof d._doConnect&&d._doConnect();return d};k.prototype._disconnect=function(){this._logger.log("debug","disconnect socket");this._socket&&(this._socket.__disconnected=!0,this._socket.end(),this._socket=null)};k.prototype.toJSON=function(){var a={sys:xnm.aio.onkyo.DM.SYS,type:"avr",ip:this._ip,port:this._port,uuid:this._uuid,model:this._model};this._name&&(a.name=this._name);return a};k.prototype.equalsTo=function(a){return a&&a instanceof k?this._ip==a._ip&&this._port==
a._port:!1};k.parseJSON=function(a){return a.ip?new k(a.ip,a.port,a.uuid,a.model,a.name):null};var m=function(a,b,c,d,e){this._avr=xnm.aio.onkyo.AVReceiverBuffer.getAVR(a,b);this._avr||(this._avr=new k(a,b,c,d,e),xnm.aio.onkyo.AVReceiverBuffer.setAVR(this._avr))};m.prototype.getUUID=function(){return this._avr?this._avr._uuid:null};m.prototype.executeCommandCreator=function(a,b,c){this._avr.executeCommandCreator(a,b,c)};m.prototype.getStatesCreator=function(a,b,c){this._avr.getStatesCreator(a,b,c)};
m.prototype.executeCommand=function(a,b){this._avr.executeCommand(a,b)};m.prototype.getStates=function(a){this._avr.getStates(a)};m.prototype.toJSON=function(){return this._avr.toJSON()};m.prototype.equalsTo=function(a){return this._avr.equalsTo(a._avr)};m.parseJSON=function(a){return a.ip?new m(a.ip,a.port,a.uuid,a.model,a.name):null};return m}();
xnm.aio.onkyo.DM=function(){var h=function(d,e){this.code=d;this.message=e;this.stack=Error().stack};h.prototype=Error();h.prototype.name="OnkyoDMError";h.prototype.code=0;h.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var d={avr:{command:[{type:"root",name:"global",value:"global",children:[{type:"string",name:"custom command",ref:{value:"customCMD",ext:"%s"}},{type:"enum",name:"open Onkyo Remote App",ref:{value:"openNative"}}]},{type:"root",name:"NET",
value:"net",children:[{type:"enum",name:"play",ref:{path:["global"],value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",
ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume to",ref:{value:"setTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"set listening mode",ref:{value:"audioMode",ext:"%e",extMeta:["MOVIE","MUSIC","GAME","STEREO"]}},{type:"enum",name:"front bass up",ref:{value:"frontBassUp"}},{type:"enum",
name:"front bass down",ref:{value:"frontBassDown"}},{type:"int",name:"front bass to",ref:{value:"frontBassTo",ext:"%d",extMeta:"-10-10",scale:"2"}},{type:"enum",name:"front treble up",ref:{value:"frontTrebleUp"}},{type:"enum",name:"front treble down",ref:{value:"frontTrebleDown"}},{type:"int",name:"front treble to",ref:{value:"frontTrebleTo",ext:"%d",extMeta:"-10-10",scale:"2"}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},
{type:"int",name:"set tuner preset",ref:{value:"tuner",ext:"%d",extMeta:"1-40",scale:"1"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"CBL/SAT;BD/DVD;STRM BOX;GAME;AUX;PC;CD;TV;NET;BLUETOOTH;FM;AM;Optical".split(";")}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},
{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume to",ref:{value:"setTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},{type:"int",name:"set tuner preset",ref:{value:"tuner",ext:"%d",extMeta:"1-40",scale:"1"}},
{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"CBL/SAT;BD/DVD;STRM BOX;GAME;AUX;PC;CD;TV;NET;BLUETOOTH;FM;AM;Optical".split(";")}}]},{type:"root",name:"zone 3",value:"zone3",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume to",
ref:{value:"setTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},{type:"int",name:"set tuner preset",ref:{value:"tuner",ext:"%d",extMeta:"1-40",scale:"1"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"CBL/SAT;BD/DVD;STRM BOX;GAME;AUX;PC;CD;TV;NET;BLUETOOTH;FM;AM;Optical".split(";")}}]}],
status:[{type:"root",name:"main zone",value:"mainzone",children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-80",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"int",name:"front bass",ref:{value:"frontBass",extMeta:"-10-10",scale:"2"}},{type:"int",name:"front treble",ref:{value:"frontTreble",extMeta:"-10-10",scale:"2"}},{type:"enum",name:"listening mode",ref:{value:"audioMode",options:["Stereo",
"All Ch Stereo"]}},{type:"enum",name:"input",ref:{value:"input",options:"CBLSAT BDDVD STRMBOX GAME AUX PC CD TV NET BLUETOOTH FM AM Optical".split(" ")}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-80",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:"CBLSAT BDDVD STRMBOX GAME AUX PC CD TV NET BLUETOOTH FM AM Optical".split(" ")}}]},
{type:"root",name:"zone 3",value:"zone3",children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-80",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:"CBLSAT BDDVD STRMBOX GAME AUX PC CD TV NET BLUETOOTH FM AM Optical".split(" ")}}]}]}};return{SYS:"onkyo",getIPDeviceType:function(){return[{sys:this.SYS,name:"Onkyo AV Receiver",type:"avr"}]},
createDevice:function(d,e,f){e=h.ERROR_CODE;d?d.ip?f(null,d):f(new h(e.INVALID,"ip is invalid")):f(new h(e.INVALID,"info is invalid"))},updateDevice:function(d,e,f){e=h.ERROR_CODE;d?d.ip?f(null,d):f(new h(e.INVALID,"ip is invalid")):f(new h(e.INVALID,"info is invalid"))},deleteDevice:function(d,e,f){f()},applyUIFilter:function(d,e,f){var h=function(a,c,d){var e=[];a.forEach(function(a){if("root"==a.type){a=JSON.parse(JSON.stringify(a));var b=h(a.children,c,d);b&&0<b.length&&(a.children=b,e.push(a))}else{b=
d.elems;if("*"==b)b=!0;else{for(var f=!1,g=0;g<b.length;g++)if(b[g]==a.type){f=!0;break}b=f}b&&(a=JSON.parse(JSON.stringify(a)),e.push(a))}});return e},k=function(a,c){var d=[],e=xnm.aio.onkyo.DM.getCommandStatusMap(a,f);if(e){var g=[];switch(c.catagory){case "command":e.command&&(g=h(e.command,a,c));break;case "status":e.status&&(g=h(e.status,a,c))}d=d.concat(g)}return d};if(!d.sys)return null;var m=JSON.parse(JSON.stringify(d)),a=null;switch(e.catagory){case "command":a=k(d,e);m.command=a;break;
case "status":a=k(d,e);m.status=a;break;default:return null}return a&&0!=a.length?m:null},getCommandStatusMap:function(g){return g&&g.type?d[g.type]:null}}}();
xnm.aio.onkyo.Handler=function(){var h=function(){this.detectedAVRs={}};h.prototype.devicemanager=xnm.aio.onkyo.DM;h.prototype.AVReceiver=xnm.aio.onkyo.AVReceiver;h.prototype.registModule=function(d){d.register(xnm.aio.onkyo.DM.SYS,"onkyo")};h.prototype.resolveDevice=function(d){if(!d)return null;switch(d.type){case "avr":return xnm.aio.onkyo.AVReceiver.parseJSON(d);default:return null}};h.prototype.getDeviceCommands=function(d,g){var e=xnm.aio.onkyo.DM.applyUIFilter(d,{catagory:"command",elems:"*"}),
e=e?e.command:[];g&&g(null,e)};h.prototype.getDeviceStatus=function(d,g){var e=xnm.aio.onkyo.DM.applyUIFilter(d,{catagory:"status",elems:"*"}),e=e?e.status:[];g&&g(null,e)};h.prototype.doCommand=function(d,g,e){var f=this.resolveDevice(d);f?f.executeCommandCreator(d,g,function(d){e&&e(d)}):e&&e(Error("device json format invalid"))};h.prototype.doStatus=function(d,g,e,f){var h=this.resolveDevice(g);h?h.getStatesCreator(null,[{id:d,device:g,status:e}],function(d,e){d?f&&f(d):f&&f(null,e[0])}):f&&f(Error("device json format invalid"))};
h.prototype.getDeviceCommandList=function(d,g,e){var f=[];if(g)f.push({id:window.XC_Text.on,cmd:"on"}),f.push({id:window.XC_Text.off,cmd:"off"});else if(e&&"avr"==d.type){d=[];d.push({id:"on",cmd:"on"});d.push({id:"off",cmd:"off"});d.push({id:"toggle",cmd:"toggle"});d.push({id:"volumeDown",cmd:"volumeDown"});d.push({id:"volumeUp",cmd:"volumeUp"});d.push({id:"set volume",cmd:"setTo",step:"1",max:"80"});d.push({id:"mute",cmd:"mute"});d.push({id:"unmute",cmd:"unmute"});d.push({id:"toggleMute",cmd:"toggleMute"});
d.push({id:"CBLSAT",cmd:"CBLSAT"});d.push({id:"BDDVD",cmd:"BDDVD"});d.push({id:"STRMBOX",cmd:"STRMBOX"});d.push({id:"GAME",cmd:"GAME"});d.push({id:"AUX",cmd:"AUX"});d.push({id:"PC",cmd:"PC"});d.push({id:"CD",cmd:"CD"});d.push({id:"TV",cmd:"TV"});d.push({id:"NET",cmd:"NET"});d.push({id:"BLUETOOTH",cmd:"BLUETOOTH"});d.push({id:"FM",cmd:"FM"});d.push({id:"AM",cmd:"AM"});d.push({id:"tunerUp",cmd:"tunerUp"});d.push({id:"tunerDown",cmd:"tunerDown"});d.push({id:"set tuner to",cmd:"tuner",step:"1",min:"1",
max:"40"});cl=d.length;for(g=0;g<cl;g++)e=JSON.parse(JSON.stringify(d[g])),e.ch="mainzone",f.push(e),e=JSON.parse(JSON.stringify(d[g])),e.ch="zone2",f.push(e);f.push({id:"MOVIE",cmd:"MOVIE"});f.push({id:"MUSIC",cmd:"MUSIC"});f.push({id:"GAME",cmd:"GAME"});f.push({id:"STEREO",cmd:"STEREO"});f.push({id:"play",cmd:"play"});f.push({id:"pause",cmd:"pause"});f.push({id:"stop",cmd:"stop"});f.push({id:"previous",cmd:"previous"});f.push({id:"next",cmd:"next"})}return f};h.prototype.discoverDevices=function(d){var g=
require("x.upnp.js");if(g){var e=this;g.discoverDevicesWithTimeout(3E3,function(f){if(f.manufacturer&&0==f.manufacturer.indexOf("ONKYO")&&"AV Receiver"==f.modelDescription){var g=new xnm.aio.onkyo.AVReceiver(f.ip,null,f.uuid,f.modelName,f.name);e.detectedAVRs["uuid:"+f.uuid]||(e.detectedAVRs["uuid:"+f.uuid]=g);d(g)}})}};h.prototype.discoverWithTimeout=function(d,g){var e={};this.discoverDevices(function(d){d&&d.getUUID()&&!e[d.getUUID()]&&(e[d.getUUID()]=d)});setTimeout(function(){var d=[],h;for(h in e)e.hasOwnProperty(h)&&
d.push(e[h]);g&&g(null,d)},d)};return h}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.onkyo.Handler);
