var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(c,e,h){c!=Array.prototype&&c!=Object.prototype&&(c[e]=h.value)};$jscomp.getGlobal=function(c){return"undefined"!=typeof window&&window===c?c:"undefined"!=typeof global&&null!=global?global:c};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var c=0;return function(e){return $jscomp.SYMBOL_PREFIX+(e||"")+c++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var c=$jscomp.global.Symbol.iterator;c||(c=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[c]&&$jscomp.defineProperty(Array.prototype,c,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(c){var e=0;return $jscomp.iteratorPrototype(function(){return e<c.length?{done:!1,value:c[e++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(c){$jscomp.initSymbolIterator();c={next:c};c[$jscomp.global.Symbol.iterator]=function(){return this};return c};$jscomp.iteratorFromArray=function(c,e){$jscomp.initSymbolIterator();c instanceof String&&(c+="");var h=0,g={next:function(){if(h<c.length){var f=h++;return{value:e(f,c[f]),done:!1}}g.next=function(){return{done:!0,value:void 0}};return g.next()}};g[Symbol.iterator]=function(){return g};return g};
$jscomp.polyfill=function(c,e,h,g){if(e){h=$jscomp.global;c=c.split(".");for(g=0;g<c.length-1;g++){var f=c[g];f in h||(h[f]={});h=h[f]}c=c[c.length-1];g=h[c];e=e(g);e!=g&&null!=e&&$jscomp.defineProperty(h,c,{configurable:!0,writable:!0,value:e})}};$jscomp.polyfill("Array.prototype.keys",function(c){return c?c:function(){return $jscomp.iteratorFromArray(this,function(e){return e})}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.onkyo=xnm.aio.onkyo||{};
xnm.aio.onkyo.AVReceiverBuffer={getAVR:function(c,e){return c&&e?this[c+":"+e]:null},setAVR:function(c){if(!c||!c.getIp())return null;this[c.getIp()+":"+c.getPort()]=c}};
xnm.aio.onkyo.AVReceiver=function(){var c=[1,2,3,4],e=function(a,b,d,e){this._taskBuffer=a;this._avr=b;this._datapoints=d;this._callback=e};e.prototype.run=function(){this._avr._logger.log("debug","run status task: "+JSON.stringify(this._datapoints));var a=this,b={},d=0,e=function(c,l){if(!c||1!=c.errorCode&&2!=c.errorCode&&3!=c.errorCode){c=a._datapoints[d];var f=null,h=c.indexOf(":");0<h&&(f=c.substr(0,h),c=c.substr(h+1));h="?";"frontTone"==c?l&&(null!=l.mainzone.frontBass&&"undefined"!=typeof l.mainzone.frontBass&&
(b["mainzone:frontBass"]=l.mainzone.frontBass),null!=l.mainzone.frontTreble&&"undefined"!=typeof l.mainzone.frontTreble&&(b["mainzone:frontTreble"]=l.mainzone.frontTreble)):(l&&(f||null==l[c]||"undefined"==typeof l[c]?f&&l[f]&&null!=l[f][c]&&"undefined"!=typeof l[f][c]&&(h=l[f][c]):h=l[c]),b[a._datapoints[d]]=h);d+=1;d<a._datapoints.length?(l=a._avr._getStateQuest(a._datapoints[d]),a._avr._doStateReq(l,e)):a._taskBuffer._finishLastTask(null,b)}else a._taskBuffer._finishAllTask(c)},c=this._avr._getStateQuest(this._datapoints[d]);
c?this._avr._doStateReq(c,e):e(Error("unknow status"))};e.prototype.merge=function(a){if(a&&a._datapoints)if(this._datapoints){a=this._datapoints.concat(a._datapoints);for(var b=0;b<a.length;++b)for(var d=b+1;d<a.length;++d)a[b]===a[d]&&a.splice(d,1);this._datapoints=a}else this._datapoints=a._datapoints};var h=function(a,b,d,c){this._taskBuffer=a;this._avr=b;this._commandTxt=d;this._callback=c};h.prototype.run=function(){this._avr._logger.log("debug","run command task: "+this._commandTxt);var a=
this,b=this._commandTxt,d=null,c=b.indexOf(":");0<c&&(d=b.substr(0,c),b=b.substr(c+1));var e=null;"toggle"==b?(e=this._avr._getStateQuest(d+":power"),this._avr._doStateReq(e,function(b,c){b?1==b.errorCode||2==b.errorCode||3==b.errorCode?a._taskBuffer._finishAllTask(b):a._taskBuffer._finishLastTask(b):(b="on",c&&c[d]&&"on"==c[d].power&&(b="off"),e=a._avr._getCommandQuest(d+":"+b),a._avr._doCommandReq(e,function(b){!b||1!=b.errorCode&&2!=b.errorCode&&3!=b.errorCode?a._taskBuffer._finishLastTask(b):
a._taskBuffer._finishAllTask(b)}))})):(e=this._avr._getCommandQuest(this._commandTxt),this._avr._doCommandReq(e,function(b){!b||1!=b.errorCode&&2!=b.errorCode&&3!=b.errorCode?a._taskBuffer._finishLastTask(b):a._taskBuffer._finishAllTask(b)}))};var g=function(a){this._avr=a;this._buffer=[]};g.prototype.executeTask=function(a){if(0==this._buffer.length)this._buffer.push(a),this._doNextTask();else if(a instanceof h)1<this._buffer.length&&this._buffer[this._buffer.length-1]&&this._buffer[this._buffer.length-
1]instanceof e?this._buffer.splice(this._buffer.length-1,0,a):this._buffer.push(a);else{if(a instanceof e){var b=[];if(1<this._buffer.length){for(var d=1;d<this._buffer.length;d++)this._buffer[d]&&this._buffer[d]instanceof e&&(b.push(d),a.merge(this._buffer[d]));for(d=0;d<b.length;d++)this._buffer.splice(b[d],1)}}this._buffer.push(a)}};g.prototype._doNextTask=function(){0!=this._buffer.length&&this._buffer[0].run()};g.prototype._finishLastTask=function(a,b){if(0<this._buffer.length){var d=this._buffer[0];
d&&d._callback&&(d._callback(a,b),d._callback=null);this._buffer.splice(0,1)}this._doNextTask()};g.prototype._finishAllTask=function(a){var b=this._buffer;this._buffer=[];for(var d=0;d<b.length;d++)b[d]&&b[d]._callback&&(b[d]._callback(a),b[d]._callback=null)};var f=function(a){this._avr=a;this._buffer=[];this._bufferEmptyTo=null};f.prototype.RESPONSE_TO=1E3;f.prototype.PACKET_IDLE_TO=6E4;f.prototype.sendPacket=function(a,b,d){if(a){var c=this._buffer.length;this._buffer.push({packet:a,ignoreRsp:b,
callback:d});this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null);0==c&&this._sendNextPacket()}else d&&d(Error("ISCP message is null"))};f.prototype._sendNextPacket=function(){if(0!=this._buffer.length){var a=this,b=this._buffer[0];this._avr._sendPacket(b.packet,function(d){d?(d.errorCode=c[0],a._finishAllPacket(d)):b.ignoreRsp?a._finishLastPacket():b.timeout=setTimeout(function(){a._avr._logger.log("warn","packet response timeout");var b=Error("packet reponse timeout");
b.errorCode=c[3];a._finishLastPacket(b)},a.RESPONSE_TO)})}};f.prototype._finishLastPacket=function(a,b){0<this._buffer.length&&(this._buffer[0]&&(this._buffer[0].timeout&&(clearTimeout(this._buffer[0].timeout),this._buffer[0].timeout=null),this._buffer[0].callback&&(this._buffer[0].callback(a,b),this._buffer[0].callback=null)),this._buffer.splice(0,1));if(0==this._buffer.length){var d=this;this._bufferEmptyTo=setTimeout(function(){d._bufferEmptyTo=null;0==d._buffer.length&&d._avr._disconnect()},this.PACKET_IDLE_TO)}else this._sendNextPacket()};
f.prototype._finishAllPacket=function(a){var b=this._buffer;this._buffer=[];this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null);for(var d=0;d<b.length;d++)b[d]&&(b[d].timeout&&(clearTimeout(b[d].timeout),b[d].timeout=null),b[d].callback&&(b[d].callback(a),b[d].callback=null))};f.prototype._onSocketData=function(a){a=new Buffer(a);a=a.toString("hex");a=new Buffer(a,"hex");12<a.length&&(a=a.slice(18,18+(a[11]-2)).toString().trim(),a=a.replace(/[\x1a]/g,""),this._avr&&this._avr._datapointBuffer&&
this._avr._datapointBuffer.updateDpt(a),0<this._buffer.length&&this._buffer[0]&&this._buffer[0].packet&&this._buffer[0].packet.substr(0,3)==a.substr(0,3)&&this._finishLastPacket(null,a))};f.prototype._onSocketTimeout=function(){};f.prototype._onSocketError=function(a){a.errorCode=c[1];this._finishAllPacket(a)};f.prototype._onSocketClose=function(a){a=Error("socket closed");a.errorCode=c[2];this._finishAllPacket(a)};var n=function(){this._buffer={}};n.prototype.EXPIRE_TO=3E3;n.prototype.updateDpt=
function(a){if(a&&3<a.length){var b=a.substr(0,3);this._buffer[b]={status:a,timestamp:(new Date).getTime()}}};n.prototype.getDpt=function(a){if(a&&3<a.length&&(a=a.substr(0,3),this._buffer[a])){if(!this._buffer[a].timestamp)return delete this._buffer[a],null;var b=(new Date).getTime(),d=b-this._buffer[a].timestamp;return d>this.EXPIRE_TO||0>d?(this._buffer[a].timestamp=b,null):null==this._buffer[a].status||"undefined"==typeof this._buffer[a].status?(delete this._buffer[a],null):this._buffer[a].status}return null};
n.prototype.delDpt=function(a){a&&3<a.length&&(a=a.substr(0,3),"AMT"!=a?delete this._buffer[a]:this._buffer[a].timestamp=(new Date).getTime())};n.prototype.refreshDptTime=function(){var a=(new Date).getTime(),b;for(b in this._buffer)this._buffer.hasOwnProperty(b)&&(this._buffer[b].timestamp=a)};var k=function(a,b,d,c,e){this._ip=a;this._port=b;this._port||(this._port=60128);this._uuid=d;this._logger=require("x.logger.js").getLogger("xnm.aio.onkyo.AVReceiver");this._model=c;this._name=e;this._socket=
null;this._taskBuffer=new g(this);this._packetBuffer=new f(this);this._datapointBuffer=new n};k.prototype.getIp=function(){return this._ip};k.prototype.getPort=function(){return this._port};k.prototype.executeCommandCreator=function(a,b,d){if(b&&b.value)if("openNative"==b.value)window&&window.XC&&window.XC.callHost&&window.XCHost.getType&&("iOS"==window.XCHost.getType()?window.XC.callHost("SYSTEM","startApp",{scheme:"onkyo-remote3://"}):"Android"==window.XCHost.getType()&&window.XC.callHost("SYSTEM",
"startApp",{scheme:"com.onkyo.jp.onkyoremote"})),d&&d();else{a="";b.path&&b.path[0]&&"global"!=b.path[0]&&(a=b.path[0]+":");var c=a+b.value;if("setTo"==b.value||"tuner"==b.value||"frontBassTo"==b.value||"frontTrebleTo"==b.value){if(null==b.ext||"undefined"==typeof b.ext){d&&d(Error("command setTo ext format invalid"));return}c+=b.ext}else if("audioMode"==b.value){if(!b.ext){d&&d(Error("command audioMode ext format invalid"));return}c+=b.ext}else if("setInput"==b.value){if(!b.ext){d&&d(Error("command setInput ext format invalid"));
return}c=a+b.ext}else if("customCMD"==b.value){if(!b.ext){d&&d(Error("command customCMD ext format invalid"));return}c=a+b.ext}var e=this;this._executeCommand(c,function(a){if(a)d&&d(a);else if("on"==b.value||"off"==b.value||"toggle"==b.value)setTimeout(function(){d&&d()},4E3);else{if("mute"==b.value||"unmute"==b.value||"toggleMute"==b.value){if(b.path&&b.path[0]&&"mainzone"==b.path[0]){e._datapointBuffer&&e._datapointBuffer.refreshDptTime();setTimeout(function(){d&&d()},3E3);return}}else if("volumeUp"==
b.value||"volumeDown"==b.value){setTimeout(function(){d&&d()},100);return}d&&d(a)}})}else d&&d(Error("command json format invalid"))};k.prototype.getStatesCreator=function(a,b,d){a=function(a,b){for(var d=0;d<b.length;d++)if(b[d]===a)return!0;return!1};for(var c=[],e=[],f=0;f<b.length;f++)if(b[f]&&b[f].id&&b[f].status&&b[f].status.value){var h="";b[f].status.path&&b[f].status.path[0]&&"global"!=b[f].status.path[0]&&(h=b[f].status.path[0]+":");var g=b[f].status.value;c.push({id:b[f].id,datapoint:h+
g});if("frontBass"==g||"frontTreble"==g)g="frontTone";a(h+g,e)||e.push(h+g)}this._getStates(e,function(a,b){if(a)d&&d(a);else{a=[];for(var e=0;e<c.length;e++){var f="?",h=c[e].id,l=c[e].datapoint;b&&null!=b[l]&&"undefined"!=typeof b[l]&&(f=b[l]);a.push({id:h,status:f})}d&&d(null,a)}})};k.prototype.executeCommand=function(a,b){this._executeCommand(a,b)};k.prototype.getStates=function(a){var b=Object.keys(k.STATUS_DPT_QUEST);this._getStates(b,function(b,c){a&&a(b,c)})};k.prototype._executeCommand=function(a,
b){this._logger.log("debug","execute command: "+a);a=new h(this._taskBuffer,this,a,b);this._taskBuffer.executeTask(a)};k.prototype._getStates=function(a,b){this._logger.log("debug","get states: "+JSON.stringify(a));a=new e(this._taskBuffer,this,a,b);this._taskBuffer.executeTask(a)};k.prototype._getCommandQuest=function(a){var b=a;var d=null;var c=a.indexOf(":");0<c&&(d=a.substr(0,c),a=a.substr(c+1));if("on"==a)b="zone2"==d?"ZPW01":"zone3"==d?"PW301":"PWR01";else if("off"==a)b="zone2"==d?"ZPW00":"zone3"==
d?"PW300":"PWR00";else if("mute"==a)b="zone2"==d?"ZMT01":"zone3"==d?"MT301":"AMT01";else if("unmute"==a)b="zone2"==d?"ZMT00":"zone3"==d?"MT300":"AMT00";else if("toggleMute"==a)b="zone2"==d?"ZMTTG":"zone3"==d?"MT3TG":"AMTTG";else if("volumeDown"==a)b="zone2"==d?"ZVLDOWN":"zone3"==d?"VL3DOWN":"MVLDOWN";else if("volumeUp"==a)b="zone2"==d?"ZVLUP":"zone3"==d?"VL3UP":"MVLUP";else if("BDDVD"==a||"BD/DVD"==a)b="zone2"==d?"SLZ10":"zone3"==d?"SL310":"SLI10";else if("STRMBOX"==a||"STRM BOX"==a)b="zone2"==d?
"SLZ11":"zone3"==d?"SL311":"SLI11";else if("CBLSAT"==a||"CBL/SAT"==a)b="zone2"==d?"SLZ01":"zone3"==d?"SL301":"SLI01";else if("PC"==a)b="zone2"==d?"SLZ05":"zone3"==d?"SL305":"SLI05";else if("GAME"==a)b="zone2"==d?"SLZ02":"zone3"==d?"SL302":"SLI02";else if("AUX"==a)b="zone2"==d?"SLZ03":"zone2"==d?"SL303":"SLI03";else if("CD"==a)b="zone2"==d?"SLZ23":"zone3"==d?"SL323":"SLI23";else if("TV"==a)b="zone2"==d?"SLZ12":"zone3"==d?"SL312":"SLI12";else if("FM"==a)b="zone2"==d?"SLZ24":"zone3"==d?"SL324":"SLI24";
else if("AM"==a)b="zone2"==d?"SLZ25":"zone3"==d?"SL325":"SLI25";else if("NET"==a)b="zone2"==d?"SLZ2B":"zone3"==d?"SL32B":"SLI2B";else if("BLUETOOTH"==a)b="zone2"==d?"SLZ2E":"zone3"==d?"SL32E":"SLI2E";else if("Optical"==a)b="zone2"==d?"SLZ44":"zone3"==d?"SL344":"SLI44";else if(0==a.indexOf("audioMode")){if(a=a.replace(/audioMode/g,""),"STEREO"==a||"MOVIE"==a||"MUSIC"==a||"GAME"==a)"STEREO"==a&&(a="00"),b="LMD"+a}else if("play"==a)b="NTCPLAY";else if("pause"==a)b="NTCPAUSE";else if("stop"==a)b="NTCSTOP";
else if("previous"==a)b="NTCTRDN";else if("next"==a)b="NTCTRUP";else if("frontBassUp"==a)b="TFRBUP";else if("frontBassDown"==a)b="TFRBDOWN";else if("frontTrebleUp"==a)b="TFRTUP";else if("frontTrebleDown"==a)b="TFRTDOWN";else if(0==a.indexOf("frontBassTo"))0==a.indexOf("frontBassTo")&&(a=a.replace(/frontBassTo/g,"")),a=a.replace(/%/g,""),a=parseInt(a),d=!1,0>a&&(d=!0,a=0-a),0>a&&(a=0),10<a&&(a=10),a=a.toString(16).toUpperCase(),b="TFRB"+(d?"-"+a:"+"+a);else if(0==a.indexOf("frontTrebleTo"))0==a.indexOf("frontTrebleTo")&&
(a=a.replace(/frontTrebleTo/g,"")),a=a.replace(/%/g,""),a=parseInt(a),d=!1,0>a&&(d=!0,a=0-a),0>a&&(a=0),10<a&&(a=10),a=a.toString(16).toUpperCase(),b="TFRT"+(d?"-"+a:"+"+a);else if(0==a.indexOf("tuner"))a=a.replace(/tuner/g,""),"Up"==a?b="zone2"==d?"PRZUP":"zone3"==d?"PR3UP":"PRSUP":"Down"==a?b="zone2"==d?"PRZDOWN":"zone3"==d?"PR3DOWN":"PRSDOWN":(a=parseInt(a),0>a?a=0:40<a&&(a=40),b="zone2"==d?"PRZ"+XC.getHexVal(a,2):"zone3"==d?"PR3"+XC.getHexVal(a,2):"PRS"+XC.getHexVal(a,2));else if(0==a.indexOf("setTo")||
/^\d+$/.test(a))0==a.indexOf("setTo")&&(a=a.replace(/setTo/g,"")),a=a.replace(/%/g,""),"zone2"==d?(a=parseInt(a),0>a?a=0:100<a&&(a=100),b="ZVL"+XC.getHexVal(a,2)):"zone3"==d?(a=parseInt(a),0>a?a=0:100<a&&(a=100),b="VL3"+XC.getHexVal(a,2)):(a=parseInt(a),0>a?a=0:100<a&&(a=100),b="MVL"+XC.getHexVal(a,2));return b};k.STATUS_DPT_QUEST={"mainzone:power":"PWRQSTN","mainzone:volume":"MVLQSTN","mainzone:mute":"AMTQSTN","mainzone:audioMode":"LMDQSTN","mainzone:input":"SLIQSTN","mainzone:frontTone":"TFRQSTN",
"zone2:power":"ZPWQSTN","zone2:volume":"ZVLQSTN","zone2:mute":"ZMTQSTN","zone2:input":"SLZQSTN","zone3:power":"PW3QSTN","zone3:volume":"VL3QSTN","zone3:mute":"MT3QSTN","zone3:input":"SL3QSTN"};k.LMD_MAP={"00":"Stereo","01":"Direct","02":"SURROUND","03":"Game-RPG","04":"THX","05":"Game-Action","06":"Game-Rock","07":"MONO MOVIE","08":"Orchestra","09":"Unplugged","0A":"Studio-Mix","0B":"TV Logic","0C":"All Ch Stereo","0D":"Theater-Dimensional","0E":"Game-Sports","0F":"Mono",11:"Pure Audio",12:"MULTIPLEX",
13:"Full Mono",14:"DOLBY VIRTUAL",15:"DTS Surround Sensation",16:"Audyssey DSX","1F":"Whole House Mode",23:"Stage",25:"Action",26:"Music","2E":"Sports",40:"Straight Decode*1",41:"Dolby EX*2",42:"THX Cinema",43:"THX Surround EX",44:"THX Music",45:"THX Games",50:"THX U2/S2/I/S Cinema/Cinema2",51:"THX U2/S2/I/S Music",52:"THX U2/S2/I/S Games",80:"Dolby Surround",81:"PLII/PLIIx Music",82:"DTS Neo:6 Cinema",83:"DTS Neo:6 Music",84:"PLII/PLIIx THX Cinema",85:"Neo:6/Neo:X THX Cinema",86:"PLII/PLIIx Game",
87:"Neural Surr*3",88:"Neural THX/Neural Surround",89:"PLII/PLIIx THX Games","8A":"Neo:6/Neo:X THX Games","8B":"PLII/PLIIx THX Music","8C":"Neo:6/Neo:X THX Music","8D":"Neural THX Cinema","8E":"Neural THX Music","8F":"Neural THX Games",90:"PLIIz Height",91:"Neo:6 Cinema DTS Surround Sensation",92:"Neo:6 Music DTS Surround Sensation",93:"Neural Digital Music",94:"PLIIz Height + THX Cinema",95:"PLIIz Height + THX Music",96:"PLIIz Height + THX Games",97:"PLIIz Height + THX U2/S2 Cinema",98:"PLIIz Height + THX U2/S2 Music",
99:"PLIIz Height + THX U2/S2 Games","9A":"Neo:X Game",A0:"PLIIx/PLII Movie + Audyssey DSX",A1:"PLIIx/PLII Music + Audyssey DSX",A2:"PLIIx/PLII Game + Audyssey DSX",A3:"Neo:6 Cinema + Audyssey DSX",A4:"Neo:6 Music + Audyssey DSX",A5:"Neural Surround + Audyssey DSX",A6:"Neural Digital Music + Audyssey DSX",A7:"Dolby EX + Audyssey DSX"};k.prototype._getStateQuest=function(a){return a?k.STATUS_DPT_QUEST[a]:null};k.prototype._buildData=function(a){var b=[73,83,67,80,0,0,0,16,0,0,0,8,1,0,0,0,33,49],d=2+
a.length+1&4294967295;b[8]=d>>24&255;b[9]=d>>16&255;b[9]=d>>8&255;b[11]=d&255;for(d=0;d<a.length;d++)b.push(a.charCodeAt(d));b.push(13);return new Buffer(b)};k.prototype._resolveStatus=function(a){var b={mainzone:{},zone2:{},zone3:{}};if(0==a.indexOf("MVL"))a.substr(3).match(/[0-9A-Fa-f]{2}/g)&&(b.mainzone.volume=parseInt(a.substr(3),16));else if(0==a.indexOf("PWR"))"00"==a.substr(3)?b.mainzone.power="off":"01"==a.substr(3)&&(b.mainzone.power="on");else if(0==a.indexOf("AMT"))"00"==a.substr(3)?b.mainzone.mute=
"off":"01"==a.substr(3)&&(b.mainzone.mute="on");else if(0==a.indexOf("LMD"))a=a.substr(3).trim(),k.LMD_MAP[a]&&(b.mainzone.audioMode=k.LMD_MAP[a]);else if(0==a.indexOf("TFR")){if(a=a.substr(3),6==a.length){var d=parseInt(a.substr(2,1),16),c="-"==a.charAt(1);c&&(d=0-d);var e=parseInt(a.substr(5,1),16);(c="-"==a.charAt(4))&&(e=0-e);b.mainzone.frontBass=d;b.mainzone.frontTreble=e}}else if(0==a.indexOf("ZVL"))a.substr(3).match(/[0-9A-Fa-f]{2}/g)&&(b.zone2.volume=parseInt(a.substr(3),16));else if(0==a.indexOf("ZPW"))"00"==
a.substr(3)?b.zone2.power="off":"01"==a.substr(3)&&(b.zone2.power="on");else if(0==a.indexOf("ZMT"))"00"==a.substr(3)?b.zone2.mute="off":"01"==a.substr(3)&&(b.zone2.mute="on");else if(0==a.indexOf("VL3"))a.substr(3).match(/[0-9A-Fa-f]{2}/g)&&(b.zone3.volume=parseInt(a.substr(3),16));else if(0==a.indexOf("PW3"))"00"==a.substr(3)?b.zone3.power="off":"01"==a.substr(3)&&(b.zone3.power="on");else if(0==a.indexOf("MT3"))"00"==a.substr(3)?b.zone3.mute="off":"01"==a.substr(3)&&(b.zone3.mute="on");else if(0==
a.indexOf("SLI")||0==a.indexOf("SLZ")||0==a.indexOf("SL3"))d=b.mainzone,0==a.indexOf("SLZ")?d=b.zone2:0==a.indexOf("SL3")&&(d=b.zone3),"10"==a.substr(3)?d.input="BD/DVD":"11"==a.substr(3)?d.input="STRM BOX":"01"==a.substr(3)?d.input="CBL/SAT":"05"==a.substr(3)?d.input="PC":"02"==a.substr(3)?d.input="GAME":"03"==a.substr(3)?d.input="AUX":"23"==a.substr(3)?d.input="CD":"12"==a.substr(3)?d.input="TV":"24"==a.substr(3)?d.input="FM":"25"==a.substr(3)?d.input="AM":"2B"==a.substr(3)?d.input="NET":"2E"==
a.substr(3)?d.input="BLUETOOTH":"44"==a.substr(3)&&(d.input="Optical");return b};k.prototype._doCommandReq=function(a,b){this._datapointBuffer&&this._datapointBuffer.delDpt(a);this._packetBuffer.sendPacket(a,!0,b)};k.prototype._doStateReq=function(a,b){var d=this;if(this._datapointBuffer){var c=this._datapointBuffer.getDpt(a);if(c){a=this._resolveStatus(c);b(null,a);return}}this._packetBuffer.sendPacket(a,!1,function(a,c){a?b(a):(a=d._resolveStatus(c),b(null,a))})};k.prototype._sendPacket=function(a,
b){if(this._socket){this._logger.log("trace","send ISCP message:"+a);var d=this._buildData(a);this._socket.write(d,"binary");b()}else{var c=this;this._connect(function(d){d?b(d):c._sendPacket(a,b)})}};k.prototype._connect=function(a){this._socket&&(this._socket.end(),this._socket=null);var b=this,d={port:this._port,host:this._ip},c=require("net").connect(d);c.setTimeout(2E3);c.__connected=!1;c.on("connect",function(){b._logger.log("trace","connect to onkyo avr:"+b._ip);c.__connected=!0;b._socket=
c;a()});c.on("data",function(a){b._logger.log("trace","receive from onkyo avr "+(c.__disconnected?"(closed)":"")+":"+b._ip+" data:"+a);c.__disconnected||b._packetBuffer._onSocketData(a)});c.on("error",function(d){c.__connected?(b._logger.log("trace","onkyo avr"+(c.__disconnected?"(closed)":"")+":"+b._ip+" error:"+d.message),c.destroy(),c.__disconnected||(c.__disconnected=!0,b._socket=null,b._packetBuffer._onSocketError(d))):(b._logger.log("trace","onkyo avr:"+b._ip+" connection error:"+d.message),
a(d))});c.on("timeout",function(){c.__connected?(b._logger.log("trace","onkyo avr"+(c.__disconnected?"(closed)":"")+":"+b._ip+" data timeout"),c.__disconnected||b._packetBuffer._onSocketTimeout()):(b._logger.log("trace","onkyo avr:"+b._ip+" connection timeout"),c.destroy&&c.destroy(),a(Error("timeout")))});c.on("close",function(){b._logger.log("trace","onkyo avr"+(c.__disconnected?"(closed)":"")+":"+b._ip+" close socket");c.__disconnected||(c.__disconnected=!0,b._socket=null,b._packetBuffer._onSocketClose(c))});
c._doConnect&&"function"==typeof c._doConnect&&c._doConnect();return c};k.prototype._disconnect=function(){this._logger.log("debug","disconnect socket");this._socket&&(this._socket.__disconnected=!0,this._socket.end(),this._socket=null)};k.prototype.toJSON=function(){var a={sys:xnm.aio.onkyo.DM.SYS,type:"avr",ip:this._ip,port:this._port,uuid:this._uuid,model:this._model};this._name&&(a.name=this._name);return a};k.prototype.equalsTo=function(a){return a&&a instanceof k?this._ip==a._ip&&this._port==
a._port:!1};k.parseJSON=function(a){return a.ip?new k(a.ip,a.port,a.uuid,a.model,a.name):null};var m=function(a,b,d,c,e){this._avr=xnm.aio.onkyo.AVReceiverBuffer.getAVR(a,b);this._avr||(this._avr=new k(a,b,d,c,e),xnm.aio.onkyo.AVReceiverBuffer.setAVR(this._avr))};m.prototype.getUUID=function(){return this._avr?this._avr._uuid:null};m.prototype.executeCommandCreator=function(a,b,d){this._avr.executeCommandCreator(a,b,d)};m.prototype.getStatesCreator=function(a,b,d){this._avr.getStatesCreator(a,b,d)};
m.prototype.executeCommand=function(a,b){this._avr.executeCommand(a,b)};m.prototype.getStates=function(a){this._avr.getStates(a)};m.prototype.toJSON=function(){return this._avr.toJSON()};m.prototype.equalsTo=function(a){return this._avr.equalsTo(a._avr)};m.parseJSON=function(a){return a.ip?new m(a.ip,a.port,a.uuid,a.model,a.name):null};return m}();
xnm.aio.onkyo.DM=function(){var c=function(c,e){this.code=c;this.message=e;this.stack=Error().stack};c.prototype=Error();c.prototype.name="OnkyoDMError";c.prototype.code=0;c.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var e={avr:{command:[{type:"root",name:"global",value:"global",children:[{type:"string",name:"custom command",ref:{value:"customCMD",ext:"%s"}},{type:"enum",name:"open Onkyo Remote App",ref:{value:"openNative"}}]},{type:"root",name:"NET",
value:"net",children:[{type:"enum",name:"play",ref:{path:["global"],value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",
ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume to",ref:{value:"setTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"set listening mode",ref:{value:"audioMode",ext:"%e",extMeta:["MOVIE","MUSIC","GAME","STEREO"]}},{type:"enum",name:"front bass up",ref:{value:"frontBassUp"}},{type:"enum",
name:"front bass down",ref:{value:"frontBassDown"}},{type:"int",name:"front bass to",ref:{value:"frontBassTo",ext:"%d",extMeta:"-10-10",scale:"2"}},{type:"enum",name:"front treble up",ref:{value:"frontTrebleUp"}},{type:"enum",name:"front treble down",ref:{value:"frontTrebleDown"}},{type:"int",name:"front treble to",ref:{value:"frontTrebleTo",ext:"%d",extMeta:"-10-10",scale:"2"}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},
{type:"int",name:"set tuner preset",ref:{value:"tuner",ext:"%d",extMeta:"1-40",scale:"1"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"CBL/SAT;BD/DVD;STRM BOX;GAME;AUX;PC;CD;TV;NET;BLUETOOTH;FM;AM;Optical".split(";")}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},
{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume to",ref:{value:"setTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},{type:"int",name:"set tuner preset",ref:{value:"tuner",ext:"%d",extMeta:"1-40",scale:"1"}},
{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"CBL/SAT;BD/DVD;STRM BOX;GAME;AUX;PC;CD;TV;NET;BLUETOOTH;FM;AM;Optical".split(";")}}]},{type:"root",name:"zone 3",value:"zone3",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume to",
ref:{value:"setTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},{type:"int",name:"set tuner preset",ref:{value:"tuner",ext:"%d",extMeta:"1-40",scale:"1"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"CBL/SAT;BD/DVD;STRM BOX;GAME;AUX;PC;CD;TV;NET;BLUETOOTH;FM;AM;Optical".split(";")}}]}],
status:[{type:"root",name:"main zone",value:"mainzone",children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-80",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"int",name:"front bass",ref:{value:"frontBass",extMeta:"-10-10",scale:"2"}},{type:"int",name:"front treble",ref:{value:"frontTreble",extMeta:"-10-10",scale:"2"}},{type:"enum",name:"listening mode",ref:{value:"audioMode",options:["Stereo",
"All Ch Stereo"]}},{type:"enum",name:"input",ref:{value:"input",options:"CBLSAT BDDVD STRMBOX GAME AUX PC CD TV NET BLUETOOTH FM AM Optical".split(" ")}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-80",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:"CBLSAT BDDVD STRMBOX GAME AUX PC CD TV NET BLUETOOTH FM AM Optical".split(" ")}}]},
{type:"root",name:"zone 3",value:"zone3",children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-80",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:"CBLSAT BDDVD STRMBOX GAME AUX PC CD TV NET BLUETOOTH FM AM Optical".split(" ")}}]}]}};return{SYS:"onkyo",getIPDeviceType:function(){return[{sys:this.SYS,name:"Onkyo AV Receiver",type:"avr"}]},
createDevice:function(e,g,f){g=c.ERROR_CODE;e?e.ip?f(null,e):f(new c(g.INVALID,"ip is invalid")):f(new c(g.INVALID,"info is invalid"))},updateDevice:function(e,g,f){g=c.ERROR_CODE;e?e.ip?f(null,e):f(new c(g.INVALID,"ip is invalid")):f(new c(g.INVALID,"info is invalid"))},deleteDevice:function(c,e,f){f()},applyUIFilter:function(c,e,f){var h=function(a,d,c){var b=[];a.forEach(function(a){if("root"==a.type){a=JSON.parse(JSON.stringify(a));var e=h(a.children,d,c);e&&0<e.length&&(a.children=e,b.push(a))}else{e=
c.elems;if("*"==e)e=!0;else{for(var f=!1,g=0;g<e.length;g++)if(e[g]==a.type){f=!0;break}e=f}e&&(a=JSON.parse(JSON.stringify(a)),b.push(a))}});return b},g=function(a,d){var b=[],c=xnm.aio.onkyo.DM.getCommandStatusMap(a,f);if(c){var e=[];switch(d.catagory){case "command":c.command&&(e=h(c.command,a,d));break;case "status":c.status&&(e=h(c.status,a,d))}b=b.concat(e)}return b};if(!c.sys)return null;var m=JSON.parse(JSON.stringify(c)),a=null;switch(e.catagory){case "command":a=g(c,e);m.command=a;break;
case "status":a=g(c,e);m.status=a;break;default:return null}return a&&0!=a.length?m:null},getCommandStatusMap:function(c){return c&&c.type?e[c.type]:null}}}();
xnm.aio.onkyo.Handler=function(){var c=function(){this.detectedAVRs={}};c.prototype.devicemanager=xnm.aio.onkyo.DM;c.prototype.AVReceiver=xnm.aio.onkyo.AVReceiver;c.prototype.registModule=function(c){c.register(xnm.aio.onkyo.DM.SYS,"onkyo")};c.prototype.resolveDevice=function(c){if(!c)return null;switch(c.type){case "avr":return xnm.aio.onkyo.AVReceiver.parseJSON(c);default:return null}};c.prototype.getDeviceCommands=function(c,h){c=(c=xnm.aio.onkyo.DM.applyUIFilter(c,{catagory:"command",elems:"*"}))?
c.command:[];h&&h(null,c)};c.prototype.getDeviceStatus=function(c,h){c=(c=xnm.aio.onkyo.DM.applyUIFilter(c,{catagory:"status",elems:"*"}))?c.status:[];h&&h(null,c)};c.prototype.doCommand=function(c,h,g){var e=this.resolveDevice(c);e?e.executeCommandCreator(c,h,function(c){g&&g(c)}):g&&g(Error("device json format invalid"))};c.prototype.doStatus=function(c,h,g,f){var e=this.resolveDevice(h);e?e.getStatesCreator(null,[{id:c,device:h,status:g}],function(c,e){c?f&&f(c):f&&f(null,e[0])}):f&&f(Error("device json format invalid"))};
c.prototype.getDeviceCommandList=function(c,h,g){var e=[];if(h)e.push({id:window.XC_Text.on,cmd:"on"}),e.push({id:window.XC_Text.off,cmd:"off"});else if(g&&"avr"==c.type){c=[];c.push({id:"on",cmd:"on"});c.push({id:"off",cmd:"off"});c.push({id:"toggle",cmd:"toggle"});c.push({id:"volumeDown",cmd:"volumeDown"});c.push({id:"volumeUp",cmd:"volumeUp"});c.push({id:"set volume",cmd:"setTo",step:"1",max:"80"});c.push({id:"mute",cmd:"mute"});c.push({id:"unmute",cmd:"unmute"});c.push({id:"toggleMute",cmd:"toggleMute"});
c.push({id:"CBLSAT",cmd:"CBLSAT"});c.push({id:"BDDVD",cmd:"BDDVD"});c.push({id:"STRMBOX",cmd:"STRMBOX"});c.push({id:"GAME",cmd:"GAME"});c.push({id:"AUX",cmd:"AUX"});c.push({id:"PC",cmd:"PC"});c.push({id:"CD",cmd:"CD"});c.push({id:"TV",cmd:"TV"});c.push({id:"NET",cmd:"NET"});c.push({id:"BLUETOOTH",cmd:"BLUETOOTH"});c.push({id:"FM",cmd:"FM"});c.push({id:"AM",cmd:"AM"});c.push({id:"tunerUp",cmd:"tunerUp"});c.push({id:"tunerDown",cmd:"tunerDown"});c.push({id:"set tuner to",cmd:"tuner",step:"1",min:"1",
max:"40"});cl=c.length;for(h=0;h<cl;h++)g=JSON.parse(JSON.stringify(c[h])),g.ch="mainzone",e.push(g),g=JSON.parse(JSON.stringify(c[h])),g.ch="zone2",e.push(g);e.push({id:"MOVIE",cmd:"MOVIE"});e.push({id:"MUSIC",cmd:"MUSIC"});e.push({id:"GAME",cmd:"GAME"});e.push({id:"STEREO",cmd:"STEREO"});e.push({id:"play",cmd:"play"});e.push({id:"pause",cmd:"pause"});e.push({id:"stop",cmd:"stop"});e.push({id:"previous",cmd:"previous"});e.push({id:"next",cmd:"next"})}return e};c.prototype.discoverDevices=function(c){var e=
require("x.upnp.js");if(e){var g=this;e.discoverDevicesWithTimeout(3E3,function(e){if(e.manufacturer&&0==e.manufacturer.indexOf("ONKYO")&&"AV Receiver"==e.modelDescription){var f=new xnm.aio.onkyo.AVReceiver(e.ip,null,e.uuid,e.modelName,e.name);g.detectedAVRs["uuid:"+e.uuid]||(g.detectedAVRs["uuid:"+e.uuid]=f);c(f)}})}};c.prototype.discoverWithTimeout=function(c,h){var e={};this.discoverDevices(function(c){c&&c.getUUID()&&!e[c.getUUID()]&&(e[c.getUUID()]=c)});setTimeout(function(){var c=[],g;for(g in e)e.hasOwnProperty(g)&&
c.push(e[g]);h&&h(null,c)},c)};return c}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.onkyo.Handler);
