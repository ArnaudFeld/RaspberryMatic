var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.cloudservice=xnm.aio.cloudservice||{};
xnm.aio.cloudservice.CloudService=function(){var g=function(a){this._cloudservice=a};g.prototype.getRules=function(a){this._cloudservice._doJsonRequest("GET","/rules",null,null,a)};g.prototype.addRule=function(a,b){a?this._cloudservice._doJsonRequest("POST","/rules",null,a,b):b&&b(Error("rule is null"))};g.prototype.updateRule=function(a,b,f){a?b?this._cloudservice._doJsonRequest("POST","/rules/"+a,null,b,f):f&&f(Error("rule is null")):f&&f(Error("rule id is null"))};g.prototype.deleteRule=function(a,
b){a?this._cloudservice._doJsonRequest("POST","/rules/"+a,null,{},b):b&&b(Error("rule id is null"))};g.prototype.deleteRules=function(a,b){this._cloudservice._doJsonRequest("DELETE","/rules",a,null,b)};var d=function(a){this._cloudservice=a;this._version="v1"};d.prototype.disconenct=function(a,b,f){a?b?this._cloudservice._doJsonRequest("GET","/eapi/"+this._version+"/"+a+"/disconnect",{id:b},null,function(a,b){f&&f(a,b)}):f&&f(Error("invalid connection id")):f&&f(Error("invalid module"))};d.prototype.getModuleConnectionInfo=
function(a,b,f){this._cloudservice._doJsonRequest("GET","/eapi/"+this._version+"/"+a+"/info/"+b,null,null,function(a,b){f(a,b)})};d.prototype.getModuleInfo=function(a,b){this._cloudservice._doJsonRequest("GET","/eapi/"+this._version+"/"+a+"/info",null,null,function(a,c){b(a,c)})};d.prototype.getModuleDevices=function(a,b){this._cloudservice._doJsonRequest("GET","/eapi/"+this._version+"/"+a+"/devices",null,null,function(a,c){b(a,c)})};d.prototype.getModuleStates=function(a,b){this._cloudservice._doJsonRequest("GET",
"/eapi/"+this._version+"/"+a+"/states",null,null,function(a,c){b(a,c)})};d.prototype.executeModuleCommand=function(a,b,f){this._cloudservice._doJsonRequest("POST","/eapi/"+this._version+"/"+a+"/command",null,b,function(a,b){f(a,b)})};var e=function(a){this._cloudservice=a;this._version="v1"};e.prototype.getUserInfo=function(a){this._cloudservice._doJsonRequest("GET","/service/userInfo",null,null,function(b,f){a(b,f)})};e.prototype.getModulesInfo=function(a){this._cloudservice._doJsonRequest("GET",
"/service/moduleInfo",null,null,function(b,f){a(b,f)})};e.prototype.toCloudDevice=function(a,b){this._cloudservice._doJsonRequest("POST","/service/toCloudDevice",null,a,function(a,c){b(a,c)})};var c=function(a,b,f,c){this._logger=require("x.logger.js").getLogger("xnm.aio.cloudservice.CloudService");this._ip=a;this._ip||(this._ip="cloud.mediola.com");this._port=b;this._port||(this._port=443);this._username=f;this._password=c;this._protocol="https";this._eapi=new d(this);this._ruleEngine=new g(this);
this._service=new e(this)};c.prototype.getIP=function(){return this._ip};c.prototype.getPort=function(){return this._port};c.prototype.getUsername=function(){return this._password};c.prototype.getUserInfo=function(a){this._service.getUserInfo(a)};c.prototype.getModulesInfo=function(a){this._service.getModulesInfo(a)};c.prototype.toCloudDevice=function(a,b){this._service.toCloudDevice(a,b)};c.prototype.disconenct=function(a,b,f){this._eapi.disconenct(a,b,f)};c.prototype.getModuleConnectionInfo=function(a,
b,f){this._eapi.getModuleConnectionInfo(a,b,f)};c.prototype.getModuleInfo=function(a,b){this._eapi.getModuleInfo(a,b)};c.prototype.getModuleDevices=function(a,b){this._eapi.getModuleDevices(a,b)};c.prototype.getModuleStates=function(a,b){this._eapi.getModuleStates(a,b)};c.prototype.executeModuleCommand=function(a,b,f){this._eapi.executeModuleCommand(a,b,f)};c.prototype.getRules=function(a){this._ruleEngine.getRules(a)};c.prototype.addRule=function(a,b){this._ruleEngine.addRule(a,b)};c.prototype.updateRule=
function(a,b,f){this._ruleEngine.updateRule(a,b,f)};c.prototype.deleteRule=function(a,b){this._ruleEngine.updateRule(a,b)};c.prototype.deleteRules=function(a,b){this._ruleEngine.deleteRules(a,b)};c.prototype.getAccessToken=function(a,b,f){a={sid:a};b&&(a.force=1);this._doJsonRequest("GET","/getAccessToken",a,null,function(a,b){a?f&&f(a):b?f&&f(null,b.at):f&&f(Error("invalid response"))})};c.prototype.executeCommandCreator=function(a,b,f){if(a&&a.module&&a.connection&&a.id)if(b&&b.value){var c={connection:a.connection,
device:a.id,command:b.value};"undefined"!=typeof b.ext&&null!=b.ext&&(c.value=b.ext);this.executeModuleCommand(a.module,c,function(a){f&&f(a)})}else f&&f(Error("command json invalid"));else f&&f(Error("device json invalid"))};c.prototype.getStatesCreator=function(a,b,c){var d=this;a=function(a,b){d.getModuleStates(a,function(c,f){b(c,f,a)})};var e=[],g;for(g=0;g<b.length;g++){var h=b[g];h&&h.device&&h.device.module&&-1==e.indexOf(h.device.module)&&e.push(h.device.module)}if(0==e.length)c&&c(null,
[]);else{var n=0,k=[];for(g=0;g<e.length;g++)a(e[g],function(a,d,g){n++;var h=[];if(!a&&d)for(var m=0;m<b.length;m++){var l=b[m];if(l&&l.id&&l.device&&l.device.module==g){var q=null;if(l.device&&l.device.connection&&l.device.id&&l.status&&l.status.value){var r=d[l.device.connection];r&&r[l.device.id]&&(r=r[l.device.id].states)&&(q=r[l.status.value])}if("undefined"==typeof q||null==q)q="?";k.push({id:l.id,status:q});h.push({id:l.id,status:q})}}"undefined"!=typeof commandhandler&&null!=commandhandler&&
"undefined"!=typeof commandhandler.reportStates&&null!=commandhandler.reportStates&&!a&&h&&0<h.length&&commandhandler.reportStates(null,h);n==e.length&&c&&c(null,k)})}};c.prototype.getDeviceList=function(a,b){this.getModuleDevices(a,function(c,d){if(c)b(c);else{var e=[];if(d)for(var g in d){var h=d[g],n;for(n in h){var k=h[n];k&&(k.sys="cloudservice",k.module=a,k.connection=g,k.id=n,e.push(k))}}b(null,e)}})};c.prototype._doJsonRequest=function(a,b,c,d,e){var g=null;d&&(g=JSON.stringify(d));this._doRequest(a,
b,c,g,function(a,b){a?e&&e(a):b?b.XC_ERR?(a=Error("error response:"+b.XC_ERR.msg),a.code=b.XC_ERR.code,e&&e(a)):b.XC_SUC?e&&e(null,b.XC_SUC):e&&e(Error("unknown response")):e&&e(Error("invalid response"))})};c.prototype._doRequest=function(a,b,c,d,e){b||(b="/");var g={};c&&(g=JSON.parse(JSON.stringify(c)));c="";for(var h in g)g.hasOwnProperty(h)&&(c&&(c+="&"),c+=h+"="+encodeURIComponent(g[h]));c&&(b+="?"+c);a={host:this._ip,port:this._port,path:b,method:a,headers:{Connection:"close","Content-Type":"application/json;  charset=UTF-8"}};
if(this._username||this._password)a.auth=(this._username?this._username:"")+":"+(this._password?this._password:""),a.headers.Authorization="Basic "+(new Buffer((this._username?this._username:"")+":"+(this._password?this._password:""))).toString("base64");h=require(this._protocol);"https"==this._protocol&&"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");c=JSON.parse(JSON.stringify(a));c.headers&&(c.headers.auth&&(c.headers.auth="*********"),c.headers.Authorization&&
(c.headers.Authorization="*********"));c.auth&&(c.auth="********");this._logger.log("trace","do request:"+JSON.stringify(c));var n=this,k=e,p=h.request(a,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){n._logger.log("trace","receive code:"+a.statusCode+" headers:"+JSON.stringify(a.headers)+" response:"+b);var c,d;if(200==a.statusCode)try{d=b?JSON.parse(b):null}catch(e){c=e}else c=Error("http reponse:"+a.statusCode);k&&(k(c,d,a.statusCode),k=null)})});
if(p.on)p.on("error",function(a){n._logger.log("trace","do request error:"+a.message);k&&(k(a),k=null)});p.setTimeout&&p.setTimeout(2E4,function(){n._logger.log("trace","do request timeout");p.abort();k&&(k(Error("timeout")),k=null)});d&&(this._logger.log("trace","do request send body:"+d),p.write(d));p.end()};c.prototype.toJSON=function(){return{sys:"cloudservice",username:this._username,password:this._password,ip:this._ip,port:this._port}};c.prototype.equalsTo=function(a){return a&&a instanceof
c?this._ip==a._ip&&this._port==a._port&&this._username==a._username&&this._password==a._password:!1};c.parseJSON=function(a){return a&&a.username&&a.password?new c(a.ip,a.port,a.username,a.password):null};return c}();
xnm.aio.cloudservice.DM=function(){var g=function(d,e){this.code=d;this.message=e;this.stack=Error().stack};g.prototype=Error();g.prototype.name="cloudserviceDMError";g.prototype.code=0;g.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"cloudservice",getGatewayType:function(){return[{sys:this.SYS,name:"Cloud Service"}]},createGateway:function(d,e,c){e=g.ERROR_CODE;d?d.username?d.password?c(null,d):c(new g(e.INVALID,"password is invalid")):c(new g(e.INVALID,
"username is invalid")):c(new g(e.INVALID,"info is invalid"))},updateGateway:function(d,e,c,a){d=g.ERROR_CODE;e?e.username?e.password?a(null,e):a(new g(d.INVALID,"password is invalid")):a(new g(d.INVALID,"username is invalid")):a(new g(d.INVALID,"update is invalid"))},deleteGateway:function(d,e,c){c()},createDevice:function(d,e,c){var a=g.ERROR_CODE;if(d)if(d.connection)if(d.id)if(d.gateway){e=e.data.gateways;var b,f;for(b=0;b<e.length;b++)if(e[b].index===d.gateway){f=e[b];break}f?c&&c(null,d):c(new g(a.NOT_FOUND,
"gateway with index "+d.gateway+" not exists"))}else c(new g(a.INVALID,"gateway is invalid"));else c(new g(a.INVALID,"id is invalid"));else c(new g(a.INVALID,"connection is invalid"));else c(new g(a.INVALID,"info is invalid"))},updateDevice:function(d,e,c){var a=g.ERROR_CODE;if(d)if(d.connection)if(d.id)if(d.gateway){e=e.data.gateways;var b,f;for(b=0;b<e.length;b++)if(e[b].index===d.gateway){f=e[b];break}f?c(null,d):c(new g(a.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else c(new g(a.INVALID,
"gateway is invalid"));else c(new g(a.INVALID,"id is invalid"));else c(new g(a.INVALID,"connection is invalid"));else c(new g(a.INVALID,"info is invalid"))},deleteDevice:function(d,e,c){c()},applyUIFilter:function(d,e,c){var a=this,b=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},f=function(a,c,d){var e=[];"command"==d.catagory?a.command&&a.command.forEach(function(a){b(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))}):"status"==d.catagory?
a.status&&a.status.forEach(function(a){b(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))}):"ipevt"==d.catagory&&a.status&&a.ipevt.forEach(function(a){b(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});return e},g=function(b,d){var e=[],g=null;if(g=a.getCommandStatusMap(b,c))g=f(g,b,d),e=e.concat(g);return e};if(!d.sys)return null;var t=JSON.parse(JSON.stringify(d)),m=null;if("command"==e.catagory)m=g(d,e),t.command=m;else if("status"==e.catagory)m=g(d,e),t.status=m;else if("ipevt"==
e.catagory)m=g(d,e),t.ipevt=m;else return null;return m&&0!=m.length?t:null},applyIPEventFilter:function(d){return d?this.applyUIFilter(d,{catagory:"ipevt",elems:"*"}):null},getCommandStatusMap:function(d,e){if(!d)return null;var c={command:[],status:[]},a,b,f;if(d.commands)for(a in c.command=[],d.commands)if(b=d.commands[a],b.values)c.command.push({type:"enum",name:a,ref:{value:a,ext:"%e",extMeta:b.values}});else if(b.value){switch(b.value.type){case "FLOAT":f={type:"float",name:a,ref:{value:a,ext:"%f"}};
break;case "RGB":f={type:"rgb",name:a,ref:{value:a,ext:"%rgb"}};break;case "RGBW":f={type:"rgbw",name:a,ref:{value:a,ext:"%rgbw"}};break;default:f={type:"int",name:a,ref:{value:a,ext:"%d"}}}void 0!=b.value.min&&null!=b.value.min&&void 0!=b.value.max&&null!=b.value.max&&f&&(f.ref.extMeta=b.value.min+"-"+b.value.max);void 0!=b.value.step&&null!=b.value.step&&f&&(f.ref.scale=b.value.step);f&&c.command.push(f)}else c.command.push({type:"enum",name:a,ref:{value:a}});if(d.states)for(a in c.status=[],c.ipevt=
[],d.states)if(b=d.states[a],b.values)0!=b.state&&c.status.push({type:"enum",name:a,ref:{value:a,options:b.values}}),0!=b.event&&c.ipevt.push({type:"enum",name:a,ref:{value:a,options:b.values}});else{switch(b.type){case "BOOL":f={type:"enum",name:a,ref:{value:a,options:["true","false"]}};break;case "FLOAT":f={type:"float",name:a,ref:{value:a}};break;case "RGB":f={type:"rgb",name:a,ref:{value:a}};break;case "RGBW":f={type:"rgbw",name:a,ref:{value:a}};break;case "STRING":f={type:"string",name:a,ref:{value:a}};
break;case "TIME":f={type:"int",name:a,ref:{value:a}};break;default:f={type:"int",name:a,ref:{value:a}}}void 0!=b.min&&null!=b.min&&void 0!=b.max&&null!=b.max&&f&&(f.ref.extMeta=b.min+"-"+b.max);void 0!=b.step&&null!=b.step&&f&&(f.ref.scale=b.step);f&&(0!=b.state&&c.status.push(f),0!=b.event&&c.ipevt.push(f))}return c}}}();
xnm.aio.cloudservice.Handler=function(){var g=function(){};g.prototype.devicemanager=xnm.aio.cloudservice.DM;g.prototype.CloudService=xnm.aio.cloudservice.CloudService;g.prototype.registModule=function(d){d.register("cloudservice","cloudservice")};g.prototype.resolveGateway=function(d){return d?this.CloudService.parseJSON(d):null};g.prototype.getDeviceCommands=function(d,e){var c=this.devicemanager.applyUIFilter(d,{catagory:"command",elems:"*"}),c=c?c.command:[];e&&e(null,c)};g.prototype.getDeviceStatus=
function(d,e){var c=this.devicemanager.applyUIFilter(d,{catagory:"status",elems:"*"}),c=c?c.status:[];e&&e(null,c)};g.prototype.doCommand=function(d,e,c,a){(d=this.resolveGateway(d))?d.executeCommandCreator(e,c,function(b){a&&a(b)}):a&&a(Error("gateway json format invalid"))};g.prototype.doStatus=function(d,e,c,a,b){(e=this.resolveGateway(e))?e.getStatesCreator(null,[{id:d,device:c,status:a}],function(a,c){a?b&&b(a):b&&b(null,c[0])}):b&&b(Error("gateway json format invalid"))};g.prototype.getUserInfo=
function(d,e){var c=this.resolveGateway(d);c?c.getUserInfo(function(a,b){e&&e(a,b)}):e&&e(Error("gateway json format invalid"))};g.prototype.getModulesInfo=function(d,e){var c=this.resolveGateway(d);c?c.getModulesInfo(function(a,b){e&&e(a,b)}):e&&e(Error("gateway json format invalid"))};g.prototype.getDeviceList=function(d,e,c){e?(d=this.resolveGateway(d))?d.getDeviceList(e,function(a,b){c&&c(a,b)}):c&&c(Error("gateway json format invalid")):c&&c(Error("module name invalid"))};g.prototype.getConnectionState=
function(d,e,c,a){e?c?(d=this.resolveGateway(d))?d.getModuleConnectionInfo(e,c,function(b,c){a&&a(b,c)}):a&&a(Error("gateway json format invalid")):a&&a(Error("connection id invalid")):a&&a(Error("module name invalid"))};g.prototype.disconnect=function(d,e,c,a){e?c?(d=this.resolveGateway(d))?d.disconenct(e,c,function(b){a&&a(b)}):a&&a(Error("gateway json format invalid")):a&&a(Error("connection id invalid")):a&&a(Error("module name invalid"))};return g}();
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.cloudservice.Handler);
