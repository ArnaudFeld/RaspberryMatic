var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.cloudservice=xnm.aio.cloudservice||{};
xnm.aio.cloudservice.CloudService=function(){var f=function(a){this._cloudservice=a};f.prototype.getRules=function(a){this._cloudservice._doJsonRequest("GET","/rules",null,null,a)};f.prototype.addRule=function(a,d){a?this._cloudservice._doJsonRequest("POST","/rules",null,a,d):d&&d(Error("rule is null"))};f.prototype.updateRule=function(a,d,b){a?d?this._cloudservice._doJsonRequest("POST","/rules/"+a,null,d,b):b&&b(Error("rule is null")):b&&b(Error("rule id is null"))};f.prototype.deleteRule=function(a,
d){a?this._cloudservice._doJsonRequest("POST","/rules/"+a,null,{},d):d&&d(Error("rule id is null"))};f.prototype.deleteRules=function(a,d){this._cloudservice._doJsonRequest("DELETE","/rules",a,null,d)};var c=function(a){this._cloudservice=a;this._version="v1"};c.prototype.disconenct=function(a,d,b){a?d?this._cloudservice._doJsonRequest("GET","/eapi/"+this._version+"/"+a+"/disconnect",{id:d},null,function(a,d){b&&b(a,d)}):b&&b(Error("invalid connection id")):b&&b(Error("invalid module"))};c.prototype.getModuleConnectionInfo=
function(a,d,b){this._cloudservice._doJsonRequest("GET","/eapi/"+this._version+"/"+a+"/info/"+d,null,null,function(a,d){b(a,d)})};c.prototype.getModuleInfo=function(a,d){this._cloudservice._doJsonRequest("GET","/eapi/"+this._version+"/"+a+"/info",null,null,function(a,b){d(a,b)})};c.prototype.getModuleDevices=function(a,d){this._cloudservice._doJsonRequest("GET","/eapi/"+this._version+"/"+a+"/devices",null,null,function(a,b){d(a,b)})};c.prototype.getModuleStates=function(a,d){this._cloudservice._doJsonRequest("GET",
"/eapi/"+this._version+"/"+a+"/states",null,null,function(a,b){d(a,b)})};c.prototype.executeModuleCommand=function(a,d,b){this._cloudservice._doJsonRequest("POST","/eapi/"+this._version+"/"+a+"/command",null,d,function(a,d){b(a,d)})};var e=function(a){this._cloudservice=a;this._version="v1"};e.prototype.getUserInfo=function(a){this._cloudservice._doJsonRequest("GET","/service/userInfo",null,null,function(d,b){a(d,b)})};e.prototype.getModulesInfo=function(a){this._cloudservice._doJsonRequest("GET",
"/service/moduleInfo",null,null,function(d,b){a(d,b)})};e.prototype.toCloudDevice=function(a,d){this._cloudservice._doJsonRequest("POST","/service/toCloudDevice",null,a,function(a,b){d(a,b)})};var b=function(a,b,g,q){this._logger=require("x.logger.js").getLogger("xnm.aio.cloudservice.CloudService");this._ip=a;this._ip||(this._ip="cloud.mediola.com");this._port=b;this._port||(this._port=443);this._username=g;this._password=q;this._protocol="https";this._eapi=new c(this);this._ruleEngine=new f(this);
this._service=new e(this)};b.prototype.getIP=function(){return this._ip};b.prototype.getPort=function(){return this._port};b.prototype.getUsername=function(){return this._password};b.prototype.getUserInfo=function(a){this._service.getUserInfo(a)};b.prototype.getModulesInfo=function(a){this._service.getModulesInfo(a)};b.prototype.toCloudDevice=function(a,b){this._service.toCloudDevice(a,b)};b.prototype.disconenct=function(a,b,c){this._eapi.disconenct(a,b,c)};b.prototype.getModuleConnectionInfo=function(a,
b,c){this._eapi.getModuleConnectionInfo(a,b,c)};b.prototype.getModuleInfo=function(a,b){this._eapi.getModuleInfo(a,b)};b.prototype.getModuleDevices=function(a,b){this._eapi.getModuleDevices(a,b)};b.prototype.getModuleStates=function(a,b){this._eapi.getModuleStates(a,b)};b.prototype.executeModuleCommand=function(a,b,c){this._eapi.executeModuleCommand(a,b,c)};b.prototype.getRules=function(a){this._ruleEngine.getRules(a)};b.prototype.addRule=function(a,b){this._ruleEngine.addRule(a,b)};b.prototype.updateRule=
function(a,b,c){this._ruleEngine.updateRule(a,b,c)};b.prototype.deleteRule=function(a,b){this._ruleEngine.updateRule(a,b)};b.prototype.deleteRules=function(a,b){this._ruleEngine.deleteRules(a,b)};b.prototype.getAccessToken=function(a,b,c){a={sid:a};b&&(a.force=1);this._doJsonRequest("GET","/getAccessToken",a,null,function(a,b){a?c&&c(a):b?c&&c(null,b.at):c&&c(Error("invalid response"))})};b.prototype.executeCommandCreator=function(a,b,c){if(a&&a.module&&a.connection&&a.id)if(b&&b.value){var d={connection:a.connection,
device:a.id,command:b.value};"undefined"!=typeof b.ext&&null!=b.ext&&(d.value=b.ext);this.executeModuleCommand(a.module,d,function(a){c&&c(a)})}else c&&c(Error("command json invalid"));else c&&c(Error("device json invalid"))};b.prototype.getStatesCreator=function(a,b,c){var d=this;a=function(a,b){d.getModuleStates(a,function(c,d){b(c,d,a)})};var e=[],f;for(f=0;f<b.length;f++){var g=b[f];g&&g.device&&g.device.module&&-1==e.indexOf(g.device.module)&&e.push(g.device.module)}if(0==e.length)c&&c(null,
[]);else{var l=0,m=[];for(f=0;f<e.length;f++)a(e[f],function(a,d,f){l++;var g=[];if(!a&&d)for(var r=0;r<b.length;r++){var h=b[r];if(h&&h.id&&h.device&&h.device.module==f){var n=null;if(h.device&&h.device.connection&&h.device.id&&h.status&&h.status.value){var k=d[h.device.connection];k&&k[h.device.id]&&(k=k[h.device.id].states)&&(n=k[h.status.value])}if("undefined"==typeof n||null==n)n="?";m.push({id:h.id,status:n});g.push({id:h.id,status:n})}}"undefined"!=typeof commandhandler&&null!=commandhandler&&
"undefined"!=typeof commandhandler.reportStates&&null!=commandhandler.reportStates&&!a&&g&&0<g.length&&commandhandler.reportStates(null,g);l==e.length&&c&&c(null,m)})}};b.prototype.getDeviceList=function(a,b){this.getModuleDevices(a,function(c,d){if(c)b(c);else{c=[];if(d)for(var e in d){var f=d[e],g;for(g in f){var l=f[g];l&&(l.sys="cloudservice",l.module=a,l.connection=e,l.id=g,c.push(l))}}b(null,c)}})};b.prototype._doJsonRequest=function(a,b,c,e,f){var d=null;e&&(d=JSON.stringify(e));this._doRequest(a,
b,c,d,function(a,b){a?f&&f(a):b?b.XC_ERR?(a=Error("error response:"+b.XC_ERR.msg),a.code=b.XC_ERR.code,f&&f(a)):b.XC_SUC?f&&f(null,b.XC_SUC):f&&f(Error("unknown response")):f&&f(Error("invalid response"))})};b.prototype._doRequest=function(a,b,c,e,f){b||(b="/");var d={};c&&(d=JSON.parse(JSON.stringify(c)));c="";for(var g in d)d.hasOwnProperty(g)&&(c&&(c+="&"),c+=g+"="+encodeURIComponent(d[g]));c&&(b+="?"+c);a={host:this._ip,port:this._port,path:b,method:a,headers:{Connection:"close","Content-Type":"application/json;  charset=UTF-8"}};
if(this._username||this._password)a.auth=(this._username?this._username:"")+":"+(this._password?this._password:""),a.headers.Authorization="Basic "+(new Buffer((this._username?this._username:"")+":"+(this._password?this._password:""))).toString("base64");g=require(this._protocol);"https"==this._protocol&&"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");c=JSON.parse(JSON.stringify(a));c.headers&&(c.headers.auth&&(c.headers.auth="*********"),c.headers.Authorization&&
(c.headers.Authorization="*********"));c.auth&&(c.auth="********");this._logger.log("trace","do request:"+JSON.stringify(c));var l=this,m=f,k=g.request(a,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){l._logger.log("trace","receive code:"+a.statusCode+" headers:"+JSON.stringify(a.headers)+" response:"+b);if(200==a.statusCode)try{var c=b?JSON.parse(b):null}catch(t){var d=t}else d=Error("http reponse:"+a.statusCode);m&&(m(d,c,a.statusCode),m=null)})});
if(k.on)k.on("error",function(a){l._logger.log("trace","do request error:"+a.message);m&&(m(a),m=null)});k.setTimeout&&k.setTimeout(2E4,function(){l._logger.log("trace","do request timeout");k.abort();m&&(m(Error("timeout")),m=null)});e&&(this._logger.log("trace","do request send body:"+e),k.write(e));k.end()};b.prototype.toJSON=function(){return{sys:"cloudservice",username:this._username,password:this._password,ip:this._ip,port:this._port}};b.prototype.equalsTo=function(a){return a&&a instanceof
b?this._ip==a._ip&&this._port==a._port&&this._username==a._username&&this._password==a._password:!1};b.parseJSON=function(a){return a&&a.username&&a.password?new b(a.ip,a.port,a.username,a.password):null};return b}();
xnm.aio.cloudservice.DM=function(){var f=function(c,e){this.code=c;this.message=e;this.stack=Error().stack};f.prototype=Error();f.prototype.name="cloudserviceDMError";f.prototype.code=0;f.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"cloudservice",getGatewayType:function(){return[{sys:this.SYS,name:"Cloud Service"}]},createGateway:function(c,e,b){e=f.ERROR_CODE;c?c.username?c.password?b(null,c):b(new f(e.INVALID,"password is invalid")):b(new f(e.INVALID,
"username is invalid")):b(new f(e.INVALID,"info is invalid"))},updateGateway:function(c,e,b,a){c=f.ERROR_CODE;e?e.username?e.password?a(null,e):a(new f(c.INVALID,"password is invalid")):a(new f(c.INVALID,"username is invalid")):a(new f(c.INVALID,"update is invalid"))},deleteGateway:function(c,e,b){b()},createDevice:function(c,e,b){var a=f.ERROR_CODE;if(c)if(c.connection)if(c.id)if(c.gateway){e=e.data.gateways;var d;for(d=0;d<e.length;d++)if(e[d].index===c.gateway){var g=e[d];break}g?b&&b(null,c):
b(new f(a.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else b(new f(a.INVALID,"gateway is invalid"));else b(new f(a.INVALID,"id is invalid"));else b(new f(a.INVALID,"connection is invalid"));else b(new f(a.INVALID,"info is invalid"))},updateDevice:function(c,e,b){var a=f.ERROR_CODE;if(c)if(c.connection)if(c.id)if(c.gateway){e=e.data.gateways;var d;for(d=0;d<e.length;d++)if(e[d].index===c.gateway){var g=e[d];break}g?b(null,c):b(new f(a.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else b(new f(a.INVALID,
"gateway is invalid"));else b(new f(a.INVALID,"id is invalid"));else b(new f(a.INVALID,"connection is invalid"));else b(new f(a.INVALID,"info is invalid"))},deleteDevice:function(c,e,b){b()},applyUIFilter:function(c,e,b){var a=this,d=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},f=function(a,b,c){var e=[];"command"==c.catagory?a.command&&a.command.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))}):"status"==c.catagory?
a.status&&a.status.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))}):"ipevt"==c.catagory&&a.status&&a.ipevt.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});return e},q=function(c,d){var e=[],g=a.getCommandStatusMap(c,b);g&&(c=f(g,c,d),e=e.concat(c));return e};if(!c.sys)return null;var n=JSON.parse(JSON.stringify(c)),p=null;if("command"==e.catagory)p=q(c,e),n.command=p;else if("status"==e.catagory)p=q(c,e),n.status=p;else if("ipevt"==
e.catagory)p=q(c,e),n.ipevt=p;else return null;return p&&0!=p.length?n:null},applyIPEventFilter:function(c){return c?this.applyUIFilter(c,{catagory:"ipevt",elems:"*"}):null},getCommandStatusMap:function(c,e){if(!c)return null;e={command:[],status:[]};var b;if(c.commands)for(b in e.command=[],c.commands){var a=c.commands[b];if(a.values)e.command.push({type:"enum",name:b,ref:{value:b,ext:"%e",extMeta:a.values}});else if(a.value){switch(a.value.type){case "FLOAT":var d={type:"float",name:b,ref:{value:b,
ext:"%f"}};break;case "RGB":d={type:"rgb",name:b,ref:{value:b,ext:"%rgb"}};break;case "RGBW":d={type:"rgbw",name:b,ref:{value:b,ext:"%rgbw"}};break;default:d={type:"int",name:b,ref:{value:b,ext:"%d"}}}void 0!=a.value.min&&null!=a.value.min&&void 0!=a.value.max&&null!=a.value.max&&d&&(d.ref.extMeta=a.value.min+"-"+a.value.max);void 0!=a.value.step&&null!=a.value.step&&d&&(d.ref.scale=a.value.step);d&&e.command.push(d)}else e.command.push({type:"enum",name:b,ref:{value:b}})}if(c.states)for(b in e.status=
[],e.ipevt=[],c.states)if(a=c.states[b],a.values)0!=a.state&&e.status.push({type:"enum",name:b,ref:{value:b,options:a.values}}),0!=a.event&&e.ipevt.push({type:"enum",name:b,ref:{value:b,options:a.values}});else{switch(a.type){case "BOOL":d={type:"enum",name:b,ref:{value:b,options:["true","false"]}};break;case "FLOAT":d={type:"float",name:b,ref:{value:b}};break;case "RGB":d={type:"rgb",name:b,ref:{value:b}};break;case "RGBW":d={type:"rgbw",name:b,ref:{value:b}};break;case "STRING":d={type:"string",
name:b,ref:{value:b}};break;case "TIME":d={type:"int",name:b,ref:{value:b}};break;default:d={type:"int",name:b,ref:{value:b}}}void 0!=a.min&&null!=a.min&&void 0!=a.max&&null!=a.max&&d&&(d.ref.extMeta=a.min+"-"+a.max);void 0!=a.step&&null!=a.step&&d&&(d.ref.scale=a.step);d&&(0!=a.state&&e.status.push(d),0!=a.event&&e.ipevt.push(d))}return e}}}();
xnm.aio.cloudservice.Handler=function(){var f=function(){};f.prototype.devicemanager=xnm.aio.cloudservice.DM;f.prototype.CloudService=xnm.aio.cloudservice.CloudService;f.prototype.registModule=function(c){c.register("cloudservice","cloudservice")};f.prototype.resolveGateway=function(c){return c?this.CloudService.parseJSON(c):null};f.prototype.getDeviceCommands=function(c,e){c=(c=this.devicemanager.applyUIFilter(c,{catagory:"command",elems:"*"}))?c.command:[];e&&e(null,c)};f.prototype.getDeviceStatus=
function(c,e){c=(c=this.devicemanager.applyUIFilter(c,{catagory:"status",elems:"*"}))?c.status:[];e&&e(null,c)};f.prototype.doCommand=function(c,e,b,a){(c=this.resolveGateway(c))?c.executeCommandCreator(e,b,function(b){a&&a(b)}):a&&a(Error("gateway json format invalid"))};f.prototype.doStatus=function(c,e,b,a,d){(e=this.resolveGateway(e))?e.getStatesCreator(null,[{id:c,device:b,status:a}],function(a,b){a?d&&d(a):d&&d(null,b[0])}):d&&d(Error("gateway json format invalid"))};f.prototype.getUserInfo=
function(c,e){(c=this.resolveGateway(c))?c.getUserInfo(function(b,a){e&&e(b,a)}):e&&e(Error("gateway json format invalid"))};f.prototype.getModulesInfo=function(c,e){(c=this.resolveGateway(c))?c.getModulesInfo(function(b,a){e&&e(b,a)}):e&&e(Error("gateway json format invalid"))};f.prototype.getDeviceList=function(c,e,b){e?(c=this.resolveGateway(c))?c.getDeviceList(e,function(a,c){b&&b(a,c)}):b&&b(Error("gateway json format invalid")):b&&b(Error("module name invalid"))};f.prototype.getConnectionState=
function(c,e,b,a){e?b?(c=this.resolveGateway(c))?c.getModuleConnectionInfo(e,b,function(b,c){a&&a(b,c)}):a&&a(Error("gateway json format invalid")):a&&a(Error("connection id invalid")):a&&a(Error("module name invalid"))};f.prototype.disconnect=function(c,e,b,a){e?b?(c=this.resolveGateway(c))?c.disconenct(e,b,function(b){a&&a(b)}):a&&a(Error("gateway json format invalid")):a&&a(Error("connection id invalid")):a&&a(Error("module name invalid"))};return f}();
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.cloudservice.Handler);
