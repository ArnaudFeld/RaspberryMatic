var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.brennenstuhl=xnm.aio.brennenstuhl||{};xnm.aio.brennenstuhl.WebLine=function(e,b,a,c){this.ip=e;this.port=80;b&&(this.port=b);this.user="admin";a&&(this.user=a);this.password="admin";c&&(this.password=c);this.CommandHandler=null};
xnm.aio.brennenstuhl.WebLine.prototype._doRequest=function(e,b,a){var c={host:this.ip,port:this.port,path:e,method:"GET",headers:{Connection:"close"}};a&&(c.headers.Authorization=a);var f=this,g=require("http").request(c,function(c){if(200==c.statusCode){c.setEncoding("utf-8");var g="";c.on("data",function(a){g+=a});c.on("end",function(){b&&b(g)})}else if(401!=c.statusCode||a)b&&b(null);else if(a=null,c.headers["www-authenticate"]&&"Digest "==c.headers["www-authenticate"].substr(0,7)){var k={};c=
c.headers["www-authenticate"].substr(7).replace(/\'/g,"").replace(/\"/g,"").split(",");for(var m=0;m<c.length;m++){var n=c[m].split("=");2==n.length&&(k[n[0]]=n[1])}k.nonce&&(a="Digest ",a+='username="'+f.user+'", ',a+='realm="'+k.realm+'", ',a+='nonce="'+k.nonce+'", ',a+='uri="'+e+'", ',c=require("x.crypt.js"),m=c.MD5(f.user+":"+k.realm+":"+f.password),n=c.MD5("GET:"+e),a+='response="'+c.MD5(m+":"+k.nonce+":1::auth:"+n)+'", ',a+='opaque="'+k.opaque+'", ',a+="qop="+k.qop+", ",a+="nc=1, ",a+='cnonce=""');
a?f._doRequest(e,b,a):b&&b(null)}});g.setTimeout(5E3,function(){g.abort()});g.on("error",function(a){b&&b(null)});g.end()};
xnm.aio.brennenstuhl.WebLine.prototype.executeCommand=function(e,b,a){if("toggle"==b)this._doRequest("/cgi-bin/toggleRel"+e.address+"?id=0",a);else if("on"==b||"off"==b){var c=this;this._doRequest("/power?id=1",function(f){f=c.getStateValues(null,f);"on"==b&&"M"==e.address&&"off"==f.master||"on"==b&&"S"==e.address&&"off"==f.slave||"off"==b&&"M"==e.address&&"on"==f.master||"off"==b&&"S"==e.address&&"on"==f.slave?c._doRequest("/cgi-bin/toggleRel"+e.address+"?id=0",a):a&&a()})}else a&&a()};
xnm.aio.brennenstuhl.WebLine.prototype.getStates=function(e,b,a){var c=this;this.CommandHandler=e;this._doRequest("/power?id=1",function(b){if(b&&c.CommandHandler)if(c.CommandHandler.setState){var e=c.getStateValues(null,b),h;for(h in e)"state"==h?c.CommandHandler.setState(d.id,e[h]):c.CommandHandler.setState(d.id+":"+h,e[h])}else c.CommandHandler.receivedState&&c.CommandHandler.receivedState("webline",c.ip,b);a&&a(c.getStateValues(null,b))})};
xnm.aio.brennenstuhl.WebLine.prototype.getStateValues=function(e,b){var a={state:"?",master:"?",slave:"?"};if(b){var c=b.split("|");5==c.length&&(a.state="off","1"==c[3]?(a.master="on",a.state="on"):a.master="off","1"==c[4]?(a.slave="on",a.state="on"):a.slave="off")}return a};
xnm.aio.brennenstuhl.WebLine.Discovery=function(e){this.Devices={};this.callback=e;this._sockets=[];var b=require("os");e=require("dgram");if(b&&b.networkInterfaces){var a=this,c=e.createSocket("udp4");c.on("listening",function(){c.setBroadcast(!0);var e=b.networkInterfaces(),g;for(g in e)for(var h=e[g],l=0;l<h.length;l++)"IPv4"==h[l].family&&0==h[l].internal&&a._addDiscoverSocket(c.address().port,h[l].address);a.discoverDevices()});c.on("message",function(b,c){a._receivedData(c.address,b)});c.bind(null)}else this._addDiscoverSocket(null),
this.discoverDevices()};xnm.aio.brennenstuhl.WebLine.Discovery.prototype._getMAC=function(e){for(var b="",a=0;5>a;a++)b+=XC.getHexVal(e[a],2).toUpperCase()+"-";return b+=XC.getHexVal(e[a],2).toUpperCase()};xnm.aio.brennenstuhl.WebLine.Discovery.prototype._receivedData=function(e,b){b=b.toString("hex");b=new Buffer(b,"hex");94==b.length&&(this.Devices[e]=new xnm.aio.brennenstuhl.WebLine(e),this.Devices[e].uuid=this._getMAC(b.slice(19,25)),this.callback&&this.callback(this.Devices[e]))};
xnm.aio.brennenstuhl.WebLine.Discovery.prototype._addDiscoverSocket=function(e,b){var a=this,c=require("dgram").createSocket("udp4");c.on("listening",function(){c.setBroadcast(!0)});c.on("message",function(b,c){a._receivedData(c.address,b)});c.bind(e,b);this._sockets.push(c)};xnm.aio.brennenstuhl.WebLine.Discovery.prototype._sendDiscoveryMessages=function(e,b,a,c){e=new Buffer([255,4,2,251]);for(b=0;b<this._sockets.length;b++)this._sockets[b].send(e,0,e.length,23,"255.255.255.255")};
xnm.aio.brennenstuhl.WebLine.Discovery.prototype.discoverDevices=function(){this._sendDiscoveryMessages()};xnm.aio.brennenstuhl.Handler=function(){this._WebLineDiscovery=new xnm.aio.brennenstuhl.WebLine.Discovery;this._WebLineDiscovery.discoverDevices()};xnm.aio.brennenstuhl.Handler.prototype.discoverDevices=function(e){e&&(this._WebLineDiscovery.callback=e);this._WebLineDiscovery.discoverDevices()};xnm.aio.brennenstuhl.Handler.prototype.getStateValues=function(e,b){return(new xnm.aio.brennenstuhl.WebLine).getStateValues(b)};
xnm.aio.brennenstuhl.Handler.prototype.getDeviceCommandList=function(e,b){var a=[];a.push({id:window.XC_Text.on,cmd:"on"});a.push({id:window.XC_Text.off,cmd:"off"});return a};xnm.aio.brennenstuhl.Handler.prototype.getDevice=function(e){for(var b in this._WebLineDiscovery.Devices)if(e.address&&this._WebLineDiscovery.Devices[b].uuid==e.address)return this._WebLineDiscovery.Devices[b];return null};xnm.aio.brennenstuhl.Handler.prototype.WebLine=xnm.aio.brennenstuhl.WebLine;
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.brennenstuhl.Handler);
