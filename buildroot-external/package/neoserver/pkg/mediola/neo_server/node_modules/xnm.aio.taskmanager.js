var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var a=0;return function(b){return $jscomp.SYMBOL_PREFIX+(b||"")+a++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.makeIterator=function(a){$jscomp.initSymbolIterator();var b=a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};$jscomp.arrayFromIterator=function(a){for(var b,c=[];!(b=a.next()).done;)c.push(b.value);return c};$jscomp.arrayFromIterable=function(a){return a instanceof Array?a:$jscomp.arrayFromIterator($jscomp.makeIterator(a))};
$jscomp.polyfill=function(a,b,c,e){if(b){c=$jscomp.global;a=a.split(".");for(e=0;e<a.length-1;e++){var d=a[e];d in c||(c[d]={});c=c[d]}a=a[a.length-1];e=c[a];b=b(e);b!=e&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Object.is",function(a){return a?a:function(a,c){return a===c?0!==a||1/a===1/c:a!==a&&c!==c}},"es6","es3");
$jscomp.polyfill("Array.prototype.includes",function(a){return a?a:function(a,c){var b=this;b instanceof String&&(b=String(b));var d=b.length;for(c=c||0;c<d;c++)if(b[c]==a||Object.is(b[c],a))return!0;return!1}},"es7","es3");
$jscomp.checkStringArgs=function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};$jscomp.polyfill("String.prototype.includes",function(a){return a?a:function(a,c){return-1!==$jscomp.checkStringArgs(this,a,"includes").indexOf(a,c||0)}},"es6","es3");
$jscomp.findInternal=function(a,b,c){a instanceof String&&(a=String(a));for(var e=a.length,d=0;d<e;d++){var h=a[d];if(b.call(c,h,d,a))return{i:d,v:h}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.taskmanager=xnm.aio.taskmanager||{};xnm.aio.taskmanager.Taskmanager=function(){};
xnm.aio.taskmanager.Taskmanager.prototype.setCloudService=function(a){this._cloudService=a;this._cloudTM=new require("xnm.aio.cloudTaskmanager");this._cloudTM.setCloudService(a);this._cloudTM.setCloudAccessUrl(this._cloudAccessUrl);return this};xnm.aio.taskmanager.Taskmanager.prototype.setWebserviceUrl=function(a){this._webServiceUrl=a;return this};
xnm.aio.taskmanager.Taskmanager.prototype.setCloudAccessUrl=function(a){this._cloudAccessUrl=a;this._cloudTM&&this._cloudTM.setCloudAccessUrl(this._cloudAccessUrl);return this};xnm.aio.taskmanager.Taskmanager.prototype.setAuth=function(a){this._auth=a;return this};xnm.aio.taskmanager.Taskmanager.prototype.setSystemData=function(a){xnm.aio.taskmanager.SystemData=a;return this};
xnm.aio.taskmanager.Taskmanager.prototype.runTask=function(a,b){(xnm.aio.taskmanager.isVx(a.aio)?xnm.aio.taskmanager.runVxTask:xnm.aio.taskmanager.runVxProTask)(a,b)};xnm.aio.taskmanager.Taskmanager.prototype.saveTask=function(a,b){xnm.aio.taskmanager.isVx(a.aio)?this.runVxSaving(a,b):this.runVxProSaving(a,b)};
xnm.aio.taskmanager.Taskmanager.prototype.runVxSaving=function(a,b){var c=a.root.if.filter(function(a){return a.cloud}),e=a.root.then[0].then.filter(function(a){return a.cloud});a.root.if=a.root.if.filter(function(a){return!a.cloud});a.root.then[0].then=a.root.then[0].then.filter(function(a){return!a.cloud});var d=[];d=[xnm.aio.taskmanager.addVxLocalCloudActions.bind(this,a,e),xnm.aio.taskmanager.saveVxTask.bind(this,a,d),this.saveVxSnsData.bind(this,a,d)];xnm.aio.taskmanager.hasCloudDevices()&&d.push(this._cloudTM.saveVxCloudData.bind(this._cloudTM,
a,c,e));(new xnm.aio.taskmanager.FunctionStack(d)).start(b)};
xnm.aio.taskmanager.Taskmanager.prototype.runVxProSaving=function(a,b){var c=this,e=a.root.if.filter(function(a){return a.cloud});a.root.if=a.root.if.filter(function(a){return!a.cloud});a.root.then[0].then.filter(function(a){return a.cloud}).forEach(function(a){a.gateway={ip:c._cloudService.getIP(),port:c._cloudService.getPort(),username:c._cloudService._username,password:c._cloudService._password,sys:"cloudservice"}});var d=[this.saveVxProSnsData.bind(this,a),xnm.aio.taskmanager.saveVxProTask.bind(this,
a)];xnm.aio.taskmanager.hasCloudDevices()&&d.push(this._cloudTM.saveVxProCloudData.bind(this._cloudTM,a,e));(new xnm.aio.taskmanager.FunctionStack(d)).start(b)};
xnm.aio.taskmanager.Taskmanager.prototype.deleteTask=function(a,b){var c=xnm.aio.taskmanager.isVx(a.aio)?xnm.aio.taskmanager.deleteVxTask:xnm.aio.taskmanager.deleteVxProTask,e=xnm.aio.taskmanager.isVx(a.aio)?this._cloudTM.deleteVxCloudData:this._cloudTM.deleteVxProCloudData;c=[c.bind(this,a)];xnm.aio.taskmanager.hasCloudDevices()&&c.push(e.bind(this._cloudTM,a));(new xnm.aio.taskmanager.FunctionStack(c)).start(b)};
xnm.aio.taskmanager.Taskmanager.prototype.setTaskActive=function(a,b,c){(xnm.aio.taskmanager.isVx(a.aio)?xnm.aio.taskmanager.setVxTaskActive:xnm.aio.taskmanager.setVxProTaskActive)(a,b,c)};xnm.aio.taskmanager.Taskmanager.prototype.clear=function(a){xnm.aio.taskmanager.isVx(a)&&xnm.aio.taskmanager.getVxTasks(a,function(b,c){b||c.forEach(function(b){return xnm.aio.taskmanager.deleteVxElement(a,b)})})};
xnm.aio.taskmanager.Taskmanager.prototype.getAllTasks=function(a,b){function c(f){return function(c,d){c||!Array.isArray(d)?g=c||Error("Unknown"):(c=e?xnm.aio.taskmanager.mapVxTasksToPro(f,d):d.map(function(a){a.aio=f;return a}),h=h.concat(c));++l===a.length&&b(g,h)}}if(!Array.isArray(a)||!a.length)return b(Error("invalid params"));var e=xnm.aio.taskmanager.isVx(a[0]),d=e?xnm.aio.taskmanager.getVxTasks:xnm.aio.taskmanager.getVxProTasks,h=[],l=0;a.forEach(function(a){return d(a,c(a))});var g=null};
xnm.aio.taskmanager.getGroups=function(a,b){var c=function(a,b){return b.filter(function(b){return b.group&&b.group.includes(a.sid)}).map(function(a){return a.sid})};a._executeRequest("getStates",{config:1},null,function(a,d){if(a)return b(a);if(!Array.isArray(d))return b(null,[]);a=d.filter(function(a){return"SGROUP"==a.type}).map(function(a){a.devices=c(a,d);return a});b(null,a)})};
xnm.aio.taskmanager.Taskmanager.prototype.markGroupActions=function(a,b){xnm.aio.taskmanager.getGroups(a.aio,function(c,e){c&&b(c);var d=e.map(function(a){return a.sid});a.root.then[0].then.forEach(function(a){a.device&&d.includes(a.device.sid)&&(a.group=e.find(function(b){return b.sid==a.device.sid}),a.subtype="group")});b(null,{})})};
xnm.aio.taskmanager.Taskmanager.prototype.fetchDetailData=function(a,b){var c=[this.unifyStructure.bind(this,a),this.addSnsData.bind(this,a)];xnm.aio.taskmanager.hasCloudDevices()&&c.push(this.addVxCloudData.bind(this,a));xnm.aio.taskmanager.isSelve(a.aio)&&c.push(this.markGroupActions.bind(this,a));(new xnm.aio.taskmanager.FunctionStack(c)).start(b)};
xnm.aio.taskmanager.Taskmanager.prototype.unifyStructure=function(a,b){a=a.root;a.if||(a.if=[]);a.then||(a.then=[]);a.then[0]||(a.then[0]={if:[],then:[],type:"condition"});if(!a.then[0].then){var c=a.then;delete a.then;a.then=[{if:[],then:c,type:"condition"}]}b(null,{})};xnm.aio.taskmanager.Taskmanager.prototype.addVxCloudData=function(a,b){return xnm.aio.taskmanager.isVx(a.aio)?this._cloudTM.addVxCloudData(a,b):this._cloudTM.addVxProCloudData(a,b)};
xnm.aio.taskmanager.Taskmanager.prototype.addSnsData=function(a,b){var c=["EMAIL","PUSH","SMS"],e=[],d=function(b,c){$.ajax({method:"GET",url:this._webServiceUrl+(b.isVx?"ai2/m.php":"xhub/sns/getsns"),headers:{Authorization:this._auth},data:b.isVx?{XC_FNC:"getMessage",SID:a.aio._sid,AID:b.id}:{token:b.token},success:function(a){b.isVx?(a=a.replace("{XC_SUC}",""),a=JSON.parse(a||"{}"),b.recipients=a.mail,"PUSH"===a.snsType&&(b.subtype="PUSH")):(b.recipients=a.recipients,b.subject=a.subject);b.message=
a.message;b.snsType=a.snsType;"no such action"===b.message&&(b.failed=!0,b.message="");c(null,a)},error:function(a){b.failed=!0;c(null,{})}})};a.root.then[0].then.forEach(function(a){c.includes(a.subtype)&&e.push(d.bind(this,a))}.bind(this));(new xnm.aio.taskmanager.FunctionStack(e)).start(b)};
xnm.aio.taskmanager.Taskmanager.prototype.saveVxProSnsData=function(a,b){var c=["EMAIL","PUSH","SMS"],e=[],d=function(a,b){var c=a.message;"string"===typeof c&&(c={subject:"",snsType:a.snsType,message:a.message,recipients:a.recipients});$.ajax({method:"POST",url:this._webServiceUrl+"xhub/sns/setsns",contentType:"application/json; charset=utf-8",headers:{Authorization:this._auth},data:JSON.stringify(c),success:function(c){if(c&&c.error)return b(c,null);a.isVx||(a.token=c.token);b(null,c)},error:function(){a.failed=
!0;b(null,{})}})};a.root.then[0].then.forEach(function(a){c.includes(a.subtype)&&e.push(d.bind(this,a))}.bind(this));(new xnm.aio.taskmanager.FunctionStack(e)).start(b)};
xnm.aio.taskmanager.Taskmanager.prototype.saveVxSnsData=function(a,b,c){var e=function(b,c){XC.debugf(b);$.ajax({method:"POST",url:this._webServiceUrl+"ai2/m.php?XC_FNC=setMessage&SID="+a.aio._sid+"&AID="+b.id,contentType:"application/x-www-form-urlencoded",headers:{Authorization:this._auth},data:{data:JSON.stringify({sns:"PUSH"===b.snsType?"PUSH":void 0,email:b.recipients,message:b.message})},success:function(a){if(a&&a.error)return c(a,null);c()},error:function(a){b.failed=!0;c(null,{})}})};b=b.map(function(a){return e.bind(this,
a)}.bind(this));(new xnm.aio.taskmanager.FunctionStack(b)).start(c)};xnm.aio.taskmanager.hasCloudDevices=function(){return 0<xnm.aio.taskmanager.SystemData.getDevices(function(a){return"cloudservice"==a.info.sys}).length};
xnm.aio.taskmanager.mapVxTasksToPro=function(a,b){function c(a,b){try{return e.tasks.find(function(a){return a.id==b}).name}catch(l){return"Task "+b}}var e=xnm.aio.taskmanager.SystemData.getGateways(function(b){return b.info.mac==a._mac})[0];return b.filter(function(a){return"GROUP"==a.sys}).map(function(d){var e={id:d.id,aio:a,root:{},name:c(a,d.id),active:1==d.active,isAlarmTask:"FF"==d.id};0<d.triggerids.length&&(e.root.if=d.triggerids.match(/.{1,2}/g).map(function(a){var c={},f=b.find(function(b){return["EVENT",
"SEVENT","TASK","ASTRO"].includes(b.sys)&&b.id==a});if(!f)return null;switch(f.sys){case "EVENT":c="IRCODE"===f.type?{type:"ir",ir:{code:f.code}}:{type:"device.status",device:{type:f.type,address:f.code},status:f.code};break;case "SEVENT":c={type:"device.status",proEvent:!0,device:{sid:f.device},status:f.condition.state,value:f.condition.value,op:f.condition.type};break;case "TASK":c={op:"=",type:"timer",time:f.time,week:f.days,start:f.dateEnd,end:f.dateStart};break;case "ASTRO":c=parseInt(f.delay,
16),0<(c&32768)&&(c-=65536),c={type:"astro",astro:1==f.time?"sunrise":"sunset",delay:c,week:f.days,start:f.dateStart,end:f.dateEnd}}c.id=f.id;c.active=f.active;return c}).filter(function(a){return null!=a}));e.root.then=[{if:[],then:[]}];d.conditionids&&0<d.conditionids.length&&(e.root.then[0].if=d.conditionids.match(/.{1,2}/g).map(function(a){var c={},f=b.find(function(b){return["TIME"].includes(b.sys)&&b.id==a});if(!f)return null;switch(f.sys){case "TIME":c={type:"timer",op:"00:00"===f.start?"<=":
">=",time:"00:00"===f.start?f.end:f.start,week:f.days}}c.id=f.id;c.active=f.active;return c}).filter(function(a){return null!=a}));0<d.actionids.length&&(e.root.then[0].then=d.actionids.match(/.{1,2}/g).map(function(a){var c={},f=b.find(function(b){return["ACTION","DEVICEACTION"].includes(b.sys)&&b.id==a});if(!f)return null;switch(f.sys){case "DEVICEACTION":c={type:"action",subtype:"command",proEvent:!0,device:{sid:f.device},command:{ref:{ext:f.value,value:f.cmd}},gateway:null};break;case "ACTION":c=
"CLOUD"===f.type?{type:"CLOUD",internal:!0}:"AIO"===f.type?{type:"action",subtype:"EMAIL",isVx:!0}:{type:"action",subtype:"command",device:{type:f.type,address:f.code},command:{ref:{value:f.code}},gateway:null}}c.id=f.id;return c}).filter(function(a){return null!=a}));return e})};
xnm.aio.taskmanager.mapProTaskToVx=function(a){var b=this,c="",e="",d="",h=a.root.if.filter(function(a){return!a.internal}).map(function(a){var c={};d+=a.id;switch(a.type){case "device.status":c=a.device.proDevice?{sys:"SEVENT",device:a.device.sid,condition:{type:a.op,state:a.status,value:a.value}}:{sys:"EVENT",type:a.device.type,code:a.code};break;case "timer":c={sys:"TASK",days:a.week,time:a.time,dateStart:"2000-00-00",dateEnd:"2099-00-00"};break;case "ir":c={sys:"EVENT",type:"IRCODE",code:a.ir.code};
break;case "astro":c=a.delay,0>c&&(c+=65536),c=b.intToStrHex(c,4),c={sys:"ASTRO",active:1,days:a.week,time:"sunrise"===a.astro?1:2,dateStart:a.start,dateEnd:a.end,delay:c,t:"00:00"}}c.id=a.id;c.active="1";return c}),l=a.root.then[0].if.filter(function(a){return!a.internal}).map(function(a){var b={};e+=a.id;switch(a.type){case "timer":b={sys:"TIME",days:a.week,start:"<="===a.op?"00:00":a.time,end:">="===a.op?"00:00":a.time,dateStart:"2000-00-00",dateEnd:"2099-00-00"}}b.id=a.id;b.active="1";return b}),
g=a.root.then[0].then.map(function(a){var b={};c+=a.id;switch(a.type){case "CLOUD":b={type:"CLOUD",sys:"ACTION"};break;case "action":"EMAIL"===a.subtype||"PUSH"===a.subtype?(b={code:"",type:"AIO",sys:"ACTION",snsType:a.subtype},"string"===typeof a.message?(b.message=a.message,b.recipients=a.recipients):(b.message=a.message.message,b.recipients=a.message.recipients)):b=a.device.proDevice?{sys:"DEVICEACTION",cmd:a.command.ref.value,value:a.command.ref.ext,device:a.device.sid}:{sys:"ACTION",type:a.sys,
code:a.command.ref.value}}b.ir="00";b.rf="00";b.id=a.id;return b}.bind(this));return{group:{id:a.id,sys:"GROUP",actionids:c,conditionids:e,triggerids:d,active:a.active?"1":"0"},actions:g,triggers:h,conditions:l}};xnm.aio.taskmanager.getVxIdList=function(a,b){return a.filter(function(a){return b.includes(a.sys)}).map(function(a){return a.id})};
xnm.aio.taskmanager.getNextVxElementId=function(a){if(!a.length)return xnm.aio.taskmanager.intToStrHex(1);for(var b=1;255>b;b++){var c=xnm.aio.taskmanager.intToStrHex(b);if(!a.includes(c))return c}return null};xnm.aio.taskmanager.runVxTask=function(a,b){a.aio._executeRequest("doGroup",{id:a.id},null,b)};xnm.aio.taskmanager.runVxProTask=function(a,b){xnm.aio.taskmanager._callVxPro(a.aio,"doTask",{id:a.id},b)};
xnm.aio.taskmanager.getVxTasks=function(a,b){a._executeRequest("GetAll",null,null,function(a,e){b(a,e)})};xnm.aio.taskmanager.getVxProTasks=function(a,b){xnm.aio.taskmanager._callVxPro(a,"GetTask",null,b)};xnm.aio.taskmanager.setVxTaskActive=function(a,b,c){a.aio._executeRequest("SaveGroup",{id:a.id,active:b?1:0},null,c)};xnm.aio.taskmanager.setVxProTaskActive=function(a,b,c){xnm.aio.taskmanager._callVxPro(a.aio,"SetTaskActive",{id:a.id,active:b},c)};
xnm.aio.taskmanager.saveVxTask=function(a,b,c){function e(a,b,c){XC.debugf("# del elements: "+a);var d=0,e=p[a],t=k[a];if(0===e.length)return c();e.forEach(function(k){var g=f.filter(function(a){return a.id==k&&t.includes(a.sys)})[0];if(!g)return c(Error(a+" not found"));xnm.aio.taskmanager.deleteVxElement(l,g,function(a,f){if(a)return c(a);m[b].splice(m[b].indexOf(g.id),1);++d===e.length&&c()})})}function d(c,d,e){XC.debugf("# add elements: "+c);var f=g[c];if(!f||!f.length)return e();var k=0;f.forEach(function(g){g.id=
xnm.aio.taskmanager.getNextVxElementId(m[d]);n[c]+=g.id;m[d].push(g.id);xnm.aio.taskmanager.addVxElement(l,g,function(c,d){if(c)return XC.debugf(c),e(Error("add element failed"));"ACTION"===g.sys&&"AIO"===g.type&&b.push(g);"ACTION"===g.sys&&"CLOUD"===g.type&&(a._localCloudId=g.id);++k===f.length&&e()})}.bind(this))}function h(b){XC.debugf("# del all");if(!a.id)return b();a.aio._executeRequest("DelGroup",{id:a.id,options:"all"},null,b)}var l=a.aio,g=xnm.aio.taskmanager.mapProTaskToVx(a),f=null,k={groups:["GROUP"],
actions:["ACTION","DEVICEACTION"],conditions:["TIME"],triggers:["TASK","ASTRO","EVENT","SEVENT"]},n={actions:"",triggers:"",conditions:""},m={groups:[],actions:[],triggers:[]},p={actions:[],triggers:[],conditions:[]},q=["e7"].includes(a.aio._hwv.toLowerCase())?[h.bind(this)]:[e.bind(this,"triggers","triggers"),e.bind(this,"conditions","triggers"),e.bind(this,"actions","actions")];q=[].concat([function(b){function c(a){return a&&a.match(/.{1,2}/g)||[]}XC.debugf("# init");xnm.aio.taskmanager.getVxTasks(l,
function(d,e){if(d)return b(d);f=e;if(a.id){d=e.filter(function(b){return"GROUP"===b.sys&&b.id==a.id})[0];if(!d)return b(Error("group not found"));p.actions=c(d.actionids);p.conditions=c(d.conditionids);p.triggers=c(d.triggerids)}m.groups=xnm.aio.taskmanager.getVxIdList(e,k.groups);m.actions=xnm.aio.taskmanager.getVxIdList(e,k.actions).concat(xnm.aio.taskmanager.getVxIdList(e,k.conditions));m.triggers=xnm.aio.taskmanager.getVxIdList(e,k.triggers);b()})}],$jscomp.arrayFromIterable(q),[d.bind(this,
"triggers","triggers"),d.bind(this,"conditions","triggers"),d.bind(this,"actions","actions"),function(b){var c=g.group;c.actionids=n.actions;c.triggerids=n.triggers;c.conditionids=n.conditions;c.id||(c.id=xnm.aio.taskmanager.getNextVxElementId(m.groups));a.id=c.id;var d=xnm.aio.taskmanager.SystemData,e=d.getGateways(function(b){return b.info.mac==a.aio._mac})[0];e.tasks||(e.tasks=[]);var f=e.tasks.find(function(b){return b.id==a.id});f?f.name=a.name:e.tasks.push({id:a.id,name:a.name});d.saveGateway(e);
a.alarmPin&&(c.pin=a.alarmPin);l._executeRequest("AddGroup",c,null,function(c,d){if(c)return a.isAlarmTask?b({msg:"pin error"}):b(Error("save group failed"));b()})}]);try{(new xnm.aio.taskmanager.FunctionStack(q)).start(c)}catch(r){XC.debugf(r)}};xnm.aio.taskmanager.saveVxProTask=function(a,b){var c={data:a};a.alarmPin&&(c.pin=a.alarmPin);xnm.aio.taskmanager._callVxPro(a.aio,a.id?"UpdateTask":"CreateTask",c,function(c,d){if(c)return b(c,d);d&&d.id&&(a.id=d.id);b(null,d)})};
xnm.aio.taskmanager.addVxLocalCloudActions=function(a,b,c){var e=a.root.then[0].then;b.some(function(a){return a.cloud})?e.some(function(a){return"CLOUD"===a.type})||e.push({type:"CLOUD",sys:"ACTION"}):a.root.then[0].then=e.filter(function(a){return"CLOUD"!==a.type});c()};
xnm.aio.taskmanager.deleteVxTask=function(a,b){function c(b,c,k){XC.debugf("# del elements: "+b);var f=0,g=h[b],l=d[b];if(0===g.length)return k();g.forEach(function(b){var c=e.filter(function(a){return a.id==b&&l.includes(a.sys)})[0];if(!c)return k();xnm.aio.taskmanager.deleteVxElement(a.aio,c,function(a,b){if(a)return k(a);++f===g.length&&k()})})}(function(a){var b=xnm.aio.taskmanager.SystemData,c=b.getGateways(function(b){return b.info.mac==a.aio._mac})[0];if(c.tasks){for(var d=c.tasks.length;d--;)c.tasks[d].id==
a.id&&c.tasks.splice(d,1);b.saveGateway(c)}})(a);if(["e7"].includes(a.aio._hwv.toLowerCase()))return a.aio._executeRequest("DelGroup",{id:a.id,options:"all"},null,b);var e=null,d={groups:["GROUP"],actions:["ACTION","DEVICEACTION"],conditions:["TIME"],triggers:["TASK","ASTRO","EVENT","SEVENT"]},h={actions:[],triggers:[],conditions:[]},l=[function(b){function c(a){return a&&a.match(/.{1,2}/g)||[]}XC.debugf("# init");xnm.aio.taskmanager.getVxTasks(a.aio,function(d,f){if(d)return b(d);e=f;if(a.id){d=
f.filter(function(b){return"GROUP"===b.sys&&b.id==a.id})[0];if(!d)return b(Error("group not found"));h.actions=c(d.actionids);h.conditions=c(d.conditionids);h.triggers=c(d.triggerids)}b()})},c.bind(this,"triggers","triggers"),c.bind(this,"conditions","triggers"),c.bind(this,"actions","actions"),function(b){a.aio._executeRequest("DelGroup",{id:a.id},null,b)}];(new xnm.aio.taskmanager.FunctionStack(l)).start(b)};
xnm.aio.taskmanager.deleteVxProTask=function(a,b){xnm.aio.taskmanager._callVxPro(a.aio,"DeleteTask",{id:a.id},b)};xnm.aio.taskmanager.addVxElement=function(a,b,c){var e={},d={SEVENT:"SensorEvent",DEVICEACTION:"DeviceAction"};d[b.sys]?(d="Add"+d[b.sys],e.method="POST"):d="Add"+b.sys.charAt(0).toUpperCase()+b.sys.toLowerCase().slice(1);a._executeRequest(d,b,e,c)};
xnm.aio.taskmanager.deleteVxElement=function(a,b,c){var e={SEVENT:"SensorEvent"};e=e[b.sys]?"Del"+e[b.sys]:"Del"+b.sys.charAt(0).toUpperCase()+b.sys.toLowerCase().slice(1);a._executeRequest(e,{id:b.id},null,c)};xnm.aio.taskmanager._callVxPro=function(a,b,c,e){(c=JSON.parse(JSON.stringify(c)))||(c={});c.XC_FNC=b;c.at=a._at;c.data&&delete c.data.aio;a.executeRequestV5Plus(c,function(a){if(e){if(!a)return e("error",a);if(a.error)return e(a.error,a);e(null,a.data)}})};
xnm.aio.taskmanager.isVx=function(a){return"EA"!==a._hwv};xnm.aio.taskmanager.isSelve=function(a){return"E7"===a._hwv};xnm.aio.taskmanager.intToStrHex=function(a,b){b||(b=2);for(a=a.toString(16);a.length<b;)a="0"+a;return a.toUpperCase()};xnm.aio.taskmanager.FunctionStack=function(a){this._stack=a;this._onNext=function(a,c){if(a)return this._callback(a);var b=this._stack.shift();b?b(this._onNext.bind(this)):this._callback(a,c)};this.start=function(a){this._callback=a;this._onNext()}};
xnm.aio.taskmanager.Handler=xnm.aio.taskmanager.Taskmanager;"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.taskmanager.Handler);
