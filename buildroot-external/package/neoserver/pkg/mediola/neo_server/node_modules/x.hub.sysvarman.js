var x=x||{};x.hub=x.hub||{};x.hub.sysvarman=x.hub.sysvarman||{};require("x.logger.js").setLevel("debug","x.hub.sysvarman");
x.hub.sysvarman.SysvarManager=function(){var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.sysvarman.SysvarManager");this._sysvarFile=null;this._sysvars={}};d.FILE_NAME="sysvar.json";d.prototype.init=function(a,c){this._logger.log("debug","init sysvar mananger");var b=require("fs-extra"),e=require("path");this._sysvarFile||(this._sysvarFile=e.resolve(a.getUserRootDataPath(),d.FILE_NAME));var k=this;b.ensureFile(this._sysvarFile,function(b){b?c&&c(b):k._readData(function(b,a){!b&&
a&&(k._sysvars=a);c&&c(b)})})};d.prototype.setVar=function(a,c){this._logger.log("trace","setVar:"+(a?JSON.stringify(a):null));if(a&&a.id&&a.type){var b=parseInt(a.id,16);if(0>=b)c&&c(Error("sysvar out of range"));else{b=b.toString(16).toUpperCase();2>b.length&&(b="0"+b);var b={id:b,type:a.type,value:a.value},e=this._sysvars[b.id],d;switch(b.type){case "ONOFF":b.value||(b.value="OFF");b.value=b.value.toUpperCase();if("ON"!=b.value&&"OFF"!=b.value&&"TOGGLE"!=b.value){c&&c(Error("ONOFF sysvar value invalid"));
return}if("TOGGLE"==b.value)if(e){if(e.type!=b.type){c&&c(Error("sysvar is not a ONOFF type"));return}b.value="ON"==e.value?"OFF":"ON"}else b.value="OFF";break;case "FLOAT":case "INT":b.value||(b.value="00000000");d=parseInt(b.value,16);if(isNaN(d)){c&&c(Error("FLOAT/INT sysvar value invalid"));return}break;case "STRING":b.value||(b.value=""),b.value=decodeURIComponent(b.value+"")}b.time=(new Date).getTime();this._sysvars[b.id]=b;d=require("x.hub.eventbus.js");e&&e.value==b.value||d.emit("gatewayevent",
this.getSysvarStateLegacy(b.id),{address:"Sysvar"},"STA");d.emit("udpevent",this.getSysvarStateLegacy(b.id),"STA");this._writeData(function(b){c&&c(b)})}}else c&&c(Error("sysvar format invalid"))};d.prototype.delVar=function(a,c){a&&this._sysvars[a]?(delete this._sysvars[a],this._writeData(function(b){c&&c(b)})):c&&c()};d.prototype.getVar=function(a){return a?this._sysvars[a]:null};d.prototype.getSysvars=function(){return this._sysvars};d.prototype.getSysvarStateLegacy=function(a){if(!a||!this._sysvars[a])return null;
a=this._sysvars[a];return{type:a.type,adr:a.id,state:a.value}};d.prototype.getSysvarStatesLegacy=function(){var a=[],c;for(c in this._sysvars)if(this._sysvars.hasOwnProperty(c)){var b=this.getSysvarStateLegacy(c);b&&a.push(b)}return a};d.prototype._readData=function(a){require("fs").readFile(this._sysvarFile,"utf8",function(c,b){if(c)a&&a(c);else if(b)try{var d=JSON.parse(b);a&&a(null,d?d:{})}catch(k){a&&a(k)}else a&&a(null,{})})};d.prototype._writeData=function(a){require("fs").writeFile(this._sysvarFile,
JSON.stringify(this._sysvars,null,2),function(c){a&&a(c)})};return d}();
x.hub.sysvarman.Handler=function(){var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.sysvarman.Handler");this.sysvarManager=new x.hub.sysvarman.SysvarManager};d.prototype.SysvarManager=x.hub.sysvarman.SysvarManager;d.prototype.init=function(a,c,b){this.sysvarManager.init(c,function(a){b&&b({error:a})})};d.prototype.setVar=function(a,c){this.sysvarManager.setVar(a,function(b){c&&c({error:b})})};d.prototype.delVar=function(a,c){this.sysvarManager.delVar(a,function(b){c&&c({error:b})})};
d.prototype.getSysvarStates=function(a){var c=this.sysvarManager.getSysvarStatesLegacy();this._logger.log("trace","getSysvarStates:"+JSON.stringify(c));a&&a({data:c})};d.prototype.processSysvarST=function(a,c,b){var d=this;d._logger.log("trace","process st sysvars:"+JSON.stringify(c));for(var k=function(b,a,c){if(b&&a&&0!=a.length){var d=0,f=function(e){d++;e?c&&c(e):d==a.length?c&&c():p(b,a[d],f)};p(b,a[d],f)}else c&&c()},p=function(b,a,c){if(b&&a&&a.id){d._logger.log("trace","delete st sysvar "+
JSON.stringify(a));var g=c;c="/cmd?XC_FNC=delVar&id="+a.id;var f=setTimeout(function(){console.log("delete st sysvar "+a.id+" timeout");g&&g(Error("st timeout"));g=null},1E4);b._doSTMCommandRequest(c,!1,function(b){f&&(clearTimeout(f),f=null);d._logger.log("trace","delete st sysvar "+a.id+" return",b);g&&g();g=null})}else c&&c()},l=[],m=[],q=[],n=0;n<c.length;n++){var h=c[n];if(h)switch(h.type){case "ONOFF":case "FLOAT":case "INT":case "STRING":var r={id:h.adr,type:h.type,value:h.state};l.push(r);
this.sysvarManager.getVar(h.adr)||m.push(r);break;default:q.push(h)}}d._logger.log("trace","find st sysvars:"+JSON.stringify(l));d._logger.log("trace","find new sysvars:"+JSON.stringify(m));(function(b,a){if(b&&0!=b.length){var c=0,g=function(f){d._logger.log("trace","add new sysvar "+JSON.stringify(b[c])+":"+f);c++;f?a&&a(f):c==b.length?a&&a():d.sysvarManager.setVar(b[c],g)};d.sysvarManager.setVar(b[c],g)}else a&&a()})(m,function(c){c?b&&b({error:c}):(k(a,l),d.getSysvarStates(function(a){a&&a.error||
(a.data||(a.data=[]),a.data=a.data.concat(q));b&&b(a)}))})};return d}();module.exports=new x.hub.sysvarman.Handler;
