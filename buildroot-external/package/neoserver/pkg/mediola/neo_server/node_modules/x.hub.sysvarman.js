var x=x||{};x.hub=x.hub||{};x.hub.sysvarman=x.hub.sysvarman||{};require("x.logger.js").setLevel("debug","x.hub.sysvarman");
x.hub.sysvarman.SysvarManager=function(){var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.sysvarman.SysvarManager");this._sysvarFile=null;this._sysvars={}};d.FILE_NAME="sysvar.json";d.prototype.init=function(a,b){this._logger.log("debug","init sysvar mananger");var c=require("fs-extra"),e=require("path");this._sysvarFile||(this._sysvarFile=e.resolve(a.getUserRootDataPath(),d.FILE_NAME));var h=this;c.ensureFile(this._sysvarFile,function(a){a?b&&b(a):h._readData(function(a,c){!a&&
c&&(h._sysvars=c);b&&b(a)})})};d.prototype.setVar=function(a,b){this._logger.log("trace","setVar:"+(a?JSON.stringify(a):null));if(a&&a.id&&a.type){var c=parseInt(a.id,16);if(0>=c)b&&b(Error("sysvar out of range"));else{c=c.toString(16).toUpperCase();2>c.length&&(c="0"+c);a={id:c,type:a.type,value:a.value};c=this._sysvars[a.id];switch(a.type){case "ONOFF":a.value||(a.value="OFF");a.value=a.value.toUpperCase();if("ON"!=a.value&&"OFF"!=a.value&&"TOGGLE"!=a.value){b&&b(Error("ONOFF sysvar value invalid"));
return}if("TOGGLE"==a.value)if(c){if(c.type!=a.type){b&&b(Error("sysvar is not a ONOFF type"));return}a.value="ON"==c.value?"OFF":"ON"}else a.value="OFF";break;case "FLOAT":case "INT":a.value||(a.value="00000000");var e=parseInt(a.value,16);if(isNaN(e)){b&&b(Error("FLOAT/INT sysvar value invalid"));return}break;case "STRING":a.value||(a.value=""),a.value=decodeURIComponent(a.value+"")}a.time=(new Date).getTime();this._sysvars[a.id]=a;e=require("x.hub.eventbus.js");c&&c.value==a.value||e.emit("gatewayevent",
this.getSysvarStateLegacy(a.id),{address:"Sysvar"},"STA");e.emit("udpevent",this.getSysvarStateLegacy(a.id),"STA");this._writeData(function(a){b&&b(a)})}}else b&&b(Error("sysvar format invalid"))};d.prototype.delVar=function(a,b){a&&this._sysvars[a]?(delete this._sysvars[a],this._writeData(function(a){b&&b(a)})):b&&b()};d.prototype.getVar=function(a){return a?this._sysvars[a]:null};d.prototype.getSysvars=function(){return this._sysvars};d.prototype.getSysvarStateLegacy=function(a){if(!a||!this._sysvars[a])return null;
a=this._sysvars[a];return{type:a.type,adr:a.id,state:a.value}};d.prototype.getSysvarStatesLegacy=function(){var a=[],b;for(b in this._sysvars)if(this._sysvars.hasOwnProperty(b)){var c=this.getSysvarStateLegacy(b);c&&a.push(c)}return a};d.prototype._readData=function(a){require("fs").readFile(this._sysvarFile,"utf8",function(b,c){if(b)a&&a(b);else if(c)try{var e=JSON.parse(c);a&&a(null,e?e:{})}catch(h){a&&a(h)}else a&&a(null,{})})};d.prototype._writeData=function(a){require("fs").writeFile(this._sysvarFile,
JSON.stringify(this._sysvars,null,2),function(b){a&&a(b)})};return d}();
x.hub.sysvarman.Handler=function(){var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.sysvarman.Handler");this.sysvarManager=new x.hub.sysvarman.SysvarManager};d.prototype.SysvarManager=x.hub.sysvarman.SysvarManager;d.prototype.init=function(a,b,c){this.sysvarManager.init(b,function(a){c&&c({error:a})})};d.prototype.setVar=function(a,b){this.sysvarManager.setVar(a,function(a){b&&b({error:a})})};d.prototype.delVar=function(a,b){this.sysvarManager.delVar(a,function(a){b&&b({error:a})})};
d.prototype.getSysvarStates=function(a){var b=this.sysvarManager.getSysvarStatesLegacy();this._logger.log("trace","getSysvarStates:"+JSON.stringify(b));a&&a({data:b})};d.prototype.processSysvarST=function(a,b,c){var d=this;d._logger.log("trace","process st sysvars:"+JSON.stringify(b));for(var h=function(a,b,c){if(a&&b&&0!=b.length){var d=0,f=function(k){d++;k?c&&c(k):d==b.length?c&&c():p(a,b[d],f)};p(a,b[d],f)}else c&&c()},p=function(a,b,c){if(a&&b&&b.id){d._logger.log("trace","delete st sysvar "+
JSON.stringify(b));var f=c;c="/cmd?XC_FNC=delVar&id="+b.id;var k=setTimeout(function(){console.log("delete st sysvar "+b.id+" timeout");f&&f(Error("st timeout"));f=null},1E4);a._doSTMCommandRequest(c,!1,function(a){k&&(clearTimeout(k),k=null);d._logger.log("trace","delete st sysvar "+b.id+" return",a);f&&f();f=null})}else c&&c()},l=[],m=[],q=[],n=0;n<b.length;n++){var g=b[n];if(g)switch(g.type){case "ONOFF":case "FLOAT":case "INT":case "STRING":var r={id:g.adr,type:g.type,value:g.state};l.push(r);
this.sysvarManager.getVar(g.adr)||m.push(r);break;default:q.push(g)}}d._logger.log("trace","find st sysvars:"+JSON.stringify(l));d._logger.log("trace","find new sysvars:"+JSON.stringify(m));(function(a,b){if(a&&0!=a.length){var c=0,f=function(e){d._logger.log("trace","add new sysvar "+JSON.stringify(a[c])+":"+e);c++;e?b&&b(e):c==a.length?b&&b():d.sysvarManager.setVar(a[c],f)};d.sysvarManager.setVar(a[c],f)}else b&&b()})(m,function(b){b?c&&c({error:b}):(h(a,l),d.getSysvarStates(function(a){a&&a.error||
(a.data||(a.data=[]),a.data=a.data.concat(q));c&&c(a)}))})};return d}();module.exports=new x.hub.sysvarman.Handler;
