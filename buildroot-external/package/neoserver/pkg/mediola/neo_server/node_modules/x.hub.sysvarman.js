var x=x||{};x.hub=x.hub||{};x.hub.sysvarman=x.hub.sysvarman||{};
x.hub.sysvarman.SysvarManager=function(){var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.sysvarman.SysvarManager");this._sysvarFile=null;this._sysvars={};this._writing=!1;this._writeQueue=0};d.FILE_NAME="sysvar.json";d.prototype.init=function(a,b){this._logger.log("info","init sysvar mananger");var c=require("fs-extra"),r=require("path");this._sysvarFile||(this._sysvarFile=r.resolve(a.getUserRootDataPath(),d.FILE_NAME));var h=this;c.ensureFile(this._sysvarFile,function(a){a?
b&&b(a):h._readData(function(a,c){!a&&c&&(h._sysvars=c);b&&b(a)})})};d.prototype.setVar=function(a,b){this._logger.log("trace","setVar:"+(a?JSON.stringify(a):null));if(a&&a.id&&a.type)if(-1==["ONOFF","FLOAT","INT","STRING"].indexOf(a.type))b&&b(Error("invalid sysvar type"));else{var c=parseInt(a.id,16);if(0>=c)b&&b(Error("sysvar out of range"));else{c=c.toString(16).toUpperCase();2>c.length&&(c="0"+c);a={id:c,type:a.type,value:a.value};c=this._sysvars[a.id];switch(a.type){case "ONOFF":a.value||(a.value=
"OFF");a.value=a.value.toUpperCase();if("ON"!=a.value&&"OFF"!=a.value&&"TOGGLE"!=a.value){b&&b(Error("ONOFF sysvar value invalid"));return}if("TOGGLE"==a.value)if(c){if(c.type!=a.type){b&&b(Error("sysvar is not a ONOFF type"));return}a.value="ON"==c.value?"OFF":"ON"}else a.value="OFF";break;case "FLOAT":case "INT":a.value||(a.value="00000000");var d=parseInt(a.value,16);if(isNaN(d)){b&&b(Error("FLOAT/INT sysvar value invalid"));return}break;case "STRING":a.value||(a.value=""),a.value=decodeURIComponent(a.value+
"")}a.time=(new Date).getTime();this._sysvars[a.id]=a;d=require("x.hub.eventbus.js");c&&c.value==a.value||d.emit("gatewayevent",this.getSysvarStateLegacy(a.id),{address:"Sysvar"},"STA");d.emit("udpevent",this.getSysvarStateLegacy(a.id),"STA");this._postWrite(function(a){b&&b(a)})}}else b&&b(Error("sysvar format invalid"))};d.prototype.delVar=function(a,b){a&&this._sysvars[a]?(delete this._sysvars[a],this._postWrite(function(a){b&&b(a)})):b&&b()};d.prototype.getVar=function(a){return a?this._sysvars[a]:
null};d.prototype.getSysvars=function(){return this._sysvars};d.prototype.getSysvarStateLegacy=function(a){if(!a||!this._sysvars[a])return null;a=this._sysvars[a];return{type:a.type,adr:a.id,state:a.value}};d.prototype.getSysvarStatesLegacy=function(){var a=[],b;for(b in this._sysvars)if(this._sysvars.hasOwnProperty(b)){var c=this.getSysvarStateLegacy(b);c&&a.push(c)}return a};d.prototype._readData=function(a){require("fs").readFile(this._sysvarFile,"utf8",function(b,c){if(b)a&&a(b);else if(c)try{var d=
JSON.parse(c);a&&a(null,d?d:{})}catch(h){a&&a(h)}else a&&a(null,{})})};d.prototype._postWrite=function(a){this._writeQueue++;this._writing||this._doWrite();a&&a()};d.prototype._doWrite=function(){if(0<this._writeQueue){var a=this;this._writeQueue=0;this._writing=!0;this._writeData(function(b){b&&a._logger.log("warn","write file failed:"+b.message);a._writing=!1;a._doWrite()})}};d.prototype._writeData=function(a){require("fs").writeFile(this._sysvarFile,JSON.stringify(this._sysvars,null,2),function(b){a&&
a(b)})};return d}();
x.hub.sysvarman.Handler=function(){var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.sysvarman.Handler");this.sysvarManager=new x.hub.sysvarman.SysvarManager};d.prototype.SysvarManager=x.hub.sysvarman.SysvarManager;d.prototype.init=function(a,b,c){this.sysvarManager.init(b,function(a){c&&c({error:a})})};d.prototype.setVar=function(a,b){this.sysvarManager.setVar(a,function(a){b&&b({error:a})})};d.prototype.delVar=function(a,b){this.sysvarManager.delVar(a,function(a){b&&b({error:a})})};
d.prototype.getSysvarStates=function(a){var b=this.sysvarManager.getSysvarStatesLegacy();this._logger.log("trace","getSysvarStates:"+JSON.stringify(b));a&&a({data:b})};d.prototype.processSysvarST=function(a,b,c){var d=this;d._logger.log("trace","process st sysvars:"+JSON.stringify(b));for(var h=function(a,b,d){if(a&&b&&0!=b.length){var c=0,e=function(f){c++;f?d&&d(f):c==b.length?d&&d():n(a,b[c],e)};n(a,b[c],e)}else d&&d()},n=function(a,b,c){if(a&&b&&b.id){d._logger.log("trace","delete st sysvar "+
JSON.stringify(b));var e=c;c="/cmd?XC_FNC=delVar&id="+b.id;var f=setTimeout(function(){console.log("delete st sysvar "+b.id+" timeout");e&&e(Error("st timeout"));e=null},1E4);a._doSTMCommandRequest(c,!1,function(a){f&&(clearTimeout(f),f=null);d._logger.log("trace","delete st sysvar "+b.id+" return",a);e&&e();e=null})}else c&&c()},k=[],l=[],p=[],m=0;m<b.length;m++){var g=b[m];if(g)switch(g.type){case "ONOFF":case "FLOAT":case "INT":case "STRING":var q={id:g.adr,type:g.type,value:g.state};k.push(q);
this.sysvarManager.getVar(g.adr)||l.push(q);break;default:p.push(g)}}d._logger.log("trace","find st sysvars:"+JSON.stringify(k));d._logger.log("trace","find new sysvars:"+JSON.stringify(l));(function(a,b){if(a&&0!=a.length){var c=0,e=function(f){d._logger.log("trace","add new sysvar "+JSON.stringify(a[c])+":"+f);c++;f?b&&b(f):c==a.length?b&&b():d.sysvarManager.setVar(a[c],e)};d.sysvarManager.setVar(a[c],e)}else b&&b()})(l,function(b){b?c&&c({error:b}):(h(a,k),d.getSysvarStates(function(a){a&&a.error||
(a.data||(a.data=[]),a.data=a.data.concat(p));c&&c(a)}))})};return d}();module.exports=new x.hub.sysvarman.Handler;
