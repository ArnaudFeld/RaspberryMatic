var x=x||{};x.hub=x.hub||{},x.hub.sysvarman=x.hub.sysvarman||{},x.hub.sysvarman.SysvarManager=function(){var SM=function SM(){this._logger=require("x.logger.js").getLogger("x.hub.sysvarman.SysvarManager"),this._sysvarFile=null,this._sysvars={},this._writing=!1,this._writeQueue=0;};return SM.FILE_NAME="sysvar.json",SM.prototype.init=function(e,t){this._logger.log("info","init sysvar mananger");var r=require("fs-extra"),s=require("path");this._sysvarFile||(this._sysvarFile=s.resolve(e.getUserRootDataPath(),SM.FILE_NAME));var a=this;r.ensureFile(this._sysvarFile,function(e){e?t&&t(e):a._readData(function(e,r){!e&&r&&(a._sysvars=r),t&&t(e);});});},SM.prototype.setVar=function(e,t){if(this._logger.log("trace","setVar:"+(e?JSON.stringify(e):null)),e&&e.id&&e.type){if(-1!=["ONOFF","FLOAT","INT","STRING"].indexOf(e.type)){var r=parseInt(e.id,16);if(r<=0)t&&t(new Error("sysvar out of range"));else{var s=r.toString(16).toUpperCase();s.length<2&&(s="0"+s);var a,i={id:s,type:e.type,value:e.value},n=this._sysvars[i.id];switch(i.type){case"ONOFF":if(i.value||(i.value="OFF"),i.value=i.value.toUpperCase(),"ON"!=i.value&&"OFF"!=i.value&&"TOGGLE"!=i.value)return void(t&&t(new Error("ONOFF sysvar value invalid")));if("TOGGLE"==i.value)if(n){if(n.type!=i.type)return void(t&&t(new Error("sysvar is not a ONOFF type")));i.value="ON"==n.value?"OFF":"ON";}else i.value="OFF";break;case"FLOAT":case"INT":if(i.value||(i.value="00000000"),a=parseInt(i.value,16),isNaN(a))return void(t&&t(new Error("FLOAT/INT sysvar value invalid")));break;case"STRING":i.value||(i.value=""),i.value=decodeURIComponent(i.value+"");}i.time=new Date().getTime(),this._sysvars[i.id]=i;var o=require("x.hub.eventbus.js");n&&n.value==i.value||o.emit("gatewayevent",this.getSysvarStateLegacy(i.id),{address:"Sysvar"},"STA"),o.emit("udpevent",this.getSysvarStateLegacy(i.id),"STA"),this._postWrite(function(e){t&&t(e);});}}else t&&t(new Error("invalid sysvar type"));}else t&&t(new Error("sysvar format invalid"));},SM.prototype.delVar=function(e,t){if(e&&this._sysvars[e])return delete this._sysvars[e],void this._postWrite(function(e){t&&t(e);});t&&t();},SM.prototype.getVar=function(e){return e?this._sysvars[e]:null;},SM.prototype.getSysvars=function(){return this._sysvars;},SM.prototype.getSysvarStateLegacy=function(e){if(!e||!this._sysvars[e])return null;var t=this._sysvars[e];return{type:t.type,adr:t.id,state:t.value};},SM.prototype.getSysvarStatesLegacy=function(){var e=[];for(var t in this._sysvars){if(this._sysvars.hasOwnProperty(t)){var r=this.getSysvarStateLegacy(t);r&&e.push(r);}}return e;},SM.prototype._readData=function(e){require("fs").readFile(this._sysvarFile,"utf8",function(t,r){if(t)e&&e(t);else if(r)try{var s=JSON.parse(r);e&&e(null,s||{});}catch(t){e&&e(t);}else e&&e(null,{});});},SM.prototype._postWrite=function(e){this._writeQueue++,this._writing||this._doWrite(),e&&e();},SM.prototype._doWrite=function(){if(this._writeQueue>0){var e=this;this._writeQueue=0,this._writing=!0,this._writeData(function(t){t&&e._logger.log("warn","write file failed:"+t.message),e._writing=!1,e._doWrite();});}},SM.prototype._writeData=function(e){require("fs").writeFile(this._sysvarFile,JSON.stringify(this._sysvars,null,2),function(t){e&&e(t);});},SM;}(),x.hub.sysvarman.Handler=function(){var Handler=function Handler(){this._logger=require("x.logger.js").getLogger("x.hub.sysvarman.Handler"),this.sysvarManager=new x.hub.sysvarman.SysvarManager();};return Handler.prototype.SysvarManager=x.hub.sysvarman.SysvarManager,Handler.prototype.init=function(e,t,r){this.sysvarManager.init(t,function(e){r&&r({error:e});});},Handler.prototype.setVar=function(e,t){this.sysvarManager.setVar(e,function(e){t&&t({error:e});});},Handler.prototype.delVar=function(e,t){this.sysvarManager.delVar(e,function(e){t&&t({error:e});});},Handler.prototype.getSysvarStates=function(e){var t=this.sysvarManager.getSysvarStatesLegacy();this._logger.log("trace","getSysvarStates:"+JSON.stringify(t)),e&&e({data:t});},Handler.prototype.processSysvarST=function(e,t,r){var s=this;s._logger.log("trace","process st sysvars:"+JSON.stringify(t));for(var _deleteStSysvar=function _deleteStSysvar(e,t,r){if(e&&t&&t.id){s._logger.log("trace","delete st sysvar "+JSON.stringify(t));var a=r,i="/cmd?XC_FNC=delVar&id="+t.id,n=setTimeout(function(){console.log("delete st sysvar "+t.id+" timeout"),a&&a(new Error("st timeout")),a=null;},1e4);e._doSTMCommandRequest(i,!1,function(e){n&&(clearTimeout(n),n=null),s._logger.log("trace","delete st sysvar "+t.id+" return",e),a&&a(),a=null;});}else r&&r();},a=[],i=[],n=[],o=0;o<t.length;o++){var u=t[o];if(u)switch(u.type){case"ONOFF":case"FLOAT":case"INT":case"STRING":var v={id:u.adr,type:u.type,value:u.state};a.push(v);var l=u.adr;this.sysvarManager.getVar(l)||i.push(v);break;default:n.push(u);}}s._logger.log("trace","find st sysvars:"+JSON.stringify(a)),s._logger.log("trace","find new sysvars:"+JSON.stringify(i)),function(e,t){if(e&&0!=e.length){var r=0,cb=function cb(a){s._logger.log("trace","add new sysvar "+JSON.stringify(e[r])+":"+a),r++,a?t&&t(a):r!=e.length?s.sysvarManager.setVar(e[r],cb):t&&t();};s.sysvarManager.setVar(e[r],cb);}else t&&t();}(i,function(t){t?r&&r({error:t}):(!function(e,t,r){if(e&&t&&0!=t.length){var s=0,cb=function cb(a){s++,a?r&&r(a):s!=t.length?_deleteStSysvar(e,t[s],cb):r&&r();};_deleteStSysvar(e,t[s],cb);}else r&&r();}(e,a),s.getSysvarStates(function(e){e&&e.error||(e.data||(e.data=[]),e.data=e.data.concat(n)),r&&r(e);}));});},Handler;}(),module.exports=new x.hub.sysvarman.Handler();