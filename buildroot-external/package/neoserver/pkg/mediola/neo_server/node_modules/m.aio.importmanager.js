var m=m||{};m.aio=m.aio||{},m.aio.importmanager=m.aio.importmanager||{},m.aio.importmanager.Manager=function(){var e=function e(_e){this._appname=_e,this._appname||(this._appname="iqontrolpro");};return e.prototype.setAppName=function(e){this._appname=e;},e.prototype.importSteckerPRO=function(e,r,n,t){var o=function o(e,r){for(var n=0;n<e.length;n++)if(e[n]===r)return!0;return!1;},a=require("m.aio.configmanager.js"),i=a.LicenseManager;a.trace("/config/tenants/"+e,function(a,s){if(a)t&&t(a);else if(s&&s.license){var c;if(i.permitFeature("read",{sys:"hcgw",ip:"127.0.0.1",vendor:"brennenstuhl"},s.license))c="brennenstuhl";else if(i.permitFeature("read",{sys:"hcgw",ip:"127.0.0.1",vendor:"intertechno"},s.license))c="intertechno";else{if(!i.permitFeature("read",{sys:"hcgw",ip:"127.0.0.1",vendor:"hc"},s.license))return void(t&&t(new Error("license do not have hcgw module")));c="hc";}var l=function(e,r){var n={rooms:[],devices:[],gateways:[]};try{var t,o,a=$($.parseXML(r)),i=a.find("gateway");if(i&&i.length>0)for(t=0;t<i.length;t++){var s=i[t];if(s){var c=$(s).find("transmitter");if(c&&c.length>0&&c[0]){var l=$(c[0]),u=l.attr("ip"),p=l.attr("mode");if(u&&p){p=parseInt(p);var d={index:n.gateways.length+1,name:("hc"==e?"HC":e)+" Gateway",info:{sys:"hcgw",ip:u,port:49880,vendor:e,mode:1==p?1:0}};n.gateways.push(d);}}}}if(0==n.gateways.length){var f={index:n.gateways.length+1,name:("hc"==e?"HC":e)+" Gateway",info:{sys:"hcgw",ip:"0.0.0.0",port:49880,vendor:e,mode:1}};n.gateways.push(f);}var m=a.find("location");if(m&&m.length>0)for(t=0;t<m.length;t++){var h=m[t];if(h){var g=$(h);if(o=g.attr("id")){var v={index:n.rooms.length+1,name:o};n.rooms.push(v);var y=g.find("device");if(y&&y.length>0)for(var w=0;w<y.length;w++){var E=y[w];if(E){var C=$(E);o=C.attr("id");var _=C.attr("type"),q=C.attr("address"),R=C.attr("data");if(o&&_&&q&&R){var I,S;switch(_){case"BS":I="brennenstuhl",S="RC 3600","heater"==R&&(S="FHT 433");break;case"ELRO":I="brennenstuhl",S="RCS 1000N";break;case"DY":I="rohrmotor24",S="RMF Motor";break;case"DY2":I="rohrmotor24",S="RMF-RS1 (AP/UP)";break;case"IT":I="intertechno",q.length>=9?(S="IT-1500 ","shutter"==R?S="ITL-1000":"dimmer"==R&&(S="ITLR-300")):(S="CMR-300","shutter"==R&&(S="CMR-500"));}var x={index:n.devices.length+1,name:o,room:v.index,info:{sys:"hcgw",gateway:1,data:R,type:"IT"==_&&q.length>=9?"IT2":_,manufacture:I,model:S,address:q}};n.devices.push(x);}}}}}}}catch(e){console.error(e);}return n;}(c,r),u=[];l&&l.rooms&&l.rooms.forEach(function(e){e&&e.name&&u.push(e.name);});var p=function(e,r){var n={groups:[]};try{var t,a=$($.parseXML(e)).find("location");if(a&&a.length>0)for(t=0;t<a.length;t++){var i=a[t];if(i){var s=$(i),c=s.attr("id");if(c&&o(r,c)){var l={classid:"group",index:n.groups.length+1,name:c,macros:[]};n.groups.push(l);var u=s.find("macro");if(u&&u.length>0)for(var p=0;p<u.length;p++){var d=u[p];if(d){var f=$(d),m=f.attr("id");if(m){var h={classid:"macro",index:l.macros.length+1,name:m,commands:[]};l.macros.push(h);var g=f.find("command");if(g&&g.length>0)for(var v=0;v<g.length;v++){var y=g[v];if(y){var w,E=$(y),C=E.attr("action"),_=E.attr("sleep");if(C){var q=C.split(".");3==q.length&&(w={classid:"command",index:h.commands.length+1,action:{type:"command",device:{name:q[1],room:q[0]},value:q[2]}},h.commands.push(w));}else _&&(w={classid:"sleep",index:h.commands.length+1,time:parseInt(_)},h.commands.push(w));}}}}}}}}}catch(e){console.error(e);}return n;}(n,u),d=require("m.aio.devicemanager.js"),f=require("m.aio.macromanager.js"),m=d.getIntHandler(e);if(m){var h=f._getHandler(e);h?(m.data=l,m._save(function(e){e?t&&t(e):(h.macros=f.Macros.parse(p),h._saveMacros(function(e){t&&t(e);}));})):t&&t(new Error("no such tenant for macros"));}else t&&t(new Error("no such tenant"));}else t&&t("invalid tenant");});},e.prototype.getConfigList_Eltako=function(e,r,n,t){e+="/listData";var o=require("url").parse(e),a={host:o.hostname,port:o.port||443,path:o.path+"?path=files/iqn/config",auth:r+":"+n},i=require("https").request(a,function(e){e.setEncoding("utf8");var r="";e.on("data",function(e){r+=e;}),e.on("end",function(){if(200!==e.statusCode)t(new Error("HTTP response code: "+e.statusCode));else if(r)try{var _e2=null,_n=JSON.parse(r);_n.XC_SUC?_n=_n.XC_SUC:_n.XC_ERR&&(_e2=new Error(r)),_e2||Array.isArray(_n)||(_e2=new Error("Response did not contain an array.")),t(_e2,_n);}catch(e){t(e);}else t(new Error("No data received for parsing."));t=null;});});i.on("timeout",function(){t&&(t(new Error("Timeout")),t=null);}),i.on("error",function(e){t&&(t(e),t=null);}),i.end();},e.prototype.getConfigList_IQP=function(e,r,n,t){e+="/iqconfig/getconfigs";var o=require("url").parse(e),a=o.protocol;"http:"==a&&(a="http"),"https:"==a&&(a="https"),a||(a="https");var i=o.port;i||(i=443);var s={host:o.hostname,port:i,path:o.path+"?app="+this._appname,auth:r+":"+n},c=require(a).request(s,function(e){e.setEncoding("utf8");var r="";e.on("data",function(e){r+=e;}),e.on("end",function(){if(200==e.statusCode)try{var n=[];r&&(n=JSON.parse(r)),t&&(t(null,n),t=null);}catch(e){t&&(t(new Error("invalid json reponse")),t=null);}else t&&(t(new Error("http reponse code:"+e.statusCode)),t=null);});});c.on("timeout",function(){t&&(t(new Error("http timeout")),t=null);}),c.on("error",function(e){t&&(t(e),t=null);}),c.end();},e.prototype.downloadConfig_Eltako=function(e,r,n,t,o,a){var _this=this;e+="/getFileURL";var i=require("url").parse(e),s={host:i.hostname,port:i.port||443,path:i.path+"?path=files/iqn/config/"+encodeURIComponent(t),auth:r+":"+n},c=require("https").request(s,function(e){e.setEncoding("utf8");var r="";e.on("data",function(e){r+=e;}),e.on("end",function(){if(200!==e.statusCode)a&&a(new Error("HTTP response code: "+e.statusCode)),a=null;else if(r)try{var _e3=null,_n2=JSON.parse(r);_n2.XC_SUC?_n2=_n2.XC_SUC:_n2.XC_ERR&&(_e3=new Error(r)),_n2&&_n2.url||(_e3=new Error("Result did not contain a URL to download the content from.")),_e3?(a&&a(_e3,_n2),a=null):_this._getContentFromURL(_n2.url,function(e,r){if(e)return a&&a(e),void(a=null);_this._parseConfig_Eltako(r,o,function(e,r){a&&a(e,r),a=null;});});}catch(e){a&&a(e),a=null;}else a&&a(new Error("No data received for parsing.")),a=null;});});c.on("timeout",function(){a&&(a(new Error("Timeout")),a=null);}),c.on("error",function(e){a&&(a(e),a=null);}),c.end();},e.prototype._getContentFromURL=function(e,r){var n=require("https").get(e,function(e){e.setEncoding("utf8");var n="";e.on("data",function(e){n+=e;}),e.on("end",function(){r&&(200!==e.statusCode?r(new Error("HTTP response code: "+e.statusCode)):n?r(null,n):r(new Error("No data received.")),r=null);});});n.on("timeout",function(){r&&(r(new Error("Timeout")),r=null);}),n.on("error",function(e){r&&(r(e),r=null);});},e.prototype._parseConfig_Eltako=function(e,r,n){if(!e)return void n(new Error("No content to parse."));var t=require("x.crypt.js"),o=function o(e){var n=t.AES.decodeString(e,r);if(!n)throw new Error("Decryption failed.");return JSON.parse(n);},a=["devices","macros"],i={},s=new(require("url").URLSearchParams)(e),c=Array.from(s.keys());for(var _r=0;_r<c.length;_r++){var _t=c[_r];var l=s.get(_t);if(l=String(l).replace(/\n/g,""),l&&a.includes(_t))try{l=o(l);}catch(e){return void n(e);}i[_t]=l;}n(null,i);},e.prototype.downloadConfig_IQP=function(e,r,n,t,o){e+="/iqconfig/getdevices";var a=require("url").parse(e),i=a.protocol;"http:"==i&&(i="http"),"https:"==i&&(i="https"),i||(i="https");var s=a.port;s||(s=443);var c={host:a.hostname,port:s,path:a.path+"?app="+this._appname+"&name="+encodeURIComponent(t),auth:r+":"+n},l=require(i).request(c,function(e){e.setEncoding("utf8");var r="";e.on("data",function(e){r+=e;}),e.on("end",function(){200==e.statusCode?o&&(o(null,r),o=null):o&&(o(new Error("http reponse code:"+e.statusCode)),o=null);});});l.on("timeout",function(){o&&(o(new Error("http timeout")),o=null);}),l.on("error",function(e){o&&(o(e),o=null);}),l.end();},e.prototype.decryptConfig_IQP=function(e,r,n){var t=require("x.crypt.js").AES.decodeString(e,r);if("string"==typeof t&&t.length>0){var o=null;try{o=JSON.parse(t),n&&n(null,o);}catch(e){n&&n(new Error("invalid config json"));}}else n&&n(new Error("decryption failed"));},e.prototype.importConfig_IQP=function(e,r,n,t,o){var a=require("m.aio.configmanager.js");a.LicenseManager,a.trace("/config/tenants/"+e,function(a,i){if(a)o&&o(a);else if(i&&i.license){var s=r;r.system&&(s=r.system);var c=require("m.aio.devicemanager.js"),l=c.getIntHandler(e);if(l){var u=-1,p=[];if(s.rooms)for(var d=0;d<s.rooms.length;d++){var f=s.rooms[d];if(f){if("_cameras_288c9304ed854ca5f41185e88b240621"==f.name){u=f.index;break;}p.push(f.index);}}else s.rooms=[];if(-1==u){for(u=1;-1!=p.indexOf(u);)u++;s.rooms.push({name:"_cameras_288c9304ed854ca5f41185e88b240621",index:u});}if(s.devices)for(var m=0;m<s.devices.length;m++){var h=s.devices[m];h&&h.info&&("cloudservice"==h.info.sys&&"ivideon"==h.info.module&&"camera"==h.info.type||"cam"==h.info.sys)&&(h.room=u);}else s.devices=[];if(s.gateways)for(var g=0;g<s.gateways.length;g++){var v=s.gateways[g];v&&v.info&&("cloudservice"==v.info.sys&&(v.info.ip||(v.info.ip="cloud.mediola.com"),v.info.port||(v.info.port=443),v.info.username||v.info.password||(v.info.username=n,v.info.password=t)),"aio"==v.info.sys&&"gtw"==v.info.common_type&&(s.gateways.splice(g,1),g--));}else s.gateways=[];l.data=s,l._save(function(e){e?o&&o(e):c.reloadTenant(i,function(e){o&&o(e);});});}else o&&o(new Error("no such tenant"));}else o&&o("invalid tenant");});},e.prototype.downloadMacros_IQP=function(e,r,n,t,o){e+="/iqconfig/getmacros";var a=require("url").parse(e),i=a.protocol;"http:"==i&&(i="http"),"https:"==i&&(i="https"),i||(i="https");var s=a.port;s||(s=443);var c={host:a.hostname,port:s,path:a.path+"?app="+this._appname+"&name="+encodeURIComponent(t),auth:r+":"+n},l=require(i).request(c,function(e){e.setEncoding("utf8");var r="";e.on("data",function(e){r+=e;}),e.on("end",function(){200==e.statusCode?o&&(o(null,r),o=null):o&&(o(new Error("http reponse code:"+e.statusCode)),o=null);});});l.on("timeout",function(){o&&(o(new Error("http timeout")),o=null);}),l.on("error",function(e){o&&(o(e),o=null);}),l.end();},e.prototype.decryptMacros_IQP=function(e,r,n){var t=require("x.crypt.js").AES.decodeString(e,r);if(t.length>0&&"string"==typeof t){var o=null;try{o=JSON.parse(t),n&&n(null,o);}catch(e){n&&n(new Error("invalid macros json"));}}else n&&n(new Error("decryption failed"));},e.prototype.importMacros_IQP=function(e,r,n){require("m.aio.configmanager.js").trace("/config/tenants/"+e,function(t,o){if(t)n&&n(t);else if(o&&o.license){var a=require("m.aio.macromanager.js"),i=a._getHandler(e);if(i){var s=require("m.aio.devicemanager.js").getIntHandler(e);if(s){var c=r;if(c&&c.groups)for(var l=0;l<c.groups.length;l++){var u=c.groups[l];if(u&&u.macros)for(var p=0;p<u.macros.length;p++){var d=u.macros[p];if(d&&d.commands)for(var f=0;f<d.commands.length;f++){var m=d.commands[f];if(m&&m.action&&m.action.device){var h=m.action.device.room;if(h&&!isNaN(parseInt(h))){var g=s.findRoomWithIndex(parseInt(h));g&&g.name&&(m.action.device.room=g.name);}}}}}i.macros=a.Macros.parse(c),i._saveMacros(function(e){e?n&&n(e):require("m.aio.devicemanager.js").reloadTenant(o,function(e){n&&n(e);});});}else n&&n(new Error("no device manager"));}else n&&n(new Error("no such tenant"));}else n&&n("invalid tenant");});},e;}(),m.aio.importmanager.Handler=m.aio.importmanager.Manager,"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.importmanager.Handler());