var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.symcon=xnm.aio.symcon||{};xnm.aio.symcon.TYPE_BOOL=0;xnm.aio.symcon.TYPE_INT=1;xnm.aio.symcon.TYPE_FLOAT=2;xnm.aio.symcon.TYPE_STRING=3;
xnm.aio.symcon.Server=function(b,a,c,d,f,e){try{this._logger=require("x.logger.js").getLogger("xnm.aio.symcon.Server")}catch(g){this._logger={log:function(){}}}this.ip=b;this.port=a?a:82;this.user=c;this.password=d;this.webusr="webfront";this.webid=f;this.webpwd=e;this._id=1;this.scripts={};this.instances={};this.variables={};this._scanning=!1;this._scanCallbacks=[];this._scanListener=[];this.CommandHandler=null};
xnm.aio.symcon.Server.prototype._doRequest=function(b,a,c){a='{"jsonrpc": "2.0", "params": '+JSON.stringify(a)+', "method": "'+b+'", "id": '+this._id++ +"}";"WFC_"==b.substr(0,4)?(this._logger.log("trace","do WFC_ request with cred.:"+this.webusr+" pwd:"+this.webpwd),b=this.webpwd?"Basic "+(new Buffer(this.webusr+":"+this.webpwd)).toString("base64"):null):(this._logger.log("trace","do request with cred.:"+this.user+" pwd:"+this.password),b=this.user&&this.password?"Basic "+(new Buffer(this.user+":"+
this.password)).toString("base64"):null);var d={host:this.ip,port:this.port,path:"/api/",method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8","Content-Length":a.length,"User-Agent":"mediola",Connection:"close"}};b&&(d.headers.Authorization=b);this._logger.log("trace","do request:"+JSON.stringify(d));this._logger.log("trace","with data:"+a);var f=this,e=require("http").request(d,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){f._logger.log("trace",
"do request reponse:"+a.statusCode);f._logger.log("trace",b);if(200==a.statusCode){var d={};try{var e=JSON.parse(b);e&&e.error?(d.error="unknown",e.error.message&&(d.error=e.error.message),e.error.code&&(d.errorCode=e.error.code)):d.data=e.result}catch(p){}c&&c(d)}else c&&c(null)})});e.setTimeout(5E3,function(){f._logger.log("trace","do request timeout");e.abort()});e.on("error",function(a){f._logger.log("trace","do request error:"+a.message);f._logger.log("trace",a.stack);c&&c({error:a&&a.message?
a.message:"http requeset error"})});a&&e.write(a);e.end()};
xnm.aio.symcon.Server.prototype._scanInstanceFunctions=function(b,a){var c=this;this._doRequest("IPS_GetFunctionList",[b],function(b){if(b)if(b.error)a(Error(b.error));else{var f=[];if(b.data)for(var e=b.data.length,g=0;g<b.data.length;g++){var h=b.data[g];"IPS_"==h.substr(0,4)?(e--,0==e&&a(null,f)):functions[h]?(e--,f.push(functions[h])):c._scanFunction(b.data[g],function(b,c){e--;!b&&c&&(functions[c.FunctionName]=c,f.push(c));0==e&&a(null,f)})}else a(null,f)}else a(Error("http error"))})};
xnm.aio.symcon.Server.prototype._scanFunction=function(b,a){this._doRequest("IPS_GetFunction",[b],function(b){if(b)if(b.error)a(Error(b.error));else{var d=null;b&&b.data&&(d=b.data);a(null,d)}else a(Error("http error"))})};xnm.aio.symcon.Server.prototype._scanWebfront=function(b){this._doRequest("WFC_GetConfigurators",[],function(a){if(a)if(a.error)b(Error(a.error));else{var c=[];a&&a.data&&0<a.data.length&&a.data.forEach(function(a){a.id&&c.push({id:a.id,requirepwd:a.password})});b(null,c)}else b(Error("http error"))})};
xnm.aio.symcon.Server.prototype.scanObjects=function(b,a){var c=function(a,b){if(!a||!b)return null;for(var c=0;c<a.length;c++)if(a[c]===b)return!0;return!1},d=function(a,b,c){a._scanListener.forEach(function(a){a.finish&&"function"==typeof a.finish&&a.finish(b,c)});a._scanCallbacks.forEach(function(a){a&&a(b,c)});a._scanning=!1;a._scanCallbacks=[];a._scanListener=[]},f=function(a,b,c){a._doRequest("IPS_GetVariable",[b],function(a){if(a)if(a.error)c(Error(a.error));else{var d=null;if(a&&a.data)if(d=
{},d.id=b,null!=a.data.VariableType&&"undefined"!=typeof a.data.VariableType)d.valuetype=parseInt(a.data.VariableType),d.value=a.data.VariableValue;else if(null!=a.data.VariableValue&&"undefined"!=typeof a.data.VariableValue&&(a=a.data.VariableValue,null!=a.ValueType&&"undefined"!=typeof a.ValueType))switch(d.valuetype=a.ValueType,parseInt(d.valuetype)){case 0:d.value=a.ValueBoolean;break;case 1:d.value=a.ValueInteger;break;case 2:d.value=a.ValueFloat;break;case 3:d.value=a.ValueString}c(null,d)}else c(Error("http error"))})},
e=function(a,b,c){g(a,b,{instances:{},variables:{},scripts:{}},function(b,d){if(b)c(b);else{var e,f={},g={};for(e in d.variables)if(d.variables.hasOwnProperty(e))if(d.variables[e].parentid){var h=d.instances[d.variables[e].parentid];h?(h.variables||(h.variables=[]),h.variables.push(d.variables[e])):g[e]=d.variables[e]}else g[e]=d.variables[e];f.instances={};for(e in d.instances)d.instances.hasOwnProperty(e)&&d.instances[e]&&d.instances[e].variables&&0<d.instances[e].variables.length&&(f.instances[e]=
d.instances[e]);f.scripts=d.scripts;f.variables=g;a.instances=f.instances;a.scripts=f.scripts;a.variables=f.variables;c(null,f)}})},g=function(a,b,c,d){if(0==b.length)d(null,c);else{var e=b.pop();a._doRequest("IPS_GetObject",[e],function(e){if(e)if(e.error)d(e.error);else if(a._scanListener.forEach(function(a){if(a.one&&"function"==typeof a.one)a.one()}),e.data){var h=e.data.ObjectID;switch(e.data.ObjectType){case 1:var n=e.data.ChildrenIDs;n&&0<n.length&&!c.instances[h]&&(c.instances[h]={name:e.data.ObjectName,
type:1,objectid:h});g(a,b,c,d);break;case 2:c.variables[h]?g(a,b,c,d):(c.variables[h]={name:e.data.ObjectName,parentid:e.data.ParentID,type:2,objectid:h},f(a,h,function(e,f){e?d(e):(f&&(c.variables[h].valuetype=f.valuetype,c.variables[h].value=f.value),g(a,b,c,d))}));break;case 3:c.scripts[h]||(c.scripts[h]={name:e.data.ObjectName,parentid:e.data.ParentID,hidden:e.data.ObjectIsHidden,type:3,objectid:h});g(a,b,c,d);break;default:g(a,b,c,d)}}else g(a,b,c,d);else d(Error("http error"))})}};a&&!c(this._scanCallbacks,
a)&&this._scanCallbacks.push(a);b&&!c(this._scanListener,b)&&this._scanListener.push(b);if(!this._scanning){this.scripts={};this.instances={};var h=this;this._scanListener.forEach(function(a){a.start&&"function"==typeof a.start&&a.start()});this._doRequest("IPS_GetObjectList",[],function(a){var b;a?a.error&&(b=Error(a.error)):b=Error("http request error");b?d(h,b):a.data&&0!=a.data.length?(h._scanListener.forEach(function(b){b.total&&"function"==typeof b.total&&b.total(a.data.length)}),e(h,a.data,
function(a,b){d(h,a,b)})):d(h,b,{instance:{},scripts:{}})})}};xnm.aio.symcon.Server.prototype.getState=function(b,a,c){c&&this._doRequest(a?"GetValueFormatted":"GetValue",[b.id],function(a){a?a.error?c&&c(Error(a.error)):c&&c(null,a.data):(a=Error("http request error"),a._code=1,c&&c(a))})};xnm.aio.symcon.Server.prototype.executeCommand=function(b,a,c){var d=!1;"on"==a&&(d=!0);this._doRequest("SetValue",[b.id,d],function(a){c&&c()})};xnm.aio.symcon.Server.prototype.getStates=function(b,a,c){};
xnm.aio.symcon.Server.prototype.getStateValues=function(b,a){return sv};xnm.aio.symcon.Server.prototype._getVariableFromInstance=function(b,a){if(!a.variables)return null;for(var c=0;c<a.variables.length;c++)if(a.variables[c].objectid==b)return a.variables[c];return null};
xnm.aio.symcon.Server.prototype.executeCommandCreator=function(b,a,c){if(b&&b.objectid&&a&&a.value){var d=a.value,f=b.objectid,e=d.indexOf("#");0<e&&(f=d.substr(0,e),d=d.substr(e+1));e=b.parentid?b.parentid:0;if(1==b.type){b=this._getVariableFromInstance(f,b);if(!b){c&&c(Error("no such variable"));return}b.parentid&&(e=b.parentid)}var g;switch(parseInt(b.type)){case 2:switch(parseInt(b.valuetype)){case 0:"on"==d?g=!0:"off"==d&&(g=!1);break;case 1:"setValue"==d&&(g=parseInt(a.ext));break;case 2:"setValue"==
d&&(g=parseFloat(a.ext));break;case 3:"setValue"==d&&(g=a.ext)}break;case 3:"run"==d&&(g=0);break;default:c&&c(Error("device type not supported"));return}if(null==g||"undefined"==typeof g)c&&c(Error("command invalid"));else if(this.webid){var h=this;this._doRequest("WFC_Execute",[parseInt(this.webid),parseInt(e),parseInt(f),g],function(b){var d;if(!b)d=Error("http requeset error");else if(b.error&&(h._logger.log("trace","execute command error:"+JSON.stringify(b)),d=Error(b.error),b.errorCode)){"run"==
a.value?(b="IPS_RunScript",d=[parseInt(f)]):(b="SetValue",d=[parseInt(f),g]);h._doRequest(b,d,function(a){var b;a?a.error&&(b=Error(a.error)):b=Error("http requeset error");c&&c(b)});return}c&&c(d)})}else c&&c(Error("no web front object id"))}else c&&c(Error("argument invalid"))};
xnm.aio.symcon.Server.prototype.getStatesCreator=function(b,a,c){if(a&&0!=a.length){b=!0;for(var d={},f={},e=0;e<a.length;e++)if(a[e]&&a[e].device&&a[e].id){var g=a[e].device.objectid,h=a[e].status.value,k=a[e].status.value.indexOf("#");0<k&&(h=a[e].status.value.substr(k+1));1==a[e].device.type&&a[e].status.value&&0<k&&(g=a[e].status.value.substr(0,k));g&&(b=!1,"stateF"==h?(d[g]||(d[g]=[]),d[g].push(a[e])):(f[g]||(f[g]=[]),f[g].push(a[e])))}if(b)c&&c(null,[]);else{var l=this;this._getNextState(0,
Object.keys(f),{},function(a,b){if(a)c&&c(a);else{var e=[];if(b)for(var g in b)if(b.hasOwnProperty(g)){var h=f[g];if(h&&0<h.length)for(var k=0;k<h.length;k++){var m=l._resolveState(h[k].device,h[k].status,b[g]);null!=m&&"undefined"!=typeof m&&e.push({id:h[k].id,status:m})}}l._getNextFormattedState(0,Object.keys(d),{},function(a,b){if(!a&&b)for(var f in b)if(b.hasOwnProperty(f)){var g=d[f];if(g&&0<g.length)for(var h=0;h<g.length;h++){var k=l._resolveState(g[h].device,g[h].status,b[f]);null!=k&&"undefined"!=
typeof k&&e.push({id:g[h].id,status:k})}}c&&c(null,e)})}})}}else c&&c(null,[])};
xnm.aio.symcon.Server.prototype._resolveState=function(b,a,c){if(!b||!a||null==c||"undefined"==typeof c)return null;var d=!1;"stateF"==a.value&&(d=!0);var f=a.value.indexOf("#");0<f&&"stateF"==a.value.substr(f+1)&&(d=!0);if(1==b.type){var e=b.objectid;0<f&&(e=a.value.substr(0,f));b=this._getVariableFromInstance(e,b);if(!b)return null}if(d)return c;switch(parseInt(b.valuetype)){case 0:if("string"==typeof c)if("true"==c.toLowerCase())c=!0;else if("false"==c.toLowerCase())c=!1;else return null;return c?
"on":"off";case 1:return parseInt(c);case 2:return parseFloat(c).toFixed(2);case 3:return c.toString();default:return null}};xnm.aio.symcon.Server.prototype._getNextState=function(b,a,c,d){if(b==a.length)d&&d(null,c);else{var f=this,e=a[b];"string"==typeof e&&(e=parseInt(e));this.getState({id:e},!1,function(e,h){e&&1==e._code?d&&d(e):(e||null==h||"undefined"==typeof h||(c[a[b]]=h),b+=1,f._getNextState(b,a,c,d))})}};
xnm.aio.symcon.Server.prototype._getNextFormattedState=function(b,a,c,d){if(b==a.length)d&&d(null,c);else{var f=this,e=a[b];"string"==typeof e&&(e=parseInt(e));this.getState({id:e},!0,function(e,h){e&&1==e._code?d&&d(e):(e||null==h||"undefined"==typeof h||(c[a[b]]=h),b+=1,f._getNextFormattedState(b,a,c,d))})}};xnm.aio.symcon.Server.prototype.toJSON=function(){return{sys:xnm.aio.symcon.DM.SYS,ip:this.ip,port:this.port,username:this.user,password:this.password,webid:this.webid,webpwd:this.webpwd}};
xnm.aio.symcon.Server.prototype.equalsTo=function(b){return b&&b instanceof xnm.aio.symcon.Server?this.ip==b.ip&&this.port==b.port&&this.user==b.user&&this.password==b.password:!1};
xnm.aio.symcon.DM=function(){var b=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};b.prototype=Error();b.prototype.name="IPSymconDMError";b.prototype.code=0;b.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"ipsync",getGatewayType:function(){return{sys:this.SYS,name:"IP-Symcon",port:82}},createGateway:function(a,c,d){c=b.ERROR_CODE;a?a.ip?a.port?a.username?a.password?d(null,a):d(new b(c.INVALID,"password is invalid")):d(new b(c.INVALID,
"username is invalid")):d(new b(c.INVALID,"port is invalid")):d(new b(c.INVALID,"ip is invalid")):d(new b(c.INVALID,"info is invalid"))},updateGateway:function(a,c,d,f){a=b.ERROR_CODE;c?c.ip?c.port?c.username?c.password?f(null,c):f(new b(a.INVALID,"password is invalid")):f(new b(a.INVALID,"username is invalid")):f(new b(a.INVALID,"port is invalid")):f(new b(a.INVALID,"ip is invalid")):f(new b(a.INVALID,"update is invalid"))},deleteGateway:function(a,b,d){d()},createDevice:function(a,c,d){var f=b.ERROR_CODE;
if(a)if(a.gateway)if(c.data&&c.data.gateways&&0!==c.data.gateways.length){c=c.data.gateways;var e,g;for(e=0;e<c.length;e++)if(c[e].index===a.gateway){g=c[e];break}g?a.type?a.objectid?d(null,a):d(new b(f.INVALID,"address is invalid")):d(new b(f.INVALID,"type is invalid")):d(new b(f.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else d(new b(f.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else d(new b(f.INVALID,"gateway is invalid"));else d(new b(f.INVALID,"info is invalid"))},
updateDevice:function(a,c,d){var f=b.ERROR_CODE;if(a)if(a.gateway){c=c.data.gateways;var e,g;for(e=0;e<c.length;e++)if(c[e].index===a.gateway){g=c[e];break}g?a.type?a.objectid?d(null,a):d(new b(f.INVALID,"address is invalid")):d(new b(f.INVALID,"type is invalid")):d(new b(f.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else d(new b(f.INVALID,"gateway is invalid"));else d(new b(f.INVALID,"info is invalid"))},deleteDevice:function(a,b,d){d()},getCommandStatusMap:function(a){var b=function(a){if(null==
a.valuetype||"undefined"==typeof a.valuetype)return null;var b;switch(parseInt(a.valuetype)){case 0:b={command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}}],status:[{type:"enum",name:"status",ref:{value:"state",options:["off","on"]}},{type:"string",name:"formatted status",ref:{value:"stateF"}}]};break;case 1:b={command:[{type:"int",name:"set value",ref:{value:"setValue",ext:"%d"}}],status:[{type:"int",name:"status",ref:{value:"state",ext:"%d"}},{type:"string",
name:"formatted status",ref:{value:"stateF"}}]};break;case 2:b={command:[{type:"float",name:"set value",ref:{value:"setValue",ext:"%f"}}],status:[{type:"float",name:"status",ref:{value:"state",ext:"%f"}},{type:"string",name:"formatted status",ref:{value:"stateF"}}]};break;case 3:b={command:[{type:"string",name:"set value",ref:{value:"setValue",ext:"%s"}}],status:[{type:"string",name:"status",ref:{value:"state",ext:"%s"}}]};break;default:return null}b&&(b.command&&b.command.forEach(function(b){b.name=
a.name?a.name+" "+b.name:b.name;b.ref.value=a.objectid+"#"+b.ref.value}),b.status&&b.status.forEach(function(b){b.name=a.name?a.name+" "+b.name:b.name;b.ref.value=a.objectid+"#"+b.ref.value}));return b};if(null==a.type||"undefined"==typeof a.type)return null;switch(parseInt(a.type)){case 1:if(a.variables){var d=[],f=[];a.variables.forEach(function(a){(a=b(a))&&a.command&&(d=d.concat(a.command));a&&a.status&&(f=f.concat(a.status))});return{command:d,status:f}}return null;case 2:return b(a);case 3:return{command:[{type:"enum",
name:"run",ref:{value:"run"}}]};default:return null}},applyUIFilter:function(a,b){var d=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},f=function(a,b,c){var e=[];switch(c.catagory){case "command":a.command&&a.command.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},e=function(a,b){var c=
[],d=null;if(d=xnm.aio.symcon.DM.getCommandStatusMap(a))d=f(d,a,b),c=c.concat(d);return c};if(!a.sys)return null;var g=JSON.parse(JSON.stringify(a)),h=null;switch(b.catagory){case "command":h=e(a,b);g.command=h;break;case "status":h=e(a,b);g.status=h;break;default:return null}return h&&0!=h.length?g:null}}}();xnm.aio.symcon.Handler=function(){};xnm.aio.symcon.Handler.prototype.Server=xnm.aio.symcon.Server;
xnm.aio.symcon.Handler.prototype.getStateValues=function(b,a){return(new xnm.aio.symcon.Server).getStateValues(b.type,a)};xnm.aio.symcon.Handler.prototype.getDeviceCommandList=function(b,a){return[]};xnm.aio.symcon.Handler.prototype.TYPE_BOOL=xnm.aio.symcon.TYPE_BOOL;xnm.aio.symcon.Handler.prototype.TYPE_INT=xnm.aio.symcon.TYPE_INT;xnm.aio.symcon.Handler.prototype.TYPE_FLOAT=xnm.aio.symcon.TYPE_FLOAT;xnm.aio.symcon.Handler.prototype.TYPE_STRING=xnm.aio.symcon.TYPE_STRING;
xnm.aio.symcon.Handler.prototype.devicemanager=xnm.aio.symcon.DM;xnm.aio.symcon.Handler.prototype.registModule=function(b){b.register(this.devicemanager.SYS,"symcon")};xnm.aio.symcon.Handler.prototype.resolveGateway=function(b){return b&&b.ip&&b.username&&b.password?new xnm.aio.symcon.Server(b.ip,b.port,b.username,b.password,b.webid,b.webpwd):null};xnm.aio.symcon.Handler.prototype.getWebfronts=function(b,a){var c=this.resolveGateway(b);c?c._scanWebfront(function(b,c){a&&a(b,c)}):a&&a(Error("gateway json invalid"))};
xnm.aio.symcon.Handler.prototype.getDeviceList=function(b,a){var c=this.resolveGateway(b);c?c.scanObjects(null,function(b,c){var e={webfront:[],devices:[]},g;if(!b&&c){for(g in c.instances)c.instances.hasOwnProperty(g)&&e.devices.push(c.instances[g]);for(g in c.scripts)c.scripts.hasOwnProperty(g)&&e.devices.push(c.scripts[g]);for(g in c.variables)c.variables.hasOwnProperty(g)&&e.devices.push(c.variables[g]);e.webfront=c.webfront}a&&a(b,e)}):a&&a(Error("gateway json invalid"))};
xnm.aio.symcon.Handler.prototype.getDeviceCommands=function(b,a){var c=xnm.aio.symcon.DM.applyUIFilter(b,{catagory:"command",elems:"*"}),c=c?c.command:[];a&&a(null,c)};xnm.aio.symcon.Handler.prototype.getDeviceStatus=function(b,a){var c=xnm.aio.symcon.DM.applyUIFilter(b,{catagory:"status",elems:"*"}),c=c?c.status:[];a&&a(null,c)};xnm.aio.symcon.Handler.prototype.doCommand=function(b,a,c,d){(b=this.resolveGateway(b))?b.executeCommandCreator(a,c,function(a){d&&d(a)}):d&&d(Error("gateway json invalid"))};
xnm.aio.symcon.Handler.prototype.doStatus=function(b,a,c,d,f){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:b,device:c,status:d}],function(a,b){a?f&&f(a):f&&f(null,b[0])}):f&&f(Error("gateway json invalid"))};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.symcon.Handler);
