var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.tplink=xnm.aio.tplink||{};xnm.aio.tplink.SmartPlug=function(a,d){this._host=a;this._port=d;this._port||(this._port=9999);this._timeout=2E3;this.CommandHandler=null};xnm.aio.tplink.SmartPlug.prototype._decryptData=function(a){var d=null;if(a&&4<a.length&&a[3]+(a[2]<<8)==a.length-4)for(var d="",c=171,b=4;b<a.length;b++){d.charCodeAt(b);var e=c^a[b],c=a[b],d=d+String.fromCharCode(e)}return d};
xnm.aio.tplink.SmartPlug.prototype._send=function(a,d){for(var c=[0,0,0,0],b=JSON.stringify(d),e=171,g=0;g<b.length;g++){var f=b.charCodeAt(g),e=f^=e;c.push(f)}c[3]=c.length-4;c=new Buffer(c);a&&a.write(c)};
xnm.aio.tplink.SmartPlug.prototype._doRequest=function(a,d){var c=this,b=require("net").connect({port:this._port,host:this._host});b.setTimeout(this._timeout);b.on("connect",function(){c._send(b,a)});b.on("data",function(a){a=c._decryptData(a);var b=null;try{b=JSON.parse(a)}catch(f){}d&&d(b)});b.on("error",function(a){d&&d(null)});b.on("timeout",function(){b&&b.destroy();d&&d(null)});b.on("close",function(){b=null})};
xnm.aio.tplink.SmartPlug.prototype.executeCommand=function(a,d,c){var b=null;if("on"==d)b={system:{set_relay_state:{state:1}}};else if("off"==d)b={system:{set_relay_state:{state:0}}};else if("ledOn"==d)b={system:{set_led_off:{off:0}}};else if("ledOff"==d)b={system:{set_led_off:{off:1}}};else if("toggle"==d||"toggleLED"==d){var e=this;this.getState(function(b){b?"toggle"==d?"off"==b.state?e.executeCommand(a,"on",c):e.executeCommand(a,"off",c):"toggleLED"==d&&("off"==b.led?e.executeCommand(a,"ledOn",
c):e.executeCommand(a,"ledOff",c)):c&&c()})}else c&&c();b&&this._doRequest(b,function(a,b){c&&c()})};
xnm.aio.tplink.SmartPlug.prototype.getState=function(a){var d=this;this._doRequest({system:{get_sysinfo:{}}},function(c,b){var e={state:"?"};c&&c.system&&c.system.get_sysinfo?(1==c.system.get_sysinfo.relay_state?e.state="on":0==c.system.get_sysinfo.relay_state&&(e.state="off"),1==c.system.get_sysinfo.led_off?e.led="off":0==c.system.get_sysinfo.led_off&&(e.led="on"),d._doRequest({emeter:{get_realtime:{}}},function(b,c){b&&b.emeter&&b.emeter.get_realtime&&(e.current=b.emeter.get_realtime.current,e.power=
b.emeter.get_realtime.power);a&&a(e)})):a&&a(e)})};xnm.aio.tplink.SmartPlug.prototype.getStates=function(a,d,c){var b=this;this.CommandHandler=a;this.getState(function(a){device&&b.CommandHandler.setState?b.CommandHandler.setState(device.id,a.state):b.CommandHandler.receivedState&&b.CommandHandler.receivedState("tplink",b.host,a);c&&c(a)})};xnm.aio.tplink.SmartPlug.prototype.getStateValues=function(a,d){return d};xnm.aio.tplink.Handler=function(){this.detectedSmartPlugs={}};
xnm.aio.tplink.Handler.prototype.discoverSmartPlugs=function(a){};xnm.aio.tplink.Handler.prototype.SmartPlug=xnm.aio.tplink.SmartPlug;xnm.aio.tplink.Handler.prototype.getStateValues=function(a,d){return(new xnm.aio.tplink.SmartPlug).getStateValues(a.type,d)};xnm.aio.tplink.Handler.prototype.getDeviceCommandList=function(a,d,c){a=[];a.push({id:"on",cmd:"on"});a.push({id:"off",cmd:"off"});a.push({id:"toggle",cmd:"toggle"});return a};
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.tplink.Handler);
