var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.zigbee=x.hub.m.zigbee||{};require("x.logger.js").setLevel("trace","x.hub.m.zigbee.Zigbee");
x.hub.m.zigbee.Util=function(){var g=function(){};g.prototype.rgbToHsv=function(c,a,b){c/=255;a/=255;b/=255;var d=Math.max(c,a,b),e=Math.min(c,a,b),h,f=d-e;if(d==e)h=0;else{switch(d){case c:h=(a-b)/f+(a<b?6:0);break;case a:h=(b-c)/f+2;break;case b:h=(c-a)/f+4}h/=6}return[h,0==d?0:f/d,d]};g.prototype.hsvToRgb=function(c,a,b){var d,e,h,f=Math.floor(6*c),g=6*c-f;c=b*(1-a);var k=b*(1-g*a);a=b*(1-(1-g)*a);switch(f%6){case 0:d=b;e=a;h=c;break;case 1:d=k;e=b;h=c;break;case 2:d=c;e=b;h=a;break;case 3:d=c;
e=k;h=b;break;case 4:d=a;e=c;h=b;break;case 5:d=b,e=c,h=k}return[255*d,255*e,255*h]};g.prototype.rgbTocie=function(c,a,b){c=.04045<c?Math.pow((c+.055)/1.055,2.4):c/12.92;a=.04045<a?Math.pow((a+.055)/1.055,2.4):a/12.92;b=.04045<b?Math.pow((b+.055)/1.055,2.4):b/12.92;var d=.664511*c+.154324*a+.162028*b,e=.283881*c+.668433*a+.047685*b;a=8.8E-5*c+.07231*a+.986039*b;c=(d/(d+e+a)).toFixed(4);d=(e/(d+e+a)).toFixed(4);isNaN(c)&&(c=0);isNaN(d)&&(d=0);return[c,d]};g.prototype.cieTorgb=function(c,a,b){void 0===
b&&(b=254);var d=1-c-a;b=(b/254).toFixed(2);c*=b/a;var e=b/a*d;a=1.656492*c-.354851*b-.255038*e;d=.707196*-c+1.655397*b+.036152*e;b=.051713*c-.121364*b+1.01153*e;a>b&&a>d&&1<a?(d/=a,b/=a,a=1):d>b&&d>a&&1<d?(a/=d,b/=d,d=1):b>a&&b>d&&1<b&&(a/=b,d/=b,b=1);a=.0031308>=a?12.92*a:1.055*Math.pow(a,1/2.4)-.055;d=.0031308>=d?12.92*d:1.055*Math.pow(d,1/2.4)-.055;b=.0031308>=b?12.92*b:1.055*Math.pow(b,1/2.4)-.055;a=Math.round(255*a);d=Math.round(255*d);b=Math.round(255*b);isNaN(a)&&(a=0);isNaN(d)&&(d=0);isNaN(b)&&
(b=0);return[a,d,b]};g.prototype.RGBToHSV=function(c,a,b){c/=255;a/=255;b/=255;var d=Math.min(c,Math.min(a,b)),e=Math.max(c,Math.max(a,b));return d==e?[0,0,d]:[60*((c==d?3:b==d?1:5)-(c==d?a-b:b==d?c-a:b-c)/(e-d)),(e-d)/e,e]};return new g}();
x.hub.m.zigbee.Device=function(){var g=function(c,a){this._ieeeAdr=c;this._endpointID=a;this._deviceID=this._profileID=null;this._states={}};g.prototype.getIeeeAdr=function(){return this._ieeeAdr};g.prototype.getEndpointID=function(){return this._endpointID};g.prototype.setBufferedState=function(c,a){this._states[c]=a};g.prototype.getBufferedState=function(c){return this._states[c]};g.prototype.getBufferedStates=function(){return this._states};g.prototype.getConvertedStates=function(){var c={};"undefined"!=
typeof this._states.onoff&&null!=this._states.onoff&&(c.onoff=this._states.onoff);"undefined"!=typeof this._states.level&&null!=this._states.level&&(c.level=Math.round(this._states.level/255*100));if("undefined"!=typeof this._states.color&&null!=this._states.color&&(c.color=this._states.color,"undefined"!=typeof this._states.color.hue&&null!=this._states.color.hue&&"undefined"!=typeof this._states.color.sat&&null!=this._states.color.sat)){var a=x.hub.m.zigbee.Util.hsvToRgb(this._states.color.hue/
254,this._states.color.sat/254,1),b=Math.round(a[0]).toString(16);2>b.length&&(b="0"+b);var b=b.toUpperCase(),d=Math.round(a[1]).toString(16);2>d.length&&(d="0"+d);d=d.toUpperCase();a=Math.round(a[2]).toString(16);2>a.length&&(a="0"+a);a=a.toUpperCase();c.rgb=b+d+a}"off"==c.onoff&&(c.level=0);"on"==c.onoff&&0==c.level&&(c.level=1);0==c.level&&(c.onoff="off");return c};g.prototype.executeCommand=function(c,a,b){var d,e,h=this;if("on"==a||"off"==a)d=a,c._doCommand(this._ieeeAdr,this._endpointID,d,null,
function(a){a||h.setBufferedState("onoff",d);b&&b(a)});else if("toggle"==a)e=this.getBufferedState("onoff"),d="on"==e?"off":"on",c._doCommand(this._ieeeAdr,this._endpointID,d,null,function(a){a||h.setBufferedState("onoff",d);b&&b(a)});else if("white"==a)if("0200"==this._deviceID&&this._profileID.indexOf("000B57")){a=x.hub.m.zigbee.Util.rgbTocie(255,255,255);var f=Math.round(65536*a[0]);65279<f&&(f=65279);a=Math.round(65536*a[1]);65279<a&&(a=65279);c._doCommand(this._ieeeAdr,this._endpointID,"color_xy",
[f,a],function(a){b&&b(a)})}else c._doCommand(this._ieeeAdr,this._endpointID,"hue_sat",[0,0],function(a){a||h.setBufferedState("color",{hue:0,sat:0});b&&b(a)});else if(0==a.indexOf("dimTo"))d="level",e=parseInt(a.substr(5)),isNaN(e)?b&&b(Error("command "+a+" invalid")):(e=Math.round(e/100*255),c._doCommand(this._ieeeAdr,this._endpointID,d,e,function(a){a||h.setBufferedState("level",e);b&&b(a)}),0==e?c._doCommand(this._ieeeAdr,this._endpointID,"off",null,function(a){a||h.setBufferedState("onoff","off")}):
c._doCommand(this._ieeeAdr,this._endpointID,"on",null,function(a){a||h.setBufferedState("onoff","on")}));else if(0==a.indexOf("setColorMap"))if((e=a.substr(11))&&-1!=e.indexOf(","))if(f=e.split(","),2>f.length)b&&b(Error("command "+a+" invalid"));else{var g=parseInt(f[0]);0>g&&(g=0);255<g&&(g=255);var k=parseInt(f[1]);0>k&&(k=0);255<k&&(k=255);c._doCommand(this._ieeeAdr,this._endpointID,"hue_sat",[g,k],function(a){a||h.setBufferedState("color",{hue:g,sat:k});b&&b(a)})}else b&&b(Error("command "+a+
" invalid"));else if(0==a.indexOf("setColorXY"))(e=a.substr(10))&&-1!=e.indexOf(",")?(f=e.split(","),2>f.length?b&&b(Error("command "+a+" invalid")):(a=parseInt(f[0]),0>a&&(a=0),65279<a&&(a=65279),f=parseInt(f[1]),0>f&&(f=0),65279<f&&(f=65279),c._doCommand(this._ieeeAdr,this._endpointID,"color_xy",[a,f],function(a){b&&b(a)}))):b&&b(Error("command "+a+" invalid"));else if(0==a.indexOf("setColorTemp"))if(e=a.substr(12)){f=parseFloat(e);15.32>f&&(f=15.32);var l=Math.round(1E6/f);c._doCommand(this._ieeeAdr,
this._endpointID,"color_temp",l,function(a){a||h.setBufferedState("color_temp",l);b&&b(a)})}else b&&b(Error("command "+a+" invalid"));else if(0==a.indexOf("setRGB")){e=a.substr(6);f=parseInt(e.substr(0,2),16);a=parseInt(e.substr(2,2),16);var m=parseInt(e.substr(4,2),16);if("0200"==this._deviceID&&0==this._ieeeAdr.indexOf("000B57"))a=x.hub.m.zigbee.Util.rgbTocie(f,a,m),f=Math.round(65536*a[0]),65279<f&&(f=65279),a=Math.round(65536*a[1]),65279<a&&(a=65279),c._doCommand(this._ieeeAdr,this._endpointID,
"color_xy",[f,a],function(a){b&&b(a)});else{var f=x.hub.m.zigbee.Util.rgbToHsv(f,a,m),n=Math.floor(254*f[0]),p=Math.floor(254*f[1]);c._doCommand(this._ieeeAdr,this._endpointID,"hue_sat",[n,p],function(a){a||h.setBufferedState("color",{hue:n,sat:p});b&&b(a)})}}else b&&b(Error("unknown command"))};g.prototype.toJSON=function(){return{ieeeAdr:this._ieeeAdr,endpointID:this._endpointID,profileID:this._profileID,deviceID:this._deviceID}};g.parseJSON=function(c){if(!c||!c.ieeeAdr||!c.endpointID)return null;
var a=new g(c.ieeeAdr,c.endpointID);a._profileID=c.profileID;a._deviceID=c.deviceID;return a};return g}();
x.hub.m.zigbee.Zigbee=function(){var g=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.zigbee.Zigbee");this._devices=[];this._learnCBs=[];this._learnTO=null};g.prototype.init=function(c){this._logger.log("info","zigbee init");var a=this;this.listDevices(function(b){b&&a._logger.log("info","init list devices error:"+b.message);c&&c(b)})};g.prototype.getDevices=function(){return this._devices};g.prototype.executeCommand=function(c,a,b){if(c)if(a){var d=c.indexOf(":");if(-1==d)b&&b(Error("address format invalid"));
else{var e=c.substr(0,d);c=c.substr(d+1);(d=this._findDevice(e,c))||(d=new x.hub.m.zigbee.Device(e,c));d.executeCommand(this,a,b)}}else b&&b(Error("command invalid"));else b&&b(Error("address is empty"))};g.prototype.learnDevice=function(c,a){a||(a=function(){});c=parseInt(c);if(!c||isNaN(c)||0>=c)c=60;var b=this._learnCBs.length;-1==this._learnCBs.indexOf(a)&&this._learnCBs.push(a);if(!(0<b)){var d=this;this._learnTO=setTimeout(function(){d._listDevices(function(a,b){var c;d._learnTO=null;var g=
d._learnCBs;d._learnCBs=[];if(a)for(c=g.length;c--;)g[c]&&g[c](a);else{var k=[];for(c=b.length;c--;){var l=b[c],m=d._findDevice(l.ieeeAdr,l.endpointID);!m&&(m=x.hub.m.zigbee.Device.parseJSON(l))&&(d._devices.push(m),k.push(l))}for(c=g.length;c--;)g[c]&&g[c](null,k)}})},1E3*c);this._openNetwork(c,function(a){if(a){clearTimeout(d._learnTO);d._learnTO=null;var b=d._learnCBs;d._learnCBs=[];for(var c=b.length;c--;)b[c]&&b[c](a)}})}};g.prototype.listDevices=function(c){var a=this;this._listDevices(function(b,
d){if(b)c&&c(b);else{for(var e=d.length;e--;){var h=d[e],f=a._findDevice(h.ieeeAdr,h.endpointID);f||(f=x.hub.m.zigbee.Device.parseJSON(h))&&a._devices.push(f)}c&&c()}})};g.prototype.removeDevice=function(c,a){if(c){var b=c.indexOf(":"),d;d=-1==b?c:c.substr(0,b);var e=this;this._removeDevice(d,function(b){b?a&&a(b):(e._deleteDevice(d,null),a&&a())})}else a&&a(Error("address is empty"))};g.prototype._findDevice=function(c,a){for(var b=this._devices.length;b--;){var d=this._devices[b];if(d.getIeeeAdr()==
c&&d.getEndpointID()==a)return d}return null};g.prototype._deleteDevice=function(c,a){var b=this._devices;this._devices=[];for(var d=b.length;d--;){var e=b[d],h=!1;e.getIeeeAdr()==c&&(a&&e.getEndpointID()!=a||(h=!0));h||this._devices.push(e)}};g.prototype._listDevices=function(c){this._logger.log("debug","list devices");var a=["/srv/Apps/zigbee/SYSTEM/servers/zb_con_action.bin"];a.push("listdevices");var a=a.join(" "),b=this;this._exec(a,function(a,e,h){if(a)b._logger.log("debug","list devices error:"+
a.message),c&&c(a);else if(h)b._logger.log("debug","list devices error:"+h),c&&c(Error(h));else if(b._logger.log("debug","list devices:\r\n"+e),e=e.trim()){a=[];e=e.split("\n");for(h=0;h<e.length;h++){var f=e[h].trim();f&&(f=f.split(" "),f={ieeeAdr:f[0]?f[0].replace(/:/g,""):null,endpointID:f[1],profileID:f[2]?f[2].substr(2):null,deviceID:f[3]?f[3].substr(2):null},a.push(f))}c&&c(null,a)}else c&&c(null,[])})};g.prototype._openNetwork=function(c,a){this._logger.log("debug","open network for "+c+" seconds");
var b=this,d=["/srv/Apps/zigbee/SYSTEM/servers/zb_con_action.bin opennetwork",c].join(" ");this._exec(d,function(c,d,f){c?(b._logger.log("debug","open network error:"+c.message),a&&a(c)):f?(b._logger.log("debug","open network error:"+f),a&&a(Error(f))):a&&a()})};g.prototype._removeDevice=function(c,a){this._logger.log("debug","remove device:"+c);var b=this,d=["/srv/Apps/zigbee/SYSTEM/servers/zb_con_action.bin remove",c].join(" ");this._exec(d,function(d,h,f){d?(b._logger.log("debug","remove device "+
c+" error:"+d.message),a&&a(d)):f?(b._logger.log("debug","remove device "+c+" error:"+f),a&&a(Error(f))):a&&a()})};g.prototype._doCommand=function(c,a,b,d,e){var h=[c,a,b,d];this._logger.log("debug","do command ["+h.join(",")+"]");h=["/srv/Apps/zigbee/SYSTEM/servers/zb_con_action.bin"];h.push(b);h.push(c);h.push(a);"undefined"!=typeof d&&null!=d&&(Array.isArray(d)?h=h.concat(d):h.push(d));var f=this;c=h.join(" ");this._exec(c,function(a,b,c){if(a)f._logger.log("debug","do command error:"+a.message),
e&&e(a);else if(c)f._logger.log("debug","do command error:"+c),e&&e(Error(c));else try{if(b){var d=JSON.parse(b);e&&e(null,d)}else e&&e()}catch(h){f._logger.log("debug","do command error (not json):"+b),e&&e(Error(b))}})};g.prototype._exec=function(c,a){this._logger.log("trace","execute native:"+c);var b=this,d=require("child_process").exec,d=d(c),e,h="",f="";d.stderr.on("data",function(a){e=String(a);f+=e});d.stdout.on("data",function(a){e=String(a);h+=e});d.on("error",function(c){b._logger.log("warn",
"execute native error:"+c.message);a&&a(c);a=null});d.on("close",function(c,d){b._logger.log("trace","execute native close:"+c+","+d);b._logger.log("trace","outTxt:"+h);b._logger.log("trace","errTxt:"+f);a&&a(null,h,f);a=null})};return g}();
x.hub.m.zigbee.Handler=function(){var g=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.zigbee.Handler");this._zigbee=null;this._zigbeeStickAvaliable=!1};util.inherits(g,EventEmitter);g.prototype.Zigbee=x.hub.m.zigbee.Zigbee;g.prototype.getSystems=function(){return["zigbee"]};g.prototype.init=function(c){var a=this,b=require("x.hub.eventbus.js");b.on("x.hub.peripheralman.ADD_ZIGBEE",function(b){a._logger.log("debug","insert zigbee usb stick");a._zigbeeStickAvaliable=!0});b.on("x.hub.peripheralman.REMOVE_ZWAVE",
function(b){a._logger.log("debug","eject zigbee usb stick");a._zigbeeStickAvaliable=!1});global.ZIGBEE_PORT&&(this._zigbeeStickAvaliable=!0);this._zigbee=new this.Zigbee;this._zigbee.init();c&&c({})};g.prototype.executeCommand=function(c,a,b){b&&b()};g.prototype.learnDevice=function(c,a){this._zigbeeStickAvaliable?this._zigbee.learnDevice(c.timeout,function(b,c){a&&a({error:b,data:c})}):a&&a({error:Error("zigbee usb stick not avaliable")})};g.prototype.removeDevice=function(c,a){this._zigbeeStickAvaliable?
this._zigbee.removeDevice(c,function(b){a&&a({error:b})}):a&&a({error:Error("zigbee usb stick not avaliable")})};g.prototype.listDevices=function(c,a){var b=this._zigbee.getDevices();if(b){for(var d=[],e=b.length;e--;){var h=b[e].toJSON();d.push(h)}a&&a({data:d})}else a&&a({data:[]})};g.prototype.getAllStatesLegacy=function(c){for(var a=[],b=this._zigbee.getDevices(),d=b.length;d--;){var e=b[d],h=e.getConvertedStates();h&&(e={type:"ZIGBEE",adr:e.getIeeeAdr()+":"+e.getEndpointID(),state:h},a.push(e))}c&&
c({data:a})};g.prototype.executeCommandLegacy=function(c,a,b){this._zigbeeStickAvaliable?c?a?this._zigbee.executeCommand(c,a,function(a){b&&b({error:a})}):b&&b({error:Error("command invalid")}):b&&b({error:Error("address invalid")}):b&&b({error:Error("zigbee usb stick not avaliable")})};g.prototype.executeCommandNativeRaw=function(c,a){if(this._zigbeeStickAvaliable){var b=c.command,d=c.value;d&&(d=JSON.parse(d));var e=["/srv/Apps/zigbee/SYSTEM/servers/zb_con_action.bin"];e.push(b);"undefined"!=typeof d&&
null!=d&&(Array.isArray(d)?e=e.concat(d):e.push(d));this._zigbee._exec(e.join(" "),function(b,c,d){if(b)a&&a({error:b});else if(d)a&&a({error:Error(d)});else try{if(c){var e=JSON.parse(c);a&&a({data:e})}else a&&a({})}catch(g){a&&a({error:Error(c)})}})}else a&&a({error:Error("zigbee usb stick not avaliable")})};return g}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.zigbee.Handler);
