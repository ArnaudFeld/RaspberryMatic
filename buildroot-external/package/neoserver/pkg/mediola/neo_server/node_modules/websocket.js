var WebSocket=function(a){this._secure=!1;this._socket=null;this._handshakeDone=!1;a=require("url").parse(a);this._host=a.hostname;this._port=a.port;this._path=a.path;this._path||(this._path="/");"wss:"==a.protocol?(this._secure=!0,this._port||(this._port=443)):this._port||(this._port=80);this.onclose=this.onopen=this.onerror=this.onmessage=null};
WebSocket.prototype.open=function(){if(this._secure){var a=require("tls");process.env.NODE_TLS_REJECT_UNAUTHORIZED="0";var b=this;this._socket=a.connect(this._port,this._host,function(){b._socket.setEncoding("utf-8");var a="GET "+b._path+" HTTP/1.1\r\nUpgrade: websocket\r\nConnection: keep-alive, Upgrade\r\nOrigin: null\r\n";a+="Host: "+b._host+"\r\n";b._socket.write(a+"Sec-WebSocket-Key: 2P9Q2RaEAdXHSNO2zy4oqQ==\r\nSec-WebSocket-Version: 13\r\n\r\n")});this._socket.addListener("data",function(a){if(b._handshakeDone){if(a=
b._decodeWSData(a).trim(),b.onmessage&&0<a.length)b.onmessage(a)}else if(0==a.indexOf("HTTP")&&(b._handshakeDone=!0,b.onopen))b.onopen()});this._socket.addListener("error",function(a){if(b.onerror)b.onerror(a.code)});this._socket.addListener("close",function(){if(b.onclose)b.onclose();b.onmessage=null;b.onerror=null;b.onopen=null;b.onclose=null})}else this._open()};
WebSocket.prototype._open=function(){var a=this;this._socket=require("net").connect(this._port,this._host,function(){a._socket.setEncoding("utf-8");var b="GET "+a._path+" HTTP/1.1\r\nUpgrade: websocket\r\nConnection: keep-alive, Upgrade\r\nOrigin: null\r\n";b+="Host: "+a._host+"\r\n";a._socket.write(b+"Sec-WebSocket-Key: 2P9Q2RaEAdXHSNO2zy4oqQ==\r\nSec-WebSocket-Version: 13\r\n\r\n")});this._socket.addListener("data",function(b){if(a._handshakeDone){if(b=a._decodeWSData(b).trim(),a.onmessage&&0<b.length)a.onmessage(b)}else if(0==
b.indexOf("HTTP")&&(a._handshakeDone=!0,a.onopen))a.onopen()});this._socket.addListener("error",function(b){if(a.onerror)a.onerror(b.code)});this._socket.addListener("close",function(){if(a.onclose)a.onclose();a.onmessage=null;a.onerror=null;a.onopen=null;a.onclose=null})};WebSocket.prototype.send=function(a){this._socket.write(this._encodeWSData(a))};WebSocket.prototype.sendJSON=function(a){this.send(JSON.stringify(a))};
WebSocket.prototype.close=function(){this._socket.end();if(this.onclose)this.onclose();this.onclose=this.onopen=this.onerror=this.onmessage=null};
WebSocket.prototype._encodeWSData=function(a){a=new Buffer(a,"binary");var b=[],c=0;b[c++]=129;if(125>=a.length)b[c++]=a.length+128;else if(65535>=a.length)b[c++]=254,b[c++]=a.length>>8&255,b[c++]=a.length&255;else return null;for(var e=[],d=0;4>d;d++)e.push(Math.floor(255*Math.random())),b[c++]=e[d];for(d=0;d<a.length;d++)b[c++]=a[d]^e[d%4];return new Buffer(b,"binary")};WebSocket.prototype._decodeWSData=function(a){var b=a.charCodeAt(1)&127,c=2;126==b?c=4:127==b&&(c=10);return a.substr(c)};
exports.createWebSocket=function(a){return new WebSocket(a)};
