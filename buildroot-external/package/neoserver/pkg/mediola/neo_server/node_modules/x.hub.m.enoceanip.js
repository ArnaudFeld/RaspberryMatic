var util=require("util"),EventEmitter=require("events");require("x.logger.js").setLevel("trace","x.hub.m.enoceanip");require("x.logger.js").setLevel("info","xnm.aio.enoceanip");var x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.enoceanip=x.hub.m.enoceanip||{};x.hub.m.enoceanip.MODULE=require("xnm.aio.enoceanip.js");
x.hub.m.enoceanip.Monitor=function(){var e=function(a){this._logger=require("x.logger.js").getLogger("x.hub.m.enoceanip.Monitor");this._running=!1;this._data=this._stream=null;this._gateway=a;this._devices={};this._buttonEvents={}};e.prototype.start=function(a){this._logger.log("debug","start monitor for "+this._gateway.getIP()+":"+this._gateway.getPort());this._running||(this._running=!0,this._startStream());a&&a()};e.prototype.addStateDevice=function(a,b,c){if(a&&a.deviceId){var d=this._devices[a.deviceId];
d||(d={device:a,event:{}},this._devices[a.deviceId]=d);c&&c.statusKey&&(a=d.event[c.statusKey],a||(a={callbacks:[]},d.event[c.statusKey]=a),c.callback&&-1==a.callbacks.indexOf(c.callback)&&a.callbacks.push(c.callback))}b&&b()};e.prototype.removeStateDevice=function(a,b,c){if(a&&a.deviceId){var d=this._devices[a.deviceId];d&&c&&c.statusKey&&((d=d.event[c.statusKey])&&c&&c.callback&&(c=d.callbacks.indexOf(c.callback),-1!=c&&d.callbacks.splice(c,1)),d&&0!=d.callbacks.length||delete this._devices[a.deviceId])}b&&
b()};e.prototype._startStream=function(){var a=this;this._stream=this._gateway.getDevicesStream("both","newline","singleLine",function(b){a._logger.log("debug","stream for "+a._gateway.getIP()+":"+a._gateway.getPort()+" closed");a._logger.log("debug",(b?"error:"+b.message:"")+" restart stream");b?-2==b.code?a._startStream():setTimeout(function(){a._startStream()},1E3):a._startStream()});this._stream.on("header",function(a){});this._stream.on("chunk",function(b){a._data=a._data?a._data+b:b;a._resolveData()})};
e.prototype._resolveData=function(){var a=this._data.split("\n");2<=a.length&&0==a[1].length&&(this._onMessage(a[0]),a.splice(0,2),this._data=a.join("\n"),0<this._data.length&&this._resolveData())};e.prototype._onMessage=function(a){try{a=JSON.parse(a)}catch(b){return}if(a&&a.header&&"telegram"==a.header.content&&a.telegram){this._logger.log("debug","receive event:"+JSON.stringify(a.telegram));var c=this._devices[a.telegram.deviceId];if(c&&c.device&&c.device.gateway&&(a=x.hub.m.enoceanip.MODULE.resolveEvent(c.device.gateway,
c.device,a.telegram)))for(var d in a)this._produceEvent(c,d,a[d])}};e.prototype._produceEvent=function(a,b,c){var d=a.device;if(a.event&&a.event[b]){var e=a.event[b].callbacks;c={module:"enoceanip",device:d,gateway:d.gateway,data:{key:b,value:c,changed:!0}};for(d=0;d<e.length;d++){var f=e[d];if(f&&f.onEvent)f.onEvent(c)}}if("btn"==b.substr(0,3)&&b.indexOf("shortPress"==-1)&&-1==b.indexOf("longPress")){e=b.substr(3,2);c=(new Date).getTime();if(f=this._buttonEvents[a.device.deviceId])d=f.event,f=f.timestamp,
d&&f&&-1!=d.indexOf("pressed")&&-1!=b.indexOf("released")&&(1E3>c-f?this._produceEvent(a,"btn"+e+"shortPress",!0):this._produceEvent(a,"btn"+e+"longPress",!0));this._buttonEvents[a.device.deviceId]={event:b,timestamp:c}}};return e}();
x.hub.m.enoceanip.Handler=function(){var e=function(){this._monitors={}};util.inherits(e,EventEmitter);e.prototype.init=function(a){a&&a()};e.prototype.getSystems=function(){return["dcgw"]};e.prototype.addStateDevice=function(a,b,c){a?a.gateway?this._startMonitor(a.gateway,function(d,e){d?b&&b({error:d}):e.addStateDevice(a,function(a){b&&b({error:a})},c)}):b&&b(Error("device gateway format invalid")):b&&b({error:Error("device json format invalid")})};e.prototype.removeStateDevice=function(a,b,c){if(a)if(a.gateway){var d=
this._getMonitor(a.gateway);d?d.removeStateDevice(a,function(a){b&&b({error:a})},c):b&&b({})}else b&&b(Error("device gateway format invalid"));else b&&b({error:Error("device json format invalid")})};e.prototype.getAllStates=function(){return[]};e.prototype.getStates=function(a){return null};e.prototype.getState=function(a,b,c){a?a.gateway?x.hub.m.hue.HUE_MODULE.doStatus("xhub",a.gateway,a,{value:b},function(a,b){a?c&&c({error:a}):b?c&&c({data:{value:b.status}}):c&&c({error:Error("do status failed")})}):
c&&c(Error("device gateway format invalid")):c&&c({error:Error("device json format invalid")})};e.prototype.executeCommand=function(a,b,c){x.hub.m.hue.HUE_MODULE.doCommand(a.gateway,a,b,c)};e.prototype.checkDeviceMatch=function(a,b){return b&&b.device&&a&&a.device?b.device.deviceId==a.device.deviceId:!1};e.prototype._startMonitor=function(a,b){if(a){var c=x.hub.m.enoceanip.MODULE.resolveGateway(a);if(c){var d=c.getIP(),e=c.getPort();d&&e?(d=d+":"+e,this._monitors[d]?b(null,this._monitors[d]):(c=new x.hub.m.enoceanip.Monitor(c),
this._monitors[d]=c,c.start(),b(null,c))):b(Error("gateway json format invalid"))}else b(Error("gateway json format invalid"))}else b(Error("gateway json is null"))};e.prototype._getMonitor=function(a){if(a){var b=x.hub.m.enoceanip.MODULE.resolveGateway(a);if(b&&(a=b.getIP(),b=b.getPort(),a&&b))return this._monitors[a+":"+b]}};return e}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.enoceanip.Handler);
