var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.ez=xnm.aio.ez||{};
xnm.aio.ez.XS1=function(){var b=function(a,d,c){this._logger=require("x.logger.js").getLogger("xnm.aio.ez.XS1");this.ip=a;this.port=80;d&&(d=parseInt(d),0<d&&(this.port=d));this.username="admin";this.password=c?c:null;this._getDevicesCBs=[];this._deviceBuffer=null};b.prototype._doRequest=function(a,d,c){a={host:this.ip,port:this.port,path:"/control?callback=data&cmd="+a,method:"GET",headers:{Connection:"close"}};if(d)for(var b in d)d.hasOwnProperty(b)&&(a.path+="&"+b+"="+encodeURI(d[b]));this._logger.log("trace",
"send http request:"+JSON.stringify(a));this.username&&this.password&&(a.headers.Authorization="Basic "+(new Buffer(this.username+":"+this.password)).toString("base64"));var e=c,f=this,g=require("http").request(a,function(a){var c="";a.setEncoding("utf-8");a.on("data",function(a){c+=a});a.on("end",function(){f._logger.log("trace","http response code:"+a.statusCode+" body:"+c);if(200==a.statusCode)if(c=c.trim(),6>c.length||"data("!=c.substr(0,5))e&&e(Error("response fomart error:"+c)),e=null;else{for(var d=
c.substr(5),b=d.length-1;0<=b&&")"!=d.charAt(b);)--b;if(0>b)e&&e(Error("response fomart error:"+c)),e=null;else{d=d.substr(0,b);try{d=JSON.parse(d),e&&e(null,d),e=null}catch(g){e&&e(Error("response fomart error:"+c)),e=null}}}else e&&e(Error("http response code:"+a.statusCode+" "+c)),e=null})});g.setTimeout(2E3,function(){f._logger.log("trace","http request timeout");g.abort();e&&e(Error("http request timeout"));e=null});g.on("error",function(a){f._logger.log("trace","http request error:"+a.message);
e&&e(a);e=null});g.end()};b.prototype.getDevices=function(a){a||(a=function(){});var d=this._getDevicesCBs.length;-1==this._getDevicesCBs.indexOf(a)&&this._getDevicesCBs.push(a);if(0==d){var c=this;this.getActuators(function(a,d){if(a){var b=c._getDevicesCBs;c._getDevicesCBs=[];for(var g=0;g<b.length;g++)b[g]&&b[g](a)}else{var k=[];d&&(k=k.concat(d));c.getSensors(function(a,d){var b=c._getDevicesCBs,e=0;c._getDevicesCBs=[];if(a)for(e=0;e<b.length;e++)b[e]&&b[e](a);else for(d&&(k=k.concat(d)),e=0;e<
b.length;e++)b[e]&&b[e](null,k)})}})}};b.prototype.getState=function(a){var d=function(a){var c={actuator:{},sensor:{}};if(a)for(var d=0;d<a.length;d++){var b=a[d];b.address&&("actuator"==b.type?c.actuator[b.address]=b.value:"sensor"==b.type&&(c.sensor[b.address]=b.value))}return c};if(this._deviceBuffer){var c=d(this._deviceBuffer);a&&a(null,c);a=null}this.getDevices(function(c,b){if(c)a&&a(c);else{var f=d(b);a&&a(null,f);a=null}})};b.prototype.executeCommand=function(a,d,c){a.address?d?this._doRequest("set_state_actuator",
{number:a.address,"function":d},function(a){c&&c(a)}):c&&c(Error("command invalid")):c&&c(Error("address invalid"))};b.prototype.executeCommandCreator=function(a,d,c){d&&d.value&&"func"==d.value&&d.ext?this.executeCommand(a,d.ext,function(a){c&&c(a)}):c&&c(Error("command invalid"))};b.prototype.getStatesCreator=function(a,d,c){this.getState(function(a,b){if(a)c&&c(a);else{for(var f=[],g=0;g<d.length;g++){var k=d[g];if(k&&k.id&&k.device){var l=k.device;if(l.type&&l.address){var m;"actuator"==l.type?
m=b.actuator[l.address]:"sensor"==l.type&&(m=b.sensor[l.address]);"undefined"!=typeof m&&null!=m&&f.push({id:k.id,status:m})}}}c&&c(null,f)}})};b.prototype.getActuators=function(a){this._doRequest("GET_LIST_ACTUATORS",null,function(d,c){if(d)a&&a(d);else{var b=[];if(c&&c.actuator)for(var e=0;e<c.actuator.length;e++)"disabled"!=c.actuator[e].type&&b.push({sys:"xs1",type:"actuator",name:c.actuator[e].name,address:c.actuator[e].id,data:c.actuator[e].type,value:c.actuator[e].value,unit:c.actuator[e].unit,
"function":c.actuator[e]["function"]});a&&a(null,b)}})};b.prototype.getSensors=function(a){this._doRequest("GET_LIST_SENSORS",null,function(b,c){if(b)a&&a(b);else{var h=[];if(c&&c.sensor)for(var e=0;e<c.sensor.length;e++)"disabled"!=c.sensor[e].type&&h.push({sys:"xs1",type:"sensor",name:c.sensor[e].name,address:c.sensor[e].id,data:c.sensor[e].type,value:c.sensor[e].value,unit:c.sensor[e].unit});a&&a(null,h)}})};b.prototype.toJSON=function(){return{sys:"xs1",ip:this.ip,port:this.port,password:this.password}};
b.prototype.equalsTo=function(a){return a&&a instanceof b?this.ip==a.ip&&this.port==a.port&&this.password==a.password:!1};return b}();xnm.aio.ez.DMError=function(b,a){this.code=b;this.message=a;this.stack=Error().stack};xnm.aio.ez.prototype=Error();xnm.aio.ez.prototype.name="EZDMError";xnm.aio.ez.prototype.code=0;xnm.aio.ez.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};
xnm.aio.ez.DM={XS1_SYS:"xs1",getGatewayType:function(){return[{sys:this.XS1_SYS,name:"EZcontrol XS1"}]},getGatewayDeviceType:function(b){switch(b.sys){case this.XS1_SYS:return[{type:"actuator",name:"Actuator"},{type:"sensor",name:"Sensor"}];default:return null}},createGateway:function(b,a,d){a=xnm.aio.ez.DM.DMError;var c=xnm.aio.ez.DM.ERROR_CODE;b?b.ip?(b.port||(b.port=80),d(null,b)):d(new a(c.INVALID,"ip is invalid")):d(new a(c.INVALID,"info is invalid"))},updateGateway:function(b,a,d,c){b=xnm.aio.ez.DM.DMError;
d=xnm.aio.ez.DM.ERROR_CODE;a?a.ip?(a.port||(a.port=80),c(null,a)):c(new b(d.INVALID,"ip is invalid")):c(new b(d.INVALID,"update is invalid"))},deleteGateway:function(b,a,d){d()},createDevice:function(b,a,d){a=xnm.aio.ez.DMError;var c=xnm.aio.ez.DM.ERROR_CODE;b?b.type?b.address?d(null,b):d(new a(c.INVALID,"address is invalid")):d(new a(c.INVALID,"type is invalid")):d(new a(c.INVALID,"info is invalid"))},updateDevice:function(b,a,d){a=xnm.aio.ez.DMError;var c=xnm.aio.ez.DM.ERROR_CODE;b?b.type?b.address?
d(null,b):d(new a(c.INVALID,"address is invalid")):d(new a(c.INVALID,"type is invalid")):d(new a(c.INVALID,"info is invalid"))},deleteDevice:function(b,a,d){d()},getCommandStatusMap:function(b){if(!b.sys||!b.type)return null;var a={command:[],status:[{type:"float",name:"status",ref:{value:"state",ext:"%f"}}]};switch(b.sys){case this.XS1_SYS:if(b["function"])for(var d=0;d<b["function"].length;d++){var c=b["function"][d];c&&c.type&&"disabled"!=c.type&&a.command.push({type:"enum",name:c.dsc,ref:{value:"func",
ext:d+1}})}return a;default:return null}},applyUIFilter:function(b,a){var d=function(a,c){if("*"==a)return!0;for(var b=!1,d=0;d<a.length;d++)if(a[d]==c){b=!0;break}return b},c=function(a,c,b){var e=[];switch(b.catagory){case "command":a.command&&a.command.forEach(function(a){d(b.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){d(b.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},h=function(a,b){var d=[],e=
null;if(e=xnm.aio.ez.DM.getCommandStatusMap(a))e=c(e,a,b),d=d.concat(e);return d};if(!b.sys)return null;var e=JSON.parse(JSON.stringify(b)),f=null;switch(a.catagory){case "command":f=h(b,a);e.command=f;break;case "status":f=h(b,a);e.status=f;break;default:return null}return f&&0!=f.length?e:null}};
xnm.aio.ez.Handler=function(){var b=function(){};b.prototype.devicemanager=xnm.aio.ez.DM;b.prototype.XS1=xnm.aio.ez.XS1;b.prototype.registModule=function(a){a.register(this.devicemanager.XS1_SYS,"ez")};b.prototype.resolveGateway=function(a){if(!a||!a.sys||!a.ip)return null;switch(a.sys){case this.devicemanager.XS1_SYS:return new xnm.aio.ez.XS1(a.ip,a.port,a.password);default:return null}};b.prototype.getDeviceCommands=function(a,b){var c=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}),
c=c?c.command:[];b&&b(null,c)};b.prototype.getDeviceStatus=function(a,b){var c=this.devicemanager.applyUIFilter(a,{catagory:"status",elems:"*"}),c=c?c.status:[];b&&b(null,c)};b.prototype.doCommand=function(a,b,c,h){(a=this.resolveGateway(a))?a.executeCommandCreator(b,c,h):h&&h(Error("gateway json format invalid"))};b.prototype.doStatus=function(a,b,c,h,e){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:c,status:h}],function(a,b){a?e&&e(a):e&&e(null,b[0])}):e&&e(Error("gateway json format invalid"))};
b.prototype.getDeviceList=function(a,b){var c=this.resolveGateway(a);c?c.getDevices(function(a,c){b&&b(a,c)}):b&&b(Error("gateway json format invalid"))};return b}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.ez.Handler);
