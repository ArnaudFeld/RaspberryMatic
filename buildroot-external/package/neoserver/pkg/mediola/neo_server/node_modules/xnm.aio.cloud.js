var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.cloud=xnm.aio.cloud||{};xnm.aio.cloud.Server=function(){this._url="http://webservice.aio-control.com/config?"};xnm.aio.cloud.Server.prototype._doRequest=function(b,a){$.ajax({url:this._url+b,timeout:4E3,cache:!1,success:function(c){var d=null;c&&8<=c.length&&"{XC_SUC}"==c.substr(0,8)?d=8<c.length?{data:$.parseJSON(c.substr(8))}:{data:{}}:c&&8<c.length&&"{XC_ERR}"==c.substr(0,8)&&(d={error:c.substr(8)});a&&a(d)},error:function(){a&&a(null)}})};
xnm.aio.cloud.Server.prototype.doRequest=function(b,a,c){b="XC_FNC="+b;if(a)for(var d in a)b+="&"+d+"="+a[d];this._doRequest(b,c)};xnm.aio.cloud.Server.prototype.getNewSID=function(b){this._doRequest("XC_FNC=getSID",b)};xnm.aio.cloud.Server.prototype.getEleroKey=function(b,a){this._doRequest("XC_FNC=getEleroKey&SID="+b,a)};
xnm.aio.cloud.Server.prototype.setMessage=function(b,a,c,d,e,f,g){c=JSON.stringify({email:c,message:d,username:g});b=this._url+"XC_FNC=setMessage&SID="+b+"&AID="+a;f&&(b+="&sns="+f);$.ajax({type:"POST",url:b,data:{data:c},timeout:4E3,cache:!1,complete:function(c){c&&(c=c.responseText);c&&8<=c.length&&"{XC_SUC}"==c.substr(0,8)?e(!0):e(!1)}})};xnm.aio.cloud.Server.prototype.getMessage=function(b,a,c){this._doRequest("XC_FNC=getMessage&SID="+b+"&AID="+a,c)};
xnm.aio.cloud.Server.prototype.assignBeckerSeiral=function(b,a){var c=a;$.ajax({url:this._url+"/beckerserial/assign?sid="+b.toUpperCase(),timeout:4E3,dataType:"text",cache:!0,success:function(a){try{var d=JSON.parse(a);if("no more available"==d.serial){var b=Error(d.serial);b.errCode=-1;c&&c(b)}else c&&c(null,d.serial)}catch(g){c&&c(g)}c=null},error:function(a,b){a="http request error:"+(a?a.status:"0")+"-"+b;c&&c(Error(a))}})};
xnm.aio.cloud.RemotesServer=function(){this.ip="https://remotes.mediola.com";this.port=443;this.password=this.user="";this.secure=!0;this.folder="";this._finishedDownloadCallback=this._error=this._remotes=null};
xnm.aio.cloud.RemotesServer.prototype._getUpdateFile=function(b){var a=this.secure?"https://":"http://";a+=this.ip+":"+this.port+"/creatorneo/remote/requestDownload";if(this.secure)this._getUpdateFileHttps(b);else{var c=b;$.ajax({type:"GET",url:a,timeout:8E3,cache:!1,dataType:"json",headers:{Authorization:"Basic "+(new Buffer(this.user+":"+this.password)).toString("base64")},success:function(a){c&&(c(null,a,200),c=null)},error:function(a,b,f){b="HTTP request error: "+(a?a.status:"0")+"-"+b;c&&(c(Error(b),
a?a.responseText:null,a?a.status:null),c=null)}})}};
xnm.aio.cloud.RemotesServer.prototype._getUpdateFileHttps=function(b){"object"===typeof process&&null!==process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var a=b;$.ajax({type:"GET",url:"https://"+this.ip+":"+this.port+"/creatorneo/remote/requestDownload",timeout:8E3,cache:!1,dataType:"json",headers:{"Content-Type":"application/json; charset=utf-8",Authorization:"Basic "+(new Buffer(this.user+":"+this.password)).toString("base64")},success:function(c){a&&(a(null,c,200),a=null)},
error:function(c,b,e){b="HTTPS request error: "+(c?c.status:"0")+"-"+b;a&&(a(Error(b),c?c.responseText:null,c?c.status:null),a=null)}})};xnm.aio.cloud.RemotesServer.prototype._moveFromTmp=function(b,a,c){var d=require("fs"),e=d.createReadStream(b);a=d.createWriteStream(a);e.pipe(a);e.on("error",function(a){XC.debugf("[xnm.aio.cloud.RemotesServer._moveFromTmp] "+a.message,"error");c&&c(a)});e.on("end",function(){d.unlinkSync(b);c&&c()})};
xnm.aio.cloud.RemotesServer.prototype._downloadFile=function(b,a,c,d){var e=require("http"),f=require("fs"),g={fileData:c,url:{username:this.user,password:this.password}},m=this,h=null;h="object"===typeof nw?function(b,e){b?f.stat(b,function(e,k){if(e)d(e);else{if("win32"===process.platform&&(e=a.substring(a.lastIndexOf("/")+1),/[<>:"|?*]/.test(e))){e=Error('Invalid characters (<>:"|?*) in filename, which cannot be used on Windows: '+e);XC.debugf("[xnm.aio.cloud.RemotesServer._downloadFile] "+e.message,
"error");d(e);return}e=a.substring(0,a.lastIndexOf("/"));f.mkdirRecursiveSync(e);m._moveFromTmp(b,a,function(b){b?d(b):f.writeFile(a+".md5",c.md5,function(a){d(a)})})}}):d(e?e:Error("file from mediola server error"))}:function(c,b){c&&f.existsSync(c)?(b=a.substring(0,a.lastIndexOf("/")),f.mkdirRecursiveSync(b),f.renameSync(c,a),d()):d(b?b:Error("file from mediola server error"))};var l=window.XCHost&&window.XCHost.getType&&("iOS"==window.XCHost.getType()||"Android"==window.XCHost.getType());if(this._aws3Client&&
c&&c.file.match(/^resources.*/))b={Bucket:"mediola-creator",Key:"resources/"+c.ref},e=null,l||(e=require("os").tmpdir()+require("path").sep+"xcdl"+require("path").sep+Math.random().toString(36).substring(2)),this._aws3Client.getObject2File(b,e,function(a,b){a?(XC.debugf("[xnm.aio.cloud.RemoteServer._downloadFile] failed to download file from S3: "+c.file),XC.debugf("[xnm.aio.cloud.RemoteServer._downloadFile] "+a.message),h(null,Error("S3:"+a.message))):h(b)});else{var n=e.getFileAIOCloud;l&&(g={},
b+="?username="+encodeURIComponent(this.user)+"&password="+encodeURIComponent(this.password),n=e.getFileUriEncoded);n(b,g,h)}};
xnm.aio.cloud.RemotesServer.prototype._encryptFile=function(b,a){if("undefined"==typeof nw)a();else{var c=require("fs");c.readFile(b,"utf8",function(d,e){!d&&e?(d=require("m.aio.devicemanager.js"),e=require("x.crypt.js").AES.encodeString(e,d.ml_v1_info()),c.writeFile(b+".enc",e,function(d){d?(XC.debugf("[xnm.aio.cloud.RemotesServer._encryptFile] "+d.message,"error"),a&&a("crypt write file")):(c.unlinkSync(b),a&&a())})):a&&a("crypt read file")})}};
xnm.aio.cloud.RemotesServer.prototype._checkFile=function(b,a,c,d,e){for(var f=this._remotesPath+"_new/"+b+"/"+d.file,g=this.secure?"https://":"http://",m=d.ref.split("/"),h="",l=0;l<m.length;l++)h+=encodeURIComponent(m[l]),l<m.length-1&&(h+="/");g+=this.ip+":"+this.port+"/creatorneo/remote/downloadFile/"+h;var n=!1,k=require("fs"),q=this._remotesPath+"/"+b+"/"+d.file,p=this;b=d.file.indexOf(".DS_Store");-1<b&&b+9==d.file.length?e():k.readFile(q+".md5","utf8",function(b,h){if(!b&&h&&h==d.md5&&"device_db"!==
d.file)try{k.copyFileSync(q,f),k.copyFileSync(q+".md5",f+".md5"),n=!0}catch(r){XC.debugf("[xnm.aio.cloud.RemotesServer._checkFile] "+r.message,"warn")}n?e():p._downloadFile(g,f,d,function(b){var g=!0;if("device_db"==d.file&&a)g=!1,k.readFile(f,"utf8",function(b,c){!b&&c?(b=require("x.crypt.js").AES.decodeString(c,a),k.writeFile(f,b,function(a){p._encryptFile(f,e)})):e("crypt")});else if("device_db"==d.file&&c&&(g=!1,k.readFile(f,"utf8",function(a,b){if(!a&&b){var c=!1;require("xnm.aio.hm.js").discoverCCUs(function(a){if(!c){c=
!0;var d=JSON.parse(b);if(d&&d.gateways)for(var g=0;g<d.gateways.length;g++){var h=d.gateways[g];h.info&&"hm"==h.info.sys&&(h.info.uuid=a.uuid,h.info.ip=a.ip)}a=JSON.stringify(d);k.writeFile(f,a,function(a){k.existsSync(f+".md5")&&k.unlinkSync(f+".md5");p._encryptFile(f,e)})}});setTimeout(function(){c||e("noCCU")},1E3)}else e("file")})),"device_db"===d.file&&(g=!1,p._encryptFile(f,e)),g)if(b){g="[File] ";if(b instanceof Error)g+=b.message;else if("string"===typeof b)g+=b;else if("object"===typeof b)try{g+=
JSON.stringify(b)}catch(t){g+="Error object cannot be converted to string."}e(Error(g))}else e()})})};
xnm.aio.cloud.RemotesServer.prototype._downloadNextFile=function(b,a){"undefined"===typeof b&&(b=0);"undefined"===typeof a&&(a=0);0===b&&0===a&&(this._remoteNames=[]);0===this._remotes.length&&(this._remoteNames=null);if(b>=this._remotes.length)XC.debugf("[xnm.aio.cloud.RemotesServer._downloadNextFile] Downloaded all remotes."),setTimeout(function(){this._renameRemoteDir(this._remoteNames)}.bind(this),100);else{this._$progressDiv&&this._$progressDiv.text(Math.floor(this._filesDownloaded/this._filesToDownload*
100)+"%");var c=this._remotes[b];0===a&&(XC.debugf("[xnm.aio.cloud.RemotesServer._downloadNextFile] Download next remote: "+c.name),this._remoteNames.push(c.name));"function"===typeof this.cbProgress&&this.cbProgress(b,c.name,Math.floor(100*a/(c.resources.length+a)),Math.floor(this._filesDownloaded/this._filesToDownload*100));0<c.resources.length?(this._filesDownloaded++,this._checkFile(c.name,c.pwd,c.replaceCCU,c.resources[0],function(c){c?(XC.debugf("[xnm.aio.cloud.RemotesServer._downloadNextFile] Check file error: "+
c,"error"),this._error=c,this._remotes=[]):this._remotes[b].resources.splice(0,1);this._downloadNextFile(b,a+1)}.bind(this))):this._downloadNextFile(b+1,0)}};
xnm.aio.cloud.RemotesServer.prototype._renameRemoteDir=function(b){XC.debugf("[xnm.aio.cloud.RemotesServer._renameRemoteDir] Renaming directory ...");if(b){var a=require("fs"),c=this._remotesPath+"_"+(new Date).getTime();a.existsSync(this._remotesPath)&&a.renameSync(this._remotesPath,c);try{a.renameSync(this._remotesPath+"_new",this._remotesPath)}catch(d){XC.debugf(d.message),a.renameSync(c,this._remotesPath)}a.existsSync(c)&&a.rmdirRecursiveSync(c);b.sort(function(a,b){return a.localeCompare(b)})}XC.debugf("[xnm.aio.cloud.RemotesServer._renameRemoteDir] ... renamed directory.");
this._finishedDownloadCallback&&(XC.debugf("[xnm.aio.cloud.RemotesServer._renameRemoteDir] Calling callback for finished download."),this._finishedDownloadCallback(b,this._error))};
xnm.aio.cloud.RemotesServer.prototype._checkPasswords=function(){for(var b=this,a=0;a<this._remotes.length;a++){var c=this._remotes[a];if(c.encrypt&&!c.pwd){this._passwordCallback(c.name,function(d){var e=!1;null!=d?require("x.crypt.js").AES.decodeString(c.encrypt,d)==c.name?c.pwd=d:(b._remotes.splice(a,1),e=!0):(b._remotes.splice(a,1),e=!0);e&&(c.pwdFailed=!0);b._checkPasswords()});return}}for(a=this._filesToDownload=this._filesDownloaded=0;a<this._remotes.length;a++)this._filesToDownload+=this._remotes[a].resources.length;
this._downloadNextFile(0,0)};
xnm.aio.cloud.RemotesServer.prototype.updateRemotes=function(b,a,c){this._error=null;this._passwordCallback=c;this._$progressDiv=b;b=require("fs");this._remotesPath="object"===typeof nw?require("path").join(nw.App.dataPath,"..","remotes"):b.dataPath()+"/remotes";try{b.mkdirRecursiveSync(this._remotesPath)}catch(d){XC.debugf('[xnm.aio.cloud.RemotesServer.updateRemotes] Failed to mkdir: "'+this._remotesPath+'". Error: '+d.message,"error")}try{b.mkdirRecursiveSync(this._remotesPath+"_new")}catch(d){XC.debugf('[xnm.aio.cloud.RemotesServer.updateRemotes] Failed to mkdir: "'+
this._remotesPath+'_new". Error: '+d.message)}this._getUpdateFile(function(b,c,f){this._aws3Client=null;b?a&&a(null,Error("[File List] "+b.message),f):c&&"error"==c.classid?a&&a(null,c.code,f):c&&c.infos?(c.credential&&(b=require("x.aws"))&&(this._aws3Client=b.getS3Client(c.credential)),this._remotes=c.infos,this._finishedDownloadCallback=function(b,c){this._aws3Client&&this._aws3Client.release();a&&a(b,c)}.bind(this),this._checkPasswords()):a&&a(null,null,f)}.bind(this))};xnm.aio.cloud.Handler=function(){XC.debugf("xnm.aio.cloud.Handler created")};
xnm.aio.cloud.Handler.prototype.Server=xnm.aio.cloud.Server;xnm.aio.cloud.Handler.prototype.RemotesServer=xnm.aio.cloud.RemotesServer;"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.cloud.Handler);
