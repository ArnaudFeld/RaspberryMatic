var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.cloud=xnm.aio.cloud||{};xnm.aio.cloud.Server=function(){this._url="http://webservice.aio-control.com/config?"};xnm.aio.cloud.Server.prototype._doRequest=function(a,c){$.ajax({url:this._url+a,timeout:4E3,cache:!1,success:function(b){var a=null;b&&8<=b.length&&"{XC_SUC}"==b.substr(0,8)?a=8<b.length?{data:$.parseJSON(b.substr(8))}:{data:{}}:b&&8<b.length&&"{XC_ERR}"==b.substr(0,8)&&(a={error:b.substr(8)});c&&c(a)},error:function(){c&&c(null)}})};
xnm.aio.cloud.Server.prototype.doRequest=function(a,c,b){a="XC_FNC="+a;if(c)for(var d in c)a+="&"+d+"="+c[d];this._doRequest(a,b)};xnm.aio.cloud.Server.prototype.getNewSID=function(a){this._doRequest("XC_FNC=getSID",a)};xnm.aio.cloud.Server.prototype.getEleroKey=function(a,c){this._doRequest("XC_FNC=getEleroKey&SID="+a,c)};
xnm.aio.cloud.Server.prototype.setMessage=function(a,c,b,d,e,f,g){b=JSON.stringify({email:b,message:d,username:g});a=this._url+"XC_FNC=setMessage&SID="+a+"&AID="+c;f&&(a+="&sns="+f);$.ajax({type:"POST",url:a,data:{data:b},timeout:4E3,cache:!1,complete:function(b){b&&(b=b.responseText);b&&8<=b.length&&"{XC_SUC}"==b.substr(0,8)?e(!0):e(!1)}})};xnm.aio.cloud.Server.prototype.getMessage=function(a,c,b){this._doRequest("XC_FNC=getMessage&SID="+a+"&AID="+c,b)};
xnm.aio.cloud.Server.prototype.assignBeckerSeiral=function(a,c){var b=c;$.ajax({url:this._url+"/beckerserial/assign?sid="+a.toUpperCase(),timeout:4E3,dataType:"text",cache:!0,success:function(c){try{var a=JSON.parse(c);if("no more available"==a.serial){var f=Error(a.serial);f.errCode=-1;b&&b(f)}else b&&b(null,a.serial)}catch(g){b&&b(g)}b=null},error:function(a,c){var f="http request error:"+(a?a.status:"0")+"-"+c;b&&b(Error(f))}})};
xnm.aio.cloud.RemotesServer=function(){this.ip="https://remotes.mediola.com";this.port=443;this.password=this.user="";this.secure=!0;this.folder="";this._finishedDownloadCallback=this._error=this._remotes=null};
xnm.aio.cloud.RemotesServer.prototype._getUpdateFile=function(a){var c=this.secure?"https://":"http://",c=c+(this.ip+":"+this.port+"/creatorneo/remote/requestDownload");if(this.secure)this._getUpdateFileHttps(a);else{var b=a;$.ajax({type:"GET",url:c,timeout:8E3,cache:!1,dataType:"json",headers:{Authorization:"Basic "+(new Buffer(this.user+":"+this.password)).toString("base64")},success:function(a){b&&(b(null,a,200),b=null)},error:function(a,c,f){c="HTTP request error: "+(a?a.status:"0")+"-"+c;b&&
(b(Error(c),a?a.responseText:null,a?a.status:null),b=null)}})}};
xnm.aio.cloud.RemotesServer.prototype._getUpdateFileHttps=function(a){"object"===typeof process&&null!==process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var c=a;$.ajax({type:"GET",url:"https://"+this.ip+":"+this.port+"/creatorneo/remote/requestDownload",timeout:8E3,cache:!1,dataType:"json",headers:{"Content-Type":"application/json; charset=UTF8",Authorization:"Basic "+(new Buffer(this.user+":"+this.password)).toString("base64")},success:function(b){c&&(c(null,b,200),c=null)},error:function(b,
a,e){console.error(e,a,b.status,b.responseText);a="HTTPS request error: "+(b?b.status:"0")+"-"+a;c&&(c(Error(a),b?b.responseText:null,b?b.status:null),c=null)}})};xnm.aio.cloud.RemotesServer.prototype._moveFromTmp=function(a,c,b){var d=require("fs"),e=d.createReadStream(a);c=d.createWriteStream(c);e.pipe(c);e.on("error",function(a){XC.debugf(a.message);b&&b(a)});e.on("end",function(){d.unlinkSync(a);b&&b()})};
xnm.aio.cloud.RemotesServer.prototype._downloadFile=function(a,c,b,d){var e=require("http"),f=require("fs"),g={fileData:b,url:{username:this.user,password:this.password}},m=this,h=function(a,e){if(a&&f.existsSync(a)){var g=c.substring(0,c.lastIndexOf("/"));f.mkdirRecursiveSync(g);f.createReadStream&&f.createWriteStream?m._moveFromTmp(a,c,function(a){a?d(a):(f.writeFile(c+".md5",b.md5),d())}):(f.renameSync(a,c),d())}else d(e?e:Error("file from mediola server error"))},l=window.XCHost&&window.XCHost.getType&&
("iOS"==window.XCHost.getType()||"Android"==window.XCHost.getType());if(this._aws3Client&&b&&b.file.match(/^resources.*/))a={Bucket:"mediola-creator",Key:"resources/"+b.ref},e=null,l||(e=require("os").tmpdir()+require("path").sep+"xcdl"+require("path").sep+Math.random().toString(36).substring(2)),this._aws3Client.getObject2File(a,e,function(a,c){a?(XC.debugf("[xnm.aio.cloud.RemoteServer._downloadFile] failed to download file from S3: "+b.file),XC.debugf("[xnm.aio.cloud.RemoteServer._downloadFile] "+
a.message),h(null,Error("S3:"+a.message))):h(c)});else{var n=e.getFileAIOCloud;l&&(g={},a+="?username="+encodeURIComponent(this.user)+"&password="+encodeURIComponent(this.password),n=e.getFileUriEncoded);n(a,g,h)}};
xnm.aio.cloud.RemotesServer.prototype._encryptFile=function(a,c){if("undefined"==typeof nw)c();else{var b=require("fs");b.readFile(a,"utf8",function(d,e){if(!d&&e){var f=require("m.aio.devicemanager.js"),f=require("x.crypt.js").AES.encodeString(e,f.ml_v1_info());b.writeFile(a+".enc",f,function(d){d?(console.error(d),c&&c("crypt write file")):(b.unlinkSync(a),c&&c())})}else c&&c("crypt read file")})}};
xnm.aio.cloud.RemotesServer.prototype._checkFile=function(a,c,b,d,e){for(var f=this._remotesPath+"_new/"+a+"/"+d.file,g=this.secure?"https://":"http://",m=d.ref.split("/"),h="",l=0;l<m.length;l++)h+=encodeURIComponent(m[l]),l<m.length-1&&(h+="/");var g=g+(this.ip+":"+this.port+"/creatorneo/remote/downloadFile/"+h),n=!1,k=require("fs"),q=this._remotesPath+"/"+a+"/"+d.file,p=this;a=d.file.indexOf(".DS_Store");-1<a&&a+9==d.file.length?e():k.readFile(q+".md5","utf8",function(a,h){!a&&h&&h==d.md5&&"device_db"!==
d.file&&(k.copyFileSync(q,f),k.copyFileSync(q+".md5",f+".md5"),n=!0);n?e():p._downloadFile(g,f,d,function(a){var g=!0;"device_db"==d.file&&c&&(g=!1,k.readFile(f,"utf8",function(a,b){if(!a&&b){var d=require("x.crypt.js").AES.decodeString(b,c);k.writeFile(f,d,function(a){p._encryptFile(f,e)})}else e("crypt")}));"device_db"==d.file&&b&&(g=!1,k.readFile(f,"utf8",function(a,b){if(!a&&b){var c=!1;require("xnm.aio.hm.js").discoverCCUs(function(a){if(!c){c=!0;var d=JSON.parse(b);if(d&&d.gateways)for(var g=
0;g<d.gateways.length;g++){var h=d.gateways[g];h.info&&"hm"==h.info.sys&&(h.info.uuid=a.uuid,h.info.ip=a.ip)}a=JSON.stringify(d);k.writeFile(f,a,function(a){k.existsSync(f+".md5")&&k.unlinkSync(f+".md5");p._encryptFile(f,e)})}});setTimeout(function(){c||e("noCCU")},1E3)}else e("file")}));"device_db"===d.file&&(g=!1,p._encryptFile(f,e));g&&(a?e(Error("[File] "+a.message)):e())})})};
xnm.aio.cloud.RemotesServer.prototype._downloadNextFile=function(a,c){"undefined"===typeof a&&(a=0);"undefined"===typeof c&&(c=0);0===a&&0===c&&(this._remoteNames=[]);0===this._remotes.length&&(this._remoteNames=null);if(a>=this._remotes.length)XC.debugf("[xnm.aio.cloud] downloaded all remotes"),setTimeout(function(){this._renameRemoteDir(this._remoteNames)}.bind(this),100);else{this._$progressDiv&&this._$progressDiv.text(Math.floor(this._filesDownloaded/this._filesToDownload*100)+"%");var b=this._remotes[a];
0===c&&(XC.debugf("[xnm.aio.cloud] download next remote: "+b.name),this._remoteNames.push(b.name));0<b.resources.length?(this._filesDownloaded++,this._checkFile(b.name,b.pwd,b.replaceCCU,b.resources[0],function(b){b?(XC.debugf("ERROR: "+b),this._error=b,this._remotes=[]):this._remotes[a].resources.splice(0,1);this._downloadNextFile(a,c+1)}.bind(this))):this._downloadNextFile(a+1,0)}};
xnm.aio.cloud.RemotesServer.prototype._renameRemoteDir=function(a){XC.debugf("[xnm.aio.cloud] rename remote dir ...");if(a){var c=require("fs"),b=this._remotesPath+"_"+(new Date).getTime();c.existsSync(this._remotesPath)&&c.renameSync(this._remotesPath,b);try{c.renameSync(this._remotesPath+"_new",this._remotesPath)}catch(d){XC.debugf(d.message),c.renameSync(b,this._remotesPath)}c.existsSync(b)&&c.rmdirRecursiveSync(b);a.sort(function(a,b){return a.localeCompare(b)})}XC.debugf("[xnm.aio.cloud] ... renamed remote dir.");
this._finishedDownloadCallback&&(XC.debugf("[xnm.aio.cloud] calling callback for finished download"),this._finishedDownloadCallback(a,this._error))};
xnm.aio.cloud.RemotesServer.prototype._checkPasswords=function(a,c){for(var b=0;b<this._remotes.length;b++)if(this._remotes[b].encrypt&&!this._remotes[b].pwd){var d=this;this._passwordCallback(this._remotes[b].name,function(a){null!=a?require("x.crypt.js").AES.decodeString(d._remotes[b].encrypt,a)==d._remotes[b].name&&(d._remotes[b].pwd=a):d._remotes.splice(b,1);d._checkPasswords()});return}for(b=this._filesToDownload=this._filesDownloaded=0;b<this._remotes.length;b++)this._filesToDownload+=this._remotes[b].resources.length;
this._downloadNextFile(0,0)};
xnm.aio.cloud.RemotesServer.prototype.updateRemotes=function(a,c,b){this._error=null;this._passwordCallback=b;this._$progressDiv=a;a=require("fs");this._remotesPath=a.dataPath()+"/remotes";try{a.mkdirRecursiveSync(this._remotesPath)}catch(d){XC.debugf('[xnm.aio.cloud] Failed to mkdir: "'+this._remotesPath+'". Error: '+d.message)}try{a.mkdirRecursiveSync(this._remotesPath+"_new")}catch(e){XC.debugf('[xnm.aio.cloud] Failed to mkdir: "'+this._remotesPath+'_new". Error: '+e.message)}this._getUpdateFile(function(a,
b,d){this._aws3Client=null;a?c&&c(null,Error("[File List] "+a.message),d):b&&"error"==b.classid?c&&c(null,b.code,d):b&&b.infos?(b.credential&&(a=require("x.aws"))&&(this._aws3Client=a.getS3Client(b.credential)),this._remotes=b.infos,this._finishedDownloadCallback=function(a,b){this._aws3Client&&this._aws3Client.release();c&&c(a,b)}.bind(this),this._checkPasswords()):c&&c(null,null,d)}.bind(this))};xnm.aio.cloud.Handler=function(){XC.debugf("xnm.aio.cloud.Handler created")};
xnm.aio.cloud.Handler.prototype.Server=xnm.aio.cloud.Server;xnm.aio.cloud.Handler.prototype.RemotesServer=xnm.aio.cloud.RemotesServer;"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.cloud.Handler);
