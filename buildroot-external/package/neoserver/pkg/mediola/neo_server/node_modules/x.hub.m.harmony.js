var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{},x.hub.m=x.hub.m||{},x.hub.m.harmony=x.hub.m.harmony||{},x.hub.m.harmony.HARMONY_MODULE=require("xnm.aio.harmony.js"),x.hub.m.harmony.Monitor=function(){var t=function t(e,i){this._logger=require("x.logger.js").getLogger("x.hub.m.harmony.Monitor");var r=this;this._state=t.STATE.IDLE,this._hub=e,this._monitorListener={onData:function onData(t,e){r.onData(t,e);},onClose:function onClose(){r.onClose();}},this._autoreconn=i,this._reconnectTO=null,this._getActivityStateCallbacks=[],this._activities={};};return t.STATE={IDLE:0,CONNECTING:1,CONNECTED:2,WAITING_RECONN:3},t.prototype.addStateDevice=function(t,e){if(t&&t.id&&t.type){if("Activity"==t.type){var i=t.id;this._activities[i]?e&&e():this.getStates(t,e);}else e&&e(new Error("device type:"+t.type+" has no status"));}else e&&e(new Error("device json invalid"));},t.prototype.getStates=function(t,e){if(t&&t.id&&t.type){if("Activity"==t.type){var i=t.id;this._activities[i]||(this._activities[i]={device:t,states:{state:{value:"?",time:-1}}});var r=this;this._getActivityState(function(i){i?e&&e(i):e&&e(null,r.getBufferedStates(t));});}else e&&e(new Error("device type:"+t.type+" has no status"));}else e&&e(new Error("device json invalid"));},t.prototype.getBufferedStates=function(t){if(!t||!t.id||!t.type)return null;if("Activity"!=t.type)return null;var e=t.id;return this._activities[e]&&this._activities[e].states?this._activities[e].states:{state:null};},t.prototype.getAllBufferedStates=function(){var t=[];for(var e in this._activities)if(this._activities.hasOwnProperty(e)){var i=this._activities[e];i&&i.device&&i.states&&t.push({device:i.device,states:i.states});}return t;},t.prototype.executeCommand=function(e,i,r){switch(this._state){case t.STATE.WAITING_RECONN:case t.STATE.IDLE:case t.STATE.CONNECTING:return void(r&&r(new Error("monitor not connected")));}this._hub.executeCommandCreator(e,i,function(t){r&&r(t);});},t.prototype.start=function(e){this._logger.log("debug","start monitor for:"+this._hub.ip);var i=this;this._state=t.STATE.CONNECTING,this._hub.setMonitorListener(this._monitorListener),this._hub.startMonitor(function(r){r?(i._logger.log("debug","monitor connected err:"+r.message),i._autoreconn?(i._state=t.STATE.WAITING_RECONN,i._reconnect(1e4)):i._state=t.STATE.IDLE):(i._logger.log("debug","monitor connected:"+i._hub.ip),i._state=t.STATE.CONNECTED,i._initStates()),e&&e(r);});},t.prototype._reconnect=function(t){this._logger.log("trace","reconnect monitor:"+this._hub.ip),this._reconnectTO&&(clearTimeout(this._reconnectTO),this._reconnectTO=null);var e=this;t?this._reconnectTO=setTimeout(function(){e.start();},t):e.start();},t.prototype._initStates=function(t){this._getActivityState(t);},t.prototype._getActivityState=function(e){switch(this._state){case t.STATE.WAITING_RECONN:case t.STATE.IDLE:case t.STATE.CONNECTING:return void(e&&e(new Error("monitor not connected")));}var i=this._getActivityStateCallbacks.length;if(e||(e=function e(){}),-1==this._getActivityStateCallbacks.indexOf(e)&&this._getActivityStateCallbacks.push(e),!i){var r=this;this._hub.getCurrentActivity(function(t,e){t||-1==e||r._updateActivityBuffer(e,"RUNNING");var i=r._getActivityStateCallbacks;r._getActivityStateCallbacks=[],i.forEach(function(i){i&&i(t,e);});});}},t.prototype._updateActivityBuffer=function(t,e){var i=!1,r=null,o=null;if(-1==t)return this._produceEvent(-1,{value:"?",time:-1},{value:"allOff",time:new Date().getTime()}),void this._produceEvent(-1,{value:"?",time:-1},{value:"off",time:new Date().getTime()});for(var a in this._activities)if(this._activities.hasOwnProperty(a)){var n=this._activities[a];if(n.states||(n.states={state:{}}),r=n.states.state,-1==a)continue;t!=a?"on"==r.value&&(n.lastStatus="NO_ACTIVITY",o={value:this._resolveState("NO_ACTIVITY"),time:new Date().getTime()},n.states.state=o,this._produceEvent(a,r,o)):(n.lastStatus=e,i=!0,o={value:this._resolveState(e),time:new Date().getTime()},n.states.state=o,this._produceEvent(a,r,o));}i||-1==t||(o={value:this._resolveState(e),time:new Date().getTime()},this._activities[t]={activity:null,states:{state:o},lastStatus:e},this._produceEvent(t,r,o));},t.prototype._produceEvent=function(t,e,i){var r=this._activities[t]?this._activities[t].device:null;if(r&&e){var o={key:"state"};o.value=i.value,o.oldvalue=e.value,o.changed=o.value!=o.oldvalue;var a=require("x.hub.eventbus.js");if(o.changed){var n={key:"event",value:i.value,oldvalue:e.value,changed:!0};a.emit("status",{module:"harmony",device:r,gateway:r.gateway,data:n});}}},t.prototype._resolveState=function(t){var e="?";switch(t){case"RUNNING":case"STARTING":e="on";break;default:e="off";}return e;},t.prototype.onData=function(t,e){e&&(this._logger.log("trace","receive notify:"+JSON.stringify(e)),this._updateActivityBuffer(e.activityId,e.activityStatus));},t.prototype.onClose=function(){this._logger.log("debug","monitor closed:"+this._hub.ip),this._reconnect();},t;}(),x.hub.m.harmony.Handler=function(){var t=function t(){this._monitors={};};return util.inherits(t,EventEmitter),t.prototype.init=function(t){t&&t();},t.prototype.getSystems=function(){return["harmony"];},t.prototype.addStateDevice=function(t,e){t?t.gateway?this._startMonitor(t.gateway,function(i,r){i?e&&e({error:i}):r.addStateDevice(t,function(t){e&&e({error:t});});}):e&&e(new Error("device gateway format invalid")):e&&e({error:new Error("device json format invalid")});},t.prototype.getAllStates=function(){var t=[];for(var e in this._monitors)if(this._monitors.hasOwnProperty(e)){var i=this._monitors[e].getAllBufferedStates();i&&(t=t.concat(i));}return t;},t.prototype.getStates=function(t){if(!t||!t.gateway||!t.gateway.ip)return null;var e=this._monitors[t.gateway.ip];return e?e.getBufferedStates(t):(this._startMonitor(t.gateway,function(e,i){e||i.addStateDevice(t,function(t){});}),null);},t.prototype.getState=function(t,e,i){t?t.gateway?this._startMonitor(t.gateway,function(r,o){if(r)i&&i({error:r});else{var a=o.getBufferedStates(t);a?null==a[e]?o.getStates(t,function(t,r){t?i&&i({error:t}):r&&r[e]?i&&i({data:r[e]}):i&&i({error:new Error("get states result invalid")});}):i&&i({data:a[e]}):i&&i({error:r});}}):i&&i(new Error("device gateway format invalid")):i&&i({error:new Error("device json format invalid")});},t.prototype.executeCommand=function(t,e,i){t?e?t.gateway?this._startMonitor(t.gateway,function(r,o){r?i&&i({error:r}):o.executeCommand(t,e,function(t){i&&i({error:t});});}):i&&i({error:new Error("gateway is null")}):i&&i({error:new Error("command invalid")}):i&&i({error:new Error("device is null")});},t.prototype.checkDeviceMatch=function(t,e){return!!(e&&e.device&&t&&t.device&&e.gateway&&t.gateway&&e.gateway.ip==t.gateway.ip&&e.device.id==t.device.id);},t.prototype._startMonitor=function(t,e){if(t&&t.ip){var i=t.ip;if(this._monitors[i])e&&e(null,this._monitors[i]);else{var r=x.hub.m.harmony.HARMONY_MODULE.resolveGateway(t);if(r){var o=new x.hub.m.harmony.Monitor(r,!0);this._monitors[i]=o,o.start(),e&&e(null,o);}else e&&e(new Error("harmony hub format invalid"));}}else e&&e(new Error("harmony hub format invalid"));},t;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.harmony.Handler());