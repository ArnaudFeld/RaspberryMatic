var x=x||{};x.hub=x.hub||{};x.hub.macroman=x.hub.macroman||{};
x.hub.macroman.MacroManager=function(a,c){a=function(b,d){this._logger=require("x.logger.js").getLogger("x.hub.macroman.MacroManager");this._handler=this._tenant=null;this._folder=b;this._folder||(this._folder="db");this._tenantIdx=d;this._tenantIdx||(this._tenantIdx=1)};a.prototype.init=function(b,d){this._logger.log("info","init macro managaer");var h=require("m.aio.configmanager.js"),a=require("m.aio.macromanager.js");b=this._generateTenantParent(b);this._tenant=new h.Tenant(b);this._tenant.index=
this._tenantIdx;this._tenant.license="dummy";this._tenant.folder=this._folder;this._handler=new a.Handler(this._tenant);var c=this;require("fs-extra").ensureDir(this._tenant.getFolderPath(),function(){c._load(d)})};a.prototype.execute=function(b,d,a,c,e){this._handler.execute(b,d,a,c,e)};a.prototype.reload=function(b){this._load(b)};a.prototype._load=function(b){var d=this;this._handler._loadMacros(function(a){a&&d._logger.log("warn","init macro error:"+a.message);b&&b(a)})};a.prototype._generateTenantParent=
function(b){return{fileManager:b,getFolderPath:function(){return this.fileManager.getUserRootDataPath()},getFolder:function(){return""}}};a.prototype.findMacro=function(b,a,c){this._handler.findMacro(b,a,c)};a.prototype.findMacroIdx=function(b,a,c){this._handler.findMacroIdx(b,a,c)};return a}();x.hub.macroman.Handler=function(){this.macroManager=new x.hub.macroman.MacroManager("db",1);this.macroManager2=new x.hub.macroman.MacroManager("db2",2)};x.hub.macroman.Handler.prototype.MacroManager=x.hub.macroman.MacroManager;
x.hub.macroman.Handler.prototype.init=function(a,c,b){this._config(a);var d=this;this.macroManager.init(c,function(){d.macroManager2.init(c,b)})};
x.hub.macroman.Handler.prototype._config=function(a){var c=this;a.use("/xhub/macromanager/:tenantIdx",function(b,a){var d=b.method.toLowerCase(),g=b.url,e=g.indexOf("?");-1!=e&&(g=g.substr(0,e));e=b.query;b=b.body;var f=null;switch(d){case "get":f="read";break;case "post":f="create";break;case "put":f="update";break;case "delete":f="delete"}f?c.macroManager.execute(f,g,e,b,function(b,d){b?a.send(this.error2json(b)):d.toJSON&&"function"==typeof d.toJSON?a.send(d.toJSON()):a.send(d)}.bind(this)):(d=
Error("invalid http method"),d.code=500,a.send(this.error2json(d)))}.bind(this))};x.hub.macroman.Handler.prototype.execute=function(a,c,b,d){this.macroManager.findMacro(a,c,function(a,c){a?b&&b({error:a}):require("x.hub.commandman.js").commandHandler.executeMacro(c,function(a){b&&b(a)},d)})};x.hub.macroman.Handler.prototype.cancel=function(a,c){require("x.hub.commandman.js").commandHandler.cancelMacro(a,function(b){c&&c(b)})};
x.hub.macroman.Handler.prototype.executeWithIdx=function(a,c,b){this.macroManager.findMacroIdx(a,c,function(a,c){a?b&&b({error:a}):require("x.hub.commandman.js").commandHandler.executeMacro(c,function(a){b&&b(a)})})};x.hub.macroman.Handler.prototype.execute2=function(a,c,b){this.macroManager2.findMacro(a,c,function(a,c){a?b&&b({error:a}):require("x.hub.commandman.js").commandHandler2.executeMacro(c,function(a){b&&b(a)})})};
x.hub.macroman.Handler.prototype.executeWithIdx2=function(a,c,b){this.macroManager2.findMacroIdx(a,c,function(a,c){a?b&&b({error:a}):require("x.hub.commandman.js").commandHandler2.executeMacro(c,function(a){b&&b(a)})})};module.exports=new x.hub.macroman.Handler;
