var x=x||{};x.hub=x.hub||{};x.hub.macroman=x.hub.macroman||{};
x.hub.macroman.MacroManager=function(c,d){var a=function(a,b){this._logger=require("x.logger.js").getLogger("x.hub.macroman.MacroManager");this._handler=this._tenant=null;this._folder=a;this._folder||(this._folder="db");this._tenantIdx=b;this._tenantIdx||(this._tenantIdx=1)};a.prototype.init=function(a,b){this._logger.log("info","init macro managaer");var e=require("m.aio.configmanager.js"),d=require("m.aio.macromanager.js"),c=this._generateTenantParent(a);this._tenant=new e.Tenant(c);this._tenant.index=
this._tenantIdx;this._tenant.license="dummy";this._tenant.folder=this._folder;this._handler=new d.Handler(this._tenant);var f=this;require("fs-extra").ensureDir(this._tenant.getFolderPath(),function(){f._load(b)})};a.prototype.execute=function(a,b,e,d,c){this._handler.execute(a,b,e,d,c)};a.prototype.reload=function(a){this._load(a)};a.prototype._load=function(a){var b=this;this._handler._loadMacros(function(e){e&&b._logger.log("warn","init macro error:"+e.message);a&&a(e)})};a.prototype._generateTenantParent=
function(a){return{fileManager:a,getFolderPath:function(){return this.fileManager.getUserRootDataPath()},getFolder:function(){return""}}};a.prototype.findMacro=function(a,b,e){this._handler.findMacro(a,b,e)};a.prototype.findMacroIdx=function(a,b,e){this._handler.findMacroIdx(a,b,e)};return a}();x.hub.macroman.Handler=function(){this.macroManager=new x.hub.macroman.MacroManager("db",1);this.macroManager2=new x.hub.macroman.MacroManager("db2",2)};x.hub.macroman.Handler.prototype.MacroManager=x.hub.macroman.MacroManager;
x.hub.macroman.Handler.prototype.init=function(c,d,a){this._config(c);var h=this;this.macroManager.init(d,function(){h.macroManager2.init(d,a)})};
x.hub.macroman.Handler.prototype._config=function(c){var d=this;c.use("/xhub/macromanager/:tenantIdx",function(a,c){var b=a.method.toLowerCase(),e=a.url,g=e.indexOf("?");-1!=g&&(e=e.substr(0,g));var g=a.query,k=a.body,f=null;switch(b){case "get":f="read";break;case "post":f="create";break;case "put":f="update";break;case "delete":f="delete"}f?d.macroManager.execute(f,e,g,k,function(a,b){a?c.send(this.error2json(a)):b.toJSON&&"function"==typeof b.toJSON?c.send(b.toJSON()):c.send(b)}.bind(this)):(b=
Error("invalid http method"),b.code=500,c.send(this.error2json(b)))}.bind(this))};x.hub.macroman.Handler.prototype.execute=function(c,d,a,h){this.macroManager.findMacro(c,d,function(b,e){b?a&&a({error:b}):require("x.hub.commandman.js").commandHandler.executeMacro(e,function(b){a&&a(b)},h)})};x.hub.macroman.Handler.prototype.cancel=function(c,d){require("x.hub.commandman.js").commandHandler.cancelMacro(c,function(a){d&&d(a)})};
x.hub.macroman.Handler.prototype.executeWithIdx=function(c,d,a){this.macroManager.findMacroIdx(c,d,function(c,b){c?a&&a({error:c}):require("x.hub.commandman.js").commandHandler.executeMacro(b,function(b){a&&a(b)})})};x.hub.macroman.Handler.prototype.execute2=function(c,d,a){this.macroManager2.findMacro(c,d,function(c,b){c?a&&a({error:c}):require("x.hub.commandman.js").commandHandler2.executeMacro(b,function(b){a&&a(b)})})};
x.hub.macroman.Handler.prototype.executeWithIdx2=function(c,d,a){this.macroManager2.findMacroIdx(c,d,function(c,b){c?a&&a({error:c}):require("x.hub.commandman.js").commandHandler2.executeMacro(b,function(b){a&&a(b)})})};module.exports=new x.hub.macroman.Handler;
