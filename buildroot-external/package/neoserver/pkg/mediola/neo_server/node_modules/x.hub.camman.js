var x=x||{};x.hub=x.hub||{};x.hub.camman=x.hub.camman||{};
x.hub.camman.CamManager=function(){var b=function(){this._logger=require("x.logger.js").getLogger("x.hub.x.hub.camman.CamManager");this._folder=null};b.prototype.init=function(a,d){this._logger.log("info","init cam managaer");var c=require("fs-extra"),b=require("path"),e=a.getUserRootDataPath();this._folder=b.resolve(e,"cam");c.ensureDir(this._folder,function(){d&&d()})};b.prototype.saveSnapshot=function(a,d,c){if(a&&a.deviceName&&d){var b=require("fs-extra"),e=require("path"),f=e.resolve(this._folder,
a.deviceName);b.ensureDir(f,function(a){a?c&&c(a):(a=new Date,a=a.getFullYear()+"-"+(a.getMonth()+1)+"-"+a.getDate()+"_"+a.getHours()+":"+a.getMinutes()+":"+a.getSeconds(),a=e.resolve(f,a+".jpg"),b.move(d,a,{clobber:!0},function(a){c&&c(a)}))})}else c&&c(Error("argument error"))};b.prototype.getSnapshot=function(a,d,c){a=require("path").resolve(this._folder,a,d);c&&c(null,a)};b.prototype.getSnapshots=function(a){var d=require("fs-extra"),c=require("path"),b=this;d.readdir(this._folder,function(e,
f){if(e)a&&a(e);else{var h={},g=0,l=function(e,k){h[f[g]]=!e&&k?k:[];g++;g==f.length?a&&a(null,h):d.readdir(c.resolve(b._folder,f[g]),l)};d.readdir(c.resolve(b._folder,f[g]),l)}})};return b}();
x.hub.camman.Handler=function(){var b=function(){this.camManager=new x.hub.camman.CamManager};b.prototype.DeviceManager=x.hub.camman.CamManager;b.prototype.init=function(a,d,c){this._config(a);this.camManager.init(d,c)};b.prototype.saveSnapshot=function(a,d,c){this.camManager.saveSnapshot(a,d,c)};b.prototype._config=function(a){a.use("/xhub/cammanager/snapshots",function(a,c){this.camManager.getSnapshots(function(a,b){c.json(this._toRestfulResponse(a,b))}.bind(this))}.bind(this));a.use("/xhub/cammanager/snapshot",
function(a,c){var b=a.query.cam,e=a.query.file;b&&e?this.camManager.getSnapshot(b,e,function(a,b){a?c.status(404).end():c.sendFile(b,function(a){a&&a.statusCode&&c.status(a.statusCode).end(a.message)})}.bind(this)):c.status(404).end()}.bind(this))};b.prototype._toRestfulResponse=function(a,b){return a?{status:"fail",message:a.message,code:a.code?a.code:0}:{status:"success",data:b}};return b}();module.exports=new x.hub.camman.Handler;
