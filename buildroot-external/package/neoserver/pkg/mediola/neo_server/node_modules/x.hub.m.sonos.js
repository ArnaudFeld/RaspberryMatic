var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.checkStringArgs=function(d,a,c){if(null==d)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(a instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return d+""};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(d,a,c){d!=Array.prototype&&d!=Object.prototype&&(d[a]=c.value)};$jscomp.getGlobal=function(d){d=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,d];for(var a=0;a<d.length;++a){var c=d[a];if(c&&c.Math==Math)return c}return globalThis};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(d,a,c,b){if(a){c=$jscomp.global;d=d.split(".");for(b=0;b<d.length-1;b++){var e=d[b];e in c||(c[e]={});c=c[e]}d=d[d.length-1];b=c[d];a=a(b);a!=b&&null!=a&&$jscomp.defineProperty(c,d,{configurable:!0,writable:!0,value:a})}};
$jscomp.polyfill("String.prototype.repeat",function(d){return d?d:function(a){var c=$jscomp.checkStringArgs(this,null,"repeat");if(0>a||1342177279<a)throw new RangeError("Invalid count value");a|=0;for(var b="";a;)if(a&1&&(b+=c),a>>>=1)c+=c;return b}},"es6","es3");var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.sonos=x.hub.m.sonos||{};x.hub.m.sonos.MODULE=require("xnm.aio.sonos.js");
x.hub.m.sonos.AudioPlayer=function(){var d=function(){this._process={}};d.prototype.playFile=function(a,c,b){if(c&&c.file){var e=require("x.hub.resource.js").getFileURL(c.file,a.ip);e?(c.url=e,this.playUrl(a,c,b)):b&&b(Error("no such file"))}else b&&b(Error("invalid file"))};d.prototype.playUrl=function(a,c,b){if(c){var e=c.url;e||(e=c.ext);if(e){var d=x.hub.m.sonos.MODULE.resolveDevice(a);if(d){var f=this;this._cancelPlay(d,function(a){a?b&&b(a):f._setVolume(d,c.volume,function(a){a?b&&b(a):f._unmute(d,
function(a){a?b&&b(a):f._playUrl(d,e,function(a){a?b&&b(a):f._setRepeat(d,c.repeat,function(a){a?b&&b(a):c.repeat&&-1!=c.repeat&&(f._process[d.ip]={url:e},f._process[d.ip].timeout=setTimeout(function(){var b=f._process[d.ip].url;f._process[d.ip]=null;f._stopPlay(d,b)},1E3*parseInt(c.repeat)))})})})})});b&&b(null,1)}else b&&b(Error("invalid device json"))}else b&&b(Error("invalid url"))}else b&&b(Error("invalid command"))};d.prototype._cancelPlay=function(a,c){if(a.ip&&this._process[a.ip]){this._process[a.ip].timeout&&
clearTimeout(this._process[a.ip].timeout);var b=this._process[a.ip].url;this._process[a.ip]=null;b?this._stopPlay(a,b,c):c&&c()}else c&&c()};d.prototype._stopPlay=function(a,c,b){a.getMediaInfo(function(d,g){d||!g?a.stop(b):g.currentURI&&g.currentURI!=c?b&&b():a.stop(b)})};d.prototype._setVolume=function(a,c,b){c?a.setVolume(c,b):b&&b()};d.prototype._setRepeat=function(a,c,b){c?a.repeatOne(b):a.repeatOff(b)};d.prototype._unmute=function(a,c){a.unmute(c)};d.prototype._playUrl=function(a,c,b){c?a.playUrl(c,
b):b&&b(Error("invalid url"))};return d}();
x.hub.m.sonos.Handler=function(){var d=function(){this._audioPlayer=new x.hub.m.sonos.AudioPlayer};util.inherits(d,EventEmitter);d.prototype.init=function(a){setTimeout(function(){x.hub.m.sonos.MODULE._master._autoSearchTimeout&&clearTimeout(x.hub.m.sonos.MODULE._master._autoSearchTimeout);var a=require("xnm.aio.raumfeld.js");a.discovery._autoSearchTimeout&&clearTimeout(a.discovery._autoSearchTimeout);a=require("xnm.aio.bose.js");a.master._autoSearchTO&&clearTimeout(a.master._autoSearchTO)},15E3);
a&&a()};d.prototype.getSystems=function(){return["sonos"]};d.prototype.executeCommand=function(a,c,b){c?"playFile"==c.value?this._audioPlayer.playFile(a,c,function(a){b&&b({error:a})}):"playUrl"==c.value?this._audioPlayer.playUrl(a,c,function(a){b&&b({error:a})}):x.hub.m.sonos.MODULE.doCommand(a,c,b):b&&b({error:Error("invalid command")})};d.prototype.executeCommandV6=function(a,c,b,d){if(a&&a.address)if(b){a={sys:"sonos",ip:a.address,port:a.port};var e=x.hub.m.sonos.MODULE.resolveDevice(a);if(e)if("alarm"==
b.command)b.value&&b.value.file?(c={},c.volume=b.value.volume,c.repeat=b.value.time,b=b.value.file,"file://file/"==b.substr(0,12)?(c.value="playFile",c.file=b.substr(12),this.executeCommand(a,c,function(a){a&&a.error?d&&d(a.error):d&&d()})):(c.value="playUrl",c.url=b,this.executeCommand(a,c,function(a){a&&a.error?d&&d(a.error):d&&d()}))):(b=Error("invalid command"),b.code="000000",d&&d(b));else{c={value:null,ext:null};switch(b.command){case "pause":case "stop":case "previous":case "next":case "mute":case "unmute":c.value=
b.command;break;case "play":b.value?(c.value="playUrl",c.ext=b.value):c.value="play";break;case "volume":c.value="volume";c.ext=b.value;break;default:b=Error("unknown command");b.code="000000";d&&d(b);return}e.executeCommandCreator(a,c,function(a){a&&(a.code="000000");d&&d(a)})}else b=Error("invalid device json"),b.code="000000",d&&d(b)}else b=Error("invalid command"),b.code="000000",d&&d(b);else b=Error("invalid device json"),b.code="000000",d&&d(b)};d.prototype.getStatesV6=function(a,c,b){a&&a.address?
(a={sys:"sonos",ip:a.address,port:a.port},(c=x.hub.m.sonos.MODULE.resolveDevice(a))?c.getStatesCreator(null,[{id:"playState",device:a,status:{value:"playState"}},{id:"volume",device:a,status:{value:"volume"}},{id:"muted",device:a,status:{value:"muted"}}],function(a,c){if(a)b&&b(a);else{a={};if(c)for(var d=0;d<c.length;d++){var e=c[d];e&&("playState"==e.id&&e.status?a.state="PLAYING"==e.status?"playing":"paused":"volume"==e.id&&null!=e.status&&void 0!=e.status?a.volume=parseInt(e.status):"muted"==
e.id&&(a.muted="true"==e.status||1==e.status))}b&&b(null,a)}}):(a=Error("invalid device json"),a.code="000000",b&&b(a))):(a=Error("invalid device json"),a.code="000000",b&&b(a))};return d}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.sonos.Handler);
