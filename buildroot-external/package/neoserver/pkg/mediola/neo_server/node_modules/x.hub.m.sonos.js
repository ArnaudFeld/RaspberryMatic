var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.checkStringArgs=function(d,a,c){if(null==d)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(a instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return d+""};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(d,a,c){d!=Array.prototype&&d!=Object.prototype&&(d[a]=c.value)};$jscomp.getGlobal=function(d){return"undefined"!=typeof window&&window===d?d:"undefined"!=typeof global&&null!=global?global:d};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(d,a,c,b){if(a){c=$jscomp.global;d=d.split(".");for(b=0;b<d.length-1;b++){var g=d[b];g in c||(c[g]={});c=c[g]}d=d[d.length-1];b=c[d];a=a(b);a!=b&&null!=a&&$jscomp.defineProperty(c,d,{configurable:!0,writable:!0,value:a})}};
$jscomp.polyfill("String.prototype.repeat",function(d){return d?d:function(a){var c=$jscomp.checkStringArgs(this,null,"repeat");if(0>a||1342177279<a)throw new RangeError("Invalid count value");a|=0;for(var b="";a;)if(a&1&&(b+=c),a>>>=1)c+=c;return b}},"es6","es3");var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.sonos=x.hub.m.sonos||{};x.hub.m.sonos.MODULE=require("xnm.aio.sonos.js");
x.hub.m.sonos.AudioPlayer=function(){var d=function(){this._process={}};d.prototype.playFile=function(a,c,b){if(c&&c.file){var d=require("x.hub.resource.js").getFileURL(c.file,a.ip);d?(c.url=d,this.playUrl(a,c,b)):b&&b(Error("no such file"))}else b&&b(Error("invalid file"))};d.prototype.playUrl=function(a,c,b){if(c&&c.url){var d=x.hub.m.sonos.MODULE.resolveDevice(a);if(d){var f=c.url,e=this;this._cancelPlay(d,function(a){a?b&&b(a):e._setVolume(d,c.volume,function(a){a?b&&b(a):e._unmute(d,function(a){a?
b&&b(a):e._playUrl(d,f,function(a){a?b&&b(a):e._setRepeat(d,c.repeat,function(a){a?b&&b(a):c.repeat&&-1!=c.repeat&&(e._process[d.ip]={url:f},e._process[d.ip].timeout=setTimeout(function(){var a=e._process[d.ip].url;e._process[d.ip]=null;e._stopPlay(d,a)},1E3*parseInt(c.repeat)))})})})})});b&&b(null,1)}else b&&b(Error("invalid device json"))}else b&&b(Error("invalid url"))};d.prototype._cancelPlay=function(a,c){if(a.ip&&this._process[a.ip]){this._process[a.ip].timeout&&clearTimeout(this._process[a.ip].timeout);
var b=this._process[a.ip].url;this._process[a.ip]=null;b?this._stopPlay(a,b,c):c&&c()}else c&&c()};d.prototype._stopPlay=function(a,c,b){a.getMediaInfo(function(d,f){d||!f?a.stop(b):f.currentURI&&f.currentURI!=c?b&&b():a.stop(b)})};d.prototype._setVolume=function(a,c,b){c?a.setVolume(c,b):b&&b()};d.prototype._setRepeat=function(a,c,b){c?a.repeatOne(b):a.repeatOff(b)};d.prototype._unmute=function(a,c){a.unmute(c)};d.prototype._playUrl=function(a,c,b){c?a.playUrl(c,b):b&&b(Error("invalid url"))};return d}();
x.hub.m.sonos.Handler=function(){var d=function(){this._audioPlayer=new x.hub.m.sonos.AudioPlayer};util.inherits(d,EventEmitter);d.prototype.init=function(a){a&&a()};d.prototype.getSystems=function(){return["sonos"]};d.prototype.executeCommand=function(a,c,b){c?"playFile"==c.value?this._audioPlayer.playFile(a,c,function(a){b&&b({error:a})}):"playUrl"==c.value&&(c.repeat||c.volume)?this._audioPlayer.playUrl(a,c,function(a){b&&b({error:a})}):x.hub.m.sonos.MODULE.doCommand(a,c,b):b&&b({error:Error("invalid command")})};
return d}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.sonos.Handler);
