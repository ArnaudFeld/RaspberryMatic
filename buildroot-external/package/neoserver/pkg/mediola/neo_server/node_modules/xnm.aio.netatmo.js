var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.netatmo=xnm.aio.netatmo||{};
xnm.aio.netatmo.Cloud=function(){var g={},e={},f={},t={},k=function(a){return a.refreshToken?a.refreshToken:a.user?e[a.user]:null},c=function(a){var b=k(a);if(!b)return null;g[b]||(g[b]={cloud:a});return g[b].cred?g[b].cred:{refresh_token:b}},p=function(a,b){var d=b.refresh_token;a.refreshToken||(a.refreshToken=d);a.user&&(e[a.user]=d);g[d]||(g[d]={cloud:a});g[d].cred=b;b.expires_in&&(b._expireTime=(new Date).getTime()+1E3*b.expires_in-6E5)},m=function(a){return(a=c(a))&&a._expireTime?(new Date).getTime()>
a._expireTime:!1},u=function(a){var b=k(a);if(!b)return null;g[b]||(g[b]={cloud:a});g[b].weather||(g[b].weather={updateData:{running:!1,error:null}});return g[b].weather},w=function(a){a=u(a);a.timer&&clearTimeout(a.timer);a.updateData={running:!0,error:null}},v=function(a,b,d){var c=k(a),h=u(a);h.updateData={running:!1,error:b};try{if(!b&&d){var l=require("xnm.aio.netatmo.js")._updateListener;if(l&&0<l.length)for(var n=0;n<l.length;n++)l[n]&&l[n].updateWeather&&l[n].updateWeather(a,h.data,d)}}catch(f){}h.timer&&
clearTimeout(h.timer);l=y(a);b?h.data=null:d&&(h.data=d);d=h.tmpCBs;h.tmpCBs=[];if(d)for(n=0;n<d.length;n++)if(b)d[n](b);else a.getWeatherStatus(d[n]);b?h.timer=setTimeout(function(){g[c].cloud.getStationsData(null)},6E4):(a=y(a),l&&a&&l==a&&1>h.retry?(h.retry=h.retry?h.retry+1:1,l=60*h.retry,h.delay=l,h.timer=setTimeout(function(){g[c].cloud.getStationsData(null)},1E3*l)):(h.retry=0,(b=h.delay)||(b=0),l=6E5,a&&(d=Math.round((new Date).getTime()/1E3),d>a&&(l=600-(d-a)%600+30)),require("x.logger.js").getLogger("xnm.aio.netatmo.Cloud").log("debug",
"weather station next poll in t:"+l/60+" min delay:"+b),h.timer=setTimeout(function(){g[c].cloud.getStationsData(null)},1E3*l+1E3*b)))},y=function(a){a=u(a);if(!a.data)return 0;for(var b=0;b<a.data.length;b++)if(a.data[b]&&a.data[b].dashboard_data&&a.data[b].dashboard_data.time_utc)return a.data[b].dashboard_data.time_utc;return 0},z=function(a){var b=k(a);if(!b)return null;g[b]||(g[b]={cloud:a});g[b].homecoach||(g[b].homecoach={updateData:{running:!1,error:null}});return g[b].homecoach},E=function(a){a=
z(a);a.timer&&clearTimeout(a.timer);a.updateData={running:!0,error:null}},B=function(a,b,d){var c=k(a),h=z(a);h.updateData={running:!1,error:b};try{if(!b&&d){var l=require("xnm.aio.netatmo.js")._updateListener;if(l&&0<l.length)for(var n=0;n<l.length;n++)l[n]&&l[n].updateHomeCoach&&l[n].updateHomeCoach(a,h.data,d)}}catch(f){}h.timer&&clearTimeout(h.timer);l=A(a);b?h.data=null:d&&(h.data=d);d=h.tmpCBs;h.tmpCBs=[];if(d)for(n=0;n<d.length;n++)if(b)d[n](b);else a.getWeatherStatus(d[n]);b?h.timer=setTimeout(function(){g[c].cloud.getHomeCoachsData(null)},
6E4):(a=A(a),l&&a&&l==a&&1>h.retry?(h.retry=h.retry?h.retry+1:1,l=60*h.retry,h.delay=l,h.timer=setTimeout(function(){g[c].cloud.getHomeCoachsData(null)},1E3*l)):(h.retry=0,(b=h.delay)||(b=0),l=6E5,a&&(d=Math.round((new Date).getTime()/1E3),d>a&&(l=600-(d-a)%600+30)),h.timer=setTimeout(function(){g[c].cloud.getHomeCoachsData(null)},1E3*l+1E3*b)))},A=function(a){a=z(a);if(!a.data)return 0;for(var b=0;b<a.data.length;b++)if(a.data[b]&&a.data[b].dashboard_data&&a.data[b].dashboard_data.time_utc)return a.data[b].dashboard_data.time_utc;
return 0},x=function(a){var b=k(a);if(!b)return null;g[b]||(g[b]={cloud:a});g[b].thermo||(g[b].thermo={updateData:{running:!1,error:null}});return g[b].thermo},F=function(a){a=x(a);a.timer&&clearTimeout(a.timer);a.updateData={running:!0,error:null}},C=function(a,b,d){var c=k(a),h=x(a);try{if(!b&&d){var l=require("xnm.aio.netatmo.js")._updateListener;if(l&&0<l.length)for(var n=0;n<l.length;n++)l[n]&&l[n].updateThermo&&l[n].updateThermo(a,h.data,d)}}catch(f){}h.timer&&clearTimeout(h.timer);h.updateData=
{running:!1,error:b};b?h.data=null:d&&(h.data=d);d=h.tmpCBs;h.tmpCBs=[];if(d)for(l=0;l<d.length;l++)if(b)d[l](b);else a.getThermoStatus(d[l]);h.timer=b?setTimeout(function(){g[c].cloud.getThermostatsData(null)},6E4):setTimeout(function(){g[c].cloud.getThermostatsData(null)},18E5)},D=function(a,b){var d=k(a);if(!b.module)return 60;var c=x(a);c.duration||(g[d].thermo.duration={});d=c.duration[b.module];if(!d){a:{if(b.module&&XC&&XC.localStorage){if(d=XC.localStorage.getItem("netatmo"))try{d=JSON.parse(d)}catch(h){}if(d&&
d.duration){d=d.duration[b.module];break a}}d=null}c.duration[b.module]=d}d||(d=60);return d},G=function(a,b,d){a=x(a);a.duration||(a.duration={});if(b.module&&(a.duration[b.module]=d,b.module&&XC&&XC.localStorage)){if(a=XC.localStorage.getItem("netatmo"))try{a=JSON.parse(a)}catch(c){}a&&"object"==typeof a||(a={});a.duration||(a.duration={});a.duration[b.module]=d;XC.localStorage.setItem("netatmo",JSON.stringify(a))}},H=function(a,b){var d=x(a);if(d.data)for(var c=0;c<d.data.length;c++){var h=d.data[c];
if(h&&h._id==b.address&&h.modules)for(var l=0;l<h.modules.length;l++){var n=h.modules[l];if(n&&n._id==b.module)return n.setpoint}}return null},q=function(a,b,d){this._logger=require("x.logger.js").getLogger("xnm.aio.netatmo.Cloud");this.user=a;this.password=b;this.refreshToken=d;this._scope="read_station read_thermostat read_homecoach write_thermostat read_camera access_camera read_presence access_presence".split(" ");this._scopeFallback="read_station read_thermostat read_homecoach write_thermostat read_camera access_camera read_presence".split(" ")};
q.prototype.executeCommandCreator=function(a,b,d){if(b&&b.value){var c=this,h={},l=D(this,a);H(this,a);switch(b.value){case "thermoAuto":h.setpoint_mode="program";break;case "thermoAway":h.setpoint_mode="away";break;case "thermoHg":h.setpoint_mode="hg";break;case "thermoOff":h.setpoint_mode="off";break;case "thermoMax":h.setpoint_mode="max";h.setpoint_endtime=Math.round(((new Date).getTime()+6E4*l)/1E3);break;case "thermoManu":if(null==b.ext||"undefined"==typeof b.ext){d&&d(Error("command ext invalid"));
return}var n=b.ext;"string"==typeof b.ext&&(n=parseFloat(b.ext));5.5>n&&(n=5.5);30<n&&(n=30);h.setpoint_mode="manual";h.setpoint_endtime=Math.round(((new Date).getTime()+6E4*l)/1E3);h.setpoint_temp=n;break;case "tempDuration":if(null==b.ext||"undefined"==typeof b.ext){d&&d(Error("command ext invalid"));return}l=b.ext;"string"==typeof b.ext&&(l=parseFloat(b.ext));15>l&&(l=15);720<l&&(l=720);G(this,a,l);d&&d();return;default:d&&d(Error("unknow command"))}this.setThermPoint(a,h,function(b){if(b)d&&d(b);
else{b=x(c);b.data||(b.data=[]);var l,n;for(l=0;l<b.data.length;l++)if(b.data[l]&&b.data[l]._id==a.address){n=b.data[l];break}n||(n={_id:a.address,modules:[]},b.data.push(n));var f;for(l=0;l<n.modules.length;l++)if(n.modules[l]&&n.modules[l]._id==a.module){f=n.modules[l];break}f||(f={_id:a.module},n.modules.push(f));f.setpoint=h;d&&d()}})}else d&&d(Error("command format invalid"))};q.prototype.getStatesCreator=function(a,b,d){b?this.getAllStatus(function(a,h){for(var c=[],n=0;n<b.length;n++){var k=
b[n];if(k.id){var e,r="?";if(!a&&h&&k.device&&k.device.type&&(e="NAMain"==k.device.type||"NHC"==k.device.type?k.device.address:k.device.address+"|"+k.device.module)&&k.status&&k.status.value&&(e=h[e]))if("tempFelt"==k.status.value)r=e.temp,e=e.hum,r="undefined"!=typeof r&&"undefined"!=typeof e?"NHC"==k.device.type?xnm.aio.netatmo.DM.calcFeltTemp(r,e,t):xnm.aio.netatmo.DM.calcFeltTemp(r,e,f):"?";else if("winDName"==k.status.value)r=e.winD,null===r||"undefined"==typeof r?r="?":(r=Number(r),r=isNaN(r)?
"?":23<r&&68>=r?"NO":68<r&&113>=r?"O":113<r&&158>=r?"SO":158<r&&203>=r?"S":203<r&&248>=r?"SW":248<r&&293>=r?"W":293<r&&338>=r?"NW":"N");else if(r=e[k.status.value],null==r||"undefined"==typeof r)r="?";c.push({id:k.id,status:r})}}d&&d(null,c)}):d&&d(Error("deviceList is null"))};q.prototype.getAllStatus=function(a){var b=this,d={};this.getWeatherStatus(function(c,h){c?a&&a(c):b.getThermoStatus(function(c,n){c?a&&a(c):b.getHomeCoachStatus(function(b,c){if(b)a&&a(b);else{for(var l in h)h.hasOwnProperty(l)&&
(d[l]=h[l]);for(l in n)n.hasOwnProperty(l)&&(d[l]=n[l]);for(l in c)c.hasOwnProperty(l)&&(d[l]=c[l]);a&&a(null,d)}})})})};q.prototype.getDeviceList=function(a){var b=this;this.getStationsData(function(d,c){d?a&&a(d):b.getThermostatsData(function(d,l){d?a&&a(d):b.getHomeCoachsData(function(b,d){if(b)a&&a(b);else{var h={weather:[],thermostat:[]};if(c){for(var k=[],f=0;f<c.length;f++){var e=c[f];if(e&&e._id&&e.type){var g=e.station_name,p=e.module_name,m={address:e._id,type:e.type,name:g+" ("+p+")"};
m.dashboard_data=e.dashboard_data;m.modules=[];if(e.modules)for(var t=0;t<e.modules.length;t++)e.modules[t]&&e.modules[t]._id&&e.modules[t].type&&(p=e.modules[t].module_name,m.modules.push({address:e._id,module:e.modules[t]._id,type:e.modules[t].type,name:g+" ("+p+")",dashboard_data:e.modules[t].dashboard_data}));k.push(m)}}h.weather=k}if(l){k=[];for(f=0;f<l.length;f++)if((e=l[f])&&e._id&&e.type&&(g=e.station_name,e.modules))for(m=0;m<e.modules.length;m++)e.modules[m]&&e.modules[m]._id&&e.modules[m].type&&
(p=e.modules[m].module_name,k.push({address:e._id,module:e.modules[m]._id,type:e.modules[m].type,name:g+" ("+p+")"}));h.thermostat=k}if(d){k=[];for(f=0;f<d.length;f++)(e=d[f])&&e._id&&e.type&&(g=e.module_name,p={address:e._id,type:e.type,name:e.name},g&&(p.name+=" ("+g+")"),p.dashboard_data=e.dashboard_data,p.modules=[],k.push(p));h.homecoach=k}a&&a(null,h)}})})})};q.prototype.getCamList=function(a){var b=this;this.getCamsData(function(d,e){if(d)a&&a(d);else{var h={cam:[]};if(e){for(var l=[],k=0;k<
e.length;k++)if(e[k]&&e[k].id){var f=e[k].name,p=e[k].cameras;if(p)for(var g=0;g<p.length;g++)if(p[g]&&p[g].id){var m="welcome";"NACamera"==p[g].type?m="welcome":"NOC"==p[g].type&&(m="presence");m&&(m={sys:"cam",type:"system",manufacturer:"netatmo",model:m,address:p[g].id},p[g].name&&(m.name=p[g].name+(f?" ("+f+")":"")),l.push(m))}}h.cam=l}l=c(b);if(h.cam&&0<h.cam.length)for(k=0;k<h.cam.length;k++)h.cam[k].refreshToken=l.refresh_token;a&&a(null,h)}})};q.prototype.getWeatherStatus=function(a){var b=
function(a,b){var d={};if(b)for(var h=0;h<b.length;h++){var c=b[h];if(c&&c._id){var e=a._resolveStationStatus(c);e&&(d[c._id]=e);if(c.modules)for(var k=0;k<c.modules.length;k++)(e=a._resolveModuleStatus(c.modules[k]))&&(d[c._id+"|"+c.modules[k]._id]=e)}}return d};this._logger.log("debug","getWeatherStatus");var d=u(this),c=this,h=a;a=null;d&&d.data?(a=b(this,d.data),h&&h(null,a),h=null):this.getStationsData(function(a){a?(h&&h(a),h=null):h&&c.getWeatherStatus(h)})};q.prototype.getHomeCoachStatus=
function(a){var b=function(a,b){var d={};if(b)for(var h=0;h<b.length;h++){var c=b[h];if(c&&c._id){var e=a._resolveHomeCoachStatus(c);e&&(d[c._id]=e)}}return d};this._logger.log("debug","getHomeCoachStatus");var d=z(this),c=this,h=a;a=null;d&&d.data?(a=b(this,d.data),h&&h(null,a),h=null):this.getHomeCoachsData(function(a){a?(h&&h(a),h=null):h&&c.getHomeCoachStatus(h)})};q.prototype.getThermoStatus=function(a){var b=function(a,b){for(var d={},h=0;h<b.length;h++){var c=b[h];if(c&&c._id&&c.modules)for(var e=
0;e<c.modules.length;e++){var k=a._resolveModuleStatus(c.modules[e]);k&&(d[c._id+"|"+c.modules[e]._id]=k)}}return d},d=x(this),c=this,h=a,e=null;d.updateData.running?(d.tmpCBs||(d.tmpCBs=[]),d.tmpCBs.push(a)):d.data?(e=b(this,d.data),h&&h(null,e),h=null):this.getThermostatsData(function(a){a?(h&&h(a),h=null):h&&c.getThermoStatus(h)})};q.prototype.getCamUrl=function(a,b){var d=this;this._refreshToken(this.refreshToken,function(c,h){if(c)h&&h.error&&(c=Error(h.error),c._code="auth_error"),b&&b(c);else{var e;
h&&h.access_token&&(e=h.access_token);e?h&&h.scope&&-1==h.scope.indexOf("access_camera")?b&&b(null,"scop_error"):d._getCamsData(e,function(h,c){if(h)c&&c.error&&(h=Error(c.error),h._code="api_error"),b&&b(h);else{var e=null;c.body&&c.body.homes&&(e=c.body.homes);if(e){for(var k,l=0;l<e.length;l++)if(e[l]&&e[l].cameras){for(var f=e[l].cameras,p=0;p<f.length;p++)if(f[p]&&f[p].id==a&&f[p].vpn_url){k=f[p];break}if(k)break}k?1==k.is_local?d._getLocalCamUrl(k.vpn_url,function(a,d){b&&b(a,d)}):b&&b(null,
k.vpn_url+"/live/index.m3u8"):b&&b("no cam with address:"+a)}else b&&b("get cams data reponse invalid")}}):b&&b(Error("auth response invalid"))}})};q.prototype._resolveStationStatus=function(a){var b={};null!=a.wifi_status&&"undefined"!=typeof a.wifi_status&&(b.wifi=a.wifi_status,b.wifiStatus=86<=b.wifi?"bad":71<=b.wifi?"middle":56<=b.wifi?"good":"very_good");if(a.dashboard_data&&(a=this._resolveDashboard(a.dashboard_data)))for(var d in a)a.hasOwnProperty(d)&&(b[d]=a[d]);return b};q.prototype._resolveModuleStatus=
function(a){var b={};null!=a.rf_status&&"undefined"!=typeof a.rf_status&&(b.rf=a.rf_status,b.rfStatus=90<=b.rf?"very_low":80<=b.rf?"low":70<=b.rf?"medium":60<=b.rf?"high":"full");if(null!=a.battery_vp&&"undefined"!=typeof a.battery_vp)switch(b.bat=a.battery_vp,a.type){case "NAModule4":b.batStatus=5640<=b.bat?"full":5280<=b.bat?"high":4920<=b.bat?"medium":4560<=b.bat?"low":"very_low";break;case "NAModule1":case "NAModule3":b.batStatus=5500<=b.bat?"full":5E3<=b.bat?"high":4500<=b.bat?"medium":4E3<=
b.bat?"low":"very_low";break;case "NAModule2":b.batStatus=5900<=b.bat?"full":5180<=b.bat?"high":4770<=b.bat?"medium":4360<=b.bat?"low":"very_low";break;case "NATherm1":b.batStatus=4100<=b.bat?"full":3600<=b.bat?"high":3300<=b.bat?"medium":3E3<=b.bat?"low":"very_low"}var d,c;if("NATherm1"==a.type&&(d=this._resolveThermoStat(a)))for(c in d)d.hasOwnProperty(c)&&(b[c]=d[c]);if(a.dashboard_data&&(d=this._resolveDashboard(a.dashboard_data)))for(c in d)d.hasOwnProperty(c)&&(b[c]=d[c]);return b};q.prototype._resolveHomeCoachStatus=
function(a){var b={};null!=a.wifi_status&&"undefined"!=typeof a.wifi_status&&(b.wifi=a.wifi_status,b.wifiStatus=86<=b.wifi?"bad":71<=b.wifi?"middle":56<=b.wifi?"good":"very_good");if(a.dashboard_data&&(a=this._resolveDashboard(a.dashboard_data)))for(var d in a)a.hasOwnProperty(d)&&(b[d]=a[d]);return b};q.prototype._resolveThermoStat=function(a){var b={};if(a.setpoint){var d;switch(a.setpoint.setpoint_mode){case "program":d="auto";break;case "away":d="away";break;case "hg":d="frost-guard";break;case "manual":d=
"manu";break;case "off":d="off";break;case "max":d="boost"}d&&(b.mode=d);null!=a.setpoint.setpoint_temp&&"undefined"!=typeof a.setpoint.setpoint_temp&&(b.manuT=a.setpoint.setpoint_temp);if(null!=a.setpoint.setpoint_endtime&&"undefined"!=typeof a.setpoint.setpoint_endtime)if(b.tempEnd=a.setpoint.setpoint_endtime,b.tempEndStr=(new Date(1E3*a.setpoint.setpoint_endtime)).toLocaleString(),"undefined"!=typeof dateFormat&&dateFormat)try{b.tempEndStr=dateFormat(b.tempEndStr,"dd mm yyyy, HH:MM:ss")}catch(c){}else b.tempEndStr=
b.tempEndStr.toLocaleString()}a.measured&&(null!=a.measured.time&&"undefined"!=typeof a.measured.time&&(b.mesureT=a.measured.time),null!=a.measured.temperature&&"undefined"!=typeof a.measured.temperature&&(b.currentTemp=a.measured.temperature));b.tempDuration=D(this,{module:a._id});return b};q.prototype._resolveDashboard=function(a){var b=function(a,b){return null!=a[b]&&"undefined"!=typeof a[b]},d={},c;b(a,"AbsolutePressure")&&(d.absPres=a.AbsolutePressure);b(a,"CO2")&&(d.co2=a.CO2);b(a,"Humidity")&&
(d.hum=a.Humidity);b(a,"Noise")&&(d.noise=a.Noise);b(a,"Pressure")&&(d.pres=a.Pressure);b(a,"Rain")&&(d.rain=a.Rain);b(a,"sum_rain_1")&&(d.rain1h=a.sum_rain_1);b(a,"sum_rain_24")&&(d.rain24h=a.sum_rain_24);b(a,"Temperature")&&(d.temp=a.Temperature);b(a,"date_max_temp")&&(d.timeMaxTemp=a.date_max_temp,c=1E3*a.date_max_temp,d.timeMaxTempStr=new Date(c),d.timeMaxTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(d.timeMaxTempStr,"dd mm yyyy, HH:MM:ss"):d.timeMaxTempStr.toLocaleString());b(a,
"date_min_temp")&&(d.timeMinTemp=a.date_min_temp,c=1E3*a.date_min_temp,d.timeMinTempStr=new Date(c),d.timeMinTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(d.timeMinTempStr,"dd.mm.yyyy, HH:MM:ss"):d.timeMinTempStr.toLocaleString());b(a,"max_temp")&&(d.maxTemp=a.max_temp);b(a,"min_temp")&&(d.minTemp=a.min_temp);b(a,"WindAngle")&&(d.winD=a.WindAngle);b(a,"WindStrength")&&(d.winS=a.WindStrength);b(a,"GustAngle")&&(d.gwinD=a.GustAngle);b(a,"GustStrength")&&(d.gwinS=a.GustStrength);b(a,
"time_utc")&&(d.mesureT=a.time_utc,c=1E3*a.time_utc,d.mesureTStr=new Date(c),d.mesureTStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(d.mesureTStr,"dd.mm.yyyy, HH:MM:ss"):d.mesureTStr.toLocaleString());b(a,"date_max_wind_str")&&(d.timeMaxWind=a.date_max_wind_str,c=1E3*a.date_max_wind_str,d.timeMaxWindStr=new Date(c),d.timeMaxWindStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(d.timeMaxWindStr,"dd.mm.yyyy, HH:MM:ss"):d.timeMaxWindStr.toLocaleString());b(a,"max_wind_angle")&&(d.maxWinD=
a.max_wind_angle);b(a,"max_wind_str")&&(d.maxWinS=a.max_wind_str);b(a,"temp_trend")&&(d.tempTrend=a.temp_trend);b(a,"pressure_trend")&&(d.presTrend=a.pressure_trend);if(b(a,"health_idx"))switch(d.healthIdxLvl=a.health_idx,parseInt(d.healthIdx)){case 0:d.healthIdx="healthy";break;case 1:d.healthIdx="fine";break;case 2:d.healthIdx="fair";break;case 3:d.healthIdx="poor";break;case 4:d.healthIdx="unhealthy"}return d};q.prototype.auth=function(a){this._logger.log("debug","auth");var b=c(this),d=this;b?
b.access_token?m(this)?this._refreshToken(b.refresh_token,function(b,c){b?(c&&c.error&&(b=Error(c.error),b._code="refresh_token_error"),a&&a(b)):(p(d,c),a&&a(null,c))}):a&&a(null,b):this._refreshToken(b.refresh_token,function(b,c){b?(c&&c.error&&(b=Error(c.error),b._code="refresh_token_error"),a&&a(b)):(p(d,c),a&&a(null,c))}):this._auth(this._scope.join(" "),function(b,c){if(b){if(c)try{if(c=JSON.parse(c),c.error&&(b=Error(c.error),b._code="auth_error","invalid_request"==c.error&&-1!=d._scope.indexOf("access_presence"))){d._scope=
d._scopeFallback;d.auth(a);return}}catch(e){}a&&a(b)}else p(d,c),a&&a(null,c)})};q.prototype.setThermPoint=function(a,b,d){if(a&&a.address&&a.module)if(b&&b.setpoint_mode)if("max"!=b.setpoint_mode||b.setpoint_endtime)if("manual"!=b.setpoint_mode||b.setpoint_endtime&&b.setpoint_temp){var e=this;this.auth(function(h){h?d&&d(h):e._setThermPoint(c(e).access_token,a.address,a.module,b.setpoint_mode,b.setpoint_endtime,b.setpoint_temp,function(a,b){a?(b&&b.error&&(a=Error(b.error),a._code="api_error"),d&&
d(a)):d&&d(null,b)})})}else d&&d(Error("param format invalid"));else d&&d(Error("param format invalid"));else d&&d(Error("param format invalid"));else d&&d(Error("device format invalid"))};q.prototype.getStationsData=function(a){this._logger.log("debug","getStationsData");var b=this;this.auth(function(d){d?a&&a(d):(d=u(b))&&d.updateData&&d.updateData.running?(d.tmpCBs||(d.tmpCBs=[]),d.tmpCBs.push(a)):(w(b),b._getStationsData(c(b).access_token,null,function(d,c){if(d)c&&c.error&&(d=Error(c.error),
d._code="api_error"),v(b,d,null),a&&a(d);else{var e=null;c.body&&c.body.devices&&(e=c.body.devices);c.body&&c.body.user&&c.body.user.administrative&&(f=c.body.user.administrative);v(b,null,e);a&&a(null,e)}}))})};q.prototype.getThermostatsData=function(a){var b=this;this.auth(function(d){d?a&&a(d):(d=x(this))&&d.updateData&&d.updateData.running?(d.tmpCBs||(d.tmpCBs=[]),d.tmpCBs.push(a)):(F(b),b._getThermostatsData(c(b).access_token,null,function(d,c){if(d)c&&c.error&&(d=Error(c.error),d._code="api_error"),
C(b,d,null),a&&a(d);else{var e=null;c.body&&c.body.devices&&(e=c.body.devices);C(b,null,e);a&&a(null,e)}}))})};q.prototype.getHomeCoachsData=function(a){this._logger.log("debug","getHomeCoachsData");var b=this;this.auth(function(d){d?a&&a(d):(d=z(this))&&d.updateData&&d.updateData.running?(d.tmpCBs||(d.tmpCBs=[]),d.tmpCBs.push(a)):(E(b),b._getHomeCoachsData(c(b).access_token,null,function(d,c){if(d)c&&c.error&&(d=Error(c.error),d._code="api_error"),B(b,d,null),a&&a(d);else{var e=null;c.body&&c.body.devices&&
(e=c.body.devices);c.body&&c.body.user&&c.body.user.administrative&&(t=c.body.user.administrative);B(b,null,e);a&&a(null,e)}}))})};q.prototype.getCamsData=function(a){this._logger.log("debug","getCamsData");var b=this;this.auth(function(d){d?a&&a(d):b._getCamsData(c(b).access_token,function(b,d){if(b)d&&d.error&&(b=Error(d.error),b._code="api_error"),a&&a(b);else{var c=null;d.body&&d.body.homes&&(c=d.body.homes);a&&a(null,c)}})})};q.prototype._auth=function(a,b){this._logger.log("trace","_auth");
this._doRequest("POST","/oauth2/token",{grant_type:"password",client_id:"564b2c5245a1e3173cb21d3b",client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",username:this.user,password:this.password,scope:a},b)};q.prototype._refreshToken=function(a,b){this._logger.log("trace","_refreshToken");this._doRequest("POST","/oauth2/token",{grant_type:"refresh_token",client_id:"564b2c5245a1e3173cb21d3b",client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",refresh_token:a},b)};q.prototype._setThermPoint=
function(a,b,d,c,e,k,f){a={access_token:a,device_id:b,module_id:d,setpoint_mode:c};e&&(a.setpoint_endtime=e);k&&(a.setpoint_temp=k);this._doRequest("GET","/api/setthermpoint",a,f)};q.prototype._getStationsData=function(a,b,d){this._logger.log("debug","_getStationsData");a={access_token:a};b&&(a.device_id=b);this._doRequest("GET","/api/getstationsdata",a,d)};q.prototype._getHomeCoachsData=function(a,b,d){this._logger.log("debug","_getHomeCoachsData");a={access_token:a};b&&(a.device_id=b);this._doRequest("GET",
"/api/gethomecoachsdata",a,d)};q.prototype._getThermostatsData=function(a,b,d){a={access_token:a};b&&(a.device_id=b);this._doRequest("GET","/api/getthermostatsdata",a,d)};q.prototype._getCamsData=function(a,b){this._doRequest("GET","/api/gethomedata",{access_token:a},b)};q.prototype._getLocalCamUrl=function(a,b){var d=this;this._logger.log("trace","ping cam "+a);this._doUrlRequest("get",a+"/command/ping",null,function(c,e){!c&&e&&e.local_url?d._doUrlRequest("get",e.local_url+"/command/ping",null,
function(d,c){d||!c||c.local_url!=e.local_url?b&&b(null,a+"/live/index.m3u8"):b&&b(null,c.local_url+"/live/index.m3u8")}):b&&b(null,a+"/live/index.m3u8")})};q.prototype._doRequest=function(a,b,d,c){this._doUrlRequest(a,"https://api.netatmo.net"+b,d,c)};q.prototype._doUrlRequest=function(a,b,d,c){var e=this,k=c;this._logger.log("trace","send "+a+" req to:"+b+" data:"+JSON.stringify(d));$.ajax({url:b,type:a,timeout:1E4,dataType:"json",data:d,cache:!1,success:function(a){e._logger.log("trace","http request success:"+
JSON.stringify(a));c&&c(null,a)},error:function(a,b,d){b="http request error:"+(a?a.status:"0")+"-"+b;e._logger.log("warn","http request error:"+b);b=Error(b);d&&(e._logger.log("warn","http request http error:"+d),b.httpError=!0,b.statusCode=a?a.status:0);k&&(k(b,a?a.responseText:null),k=null)}})};q.prototype.toJSON=function(){return{sys:xnm.aio.netatmo.DM.SYS,username:this.user,password:this.password}};q.prototype.equalsTo=function(a){return a&&a instanceof q?this.user==a.user&&this.password==a.password:
!1};q.pause=function(a){for(var b in g)if(g.hasOwnProperty(b)){var d=g[b];d&&d.weather&&d.weather.timer&&clearTimeout(d.weather.timer);d&&d.thermo&&d.thermo.timer&&clearInterval(d.thermo.timer)}g={};a&&a()};return q}();
xnm.aio.netatmo.MNetatmo=function(){var g=function(e){this._logger=require("x.logger.js").getLogger("xnm.aio.netatmo.MNetatmo");this._interval=0;this._on={};this._updateInterval=12E4;this._url=null;this._username=e?e.username:null;this._password=e?e.password:null;this._basicAuth=e?e.basicAuth:null};g.CLOUD_URL="cloud.mediola.com";g.prototype={_doUpdate:function(e){var f=this;APP.isInDemoMode||this.getStates(null,function(g,k){if(k&&k.XC_SUC){XC.debugf("[MNetatmo] Received update.");for(var c in k.XC_SUC){var p=
k.XC_SUC[c],m;for(m in p){var u=p[m],w=c+"_"+m;if(u.states)for(var v in u.states)CommandHandler.setState(w+":"+v,u.states[v],!0)}}e&&e();if(Array.isArray(f._on.update))for(c={type:"update"},p=0;p<f._on.update.length;p++)(m=f._on.update[p])&&m(c)}})},_sendRequest:function(e,f){"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var g=require("https"),k=this._getURL(),k=k.replace("https://",""),k={host:k,method:"GET",path:e||"/",headers:{}},c=this._getBasicAuthHeader();
c&&(k.headers.Authorization=c);var p=this,m=f,u=g.request(k,function(c){c.setEncoding("utf-8");var e="";c.on("data",function(c){e+=c});c.on("end",function(){p._logger.log("trace","http reponse:"+e+" statusCode:"+c.statusCode);if(200!=c.statusCode)m&&m(Error("http response with code:"+c.statusCode),null);else try{var k=JSON.parse(e);k&&k.XC_SUC?m&&m(null,k.XC_SUC):k&&k.XC_ERR?m&&m(Error(k.XC_ERR.msg)):m&&m(Error("http reponse format valid"));m=null}catch(f){p._logger.log("trace","http reponse is not valid json:"+
f.message),m&&m(f,null),m=null}})});u.setTimeout(1E4,function(){p._logger.log("trace","http request timeout");u.abort();m&&m(Error("http timeout"));m=null});u.on("error",function(c){p._logger.log("trace","http request error:"+c.message);m&&m(c);m=null});u.end()},_getURL:function(){return this._url?this._url:g.CLOUD_URL},_getBasicAuthHeader:function(){return this._basicAuth?this._basicAuth:this._username?"Basic "+(new Buffer(this._username+":"+(this._password?this._password:""))).toString("base64"):
null},_getStates:function(e){this._sendRequest("/netatmo/getStates",e)},addEventListener:function(e,f){this._on[e]||(this._on[e]=[]);this._on[e].push(f)},setUrl:function(e){this._url=e},getDevices:function(e){this._sendRequest("/netatmo/getDevices",e)},getStates:function(e,f,g){this._getStates(function(k,c){if(k)g&&g(null);else if(f){var p={},m;for(m in c){var u=c[m];if(u)for(var w in u)if(f&&f.address==w){var v=u[w];if(v&&v.states){p=v.states;break}}}if(e)for(var y in p)e.setState(f.id+":"+y,p[y]);
g&&g(p)}else g&&g(c)})},removeEventListener:function(e,f){if(this._on[e])for(var g=0;g<this._on[e].length;g++)if(this._on[e][g]===f){this._on[e].splice(g,1);break}},startUpdating:function(e){if(!this._interval)if(APP.isInDemoMode)XC.debugf("[MNetatmo.startUpdating] Ignored. App is in demo mode.");else{var f=this;XC.debugf("[MNetatmo.startUpdating] Start.");this._doUpdate();this._interval=setInterval(function(){f._doUpdate()},this._updateInterval)}},stopUpdating:function(){clearInterval(this._interval);
XC.debugf("[MNetatmo.stopUpdating] Stop.")}};return g}();
xnm.aio.netatmo.DM=function(){var g=function(e,c){this.code=e;this.message=c;this.stack=Error().stack};g.prototype=Error();g.prototype.name="NetatmoDmError";g.prototype.code=0;g.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var e=g.ERROR_CODE,f=[{type:"float",name:"absolute pressure",ref:{value:"absPres"}},{type:"int",name:"co2",ref:{value:"co2"}},{type:"int",name:"humidity",ref:{value:"hum"}},{type:"int",name:"noise",ref:{value:"noise"}},{type:"float",
name:"pressure",ref:{value:"pres"}},{type:"float",name:"rain",ref:{value:"rain"}},{type:"float",name:"rain last hour",ref:{value:"rain1h"}},{type:"float",name:"rain today",ref:{value:"rain24h"}},{type:"float",name:"temperature",ref:{value:"temp"}},{type:"int",name:"time max temperatue",ref:{value:"timeMaxTemp"}},{type:"int",name:"time min temperatue",ref:{value:"timeMinTemp"}},{type:"float",name:"max temperatue",ref:{value:"maxTemp"}},{type:"float",name:"min temperatue",ref:{value:"minTemp"}},{type:"int",
name:"wind direction",ref:{value:"winD"}},{type:"float",name:"wind speed",ref:{value:"winS"}},{type:"int",name:"gust wind direction",ref:{value:"gwinD"}},{type:"float",name:"gust wind speed",ref:{value:"gwinS"}},{type:"int",name:"last measure time",ref:{value:"mesureT"}},{type:"int",name:"time max wind",ref:{value:"timeMaxWind"}},{type:"int",name:"max wind direction",ref:{value:"maxWinD"}},{type:"float",name:"max wind speed",ref:{value:"maxWinS"}},{type:"float",name:"rf level",ref:{value:"rf"}},{type:"enum",
name:"rf status",ref:{value:"rfStatus",options:["very_low","low","medium","high","full"]}},{type:"float",name:"battery level",ref:{value:"bat",extMeta:"3000-6000"}},{type:"enum",name:"battery status",ref:{value:"batStatus",options:["very_low","low","medium","high","full"]}},{type:"float",name:"wifi level",ref:{value:"wifi"}},{type:"enum",name:"wifi status",ref:{value:"wifiStatus",options:["bad","middle","good","very_good"]}},{type:"enum",name:"mode",ref:{value:"mode",options:"auto away frost-guard manu off boost".split(" ")}},
{type:"float",name:"manual temperature",ref:{value:"manuT",extMeta:"5.5-30",scale:"0.5"}},{type:"int",name:"manual/boost endtime",ref:{value:"tempEnd"}},{type:"float",name:"measured temperature",ref:{value:"currentTemp"}},{type:"int",name:"manual/boost duration",ref:{value:"tempDuration",extMeta:"15-720",scale:"15"}},{type:"string",name:"manual/boost endtime string",ref:{value:"tempEndStr"}},{type:"string",name:"time string max temperatue",ref:{value:"timeMaxTempStr"}},{type:"string",name:"time string min temperatue",
ref:{value:"timeMinTempStr"}},{type:"string",name:"last measure time string",ref:{value:"mesureTStr"}},{type:"string",name:"time string max wind",ref:{value:"timeMaxWindStr"}},{type:"float",name:"felt temperature",ref:{value:"tempFelt"}},{type:"string",name:"wind direction named",ref:{value:"winDName",options:"N NO O SO S SW W NW".split(" ")}},{type:"enum",name:"temperature trend",ref:{value:"tempTrend",options:["up","down","stable"]}},{type:"enum",name:"pressure trend",ref:{value:"presTrend",options:["up",
"down","stable"]}},{type:"enum",name:"health index",ref:{value:"healthIdx",options:["healthy","fine","fair","poor","unhealthy"]}},{type:"int",name:"health index level",ref:{value:"healthIdxLvl",extMeta:"0-4"}}],t=[{type:"enum",name:"auto",ref:{value:"thermoAuto"}},{type:"enum",name:"away",ref:{value:"thermoAway"}},{type:"enum",name:"frost-guard",ref:{value:"thermoHg"}},{type:"enum",name:"off",ref:{value:"thermoOff"}},{type:"enum",name:"max",ref:{value:"thermoMax"}},{type:"float",name:"manu",ref:{value:"thermoManu",
ext:"%f",extMeta:"5.5-30",scale:"0.5"}},{type:"enum",name:"up",ref:{value:"thermoUp"}},{type:"enum",name:"down",ref:{value:"thermoDown"}},{type:"int",name:"manual/boost duration",ref:{value:"tempDuration",ext:"%d",extMeta:"15-720",scale:"15"}}];return{SYS:"netatmo",getGatewayType:function(){return[{sys:this.SYS,name:"Netatmo (Online)",port:443}]},getGatewayDeviceType:function(e){return[{sys:this.SYS,type:"NAMain",name:"Base Station"},{sys:this.SYS,type:"NAModule1",name:"Outdoor module"},{sys:this.SYS,
type:"NAModule4",name:"Additional indoor module"},{sys:this.SYS,type:"NAModule3",name:"Rain gauge module"},{sys:this.SYS,type:"NAModule2",name:"Wind gauge module"},{sys:this.SYS,type:"NATherm1",name:"Thermostat"},{sys:this.SYS,type:"NHC",name:"Home Coach"}]},_checkInfo:function(k,c,f){if(k)if(k.gateway)if(k.type)if(k.address)if(c.data&&c.data.gateways&&0!==c.data.gateways.length){c=c.data.gateways;var m,t;for(m=0;m<c.length;m++)if(c[m].index===k.gateway){t=c[m];break}t?f():f(new g(e.NOT_FOUND,"gateway with index "+
k.gateway+" not exists"))}else f(new g(e.NOT_FOUND,"gateway with index "+k.gateway+" not exists"));else f(new g(e.INVALID,"address is invalid"));else f(new g(e.INVALID,"type is invalid"));else f(new g(e.INVALID,"gateway is invalid"));else f(new g(e.INVALID,"info is invalid"))},createGateway:function(k,c,f){k?k.refreshToken||k.username&&k.password?f(null,k):f(new g(e.INVALID,"refreshToken is invalid")):f(new g(e.INVALID,"info is invalid"))},updateGateway:function(k,c,f,m){c?c.refreshToken||c.username&&
c.password?m(null,c):m(new g(e.INVALID,"refreshToken is invalid")):m(new g(e.INVALID,"info is invalid"))},deleteGateway:function(e,c,f){f()},createDevice:function(e,c,f){this._checkInfo(e,c,function(c){f(c,e)})},updateDevice:function(e,c,f){this._checkInfo(e,c,function(c){f(c,e)})},deleteDevice:function(e,c,f){f(null,e)},applyUIFilter:function(e,c){var f=function(c,e){if("*"==c)return!0;for(var f=!1,k=0;k<c.length;k++)if(c[k]==e){f=!0;break}return f},g=function(c,e,k){var g=[];switch(k.catagory){case "command":c.command&&
c.command.forEach(function(c){f(k.elems,c.type)&&(c=JSON.parse(JSON.stringify(c)),g.push(c))});break;case "status":c.status&&c.status.forEach(function(c){f(k.elems,c.type)&&(c=JSON.parse(JSON.stringify(c)),g.push(c))})}return g},t=function(c,e){var f=[],k=null;if(k=this.getCommandStatusMap(c))k=g(k,c,e),f=f.concat(k);return f};if(!e.sys)return null;var w=JSON.parse(JSON.stringify(e)),v=null;switch(c.catagory){case "command":v=t.call(this,e,c);w.command=v;break;case "status":v=t.call(this,e,c);w.status=
v;break;default:return null}return v&&0!=v.length?w:null},applyIPEventFilter:function(e,c){if(!e.sys)return null;var f=JSON.parse(JSON.stringify(e)),g=this.getIPevtMap(e);if(!g)return f;f.ipevt=g.ipevt;return f},getCommandStatusMap:function(e){var c={command:[],status:[]};switch(e.type){case "NAMain":c.status.push(f[25]);c.status.push(f[26]);break;case "NAModule1":case "NAModule2":case "NAModule3":case "NAModule4":case "NATherm1":c.status.push(f[21]);c.status.push(f[22]);c.status.push(f[23]);c.status.push(f[24]);
"NATherm1"==e.type&&(c.status.push(f[27]),c.status.push(f[28]),c.status.push(f[29]),c.status.push(f[30]),c.status.push(f[31]),c.status.push(f[32]));break;case "NHC":c.status.push(f[25]),c.status.push(f[26])}"NATherm1"==e.type&&(c.command=t);if(e.dashboard_data)for(var g in e.dashboard_data)if(e.dashboard_data.hasOwnProperty(g))switch(g){case "AbsolutePressure":c.status.push(f[0]);break;case "CO2":c.status.push(f[1]);break;case "Humidity":c.status.push(f[2]);c.status.push(f[37]);break;case "Noise":c.status.push(f[3]);
break;case "Pressure":c.status.push(f[4]);break;case "Rain":c.status.push(f[5]);break;case "sum_rain_1":c.status.push(f[6]);break;case "sum_rain_24":c.status.push(f[7]);break;case "Temperature":c.status.push(f[8]);break;case "date_max_temp":c.status.push(f[9]);c.status.push(f[33]);break;case "date_min_temp":c.status.push(f[10]);c.status.push(f[34]);break;case "max_temp":c.status.push(f[11]);break;case "min_temp":c.status.push(f[12]);break;case "WindAngle":c.status.push(f[13]);c.status.push(f[38]);
break;case "WindStrength":c.status.push(f[14]);break;case "GustAngle":c.status.push(f[15]);break;case "GustStrength":c.status.push(f[16]);break;case "time_utc":c.status.push(f[17]);c.status.push(f[35]);break;case "date_max_wind_str":c.status.push(f[18]);c.status.push(f[36]);break;case "max_wind_angle":c.status.push(f[19]);break;case "max_wind_str":c.status.push(f[20]);break;case "temp_trend":c.status.push(f[39]);break;case "pressure_trend":c.status.push(f[40]);break;case "health_idx":c.status.push(f[41]),
c.status.push(f[42])}return c},getIPevtMap:function(e){return(e=this.getCommandStatusMap(e))?{ipevt:e.status}:null},calcFeltTemp:function(e,c,f){var g=0;if(f&&"object"==typeof f&&0===f.feel_like_algo)f=243.5,c=Math.log(.01*c)+17.67*e/(f+e),c=f*c/(17.67-c)+273.15,g=e+.5555*(6.11*Math.exp(5417.753*(1/273.16-1/c))-10);else{f=[-42.379,2.04901523,10.14333127,-.22475541,-.00683783,-.05481717,.00122874,8.5282E-4,-1.99E-6];e=9*e/5+32;var g=e*e,t=c*c,g=f[0]+f[1]*e+f[2]*c+f[3]*e*c+f[4]*g+f[5]*t+f[6]*g*c+f[7]*
e*t+f[8]*g*t,g=5*(g-32)/9}return Math.round(10*g)/10}}}();
xnm.aio.netatmo.Handler=function(){var g=function(){this._updateListener=[]};g.prototype.Cloud=xnm.aio.netatmo.Cloud;g.prototype.MNetatmo=xnm.aio.netatmo.MNetatmo;g.prototype.devicemanager=xnm.aio.netatmo.DM;g.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"netatmo")};g.prototype.resolveGateway=function(e){return e.refreshToken||e.username&&e.password?new xnm.aio.netatmo.Cloud(e.username,e.password,e.refreshToken):null};g.prototype.getDeviceCommands=function(e,f){var g=xnm.aio.netatmo.DM.applyUIFilter(e,
{catagory:"command",elems:"*"}),g=g?g.command:[];f&&f(null,g)};g.prototype.getDeviceStatus=function(e,f){var g=xnm.aio.netatmo.DM.applyUIFilter(e,{catagory:"status",elems:"*"}),g=g?g.status:[];f&&f(null,g)};g.prototype.login=function(e,f){var g=this.resolveGateway(e);g?g.auth(function(e,c){e?f&&f(e):f&&f(e,{refreshToken:c.refresh_token})}):f&&f(Error("gateway json format invalid"))};g.prototype.doCommand=function(e,f,g,k){(e=this.resolveGateway(e))?e.executeCommandCreator(f,g,function(c){k&&k(c)}):
k&&k(Error("gateway json format invalid"))};g.prototype.doStatus=function(e,f,g,k,c){(f=this.resolveGateway(f))?f.getStatesCreator(null,[{id:e,device:g,status:k}],function(e,f){e?c&&c(e):c&&c(null,f[0])}):c&&c(Error("gateway json format invalid"))};g.prototype.getDeviceList=function(e,f){var g=this.resolveGateway(e);g?g.getDeviceList(f):f&&f(Error("gateway json format invalid"))};g.prototype.getCamList=function(e,f){var g=this.resolveGateway(e);g?g.getCamList(f):f&&f(Error("gateway json format invalid"))};
g.prototype.pause=function(e){xnm.aio.netatmo.Cloud.pause(e)};g.prototype.addUpdateListener=function(e){e&&-1==this._updateListener.indexOf(e)&&this._updateListener.push(e)};g.prototype.getDevice=function(e){return new this.MNetatmo(e)};g.prototype.setMNetatmoCloudUrl=function(e){this.MNetatmo.CLOUD_URL=e};return g}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.netatmo.Handler);
