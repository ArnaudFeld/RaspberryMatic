var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.netatmo=xnm.aio.netatmo||{};
xnm.aio.netatmo.Cloud=function(){var n={},g={},a={},d={},b=function(a){return a.refreshToken?a.refreshToken:a.user?g[a.user]:null},f=function(a){var m=b(a);if(!m)return null;n[m]||(n[m]={cloud:a});return n[m].cred?n[m].cred:{refresh_token:m}},e=function(a,b){var m=b.refresh_token;a.refreshToken||(a.refreshToken=m);a.user&&(g[a.user]=m);n[m]||(n[m]={cloud:a});n[m].cred=b;b.expires_in&&(b._expireTime=(new Date).getTime()+1E3*b.expires_in-6E5)},c=function(a){return(a=f(a))&&a._expireTime?(new Date).getTime()>
a._expireTime:!1},h=function(a){var m=b(a);if(!m)return null;n[m]||(n[m]={cloud:a});n[m].weather||(n[m].weather={updateData:{running:!1,error:null}});return n[m].weather},k=function(a){a=h(a);a.timer&&clearTimeout(a.timer);a.updateData={running:!0,error:null}},u=function(a,c,d){var m=b(a),l=h(a);l.updateData={running:!1,error:c};try{if(!c&&d){var e=require("xnm.aio.netatmo.js")._updateListener;if(e&&0<e.length)for(var p=0;p<e.length;p++)e[p]&&e[p].updateWeather&&e[p].updateWeather(a,l.data,d)}}catch(x){}l.timer&&
clearTimeout(l.timer);e=r(a);c?l.data=null:d&&(l.data=d);d=l.tmpCBs;l.tmpCBs=[];if(d)for(p=0;p<d.length;p++)if(c)d[p](c);else a.getWeatherStatus(d[p]);c?l.timer=setTimeout(function(){n[m].cloud.getStationsData(null)},6E4):(a=r(a),e&&a&&e==a&&1>l.retry?(l.retry=l.retry?l.retry+1:1,c=60*l.retry,l.delay=c,l.timer=setTimeout(function(){n[m].cloud.getStationsData(null)},1E3*c)):(l.retry=0,(e=l.delay)||(e=0),c=6E5,a&&(d=Math.round((new Date).getTime()/1E3),d>a&&(c=600-(d-a)%600+30)),require("x.logger.js").getLogger("xnm.aio.netatmo.Cloud").log("debug",
"weather station next poll in t:"+c/60+" min delay:"+e),l.timer=setTimeout(function(){n[m].cloud.getStationsData(null)},1E3*c+1E3*e)))},r=function(a){a=h(a);if(!a.data)return 0;for(var b=0;b<a.data.length;b++)if(a.data[b]&&a.data[b].dashboard_data&&a.data[b].dashboard_data.time_utc)return a.data[b].dashboard_data.time_utc;return 0},t=function(a){var c=b(a);if(!c)return null;n[c]||(n[c]={cloud:a});n[c].homecoach||(n[c].homecoach={updateData:{running:!1,error:null}});return n[c].homecoach},y=function(a){a=
t(a);a.timer&&clearTimeout(a.timer);a.updateData={running:!0,error:null}},w=function(a,c,d){var m=b(a),e=t(a);e.updateData={running:!1,error:c};try{if(!c&&d){var l=require("xnm.aio.netatmo.js")._updateListener;if(l&&0<l.length)for(var p=0;p<l.length;p++)l[p]&&l[p].updateHomeCoach&&l[p].updateHomeCoach(a,e.data,d)}}catch(x){}e.timer&&clearTimeout(e.timer);l=A(a);c?e.data=null:d&&(e.data=d);d=e.tmpCBs;e.tmpCBs=[];if(d)for(p=0;p<d.length;p++)if(c)d[p](c);else a.getWeatherStatus(d[p]);c?e.timer=setTimeout(function(){n[m].cloud.getHomeCoachsData(null)},
6E4):(a=A(a),l&&a&&l==a&&1>e.retry?(e.retry=e.retry?e.retry+1:1,c=60*e.retry,e.delay=c,e.timer=setTimeout(function(){n[m].cloud.getHomeCoachsData(null)},1E3*c)):(e.retry=0,(l=e.delay)||(l=0),c=6E5,a&&(d=Math.round((new Date).getTime()/1E3),d>a&&(c=600-(d-a)%600+30)),e.timer=setTimeout(function(){n[m].cloud.getHomeCoachsData(null)},1E3*c+1E3*l)))},A=function(a){a=t(a);if(!a.data)return 0;for(var b=0;b<a.data.length;b++)if(a.data[b]&&a.data[b].dashboard_data&&a.data[b].dashboard_data.time_utc)return a.data[b].dashboard_data.time_utc;
return 0},v=function(a){var c=b(a);if(!c)return null;n[c]||(n[c]={cloud:a});n[c].thermo||(n[c].thermo={updateData:{running:!1,error:null}});return n[c].thermo},D=function(a){a=v(a);a.timer&&clearTimeout(a.timer);a.updateData={running:!0,error:null}},B=function(a,c,d){var m=b(a),e=v(a);try{if(!c&&d){var l=require("xnm.aio.netatmo.js")._updateListener;if(l&&0<l.length)for(var p=0;p<l.length;p++)l[p]&&l[p].updateThermo&&l[p].updateThermo(a,e.data,d)}}catch(x){}e.timer&&clearTimeout(e.timer);e.updateData=
{running:!1,error:c};c?e.data=null:d&&(e.data=d);d=e.tmpCBs;e.tmpCBs=[];if(d)for(l=0;l<d.length;l++)if(c)d[l](c);else a.getThermoStatus(d[l]);e.timer=c?setTimeout(function(){n[m].cloud.getThermostatsData(null)},6E4):setTimeout(function(){n[m].cloud.getThermostatsData(null)},18E5)},C=function(a,c){var d=b(a);if(!c.module)return 60;a=v(a);a.duration||(n[d].thermo.duration={});d=a.duration[c.module];if(!d){a:{if(c.module&&XC&&XC.localStorage){if(d=XC.localStorage.getItem("netatmo"))try{d=JSON.parse(d)}catch(z){}if(d&&
d.duration){d=d.duration[c.module];break a}}d=null}a.duration[c.module]=d}d||(d=60);return d},E=function(a,c,b){a=v(a);a.duration||(a.duration={});if(c.module&&(a.duration[c.module]=b,c.module&&XC&&XC.localStorage)){if(a=XC.localStorage.getItem("netatmo"))try{a=JSON.parse(a)}catch(z){}a&&"object"==typeof a||(a={});a.duration||(a.duration={});a.duration[c.module]=b;XC.localStorage.setItem("netatmo",JSON.stringify(a))}},F=function(a,c){a=v(a);if(a.data)for(var b=0;b<a.data.length;b++){var d=a.data[b];
if(d&&d._id==c.address&&d.modules)for(var e=0;e<d.modules.length;e++){var m=d.modules[e];if(m&&m._id==c.module)return m.setpoint}}return null},q=function(a,c,b){this._logger=require("x.logger.js").getLogger("xnm.aio.netatmo.Cloud");this.user=a;this.password=c;this.refreshToken=b;this._scope="read_station read_thermostat read_homecoach write_thermostat read_camera access_camera read_presence access_presence".split(" ");this._scopeFallback="read_station read_thermostat read_homecoach write_thermostat read_camera access_camera read_presence".split(" ")};
q.prototype.executeCommandCreator=function(a,c,b){if(c&&c.value){var d=this,e={},m=C(this,a);F(this,a);switch(c.value){case "thermoAuto":e.setpoint_mode="program";break;case "thermoAway":e.setpoint_mode="away";break;case "thermoHg":e.setpoint_mode="hg";break;case "thermoOff":e.setpoint_mode="off";break;case "thermoMax":e.setpoint_mode="max";e.setpoint_endtime=Math.round(((new Date).getTime()+6E4*m)/1E3);break;case "thermoManu":if(null==c.ext||"undefined"==typeof c.ext){b&&b(Error("command ext invalid"));
return}var l=c.ext;"string"==typeof c.ext&&(l=parseFloat(c.ext));5.5>l&&(l=5.5);30<l&&(l=30);e.setpoint_mode="manual";e.setpoint_endtime=Math.round(((new Date).getTime()+6E4*m)/1E3);e.setpoint_temp=l;break;case "tempDuration":if(null==c.ext||"undefined"==typeof c.ext){b&&b(Error("command ext invalid"));return}m=c.ext;"string"==typeof c.ext&&(m=parseFloat(c.ext));15>m&&(m=15);720<m&&(m=720);E(this,a,m);b&&b();return;default:b&&b(Error("unknow command"))}this.setThermPoint(a,e,function(c){if(c)b&&b(c);
else{c=v(d);c.data||(c.data=[]);var m;for(m=0;m<c.data.length;m++)if(c.data[m]&&c.data[m]._id==a.address){var l=c.data[m];break}l||(l={_id:a.address,modules:[]},c.data.push(l));for(m=0;m<l.modules.length;m++)if(l.modules[m]&&l.modules[m]._id==a.module){var p=l.modules[m];break}p||(p={_id:a.module},l.modules.push(p));p.setpoint=e;b&&b()}})}else b&&b(Error("command format invalid"))};q.prototype.getStatesCreator=function(c,b,e){b?this.getAllStatus(function(c,m){for(var l=[],p=0;p<b.length;p++){var h=
b[p];if(h.id){var f,k="?";if(!c&&m&&h.device&&h.device.type&&(f="NAMain"==h.device.type||"NHC"==h.device.type?h.device.address:h.device.address+"|"+h.device.module)&&h.status&&h.status.value&&(f=m[f]))if("tempFelt"==h.status.value)k=f.temp,f=f.hum,k="undefined"!=typeof k&&"undefined"!=typeof f?"NHC"==h.device.type?xnm.aio.netatmo.DM.calcFeltTemp(k,f,d):xnm.aio.netatmo.DM.calcFeltTemp(k,f,a):"?";else if("winDName"==h.status.value)k=f.winD,null===k||"undefined"==typeof k?k="?":(k=Number(k),k=isNaN(k)?
"?":23<k&&68>=k?"NO":68<k&&113>=k?"O":113<k&&158>=k?"SO":158<k&&203>=k?"S":203<k&&248>=k?"SW":248<k&&293>=k?"W":293<k&&338>=k?"NW":"N");else if(k=f[h.status.value],null==k||"undefined"==typeof k)k="?";l.push({id:h.id,status:k})}}e&&e(null,l)}):e&&e(Error("deviceList is null"))};q.prototype.getAllStatus=function(a){var c=this,b={};this.getWeatherStatus(function(d,e){d?a&&a(d):c.getThermoStatus(function(d,m){d?a&&a(d):c.getHomeCoachStatus(function(c,d){if(c)a&&a(c);else{for(var l in e)e.hasOwnProperty(l)&&
(b[l]=e[l]);for(l in m)m.hasOwnProperty(l)&&(b[l]=m[l]);for(l in d)d.hasOwnProperty(l)&&(b[l]=d[l]);a&&a(null,b)}})})})};q.prototype.getDeviceList=function(a){var c=this;this.getStationsData(function(b,d){b?a&&a(b):c.getThermostatsData(function(b,e){b?a&&a(b):c.getHomeCoachsData(function(c,b){if(c)a&&a(c);else{c={weather:[],thermostat:[]};if(d){for(var m=[],l=0;l<d.length;l++){var h=d[l];if(h&&h._id&&h.type){var k=h.station_name,f=h.module_name,p={address:h._id,type:h.type,name:k+" ("+f+")"};p.dashboard_data=
h.dashboard_data;p.modules=[];if(h.modules)for(var g=0;g<h.modules.length;g++)h.modules[g]&&h.modules[g]._id&&h.modules[g].type&&(f=h.modules[g].module_name,p.modules.push({address:h._id,module:h.modules[g]._id,type:h.modules[g].type,name:k+" ("+f+")",dashboard_data:h.modules[g].dashboard_data}));m.push(p)}}c.weather=m}if(e){m=[];for(l=0;l<e.length;l++)if((h=e[l])&&h._id&&h.type&&(k=h.station_name,h.modules))for(p=0;p<h.modules.length;p++)h.modules[p]&&h.modules[p]._id&&h.modules[p].type&&(f=h.modules[p].module_name,
m.push({address:h._id,module:h.modules[p]._id,type:h.modules[p].type,name:k+" ("+f+")"}));c.thermostat=m}if(b){m=[];for(l=0;l<b.length;l++)(h=b[l])&&h._id&&h.type&&(k=h.module_name,f={address:h._id,type:h.type,name:h.name},k&&(f.name+=" ("+k+")"),f.dashboard_data=h.dashboard_data,f.modules=[],m.push(f));c.homecoach=m}a&&a(null,c)}})})})};q.prototype.getCamList=function(a){var c=this;this.getCamsData(function(b,d){if(b)a&&a(b);else{b={cam:[]};if(d){for(var e=[],m=0;m<d.length;m++)if(d[m]&&d[m].id){var h=
d[m].name,l=d[m].cameras;if(l)for(var k=0;k<l.length;k++)if(l[k]&&l[k].id){var p="welcome";"NACamera"==l[k].type?p="welcome":"NOC"==l[k].type&&(p="presence");p&&(p={sys:"cam",type:"system",manufacturer:"netatmo",model:p,address:l[k].id},l[k].name&&(p.name=l[k].name+(h?" ("+h+")":"")),e.push(p))}}b.cam=e}d=f(c);if(b.cam&&0<b.cam.length)for(e=0;e<b.cam.length;e++)b.cam[e].refreshToken=d.refresh_token;a&&a(null,b)}})};q.prototype.getWeatherStatus=function(a){var c=function(a,c){var b={};if(c)for(var d=
0;d<c.length;d++){var e=c[d];if(e&&e._id){var m=a._resolveStationStatus(e);m&&(b[e._id]=m);if(e.modules)for(var l=0;l<e.modules.length;l++)(m=a._resolveModuleStatus(e.modules[l]))&&(b[e._id+"|"+e.modules[l]._id]=m)}}return b};this._logger.log("debug","getWeatherStatus");var b=h(this),d=this,e=a;a=null;b&&b.data?(a=c(this,b.data),e&&e(null,a),e=null):this.getStationsData(function(a){a?(e&&e(a),e=null):e&&d.getWeatherStatus(e)})};q.prototype.getHomeCoachStatus=function(a){var c=function(a,c){var b=
{};if(c)for(var d=0;d<c.length;d++){var e=c[d];if(e&&e._id){var m=a._resolveHomeCoachStatus(e);m&&(b[e._id]=m)}}return b};this._logger.log("debug","getHomeCoachStatus");var b=t(this),d=this,e=a;a=null;b&&b.data?(a=c(this,b.data),e&&e(null,a),e=null):this.getHomeCoachsData(function(a){a?(e&&e(a),e=null):e&&d.getHomeCoachStatus(e)})};q.prototype.getThermoStatus=function(a){var c=function(a,c){for(var b={},d=0;d<c.length;d++){var e=c[d];if(e&&e._id&&e.modules)for(var m=0;m<e.modules.length;m++){var l=
a._resolveModuleStatus(e.modules[m]);l&&(b[e._id+"|"+e.modules[m]._id]=l)}}return b},b=v(this),d=this,e=a,m=null;b.updateData.running?(b.tmpCBs||(b.tmpCBs=[]),b.tmpCBs.push(a)):b.data?(m=c(this,b.data),e&&e(null,m),e=null):this.getThermostatsData(function(a){a?(e&&e(a),e=null):e&&d.getThermoStatus(e)})};q.prototype.getCamUrl=function(a,c){var b=this;this._refreshToken(this.refreshToken,function(e,d){if(e)d&&d.error&&(e=Error(d.error),e._code="auth_error"),c&&c(e);else{if(d&&d.access_token)var m=d.access_token;
m?d&&d.scope&&-1==d.scope.indexOf("access_camera")?c&&c(null,"scop_error"):b._getCamsData(m,function(d,e){if(d)e&&e.error&&(d=Error(e.error),d._code="api_error"),c&&c(d);else if(d=null,e.body&&e.body.homes&&(d=e.body.homes),d){for(e=0;e<d.length;e++)if(d[e]&&d[e].cameras){for(var m=d[e].cameras,h=0;h<m.length;h++)if(m[h]&&m[h].id==a&&m[h].vpn_url){var l=m[h];break}if(l)break}l?1==l.is_local?b._getLocalCamUrl(l.vpn_url,function(a,b){c&&c(a,b)}):c&&c(null,l.vpn_url+"/live/index.m3u8"):c&&c("no cam with address:"+
a)}else c&&c("get cams data reponse invalid")}):c&&c(Error("auth response invalid"))}})};q.prototype._resolveStationStatus=function(a){var c={};null!=a.wifi_status&&"undefined"!=typeof a.wifi_status&&(c.wifi=a.wifi_status,c.wifiStatus=86<=c.wifi?"bad":71<=c.wifi?"middle":56<=c.wifi?"good":"very_good");if(a.dashboard_data&&(a=this._resolveDashboard(a.dashboard_data)))for(var b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c};q.prototype._resolveModuleStatus=function(a){var c={};null!=a.rf_status&&"undefined"!=
typeof a.rf_status&&(c.rf=a.rf_status,c.rfStatus=90<=c.rf?"very_low":80<=c.rf?"low":70<=c.rf?"medium":60<=c.rf?"high":"full");if(null!=a.battery_vp&&"undefined"!=typeof a.battery_vp)switch(c.bat=a.battery_vp,a.type){case "NAModule4":c.batStatus=5640<=c.bat?"full":5280<=c.bat?"high":4920<=c.bat?"medium":4560<=c.bat?"low":"very_low";break;case "NAModule1":case "NAModule3":c.batStatus=5500<=c.bat?"full":5E3<=c.bat?"high":4500<=c.bat?"medium":4E3<=c.bat?"low":"very_low";break;case "NAModule2":c.batStatus=
5900<=c.bat?"full":5180<=c.bat?"high":4770<=c.bat?"medium":4360<=c.bat?"low":"very_low";break;case "NATherm1":c.batStatus=4100<=c.bat?"full":3600<=c.bat?"high":3300<=c.bat?"medium":3E3<=c.bat?"low":"very_low"}var b,d;if("NATherm1"==a.type&&(b=this._resolveThermoStat(a)))for(d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);if(a.dashboard_data&&(b=this._resolveDashboard(a.dashboard_data)))for(d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);return c};q.prototype._resolveHomeCoachStatus=function(a){var c={};null!=a.wifi_status&&
"undefined"!=typeof a.wifi_status&&(c.wifi=a.wifi_status,c.wifiStatus=86<=c.wifi?"bad":71<=c.wifi?"middle":56<=c.wifi?"good":"very_good");if(a.dashboard_data&&(a=this._resolveDashboard(a.dashboard_data)))for(var b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c};q.prototype._resolveThermoStat=function(a){var c={};if(a.setpoint){switch(a.setpoint.setpoint_mode){case "program":var b="auto";break;case "away":b="away";break;case "hg":b="frost-guard";break;case "manual":b="manu";break;case "off":b="off";
break;case "max":b="boost"}b&&(c.mode=b);null!=a.setpoint.setpoint_temp&&"undefined"!=typeof a.setpoint.setpoint_temp&&(c.manuT=a.setpoint.setpoint_temp);if(null!=a.setpoint.setpoint_endtime&&"undefined"!=typeof a.setpoint.setpoint_endtime)if(c.tempEnd=a.setpoint.setpoint_endtime,c.tempEndStr=(new Date(1E3*a.setpoint.setpoint_endtime)).toLocaleString(),"undefined"!=typeof dateFormat&&dateFormat)try{c.tempEndStr=dateFormat(c.tempEndStr,"dd mm yyyy, HH:MM:ss")}catch(z){}else c.tempEndStr=c.tempEndStr.toLocaleString()}a.measured&&
(null!=a.measured.time&&"undefined"!=typeof a.measured.time&&(c.mesureT=a.measured.time),null!=a.measured.temperature&&"undefined"!=typeof a.measured.temperature&&(c.currentTemp=a.measured.temperature));c.tempDuration=C(this,{module:a._id});return c};q.prototype._resolveDashboard=function(a){var c=function(a,c){return null!=a[c]&&"undefined"!=typeof a[c]},b={};c(a,"AbsolutePressure")&&(b.absPres=a.AbsolutePressure);c(a,"CO2")&&(b.co2=a.CO2);c(a,"Humidity")&&(b.hum=a.Humidity);c(a,"Noise")&&(b.noise=
a.Noise);c(a,"Pressure")&&(b.pres=a.Pressure);c(a,"Rain")&&(b.rain=a.Rain);c(a,"sum_rain_1")&&(b.rain1h=a.sum_rain_1);c(a,"sum_rain_24")&&(b.rain24h=a.sum_rain_24);c(a,"Temperature")&&(b.temp=a.Temperature);if(c(a,"date_max_temp")){b.timeMaxTemp=a.date_max_temp;var d=1E3*a.date_max_temp;b.timeMaxTempStr=new Date(d);b.timeMaxTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(b.timeMaxTempStr,"dd mm yyyy, HH:MM:ss"):b.timeMaxTempStr.toLocaleString()}c(a,"date_min_temp")&&(b.timeMinTemp=a.date_min_temp,
d=1E3*a.date_min_temp,b.timeMinTempStr=new Date(d),b.timeMinTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(b.timeMinTempStr,"dd.mm.yyyy, HH:MM:ss"):b.timeMinTempStr.toLocaleString());c(a,"max_temp")&&(b.maxTemp=a.max_temp);c(a,"min_temp")&&(b.minTemp=a.min_temp);c(a,"WindAngle")&&(b.winD=a.WindAngle);c(a,"WindStrength")&&(b.winS=a.WindStrength);c(a,"GustAngle")&&(b.gwinD=a.GustAngle);c(a,"GustStrength")&&(b.gwinS=a.GustStrength);c(a,"time_utc")&&(b.mesureT=a.time_utc,d=1E3*a.time_utc,
b.mesureTStr=new Date(d),b.mesureTStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(b.mesureTStr,"dd.mm.yyyy, HH:MM:ss"):b.mesureTStr.toLocaleString());c(a,"date_max_wind_str")&&(b.timeMaxWind=a.date_max_wind_str,d=1E3*a.date_max_wind_str,b.timeMaxWindStr=new Date(d),b.timeMaxWindStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(b.timeMaxWindStr,"dd.mm.yyyy, HH:MM:ss"):b.timeMaxWindStr.toLocaleString());c(a,"max_wind_angle")&&(b.maxWinD=a.max_wind_angle);c(a,"max_wind_str")&&(b.maxWinS=
a.max_wind_str);c(a,"temp_trend")&&(b.tempTrend=a.temp_trend);c(a,"pressure_trend")&&(b.presTrend=a.pressure_trend);if(c(a,"health_idx"))switch(b.healthIdxLvl=a.health_idx,parseInt(b.healthIdx)){case 0:b.healthIdx="healthy";break;case 1:b.healthIdx="fine";break;case 2:b.healthIdx="fair";break;case 3:b.healthIdx="poor";break;case 4:b.healthIdx="unhealthy"}return b};q.prototype.auth=function(a){this._logger.log("debug","auth");var b=f(this),d=this;b?b.access_token?c(this)?this._refreshToken(b.refresh_token,
function(c,b){c?(b&&b.error&&(c=Error(b.error),c._code="refresh_token_error"),a&&a(c)):(e(d,b),a&&a(null,b))}):a&&a(null,b):this._refreshToken(b.refresh_token,function(c,b){c?(b&&b.error&&(c=Error(b.error),c._code="refresh_token_error"),a&&a(c)):(e(d,b),a&&a(null,b))}):this._auth(this._scope.join(" "),function(c,b){if(c){if(b)try{if(b=JSON.parse(b),b.error&&(c=Error(b.error),c._code="auth_error","invalid_request"==b.error&&-1!=d._scope.indexOf("access_presence"))){d._scope=d._scopeFallback;d.auth(a);
return}}catch(G){}a&&a(c)}else e(d,b),a&&a(null,b)})};q.prototype.setThermPoint=function(a,c,b){if(a&&a.address&&a.module)if(c&&c.setpoint_mode)if("max"!=c.setpoint_mode||c.setpoint_endtime)if("manual"!=c.setpoint_mode||c.setpoint_endtime&&c.setpoint_temp){var d=this;this.auth(function(e){e?b&&b(e):d._setThermPoint(f(d).access_token,a.address,a.module,c.setpoint_mode,c.setpoint_endtime,c.setpoint_temp,function(a,c){a?(c&&c.error&&(a=Error(c.error),a._code="api_error"),b&&b(a)):b&&b(null,c)})})}else b&&
b(Error("param format invalid"));else b&&b(Error("param format invalid"));else b&&b(Error("param format invalid"));else b&&b(Error("device format invalid"))};q.prototype.getStationsData=function(c){this._logger.log("debug","getStationsData");var b=this;this.auth(function(d){d?c&&c(d):(d=h(b))&&d.updateData&&d.updateData.running?(d.tmpCBs||(d.tmpCBs=[]),d.tmpCBs.push(c)):(k(b),b._getStationsData(f(b).access_token,null,function(d,e){d?(e&&e.error&&(d=Error(e.error),d._code="api_error"),u(b,d,null),
c&&c(d)):(d=null,e.body&&e.body.devices&&(d=e.body.devices),e.body&&e.body.user&&e.body.user.administrative&&(a=e.body.user.administrative),u(b,null,d),c&&c(null,d))}))})};q.prototype.getThermostatsData=function(a){var c=this;this.auth(function(b){b?a&&a(b):(b=v(this))&&b.updateData&&b.updateData.running?(b.tmpCBs||(b.tmpCBs=[]),b.tmpCBs.push(a)):(D(c),c._getThermostatsData(f(c).access_token,null,function(b,d){b?(d&&d.error&&(b=Error(d.error),b._code="api_error"),B(c,b,null),a&&a(b)):(b=null,d.body&&
d.body.devices&&(b=d.body.devices),B(c,null,b),a&&a(null,b))}))})};q.prototype.getHomeCoachsData=function(a){this._logger.log("debug","getHomeCoachsData");var c=this;this.auth(function(b){b?a&&a(b):(b=t(this))&&b.updateData&&b.updateData.running?(b.tmpCBs||(b.tmpCBs=[]),b.tmpCBs.push(a)):(y(c),c._getHomeCoachsData(f(c).access_token,null,function(b,e){b?(e&&e.error&&(b=Error(e.error),b._code="api_error"),w(c,b,null),a&&a(b)):(b=null,e.body&&e.body.devices&&(b=e.body.devices),e.body&&e.body.user&&e.body.user.administrative&&
(d=e.body.user.administrative),w(c,null,b),a&&a(null,b))}))})};q.prototype.getCamsData=function(a){this._logger.log("debug","getCamsData");var b=this;this.auth(function(c){c?a&&a(c):b._getCamsData(f(b).access_token,function(b,c){b?(c&&c.error&&(b=Error(c.error),b._code="api_error"),a&&a(b)):(b=null,c.body&&c.body.homes&&(b=c.body.homes),a&&a(null,b))})})};q.prototype._auth=function(a,b){this._logger.log("trace","_auth");this._doRequest("POST","/oauth2/token",{grant_type:"password",client_id:"564b2c5245a1e3173cb21d3b",
client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",username:this.user,password:this.password,scope:a},b)};q.prototype._refreshToken=function(a,b){this._logger.log("trace","_refreshToken");this._doRequest("POST","/oauth2/token",{grant_type:"refresh_token",client_id:"564b2c5245a1e3173cb21d3b",client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",refresh_token:a},b)};q.prototype._setThermPoint=function(a,b,c,d,e,h,k){a={access_token:a,device_id:b,module_id:c,setpoint_mode:d};e&&(a.setpoint_endtime=
e);h&&(a.setpoint_temp=h);this._doRequest("GET","/api/setthermpoint",a,k)};q.prototype._getStationsData=function(a,b,c){this._logger.log("debug","_getStationsData");a={access_token:a};b&&(a.device_id=b);this._doRequest("GET","/api/getstationsdata",a,c)};q.prototype._getHomeCoachsData=function(a,b,c){this._logger.log("debug","_getHomeCoachsData");a={access_token:a};b&&(a.device_id=b);this._doRequest("GET","/api/gethomecoachsdata",a,c)};q.prototype._getThermostatsData=function(a,b,c){a={access_token:a};
b&&(a.device_id=b);this._doRequest("GET","/api/getthermostatsdata",a,c)};q.prototype._getCamsData=function(a,b){this._doRequest("GET","/api/gethomedata",{access_token:a},b)};q.prototype._getLocalCamUrl=function(a,b){var c=this;this._logger.log("trace","ping cam "+a);this._doUrlRequest("get",a+"/command/ping",null,function(d,e){!d&&e&&e.local_url?c._doUrlRequest("get",e.local_url+"/command/ping",null,function(c,d){c||!d||d.local_url!=e.local_url?b&&b(null,a+"/live/index.m3u8"):b&&b(null,d.local_url+
"/live/index.m3u8")}):b&&b(null,a+"/live/index.m3u8")})};q.prototype._doRequest=function(a,b,c,d){this._doUrlRequest(a,"https://api.netatmo.net"+b,c,d)};q.prototype._doUrlRequest=function(a,b,c,d){var e=this,h=d,k=null;try{k=JSON.parse(JSON.stringify(c)),k.username&&(k.username="xxxxxx"),k.password&&(k.password="xxxxxx")}catch(x){k=c}this._logger.log("trace","send "+a+" req to:"+b+" data:"+JSON.stringify(k));$.ajax({url:b,type:a,timeout:1E4,dataType:"json",data:c,cache:!1,success:function(a){e._logger.log("trace",
"http request success:"+JSON.stringify(a));d&&d(null,a)},error:function(a,b,c){b="http request error:"+(a?a.status:"0")+"-"+b;e._logger.log("warn","http request error:"+b);b=Error(b);c&&(e._logger.log("warn","http request http error:"+c),b.httpError=!0,b.statusCode=a?a.status:0);h&&(h(b,a?a.responseText:null),h=null)}})};q.prototype.toJSON=function(){return{sys:xnm.aio.netatmo.DM.SYS,username:this.user,password:this.password}};q.prototype.equalsTo=function(a){return a&&a instanceof q?this.user==a.user&&
this.password==a.password:!1};q.pause=function(a){for(var b in n)if(n.hasOwnProperty(b)){var c=n[b];c&&c.weather&&c.weather.timer&&clearTimeout(c.weather.timer);c&&c.thermo&&c.thermo.timer&&clearInterval(c.thermo.timer)}n={};a&&a()};return q}();
xnm.aio.netatmo.MNetatmo=function(){var n=function(g){this._logger=require("x.logger.js").getLogger("xnm.aio.netatmo.MNetatmo");this._interval=0;this._on={};this._updateInterval=12E4;this._url=null;this._username=g?g.username:null;this._password=g?g.password:null;this._basicAuth=g?g.basicAuth:null};n.CLOUD_URL="cloud.mediola.com";n.prototype={_doUpdate:function(g){var a=this;APP.isInDemoMode||this.getStates(null,function(d,b){if(b&&b.XC_SUC){XC.debugf("[MNetatmo] Received update.");for(var f in b.XC_SUC){d=
b.XC_SUC[f];for(var e in d){var c=d[e],h=f+"_"+e;if(c.states)for(var k in c.states)CommandHandler.setState(h+":"+k,c.states[k],!0)}}g&&g();if(Array.isArray(a._on.update))for(b={type:"update"},f=0;f<a._on.update.length;f++)(e=a._on.update[f])&&e(b)}})},_sendRequest:function(g,a){"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var d=require("https"),b=this._getURL();b=b.replace("https://","");g={host:b,method:"GET",path:g||"/",headers:{}};(b=this._getBasicAuthHeader())&&
(g.headers.Authorization=b);var f=this,e=a,c=d.request(g,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){f._logger.log("trace","http reponse:"+b+" statusCode:"+a.statusCode);if(200!=a.statusCode)e&&e(Error("http response with code:"+a.statusCode),null);else try{var c=JSON.parse(b);c&&c.XC_SUC?e&&e(null,c.XC_SUC):c&&c.XC_ERR?e&&e(Error(c.XC_ERR.msg)):e&&e(Error("http reponse format valid"));e=null}catch(r){f._logger.log("trace","http reponse is not valid json:"+
r.message),e&&e(r,null),e=null}})});c.setTimeout(1E4,function(){f._logger.log("trace","http request timeout");c.abort();e&&e(Error("http timeout"));e=null});c.on("error",function(a){f._logger.log("trace","http request error:"+a.message);e&&e(a);e=null});c.end()},_getURL:function(){return this._url?this._url:n.CLOUD_URL},_getBasicAuthHeader:function(){return this._basicAuth?this._basicAuth:this._username?"Basic "+(new Buffer(this._username+":"+(this._password?this._password:""))).toString("base64"):
null},_getStates:function(g){this._sendRequest("/netatmo/getStates",g)},addEventListener:function(g,a){this._on[g]||(this._on[g]=[]);this._on[g].push(a)},setUrl:function(g){this._url=g},getDevices:function(g){this._sendRequest("/netatmo/getDevices",g)},getStates:function(g,a,d){this._getStates(function(b,f){if(b)d&&d(null);else if(a){b={};for(var e in f){var c=f[e];if(c)for(var h in c)if(a&&a.address==h){var k=c[h];if(k&&k.states){b=k.states;break}}}if(g)for(var u in b)g.setState(a.id+":"+u,b[u]);
d&&d(b)}else d&&d(f)})},removeEventListener:function(g,a){if(this._on[g])for(var d=0;d<this._on[g].length;d++)if(this._on[g][d]===a){this._on[g].splice(d,1);break}},startUpdating:function(g){if(!this._interval)if(APP.isInDemoMode)XC.debugf("[MNetatmo.startUpdating] Ignored. App is in demo mode.");else{var a=this;XC.debugf("[MNetatmo.startUpdating] Start.");this._doUpdate();this._interval=setInterval(function(){a._doUpdate()},this._updateInterval)}},stopUpdating:function(){clearInterval(this._interval);
XC.debugf("[MNetatmo.stopUpdating] Stop.")}};return n}();
xnm.aio.netatmo.Client=function(){var n=function(){var a=function(){this._homes={};this._weather={};this._thermo={};this._coach={};this._states={};this._smartThermoDuraion={}};a.prototype.getStates=function(){return this._states};a.prototype.areStatesExpired=function(){var a={weather:!1,thermo:!1,coach:!1,hasWeatherDevice:!1,hasThermoDevice:!1,hasCoachDevice:!1};this._homes.lastReqTime?this._homes.lastReqOk?(a.weather=!(!this._homes.weather||!this._homes.weather.length),a.hasWeatherDevice=a.weather,
a.thermo=!(!this._homes.thermo||!this._homes.thermo.length),a.hasThermoDevice=a.thermo):300<Math.round((new Date).getTime()/1E3)-this._homes.lastReqTime&&(a.weather=!0,a.thermo=!0):(a.weather=!0,a.thermo=!0);this._coach&&(a.coach=!0);a.weather&&(a.weather=this._isWeatherExpired());a.thermo&&(a.thermo=this._isThermoExpired());a.coach&&(a.coach=this._isCoachExpired());return a};a.prototype._isWeatherExpired=function(){if(!this._weather.lastReqTime)return!0;var a=Math.round((new Date).getTime()/1E3);
return this._weather.lastReqOk?this._weather.weatherTimeChanged?this._weather.expired:660<a-this._weather.lastReqTime?!0:!1:300<a-this._weather.lastReqTime?!0:!1};a.prototype._isThermoExpired=function(){if(!this._thermo.lastReqTime)return!0;var a=Math.round((new Date).getTime()/1E3);return this._thermo.lastReqOk?660<a-this._thermo.lastReqTime?!0:!1:300<a-this._thermo.lastReqTime?!0:!1};a.prototype._isCoachExpired=function(){if(!this._coach.lastReqTime)return!0;var a=Math.round((new Date).getTime()/
1E3);return this._coach.lastReqOk?this._coach.coachTimeChanged?this._coach.expired:660<a-this._coach.lastReqTime?!0:!1:300<a-this._coach.lastReqTime?!0:!1};a.prototype.updateReqTime=function(a,b){switch(a){case "weather":this._weather.lastReqTime=b;break;case "thermo":this._thermo.lastReqTime=b;break;case "coach":this._coach.lastReqTime=b;break;case "homes":this._homes.lastReqTime=b}};a.prototype.updateReqOK=function(a,b){switch(a){case "weather":this._weather.lastReqOk=b;break;case "thermo":this._thermo.lastReqOk=
b;break;case "coach":this._coach.lastReqOk=b;break;case "homes":this._homes.lastReqOk=b}};a.prototype.updateHomesInfo=function(a,b){if(a&&b){this._homes.weather=b.weather;this._homes.thermo=b.thermo;this._homes.coach=b.coach;for(var d in a)this._states[d]=a[d]}};a.prototype.updateWeatherStatus=function(a,b,f){if(a&&b&&f){var e=this._weather.weatherTime;this._weather.weatherTime=b;this._weather.weatherTimeChanged=b!=e;this._weather.expired=660<f-b;if(!this._weather.expired){this._weather.expireTo&&
clearTimeout(this._weather.expireTo);var c=this;this._weather.expireTo=setTimeout(function(){c._weather.expired=!0},1E3*(b+660-f))}for(var d in a)this._states[d]=a[d]}};a.prototype.updateThermoStatus=function(a){if(a)for(var b in a)this._states[b]=a[b]};a.prototype.updateCoachStatus=function(a,b,f){if(a&&b&&f){var e=this._coach.coachTime;this._coach.coachTime=b;this._coach.coachTimeChanged=b!=e;this._coach.expired=660<f-b;if(!this._coach.expired){this._coach.expireTo&&clearTimeout(this._coach.expireTo);
var c=this;this._coach.expireTo=setTimeout(function(){c._coach.expired=!0},1E3*(b+660-f))}for(var d in a)this._states[d]=a[d]}};a.prototype.thermoStatusChanged=function(){this._thermo.lastReqTime=null};a.prototype.setSmartThermoDuration=function(a,b){a&&a.module&&(this._smartThermoDuraion[a.module]=b)};a.prototype.getSmartThermoDuration=function(a){if(a&&a.module)return this._smartThermoDuraion[a.module]};return a}(),g=function(a,d,b){this._logger=require("x.logger.js").getLogger("xnm.aio.netatmo.Client");
this.username=a;this.password=d;this.refreshToken=b;this.accessToken=null;this._scope="read_station read_thermostat read_homecoach write_thermostat read_camera access_camera read_presence access_presence".split(" ");this._stateBuffer=new n;this._renewTokenCBs=[];this._getHomesInfoCBs=[];this._getWeatherStatusCBs=[];this._getThermoStatusCBs=[];this._getCoachStatusCBs=[]};g.prototype.toJSON=function(){return{sys:xnm.aio.netatmo.DM.SYS,username:this.username,password:this.password,refreshToken:this.refreshToken}};
g.prototype.equalsTo=function(a){return a&&a instanceof g?this.refreshToken?this.refreshToken===a.refreshToken:this.user==a.user&&this.password==a.password:!1};g.prototype.executeCommandCreator=function(a,d,b){d&&d.value?"NATherm1"==a.type?this._setSmartThermostat(a,d,function(a){b&&b(a)}):"home"==a.type?this._setHomeThermMode(a,d,function(a){b&&b(a)}):"room"==a.type?this._setRoomTherm(a,d,function(a){b&&b(a)}):b&&b(Error("device has no command")):b&&b(Error("command format invalid"))};g.prototype.getStatesCreator=
function(a,d,b){d?this.getAllStatus(function(a,e){for(var c=[],h=0;h<d.length;h++){var k=d[h];if(k.id){var f,g="?";!a&&e&&k.device&&k.device.type&&(f="NAMain"==k.device.type||"NHC"==k.device.type||"NAPlug"==k.device.type?k.device.address:"room"==k.device.type||"home"==k.device.type?k.device.address:k.device.module)&&k.status&&k.status.value&&(f=e[f])&&(g=f[k.status.value],null==g||"undefined"==typeof g)&&(g="?");c.push({id:k.id,status:g})}}b&&b(null,c)}):b&&b(Error("deviceList is null"))};g.prototype._setHomeThermMode=
function(a,d,b){if(a&&a.address&&"home"==a.type){var f=this;a=a.address;switch(d.value){case "thermoAuto":var e="schedule";break;case "thermoAway":e="away";break;case "thermoAwayUntil":if(!d.ext){b(Error("invalid command"));return}e="away";var c=parseInt(d.ext);break;case "thermoHg":e="hg";break;case "thermoHgUntil":if(!d.ext){b(Error("invalid command"));return}e="hg";c=parseInt(d.ext);break;default:b(Error("unknown command"))}this._setThermMode(a,e,c,null,function(a,c){a?b(a):(f._stateBuffer.thermoStatusChanged(),
b())})}else b(Error("invalid device"))};g.prototype._setRoomTherm=function(a,d,b){if(a&&a.address&&a.homeId&&"room"==a.type){var f=this,e=a.homeId,c=a.address;switch(d.value){case "thermoAuto":var h="home";break;case "thermoManu":if(!d.ext){b(Error("invalid command"));return}h="manual";var k=parseFloat(d.ext);7>k&&(k=7);30<k&&(k=30);break;case "thermoManuUntil":if(!d.ext){b(Error("invalid command"));return}h="manual";for(a=0;a<d.ext.length;a++){var g=d.ext[a];if(g)switch(g.value){case "temp":k=parseFloat(g.ext);
break;case "endtime":var r=parseInt(g.ext)}}if(!k||!r){b(Error("invalid command"));return}7>k&&(k=7);30<k&&(k=30);break;case "thermoUp":case "thermoDown":this.getAllStatus(function(a,g){a?b(a):(a=g?g[c]:null)?(r=a.tempEnd,k=parseFloat(a.manuT),isNaN(k)?b(Error("unknown current room setpoint")):(k="thermoUp"==d.value?k+.5:k-.5,7>k&&(k=7),30<k&&(k=30),h="manual",f._setRoomThermPoint(e,c,h,k,r,function(a,c){a?b(a):(f._stateBuffer.thermoStatusChanged(),b())}))):b(Error("unknown current room status"))});
return;default:b(Error("unknown command"))}this._setRoomThermPoint(e,c,h,k,r,function(a,c){a?b(a):(f._stateBuffer.thermoStatusChanged(),b())})}else b(Error("invalid device"))};g.prototype._setSmartThermostat=function(a,d,b){var f=this,e=this._stateBuffer.getSmartThermoDuration(a);e||(e=60);var c={};switch(d.value){case "thermoAuto":c.setpoint_mode="program";break;case "thermoAway":c.setpoint_mode="away";break;case "thermoHg":c.setpoint_mode="hg";break;case "thermoOff":c.setpoint_mode="off";break;
case "thermoMax":c.setpoint_mode="max";c.setpoint_endtime=Math.round(((new Date).getTime()+6E4*e)/1E3);break;case "thermoManu":if(null==d.ext||"undefined"==typeof d.ext){b&&b(Error("command ext invalid"));return}var h=d.ext;"string"==typeof d.ext&&(h=parseFloat(d.ext));5.5>h&&(h=5.5);30<h&&(h=30);c.setpoint_mode="manual";c.setpoint_endtime=Math.round(((new Date).getTime()+6E4*e)/1E3);c.setpoint_temp=h;break;case "tempDuration":if(null==d.ext||"undefined"==typeof d.ext){b&&b(Error("command ext invalid"));
return}e=d.ext;"string"==typeof d.ext&&(e=parseFloat(d.ext));15>e&&(e=15);720<e&&(e=720);this._stateBuffer.setSmartThermoDuration(a,e);b&&b();return;default:b&&b(Error("unknow command"))}a&&a.address&&a.module?c&&c.setpoint_mode?"max"!=c.setpoint_mode||c.setpoint_endtime?"manual"!=c.setpoint_mode||c.setpoint_endtime&&c.setpoint_temp?this._setThermPoint(a.address,a.module,c.setpoint_mode,c.setpoint_endtime,c.setpoint_temp,function(a,c){a?b&&b(a):(f._stateBuffer.thermoStatusChanged(),b&&b(null,c))}):
b&&b(Error("param format invalid")):b&&b(Error("param format invalid")):b&&b(Error("param format invalid")):b&&b(Error("device format invalid"))};g.prototype.auth=function(a){this._logger.log("debug","auth");this.username&&this.password?this._auth(function(d,b){a&&a(d,b)}):this.refreshToken?this._refreshToken(function(d,b){a&&a(d,b)}):a&&a(Error(""))};g.prototype.getDeviceList=function(a){var d=this,b=[];this._getHomeCoachsData(null,function(f,e){f?d._logger.log("error","getHomeCoachsData error: "+
f.message):e&&Array.isArray(e.devices)&&e.devices.forEach(function(a){var c=a.name||a.type;a.station_name&&(c+=" ("+a.station_name+")");b.push({address:a._id,type:a.type,name:c,room:null,home:null,dashboard_data:a.dashboard_data})});d._getHomesData(null,null,function(c,e){c?0===b.length?a&&a(c):a&&a(null,b):(e&&e.length&&e.forEach(function(a){if(a&&a.modules&&a.modules.length){var c={};a.rooms&&a.rooms.forEach(function(a){c[a.id]={name:a.name,hasThermo:!1}});var e=!1;a.modules.forEach(function(d){if(d&&
d.id&&d.type)switch(d.type){case "NAMain":var h={address:d.id,type:d.type,name:d.name?d.name:null,room:null,home:a.name};d.room_id&&c[d.room_id]&&(h.room=c[d.room_id].name);b.push(h);break;case "NAModule1":case "NAModule2":case "NAModule3":case "NAModule4":h={module:d.id,address:d.bridge,type:d.type,name:d.name?d.name:null,room:null,home:a.name};d.room_id&&c[d.room_id]&&(h.room=c[d.room_id].name);b.push(h);break;case "NAPlug":e=!0;h={address:d.id,type:d.type,name:d.name?d.name:null,room:null,home:a.name};
d.room_id&&c[d.room_id]&&(h.room=c[d.room_id].name,c[d.room_id].hasThermo=!0);b.push(h);break;case "NATherm1":case "NRV":e=!0;h={address:d.bridge,module:d.id,type:d.type,name:d.name?d.name:null,room:null,home:a.name};d.room_id&&c[d.room_id]&&(h.room=c[d.room_id].name,c[d.room_id].hasThermo=!0);b.push(h);break;case "NHC":h={address:d.id,type:d.type,name:d.name?d.name:a.name,room:null,home:a.name},d.room_id&&c[d.room_id]&&(h.room=c[d.room_id].name),b.push(h)}});for(var d in c){var h=c[d];h.hasThermo&&
b.push({address:d,type:"room",name:h.name,home:a.name,homeId:a.id})}e&&b.push({address:a.id,type:"home",name:a.name})}}),a&&a(null,b))})})};g.prototype.getCamList=function(a){var d=this;this._getHomeData(null,null,function(b,f){if(b)a&&a(b);else{b={cam:[]};if(f){for(var e=[],c=0;c<f.length;c++)if(f[c]&&f[c].id){var h=f[c].name,k=f[c].cameras;if(k)for(var g=0;g<k.length;g++)if(k[g]&&k[g].id){var r="welcome";"NACamera"==k[g].type?r="welcome":"NOC"==k[g].type&&(r="presence");r&&(r={sys:"cam",type:"system",
manufacturer:"netatmo",model:r,address:k[g].id},k[g].name&&(r.name=k[g].name+(h?" ("+h+")":"")),e.push(r))}}b.cam=e}if(b.cam&&0<b.cam.length)for(f=0;f<b.cam.length;f++)b.cam[f].refreshToken=d.refreshToken;a&&a(null,b)}})};g.prototype.getCamUrl=function(a,d){var b=this;this._getHomeData(null,null,function(f,e){if(f)d&&d(f);else if(e){for(f=0;f<e.length;f++)if(e[f]&&e[f].cameras){for(var c=e[f].cameras,h=0;h<c.length;h++)if(c[h]&&c[h].id==a&&c[h].vpn_url){var k=c[h];break}if(k)break}k?1==k.is_local?
b._getLocalCamUrl(k.vpn_url,function(a,c){d&&d(a,c)}):d&&d(null,k.vpn_url+"/live/index.m3u8"):d&&d("no cam with address:"+a)}else d&&d("get cams data reponse invalid")})};g.prototype._getLocalCamUrl=function(a,d){var b=this;this._logger.log("trace","ping cam "+a);this._doUrlRequest("get",a+"/command/ping",null,function(f,e){!f&&e&&e.local_url?b._doUrlRequest("get",e.local_url+"/command/ping",null,function(c,b){c||!b||b.local_url!=e.local_url?d&&d(null,a+"/live/index.m3u8"):d&&d(null,b.local_url+"/live/index.m3u8")}):
d&&d(null,a+"/live/index.m3u8")})};g.prototype.getAllStatus=function(a){var d=this,b=this._stateBuffer.areStatesExpired();b.weather||b.thermo||b.coach?this._getAllStatus(b,function(b){b?a&&a(b):a&&a(null,d._stateBuffer.getStates())}):a&&a(null,this._stateBuffer.getStates())};g.prototype._getAllStatus=function(a,d){var b=this,f=function(a,c){a&&a.weather?b._getWeatherStatus(c):c()},e=function(a,c){a&&a.thermo?b._getThermoStatus(a.home,c):c()},c=function(a,c){a&&a.coach?b._getHomeCoachStatus(c):c()};
this._getHomesInfo(function(b,k,g){b?d(b):("object"===typeof g&&g?(a.weather=g.weather&&0<g.weather.length,a.thermo=g.thermo&&0<g.thermo.length,g.coach&&0<g.coach.length&&(a.coach=!0),a.thermo&&(a.home=g.home)):(a.weather=!1,a.thermo=!1),f(a,function(b){b?d(b):e(a,function(b){b?d(b):c(a,function(a){d(a)})})}))})};g.prototype._getHomesInfo=function(a){var d=this._getHomesInfoCBs.length;-1==this._getHomesInfoCBs.indexOf(a)&&this._getHomesInfoCBs.push(a);if(0==d){var b=this;this._stateBuffer.updateReqTime("homes",
Math.round((new Date).getTime()/1E3));this._getHomesData(null,null,function(a,d,c){b._stateBuffer.updateReqOK("homes",a?!1:!0);c=b._getHomesInfoCBs;b._getHomesInfoCBs=[];a&&c.forEach(function(b){try{b&&b(a)}catch(w){}});if(d&&d.length){var e=[],k=[],f=[],g=[],n={};d.forEach(function(a){if(a&&a.modules&&a.modules.length){a.modules.forEach(function(b){if(b&&b.id&&b.type)switch(b.type){case "NAMain":case "NAModule1":case "NAModule2":case "NAModule3":case "NAModule4":k.push(b.id);break;case "NATherm1":case "NAPlug":case "NRV":-1==
e.indexOf(a.id)&&e.push(a.id);f.push(b.id);break;case "NHC":g.push(b.id)}});var c=b._resolveHomeStatus(a);if(c)for(var d in c)n[d]=c[d]}});b._stateBuffer.updateHomesInfo(n,{weather:k,thermo:f,coach:g});c.forEach(function(a){try{a&&a(null,n,{weather:k,thermo:f,coach:g,home:e})}catch(w){}})}else b._stateBuffer.updateHomesInfo({},{}),c.forEach(function(a){try{a&&a(null,{})}catch(w){}})})}};g.prototype._resolveHomeStatus=function(a){if(!a)return null;var d={};d.mode=a.therm_mode;d.tempEnd=a.therm_mode_endtime;
if(d.tempEnd)if(d.tempEndStr=(new Date(1E3*d.tempEnd)).toLocaleString(),"undefined"!=typeof dateFormat&&dateFormat)try{d.tempEndStr=dateFormat(d.tempEndStr,"dd mm yyyy, HH:MM:ss")}catch(f){}else d.tempEndStr=d.tempEndStr.toLocaleString();var b={};b[a.id]=d;return b};g.prototype._getWeatherStatus=function(a){var d=this._getWeatherStatusCBs.length;-1==this._getWeatherStatusCBs.indexOf(a)&&this._getWeatherStatusCBs.push(a);if(0==d){var b=this;this._stateBuffer.updateReqTime("weather",Math.round((new Date).getTime()/
1E3));this._getStationsData(null,!1,function(a,d,c){b._stateBuffer.updateReqOK("weather",a?!1:!0);var e=b._getWeatherStatusCBs;b._getWeatherStatusCBs=[];if(a)e.forEach(function(b){try{b&&b(a,homes,c)}catch(t){}});else{var k=null,f={};d.devices&&d.devices.length&&d.devices.forEach(function(a){if(a&&"NAMain"==a.type&&(a.last_status_store&&(k=Math.max(a.last_status_store,k)),a=b._resolveWeatherStatus(a,d.user?d.user.administrative:null)))for(var c in a)f[c]=a[c]});k&&b._stateBuffer.updateWeatherStatus(f,
k,c);e.forEach(function(a){try{a&&a(null,f)}catch(t){}})}})}};g.prototype._resolveWeatherStatus=function(a,d){if(!a||"NAMain"!=a.type)return null;var b={};if(a._id){var f={};null!=a.wifi_status&&"undefined"!=typeof a.wifi_status&&(f.wifi=a.wifi_status,f.wifiStatus=86<=f.wifi?"bad":71<=f.wifi?"middle":56<=f.wifi?"good":"very_good");if(a.dashboard_data){var e=this._resolveDashboard(a.dashboard_data);if(e)for(var c in e)e.hasOwnProperty(c)&&(f[c]=e[c])}f.tempFelt=null;"undefined"!=typeof f.temp&&"undefined"!=
typeof f.hum&&d&&(f.tempFelt=xnm.aio.netatmo.DM.calcFeltTemp(f.temp,f.hum,d));b[a._id]=f}var h=this;a.modules&&a.modules.forEach(function(a){var c=h._resolveModuleStatus(a,d);a&&a._id&&c&&(b[a._id]=c)});return b};g.prototype._resolveModuleStatus=function(a,d){var b={};null!=a.rf_status&&"undefined"!=typeof a.rf_status&&(b.rf=a.rf_status,b.rfStatus=90<=b.rf?"very_low":80<=b.rf?"low":70<=b.rf?"medium":60<=b.rf?"high":"full");if(null!=a.battery_vp&&"undefined"!=typeof a.battery_vp)switch(b.bat=a.battery_vp,
a.type){case "NAModule4":b.batStatus=5640<=b.bat?"full":5280<=b.bat?"high":4920<=b.bat?"medium":4560<=b.bat?"low":"very_low";break;case "NAModule1":case "NAModule3":b.batStatus=5500<=b.bat?"full":5E3<=b.bat?"high":4500<=b.bat?"medium":4E3<=b.bat?"low":"very_low";break;case "NAModule2":b.batStatus=5900<=b.bat?"full":5180<=b.bat?"high":4770<=b.bat?"medium":4360<=b.bat?"low":"very_low";break;case "NATherm1":b.batStatus=4100<=b.bat?"full":3600<=b.bat?"high":3300<=b.bat?"medium":3E3<=b.bat?"low":"very_low"}var f,
e;if("NATherm1"==a.type&&(f=this._resolveThermoStat(a)))for(e in f)f.hasOwnProperty(e)&&(b[e]=f[e]);if(a.dashboard_data){if(f=this._resolveDashboard(a.dashboard_data))for(e in f)f.hasOwnProperty(e)&&(b[e]=f[e]);"undefined"!=typeof b.winD&&null!=b.winD&&(a=Number(b.winD),isNaN(a)||(b.winDName=23<a&&68>=a?"NO":68<a&&113>=a?"O":113<a&&158>=a?"SO":158<a&&203>=a?"S":203<a&&248>=a?"SW":248<a&&293>=a?"W":293<a&&338>=a?"NW":"N"));"undefined"!=typeof b.temp&&"undefined"!=typeof b.hum&&d&&(b.tempFelt=xnm.aio.netatmo.DM.calcFeltTemp(b.temp,
b.hum,d))}return b};g.prototype._resolveDashboard=function(a){var d=function(a,b){return null!=a[b]&&"undefined"!=typeof a[b]},b={};d(a,"AbsolutePressure")&&(b.absPres=a.AbsolutePressure);d(a,"CO2")&&(b.co2=a.CO2);d(a,"Humidity")&&(b.hum=a.Humidity);d(a,"Noise")&&(b.noise=a.Noise);d(a,"Pressure")&&(b.pres=a.Pressure);d(a,"Rain")&&(b.rain=a.Rain);d(a,"sum_rain_1")&&(b.rain1h=a.sum_rain_1);d(a,"sum_rain_24")&&(b.rain24h=a.sum_rain_24);d(a,"Temperature")&&(b.temp=a.Temperature);if(d(a,"date_max_temp")){b.timeMaxTemp=
a.date_max_temp;var f=1E3*a.date_max_temp;b.timeMaxTempStr=new Date(f);b.timeMaxTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(b.timeMaxTempStr,"dd mm yyyy, HH:MM:ss"):b.timeMaxTempStr.toLocaleString()}d(a,"date_min_temp")&&(b.timeMinTemp=a.date_min_temp,f=1E3*a.date_min_temp,b.timeMinTempStr=new Date(f),b.timeMinTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(b.timeMinTempStr,"dd.mm.yyyy, HH:MM:ss"):b.timeMinTempStr.toLocaleString());d(a,"max_temp")&&(b.maxTemp=a.max_temp);
d(a,"min_temp")&&(b.minTemp=a.min_temp);d(a,"WindAngle")&&(b.winD=a.WindAngle);d(a,"WindStrength")&&(b.winS=a.WindStrength);d(a,"GustAngle")&&(b.gwinD=a.GustAngle);d(a,"GustStrength")&&(b.gwinS=a.GustStrength);d(a,"time_utc")&&(b.mesureT=a.time_utc,f=1E3*a.time_utc,b.mesureTStr=new Date(f),b.mesureTStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(b.mesureTStr,"dd.mm.yyyy, HH:MM:ss"):b.mesureTStr.toLocaleString());d(a,"date_max_wind_str")&&(b.timeMaxWind=a.date_max_wind_str,f=1E3*a.date_max_wind_str,
b.timeMaxWindStr=new Date(f),b.timeMaxWindStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(b.timeMaxWindStr,"dd.mm.yyyy, HH:MM:ss"):b.timeMaxWindStr.toLocaleString());d(a,"max_wind_angle")&&(b.maxWinD=a.max_wind_angle);d(a,"max_wind_str")&&(b.maxWinS=a.max_wind_str);d(a,"temp_trend")&&(b.tempTrend=a.temp_trend);d(a,"pressure_trend")&&(b.presTrend=a.pressure_trend);if(d(a,"health_idx"))switch(b.healthIdxLvl=a.health_idx,parseInt(b.healthIdx)){case 0:b.healthIdx="healthy";break;case 1:b.healthIdx=
"fine";break;case 2:b.healthIdx="fair";break;case 3:b.healthIdx="poor";break;case 4:b.healthIdx="unhealthy"}return b};g.prototype._getThermoStatus=function(a,d){if(a&&a.length){var b=this._getThermoStatusCBs.length;-1==this._getThermoStatusCBs.indexOf(d)&&this._getThermoStatusCBs.push(d);if(0==b){var f=this;this._stateBuffer.updateReqTime("thermo",Math.round((new Date).getTime()/1E3));var e=0,c={},h=function(b,d){var k=f._getThermoStatusCBs;b?(f._stateBuffer.updateReqOK("thermo",!1),f._getThermoStatusCBs=
[],k.forEach(function(a){try{a&&a(b)}catch(y){}})):(d&&(d.modules&&d.modules.forEach(function(a){if(a&&a.id){var b=f._resolveThermoModuleStatus(a);b&&(c[a.id]=b)}}),d.rooms&&d.rooms.forEach(function(a){if(a&&a.id){var b=f._resolveThermoRoomStatus(a);b&&(c[a.id]=b)}})),e++,e<a.length?f._getHomeStatus(a[e],null,h):(f._stateBuffer.updateReqOK("thermo",!0),f._stateBuffer.updateThermoStatus(c),f._getThermoStatusCBs=[],k.forEach(function(a){try{a&&a(null,c)}catch(y){}})))};this._getHomeStatus(a[e],null,
h)}}else d(null,null)};g.prototype._resolveThermoModuleStatus=function(a){if(!a)return null;var d=function(a,b){return null!=a[b]&&"undefined"!=typeof a[b]},b={};d(a,"rf_strength")&&(b.rf=a.rf_strength,b.rfStatus=90<b.rf?"very_low":80<b.rf?"low":70<b.rf?"medium":60<b.rf?"high":"full");d(a,"wifi_strength")&&(b.wifi=a.wifi_status,b.wifiStatus=86<=b.wifi?"bad":71<=b.wifi?"middle":56<=b.wifi?"good":"very_good");d(a,"battery_level")&&(b.bat=a.battery_level);d(a,"battery_state")&&(b.batStatus=a.battery_state);
return b};g.prototype._resolveThermoRoomStatus=function(a){if(!a)return null;var d={};d.mode=a.therm_setpoint_mode;d.manuT=a.therm_setpoint_temperature;d.tempEnd=a.therm_setpoint_end_time;if(d.tempEnd)if(d.tempEndStr=(new Date(1E3*d.tempEnd)).toLocaleString(),"undefined"!=typeof dateFormat&&dateFormat)try{d.tempEndStr=dateFormat(d.tempEndStr,"dd mm yyyy, HH:MM:ss")}catch(b){}else d.tempEndStr=d.tempEndStr.toLocaleString();d.currentTemp=a.therm_measured_temperature;return d};g.prototype._getHomeCoachStatus=
function(a){var d=this._getCoachStatusCBs.length;-1==this._getCoachStatusCBs.indexOf(a)&&this._getCoachStatusCBs.push(a);if(0==d){var b=this;this._stateBuffer.updateReqTime("coach",Math.round((new Date).getTime()/1E3));this._getHomeCoachsData(null,function(a,d,c){b._stateBuffer.updateReqOK("coach",a?!1:!0);var e=b._getCoachStatusCBs;b._getCoachStatusCBs=[];if(a)e.forEach(function(b){try{b&&b(a,d,c)}catch(t){}});else{var f=null,g={};d.devices&&d.devices.length&&d.devices.forEach(function(a){if(a&&
"NHC"==a.type&&(a.last_status_store&&(f=Math.max(a.last_status_store,f)),a=b._resolveCoachStatus(a,d.user?d.user.administrative:null)))for(var c in a)g[c]=a[c]});f&&b._stateBuffer.updateCoachStatus(g,f,c);e.forEach(function(a){try{a&&a(null,g)}catch(t){}})}})}};g.prototype._resolveCoachStatus=function(a,d){var b={};b.wifi=a.wifi_status;b.wifiStatus=86<=b.wifi?"bad":71<=b.wifi?"middle":56<=b.wifi?"good":"very_good";if(a.dashboard_data){var f=this._resolveDashboard(a.dashboard_data);if(f)for(var e in f)f.hasOwnProperty(e)&&
(b[e]=f[e])}b.tempFelt=null;"undefined"!=typeof b.temp&&"undefined"!=typeof b.hum&&d&&(b.tempFelt=xnm.aio.netatmo.DM.calcFeltTemp(b.temp,b.hum,d));d={};d[a._id]=b;return d};g.prototype._renewAccessToken=function(a){var d=this._renewTokenCBs.length;a&&-1==this._renewTokenCBs.indexOf(a)&&this._renewTokenCBs.push(a);if(0==d){var b=this;a=function(a,d){var c=!1;!a&&d&&(d.access_token&&(b.accessToken=d.access_token,c=!0),d.refresh_token&&(b.refreshToken=d.refresh_token));a||c||(a=Error("invalid token response"));
d=b._renewTokenCBs;b._renewTokenCBs=[];for(c=0;c<d.length;c++)try{d[c](a)}catch(h){}};this.refreshToken?this._refreshToken(a):this.username&&this.password?this._auth(a):a(Error("no refresh token or username/password"))}};g.prototype._auth=function(a){this._logger.log("trace","_auth");var d={grant_type:"password",client_id:"564b2c5245a1e3173cb21d3b",client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",username:this.username,password:this.password,scope:this._scope.join(" ")},b=[],f;for(f in d)b.push(f+
"="+encodeURIComponent(d[f]));d=b.join("&");this._doRequest("POST","/oauth2/token",{"Content-Type":"application/x-www-form-urlencoded"},d,function(b,c,d){if(b)a(b);else if(c)try{var e=JSON.parse(c);200!=d?(b=Error(e.error),a(b)):a(null,e)}catch(u){a(u)}else a(Error("invalid response"))})};g.prototype._refreshToken=function(a){this._logger.log("trace","_refreshToken");var d={grant_type:"refresh_token",client_id:"564b2c5245a1e3173cb21d3b",client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",refresh_token:this.refreshToken},
b=[],f;for(f in d)b.push(f+"="+encodeURIComponent(d[f]));d=b.join("&");this._doRequest("POST","/oauth2/token",{"Content-Type":"application/x-www-form-urlencoded"},d,function(b,c,d){if(b)a(b);else if(c)try{var e=JSON.parse(c);200!=d?(b=Error(e.error),a(b)):a(null,e)}catch(u){a(u)}else a(Error("invalid response"))})};g.prototype._getStationsData=function(a,d,b){this._logger.log("debug","_getStationsData");var f="/api/getstationsdata",e=[];a&&e.push("device_id="+a);d&&e.push("get_favorites="+get_favorites);
e.length&&(f+="?"+e.join("&"));this._doAPIRequest("GET",f,null,function(a,d){a?b(a):d&&d.body?b(null,d.body,d.time_server):b(Error("invalid get stations data response"))})};g.prototype._getHomesData=function(a,d,b){this._logger.log("debug","_getHomesData");var f="/api/homesdata",e=[];a&&e.push("home_id="+a);d&&e.push("gateway_types="+d);e.length&&(f+="?"+e.join("&"));this._doAPIRequest("GET",f,null,function(a,d){a?b(a):d&&d.body&&d.body.homes?b(null,d.body.homes,d.time_server):b(Error("invalid get homes data response"))})};
g.prototype._getHomeStatus=function(a,d,b){this._logger.log("debug","_getHomeStatus");var f="/api/homestatus",e=[];a&&e.push("home_id="+a);d&&d.length&&d.forEach(function(a){e.push("device_types="+a)});e.length&&(f+="?"+e.join("&"));this._doAPIRequest("GET",f,null,function(a,d){a?b(a):d&&d.body&&d.body.home?b(null,d.body.home,d.time_server):b(Error("invalid get home status response"))})};g.prototype._getHomeCoachsData=function(a,d){this._logger.log("debug","_getHomeCoachsData");var b="/api/gethomecoachsdata",
f=[];a&&f.push("device_id="+a);f.length&&(b+="?"+f.join("&"));this._doAPIRequest("GET",b,null,function(a,b){a?d(a):b&&b.body?d(null,b.body,b.time_server):d(Error("invalid get stations data response"))})};g.prototype._setThermPoint=function(a,d,b,f,e,c){var h="/api/setthermpoint",k=[];a&&k.push("device_id="+a);d&&k.push("module_id="+d);b&&k.push("setpoint_mode="+b);f&&k.push("setpoint_endtime="+f);e&&k.push("setpoint_temp="+e);k.length&&(h+="?"+k.join("&"));this._doAPIRequest("GET",h,null,c)};g.prototype._setThermMode=
function(a,d,b,f,e){this._logger.log("debug","_setThermMode");var c="/api/setthermmode",h=[];a&&h.push("home_id="+a);d&&h.push("mode="+d);b&&h.push("endtime="+b);f&&h.push("schedule_id="+f);h.length&&(c+="?"+h.join("&"));this._doAPIRequest("GET",c,null,function(a,b){e(a)})};g.prototype._setRoomThermPoint=function(a,d,b,f,e,c){this._logger.log("debug","_setRoomThermPoint");var h="/api/setroomthermpoint",k=[];a&&k.push("home_id="+a);d&&k.push("room_id="+d);b&&k.push("mode="+b);f&&k.push("temp="+f);
e&&k.push("endtime="+e);k.length&&(h+="?"+k.join("&"));this._doAPIRequest("GET",h,null,function(a,b){c(a)})};g.prototype._getHomeData=function(a,d,b){this._logger.log("debug","_getHomeData");var f="/api/gethomedata",e=[];a&&e.push("home_id="+a);d&&e.push("size="+d);e.length&&(f+="?"+e.join("&"));this._doAPIRequest("GET",f,null,function(a,d){a?b(a):d&&d.body&&d.body.homes?b(null,d.body.homes,d.time_server):b(Error("invalid get homes data response"))})};g.prototype._doAPIRequest=function(a,d,b,f){var e=
this;this.accessToken?this._doJsonRequest(a,d,b,function(c,h){!c||2!=c.code&&3!=c.code||401!=c.status&&403!=c.status?f(c,h):e._renewAccessToken(function(c){c?f(c):e._doJsonRequest(a,d,b,function(a,b){f(a,b)})})}):this._renewAccessToken(function(c){c?f(c):e._doJsonRequest(a,d,b,function(a,b){f(a,b)})})};g.prototype._doJsonRequest=function(a,d,b,f){var e=this;this._doRequest(a,d,{Authorization:"Bearer "+this.accessToken},b?JSON.stringify(b):null,function(a,b,d){if(a)f(a);else if(b)try{var c=JSON.parse(b);
if(200!=d){e._logger.log("error","[_doJsonRequest] Status: "+d+". Error: "+b);var h=c.error?c.error.code?c.error.code:0:0;a=Error(c.error?c.error.message?c.error.message:"invalid error response":"invalid error response");a.code=h;a.status=d;f(a)}else f(null,c)}catch(t){f(t)}else f(Error("invalid response"))})};g.prototype._doRequest=function(a,d,b,f,e){a={host:"api.netatmo.net",port:443,path:d,method:a,headers:{Connection:"close","Content-Type":"application/json; charset=UTF-8"}};if(b)for(var c in b)a.headers[c]=
b[c];b=require("https");c=JSON.parse(JSON.stringify(a));c.headers&&(c.headers.auth&&(c.headers.auth="*********"),c.headers.Authorization&&(c.headers.Authorization="*********"));c.auth&&(c.auth="********");this._logger.log("trace","do request:"+JSON.stringify(c));var h=this,k=e,g=b.request(a,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){h._logger.log("trace","receive code:"+a.statusCode+" headers:"+JSON.stringify(a.headers)+" response:"+b);k&&(k(null,
b,a.statusCode),k=null)})});if(g.on)g.on("error",function(a){h._logger.log("trace","do request error:"+a.message);k&&(k(a),k=null)});g.setTimeout&&g.setTimeout(1E4,function(){h._logger.log("trace","do request timeout");g.abort();k&&(k(Error("timeout")),k=null)});f&&(this._logger.log("trace","send body:"+f),g.write(f));g.end()};g.prototype._doUrlRequest=function(a,d,b,f){var e=this,c=f,h=null;try{h=JSON.parse(JSON.stringify(b)),h.username&&(h.username="xxxxxx"),h.password&&(h.password="xxxxxx")}catch(k){h=
b}this._logger.log("trace","send "+a+" req to:"+d+" data:"+JSON.stringify(h));$.ajax({url:d,type:a,timeout:1E4,dataType:"json",data:b,cache:!1,success:function(a){e._logger.log("trace","http request success:"+JSON.stringify(a));f&&f(null,a)},error:function(a,b,d){b="http request error:"+(a?a.status:"0")+"-"+b;e._logger.log("warn","http request error:"+b);b=Error(b);d&&(e._logger.log("warn","http request http error:"+d),b.httpError=!0,b.statusCode=a?a.status:0);c&&(c(b,a?a.responseText:null),c=null)}})};
return g}();
xnm.aio.netatmo.DM=function(){var n=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};n.prototype=Error();n.prototype.name="NetatmoDmError";n.prototype.code=0;n.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var g=n.ERROR_CODE,a=[{type:"float",name:"absolute pressure",ref:{value:"absPres",value_t:"pressureAbsolute"}},{type:"int",name:"co2",ref:{value:"co2"}},{type:"int",name:"humidity",ref:{value:"hum"}},{type:"int",name:"noise",ref:{value:"noise"}},
{type:"float",name:"pressure",ref:{value:"pres",value_t:"pressure"}},{type:"float",name:"rain",ref:{value:"rain"}},{type:"float",name:"rain last hour",ref:{value:"rain1h"}},{type:"float",name:"rain last 24 hours",ref:{value:"rain24h"}},{type:"float",name:"temperature",ref:{value:"temp"}},{type:"int",name:"time max temperatue",ref:{value:"timeMaxTemp"}},{type:"int",name:"time min temperatue",ref:{value:"timeMinTemp"}},{type:"float",name:"max temperatue",ref:{value:"maxTemp"}},{type:"float",name:"min temperatue",
ref:{value:"minTemp"}},{type:"int",name:"wind direction",ref:{value:"winD"}},{type:"float",name:"wind speed",ref:{value:"winS"}},{type:"int",name:"gust wind direction",ref:{value:"gwinD"}},{type:"float",name:"gust wind speed",ref:{value:"gwinS"}},{type:"int",name:"last measure time",ref:{value:"mesureT",value_t:"lastMeasureTime"}},{type:"int",name:"time max wind",ref:{value:"timeMaxWind"}},{type:"int",name:"max wind direction",ref:{value:"maxWinD"}},{type:"float",name:"max wind speed",ref:{value:"maxWinS"}},
{type:"float",name:"rf level",ref:{value:"rf"}},{type:"enum",name:"rf status",ref:{value:"rfStatus",options:["very_low","low","medium","high","full"]}},{type:"float",name:"battery level",ref:{value:"bat",value_t:"battery_level",extMeta:"3000-6000"}},{type:"enum",name:"battery status",ref:{value:"batStatus",value_t:"battery_state",options:["very_low","low","medium","high","full"]}},{type:"float",name:"wifi level",ref:{value:"wifi"}},{type:"enum",name:"wifi status",ref:{value:"wifiStatus",options:["bad",
"middle","good","very_good"]}},{type:"enum",name:"mode",ref:{value:"mode",options:"auto away frost-guard manu off boost".split(" ")}},{type:"float",name:"manual temperature",ref:{value:"manuT",extMeta:"5.5-30",scale:"0.5"}},{type:"int",name:"manual/boost endtime",ref:{value:"tempEnd"}},{type:"float",name:"measured temperature",ref:{value:"currentTemp"}},{type:"int",name:"manual/boost duration",ref:{value:"tempDuration",extMeta:"15-720",scale:"15"}},{type:"string",name:"manual/boost endtime string",
ref:{value:"tempEndStr"}},{type:"string",name:"time string max temperatue",ref:{value:"timeMaxTempStr"}},{type:"string",name:"time string min temperatue",ref:{value:"timeMinTempStr"}},{type:"string",name:"last measure time string",ref:{value:"mesureTStr",value_t:"lastMeasureTimeStr"}},{type:"string",name:"time string max wind",ref:{value:"timeMaxWindStr"}},{type:"float",name:"felt temperature",ref:{value:"tempFelt"}},{type:"string",name:"wind direction named",ref:{value:"winDName",options:"N NO O SO S SW W NW".split(" ")}},
{type:"enum",name:"temperature trend",ref:{value:"tempTrend",options:["up","down","stable"]}},{type:"enum",name:"pressure trend",ref:{value:"presTrend",value_t:"pressureTrend",options:["up","down","stable"]}},{type:"enum",name:"health index",ref:{value:"healthIdx",options:["healthy","fine","fair","poor","unhealthy"]}},{type:"int",name:"health index level",ref:{value:"healthIdxLvl",extMeta:"0-4"}}],d=[{type:"enum",name:"auto",ref:{value:"thermoAuto"}},{type:"enum",name:"away",ref:{value:"thermoAway"}},
{type:"enum",name:"frost-guard",ref:{value:"thermoHg"}},{type:"enum",name:"off",ref:{value:"thermoOff"}},{type:"enum",name:"max",ref:{value:"thermoMax"}},{type:"float",name:"manu",ref:{value:"thermoManu",ext:"%f",extMeta:"5.5-30",scale:"0.5"}},{type:"enum",name:"up",ref:{value:"thermoUp"}},{type:"enum",name:"down",ref:{value:"thermoDown"}},{type:"int",name:"manual/boost duration",ref:{value:"tempDuration",ext:"%d",extMeta:"15-720",scale:"15"}}],b={command:[{type:"enum",name:"auto",ref:{value:"thermoAuto"}},
{type:"enum",name:"up",ref:{value:"thermoUp"}},{type:"enum",name:"down",ref:{value:"thermoDown"}},{type:"float",name:"manu",ref:{value:"thermoManu",ext:"%f",extMeta:"7-30",scale:"0.5"}},{type:"multi",name:"manu until",ref:{value:"thermoManuUntil",ext:"%multi",extMeta:[{type:"float",name:"temperature",ref:{value:"temp",ext:"%f",extMeta:"7-30",scale:"0.5"}},{type:"time",name:"end time",ref:{value:"endtime",ext:"%time"}}]}}],status:[{type:"enum",name:"mode",ref:{value:"mode",options:"manual max off schedule away hg".split(" ")}},
{type:"float",name:"setpoint temperature",ref:{value:"manuT",value_t:"setTemperature",extMeta:"7-30",scale:"0.5"}},{type:"int",name:"mode end time",ref:{value:"tempEnd"}},{type:"string",name:"mode end time string",ref:{value:"tempEndStr"}},{type:"float",name:"measured temperature",ref:{value:"currentTemp"}}]},f={command:[{type:"enum",name:"auto",ref:{value:"thermoAuto"}},{type:"enum",name:"away",ref:{value:"thermoAway"}},{type:"time",name:"away until",ref:{value:"thermoAwayUntil",ext:"%time"}},{type:"enum",
name:"frost-guard",ref:{value:"thermoHg"}},{type:"time",name:"frost-guard until",ref:{value:"thermoHgUntil",ext:"%time"}}],status:[{type:"enum",name:"mode",ref:{value:"mode",options:["schedule","away","frost_guard"]}},{type:"int",name:"mode end time",ref:{value:"tempEnd"}},{type:"string",name:"mode end time string",ref:{value:"tempEndStr"}}]};return{SYS:"netatmo",getGatewayType:function(){return[{sys:this.SYS,name:"Netatmo (Online)",port:443}]},getGatewayDeviceType:function(a){return[{sys:this.SYS,
type:"NAMain",name:"Base Station"},{sys:this.SYS,type:"NAModule1",name:"Outdoor module"},{sys:this.SYS,type:"NAModule4",name:"Additional indoor module"},{sys:this.SYS,type:"NAModule3",name:"Rain gauge module"},{sys:this.SYS,type:"NAModule2",name:"Wind gauge module"},{sys:this.SYS,type:"NATherm1",name:"Thermostat"},{sys:this.SYS,type:"NHC",name:"Home Coach"}]},_checkInfo:function(a,b,d){if(a)if(a.gateway)if(a.type)if(a.address)if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;
var c;for(c=0;c<b.length;c++)if(b[c].index===a.gateway){var e=b[c];break}e?d():d(new n(g.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else d(new n(g.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else d(new n(g.INVALID,"address is invalid"));else d(new n(g.INVALID,"type is invalid"));else d(new n(g.INVALID,"gateway is invalid"));else d(new n(g.INVALID,"info is invalid"))},createGateway:function(a,b,d){a?a.refreshToken||a.username&&a.password?d(null,a):d(new n(g.INVALID,"refreshToken is invalid")):
d(new n(g.INVALID,"info is invalid"))},updateGateway:function(a,b,d,f){b?b.refreshToken||b.username&&b.password?f(null,b):f(new n(g.INVALID,"refreshToken is invalid")):f(new n(g.INVALID,"info is invalid"))},deleteGateway:function(a,b,d){d()},createDevice:function(a,b,d){this._checkInfo(a,b,function(b){d(b,a)})},updateDevice:function(a,b,d){this._checkInfo(a,b,function(b){d(b,a)})},deleteDevice:function(a,b,d){d(null,a)},applyUIFilter:function(a,b){var c=function(a,b){if("*"==a)return!0;for(var c=
!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},d=function(a,b,d){var e=[];switch(d.catagory){case "command":a.command&&a.command.forEach(function(a){c(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){c(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},e=function(a,b){var c=[],e=this.getCommandStatusMap(a);e&&(a=d(e,a,b),c=c.concat(a));return c};if(!a.sys)return null;var f=JSON.parse(JSON.stringify(a)),
g=null;switch(b.catagory){case "command":g=e.call(this,a,b);f.command=g;break;case "status":g=e.call(this,a,b);f.status=g;break;default:return null}return g&&0!=g.length?f:null},applyIPEventFilter:function(a,b){if(!a.sys)return null;b=JSON.parse(JSON.stringify(a));a=this.getIPevtMap(a);if(!a)return b;b.ipevt=a.ipevt;return b},getCommandStatusMap:function(b){var c={command:[],status:[]};switch(b.type){case "NAMain":c.status.push(a[25]);c.status.push(a[26]);break;case "NAModule1":case "NAModule2":case "NAModule3":case "NAModule4":case "NATherm1":c.status.push(a[21]);
c.status.push(a[22]);c.status.push(a[23]);c.status.push(a[24]);"NATherm1"==b.type&&(c.status.push(a[27]),c.status.push(a[28]),c.status.push(a[29]),c.status.push(a[30]),c.status.push(a[31]),c.status.push(a[32]));break;case "NHC":c.status.push(a[25]),c.status.push(a[26])}"NATherm1"==b.type&&(c.command=d);if(b.dashboard_data)for(var e in b.dashboard_data)if(b.dashboard_data.hasOwnProperty(e))switch(e){case "AbsolutePressure":c.status.push(a[0]);break;case "CO2":c.status.push(a[1]);break;case "Humidity":c.status.push(a[2]);
c.status.push(a[37]);break;case "Noise":c.status.push(a[3]);break;case "Pressure":c.status.push(a[4]);break;case "Rain":c.status.push(a[5]);break;case "sum_rain_1":c.status.push(a[6]);break;case "sum_rain_24":c.status.push(a[7]);break;case "Temperature":c.status.push(a[8]);break;case "date_max_temp":c.status.push(a[9]);c.status.push(a[33]);break;case "date_min_temp":c.status.push(a[10]);c.status.push(a[34]);break;case "max_temp":c.status.push(a[11]);break;case "min_temp":c.status.push(a[12]);break;
case "WindAngle":c.status.push(a[13]);c.status.push(a[38]);break;case "WindStrength":c.status.push(a[14]);break;case "GustAngle":c.status.push(a[15]);break;case "GustStrength":c.status.push(a[16]);break;case "time_utc":c.status.push(a[17]);c.status.push(a[35]);break;case "date_max_wind_str":c.status.push(a[18]);c.status.push(a[36]);break;case "max_wind_angle":c.status.push(a[19]);break;case "max_wind_str":c.status.push(a[20]);break;case "temp_trend":c.status.push(a[39]);break;case "pressure_trend":c.status.push(a[40]);
break;case "health_idx":c.status.push(a[41]),c.status.push(a[42])}return c},getCommandStatusMap2:function(d){var c={command:[],status:[]},e=null;switch(d.type){case "NAMain":e="time_utc Temperature CO2 Humidity Noise Pressure AbsolutePressure min_temp max_temp date_min_temp date_max_temp temp_trend pressure_trend".split(" ");c.status.push(a[25]);c.status.push(a[26]);break;case "NAModule1":e="time_utc Temperature Humidity min_temp max_temp date_min_temp date_max_temp temp_trend".split(" ");c.status.push(a[21]);
c.status.push(a[22]);c.status.push(a[23]);c.status.push(a[24]);break;case "NAModule2":e="time_utc WindStrength WindAngle GustStrength GustAngle max_wind_str max_wind_angle date_max_wind_str".split(" ");c.status.push(a[21]);c.status.push(a[22]);c.status.push(a[23]);c.status.push(a[24]);break;case "NAModule3":e=["time_utc","Rain","sum_rain_24","sum_rain_1"];c.status.push(a[21]);c.status.push(a[22]);c.status.push(a[23]);c.status.push(a[24]);break;case "NAModule4":e="time_utc Temperature CO2 Humidity Pressure AbsolutePressure min_temp max_temp date_min_temp date_max_temp temp_trend".split(" ");
c.status.push(a[21]);c.status.push(a[22]);c.status.push(a[23]);c.status.push(a[24]);break;case "NATherm1":c.status.push(a[21]);c.status.push(a[22]);c.status.push(a[23]);c.status.push(a[24]);break;case "NRV":c.status.push(a[21]);c.status.push(a[22]);c.status.push(a[23]);c.status.push(a[24]);break;case "NAPlug":c.status.push(a[21]);c.status.push(a[22]);c.status.push(a[25]);c.status.push(a[26]);break;case "NHC":e="time_utc Temperature CO2 Humidity Noise Pressure AbsolutePressure health_idx min_temp max_temp date_min_temp date_max_temp".split(" ");
c.status.push(a[25]);c.status.push(a[26]);break;case "room":c=b;break;case "home":c=f}e&&e.forEach(function(b){switch(b){case "AbsolutePressure":c.status.push(a[0]);break;case "CO2":c.status.push(a[1]);break;case "Humidity":c.status.push(a[2]);c.status.push(a[37]);break;case "Noise":c.status.push(a[3]);break;case "Pressure":c.status.push(a[4]);break;case "Rain":c.status.push(a[5]);break;case "sum_rain_1":c.status.push(a[6]);break;case "sum_rain_24":c.status.push(a[7]);break;case "Temperature":c.status.push(a[8]);
break;case "date_max_temp":c.status.push(a[9]);c.status.push(a[33]);break;case "date_min_temp":c.status.push(a[10]);c.status.push(a[34]);break;case "max_temp":c.status.push(a[11]);break;case "min_temp":c.status.push(a[12]);break;case "WindAngle":c.status.push(a[13]);c.status.push(a[38]);break;case "WindStrength":c.status.push(a[14]);break;case "GustAngle":c.status.push(a[15]);break;case "GustStrength":c.status.push(a[16]);break;case "time_utc":c.status.push(a[17]);c.status.push(a[35]);break;case "date_max_wind_str":c.status.push(a[18]);
c.status.push(a[36]);break;case "max_wind_angle":c.status.push(a[19]);break;case "max_wind_str":c.status.push(a[20]);break;case "temp_trend":c.status.push(a[39]);break;case "pressure_trend":c.status.push(a[40]);break;case "health_idx":c.status.push(a[41]),c.status.push(a[42])}});return c},getIPevtMap:function(a){return(a=this.getCommandStatusMap(a))?{ipevt:a.status}:null},calcFeltTemp:function(a,b,d){if(d&&"object"==typeof d&&0===d.feel_like_algo)d=243.5,b=Math.log(.01*b)+17.67*a/(d+a),b=a+.5555*
(6.11*Math.exp(5417.753*(1/273.16-1/(d*b/(17.67-b)+273.15)))-10);else{d=[-42.379,2.04901523,10.14333127,-.22475541,-.00683783,-.05481717,.00122874,8.5282E-4,-1.99E-6];a=9*a/5+32;var c=a*a,e=b*b;b=d[0]+d[1]*a+d[2]*b+d[3]*a*b+d[4]*c+d[5]*e+d[6]*c*b+d[7]*a*e+d[8]*c*e;b=5*(b-32)/9}return Math.round(10*b)/10},supportSmartWidget:function(a){return a&&a.type?0<=["home","room"].indexOf(a.type):!1},applySmartWidgetFilter:function(a,b,d,f,g){if(!b||!b.type)return!1;d=[];if("home"===b.type){b={"%auto%":{value:"thermoAuto"},
"%away%":{value:"thermoAway"},"%awayUntil%":{value:"thermoAwayUntil",ext:"%time"},"%frostGuard%":{value:"thermoHg"},"%frostGuardUntil%":{value:"thermoHgUntil",ext:"%time"}};var c={"%mode%":{value:"mode",options:["schedule","away","frost_guard"]}};d.push("netatmo_thermo")}else if("room"===b.type)b={"%auto%":{value:"thermoAuto"},"%thermoUp%":{value:"thermoUp"},"%thermoDown%":{value:"thermoDown"},"%thermoManu%":{value:"thermoManu",ext:"%f",extMeta:"7-30",scale:.5}},c={"%mode%":{value:"mode",options:"manual max off schedule away hg".split(" ")},
"%setTemp%":{value:"manuT",extMeta:"7-30",scale:.5},"%currentTemp%":{value:"currentTemp"}},d.push("netatmo_thermo");else return!1;return a._injectToSmartWidgetTemplate(f,d,g,b,c)}}}();xnm.aio.netatmo.DM.getCommandStatusMap=xnm.aio.netatmo.DM.getCommandStatusMap2;xnm.aio.netatmo.Cloud=xnm.aio.netatmo.Client;
xnm.aio.netatmo.Handler=function(){var n=function(){this._updateListener=[]};n.prototype.Client=xnm.aio.netatmo.Client;n.prototype.Cloud=xnm.aio.netatmo.Cloud;n.prototype.MNetatmo=xnm.aio.netatmo.MNetatmo;n.prototype.devicemanager=xnm.aio.netatmo.DM;n.prototype.registModule=function(g){g.register(this.devicemanager.SYS,"netatmo")};n.prototype.resolveGateway=function(g){return g.refreshToken||g.username&&g.password?new xnm.aio.netatmo.Cloud(g.username,g.password,g.refreshToken):null};n.prototype.getDeviceCommands=
function(g,a){g=(g=xnm.aio.netatmo.DM.applyUIFilter(g,{catagory:"command",elems:"*"}))?g.command:[];a&&a(null,g)};n.prototype.getDeviceStatus=function(g,a){g=(g=xnm.aio.netatmo.DM.applyUIFilter(g,{catagory:"status",elems:"*"}))?g.status:[];a&&a(null,g)};n.prototype.login=function(g,a){(g=this.resolveGateway(g))?g.auth(function(d,b){d?a&&a(d):a&&a(d,{refreshToken:b.refresh_token})}):a&&a(Error("gateway json format invalid"))};n.prototype.doCommand=function(g,a,d,b){(g=this.resolveGateway(g))?g.executeCommandCreator(a,
d,function(a){b&&b(a)}):b&&b(Error("gateway json format invalid"))};n.prototype.doStatus=function(g,a,d,b,f){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:g,device:d,status:b}],function(a,b){a?f&&f(a):f&&f(null,b[0])}):f&&f(Error("gateway json format invalid"))};n.prototype.getDeviceList=function(g,a){(g=this.resolveGateway(g))?g.getDeviceList(a):a&&a(Error("gateway json format invalid"))};n.prototype.getCamList=function(g,a){(g=this.resolveGateway(g))?g.getCamList(a):a&&a(Error("gateway json format invalid"))};
n.prototype.pause=function(g){xnm.aio.netatmo.Cloud.pause(g)};n.prototype.addUpdateListener=function(g){g&&-1==this._updateListener.indexOf(g)&&this._updateListener.push(g)};n.prototype.getDevice=function(g){return new this.MNetatmo(g)};n.prototype.setMNetatmoCloudUrl=function(g){this.MNetatmo.CLOUD_URL=g};return n}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.netatmo.Handler);
