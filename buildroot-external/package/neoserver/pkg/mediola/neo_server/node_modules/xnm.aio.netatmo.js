var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.netatmo=xnm.aio.netatmo||{};
xnm.aio.netatmo.Cloud=function(){var m={},g={},a={},d={},b=function(a){return a.refreshToken?a.refreshToken:a.user?g[a.user]:null},f=function(a){var k=b(a);if(!k)return null;m[k]||(m[k]={cloud:a});return m[k].cred?m[k].cred:{refresh_token:k}},e=function(a,b){var k=b.refresh_token;a.refreshToken||(a.refreshToken=k);a.user&&(g[a.user]=k);m[k]||(m[k]={cloud:a});m[k].cred=b;b.expires_in&&(b._expireTime=(new Date).getTime()+1E3*b.expires_in-6E5)},c=function(a){return(a=f(a))&&a._expireTime?(new Date).getTime()>
a._expireTime:!1},n=function(a){var k=b(a);if(!k)return null;m[k]||(m[k]={cloud:a});m[k].weather||(m[k].weather={updateData:{running:!1,error:null}});return m[k].weather},h=function(a){a=n(a);a.timer&&clearTimeout(a.timer);a.updateData={running:!0,error:null}},t=function(a,c,d){var k=b(a),e=n(a);e.updateData={running:!1,error:c};try{if(!c&&d){var p=require("xnm.aio.netatmo.js")._updateListener;if(p&&0<p.length)for(var l=0;l<p.length;l++)p[l]&&p[l].updateWeather&&p[l].updateWeather(a,e.data,d)}}catch(x){}e.timer&&
clearTimeout(e.timer);p=r(a);c?e.data=null:d&&(e.data=d);d=e.tmpCBs;e.tmpCBs=[];if(d)for(l=0;l<d.length;l++)if(c)d[l](c);else a.getWeatherStatus(d[l]);c?e.timer=setTimeout(function(){m[k].cloud.getStationsData(null)},6E4):(a=r(a),p&&a&&p==a&&1>e.retry?(e.retry=e.retry?e.retry+1:1,c=60*e.retry,e.delay=c,e.timer=setTimeout(function(){m[k].cloud.getStationsData(null)},1E3*c)):(e.retry=0,(p=e.delay)||(p=0),c=6E5,a&&(d=Math.round((new Date).getTime()/1E3),d>a&&(c=600-(d-a)%600+30)),require("x.logger.js").getLogger("xnm.aio.netatmo.Cloud").log("debug",
"weather station next poll in t:"+c/60+" min delay:"+p),e.timer=setTimeout(function(){m[k].cloud.getStationsData(null)},1E3*c+1E3*p)))},r=function(a){a=n(a);if(!a.data)return 0;for(var b=0;b<a.data.length;b++)if(a.data[b]&&a.data[b].dashboard_data&&a.data[b].dashboard_data.time_utc)return a.data[b].dashboard_data.time_utc;return 0},u=function(a){var c=b(a);if(!c)return null;m[c]||(m[c]={cloud:a});m[c].homecoach||(m[c].homecoach={updateData:{running:!1,error:null}});return m[c].homecoach},y=function(a){a=
u(a);a.timer&&clearTimeout(a.timer);a.updateData={running:!0,error:null}},w=function(a,c,d){var k=b(a),e=u(a);e.updateData={running:!1,error:c};try{if(!c&&d){var p=require("xnm.aio.netatmo.js")._updateListener;if(p&&0<p.length)for(var l=0;l<p.length;l++)p[l]&&p[l].updateHomeCoach&&p[l].updateHomeCoach(a,e.data,d)}}catch(x){}e.timer&&clearTimeout(e.timer);p=A(a);c?e.data=null:d&&(e.data=d);d=e.tmpCBs;e.tmpCBs=[];if(d)for(l=0;l<d.length;l++)if(c)d[l](c);else a.getWeatherStatus(d[l]);c?e.timer=setTimeout(function(){m[k].cloud.getHomeCoachsData(null)},
6E4):(a=A(a),p&&a&&p==a&&1>e.retry?(e.retry=e.retry?e.retry+1:1,c=60*e.retry,e.delay=c,e.timer=setTimeout(function(){m[k].cloud.getHomeCoachsData(null)},1E3*c)):(e.retry=0,(p=e.delay)||(p=0),c=6E5,a&&(d=Math.round((new Date).getTime()/1E3),d>a&&(c=600-(d-a)%600+30)),e.timer=setTimeout(function(){m[k].cloud.getHomeCoachsData(null)},1E3*c+1E3*p)))},A=function(a){a=u(a);if(!a.data)return 0;for(var c=0;c<a.data.length;c++)if(a.data[c]&&a.data[c].dashboard_data&&a.data[c].dashboard_data.time_utc)return a.data[c].dashboard_data.time_utc;
return 0},v=function(a){var c=b(a);if(!c)return null;m[c]||(m[c]={cloud:a});m[c].thermo||(m[c].thermo={updateData:{running:!1,error:null}});return m[c].thermo},D=function(a){a=v(a);a.timer&&clearTimeout(a.timer);a.updateData={running:!0,error:null}},B=function(a,c,e){var d=b(a),k=v(a);try{if(!c&&e){var l=require("xnm.aio.netatmo.js")._updateListener;if(l&&0<l.length)for(var p=0;p<l.length;p++)l[p]&&l[p].updateThermo&&l[p].updateThermo(a,k.data,e)}}catch(x){}k.timer&&clearTimeout(k.timer);k.updateData=
{running:!1,error:c};c?k.data=null:e&&(k.data=e);e=k.tmpCBs;k.tmpCBs=[];if(e)for(l=0;l<e.length;l++)if(c)e[l](c);else a.getThermoStatus(e[l]);k.timer=c?setTimeout(function(){m[d].cloud.getThermostatsData(null)},6E4):setTimeout(function(){m[d].cloud.getThermostatsData(null)},18E5)},C=function(a,c){var e=b(a);if(!c.module)return 60;a=v(a);a.duration||(m[e].thermo.duration={});e=a.duration[c.module];if(!e){a:{if(c.module&&XC&&XC.localStorage){if(e=XC.localStorage.getItem("netatmo"))try{e=JSON.parse(e)}catch(z){}if(e&&
e.duration){e=e.duration[c.module];break a}}e=null}a.duration[c.module]=e}e||(e=60);return e},E=function(a,c,b){a=v(a);a.duration||(a.duration={});if(c.module&&(a.duration[c.module]=b,c.module&&XC&&XC.localStorage)){if(a=XC.localStorage.getItem("netatmo"))try{a=JSON.parse(a)}catch(z){}a&&"object"==typeof a||(a={});a.duration||(a.duration={});a.duration[c.module]=b;XC.localStorage.setItem("netatmo",JSON.stringify(a))}},F=function(a,c){a=v(a);if(a.data)for(var b=0;b<a.data.length;b++){var e=a.data[b];
if(e&&e._id==c.address&&e.modules)for(var d=0;d<e.modules.length;d++){var k=e.modules[d];if(k&&k._id==c.module)return k.setpoint}}return null},q=function(a,c,b){this._logger=require("x.logger.js").getLogger("xnm.aio.netatmo.Cloud");this.user=a;this.password=c;this.refreshToken=b;this._scope="read_station read_thermostat read_homecoach write_thermostat read_camera access_camera read_presence access_presence".split(" ");this._scopeFallback="read_station read_thermostat read_homecoach write_thermostat read_camera access_camera read_presence".split(" ")};
q.prototype.executeCommandCreator=function(a,c,b){if(c&&c.value){var e=this,d={},k=C(this,a);F(this,a);switch(c.value){case "thermoAuto":d.setpoint_mode="program";break;case "thermoAway":d.setpoint_mode="away";break;case "thermoHg":d.setpoint_mode="hg";break;case "thermoOff":d.setpoint_mode="off";break;case "thermoMax":d.setpoint_mode="max";d.setpoint_endtime=Math.round(((new Date).getTime()+6E4*k)/1E3);break;case "thermoManu":if(null==c.ext||"undefined"==typeof c.ext){b&&b(Error("command ext invalid"));
return}var l=c.ext;"string"==typeof c.ext&&(l=parseFloat(c.ext));5.5>l&&(l=5.5);30<l&&(l=30);d.setpoint_mode="manual";d.setpoint_endtime=Math.round(((new Date).getTime()+6E4*k)/1E3);d.setpoint_temp=l;break;case "tempDuration":if(null==c.ext||"undefined"==typeof c.ext){b&&b(Error("command ext invalid"));return}k=c.ext;"string"==typeof c.ext&&(k=parseFloat(c.ext));15>k&&(k=15);720<k&&(k=720);E(this,a,k);b&&b();return;default:b&&b(Error("unknow command"))}this.setThermPoint(a,d,function(c){if(c)b&&b(c);
else{c=v(e);c.data||(c.data=[]);var k;for(k=0;k<c.data.length;k++)if(c.data[k]&&c.data[k]._id==a.address){var l=c.data[k];break}l||(l={_id:a.address,modules:[]},c.data.push(l));for(k=0;k<l.modules.length;k++)if(l.modules[k]&&l.modules[k]._id==a.module){var p=l.modules[k];break}p||(p={_id:a.module},l.modules.push(p));p.setpoint=d;b&&b()}})}else b&&b(Error("command format invalid"))};q.prototype.getStatesCreator=function(c,b,e){b?this.getAllStatus(function(c,k){for(var l=[],p=0;p<b.length;p++){var f=
b[p];if(f.id){var n,h="?";if(!c&&k&&f.device&&f.device.type&&(n="NAMain"==f.device.type||"NHC"==f.device.type?f.device.address:f.device.address+"|"+f.device.module)&&f.status&&f.status.value&&(n=k[n]))if("tempFelt"==f.status.value)h=n.temp,n=n.hum,h="undefined"!=typeof h&&"undefined"!=typeof n?"NHC"==f.device.type?xnm.aio.netatmo.DM.calcFeltTemp(h,n,d):xnm.aio.netatmo.DM.calcFeltTemp(h,n,a):"?";else if("winDName"==f.status.value)h=n.winD,null===h||"undefined"==typeof h?h="?":(h=Number(h),h=isNaN(h)?
"?":23<h&&68>=h?"NO":68<h&&113>=h?"O":113<h&&158>=h?"SO":158<h&&203>=h?"S":203<h&&248>=h?"SW":248<h&&293>=h?"W":293<h&&338>=h?"NW":"N");else if(h=n[f.status.value],null==h||"undefined"==typeof h)h="?";l.push({id:f.id,status:h})}}e&&e(null,l)}):e&&e(Error("deviceList is null"))};q.prototype.getAllStatus=function(a){var c=this,b={};this.getWeatherStatus(function(e,d){e?a&&a(e):c.getThermoStatus(function(e,k){e?a&&a(e):c.getHomeCoachStatus(function(c,e){if(c)a&&a(c);else{for(var f in d)d.hasOwnProperty(f)&&
(b[f]=d[f]);for(f in k)k.hasOwnProperty(f)&&(b[f]=k[f]);for(f in e)e.hasOwnProperty(f)&&(b[f]=e[f]);a&&a(null,b)}})})})};q.prototype.getDeviceList=function(a){var c=this;this.getStationsData(function(b,e){b?a&&a(b):c.getThermostatsData(function(b,d){b?a&&a(b):c.getHomeCoachsData(function(c,b){if(c)a&&a(c);else{c={weather:[],thermostat:[]};if(e){for(var k=[],f=0;f<e.length;f++){var l=e[f];if(l&&l._id&&l.type){var p=l.station_name,n=l.module_name,h={address:l._id,type:l.type,name:p+" ("+n+")"};h.dashboard_data=
l.dashboard_data;h.modules=[];if(l.modules)for(var g=0;g<l.modules.length;g++)l.modules[g]&&l.modules[g]._id&&l.modules[g].type&&(n=l.modules[g].module_name,h.modules.push({address:l._id,module:l.modules[g]._id,type:l.modules[g].type,name:p+" ("+n+")",dashboard_data:l.modules[g].dashboard_data}));k.push(h)}}c.weather=k}if(d){k=[];for(f=0;f<d.length;f++)if((l=d[f])&&l._id&&l.type&&(p=l.station_name,l.modules))for(h=0;h<l.modules.length;h++)l.modules[h]&&l.modules[h]._id&&l.modules[h].type&&(n=l.modules[h].module_name,
k.push({address:l._id,module:l.modules[h]._id,type:l.modules[h].type,name:p+" ("+n+")"}));c.thermostat=k}if(b){k=[];for(f=0;f<b.length;f++)(l=b[f])&&l._id&&l.type&&(p=l.module_name,n={address:l._id,type:l.type,name:l.name},p&&(n.name+=" ("+p+")"),n.dashboard_data=l.dashboard_data,n.modules=[],k.push(n));c.homecoach=k}a&&a(null,c)}})})})};q.prototype.getCamList=function(a){var c=this;this.getCamsData(function(b,e){if(b)a&&a(b);else{b={cam:[]};if(e){for(var d=[],k=0;k<e.length;k++)if(e[k]&&e[k].id){var l=
e[k].name,n=e[k].cameras;if(n)for(var h=0;h<n.length;h++)if(n[h]&&n[h].id){var p="welcome";"NACamera"==n[h].type?p="welcome":"NOC"==n[h].type&&(p="presence");p&&(p={sys:"cam",type:"system",manufacturer:"netatmo",model:p,address:n[h].id},n[h].name&&(p.name=n[h].name+(l?" ("+l+")":"")),d.push(p))}}b.cam=d}e=f(c);if(b.cam&&0<b.cam.length)for(d=0;d<b.cam.length;d++)b.cam[d].refreshToken=e.refresh_token;a&&a(null,b)}})};q.prototype.getWeatherStatus=function(a){var c=function(a,c){var b={};if(c)for(var e=
0;e<c.length;e++){var d=c[e];if(d&&d._id){var k=a._resolveStationStatus(d);k&&(b[d._id]=k);if(d.modules)for(var l=0;l<d.modules.length;l++)(k=a._resolveModuleStatus(d.modules[l]))&&(b[d._id+"|"+d.modules[l]._id]=k)}}return b};this._logger.log("debug","getWeatherStatus");var b=n(this),e=this,d=a;a=null;b&&b.data?(a=c(this,b.data),d&&d(null,a),d=null):this.getStationsData(function(a){a?(d&&d(a),d=null):d&&e.getWeatherStatus(d)})};q.prototype.getHomeCoachStatus=function(a){var c=function(a,c){var b=
{};if(c)for(var e=0;e<c.length;e++){var d=c[e];if(d&&d._id){var k=a._resolveHomeCoachStatus(d);k&&(b[d._id]=k)}}return b};this._logger.log("debug","getHomeCoachStatus");var b=u(this),e=this,d=a;a=null;b&&b.data?(a=c(this,b.data),d&&d(null,a),d=null):this.getHomeCoachsData(function(a){a?(d&&d(a),d=null):d&&e.getHomeCoachStatus(d)})};q.prototype.getThermoStatus=function(a){var c=function(a,c){for(var b={},e=0;e<c.length;e++){var d=c[e];if(d&&d._id&&d.modules)for(var k=0;k<d.modules.length;k++){var f=
a._resolveModuleStatus(d.modules[k]);f&&(b[d._id+"|"+d.modules[k]._id]=f)}}return b},b=v(this),e=this,d=a,k=null;b.updateData.running?(b.tmpCBs||(b.tmpCBs=[]),b.tmpCBs.push(a)):b.data?(k=c(this,b.data),d&&d(null,k),d=null):this.getThermostatsData(function(a){a?(d&&d(a),d=null):d&&e.getThermoStatus(d)})};q.prototype.getCamUrl=function(a,c){var b=this;this._refreshToken(this.refreshToken,function(e,d){if(e)d&&d.error&&(e=Error(d.error),e._code="auth_error"),c&&c(e);else{if(d&&d.access_token)var k=d.access_token;
k?d&&d.scope&&-1==d.scope.indexOf("access_camera")?c&&c(null,"scop_error"):b._getCamsData(k,function(d,e){if(d)e&&e.error&&(d=Error(e.error),d._code="api_error"),c&&c(d);else if(d=null,e.body&&e.body.homes&&(d=e.body.homes),d){for(e=0;e<d.length;e++)if(d[e]&&d[e].cameras){for(var k=d[e].cameras,f=0;f<k.length;f++)if(k[f]&&k[f].id==a&&k[f].vpn_url){var l=k[f];break}if(l)break}l?1==l.is_local?b._getLocalCamUrl(l.vpn_url,function(a,b){c&&c(a,b)}):c&&c(null,l.vpn_url+"/live/index.m3u8"):c&&c("no cam with address:"+
a)}else c&&c("get cams data reponse invalid")}):c&&c(Error("auth response invalid"))}})};q.prototype._resolveStationStatus=function(a){var c={};null!=a.wifi_status&&"undefined"!=typeof a.wifi_status&&(c.wifi=a.wifi_status,c.wifiStatus=86<=c.wifi?"bad":71<=c.wifi?"middle":56<=c.wifi?"good":"very_good");if(a.dashboard_data&&(a=this._resolveDashboard(a.dashboard_data)))for(var b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c};q.prototype._resolveModuleStatus=function(a){var c={};null!=a.rf_status&&"undefined"!=
typeof a.rf_status&&(c.rf=a.rf_status,c.rfStatus=90<=c.rf?"very_low":80<=c.rf?"low":70<=c.rf?"medium":60<=c.rf?"high":"full");if(null!=a.battery_vp&&"undefined"!=typeof a.battery_vp)switch(c.bat=a.battery_vp,a.type){case "NAModule4":c.batStatus=5640<=c.bat?"full":5280<=c.bat?"high":4920<=c.bat?"medium":4560<=c.bat?"low":"very_low";break;case "NAModule1":case "NAModule3":c.batStatus=5500<=c.bat?"full":5E3<=c.bat?"high":4500<=c.bat?"medium":4E3<=c.bat?"low":"very_low";break;case "NAModule2":c.batStatus=
5900<=c.bat?"full":5180<=c.bat?"high":4770<=c.bat?"medium":4360<=c.bat?"low":"very_low";break;case "NATherm1":c.batStatus=4100<=c.bat?"full":3600<=c.bat?"high":3300<=c.bat?"medium":3E3<=c.bat?"low":"very_low"}var b,d;if("NATherm1"==a.type&&(b=this._resolveThermoStat(a)))for(d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);if(a.dashboard_data&&(b=this._resolveDashboard(a.dashboard_data)))for(d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);return c};q.prototype._resolveHomeCoachStatus=function(a){var c={};null!=a.wifi_status&&
"undefined"!=typeof a.wifi_status&&(c.wifi=a.wifi_status,c.wifiStatus=86<=c.wifi?"bad":71<=c.wifi?"middle":56<=c.wifi?"good":"very_good");if(a.dashboard_data&&(a=this._resolveDashboard(a.dashboard_data)))for(var b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c};q.prototype._resolveThermoStat=function(a){var c={};if(a.setpoint){switch(a.setpoint.setpoint_mode){case "program":var b="auto";break;case "away":b="away";break;case "hg":b="frost-guard";break;case "manual":b="manu";break;case "off":b="off";
break;case "max":b="boost"}b&&(c.mode=b);null!=a.setpoint.setpoint_temp&&"undefined"!=typeof a.setpoint.setpoint_temp&&(c.manuT=a.setpoint.setpoint_temp);if(null!=a.setpoint.setpoint_endtime&&"undefined"!=typeof a.setpoint.setpoint_endtime)if(c.tempEnd=a.setpoint.setpoint_endtime,c.tempEndStr=(new Date(1E3*a.setpoint.setpoint_endtime)).toLocaleString(),"undefined"!=typeof dateFormat&&dateFormat)try{c.tempEndStr=dateFormat(c.tempEndStr,"dd mm yyyy, HH:MM:ss")}catch(z){}else c.tempEndStr=c.tempEndStr.toLocaleString()}a.measured&&
(null!=a.measured.time&&"undefined"!=typeof a.measured.time&&(c.mesureT=a.measured.time),null!=a.measured.temperature&&"undefined"!=typeof a.measured.temperature&&(c.currentTemp=a.measured.temperature));c.tempDuration=C(this,{module:a._id});return c};q.prototype._resolveDashboard=function(a){var c=function(a,c){return null!=a[c]&&"undefined"!=typeof a[c]},b={};c(a,"AbsolutePressure")&&(b.absPres=a.AbsolutePressure);c(a,"CO2")&&(b.co2=a.CO2);c(a,"Humidity")&&(b.hum=a.Humidity);c(a,"Noise")&&(b.noise=
a.Noise);c(a,"Pressure")&&(b.pres=a.Pressure);c(a,"Rain")&&(b.rain=a.Rain);c(a,"sum_rain_1")&&(b.rain1h=a.sum_rain_1);c(a,"sum_rain_24")&&(b.rain24h=a.sum_rain_24);c(a,"Temperature")&&(b.temp=a.Temperature);if(c(a,"date_max_temp")){b.timeMaxTemp=a.date_max_temp;var d=1E3*a.date_max_temp;b.timeMaxTempStr=new Date(d);b.timeMaxTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(b.timeMaxTempStr,"dd mm yyyy, HH:MM:ss"):b.timeMaxTempStr.toLocaleString()}c(a,"date_min_temp")&&(b.timeMinTemp=a.date_min_temp,
d=1E3*a.date_min_temp,b.timeMinTempStr=new Date(d),b.timeMinTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(b.timeMinTempStr,"dd.mm.yyyy, HH:MM:ss"):b.timeMinTempStr.toLocaleString());c(a,"max_temp")&&(b.maxTemp=a.max_temp);c(a,"min_temp")&&(b.minTemp=a.min_temp);c(a,"WindAngle")&&(b.winD=a.WindAngle);c(a,"WindStrength")&&(b.winS=a.WindStrength);c(a,"GustAngle")&&(b.gwinD=a.GustAngle);c(a,"GustStrength")&&(b.gwinS=a.GustStrength);c(a,"time_utc")&&(b.mesureT=a.time_utc,d=1E3*a.time_utc,
b.mesureTStr=new Date(d),b.mesureTStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(b.mesureTStr,"dd.mm.yyyy, HH:MM:ss"):b.mesureTStr.toLocaleString());c(a,"date_max_wind_str")&&(b.timeMaxWind=a.date_max_wind_str,d=1E3*a.date_max_wind_str,b.timeMaxWindStr=new Date(d),b.timeMaxWindStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(b.timeMaxWindStr,"dd.mm.yyyy, HH:MM:ss"):b.timeMaxWindStr.toLocaleString());c(a,"max_wind_angle")&&(b.maxWinD=a.max_wind_angle);c(a,"max_wind_str")&&(b.maxWinS=
a.max_wind_str);c(a,"temp_trend")&&(b.tempTrend=a.temp_trend);c(a,"pressure_trend")&&(b.presTrend=a.pressure_trend);if(c(a,"health_idx"))switch(b.healthIdxLvl=a.health_idx,parseInt(b.healthIdx)){case 0:b.healthIdx="healthy";break;case 1:b.healthIdx="fine";break;case 2:b.healthIdx="fair";break;case 3:b.healthIdx="poor";break;case 4:b.healthIdx="unhealthy"}return b};q.prototype.auth=function(a){this._logger.log("debug","auth");var b=f(this),d=this;b?b.access_token?c(this)?this._refreshToken(b.refresh_token,
function(c,b){c?(b&&b.error&&(c=Error(b.error),c._code="refresh_token_error"),a&&a(c)):(e(d,b),a&&a(null,b))}):a&&a(null,b):this._refreshToken(b.refresh_token,function(c,b){c?(b&&b.error&&(c=Error(b.error),c._code="refresh_token_error"),a&&a(c)):(e(d,b),a&&a(null,b))}):this._auth(this._scope.join(" "),function(c,b){if(c){if(b)try{if(b=JSON.parse(b),b.error&&(c=Error(b.error),c._code="auth_error","invalid_request"==b.error&&-1!=d._scope.indexOf("access_presence"))){d._scope=d._scopeFallback;d.auth(a);
return}}catch(G){}a&&a(c)}else e(d,b),a&&a(null,b)})};q.prototype.setThermPoint=function(a,c,b){if(a&&a.address&&a.module)if(c&&c.setpoint_mode)if("max"!=c.setpoint_mode||c.setpoint_endtime)if("manual"!=c.setpoint_mode||c.setpoint_endtime&&c.setpoint_temp){var d=this;this.auth(function(e){e?b&&b(e):d._setThermPoint(f(d).access_token,a.address,a.module,c.setpoint_mode,c.setpoint_endtime,c.setpoint_temp,function(a,c){a?(c&&c.error&&(a=Error(c.error),a._code="api_error"),b&&b(a)):b&&b(null,c)})})}else b&&
b(Error("param format invalid"));else b&&b(Error("param format invalid"));else b&&b(Error("param format invalid"));else b&&b(Error("device format invalid"))};q.prototype.getStationsData=function(c){this._logger.log("debug","getStationsData");var b=this;this.auth(function(d){d?c&&c(d):(d=n(b))&&d.updateData&&d.updateData.running?(d.tmpCBs||(d.tmpCBs=[]),d.tmpCBs.push(c)):(h(b),b._getStationsData(f(b).access_token,null,function(d,e){d?(e&&e.error&&(d=Error(e.error),d._code="api_error"),t(b,d,null),
c&&c(d)):(d=null,e.body&&e.body.devices&&(d=e.body.devices),e.body&&e.body.user&&e.body.user.administrative&&(a=e.body.user.administrative),t(b,null,d),c&&c(null,d))}))})};q.prototype.getThermostatsData=function(a){var c=this;this.auth(function(b){b?a&&a(b):(b=v(this))&&b.updateData&&b.updateData.running?(b.tmpCBs||(b.tmpCBs=[]),b.tmpCBs.push(a)):(D(c),c._getThermostatsData(f(c).access_token,null,function(b,d){b?(d&&d.error&&(b=Error(d.error),b._code="api_error"),B(c,b,null),a&&a(b)):(b=null,d.body&&
d.body.devices&&(b=d.body.devices),B(c,null,b),a&&a(null,b))}))})};q.prototype.getHomeCoachsData=function(a){this._logger.log("debug","getHomeCoachsData");var c=this;this.auth(function(b){b?a&&a(b):(b=u(this))&&b.updateData&&b.updateData.running?(b.tmpCBs||(b.tmpCBs=[]),b.tmpCBs.push(a)):(y(c),c._getHomeCoachsData(f(c).access_token,null,function(b,e){b?(e&&e.error&&(b=Error(e.error),b._code="api_error"),w(c,b,null),a&&a(b)):(b=null,e.body&&e.body.devices&&(b=e.body.devices),e.body&&e.body.user&&e.body.user.administrative&&
(d=e.body.user.administrative),w(c,null,b),a&&a(null,b))}))})};q.prototype.getCamsData=function(a){this._logger.log("debug","getCamsData");var c=this;this.auth(function(b){b?a&&a(b):c._getCamsData(f(c).access_token,function(c,b){c?(b&&b.error&&(c=Error(b.error),c._code="api_error"),a&&a(c)):(c=null,b.body&&b.body.homes&&(c=b.body.homes),a&&a(null,c))})})};q.prototype._auth=function(a,c){this._logger.log("trace","_auth");this._doRequest("POST","/oauth2/token",{grant_type:"password",client_id:"564b2c5245a1e3173cb21d3b",
client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",username:this.user,password:this.password,scope:a},c)};q.prototype._refreshToken=function(a,c){this._logger.log("trace","_refreshToken");this._doRequest("POST","/oauth2/token",{grant_type:"refresh_token",client_id:"564b2c5245a1e3173cb21d3b",client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",refresh_token:a},c)};q.prototype._setThermPoint=function(a,c,b,d,e,f,n){a={access_token:a,device_id:c,module_id:b,setpoint_mode:d};e&&(a.setpoint_endtime=
e);f&&(a.setpoint_temp=f);this._doRequest("GET","/api/setthermpoint",a,n)};q.prototype._getStationsData=function(a,c,b){this._logger.log("debug","_getStationsData");a={access_token:a};c&&(a.device_id=c);this._doRequest("GET","/api/getstationsdata",a,b)};q.prototype._getHomeCoachsData=function(a,c,b){this._logger.log("debug","_getHomeCoachsData");a={access_token:a};c&&(a.device_id=c);this._doRequest("GET","/api/gethomecoachsdata",a,b)};q.prototype._getThermostatsData=function(a,c,b){a={access_token:a};
c&&(a.device_id=c);this._doRequest("GET","/api/getthermostatsdata",a,b)};q.prototype._getCamsData=function(a,c){this._doRequest("GET","/api/gethomedata",{access_token:a},c)};q.prototype._getLocalCamUrl=function(a,c){var b=this;this._logger.log("trace","ping cam "+a);this._doUrlRequest("get",a+"/command/ping",null,function(d,e){!d&&e&&e.local_url?b._doUrlRequest("get",e.local_url+"/command/ping",null,function(b,d){b||!d||d.local_url!=e.local_url?c&&c(null,a+"/live/index.m3u8"):c&&c(null,d.local_url+
"/live/index.m3u8")}):c&&c(null,a+"/live/index.m3u8")})};q.prototype._doRequest=function(a,c,b,d){this._doUrlRequest(a,"https://api.netatmo.net"+c,b,d)};q.prototype._doUrlRequest=function(a,c,b,d){var e=this,f=d,n=null;try{n=JSON.parse(JSON.stringify(b)),n.username&&(n.username="xxxxxx"),n.password&&(n.password="xxxxxx")}catch(x){n=b}this._logger.log("trace","send "+a+" req to:"+c+" data:"+JSON.stringify(n));$.ajax({url:c,type:a,timeout:1E4,dataType:"json",data:b,cache:!1,success:function(a){e._logger.log("trace",
"http request success:"+JSON.stringify(a));d&&d(null,a)},error:function(a,c,b){c="http request error:"+(a?a.status:"0")+"-"+c;e._logger.log("warn","http request error:"+c);c=Error(c);b&&(e._logger.log("warn","http request http error:"+b),c.httpError=!0,c.statusCode=a?a.status:0);f&&(f(c,a?a.responseText:null),f=null)}})};q.prototype.toJSON=function(){return{sys:xnm.aio.netatmo.DM.SYS,username:this.user,password:this.password}};q.prototype.equalsTo=function(a){return a&&a instanceof q?this.user==a.user&&
this.password==a.password:!1};q.pause=function(a){for(var c in m)if(m.hasOwnProperty(c)){var b=m[c];b&&b.weather&&b.weather.timer&&clearTimeout(b.weather.timer);b&&b.thermo&&b.thermo.timer&&clearInterval(b.thermo.timer)}m={};a&&a()};return q}();
xnm.aio.netatmo.MNetatmo=function(){var m=function(g){this._logger=require("x.logger.js").getLogger("xnm.aio.netatmo.MNetatmo");this._interval=0;this._on={};this._updateInterval=12E4;this._url=null;this._username=g?g.username:null;this._password=g?g.password:null;this._basicAuth=g?g.basicAuth:null};m.CLOUD_URL="cloud.mediola.com";m.prototype={_doUpdate:function(g){var a=this;APP.isInDemoMode||this.getStates(null,function(d,b){if(b&&b.XC_SUC){XC.debugf("[MNetatmo] Received update.");for(var f in b.XC_SUC){d=
b.XC_SUC[f];for(var e in d){var c=d[e],n=f+"_"+e;if(c.states)for(var h in c.states)CommandHandler.setState(n+":"+h,c.states[h],!0)}}g&&g();if(Array.isArray(a._on.update))for(b={type:"update"},f=0;f<a._on.update.length;f++)(e=a._on.update[f])&&e(b)}})},_sendRequest:function(g,a){"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var d=require("https"),b=this._getURL();b=b.replace("https://","");g={host:b,method:"GET",path:g||"/",headers:{}};(b=this._getBasicAuthHeader())&&
(g.headers.Authorization=b);var f=this,e=a,c=d.request(g,function(a){a.setEncoding("utf-8");var c="";a.on("data",function(a){c+=a});a.on("end",function(){f._logger.log("trace","http reponse:"+c+" statusCode:"+a.statusCode);if(200!=a.statusCode)e&&e(Error("http response with code:"+a.statusCode),null);else try{var b=JSON.parse(c);b&&b.XC_SUC?e&&e(null,b.XC_SUC):b&&b.XC_ERR?e&&e(Error(b.XC_ERR.msg)):e&&e(Error("http reponse format valid"));e=null}catch(r){f._logger.log("trace","http reponse is not valid json:"+
r.message),e&&e(r,null),e=null}})});c.setTimeout(1E4,function(){f._logger.log("trace","http request timeout");c.abort();e&&e(Error("http timeout"));e=null});c.on("error",function(a){f._logger.log("trace","http request error:"+a.message);e&&e(a);e=null});c.end()},_getURL:function(){return this._url?this._url:m.CLOUD_URL},_getBasicAuthHeader:function(){return this._basicAuth?this._basicAuth:this._username?"Basic "+(new Buffer(this._username+":"+(this._password?this._password:""))).toString("base64"):
null},_getStates:function(g){this._sendRequest("/netatmo/getStates",g)},addEventListener:function(g,a){this._on[g]||(this._on[g]=[]);this._on[g].push(a)},setUrl:function(g){this._url=g},getDevices:function(g){this._sendRequest("/netatmo/getDevices",g)},getStates:function(g,a,d){this._getStates(function(b,f){if(b)d&&d(null);else if(a){b={};for(var e in f){var c=f[e];if(c)for(var n in c)if(a&&a.address==n){var h=c[n];if(h&&h.states){b=h.states;break}}}if(g)for(var t in b)g.setState(a.id+":"+t,b[t]);
d&&d(b)}else d&&d(f)})},removeEventListener:function(g,a){if(this._on[g])for(var d=0;d<this._on[g].length;d++)if(this._on[g][d]===a){this._on[g].splice(d,1);break}},startUpdating:function(g){if(!this._interval)if(APP.isInDemoMode)XC.debugf("[MNetatmo.startUpdating] Ignored. App is in demo mode.");else{var a=this;XC.debugf("[MNetatmo.startUpdating] Start.");this._doUpdate();this._interval=setInterval(function(){a._doUpdate()},this._updateInterval)}},stopUpdating:function(){clearInterval(this._interval);
XC.debugf("[MNetatmo.stopUpdating] Stop.")}};return m}();
xnm.aio.netatmo.Client=function(){var m=function(){var a=function(){this._homes={};this._weather={};this._thermo={};this._coach={};this._states={};this._smartThermoDuraion={}};a.prototype.getStates=function(){return this._states};a.prototype.areStatesExpired=function(){var a={weather:!1,thermo:!1,coach:!1,hasWeatherDevice:!1,hasThermoDevice:!1,hasCoachDevice:!1};this._homes.lastReqTime?this._homes.lastReqOk?(a.weather=this._homes.weather&&this._homes.weather.length?!0:!1,a.hasWeatherDevice=0<this._homes.weather.length,
a.thermo=this._homes.thermo&&this._homes.thermo.length?!0:!1,a.hasThermoDevice=0<this._homes.thermo.length,a.coach=this._homes.coach&&this._homes.coach.length?!0:!1,a.hasCoachDevice=0<this._homes.coach.length):300<Math.round((new Date).getTime()/1E3)-this._homes.lastReqTime&&(a.weather=!0,a.thermo=!0,a.coach=!0):(a.weather=!0,a.thermo=!0,a.coach=!0);a.weather&&(a.weather=this._isWeatherExpired());a.thermo&&(a.thermo=this._isThermoExpired());a.coach&&(a.coach=this._isCoachExpired());return a};a.prototype._isWeatherExpired=
function(){if(!this._weather.lastReqTime)return!0;var a=Math.round((new Date).getTime()/1E3);return this._weather.lastReqOk?this._weather.weatherTimeChanged?this._weather.expired:660<a-this._weather.lastReqTime?!0:!1:300<a-this._weather.lastReqTime?!0:!1};a.prototype._isThermoExpired=function(){if(!this._thermo.lastReqTime)return!0;var a=Math.round((new Date).getTime()/1E3);return this._thermo.lastReqOk?660<a-this._thermo.lastReqTime?!0:!1:300<a-this._thermo.lastReqTime?!0:!1};a.prototype._isCoachExpired=
function(){if(!this._coach.lastReqTime)return!0;var a=Math.round((new Date).getTime()/1E3);return this._coach.lastReqOk?this._coach.coachTimeChanged?this._coach.expired:660<a-this._coach.lastReqTime?!0:!1:300<a-this._coach.lastReqTime?!0:!1};a.prototype.updateReqTime=function(a,b){switch(a){case "weather":this._weather.lastReqTime=b;break;case "thermo":this._thermo.lastReqTime=b;break;case "cocah":this._cocah.lastReqTime=b;break;case "homes":this._homes.lastReqTime=b}};a.prototype.updateReqOK=function(a,
b){switch(a){case "weather":this._weather.lastReqOk=b;break;case "thermo":this._thermo.lastReqOk=b;break;case "cocah":this._cocah.lastReqOk=b;break;case "homes":this._homes.lastReqOk=b}};a.prototype.updateHomesInfo=function(a,b){if(a&&b){this._homes.weather=b.weather;this._homes.thermo=b.thermo;this._homes.coach=b.coach;for(var d in a)this._states[d]=a[d]}};a.prototype.updateWeatherStatus=function(a,b,f){if(a&&b&&f){var e=this._weather.weatherTime;this._weather.weatherTime=b;this._weather.weatherTimeChanged=
b!=e;this._weather.expired=660<f-b;if(!this._weather.expired){this._weather.expireTo&&clearTimeout(this._weather.expireTo);var c=this;this._weather.expireTo=setTimeout(function(){c._weather.expired=!0},1E3*(b+660-f))}for(var d in a)this._states[d]=a[d]}};a.prototype.updateThermoStatus=function(a){if(a)for(var b in a)this._states[b]=a[b]};a.prototype.updateCoachStatus=function(a,b,f){if(a&&b&&f){var e=this._coach.coachTime;this._coach.coachTime=b;this._coach.coachTimeChanged=b!=e;this._coach.expired=
660<f-b;if(!this._coach.expired){this._coach.expireTo&&clearTimeout(this._coach.expireTo);var c=this;this._coach.expireTo=setTimeout(function(){c._coach.expired=!0},1E3*(b+660-f))}for(var d in a)this._states[d]=a[d]}};a.prototype.thermoStatusChanged=function(){this._thermo.lastReqTime=null};a.prototype.setSmartThermoDuration=function(a,b){a&&a.module&&(this._smartThermoDuraion[a.module]=b)};a.prototype.getSmartThermoDuration=function(a){if(a&&a.module)return this._smartThermoDuraion[a.module]};return a}(),
g=function(a,d,b){this._logger=require("x.logger.js").getLogger("xnm.aio.netatmo.Client");this.username=a;this.password=d;this.refreshToken=b;this.accessToken=null;this._scope="read_station read_thermostat read_homecoach write_thermostat read_camera access_camera read_presence access_presence".split(" ");this._stateBuffer=new m;this._renewTokenCBs=[];this._getHomesInfoCBs=[];this._getWeatherStatusCBs=[];this._getThermoStatusCBs=[];this._getCoachStatusCBs=[]};g.prototype.toJSON=function(){return{sys:xnm.aio.netatmo.DM.SYS,
username:this.username,password:this.password,refreshToken:this.refreshToken}};g.prototype.equalsTo=function(a){return a&&a instanceof g?this.refreshToken&&this.refreshToken==a.refreshToken?!0:this.user==a.user&&this.password==a.password:!1};g.prototype.executeCommandCreator=function(a,d,b){d&&d.value?"NATherm1"==a.type?this._setSmartThermostat(a,d,function(a){b&&b(a)}):"home"==a.type?this._setHomeThermMode(a,d,function(a){b&&b(a)}):"room"==a.type?this._setRoomTherm(a,d,function(a){b&&b(a)}):b&&b(Error("device has no command")):
b&&b(Error("command format invalid"))};g.prototype.getStatesCreator=function(a,d,b){d?this.getAllStatus(function(a,e){for(var c=[],f=0;f<d.length;f++){var h=d[f];if(h.id){var g,r="?";!a&&e&&h.device&&h.device.type&&(g="NAMain"==h.device.type||"NHC"==h.device.type||"NAPlug"==h.device.type?h.device.address:"room"==h.device.type||"home"==h.device.type?h.device.address:h.device.module)&&h.status&&h.status.value&&(g=e[g])&&(r=g[h.status.value],null==r||"undefined"==typeof r)&&(r="?");c.push({id:h.id,status:r})}}b&&
b(null,c)}):b&&b(Error("deviceList is null"))};g.prototype._setHomeThermMode=function(a,d,b){if(a&&a.address&&"home"==a.type){var f=this;a=a.address;switch(d.value){case "thermoAuto":var e="schedule";break;case "thermoAway":e="away";break;case "thermoAwayUntil":if(!d.ext){b(Error("invalid command"));return}e="away";var c=parseInt(d.ext);break;case "thermoHg":e="hg";break;case "thermoHgUntil":if(!d.ext){b(Error("invalid command"));return}e="hg";c=parseInt(d.ext);break;default:b(Error("unknonw command"))}this._setThermMode(a,
e,c,null,function(a,c){a?b(a):(f._stateBuffer.thermoStatusChanged(),b())})}else b(Error("invalid device"))};g.prototype._setRoomTherm=function(a,d,b){if(a&&a.address&&a.homeId&&"room"==a.type){var f=this,e=a.homeId,c=a.address;switch(d.value){case "thermoAuto":var n="home";break;case "thermoManu":if(!d.ext){b(Error("invalid command"));return}n="manual";var h=parseFloat(d.ext);7>h&&(h=7);30<h&&(h=30);break;case "thermoManuUntil":if(!d.ext){b(Error("invalid command"));return}n="manual";for(a=0;a<d.ext.length;a++){var g=
d.ext[a];if(g)switch(g.value){case "temp":h=parseFloat(g.ext);break;case "endtime":var r=parseInt(g.ext)}}if(!h||!r){b(Error("invalid command"));return}7>h&&(h=7);30<h&&(h=30);break;case "thermoUp":case "thermoDown":this.getAllStatus(function(a,g){a?b(a):(a=g?g[c]:null)?(r=a.tempEnd,h=parseFloat(a.manuT),isNaN(h)?b(Error("unknown current room setpoint")):(h="thermoUp"==d.value?h+.5:h-.5,7>h&&(h=7),30<h&&(h=30),n="manual",f._setRoomThermPoint(e,c,n,h,r,function(a,c){a?b(a):(f._stateBuffer.thermoStatusChanged(),
b())}))):b(Error("unknown current room status"))});return;default:b(Error("unknonw command"))}this._setRoomThermPoint(e,c,n,h,r,function(a,c){a?b(a):(f._stateBuffer.thermoStatusChanged(),b())})}else b(Error("invalid device"))};g.prototype._setSmartThermostat=function(a,d,b){var f=this,e=this._stateBuffer.getSmartThermoDuration(a);e||(e=60);var c={};switch(d.value){case "thermoAuto":c.setpoint_mode="program";break;case "thermoAway":c.setpoint_mode="away";break;case "thermoHg":c.setpoint_mode="hg";
break;case "thermoOff":c.setpoint_mode="off";break;case "thermoMax":c.setpoint_mode="max";c.setpoint_endtime=Math.round(((new Date).getTime()+6E4*e)/1E3);break;case "thermoManu":if(null==d.ext||"undefined"==typeof d.ext){b&&b(Error("command ext invalid"));return}var n=d.ext;"string"==typeof d.ext&&(n=parseFloat(d.ext));5.5>n&&(n=5.5);30<n&&(n=30);c.setpoint_mode="manual";c.setpoint_endtime=Math.round(((new Date).getTime()+6E4*e)/1E3);c.setpoint_temp=n;break;case "tempDuration":if(null==d.ext||"undefined"==
typeof d.ext){b&&b(Error("command ext invalid"));return}e=d.ext;"string"==typeof d.ext&&(e=parseFloat(d.ext));15>e&&(e=15);720<e&&(e=720);this._stateBuffer.setSmartThermoDuration(a,e);b&&b();return;default:b&&b(Error("unknow command"))}a&&a.address&&a.module?c&&c.setpoint_mode?"max"!=c.setpoint_mode||c.setpoint_endtime?"manual"!=c.setpoint_mode||c.setpoint_endtime&&c.setpoint_temp?this._setThermPoint(a.address,a.module,c.setpoint_mode,c.setpoint_endtime,c.setpoint_temp,function(a,c){a?b&&b(a):(f._stateBuffer.thermoStatusChanged(),
b&&b(null,c))}):b&&b(Error("param format invalid")):b&&b(Error("param format invalid")):b&&b(Error("param format invalid")):b&&b(Error("device format invalid"))};g.prototype.auth=function(a){this._logger.log("debug","auth");this.username&&this.password?this._auth(function(d,b){a&&a(d,b)}):this.refreshToken?this._refreshToken(function(d,b){a&&a(d,b)}):a&&a(Error(""))};g.prototype.getDeviceList=function(a){this._getHomesData(null,null,function(d,b){if(d)a&&a(d);else if(b&&b.length){var f=[];b.forEach(function(a){if(a&&
a.modules&&a.modules.length){var c={};a.rooms&&a.rooms.forEach(function(a){c[a.id]={name:a.name,hasThermo:!1}});var b=!1;a.modules.forEach(function(d){if(d&&d.id&&d.type)switch(d.type){case "NAMain":var e={address:d.id,type:d.type,name:d.name?d.name:null,room:null,home:a.name};d.room_id&&c[d.room_id]&&(e.room=c[d.room_id].name);f.push(e);break;case "NAModule1":case "NAModule2":case "NAModule3":case "NAModule4":e={module:d.id,address:d.bridge,type:d.type,name:d.name?d.name:null,room:null,home:a.name};
d.room_id&&c[d.room_id]&&(e.room=c[d.room_id].name);f.push(e);break;case "NAPlug":b=!0;e={address:d.id,type:d.type,name:d.name?d.name:null,room:null,home:a.name};d.room_id&&c[d.room_id]&&(e.room=c[d.room_id].name,c[d.room_id].hasThermo=!0);f.push(e);break;case "NATherm1":case "NRV":b=!0;e={address:d.bridge,module:d.id,type:d.type,name:d.name?d.name:null,room:null,home:a.name};d.room_id&&c[d.room_id]&&(e.room=c[d.room_id].name,c[d.room_id].hasThermo=!0);f.push(e);break;case "NHC":e={address:d.id,type:d.type,
name:d.name?d.name:a.name,room:null,home:a.name},d.room_id&&c[d.room_id]&&(e.room=c[d.room_id].name),f.push(e)}});for(var d in c){var e=c[d];e.hasThermo&&f.push({address:d,type:"room",name:e.name,home:a.name,homeId:a.id})}b&&f.push({address:a.id,type:"home",name:a.name})}});a&&a(null,f)}else a&&a(null,[])})};g.prototype.getCamList=function(a){var d=this;this._getHomeData(null,null,function(b,f){if(b)a&&a(b);else{b={cam:[]};if(f){for(var e=[],c=0;c<f.length;c++)if(f[c]&&f[c].id){var n=f[c].name,h=
f[c].cameras;if(h)for(var g=0;g<h.length;g++)if(h[g]&&h[g].id){var r="welcome";"NACamera"==h[g].type?r="welcome":"NOC"==h[g].type&&(r="presence");r&&(r={sys:"cam",type:"system",manufacturer:"netatmo",model:r,address:h[g].id},h[g].name&&(r.name=h[g].name+(n?" ("+n+")":"")),e.push(r))}}b.cam=e}if(b.cam&&0<b.cam.length)for(f=0;f<b.cam.length;f++)b.cam[f].refreshToken=d.refreshToken;a&&a(null,b)}})};g.prototype.getCamUrl=function(a,d){var b=this;this._getHomeData(null,null,function(f,e){if(f)d&&d(f);
else if(e){for(f=0;f<e.length;f++)if(e[f]&&e[f].cameras){for(var c=e[f].cameras,n=0;n<c.length;n++)if(c[n]&&c[n].id==a&&c[n].vpn_url){var h=c[n];break}if(h)break}h?1==h.is_local?b._getLocalCamUrl(h.vpn_url,function(a,c){d&&d(a,c)}):d&&d(null,h.vpn_url+"/live/index.m3u8"):d&&d("no cam with address:"+a)}else d&&d("get cams data reponse invalid")})};g.prototype._getLocalCamUrl=function(a,d){var b=this;this._logger.log("trace","ping cam "+a);this._doUrlRequest("get",a+"/command/ping",null,function(f,
e){!f&&e&&e.local_url?b._doUrlRequest("get",e.local_url+"/command/ping",null,function(c,b){c||!b||b.local_url!=e.local_url?d&&d(null,a+"/live/index.m3u8"):d&&d(null,b.local_url+"/live/index.m3u8")}):d&&d(null,a+"/live/index.m3u8")})};g.prototype.getAllStatus=function(a){var d=this,b=this._stateBuffer.areStatesExpired();b.weather||b.thermo||b.coach?this._getAllStatus(b,function(b){b?a&&a(b):a&&a(null,d._stateBuffer.getStates())}):a&&a(null,this._stateBuffer.getStates())};g.prototype._getAllStatus=
function(a,d){var b=this,f=function(a,c){a&&a.weather?b._getWeatherStatus(c):c()},e=function(a,c){a&&a.thermo?b._getThermoStatus(a.home,c):c()},c=function(a,c){a&&a.coach?b._getHomeCoachStatus(c):c()};this._getHomesInfo(function(b,h,g){b?d(b):(a.weather&&!g.weather.length?a.weather=!1:a.weather||a.hasWeatherDevice||!g.weather.length||(a.weather=!0),a.thermo&&!g.thermo.length?a.thermo=!1:a.thermo||a.hasThermoDevice||!g.thermo.length||(a.thermo=!0),a.coach&&!g.coach.length?a.coach=!1:a.coach||a.hasCoachDevice||
!g.coach.length||(a.coach=!0),a.thermo&&(a.home=g.home),f(a,function(b){b?d(b):e(a,function(b){b?d(b):c(a,function(a){d(a)})})}))})};g.prototype._getHomesInfo=function(a){var d=this._getHomesInfoCBs.length;-1==this._getHomesInfoCBs.indexOf(a)&&this._getHomesInfoCBs.push(a);if(0==d){var b=this;this._stateBuffer.updateReqTime("homes",Math.round((new Date).getTime()/1E3));this._getHomesData(null,null,function(a,d,c){b._stateBuffer.updateReqOK("homes",a?!1:!0);c=b._getHomesInfoCBs;b._getHomesInfoCBs=
[];a&&c.forEach(function(c){try{c&&c(a)}catch(w){}});if(d&&d.length){var e=[],f=[],g=[],r=[],m={};d.forEach(function(a){if(a&&a.modules&&a.modules.length){a.modules.forEach(function(c){if(c&&c.id&&c.type)switch(c.type){case "NAMain":case "NAModule1":case "NAModule2":case "NAModule3":case "NAModule4":f.push(c.id);break;case "NATherm1":case "NAPlug":case "NRV":-1==e.indexOf(a.id)&&e.push(a.id);g.push(c.id);break;case "NHC":r.push(c.id)}});var c=b._resolveHomeStatus(a);if(c)for(var d in c)m[d]=c[d]}});
b._stateBuffer.updateHomesInfo(m,{weather:f,thermo:g,coach:r});c.forEach(function(a){try{a&&a(null,m,{weather:f,thermo:g,coach:r,home:e})}catch(w){}})}else b._stateBuffer.updateHomesInfo({},{}),c.forEach(function(a){try{a&&a(null,{})}catch(w){}})})}};g.prototype._resolveHomeStatus=function(a){if(!a)return null;var d={};d.mode=a.therm_mode;d.tempEnd=a.therm_mode_endtime;if(d.tempEnd)if(d.tempEndStr=(new Date(1E3*d.tempEnd)).toLocaleString(),"undefined"!=typeof dateFormat&&dateFormat)try{d.tempEndStr=
dateFormat(d.tempEndStr,"dd mm yyyy, HH:MM:ss")}catch(f){}else d.tempEndStr=d.tempEndStr.toLocaleString();var b={};b[a.id]=d;return b};g.prototype._getWeatherStatus=function(a){var d=this._getWeatherStatusCBs.length;-1==this._getWeatherStatusCBs.indexOf(a)&&this._getWeatherStatusCBs.push(a);if(0==d){var b=this;this._stateBuffer.updateReqTime("weather",Math.round((new Date).getTime()/1E3));this._getStationsData(null,!1,function(a,d,c){b._stateBuffer.updateReqOK("weather",a?!1:!0);var e=b._getWeatherStatusCBs;
b._getWeatherStatusCBs=[];if(a)e.forEach(function(b){try{b&&b(a,homes,c)}catch(u){}});else{var f=null,g={};d.devices&&d.devices.length&&d.devices.forEach(function(a){if(a&&"NAMain"==a.type&&(a.last_status_store&&(f=Math.max(a.last_status_store,f)),a=b._resolveWeatherStatus(a,d.user?d.user.administrative:null)))for(var c in a)g[c]=a[c]});f&&b._stateBuffer.updateWeatherStatus(g,f,c);e.forEach(function(a){try{a&&a(null,g)}catch(u){}})}})}};g.prototype._resolveWeatherStatus=function(a,d){if(!a||"NAMain"!=
a.type)return null;var b={};if(a._id){var f={};null!=a.wifi_status&&"undefined"!=typeof a.wifi_status&&(f.wifi=a.wifi_status,f.wifiStatus=86<=f.wifi?"bad":71<=f.wifi?"middle":56<=f.wifi?"good":"very_good");if(a.dashboard_data){var e=this._resolveDashboard(a.dashboard_data);if(e)for(var c in e)e.hasOwnProperty(c)&&(f[c]=e[c])}f.tempFelt=null;"undefined"!=typeof f.temp&&"undefined"!=typeof f.hum&&d&&(f.tempFelt=xnm.aio.netatmo.DM.calcFeltTemp(f.temp,f.hum,d));b[a._id]=f}var n=this;a.modules&&a.modules.forEach(function(a){var c=
n._resolveModuleStatus(a,d);a&&a._id&&c&&(b[a._id]=c)});return b};g.prototype._resolveModuleStatus=function(a,d){var b={};null!=a.rf_status&&"undefined"!=typeof a.rf_status&&(b.rf=a.rf_status,b.rfStatus=90<=b.rf?"very_low":80<=b.rf?"low":70<=b.rf?"medium":60<=b.rf?"high":"full");if(null!=a.battery_vp&&"undefined"!=typeof a.battery_vp)switch(b.bat=a.battery_vp,a.type){case "NAModule4":b.batStatus=5640<=b.bat?"full":5280<=b.bat?"high":4920<=b.bat?"medium":4560<=b.bat?"low":"very_low";break;case "NAModule1":case "NAModule3":b.batStatus=
5500<=b.bat?"full":5E3<=b.bat?"high":4500<=b.bat?"medium":4E3<=b.bat?"low":"very_low";break;case "NAModule2":b.batStatus=5900<=b.bat?"full":5180<=b.bat?"high":4770<=b.bat?"medium":4360<=b.bat?"low":"very_low";break;case "NATherm1":b.batStatus=4100<=b.bat?"full":3600<=b.bat?"high":3300<=b.bat?"medium":3E3<=b.bat?"low":"very_low"}var f,e;if("NATherm1"==a.type&&(f=this._resolveThermoStat(a)))for(e in f)f.hasOwnProperty(e)&&(b[e]=f[e]);if(a.dashboard_data){if(f=this._resolveDashboard(a.dashboard_data))for(e in f)f.hasOwnProperty(e)&&
(b[e]=f[e]);"undefined"!=typeof b.winD&&null!=b.winD&&(a=Number(b.winD),isNaN(a)||(b.winDName=23<a&&68>=a?"NO":68<a&&113>=a?"O":113<a&&158>=a?"SO":158<a&&203>=a?"S":203<a&&248>=a?"SW":248<a&&293>=a?"W":293<a&&338>=a?"NW":"N"));"undefined"!=typeof b.temp&&"undefined"!=typeof b.hum&&d&&(b.tempFelt=xnm.aio.netatmo.DM.calcFeltTemp(b.temp,b.hum,d))}return b};g.prototype._resolveDashboard=function(a){var d=function(a,c){return null!=a[c]&&"undefined"!=typeof a[c]},b={};d(a,"AbsolutePressure")&&(b.absPres=
a.AbsolutePressure);d(a,"CO2")&&(b.co2=a.CO2);d(a,"Humidity")&&(b.hum=a.Humidity);d(a,"Noise")&&(b.noise=a.Noise);d(a,"Pressure")&&(b.pres=a.Pressure);d(a,"Rain")&&(b.rain=a.Rain);d(a,"sum_rain_1")&&(b.rain1h=a.sum_rain_1);d(a,"sum_rain_24")&&(b.rain24h=a.sum_rain_24);d(a,"Temperature")&&(b.temp=a.Temperature);if(d(a,"date_max_temp")){b.timeMaxTemp=a.date_max_temp;var f=1E3*a.date_max_temp;b.timeMaxTempStr=new Date(f);b.timeMaxTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(b.timeMaxTempStr,
"dd mm yyyy, HH:MM:ss"):b.timeMaxTempStr.toLocaleString()}d(a,"date_min_temp")&&(b.timeMinTemp=a.date_min_temp,f=1E3*a.date_min_temp,b.timeMinTempStr=new Date(f),b.timeMinTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(b.timeMinTempStr,"dd.mm.yyyy, HH:MM:ss"):b.timeMinTempStr.toLocaleString());d(a,"max_temp")&&(b.maxTemp=a.max_temp);d(a,"min_temp")&&(b.minTemp=a.min_temp);d(a,"WindAngle")&&(b.winD=a.WindAngle);d(a,"WindStrength")&&(b.winS=a.WindStrength);d(a,"GustAngle")&&(b.gwinD=a.GustAngle);
d(a,"GustStrength")&&(b.gwinS=a.GustStrength);d(a,"time_utc")&&(b.mesureT=a.time_utc,f=1E3*a.time_utc,b.mesureTStr=new Date(f),b.mesureTStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(b.mesureTStr,"dd.mm.yyyy, HH:MM:ss"):b.mesureTStr.toLocaleString());d(a,"date_max_wind_str")&&(b.timeMaxWind=a.date_max_wind_str,f=1E3*a.date_max_wind_str,b.timeMaxWindStr=new Date(f),b.timeMaxWindStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(b.timeMaxWindStr,"dd.mm.yyyy, HH:MM:ss"):b.timeMaxWindStr.toLocaleString());
d(a,"max_wind_angle")&&(b.maxWinD=a.max_wind_angle);d(a,"max_wind_str")&&(b.maxWinS=a.max_wind_str);d(a,"temp_trend")&&(b.tempTrend=a.temp_trend);d(a,"pressure_trend")&&(b.presTrend=a.pressure_trend);if(d(a,"health_idx"))switch(b.healthIdxLvl=a.health_idx,parseInt(b.healthIdx)){case 0:b.healthIdx="healthy";break;case 1:b.healthIdx="fine";break;case 2:b.healthIdx="fair";break;case 3:b.healthIdx="poor";break;case 4:b.healthIdx="unhealthy"}return b};g.prototype._getThermoStatus=function(a,d){if(a&&a.length){var b=
this._getThermoStatusCBs.length;-1==this._getThermoStatusCBs.indexOf(d)&&this._getThermoStatusCBs.push(d);if(0==b){var f=this;this._stateBuffer.updateReqTime("thermo",Math.round((new Date).getTime()/1E3));var e=0,c={},n=function(b,d){var h=f._getThermoStatusCBs;b?(f._stateBuffer.updateReqOK("thermo",!1),f._getThermoStatusCBs=[],h.forEach(function(a){try{a&&a(b)}catch(y){}})):(d&&(d.modules&&d.modules.forEach(function(a){if(a&&a.id){var b=f._resolveThermoModuleStatus(a);b&&(c[a.id]=b)}}),d.rooms&&
d.rooms.forEach(function(a){if(a&&a.id){var b=f._resolveThermoRoomStatus(a);b&&(c[a.id]=b)}})),e++,e<a.length?f._getHomeStatus(a[e],null,n):(f._stateBuffer.updateReqOK("thermo",!0),f._stateBuffer.updateThermoStatus(c),f._getThermoStatusCBs=[],h.forEach(function(a){try{a&&a(null,c)}catch(y){}})))};this._getHomeStatus(a[e],null,n)}}else d(null,null)};g.prototype._resolveThermoModuleStatus=function(a){if(!a)return null;var d=function(a,b){return null!=a[b]&&"undefined"!=typeof a[b]},b={};d(a,"rf_strength")&&
(b.rf=a.rf_strength,b.rfStatus=90<b.rf?"very_low":80<b.rf?"low":70<b.rf?"medium":60<b.rf?"high":"full");d(a,"wifi_strength")&&(b.wifi=a.wifi_status,b.wifiStatus=86<=b.wifi?"bad":71<=b.wifi?"middle":56<=b.wifi?"good":"very_good");d(a,"battery_level")&&(b.bat=a.battery_level);d(a,"battery_state")&&(b.batStatus=a.battery_state);return b};g.prototype._resolveThermoRoomStatus=function(a){if(!a)return null;var d={};d.mode=a.therm_setpoint_mode;d.manuT=a.therm_setpoint_temperature;d.tempEnd=a.therm_setpoint_end_time;
if(d.tempEnd)if(d.tempEndStr=(new Date(1E3*d.tempEnd)).toLocaleString(),"undefined"!=typeof dateFormat&&dateFormat)try{d.tempEndStr=dateFormat(d.tempEndStr,"dd mm yyyy, HH:MM:ss")}catch(b){}else d.tempEndStr=d.tempEndStr.toLocaleString();d.currentTemp=a.therm_measured_temperature;return d};g.prototype._getHomeCoachStatus=function(a){var d=this._getCoachStatusCBs.length;-1==this._getCoachStatusCBs.indexOf(a)&&this._getCoachStatusCBs.push(a);if(0==d){var b=this;this._stateBuffer.updateReqTime("coach",
Math.round((new Date).getTime()/1E3));this._getHomeCoachsData(null,function(a,d,c){b._stateBuffer.updateReqOK("coach",a?!1:!0);var e=b._getCoachStatusCBs;b._getCoachStatusCBs=[];if(a)e.forEach(function(b){try{b&&b(a,d,c)}catch(u){}});else{var f=null,g={};d.devices&&d.devices.length&&d.devices.forEach(function(a){if(a&&"NHC"==a.type&&(a.last_status_store&&(f=Math.max(a.last_status_store,f)),a=b._resolveCoachStatus(a,d.user?d.user.administrative:null)))for(var c in a)g[c]=a[c]});f&&b._stateBuffer.updateCoachStatus(g,
f,c);e.forEach(function(a){try{a&&a(null,g)}catch(u){}})}})}};g.prototype._resolveCoachStatus=function(a,d){var b={};b.wifi=a.wifi_status;b.wifiStatus=86<=b.wifi?"bad":71<=b.wifi?"middle":56<=b.wifi?"good":"very_good";if(a.dashboard_data){var f=this._resolveDashboard(a.dashboard_data);if(f)for(var e in f)f.hasOwnProperty(e)&&(b[e]=f[e])}b.tempFelt=null;"undefined"!=typeof b.temp&&"undefined"!=typeof b.hum&&d&&(b.tempFelt=xnm.aio.netatmo.DM.calcFeltTemp(b.temp,b.hum,d));d={};d[a._id]=b;return d};g.prototype._renewAccessToken=
function(a){var d=this._renewTokenCBs.length;a&&-1==this._renewTokenCBs.indexOf(a)&&this._renewTokenCBs.push(a);if(0==d){var b=this;a=function(a,d){var c=!1;!a&&d&&(d.access_token&&(b.accessToken=d.access_token,c=!0),d.refresh_token&&(b.refreshToken=d.refresh_token));a||c||(a=Error("invalid token response"));d=b._renewTokenCBs;b._renewTokenCBs=null;for(c=0;c<d.length;c++)try{d[c](a)}catch(n){}};this.refreshToken?this._refreshToken(a):this.username&&this.password?this._auth(a):a(Error("no refresh token or username/password"))}};
g.prototype._auth=function(a){this._logger.log("trace","_auth");var d={grant_type:"password",client_id:"564b2c5245a1e3173cb21d3b",client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",username:this.username,password:this.password,scope:this._scope.join(" ")},b=[],f;for(f in d)b.push(f+"="+encodeURIComponent(d[f]));d=b.join("&");this._doRequest("POST","/oauth2/token",{"Content-Type":"application/x-www-form-urlencoded"},d,function(b,c,d){if(b)a(b);else if(c)try{var e=JSON.parse(c);200!=d?(b=Error(e.error),
a(b)):a(null,e)}catch(t){a(t)}else a(Error("invalid response"))})};g.prototype._refreshToken=function(a){this._logger.log("trace","_refreshToken");var d={grant_type:"refresh_token",client_id:"564b2c5245a1e3173cb21d3b",client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",refresh_token:this.refreshToken},b=[],f;for(f in d)b.push(f+"="+encodeURIComponent(d[f]));d=b.join("&");this._doRequest("POST","/oauth2/token",{"Content-Type":"application/x-www-form-urlencoded"},d,function(b,c,d){if(b)a(b);
else if(c)try{var e=JSON.parse(c);200!=d?(b=Error(e.error),a(b)):a(null,e)}catch(t){a(t)}else a(Error("invalid response"))})};g.prototype._getStationsData=function(a,d,b){this._logger.log("debug","_getStationsData");var f="/api/getstationsdata",e=[];a&&e.push("device_id="+a);d&&e.push("get_favorites="+get_favorites);e.length&&(f+="?"+e.join("&"));this._doAPIRequest("GET",f,null,function(a,d){a?b(a):d&&d.body?b(null,d.body,d.time_server):b(Error("invalid get stations data response"))})};g.prototype._getHomesData=
function(a,d,b){this._logger.log("debug","_getHomesData");var f="/api/homesdata",e=[];a&&e.push("home_id="+a);d&&e.push("gateway_types="+d);e.length&&(f+="?"+e.join("&"));this._doAPIRequest("GET",f,null,function(a,d){a?b(a):d&&d.body&&d.body.homes?b(null,d.body.homes,d.time_server):b(Error("invalid get homes data response"))})};g.prototype._getHomeStatus=function(a,d,b){this._logger.log("debug","_getHomeStatus");var f="/api/homestatus",e=[];a&&e.push("home_id="+a);d&&d.length&&d.forEach(function(a){e.push("device_types="+
a)});e.length&&(f+="?"+e.join("&"));this._doAPIRequest("GET",f,null,function(a,d){a?b(a):d&&d.body&&d.body.home?b(null,d.body.home,d.time_server):b(Error("invalid get home status response"))})};g.prototype._getHomeCoachsData=function(a,d){this._logger.log("debug","_getHomeCoachsData");var b="/api/gethomecoachsdata",f=[];a&&f.push("device_id="+a);f.length&&(b+="?"+f.join("&"));this._doAPIRequest("GET",b,null,function(a,c){a?d(a):c&&c.body?d(null,c.body,c.time_server):d(Error("invalid get stations data response"))})};
g.prototype._setThermPoint=function(a,d,b,f,e,c){var g="/api/setthermpoint",h=[];a&&h.push("device_id="+a);d&&h.push("module_id="+d);b&&h.push("setpoint_mode="+b);f&&h.push("setpoint_endtime="+f);e&&h.push("setpoint_temp="+e);h.length&&(g+="?"+h.join("&"));this._doAPIRequest("GET",g,null,c)};g.prototype._setThermMode=function(a,d,b,f,e){this._logger.log("debug","_setThermMode");var c="/api/setthermmode",g=[];a&&g.push("home_id="+a);d&&g.push("mode="+d);b&&g.push("endtime="+b);f&&g.push("schedule_id="+
f);g.length&&(c+="?"+g.join("&"));this._doAPIRequest("GET",c,null,function(a,c){e(a)})};g.prototype._setRoomThermPoint=function(a,d,b,f,e,c){this._logger.log("debug","_setRoomThermPoint");var g="/api/setroomthermpoint",h=[];a&&h.push("home_id="+a);d&&h.push("room_id="+d);b&&h.push("mode="+b);f&&h.push("temp="+f);e&&h.push("endtime="+e);h.length&&(g+="?"+h.join("&"));this._doAPIRequest("GET",g,null,function(a,b){c(a)})};g.prototype._getHomeData=function(a,d,b){this._logger.log("debug","_getHomeData");
var f="/api/gethomedata",e=[];a&&e.push("home_id="+a);d&&e.push("size="+d);e.length&&(f+="?"+e.join("&"));this._doAPIRequest("GET",f,null,function(a,d){a?b(a):d&&d.body&&d.body.homes?b(null,d.body.homes,d.time_server):b(Error("invalid get homes data response"))})};g.prototype._doAPIRequest=function(a,d,b,f){var e=this;this.accessToken?this._doJsonRequest(a,d,b,function(c,g){c&&2==c.code&&401==c.status?e._renewAccessToken(function(c){c?f(c):e._doJsonRequest(a,d,b,function(a,c){f(a,c)})}):f(c,g)}):
this._renewAccessToken(function(c){c?f(c):e._doJsonRequest(a,d,b,function(a,c){f(a,c)})})};g.prototype._doJsonRequest=function(a,d,b,f){this._doRequest(a,d,{Authorization:"Bearer "+this.accessToken},b?JSON.stringify(b):null,function(a,c,b){if(a)f(a);else if(c)try{var d=JSON.parse(c);if(200!=b){var e=d.error?d.error.code?d.error.code:0:0;a=Error(d.error?d.error.message?d.error.message:"invalid error response":"invalid error response");a.code=e;a.status=b;f(a)}else f(null,d)}catch(r){f(r)}else f(Error("invalid response"))})};
g.prototype._doRequest=function(a,d,b,f,e){a={host:"api.netatmo.net",port:443,path:d,method:a,headers:{Connection:"close","Content-Type":"application/json; charset=UTF-8"}};if(b)for(var c in b)a.headers[c]=b[c];b=require("https");c=JSON.parse(JSON.stringify(a));c.headers&&(c.headers.auth&&(c.headers.auth="*********"),c.headers.Authorization&&(c.headers.Authorization="*********"));c.auth&&(c.auth="********");this._logger.log("trace","do request:"+JSON.stringify(c));var g=this,h=e,m=b.request(a,function(a){a.setEncoding("utf-8");
var c="";a.on("data",function(a){c+=a});a.on("end",function(){g._logger.log("trace","receive code:"+a.statusCode+" headers:"+JSON.stringify(a.headers)+" response:"+c);h&&(h(null,c,a.statusCode),h=null)})});if(m.on)m.on("error",function(a){g._logger.log("trace","do request error:"+a.message);h&&(h(a),h=null)});m.setTimeout&&m.setTimeout(2E3,function(){g._logger.log("trace","do request timeout");m.abort();h&&(h(Error("timeout")),h=null)});f&&(this._logger.log("trace","send body:"+f),m.write(f));m.end()};
g.prototype._doUrlRequest=function(a,d,b,f){var e=this,c=f,g=null;try{g=JSON.parse(JSON.stringify(b)),g.username&&(g.username="xxxxxx"),g.password&&(g.password="xxxxxx")}catch(h){g=b}this._logger.log("trace","send "+a+" req to:"+d+" data:"+JSON.stringify(g));$.ajax({url:d,type:a,timeout:1E4,dataType:"json",data:b,cache:!1,success:function(a){e._logger.log("trace","http request success:"+JSON.stringify(a));f&&f(null,a)},error:function(a,b,d){b="http request error:"+(a?a.status:"0")+"-"+b;e._logger.log("warn",
"http request error:"+b);b=Error(b);d&&(e._logger.log("warn","http request http error:"+d),b.httpError=!0,b.statusCode=a?a.status:0);c&&(c(b,a?a.responseText:null),c=null)}})};return g}();
xnm.aio.netatmo.DM=function(){var m=function(a,c){this.code=a;this.message=c;this.stack=Error().stack};m.prototype=Error();m.prototype.name="NetatmoDmError";m.prototype.code=0;m.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var g=m.ERROR_CODE,a=[{type:"float",name:"absolute pressure",ref:{value:"absPres",value_t:"pressureAbsolute"}},{type:"int",name:"co2",ref:{value:"co2"}},{type:"int",name:"humidity",ref:{value:"hum"}},{type:"int",name:"noise",ref:{value:"noise"}},
{type:"float",name:"pressure",ref:{value:"pres",value_t:"pressure"}},{type:"float",name:"rain",ref:{value:"rain"}},{type:"float",name:"rain last hour",ref:{value:"rain1h"}},{type:"float",name:"rain today",ref:{value:"rain24h"}},{type:"float",name:"temperature",ref:{value:"temp"}},{type:"int",name:"time max temperatue",ref:{value:"timeMaxTemp"}},{type:"int",name:"time min temperatue",ref:{value:"timeMinTemp"}},{type:"float",name:"max temperatue",ref:{value:"maxTemp"}},{type:"float",name:"min temperatue",
ref:{value:"minTemp"}},{type:"int",name:"wind direction",ref:{value:"winD"}},{type:"float",name:"wind speed",ref:{value:"winS"}},{type:"int",name:"gust wind direction",ref:{value:"gwinD"}},{type:"float",name:"gust wind speed",ref:{value:"gwinS"}},{type:"int",name:"last measure time",ref:{value:"mesureT",value_t:"lastMeasureTime"}},{type:"int",name:"time max wind",ref:{value:"timeMaxWind"}},{type:"int",name:"max wind direction",ref:{value:"maxWinD"}},{type:"float",name:"max wind speed",ref:{value:"maxWinS"}},
{type:"float",name:"rf level",ref:{value:"rf"}},{type:"enum",name:"rf status",ref:{value:"rfStatus",options:["very_low","low","medium","high","full"]}},{type:"float",name:"battery level",ref:{value:"bat",value_t:"battery_level",extMeta:"3000-6000"}},{type:"enum",name:"battery status",ref:{value:"batStatus",value_t:"battery_state",options:["very_low","low","medium","high","full"]}},{type:"float",name:"wifi level",ref:{value:"wifi"}},{type:"enum",name:"wifi status",ref:{value:"wifiStatus",options:["bad",
"middle","good","very_good"]}},{type:"enum",name:"mode",ref:{value:"mode",options:"auto away frost-guard manu off boost".split(" ")}},{type:"float",name:"manual temperature",ref:{value:"manuT",extMeta:"5.5-30",scale:"0.5"}},{type:"int",name:"manual/boost endtime",ref:{value:"tempEnd"}},{type:"float",name:"measured temperature",ref:{value:"currentTemp"}},{type:"int",name:"manual/boost duration",ref:{value:"tempDuration",extMeta:"15-720",scale:"15"}},{type:"string",name:"manual/boost endtime string",
ref:{value:"tempEndStr"}},{type:"string",name:"time string max temperatue",ref:{value:"timeMaxTempStr"}},{type:"string",name:"time string min temperatue",ref:{value:"timeMinTempStr"}},{type:"string",name:"last measure time string",ref:{value:"mesureTStr",value_t:"lastMeasureTimeStr"}},{type:"string",name:"time string max wind",ref:{value:"timeMaxWindStr"}},{type:"float",name:"felt temperature",ref:{value:"tempFelt"}},{type:"string",name:"wind direction named",ref:{value:"winDName",options:"N NO O SO S SW W NW".split(" ")}},
{type:"enum",name:"temperature trend",ref:{value:"tempTrend",options:["up","down","stable"]}},{type:"enum",name:"pressure trend",ref:{value:"presTrend",value_t:"pressureTrend",options:["up","down","stable"]}},{type:"enum",name:"health index",ref:{value:"healthIdx",options:["healthy","fine","fair","poor","unhealthy"]}},{type:"int",name:"health index level",ref:{value:"healthIdxLvl",extMeta:"0-4"}}],d=[{type:"enum",name:"auto",ref:{value:"thermoAuto"}},{type:"enum",name:"away",ref:{value:"thermoAway"}},
{type:"enum",name:"frost-guard",ref:{value:"thermoHg"}},{type:"enum",name:"off",ref:{value:"thermoOff"}},{type:"enum",name:"max",ref:{value:"thermoMax"}},{type:"float",name:"manu",ref:{value:"thermoManu",ext:"%f",extMeta:"5.5-30",scale:"0.5"}},{type:"enum",name:"up",ref:{value:"thermoUp"}},{type:"enum",name:"down",ref:{value:"thermoDown"}},{type:"int",name:"manual/boost duration",ref:{value:"tempDuration",ext:"%d",extMeta:"15-720",scale:"15"}}],b={command:[{type:"enum",name:"auto",ref:{value:"thermoAuto"}},
{type:"enum",name:"up",ref:{value:"thermoUp"}},{type:"enum",name:"down",ref:{value:"thermoDown"}},{type:"float",name:"manu",ref:{value:"thermoManu",ext:"%f",extMeta:"7-30",scale:"0.5"}},{type:"multi",name:"manu until",ref:{value:"thermoManuUntil",ext:"%multi",extMeta:[{type:"float",name:"temperature",ref:{value:"temp",ext:"%f",extMeta:"7-30",scale:"0.5"}},{type:"time",name:"end time",ref:{value:"endtime",ext:"%time"}}]}}],status:[{type:"enum",name:"mode",ref:{value:"mode",options:"manual max off schedule away hg".split(" ")}},
{type:"float",name:"setpoint temperature",ref:{value:"manuT",value_t:"setTemperature",extMeta:"7-30",scale:"0.5"}},{type:"int",name:"mode end time",ref:{value:"tempEnd"}},{type:"string",name:"mode end time string",ref:{value:"tempEndStr"}},{type:"float",name:"measured temperature",ref:{value:"currentTemp"}}]},f={command:[{type:"enum",name:"auto",ref:{value:"thermoAuto"}},{type:"enum",name:"away",ref:{value:"thermoAway"}},{type:"time",name:"away until",ref:{value:"thermoAwayUntil",ext:"%time"}},{type:"enum",
name:"frost-guard",ref:{value:"thermoHg"}},{type:"time",name:"frost-guard until",ref:{value:"thermoHgUntil",ext:"%time"}}],status:[{type:"enum",name:"mode",ref:{value:"mode",options:["schedule","away","frost_guard"]}},{type:"int",name:"mode end time",ref:{value:"tempEnd"}},{type:"string",name:"mode end time string",ref:{value:"tempEndStr"}}]};return{SYS:"netatmo",getGatewayType:function(){return[{sys:this.SYS,name:"Netatmo (Online)",port:443}]},getGatewayDeviceType:function(a){return[{sys:this.SYS,
type:"NAMain",name:"Base Station"},{sys:this.SYS,type:"NAModule1",name:"Outdoor module"},{sys:this.SYS,type:"NAModule4",name:"Additional indoor module"},{sys:this.SYS,type:"NAModule3",name:"Rain gauge module"},{sys:this.SYS,type:"NAModule2",name:"Wind gauge module"},{sys:this.SYS,type:"NATherm1",name:"Thermostat"},{sys:this.SYS,type:"NHC",name:"Home Coach"}]},_checkInfo:function(a,c,b){if(a)if(a.gateway)if(a.type)if(a.address)if(c.data&&c.data.gateways&&0!==c.data.gateways.length){c=c.data.gateways;
var d;for(d=0;d<c.length;d++)if(c[d].index===a.gateway){var e=c[d];break}e?b():b(new m(g.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else b(new m(g.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else b(new m(g.INVALID,"address is invalid"));else b(new m(g.INVALID,"type is invalid"));else b(new m(g.INVALID,"gateway is invalid"));else b(new m(g.INVALID,"info is invalid"))},createGateway:function(a,b,d){a?a.refreshToken||a.username&&a.password?d(null,a):d(new m(g.INVALID,"refreshToken is invalid")):
d(new m(g.INVALID,"info is invalid"))},updateGateway:function(a,b,d,f){b?b.refreshToken||b.username&&b.password?f(null,b):f(new m(g.INVALID,"refreshToken is invalid")):f(new m(g.INVALID,"info is invalid"))},deleteGateway:function(a,b,d){d()},createDevice:function(a,b,d){this._checkInfo(a,b,function(b){d(b,a)})},updateDevice:function(a,b,d){this._checkInfo(a,b,function(b){d(b,a)})},deleteDevice:function(a,b,d){d(null,a)},applyUIFilter:function(a,b){var c=function(a,b){if("*"==a)return!0;for(var c=
!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},d=function(a,b,d){var e=[];switch(d.catagory){case "command":a.command&&a.command.forEach(function(a){c(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){c(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},e=function(a,b){var c=[],e=this.getCommandStatusMap(a);e&&(a=d(e,a,b),c=c.concat(a));return c};if(!a.sys)return null;var f=JSON.parse(JSON.stringify(a)),
g=null;switch(b.catagory){case "command":g=e.call(this,a,b);f.command=g;break;case "status":g=e.call(this,a,b);f.status=g;break;default:return null}return g&&0!=g.length?f:null},applyIPEventFilter:function(a,b){if(!a.sys)return null;b=JSON.parse(JSON.stringify(a));a=this.getIPevtMap(a);if(!a)return b;b.ipevt=a.ipevt;return b},getCommandStatusMap:function(b){var c={command:[],status:[]};switch(b.type){case "NAMain":c.status.push(a[25]);c.status.push(a[26]);break;case "NAModule1":case "NAModule2":case "NAModule3":case "NAModule4":case "NATherm1":c.status.push(a[21]);
c.status.push(a[22]);c.status.push(a[23]);c.status.push(a[24]);"NATherm1"==b.type&&(c.status.push(a[27]),c.status.push(a[28]),c.status.push(a[29]),c.status.push(a[30]),c.status.push(a[31]),c.status.push(a[32]));break;case "NHC":c.status.push(a[25]),c.status.push(a[26])}"NATherm1"==b.type&&(c.command=d);if(b.dashboard_data)for(var e in b.dashboard_data)if(b.dashboard_data.hasOwnProperty(e))switch(e){case "AbsolutePressure":c.status.push(a[0]);break;case "CO2":c.status.push(a[1]);break;case "Humidity":c.status.push(a[2]);
c.status.push(a[37]);break;case "Noise":c.status.push(a[3]);break;case "Pressure":c.status.push(a[4]);break;case "Rain":c.status.push(a[5]);break;case "sum_rain_1":c.status.push(a[6]);break;case "sum_rain_24":c.status.push(a[7]);break;case "Temperature":c.status.push(a[8]);break;case "date_max_temp":c.status.push(a[9]);c.status.push(a[33]);break;case "date_min_temp":c.status.push(a[10]);c.status.push(a[34]);break;case "max_temp":c.status.push(a[11]);break;case "min_temp":c.status.push(a[12]);break;
case "WindAngle":c.status.push(a[13]);c.status.push(a[38]);break;case "WindStrength":c.status.push(a[14]);break;case "GustAngle":c.status.push(a[15]);break;case "GustStrength":c.status.push(a[16]);break;case "time_utc":c.status.push(a[17]);c.status.push(a[35]);break;case "date_max_wind_str":c.status.push(a[18]);c.status.push(a[36]);break;case "max_wind_angle":c.status.push(a[19]);break;case "max_wind_str":c.status.push(a[20]);break;case "temp_trend":c.status.push(a[39]);break;case "pressure_trend":c.status.push(a[40]);
break;case "health_idx":c.status.push(a[41]),c.status.push(a[42])}return c},getCommandStatusMap2:function(d){var c={command:[],status:[]},e=null;switch(d.type){case "NAMain":e="time_utc Temperature CO2 Humidity Noise Pressure AbsolutePressure min_temp max_temp date_min_temp date_max_temp temp_trend pressure_trend".split(" ");c.status.push(a[25]);c.status.push(a[26]);break;case "NAModule1":e="time_utc Temperature Humidity min_temp max_temp date_min_temp date_max_temp temp_trend".split(" ");c.status.push(a[21]);
c.status.push(a[22]);c.status.push(a[23]);c.status.push(a[24]);break;case "NAModule2":e="time_utc WindStrength WindAngle GustStrength GustAngle max_wind_str max_wind_angle date_max_wind_str".split(" ");c.status.push(a[21]);c.status.push(a[22]);c.status.push(a[23]);c.status.push(a[24]);break;case "NAModule3":e=["time_utc","Rain","sum_rain_24","sum_rain_1"];c.status.push(a[21]);c.status.push(a[22]);c.status.push(a[23]);c.status.push(a[24]);break;case "NAModule4":e="time_utc Temperature CO2 Humidity Pressure AbsolutePressure min_temp max_temp date_min_temp date_max_temp temp_trend".split(" ");
c.status.push(a[21]);c.status.push(a[22]);c.status.push(a[23]);c.status.push(a[24]);break;case "NATherm1":c.status.push(a[21]);c.status.push(a[22]);c.status.push(a[23]);c.status.push(a[24]);break;case "NRV":c.status.push(a[21]);c.status.push(a[22]);c.status.push(a[23]);c.status.push(a[24]);break;case "NAPlug":c.status.push(a[21]);c.status.push(a[22]);c.status.push(a[25]);c.status.push(a[26]);break;case "NHC":e="time_utc Temperature CO2 Humidity Noise Pressure AbsolutePressure health_idx min_temp max_temp date_min_temp date_max_temp".split(" ");
c.status.push(a[25]);c.status.push(a[26]);break;case "room":c=b;break;case "home":c=f}e&&e.forEach(function(b){switch(b){case "AbsolutePressure":c.status.push(a[0]);break;case "CO2":c.status.push(a[1]);break;case "Humidity":c.status.push(a[2]);c.status.push(a[37]);break;case "Noise":c.status.push(a[3]);break;case "Pressure":c.status.push(a[4]);break;case "Rain":c.status.push(a[5]);break;case "sum_rain_1":c.status.push(a[6]);break;case "sum_rain_24":c.status.push(a[7]);break;case "Temperature":c.status.push(a[8]);
break;case "date_max_temp":c.status.push(a[9]);c.status.push(a[33]);break;case "date_min_temp":c.status.push(a[10]);c.status.push(a[34]);break;case "max_temp":c.status.push(a[11]);break;case "min_temp":c.status.push(a[12]);break;case "WindAngle":c.status.push(a[13]);c.status.push(a[38]);break;case "WindStrength":c.status.push(a[14]);break;case "GustAngle":c.status.push(a[15]);break;case "GustStrength":c.status.push(a[16]);break;case "time_utc":c.status.push(a[17]);c.status.push(a[35]);break;case "date_max_wind_str":c.status.push(a[18]);
c.status.push(a[36]);break;case "max_wind_angle":c.status.push(a[19]);break;case "max_wind_str":c.status.push(a[20]);break;case "temp_trend":c.status.push(a[39]);break;case "pressure_trend":c.status.push(a[40]);break;case "health_idx":c.status.push(a[41]),c.status.push(a[42])}});return c},getIPevtMap:function(a){return(a=this.getCommandStatusMap(a))?{ipevt:a.status}:null},calcFeltTemp:function(a,b,d){if(d&&"object"==typeof d&&0===d.feel_like_algo)d=243.5,b=Math.log(.01*b)+17.67*a/(d+a),b=a+.5555*
(6.11*Math.exp(5417.753*(1/273.16-1/(d*b/(17.67-b)+273.15)))-10);else{d=[-42.379,2.04901523,10.14333127,-.22475541,-.00683783,-.05481717,.00122874,8.5282E-4,-1.99E-6];a=9*a/5+32;var c=a*a,e=b*b;b=d[0]+d[1]*a+d[2]*b+d[3]*a*b+d[4]*c+d[5]*e+d[6]*c*b+d[7]*a*e+d[8]*c*e;b=5*(b-32)/9}return Math.round(10*b)/10},supportSmartWidget:function(a){return a&&a.type?0<=["home","room"].indexOf(a.type):!1},applySmartWidgetFilter:function(a,b,d,f,g){if(!b||!b.type)return!1;d=[];if("home"===b.type){b={"%auto%":{value:"thermoAuto"},
"%away%":{value:"thermoAway"},"%awayUntil%":{value:"thermoAwayUntil",ext:"%time"},"%frostGuard%":{value:"thermoHg"},"%frostGuardUntil%":{value:"thermoHgUntil",ext:"%time"}};var c={"%mode%":{value:"mode",options:["schedule","away","frost_guard"]}};d.push("netatmo_thermo")}else if("room"===b.type)b={"%auto%":{value:"thermoAuto"},"%thermoUp%":{value:"thermoUp"},"%thermoDown%":{value:"thermoDown"},"%thermoManu%":{value:"thermoManu",ext:"%f",extMeta:"7-30",scale:.5}},c={"%mode%":{value:"mode",options:"manual max off schedule away hg".split(" ")},
"%setTemp%":{value:"manuT",extMeta:"7-30",scale:.5},"%currentTemp%":{value:"currentTemp"}},d.push("netatmo_thermo");else return!1;return a._injectToSmartWidgetTemplate(f,d,g,b,c)}}}();xnm.aio.netatmo.DM.getCommandStatusMap=xnm.aio.netatmo.DM.getCommandStatusMap2;xnm.aio.netatmo.Cloud=xnm.aio.netatmo.Client;
xnm.aio.netatmo.Handler=function(){var m=function(){this._updateListener=[]};m.prototype.Client=xnm.aio.netatmo.Client;m.prototype.Cloud=xnm.aio.netatmo.Cloud;m.prototype.MNetatmo=xnm.aio.netatmo.MNetatmo;m.prototype.devicemanager=xnm.aio.netatmo.DM;m.prototype.registModule=function(g){g.register(this.devicemanager.SYS,"netatmo")};m.prototype.resolveGateway=function(g){return g.refreshToken||g.username&&g.password?new xnm.aio.netatmo.Cloud(g.username,g.password,g.refreshToken):null};m.prototype.getDeviceCommands=
function(g,a){g=(g=xnm.aio.netatmo.DM.applyUIFilter(g,{catagory:"command",elems:"*"}))?g.command:[];a&&a(null,g)};m.prototype.getDeviceStatus=function(g,a){g=(g=xnm.aio.netatmo.DM.applyUIFilter(g,{catagory:"status",elems:"*"}))?g.status:[];a&&a(null,g)};m.prototype.login=function(g,a){(g=this.resolveGateway(g))?g.auth(function(d,b){d?a&&a(d):a&&a(d,{refreshToken:b.refresh_token})}):a&&a(Error("gateway json format invalid"))};m.prototype.doCommand=function(g,a,d,b){(g=this.resolveGateway(g))?g.executeCommandCreator(a,
d,function(a){b&&b(a)}):b&&b(Error("gateway json format invalid"))};m.prototype.doStatus=function(g,a,d,b,f){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:g,device:d,status:b}],function(a,b){a?f&&f(a):f&&f(null,b[0])}):f&&f(Error("gateway json format invalid"))};m.prototype.getDeviceList=function(g,a){(g=this.resolveGateway(g))?g.getDeviceList(a):a&&a(Error("gateway json format invalid"))};m.prototype.getCamList=function(g,a){(g=this.resolveGateway(g))?g.getCamList(a):a&&a(Error("gateway json format invalid"))};
m.prototype.pause=function(g){xnm.aio.netatmo.Cloud.pause(g)};m.prototype.addUpdateListener=function(g){g&&-1==this._updateListener.indexOf(g)&&this._updateListener.push(g)};m.prototype.getDevice=function(g){return new this.MNetatmo(g)};m.prototype.setMNetatmoCloudUrl=function(g){this.MNetatmo.CLOUD_URL=g};return m}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.netatmo.Handler);
