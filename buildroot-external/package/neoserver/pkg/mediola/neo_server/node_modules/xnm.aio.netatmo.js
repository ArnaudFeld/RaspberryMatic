var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.netatmo=xnm.aio.netatmo||{};
xnm.aio.netatmo.Cloud=function(){var m={},h={},a={},d={},b=function(a){return a.refreshToken?a.refreshToken:a.user?h[a.user]:null},g=function(a){var k=b(a);if(!k)return null;m[k]||(m[k]={cloud:a});return m[k].cred?m[k].cred:{refresh_token:k}},e=function(a,b){var k=b.refresh_token;a.refreshToken||(a.refreshToken=k);a.user&&(h[a.user]=k);m[k]||(m[k]={cloud:a});m[k].cred=b;b.expires_in&&(b._expireTime=(new Date).getTime()+1E3*b.expires_in-6E5)},c=function(a){return(a=g(a))&&a._expireTime?(new Date).getTime()>
a._expireTime:!1},n=function(a){var k=b(a);if(!k)return null;m[k]||(m[k]={cloud:a});m[k].weather||(m[k].weather={updateData:{running:!1,error:null}});return m[k].weather},f=function(a){a=n(a);a.timer&&clearTimeout(a.timer);a.updateData={running:!0,error:null}},t=function(a,c,d){var k=b(a),l=n(a);l.updateData={running:!1,error:c};try{if(!c&&d){var e=require("xnm.aio.netatmo.js")._updateListener;if(e&&0<e.length)for(var p=0;p<e.length;p++)e[p]&&e[p].updateWeather&&e[p].updateWeather(a,l.data,d)}}catch(x){}l.timer&&
clearTimeout(l.timer);e=r(a);c?l.data=null:d&&(l.data=d);d=l.tmpCBs;l.tmpCBs=[];if(d)for(p=0;p<d.length;p++)if(c)d[p](c);else a.getWeatherStatus(d[p]);c?l.timer=setTimeout(function(){m[k].cloud.getStationsData(null)},6E4):(a=r(a),e&&a&&e==a&&1>l.retry?(l.retry=l.retry?l.retry+1:1,c=60*l.retry,l.delay=c,l.timer=setTimeout(function(){m[k].cloud.getStationsData(null)},1E3*c)):(l.retry=0,(e=l.delay)||(e=0),c=6E5,a&&(d=Math.round((new Date).getTime()/1E3),d>a&&(c=600-(d-a)%600+30)),require("x.logger.js").getLogger("xnm.aio.netatmo.Cloud").log("debug",
"weather station next poll in t:"+c/60+" min delay:"+e),l.timer=setTimeout(function(){m[k].cloud.getStationsData(null)},1E3*c+1E3*e)))},r=function(a){a=n(a);if(!a.data)return 0;for(var b=0;b<a.data.length;b++)if(a.data[b]&&a.data[b].dashboard_data&&a.data[b].dashboard_data.time_utc)return a.data[b].dashboard_data.time_utc;return 0},u=function(a){var c=b(a);if(!c)return null;m[c]||(m[c]={cloud:a});m[c].homecoach||(m[c].homecoach={updateData:{running:!1,error:null}});return m[c].homecoach},y=function(a){a=
u(a);a.timer&&clearTimeout(a.timer);a.updateData={running:!0,error:null}},w=function(a,c,d){var k=b(a),e=u(a);e.updateData={running:!1,error:c};try{if(!c&&d){var l=require("xnm.aio.netatmo.js")._updateListener;if(l&&0<l.length)for(var p=0;p<l.length;p++)l[p]&&l[p].updateHomeCoach&&l[p].updateHomeCoach(a,e.data,d)}}catch(x){}e.timer&&clearTimeout(e.timer);l=A(a);c?e.data=null:d&&(e.data=d);d=e.tmpCBs;e.tmpCBs=[];if(d)for(p=0;p<d.length;p++)if(c)d[p](c);else a.getWeatherStatus(d[p]);c?e.timer=setTimeout(function(){m[k].cloud.getHomeCoachsData(null)},
6E4):(a=A(a),l&&a&&l==a&&1>e.retry?(e.retry=e.retry?e.retry+1:1,c=60*e.retry,e.delay=c,e.timer=setTimeout(function(){m[k].cloud.getHomeCoachsData(null)},1E3*c)):(e.retry=0,(l=e.delay)||(l=0),c=6E5,a&&(d=Math.round((new Date).getTime()/1E3),d>a&&(c=600-(d-a)%600+30)),e.timer=setTimeout(function(){m[k].cloud.getHomeCoachsData(null)},1E3*c+1E3*l)))},A=function(a){a=u(a);if(!a.data)return 0;for(var b=0;b<a.data.length;b++)if(a.data[b]&&a.data[b].dashboard_data&&a.data[b].dashboard_data.time_utc)return a.data[b].dashboard_data.time_utc;
return 0},v=function(a){var c=b(a);if(!c)return null;m[c]||(m[c]={cloud:a});m[c].thermo||(m[c].thermo={updateData:{running:!1,error:null}});return m[c].thermo},D=function(a){a=v(a);a.timer&&clearTimeout(a.timer);a.updateData={running:!0,error:null}},B=function(a,c,d){var k=b(a),e=v(a);try{if(!c&&d){var l=require("xnm.aio.netatmo.js")._updateListener;if(l&&0<l.length)for(var p=0;p<l.length;p++)l[p]&&l[p].updateThermo&&l[p].updateThermo(a,e.data,d)}}catch(x){}e.timer&&clearTimeout(e.timer);e.updateData=
{running:!1,error:c};c?e.data=null:d&&(e.data=d);d=e.tmpCBs;e.tmpCBs=[];if(d)for(l=0;l<d.length;l++)if(c)d[l](c);else a.getThermoStatus(d[l]);e.timer=c?setTimeout(function(){m[k].cloud.getThermostatsData(null)},6E4):setTimeout(function(){m[k].cloud.getThermostatsData(null)},18E5)},C=function(a,c){var d=b(a);if(!c.module)return 60;a=v(a);a.duration||(m[d].thermo.duration={});d=a.duration[c.module];if(!d){a:{if(c.module&&XC&&XC.localStorage){if(d=XC.localStorage.getItem("netatmo"))try{d=JSON.parse(d)}catch(z){}if(d&&
d.duration){d=d.duration[c.module];break a}}d=null}a.duration[c.module]=d}d||(d=60);return d},E=function(a,c,b){a=v(a);a.duration||(a.duration={});if(c.module&&(a.duration[c.module]=b,c.module&&XC&&XC.localStorage)){if(a=XC.localStorage.getItem("netatmo"))try{a=JSON.parse(a)}catch(z){}a&&"object"==typeof a||(a={});a.duration||(a.duration={});a.duration[c.module]=b;XC.localStorage.setItem("netatmo",JSON.stringify(a))}},F=function(a,c){a=v(a);if(a.data)for(var b=0;b<a.data.length;b++){var d=a.data[b];
if(d&&d._id==c.address&&d.modules)for(var e=0;e<d.modules.length;e++){var k=d.modules[e];if(k&&k._id==c.module)return k.setpoint}}return null},q=function(a,c,b){this._logger=require("x.logger.js").getLogger("xnm.aio.netatmo.Cloud");this.user=a;this.password=c;this.refreshToken=b;this._scope="read_station read_thermostat read_homecoach write_thermostat read_camera access_camera read_presence access_presence".split(" ");this._scopeFallback="read_station read_thermostat read_homecoach write_thermostat read_camera access_camera read_presence".split(" ")};
q.prototype.executeCommandCreator=function(a,c,b){if(c&&c.value){var d=this,e={},k=C(this,a);F(this,a);switch(c.value){case "thermoAuto":e.setpoint_mode="program";break;case "thermoAway":e.setpoint_mode="away";break;case "thermoHg":e.setpoint_mode="hg";break;case "thermoOff":e.setpoint_mode="off";break;case "thermoMax":e.setpoint_mode="max";e.setpoint_endtime=Math.round(((new Date).getTime()+6E4*k)/1E3);break;case "thermoManu":if(null==c.ext||"undefined"==typeof c.ext){b&&b(Error("command ext invalid"));
return}var l=c.ext;"string"==typeof c.ext&&(l=parseFloat(c.ext));5.5>l&&(l=5.5);30<l&&(l=30);e.setpoint_mode="manual";e.setpoint_endtime=Math.round(((new Date).getTime()+6E4*k)/1E3);e.setpoint_temp=l;break;case "tempDuration":if(null==c.ext||"undefined"==typeof c.ext){b&&b(Error("command ext invalid"));return}k=c.ext;"string"==typeof c.ext&&(k=parseFloat(c.ext));15>k&&(k=15);720<k&&(k=720);E(this,a,k);b&&b();return;default:b&&b(Error("unknow command"))}this.setThermPoint(a,e,function(c){if(c)b&&b(c);
else{c=v(d);c.data||(c.data=[]);var k;for(k=0;k<c.data.length;k++)if(c.data[k]&&c.data[k]._id==a.address){var l=c.data[k];break}l||(l={_id:a.address,modules:[]},c.data.push(l));for(k=0;k<l.modules.length;k++)if(l.modules[k]&&l.modules[k]._id==a.module){var p=l.modules[k];break}p||(p={_id:a.module},l.modules.push(p));p.setpoint=e;b&&b()}})}else b&&b(Error("command format invalid"))};q.prototype.getStatesCreator=function(c,b,e){b?this.getAllStatus(function(c,k){for(var l=[],p=0;p<b.length;p++){var n=
b[p];if(n.id){var g,f="?";if(!c&&k&&n.device&&n.device.type&&(g="NAMain"==n.device.type||"NHC"==n.device.type?n.device.address:n.device.address+"|"+n.device.module)&&n.status&&n.status.value&&(g=k[g]))if("tempFelt"==n.status.value)f=g.temp,g=g.hum,f="undefined"!=typeof f&&"undefined"!=typeof g?"NHC"==n.device.type?xnm.aio.netatmo.DM.calcFeltTemp(f,g,d):xnm.aio.netatmo.DM.calcFeltTemp(f,g,a):"?";else if("winDName"==n.status.value)f=g.winD,null===f||"undefined"==typeof f?f="?":(f=Number(f),f=isNaN(f)?
"?":23<f&&68>=f?"NO":68<f&&113>=f?"O":113<f&&158>=f?"SO":158<f&&203>=f?"S":203<f&&248>=f?"SW":248<f&&293>=f?"W":293<f&&338>=f?"NW":"N");else if(f=g[n.status.value],null==f||"undefined"==typeof f)f="?";l.push({id:n.id,status:f})}}e&&e(null,l)}):e&&e(Error("deviceList is null"))};q.prototype.getAllStatus=function(a){var c=this,b={};this.getWeatherStatus(function(d,e){d?a&&a(d):c.getThermoStatus(function(d,k){d?a&&a(d):c.getHomeCoachStatus(function(c,d){if(c)a&&a(c);else{for(var l in e)e.hasOwnProperty(l)&&
(b[l]=e[l]);for(l in k)k.hasOwnProperty(l)&&(b[l]=k[l]);for(l in d)d.hasOwnProperty(l)&&(b[l]=d[l]);a&&a(null,b)}})})})};q.prototype.getDeviceList=function(a){var c=this;this.getStationsData(function(b,d){b?a&&a(b):c.getThermostatsData(function(b,e){b?a&&a(b):c.getHomeCoachsData(function(c,b){if(c)a&&a(c);else{c={weather:[],thermostat:[]};if(d){for(var k=[],l=0;l<d.length;l++){var f=d[l];if(f&&f._id&&f.type){var n=f.station_name,g=f.module_name,p={address:f._id,type:f.type,name:n+" ("+g+")"};p.dashboard_data=
f.dashboard_data;p.modules=[];if(f.modules)for(var h=0;h<f.modules.length;h++)f.modules[h]&&f.modules[h]._id&&f.modules[h].type&&(g=f.modules[h].module_name,p.modules.push({address:f._id,module:f.modules[h]._id,type:f.modules[h].type,name:n+" ("+g+")",dashboard_data:f.modules[h].dashboard_data}));k.push(p)}}c.weather=k}if(e){k=[];for(l=0;l<e.length;l++)if((f=e[l])&&f._id&&f.type&&(n=f.station_name,f.modules))for(p=0;p<f.modules.length;p++)f.modules[p]&&f.modules[p]._id&&f.modules[p].type&&(g=f.modules[p].module_name,
k.push({address:f._id,module:f.modules[p]._id,type:f.modules[p].type,name:n+" ("+g+")"}));c.thermostat=k}if(b){k=[];for(l=0;l<b.length;l++)(f=b[l])&&f._id&&f.type&&(n=f.module_name,g={address:f._id,type:f.type,name:f.name},n&&(g.name+=" ("+n+")"),g.dashboard_data=f.dashboard_data,g.modules=[],k.push(g));c.homecoach=k}a&&a(null,c)}})})})};q.prototype.getCamList=function(a){var c=this;this.getCamsData(function(b,d){if(b)a&&a(b);else{b={cam:[]};if(d){for(var e=[],k=0;k<d.length;k++)if(d[k]&&d[k].id){var f=
d[k].name,l=d[k].cameras;if(l)for(var n=0;n<l.length;n++)if(l[n]&&l[n].id){var p="welcome";"NACamera"==l[n].type?p="welcome":"NOC"==l[n].type&&(p="presence");p&&(p={sys:"cam",type:"system",manufacturer:"netatmo",model:p,address:l[n].id},l[n].name&&(p.name=l[n].name+(f?" ("+f+")":"")),e.push(p))}}b.cam=e}d=g(c);if(b.cam&&0<b.cam.length)for(e=0;e<b.cam.length;e++)b.cam[e].refreshToken=d.refresh_token;a&&a(null,b)}})};q.prototype.getWeatherStatus=function(a){var c=function(a,c){var b={};if(c)for(var d=
0;d<c.length;d++){var e=c[d];if(e&&e._id){var k=a._resolveStationStatus(e);k&&(b[e._id]=k);if(e.modules)for(var f=0;f<e.modules.length;f++)(k=a._resolveModuleStatus(e.modules[f]))&&(b[e._id+"|"+e.modules[f]._id]=k)}}return b};this._logger.log("debug","getWeatherStatus");var b=n(this),d=this,e=a;a=null;b&&b.data?(a=c(this,b.data),e&&e(null,a),e=null):this.getStationsData(function(a){a?(e&&e(a),e=null):e&&d.getWeatherStatus(e)})};q.prototype.getHomeCoachStatus=function(a){var c=function(a,c){var b=
{};if(c)for(var d=0;d<c.length;d++){var e=c[d];if(e&&e._id){var k=a._resolveHomeCoachStatus(e);k&&(b[e._id]=k)}}return b};this._logger.log("debug","getHomeCoachStatus");var b=u(this),d=this,e=a;a=null;b&&b.data?(a=c(this,b.data),e&&e(null,a),e=null):this.getHomeCoachsData(function(a){a?(e&&e(a),e=null):e&&d.getHomeCoachStatus(e)})};q.prototype.getThermoStatus=function(a){var c=function(a,b){for(var c={},e=0;e<b.length;e++){var d=b[e];if(d&&d._id&&d.modules)for(var k=0;k<d.modules.length;k++){var f=
a._resolveModuleStatus(d.modules[k]);f&&(c[d._id+"|"+d.modules[k]._id]=f)}}return c},b=v(this),d=this,e=a,k=null;b.updateData.running?(b.tmpCBs||(b.tmpCBs=[]),b.tmpCBs.push(a)):b.data?(k=c(this,b.data),e&&e(null,k),e=null):this.getThermostatsData(function(a){a?(e&&e(a),e=null):e&&d.getThermoStatus(e)})};q.prototype.getCamUrl=function(a,b){var c=this;this._refreshToken(this.refreshToken,function(d,e){if(d)e&&e.error&&(d=Error(e.error),d._code="auth_error"),b&&b(d);else{if(e&&e.access_token)var k=e.access_token;
k?e&&e.scope&&-1==e.scope.indexOf("access_camera")?b&&b(null,"scop_error"):c._getCamsData(k,function(e,d){if(e)d&&d.error&&(e=Error(d.error),e._code="api_error"),b&&b(e);else if(e=null,d.body&&d.body.homes&&(e=d.body.homes),e){for(d=0;d<e.length;d++)if(e[d]&&e[d].cameras){for(var k=e[d].cameras,f=0;f<k.length;f++)if(k[f]&&k[f].id==a&&k[f].vpn_url){var l=k[f];break}if(l)break}l?1==l.is_local?c._getLocalCamUrl(l.vpn_url,function(a,c){b&&b(a,c)}):b&&b(null,l.vpn_url+"/live/index.m3u8"):b&&b("no cam with address:"+
a)}else b&&b("get cams data reponse invalid")}):b&&b(Error("auth response invalid"))}})};q.prototype._resolveStationStatus=function(a){var b={};null!=a.wifi_status&&"undefined"!=typeof a.wifi_status&&(b.wifi=a.wifi_status,b.wifiStatus=86<=b.wifi?"bad":71<=b.wifi?"middle":56<=b.wifi?"good":"very_good");if(a.dashboard_data&&(a=this._resolveDashboard(a.dashboard_data)))for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b};q.prototype._resolveModuleStatus=function(a){var b={};null!=a.rf_status&&"undefined"!=
typeof a.rf_status&&(b.rf=a.rf_status,b.rfStatus=90<=b.rf?"very_low":80<=b.rf?"low":70<=b.rf?"medium":60<=b.rf?"high":"full");if(null!=a.battery_vp&&"undefined"!=typeof a.battery_vp)switch(b.bat=a.battery_vp,a.type){case "NAModule4":b.batStatus=5640<=b.bat?"full":5280<=b.bat?"high":4920<=b.bat?"medium":4560<=b.bat?"low":"very_low";break;case "NAModule1":case "NAModule3":b.batStatus=5500<=b.bat?"full":5E3<=b.bat?"high":4500<=b.bat?"medium":4E3<=b.bat?"low":"very_low";break;case "NAModule2":b.batStatus=
5900<=b.bat?"full":5180<=b.bat?"high":4770<=b.bat?"medium":4360<=b.bat?"low":"very_low";break;case "NATherm1":b.batStatus=4100<=b.bat?"full":3600<=b.bat?"high":3300<=b.bat?"medium":3E3<=b.bat?"low":"very_low"}var c,e;if("NATherm1"==a.type&&(c=this._resolveThermoStat(a)))for(e in c)c.hasOwnProperty(e)&&(b[e]=c[e]);if(a.dashboard_data&&(c=this._resolveDashboard(a.dashboard_data)))for(e in c)c.hasOwnProperty(e)&&(b[e]=c[e]);return b};q.prototype._resolveHomeCoachStatus=function(a){var b={};null!=a.wifi_status&&
"undefined"!=typeof a.wifi_status&&(b.wifi=a.wifi_status,b.wifiStatus=86<=b.wifi?"bad":71<=b.wifi?"middle":56<=b.wifi?"good":"very_good");if(a.dashboard_data&&(a=this._resolveDashboard(a.dashboard_data)))for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b};q.prototype._resolveThermoStat=function(a){var b={};if(a.setpoint){switch(a.setpoint.setpoint_mode){case "program":var c="auto";break;case "away":c="away";break;case "hg":c="frost-guard";break;case "manual":c="manu";break;case "off":c="off";
break;case "max":c="boost"}c&&(b.mode=c);null!=a.setpoint.setpoint_temp&&"undefined"!=typeof a.setpoint.setpoint_temp&&(b.manuT=a.setpoint.setpoint_temp);if(null!=a.setpoint.setpoint_endtime&&"undefined"!=typeof a.setpoint.setpoint_endtime)if(b.tempEnd=a.setpoint.setpoint_endtime,b.tempEndStr=(new Date(1E3*a.setpoint.setpoint_endtime)).toLocaleString(),"undefined"!=typeof dateFormat&&dateFormat)try{b.tempEndStr=dateFormat(b.tempEndStr,"dd mm yyyy, HH:MM:ss")}catch(z){}else b.tempEndStr=b.tempEndStr.toLocaleString()}a.measured&&
(null!=a.measured.time&&"undefined"!=typeof a.measured.time&&(b.mesureT=a.measured.time),null!=a.measured.temperature&&"undefined"!=typeof a.measured.temperature&&(b.currentTemp=a.measured.temperature));b.tempDuration=C(this,{module:a._id});return b};q.prototype._resolveDashboard=function(a){var b=function(a,b){return null!=a[b]&&"undefined"!=typeof a[b]},c={};b(a,"AbsolutePressure")&&(c.absPres=a.AbsolutePressure);b(a,"CO2")&&(c.co2=a.CO2);b(a,"Humidity")&&(c.hum=a.Humidity);b(a,"Noise")&&(c.noise=
a.Noise);b(a,"Pressure")&&(c.pres=a.Pressure);b(a,"Rain")&&(c.rain=a.Rain);b(a,"sum_rain_1")&&(c.rain1h=a.sum_rain_1);b(a,"sum_rain_24")&&(c.rain24h=a.sum_rain_24);b(a,"Temperature")&&(c.temp=a.Temperature);if(b(a,"date_max_temp")){c.timeMaxTemp=a.date_max_temp;var e=1E3*a.date_max_temp;c.timeMaxTempStr=new Date(e);c.timeMaxTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(c.timeMaxTempStr,"dd mm yyyy, HH:MM:ss"):c.timeMaxTempStr.toLocaleString()}b(a,"date_min_temp")&&(c.timeMinTemp=a.date_min_temp,
e=1E3*a.date_min_temp,c.timeMinTempStr=new Date(e),c.timeMinTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(c.timeMinTempStr,"dd.mm.yyyy, HH:MM:ss"):c.timeMinTempStr.toLocaleString());b(a,"max_temp")&&(c.maxTemp=a.max_temp);b(a,"min_temp")&&(c.minTemp=a.min_temp);b(a,"WindAngle")&&(c.winD=a.WindAngle);b(a,"WindStrength")&&(c.winS=a.WindStrength);b(a,"GustAngle")&&(c.gwinD=a.GustAngle);b(a,"GustStrength")&&(c.gwinS=a.GustStrength);b(a,"time_utc")&&(c.mesureT=a.time_utc,e=1E3*a.time_utc,
c.mesureTStr=new Date(e),c.mesureTStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(c.mesureTStr,"dd.mm.yyyy, HH:MM:ss"):c.mesureTStr.toLocaleString());b(a,"date_max_wind_str")&&(c.timeMaxWind=a.date_max_wind_str,e=1E3*a.date_max_wind_str,c.timeMaxWindStr=new Date(e),c.timeMaxWindStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(c.timeMaxWindStr,"dd.mm.yyyy, HH:MM:ss"):c.timeMaxWindStr.toLocaleString());b(a,"max_wind_angle")&&(c.maxWinD=a.max_wind_angle);b(a,"max_wind_str")&&(c.maxWinS=
a.max_wind_str);b(a,"temp_trend")&&(c.tempTrend=a.temp_trend);b(a,"pressure_trend")&&(c.presTrend=a.pressure_trend);if(b(a,"health_idx"))switch(c.healthIdxLvl=a.health_idx,parseInt(c.healthIdx)){case 0:c.healthIdx="healthy";break;case 1:c.healthIdx="fine";break;case 2:c.healthIdx="fair";break;case 3:c.healthIdx="poor";break;case 4:c.healthIdx="unhealthy"}return c};q.prototype.auth=function(a){this._logger.log("debug","auth");var b=g(this),d=this;b?b.access_token?c(this)?this._refreshToken(b.refresh_token,
function(b,c){b?(c&&c.error&&(b=Error(c.error),b._code="refresh_token_error"),a&&a(b)):(e(d,c),a&&a(null,c))}):a&&a(null,b):this._refreshToken(b.refresh_token,function(b,c){b?(c&&c.error&&(b=Error(c.error),b._code="refresh_token_error"),a&&a(b)):(e(d,c),a&&a(null,c))}):this._auth(this._scope.join(" "),function(b,c){if(b){if(c)try{if(c=JSON.parse(c),c.error&&(b=Error(c.error),b._code="auth_error","invalid_request"==c.error&&-1!=d._scope.indexOf("access_presence"))){d._scope=d._scopeFallback;d.auth(a);
return}}catch(G){}a&&a(b)}else e(d,c),a&&a(null,c)})};q.prototype.setThermPoint=function(a,b,c){if(a&&a.address&&a.module)if(b&&b.setpoint_mode)if("max"!=b.setpoint_mode||b.setpoint_endtime)if("manual"!=b.setpoint_mode||b.setpoint_endtime&&b.setpoint_temp){var e=this;this.auth(function(d){d?c&&c(d):e._setThermPoint(g(e).access_token,a.address,a.module,b.setpoint_mode,b.setpoint_endtime,b.setpoint_temp,function(a,b){a?(b&&b.error&&(a=Error(b.error),a._code="api_error"),c&&c(a)):c&&c(null,b)})})}else c&&
c(Error("param format invalid"));else c&&c(Error("param format invalid"));else c&&c(Error("param format invalid"));else c&&c(Error("device format invalid"))};q.prototype.getStationsData=function(b){this._logger.log("debug","getStationsData");var c=this;this.auth(function(e){e?b&&b(e):(e=n(c))&&e.updateData&&e.updateData.running?(e.tmpCBs||(e.tmpCBs=[]),e.tmpCBs.push(b)):(f(c),c._getStationsData(g(c).access_token,null,function(e,d){e?(d&&d.error&&(e=Error(d.error),e._code="api_error"),t(c,e,null),
b&&b(e)):(e=null,d.body&&d.body.devices&&(e=d.body.devices),d.body&&d.body.user&&d.body.user.administrative&&(a=d.body.user.administrative),t(c,null,e),b&&b(null,e))}))})};q.prototype.getThermostatsData=function(a){var b=this;this.auth(function(c){c?a&&a(c):(c=v(this))&&c.updateData&&c.updateData.running?(c.tmpCBs||(c.tmpCBs=[]),c.tmpCBs.push(a)):(D(b),b._getThermostatsData(g(b).access_token,null,function(c,e){c?(e&&e.error&&(c=Error(e.error),c._code="api_error"),B(b,c,null),a&&a(c)):(c=null,e.body&&
e.body.devices&&(c=e.body.devices),B(b,null,c),a&&a(null,c))}))})};q.prototype.getHomeCoachsData=function(a){this._logger.log("debug","getHomeCoachsData");var b=this;this.auth(function(c){c?a&&a(c):(c=u(this))&&c.updateData&&c.updateData.running?(c.tmpCBs||(c.tmpCBs=[]),c.tmpCBs.push(a)):(y(b),b._getHomeCoachsData(g(b).access_token,null,function(c,e){c?(e&&e.error&&(c=Error(e.error),c._code="api_error"),w(b,c,null),a&&a(c)):(c=null,e.body&&e.body.devices&&(c=e.body.devices),e.body&&e.body.user&&e.body.user.administrative&&
(d=e.body.user.administrative),w(b,null,c),a&&a(null,c))}))})};q.prototype.getCamsData=function(a){this._logger.log("debug","getCamsData");var b=this;this.auth(function(c){c?a&&a(c):b._getCamsData(g(b).access_token,function(b,c){b?(c&&c.error&&(b=Error(c.error),b._code="api_error"),a&&a(b)):(b=null,c.body&&c.body.homes&&(b=c.body.homes),a&&a(null,b))})})};q.prototype._auth=function(a,b){this._logger.log("trace","_auth");this._doRequest("POST","/oauth2/token",{grant_type:"password",client_id:"564b2c5245a1e3173cb21d3b",
client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",username:this.user,password:this.password,scope:a},b)};q.prototype._refreshToken=function(a,b){this._logger.log("trace","_refreshToken");this._doRequest("POST","/oauth2/token",{grant_type:"refresh_token",client_id:"564b2c5245a1e3173cb21d3b",client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",refresh_token:a},b)};q.prototype._setThermPoint=function(a,b,c,e,d,f,n){a={access_token:a,device_id:b,module_id:c,setpoint_mode:e};d&&(a.setpoint_endtime=
d);f&&(a.setpoint_temp=f);this._doRequest("GET","/api/setthermpoint",a,n)};q.prototype._getStationsData=function(a,b,c){this._logger.log("debug","_getStationsData");a={access_token:a};b&&(a.device_id=b);this._doRequest("GET","/api/getstationsdata",a,c)};q.prototype._getHomeCoachsData=function(a,b,c){this._logger.log("debug","_getHomeCoachsData");a={access_token:a};b&&(a.device_id=b);this._doRequest("GET","/api/gethomecoachsdata",a,c)};q.prototype._getThermostatsData=function(a,b,c){a={access_token:a};
b&&(a.device_id=b);this._doRequest("GET","/api/getthermostatsdata",a,c)};q.prototype._getCamsData=function(a,b){this._doRequest("GET","/api/gethomedata",{access_token:a},b)};q.prototype._getLocalCamUrl=function(a,b){var c=this;this._logger.log("trace","ping cam "+a);this._doUrlRequest("get",a+"/command/ping",null,function(e,d){!e&&d&&d.local_url?c._doUrlRequest("get",d.local_url+"/command/ping",null,function(c,e){c||!e||e.local_url!=d.local_url?b&&b(null,a+"/live/index.m3u8"):b&&b(null,e.local_url+
"/live/index.m3u8")}):b&&b(null,a+"/live/index.m3u8")})};q.prototype._doRequest=function(a,b,c,e){this._doUrlRequest(a,"https://api.netatmo.net"+b,c,e)};q.prototype._doUrlRequest=function(a,b,c,e){var d=this,f=e,n=null;try{n=JSON.parse(JSON.stringify(c)),n.username&&(n.username="xxxxxx"),n.password&&(n.password="xxxxxx")}catch(x){n=c}this._logger.log("trace","send "+a+" req to:"+b+" data:"+JSON.stringify(n));$.ajax({url:b,type:a,timeout:1E4,dataType:"json",data:c,cache:!1,success:function(a){d._logger.log("trace",
"http request success:"+JSON.stringify(a));e&&e(null,a)},error:function(a,b,c){b="http request error:"+(a?a.status:"0")+"-"+b;d._logger.log("warn","http request error:"+b);b=Error(b);c&&(d._logger.log("warn","http request http error:"+c),b.httpError=!0,b.statusCode=a?a.status:0);f&&(f(b,a?a.responseText:null),f=null)}})};q.prototype.toJSON=function(){return{sys:xnm.aio.netatmo.DM.SYS,username:this.user,password:this.password}};q.prototype.equalsTo=function(a){return a&&a instanceof q?this.user==a.user&&
this.password==a.password:!1};q.pause=function(a){for(var b in m)if(m.hasOwnProperty(b)){var c=m[b];c&&c.weather&&c.weather.timer&&clearTimeout(c.weather.timer);c&&c.thermo&&c.thermo.timer&&clearInterval(c.thermo.timer)}m={};a&&a()};return q}();
xnm.aio.netatmo.MNetatmo=function(){var m=function(h){this._logger=require("x.logger.js").getLogger("xnm.aio.netatmo.MNetatmo");this._interval=0;this._on={};this._updateInterval=12E4;this._url=null;this._username=h?h.username:null;this._password=h?h.password:null;this._basicAuth=h?h.basicAuth:null};m.CLOUD_URL="cloud.mediola.com";m.prototype={_doUpdate:function(h){var a=this;APP.isInDemoMode||this.getStates(null,function(d,b){if(b&&b.XC_SUC){XC.debugf("[MNetatmo] Received update.");for(var g in b.XC_SUC){d=
b.XC_SUC[g];for(var e in d){var c=d[e],n=g+"_"+e;if(c.states)for(var f in c.states)CommandHandler.setState(n+":"+f,c.states[f],!0)}}h&&h();if(Array.isArray(a._on.update))for(b={type:"update"},g=0;g<a._on.update.length;g++)(e=a._on.update[g])&&e(b)}})},_sendRequest:function(h,a){"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var d=require("https"),b=this._getURL();b=b.replace("https://","");h={host:b,method:"GET",path:h||"/",headers:{}};(b=this._getBasicAuthHeader())&&
(h.headers.Authorization=b);var g=this,e=a,c=d.request(h,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){g._logger.log("trace","http reponse:"+b+" statusCode:"+a.statusCode);if(200!=a.statusCode)e&&e(Error("http response with code:"+a.statusCode),null);else try{var c=JSON.parse(b);c&&c.XC_SUC?e&&e(null,c.XC_SUC):c&&c.XC_ERR?e&&e(Error(c.XC_ERR.msg)):e&&e(Error("http reponse format valid"));e=null}catch(r){g._logger.log("trace","http reponse is not valid json:"+
r.message),e&&e(r,null),e=null}})});c.setTimeout(1E4,function(){g._logger.log("trace","http request timeout");c.abort();e&&e(Error("http timeout"));e=null});c.on("error",function(a){g._logger.log("trace","http request error:"+a.message);e&&e(a);e=null});c.end()},_getURL:function(){return this._url?this._url:m.CLOUD_URL},_getBasicAuthHeader:function(){return this._basicAuth?this._basicAuth:this._username?"Basic "+(new Buffer(this._username+":"+(this._password?this._password:""))).toString("base64"):
null},_getStates:function(h){this._sendRequest("/netatmo/getStates",h)},addEventListener:function(h,a){this._on[h]||(this._on[h]=[]);this._on[h].push(a)},setUrl:function(h){this._url=h},getDevices:function(h){this._sendRequest("/netatmo/getDevices",h)},getStates:function(h,a,d){this._getStates(function(b,g){if(b)d&&d(null);else if(a){b={};for(var e in g){var c=g[e];if(c)for(var n in c)if(a&&a.address==n){var f=c[n];if(f&&f.states){b=f.states;break}}}if(h)for(var t in b)h.setState(a.id+":"+t,b[t]);
d&&d(b)}else d&&d(g)})},removeEventListener:function(h,a){if(this._on[h])for(var d=0;d<this._on[h].length;d++)if(this._on[h][d]===a){this._on[h].splice(d,1);break}},startUpdating:function(h){if(!this._interval)if(APP.isInDemoMode)XC.debugf("[MNetatmo.startUpdating] Ignored. App is in demo mode.");else{var a=this;XC.debugf("[MNetatmo.startUpdating] Start.");this._doUpdate();this._interval=setInterval(function(){a._doUpdate()},this._updateInterval)}},stopUpdating:function(){clearInterval(this._interval);
XC.debugf("[MNetatmo.stopUpdating] Stop.")}};return m}();
xnm.aio.netatmo.Client=function(){var m=function(){var a=function(){this._homes={};this._weather={};this._thermo={};this._coach={};this._states={};this._smartThermoDuraion={}};a.prototype.getStates=function(){return this._states};a.prototype.areStatesExpired=function(){var a={weather:!1,thermo:!1,coach:!1,hasWeatherDevice:!1,hasThermoDevice:!1,hasCoachDevice:!1};this._homes.lastReqTime?this._homes.lastReqOk?(a.weather=!(!this._homes.weather||!this._homes.weather.length),a.hasWeatherDevice=a.weather,
a.thermo=!(!this._homes.thermo||!this._homes.thermo.length),a.hasThermoDevice=a.thermo):300<Math.round((new Date).getTime()/1E3)-this._homes.lastReqTime&&(a.weather=!0,a.thermo=!0):(a.weather=!0,a.thermo=!0);this._coach&&(a.coach=!0);a.weather&&(a.weather=this._isWeatherExpired());a.thermo&&(a.thermo=this._isThermoExpired());a.coach&&(a.coach=this._isCoachExpired());return a};a.prototype._isWeatherExpired=function(){if(!this._weather.lastReqTime)return!0;var a=Math.round((new Date).getTime()/1E3);
return this._weather.lastReqOk?this._weather.weatherTimeChanged?this._weather.expired:660<a-this._weather.lastReqTime?!0:!1:300<a-this._weather.lastReqTime?!0:!1};a.prototype._isThermoExpired=function(){if(!this._thermo.lastReqTime)return!0;var a=Math.round((new Date).getTime()/1E3);return this._thermo.lastReqOk?660<a-this._thermo.lastReqTime?!0:!1:300<a-this._thermo.lastReqTime?!0:!1};a.prototype._isCoachExpired=function(){if(!this._coach.lastReqTime)return!0;var a=Math.round((new Date).getTime()/
1E3);return this._coach.lastReqOk?this._coach.coachTimeChanged?this._coach.expired:660<a-this._coach.lastReqTime?!0:!1:300<a-this._coach.lastReqTime?!0:!1};a.prototype.updateReqTime=function(a,b){switch(a){case "weather":this._weather.lastReqTime=b;break;case "thermo":this._thermo.lastReqTime=b;break;case "coach":this._coach.lastReqTime=b;break;case "homes":this._homes.lastReqTime=b}};a.prototype.updateReqOK=function(a,b){switch(a){case "weather":this._weather.lastReqOk=b;break;case "thermo":this._thermo.lastReqOk=
b;break;case "coach":this._coach.lastReqOk=b;break;case "homes":this._homes.lastReqOk=b}};a.prototype.updateHomesInfo=function(a,b){if(a&&b){this._homes.weather=b.weather;this._homes.thermo=b.thermo;this._homes.coach=b.coach;for(var d in a)this._states[d]=a[d]}};a.prototype.updateWeatherStatus=function(a,b,g){if(a&&b&&g){var e=this._weather.weatherTime;this._weather.weatherTime=b;this._weather.weatherTimeChanged=b!=e;this._weather.expired=660<g-b;if(!this._weather.expired){this._weather.expireTo&&
clearTimeout(this._weather.expireTo);var c=this;this._weather.expireTo=setTimeout(function(){c._weather.expired=!0},1E3*(b+660-g))}for(var d in a)this._states[d]=a[d]}};a.prototype.updateThermoStatus=function(a){if(a)for(var b in a)this._states[b]=a[b]};a.prototype.updateCoachStatus=function(a,b,g){if(a&&b&&g){var e=this._coach.coachTime;this._coach.coachTime=b;this._coach.coachTimeChanged=b!=e;this._coach.expired=660<g-b;if(!this._coach.expired){this._coach.expireTo&&clearTimeout(this._coach.expireTo);
var c=this;this._coach.expireTo=setTimeout(function(){c._coach.expired=!0},1E3*(b+660-g))}for(var d in a)this._states[d]=a[d]}};a.prototype.thermoStatusChanged=function(){this._thermo.lastReqTime=null};a.prototype.setSmartThermoDuration=function(a,b){a&&a.module&&(this._smartThermoDuraion[a.module]=b)};a.prototype.getSmartThermoDuration=function(a){if(a&&a.module)return this._smartThermoDuraion[a.module]};return a}(),h=function(a,d,b){this._logger=require("x.logger.js").getLogger("xnm.aio.netatmo.Client");
this.username=a;this.password=d;this.refreshToken=b;this.accessToken=null;this._scope="read_station read_thermostat read_homecoach write_thermostat read_camera access_camera read_presence access_presence".split(" ");this._stateBuffer=new m;this._renewTokenCBs=[];this._getHomesInfoCBs=[];this._getWeatherStatusCBs=[];this._getThermoStatusCBs=[];this._getCoachStatusCBs=[]};h.prototype.toJSON=function(){return{sys:xnm.aio.netatmo.DM.SYS,username:this.username,password:this.password,refreshToken:this.refreshToken}};
h.prototype.equalsTo=function(a){return a&&a instanceof h?this.refreshToken?this.refreshToken===a.refreshToken:this.user==a.user&&this.password==a.password:!1};h.prototype.executeCommandCreator=function(a,d,b){d&&d.value?"NATherm1"==a.type?this._setSmartThermostat(a,d,function(a){b&&b(a)}):"home"==a.type?this._setHomeThermMode(a,d,function(a){b&&b(a)}):"room"==a.type?this._setRoomTherm(a,d,function(a){b&&b(a)}):b&&b(Error("device has no command")):b&&b(Error("command format invalid"))};h.prototype.getStatesCreator=
function(a,d,b){d?this.getAllStatus(function(a,e){for(var c=[],n=0;n<d.length;n++){var f=d[n];if(f.id){var g,h="?";!a&&e&&f.device&&f.device.type&&(g="NAMain"==f.device.type||"NHC"==f.device.type||"NAPlug"==f.device.type?f.device.address:"room"==f.device.type||"home"==f.device.type?f.device.address:f.device.module)&&f.status&&f.status.value&&(g=e[g])&&(h=g[f.status.value],null==h||"undefined"==typeof h)&&(h="?");c.push({id:f.id,status:h})}}b&&b(null,c)}):b&&b(Error("deviceList is null"))};h.prototype._setHomeThermMode=
function(a,d,b){if(a&&a.address&&"home"==a.type){var g=this;a=a.address;switch(d.value){case "thermoAuto":var e="schedule";break;case "thermoAway":e="away";break;case "thermoAwayUntil":if(!d.ext){b(Error("invalid command"));return}e="away";var c=parseInt(d.ext);break;case "thermoHg":e="hg";break;case "thermoHgUntil":if(!d.ext){b(Error("invalid command"));return}e="hg";c=parseInt(d.ext);break;default:b(Error("unknown command"))}this._setThermMode(a,e,c,null,function(a,c){a?b(a):(g._stateBuffer.thermoStatusChanged(),
b())})}else b(Error("invalid device"))};h.prototype._setRoomTherm=function(a,d,b){if(a&&a.address&&a.homeId&&"room"==a.type){var g=this,e=a.homeId,c=a.address;switch(d.value){case "thermoAuto":var n="home";break;case "thermoManu":if(!d.ext){b(Error("invalid command"));return}n="manual";var f=parseFloat(d.ext);7>f&&(f=7);30<f&&(f=30);break;case "thermoManuUntil":if(!d.ext){b(Error("invalid command"));return}n="manual";for(a=0;a<d.ext.length;a++){var h=d.ext[a];if(h)switch(h.value){case "temp":f=parseFloat(h.ext);
break;case "endtime":var r=parseInt(h.ext)}}if(!f||!r){b(Error("invalid command"));return}7>f&&(f=7);30<f&&(f=30);break;case "thermoUp":case "thermoDown":this.getAllStatus(function(a,h){a?b(a):(a=h?h[c]:null)?(r=a.tempEnd,f=parseFloat(a.manuT),isNaN(f)?b(Error("unknown current room setpoint")):(f="thermoUp"==d.value?f+.5:f-.5,7>f&&(f=7),30<f&&(f=30),n="manual",g._setRoomThermPoint(e,c,n,f,r,function(a,c){a?b(a):(g._stateBuffer.thermoStatusChanged(),b())}))):b(Error("unknown current room status"))});
return;default:b(Error("unknown command"))}this._setRoomThermPoint(e,c,n,f,r,function(a,c){a?b(a):(g._stateBuffer.thermoStatusChanged(),b())})}else b(Error("invalid device"))};h.prototype._setSmartThermostat=function(a,d,b){var g=this,e=this._stateBuffer.getSmartThermoDuration(a);e||(e=60);var c={};switch(d.value){case "thermoAuto":c.setpoint_mode="program";break;case "thermoAway":c.setpoint_mode="away";break;case "thermoHg":c.setpoint_mode="hg";break;case "thermoOff":c.setpoint_mode="off";break;
case "thermoMax":c.setpoint_mode="max";c.setpoint_endtime=Math.round(((new Date).getTime()+6E4*e)/1E3);break;case "thermoManu":if(null==d.ext||"undefined"==typeof d.ext){b&&b(Error("command ext invalid"));return}var n=d.ext;"string"==typeof d.ext&&(n=parseFloat(d.ext));5.5>n&&(n=5.5);30<n&&(n=30);c.setpoint_mode="manual";c.setpoint_endtime=Math.round(((new Date).getTime()+6E4*e)/1E3);c.setpoint_temp=n;break;case "tempDuration":if(null==d.ext||"undefined"==typeof d.ext){b&&b(Error("command ext invalid"));
return}e=d.ext;"string"==typeof d.ext&&(e=parseFloat(d.ext));15>e&&(e=15);720<e&&(e=720);this._stateBuffer.setSmartThermoDuration(a,e);b&&b();return;default:b&&b(Error("unknow command"))}a&&a.address&&a.module?c&&c.setpoint_mode?"max"!=c.setpoint_mode||c.setpoint_endtime?"manual"!=c.setpoint_mode||c.setpoint_endtime&&c.setpoint_temp?this._setThermPoint(a.address,a.module,c.setpoint_mode,c.setpoint_endtime,c.setpoint_temp,function(a,c){a?b&&b(a):(g._stateBuffer.thermoStatusChanged(),b&&b(null,c))}):
b&&b(Error("param format invalid")):b&&b(Error("param format invalid")):b&&b(Error("param format invalid")):b&&b(Error("device format invalid"))};h.prototype.auth=function(a){this._logger.log("debug","auth");this.username&&this.password?this._auth(function(d,b){a&&a(d,b)}):this.refreshToken?this._refreshToken(function(d,b){a&&a(d,b)}):a&&a(Error(""))};h.prototype.getDeviceList=function(a){var d=this,b=[];this._getHomeCoachsData(null,function(g,e){g?d._logger.log("error","getHomeCoachsData error: "+
g.message):e&&Array.isArray(e.devices)&&e.devices.forEach(function(a){var c=a.name||a.type;a.station_name&&(c+=" ("+a.station_name+")");b.push({address:a._id,type:a.type,name:c,room:null,home:null,dashboard_data:a.dashboard_data})});d._getHomesData(null,null,function(c,e){c?0===b.length?a&&a(c):a&&a(null,b):(e&&e.length&&e.forEach(function(a){if(a&&a.modules&&a.modules.length){var c={};a.rooms&&a.rooms.forEach(function(a){c[a.id]={name:a.name,hasThermo:!1}});var e=!1;a.modules.forEach(function(d){if(d&&
d.id&&d.type)switch(d.type){case "NAMain":var f={address:d.id,type:d.type,name:d.name?d.name:null,room:null,home:a.name};d.room_id&&c[d.room_id]&&(f.room=c[d.room_id].name);b.push(f);break;case "NAModule1":case "NAModule2":case "NAModule3":case "NAModule4":f={module:d.id,address:d.bridge,type:d.type,name:d.name?d.name:null,room:null,home:a.name};d.room_id&&c[d.room_id]&&(f.room=c[d.room_id].name);b.push(f);break;case "NAPlug":e=!0;f={address:d.id,type:d.type,name:d.name?d.name:null,room:null,home:a.name};
d.room_id&&c[d.room_id]&&(f.room=c[d.room_id].name,c[d.room_id].hasThermo=!0);b.push(f);break;case "NATherm1":case "NRV":e=!0;f={address:d.bridge,module:d.id,type:d.type,name:d.name?d.name:null,room:null,home:a.name};d.room_id&&c[d.room_id]&&(f.room=c[d.room_id].name,c[d.room_id].hasThermo=!0);b.push(f);break;case "NHC":f={address:d.id,type:d.type,name:d.name?d.name:a.name,room:null,home:a.name},d.room_id&&c[d.room_id]&&(f.room=c[d.room_id].name),b.push(f)}});for(var d in c){var f=c[d];f.hasThermo&&
b.push({address:d,type:"room",name:f.name,home:a.name,homeId:a.id})}e&&b.push({address:a.id,type:"home",name:a.name})}}),a&&a(null,b))})})};h.prototype.getCamList=function(a){var d=this;this._getHomeData(null,null,function(b,g){if(b)a&&a(b);else{b={cam:[]};if(g){for(var e=[],c=0;c<g.length;c++)if(g[c]&&g[c].id){var n=g[c].name,f=g[c].cameras;if(f)for(var h=0;h<f.length;h++)if(f[h]&&f[h].id){var r="welcome";"NACamera"==f[h].type?r="welcome":"NOC"==f[h].type&&(r="presence");r&&(r={sys:"cam",type:"system",
manufacturer:"netatmo",model:r,address:f[h].id},f[h].name&&(r.name=f[h].name+(n?" ("+n+")":"")),e.push(r))}}b.cam=e}if(b.cam&&0<b.cam.length)for(g=0;g<b.cam.length;g++)b.cam[g].refreshToken=d.refreshToken;a&&a(null,b)}})};h.prototype.getCamUrl=function(a,d){var b=this;this._getHomeData(null,null,function(g,e){if(g)d&&d(g);else if(e){for(g=0;g<e.length;g++)if(e[g]&&e[g].cameras){for(var c=e[g].cameras,n=0;n<c.length;n++)if(c[n]&&c[n].id==a&&c[n].vpn_url){var f=c[n];break}if(f)break}f?1==f.is_local?
b._getLocalCamUrl(f.vpn_url,function(a,c){d&&d(a,c)}):d&&d(null,f.vpn_url+"/live/index.m3u8"):d&&d("no cam with address:"+a)}else d&&d("get cams data reponse invalid")})};h.prototype._getLocalCamUrl=function(a,d){var b=this;this._logger.log("trace","ping cam "+a);this._doUrlRequest("get",a+"/command/ping",null,function(g,e){!g&&e&&e.local_url?b._doUrlRequest("get",e.local_url+"/command/ping",null,function(c,b){c||!b||b.local_url!=e.local_url?d&&d(null,a+"/live/index.m3u8"):d&&d(null,b.local_url+"/live/index.m3u8")}):
d&&d(null,a+"/live/index.m3u8")})};h.prototype.getAllStatus=function(a){var d=this,b=this._stateBuffer.areStatesExpired();b.weather||b.thermo||b.coach?this._getAllStatus(b,function(b){b?a&&a(b):a&&a(null,d._stateBuffer.getStates())}):a&&a(null,this._stateBuffer.getStates())};h.prototype._getAllStatus=function(a,d){var b=this,g=function(a,c){a&&a.weather?b._getWeatherStatus(c):c()},e=function(a,c){a&&a.thermo?b._getThermoStatus(a.home,c):c()},c=function(a,c){a&&a.coach?b._getHomeCoachStatus(c):c()};
this._getHomesInfo(function(b,f,h){b?d(b):("object"===typeof h&&h?(a.weather=h.weather&&0<h.weather.length,a.thermo=h.thermo&&0<h.thermo.length,h.coach&&0<h.coach.length&&(a.coach=!0),a.thermo&&(a.home=h.home)):(a.weather=!1,a.thermo=!1),g(a,function(b){b?d(b):e(a,function(b){b?d(b):c(a,function(a){d(a)})})}))})};h.prototype._getHomesInfo=function(a){var d=this._getHomesInfoCBs.length;-1==this._getHomesInfoCBs.indexOf(a)&&this._getHomesInfoCBs.push(a);if(0==d){var b=this;this._stateBuffer.updateReqTime("homes",
Math.round((new Date).getTime()/1E3));this._getHomesData(null,null,function(a,e,c){b._stateBuffer.updateReqOK("homes",a?!1:!0);c=b._getHomesInfoCBs;b._getHomesInfoCBs=[];a&&c.forEach(function(b){try{b&&b(a)}catch(w){}});if(e&&e.length){var d=[],f=[],g=[],h=[],m={};e.forEach(function(a){if(a&&a.modules&&a.modules.length){a.modules.forEach(function(b){if(b&&b.id&&b.type)switch(b.type){case "NAMain":case "NAModule1":case "NAModule2":case "NAModule3":case "NAModule4":f.push(b.id);break;case "NATherm1":case "NAPlug":case "NRV":-1==
d.indexOf(a.id)&&d.push(a.id);g.push(b.id);break;case "NHC":h.push(b.id)}});var c=b._resolveHomeStatus(a);if(c)for(var e in c)m[e]=c[e]}});b._stateBuffer.updateHomesInfo(m,{weather:f,thermo:g,coach:h});c.forEach(function(a){try{a&&a(null,m,{weather:f,thermo:g,coach:h,home:d})}catch(w){}})}else b._stateBuffer.updateHomesInfo({},{}),c.forEach(function(a){try{a&&a(null,{})}catch(w){}})})}};h.prototype._resolveHomeStatus=function(a){if(!a)return null;var d={};d.mode=a.therm_mode;d.tempEnd=a.therm_mode_endtime;
if(d.tempEnd)if(d.tempEndStr=(new Date(1E3*d.tempEnd)).toLocaleString(),"undefined"!=typeof dateFormat&&dateFormat)try{d.tempEndStr=dateFormat(d.tempEndStr,"dd mm yyyy, HH:MM:ss")}catch(g){}else d.tempEndStr=d.tempEndStr.toLocaleString();var b={};b[a.id]=d;return b};h.prototype._getWeatherStatus=function(a){var d=this._getWeatherStatusCBs.length;-1==this._getWeatherStatusCBs.indexOf(a)&&this._getWeatherStatusCBs.push(a);if(0==d){var b=this;this._stateBuffer.updateReqTime("weather",Math.round((new Date).getTime()/
1E3));this._getStationsData(null,!1,function(a,e,c){b._stateBuffer.updateReqOK("weather",a?!1:!0);var d=b._getWeatherStatusCBs;b._getWeatherStatusCBs=[];if(a)d.forEach(function(b){try{b&&b(a,homes,c)}catch(u){}});else{var f=null,g={};e.devices&&e.devices.length&&e.devices.forEach(function(a){if(a&&"NAMain"==a.type&&(a.last_status_store&&(f=Math.max(a.last_status_store,f)),a=b._resolveWeatherStatus(a,e.user?e.user.administrative:null)))for(var c in a)g[c]=a[c]});f&&b._stateBuffer.updateWeatherStatus(g,
f,c);d.forEach(function(a){try{a&&a(null,g)}catch(u){}})}})}};h.prototype._resolveWeatherStatus=function(a,d){if(!a||"NAMain"!=a.type)return null;var b={};if(a._id){var g={};null!=a.wifi_status&&"undefined"!=typeof a.wifi_status&&(g.wifi=a.wifi_status,g.wifiStatus=86<=g.wifi?"bad":71<=g.wifi?"middle":56<=g.wifi?"good":"very_good");if(a.dashboard_data){var e=this._resolveDashboard(a.dashboard_data);if(e)for(var c in e)e.hasOwnProperty(c)&&(g[c]=e[c])}g.tempFelt=null;"undefined"!=typeof g.temp&&"undefined"!=
typeof g.hum&&d&&(g.tempFelt=xnm.aio.netatmo.DM.calcFeltTemp(g.temp,g.hum,d));b[a._id]=g}var n=this;a.modules&&a.modules.forEach(function(a){var c=n._resolveModuleStatus(a,d);a&&a._id&&c&&(b[a._id]=c)});return b};h.prototype._resolveModuleStatus=function(a,d){var b={};null!=a.rf_status&&"undefined"!=typeof a.rf_status&&(b.rf=a.rf_status,b.rfStatus=90<=b.rf?"very_low":80<=b.rf?"low":70<=b.rf?"medium":60<=b.rf?"high":"full");if(null!=a.battery_vp&&"undefined"!=typeof a.battery_vp)switch(b.bat=a.battery_vp,
a.type){case "NAModule4":b.batStatus=5640<=b.bat?"full":5280<=b.bat?"high":4920<=b.bat?"medium":4560<=b.bat?"low":"very_low";break;case "NAModule1":case "NAModule3":b.batStatus=5500<=b.bat?"full":5E3<=b.bat?"high":4500<=b.bat?"medium":4E3<=b.bat?"low":"very_low";break;case "NAModule2":b.batStatus=5900<=b.bat?"full":5180<=b.bat?"high":4770<=b.bat?"medium":4360<=b.bat?"low":"very_low";break;case "NATherm1":b.batStatus=4100<=b.bat?"full":3600<=b.bat?"high":3300<=b.bat?"medium":3E3<=b.bat?"low":"very_low"}var g,
e;if("NATherm1"==a.type&&(g=this._resolveThermoStat(a)))for(e in g)g.hasOwnProperty(e)&&(b[e]=g[e]);if(a.dashboard_data){if(g=this._resolveDashboard(a.dashboard_data))for(e in g)g.hasOwnProperty(e)&&(b[e]=g[e]);"undefined"!=typeof b.winD&&null!=b.winD&&(a=Number(b.winD),isNaN(a)||(b.winDName=23<a&&68>=a?"NO":68<a&&113>=a?"O":113<a&&158>=a?"SO":158<a&&203>=a?"S":203<a&&248>=a?"SW":248<a&&293>=a?"W":293<a&&338>=a?"NW":"N"));"undefined"!=typeof b.temp&&"undefined"!=typeof b.hum&&d&&(b.tempFelt=xnm.aio.netatmo.DM.calcFeltTemp(b.temp,
b.hum,d))}return b};h.prototype._resolveDashboard=function(a){var d=function(a,b){return null!=a[b]&&"undefined"!=typeof a[b]},b={};d(a,"AbsolutePressure")&&(b.absPres=a.AbsolutePressure);d(a,"CO2")&&(b.co2=a.CO2);d(a,"Humidity")&&(b.hum=a.Humidity);d(a,"Noise")&&(b.noise=a.Noise);d(a,"Pressure")&&(b.pres=a.Pressure);d(a,"Rain")&&(b.rain=a.Rain);d(a,"sum_rain_1")&&(b.rain1h=a.sum_rain_1);d(a,"sum_rain_24")&&(b.rain24h=a.sum_rain_24);d(a,"Temperature")&&(b.temp=a.Temperature);if(d(a,"date_max_temp")){b.timeMaxTemp=
a.date_max_temp;var g=1E3*a.date_max_temp;b.timeMaxTempStr=new Date(g);b.timeMaxTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(b.timeMaxTempStr,"dd mm yyyy, HH:MM:ss"):b.timeMaxTempStr.toLocaleString()}d(a,"date_min_temp")&&(b.timeMinTemp=a.date_min_temp,g=1E3*a.date_min_temp,b.timeMinTempStr=new Date(g),b.timeMinTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(b.timeMinTempStr,"dd.mm.yyyy, HH:MM:ss"):b.timeMinTempStr.toLocaleString());d(a,"max_temp")&&(b.maxTemp=a.max_temp);
d(a,"min_temp")&&(b.minTemp=a.min_temp);d(a,"WindAngle")&&(b.winD=a.WindAngle);d(a,"WindStrength")&&(b.winS=a.WindStrength);d(a,"GustAngle")&&(b.gwinD=a.GustAngle);d(a,"GustStrength")&&(b.gwinS=a.GustStrength);d(a,"time_utc")&&(b.mesureT=a.time_utc,g=1E3*a.time_utc,b.mesureTStr=new Date(g),b.mesureTStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(b.mesureTStr,"dd.mm.yyyy, HH:MM:ss"):b.mesureTStr.toLocaleString());d(a,"date_max_wind_str")&&(b.timeMaxWind=a.date_max_wind_str,g=1E3*a.date_max_wind_str,
b.timeMaxWindStr=new Date(g),b.timeMaxWindStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(b.timeMaxWindStr,"dd.mm.yyyy, HH:MM:ss"):b.timeMaxWindStr.toLocaleString());d(a,"max_wind_angle")&&(b.maxWinD=a.max_wind_angle);d(a,"max_wind_str")&&(b.maxWinS=a.max_wind_str);d(a,"temp_trend")&&(b.tempTrend=a.temp_trend);d(a,"pressure_trend")&&(b.presTrend=a.pressure_trend);if(d(a,"health_idx"))switch(b.healthIdxLvl=a.health_idx,parseInt(b.healthIdx)){case 0:b.healthIdx="healthy";break;case 1:b.healthIdx=
"fine";break;case 2:b.healthIdx="fair";break;case 3:b.healthIdx="poor";break;case 4:b.healthIdx="unhealthy"}return b};h.prototype._getThermoStatus=function(a,d){if(a&&a.length){var b=this._getThermoStatusCBs.length;-1==this._getThermoStatusCBs.indexOf(d)&&this._getThermoStatusCBs.push(d);if(0==b){var g=this;this._stateBuffer.updateReqTime("thermo",Math.round((new Date).getTime()/1E3));var e=0,c={},n=function(b,d){var f=g._getThermoStatusCBs;b?(g._stateBuffer.updateReqOK("thermo",!1),g._getThermoStatusCBs=
[],f.forEach(function(a){try{a&&a(b)}catch(y){}})):(d&&(d.modules&&d.modules.forEach(function(a){if(a&&a.id){var b=g._resolveThermoModuleStatus(a);b&&(c[a.id]=b)}}),d.rooms&&d.rooms.forEach(function(a){if(a&&a.id){var b=g._resolveThermoRoomStatus(a);b&&(c[a.id]=b)}})),e++,e<a.length?g._getHomeStatus(a[e],null,n):(g._stateBuffer.updateReqOK("thermo",!0),g._stateBuffer.updateThermoStatus(c),g._getThermoStatusCBs=[],f.forEach(function(a){try{a&&a(null,c)}catch(y){}})))};this._getHomeStatus(a[e],null,
n)}}else d(null,null)};h.prototype._resolveThermoModuleStatus=function(a){if(!a)return null;var d=function(a,b){return null!=a[b]&&"undefined"!=typeof a[b]},b={};d(a,"rf_strength")&&(b.rf=a.rf_strength,b.rfStatus=90<b.rf?"very_low":80<b.rf?"low":70<b.rf?"medium":60<b.rf?"high":"full");d(a,"wifi_strength")&&(b.wifi=a.wifi_status,b.wifiStatus=86<=b.wifi?"bad":71<=b.wifi?"middle":56<=b.wifi?"good":"very_good");d(a,"battery_level")&&(b.bat=a.battery_level);d(a,"battery_state")&&(b.batStatus=a.battery_state);
return b};h.prototype._resolveThermoRoomStatus=function(a){if(!a)return null;var d={};d.mode=a.therm_setpoint_mode;d.manuT=a.therm_setpoint_temperature;d.tempEnd=a.therm_setpoint_end_time;if(d.tempEnd)if(d.tempEndStr=(new Date(1E3*d.tempEnd)).toLocaleString(),"undefined"!=typeof dateFormat&&dateFormat)try{d.tempEndStr=dateFormat(d.tempEndStr,"dd mm yyyy, HH:MM:ss")}catch(b){}else d.tempEndStr=d.tempEndStr.toLocaleString();d.currentTemp=a.therm_measured_temperature;return d};h.prototype._getHomeCoachStatus=
function(a){var d=this._getCoachStatusCBs.length;-1==this._getCoachStatusCBs.indexOf(a)&&this._getCoachStatusCBs.push(a);if(0==d){var b=this;this._stateBuffer.updateReqTime("coach",Math.round((new Date).getTime()/1E3));this._getHomeCoachsData(null,function(a,e,c){b._stateBuffer.updateReqOK("coach",a?!1:!0);var d=b._getCoachStatusCBs;b._getCoachStatusCBs=[];if(a)d.forEach(function(b){try{b&&b(a,e,c)}catch(u){}});else{var f=null,g={};e.devices&&e.devices.length&&e.devices.forEach(function(a){if(a&&
"NHC"==a.type&&(a.last_status_store&&(f=Math.max(a.last_status_store,f)),a=b._resolveCoachStatus(a,e.user?e.user.administrative:null)))for(var c in a)g[c]=a[c]});f&&b._stateBuffer.updateCoachStatus(g,f,c);d.forEach(function(a){try{a&&a(null,g)}catch(u){}})}})}};h.prototype._resolveCoachStatus=function(a,d){var b={};b.wifi=a.wifi_status;b.wifiStatus=86<=b.wifi?"bad":71<=b.wifi?"middle":56<=b.wifi?"good":"very_good";if(a.dashboard_data){var g=this._resolveDashboard(a.dashboard_data);if(g)for(var e in g)g.hasOwnProperty(e)&&
(b[e]=g[e])}b.tempFelt=null;"undefined"!=typeof b.temp&&"undefined"!=typeof b.hum&&d&&(b.tempFelt=xnm.aio.netatmo.DM.calcFeltTemp(b.temp,b.hum,d));d={};d[a._id]=b;return d};h.prototype._renewAccessToken=function(a){var d=this._renewTokenCBs.length;a&&-1==this._renewTokenCBs.indexOf(a)&&this._renewTokenCBs.push(a);if(0==d){var b=this;a=function(a,e){var c=!1;!a&&e&&(e.access_token&&(b.accessToken=e.access_token,c=!0),e.refresh_token&&(b.refreshToken=e.refresh_token));a||c||(a=Error("invalid token response"));
e=b._renewTokenCBs;b._renewTokenCBs=null;for(c=0;c<e.length;c++)try{e[c](a)}catch(n){}};this.refreshToken?this._refreshToken(a):this.username&&this.password?this._auth(a):a(Error("no refresh token or username/password"))}};h.prototype._auth=function(a){this._logger.log("trace","_auth");var d={grant_type:"password",client_id:"564b2c5245a1e3173cb21d3b",client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",username:this.username,password:this.password,scope:this._scope.join(" ")},b=[],g;for(g in d)b.push(g+
"="+encodeURIComponent(d[g]));d=b.join("&");this._doRequest("POST","/oauth2/token",{"Content-Type":"application/x-www-form-urlencoded"},d,function(b,c,d){if(b)a(b);else if(c)try{var e=JSON.parse(c);200!=d?(b=Error(e.error),a(b)):a(null,e)}catch(t){a(t)}else a(Error("invalid response"))})};h.prototype._refreshToken=function(a){this._logger.log("trace","_refreshToken");var d={grant_type:"refresh_token",client_id:"564b2c5245a1e3173cb21d3b",client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",refresh_token:this.refreshToken},
b=[],g;for(g in d)b.push(g+"="+encodeURIComponent(d[g]));d=b.join("&");this._doRequest("POST","/oauth2/token",{"Content-Type":"application/x-www-form-urlencoded"},d,function(b,c,d){if(b)a(b);else if(c)try{var e=JSON.parse(c);200!=d?(b=Error(e.error),a(b)):a(null,e)}catch(t){a(t)}else a(Error("invalid response"))})};h.prototype._getStationsData=function(a,d,b){this._logger.log("debug","_getStationsData");var g="/api/getstationsdata",e=[];a&&e.push("device_id="+a);d&&e.push("get_favorites="+get_favorites);
e.length&&(g+="?"+e.join("&"));this._doAPIRequest("GET",g,null,function(a,e){a?b(a):e&&e.body?b(null,e.body,e.time_server):b(Error("invalid get stations data response"))})};h.prototype._getHomesData=function(a,d,b){this._logger.log("debug","_getHomesData");var g="/api/homesdata",e=[];a&&e.push("home_id="+a);d&&e.push("gateway_types="+d);e.length&&(g+="?"+e.join("&"));this._doAPIRequest("GET",g,null,function(a,e){a?b(a):e&&e.body&&e.body.homes?b(null,e.body.homes,e.time_server):b(Error("invalid get homes data response"))})};
h.prototype._getHomeStatus=function(a,d,b){this._logger.log("debug","_getHomeStatus");var g="/api/homestatus",e=[];a&&e.push("home_id="+a);d&&d.length&&d.forEach(function(a){e.push("device_types="+a)});e.length&&(g+="?"+e.join("&"));this._doAPIRequest("GET",g,null,function(a,e){a?b(a):e&&e.body&&e.body.home?b(null,e.body.home,e.time_server):b(Error("invalid get home status response"))})};h.prototype._getHomeCoachsData=function(a,d){this._logger.log("debug","_getHomeCoachsData");var b="/api/gethomecoachsdata",
g=[];a&&g.push("device_id="+a);g.length&&(b+="?"+g.join("&"));this._doAPIRequest("GET",b,null,function(a,b){a?d(a):b&&b.body?d(null,b.body,b.time_server):d(Error("invalid get stations data response"))})};h.prototype._setThermPoint=function(a,d,b,g,e,c){var h="/api/setthermpoint",f=[];a&&f.push("device_id="+a);d&&f.push("module_id="+d);b&&f.push("setpoint_mode="+b);g&&f.push("setpoint_endtime="+g);e&&f.push("setpoint_temp="+e);f.length&&(h+="?"+f.join("&"));this._doAPIRequest("GET",h,null,c)};h.prototype._setThermMode=
function(a,d,b,g,e){this._logger.log("debug","_setThermMode");var c="/api/setthermmode",h=[];a&&h.push("home_id="+a);d&&h.push("mode="+d);b&&h.push("endtime="+b);g&&h.push("schedule_id="+g);h.length&&(c+="?"+h.join("&"));this._doAPIRequest("GET",c,null,function(a,b){e(a)})};h.prototype._setRoomThermPoint=function(a,d,b,g,e,c){this._logger.log("debug","_setRoomThermPoint");var h="/api/setroomthermpoint",f=[];a&&f.push("home_id="+a);d&&f.push("room_id="+d);b&&f.push("mode="+b);g&&f.push("temp="+g);
e&&f.push("endtime="+e);f.length&&(h+="?"+f.join("&"));this._doAPIRequest("GET",h,null,function(a,b){c(a)})};h.prototype._getHomeData=function(a,d,b){this._logger.log("debug","_getHomeData");var g="/api/gethomedata",e=[];a&&e.push("home_id="+a);d&&e.push("size="+d);e.length&&(g+="?"+e.join("&"));this._doAPIRequest("GET",g,null,function(a,e){a?b(a):e&&e.body&&e.body.homes?b(null,e.body.homes,e.time_server):b(Error("invalid get homes data response"))})};h.prototype._doAPIRequest=function(a,d,b,g){var e=
this;this.accessToken?this._doJsonRequest(a,d,b,function(c,h){c&&2==c.code&&401==c.status?e._renewAccessToken(function(c){c?g(c):e._doJsonRequest(a,d,b,function(a,b){g(a,b)})}):g(c,h)}):this._renewAccessToken(function(c){c?g(c):e._doJsonRequest(a,d,b,function(a,b){g(a,b)})})};h.prototype._doJsonRequest=function(a,d,b,g){this._doRequest(a,d,{Authorization:"Bearer "+this.accessToken},b?JSON.stringify(b):null,function(a,b,d){if(a)g(a);else if(b)try{var c=JSON.parse(b);if(200!=d){var e=c.error?c.error.code?
c.error.code:0:0;a=Error(c.error?c.error.message?c.error.message:"invalid error response":"invalid error response");a.code=e;a.status=d;g(a)}else g(null,c)}catch(r){g(r)}else g(Error("invalid response"))})};h.prototype._doRequest=function(a,d,b,g,e){a={host:"api.netatmo.net",port:443,path:d,method:a,headers:{Connection:"close","Content-Type":"application/json; charset=UTF-8"}};if(b)for(var c in b)a.headers[c]=b[c];b=require("https");c=JSON.parse(JSON.stringify(a));c.headers&&(c.headers.auth&&(c.headers.auth=
"*********"),c.headers.Authorization&&(c.headers.Authorization="*********"));c.auth&&(c.auth="********");this._logger.log("trace","do request:"+JSON.stringify(c));var h=this,f=e,m=b.request(a,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){h._logger.log("trace","receive code:"+a.statusCode+" headers:"+JSON.stringify(a.headers)+" response:"+b);f&&(f(null,b,a.statusCode),f=null)})});if(m.on)m.on("error",function(a){h._logger.log("trace","do request error:"+
a.message);f&&(f(a),f=null)});m.setTimeout&&m.setTimeout(2E3,function(){h._logger.log("trace","do request timeout");m.abort();f&&(f(Error("timeout")),f=null)});g&&(this._logger.log("trace","send body:"+g),m.write(g));m.end()};h.prototype._doUrlRequest=function(a,d,b,g){var e=this,c=g,h=null;try{h=JSON.parse(JSON.stringify(b)),h.username&&(h.username="xxxxxx"),h.password&&(h.password="xxxxxx")}catch(f){h=b}this._logger.log("trace","send "+a+" req to:"+d+" data:"+JSON.stringify(h));$.ajax({url:d,type:a,
timeout:1E4,dataType:"json",data:b,cache:!1,success:function(a){e._logger.log("trace","http request success:"+JSON.stringify(a));g&&g(null,a)},error:function(a,b,d){b="http request error:"+(a?a.status:"0")+"-"+b;e._logger.log("warn","http request error:"+b);b=Error(b);d&&(e._logger.log("warn","http request http error:"+d),b.httpError=!0,b.statusCode=a?a.status:0);c&&(c(b,a?a.responseText:null),c=null)}})};return h}();
xnm.aio.netatmo.DM=function(){var m=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};m.prototype=Error();m.prototype.name="NetatmoDmError";m.prototype.code=0;m.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var h=m.ERROR_CODE,a=[{type:"float",name:"absolute pressure",ref:{value:"absPres",value_t:"pressureAbsolute"}},{type:"int",name:"co2",ref:{value:"co2"}},{type:"int",name:"humidity",ref:{value:"hum"}},{type:"int",name:"noise",ref:{value:"noise"}},
{type:"float",name:"pressure",ref:{value:"pres",value_t:"pressure"}},{type:"float",name:"rain",ref:{value:"rain"}},{type:"float",name:"rain last hour",ref:{value:"rain1h"}},{type:"float",name:"rain last 24 hours",ref:{value:"rain24h"}},{type:"float",name:"temperature",ref:{value:"temp"}},{type:"int",name:"time max temperatue",ref:{value:"timeMaxTemp"}},{type:"int",name:"time min temperatue",ref:{value:"timeMinTemp"}},{type:"float",name:"max temperatue",ref:{value:"maxTemp"}},{type:"float",name:"min temperatue",
ref:{value:"minTemp"}},{type:"int",name:"wind direction",ref:{value:"winD"}},{type:"float",name:"wind speed",ref:{value:"winS"}},{type:"int",name:"gust wind direction",ref:{value:"gwinD"}},{type:"float",name:"gust wind speed",ref:{value:"gwinS"}},{type:"int",name:"last measure time",ref:{value:"mesureT",value_t:"lastMeasureTime"}},{type:"int",name:"time max wind",ref:{value:"timeMaxWind"}},{type:"int",name:"max wind direction",ref:{value:"maxWinD"}},{type:"float",name:"max wind speed",ref:{value:"maxWinS"}},
{type:"float",name:"rf level",ref:{value:"rf"}},{type:"enum",name:"rf status",ref:{value:"rfStatus",options:["very_low","low","medium","high","full"]}},{type:"float",name:"battery level",ref:{value:"bat",value_t:"battery_level",extMeta:"3000-6000"}},{type:"enum",name:"battery status",ref:{value:"batStatus",value_t:"battery_state",options:["very_low","low","medium","high","full"]}},{type:"float",name:"wifi level",ref:{value:"wifi"}},{type:"enum",name:"wifi status",ref:{value:"wifiStatus",options:["bad",
"middle","good","very_good"]}},{type:"enum",name:"mode",ref:{value:"mode",options:"auto away frost-guard manu off boost".split(" ")}},{type:"float",name:"manual temperature",ref:{value:"manuT",extMeta:"5.5-30",scale:"0.5"}},{type:"int",name:"manual/boost endtime",ref:{value:"tempEnd"}},{type:"float",name:"measured temperature",ref:{value:"currentTemp"}},{type:"int",name:"manual/boost duration",ref:{value:"tempDuration",extMeta:"15-720",scale:"15"}},{type:"string",name:"manual/boost endtime string",
ref:{value:"tempEndStr"}},{type:"string",name:"time string max temperatue",ref:{value:"timeMaxTempStr"}},{type:"string",name:"time string min temperatue",ref:{value:"timeMinTempStr"}},{type:"string",name:"last measure time string",ref:{value:"mesureTStr",value_t:"lastMeasureTimeStr"}},{type:"string",name:"time string max wind",ref:{value:"timeMaxWindStr"}},{type:"float",name:"felt temperature",ref:{value:"tempFelt"}},{type:"string",name:"wind direction named",ref:{value:"winDName",options:"N NO O SO S SW W NW".split(" ")}},
{type:"enum",name:"temperature trend",ref:{value:"tempTrend",options:["up","down","stable"]}},{type:"enum",name:"pressure trend",ref:{value:"presTrend",value_t:"pressureTrend",options:["up","down","stable"]}},{type:"enum",name:"health index",ref:{value:"healthIdx",options:["healthy","fine","fair","poor","unhealthy"]}},{type:"int",name:"health index level",ref:{value:"healthIdxLvl",extMeta:"0-4"}}],d=[{type:"enum",name:"auto",ref:{value:"thermoAuto"}},{type:"enum",name:"away",ref:{value:"thermoAway"}},
{type:"enum",name:"frost-guard",ref:{value:"thermoHg"}},{type:"enum",name:"off",ref:{value:"thermoOff"}},{type:"enum",name:"max",ref:{value:"thermoMax"}},{type:"float",name:"manu",ref:{value:"thermoManu",ext:"%f",extMeta:"5.5-30",scale:"0.5"}},{type:"enum",name:"up",ref:{value:"thermoUp"}},{type:"enum",name:"down",ref:{value:"thermoDown"}},{type:"int",name:"manual/boost duration",ref:{value:"tempDuration",ext:"%d",extMeta:"15-720",scale:"15"}}],b={command:[{type:"enum",name:"auto",ref:{value:"thermoAuto"}},
{type:"enum",name:"up",ref:{value:"thermoUp"}},{type:"enum",name:"down",ref:{value:"thermoDown"}},{type:"float",name:"manu",ref:{value:"thermoManu",ext:"%f",extMeta:"7-30",scale:"0.5"}},{type:"multi",name:"manu until",ref:{value:"thermoManuUntil",ext:"%multi",extMeta:[{type:"float",name:"temperature",ref:{value:"temp",ext:"%f",extMeta:"7-30",scale:"0.5"}},{type:"time",name:"end time",ref:{value:"endtime",ext:"%time"}}]}}],status:[{type:"enum",name:"mode",ref:{value:"mode",options:"manual max off schedule away hg".split(" ")}},
{type:"float",name:"setpoint temperature",ref:{value:"manuT",value_t:"setTemperature",extMeta:"7-30",scale:"0.5"}},{type:"int",name:"mode end time",ref:{value:"tempEnd"}},{type:"string",name:"mode end time string",ref:{value:"tempEndStr"}},{type:"float",name:"measured temperature",ref:{value:"currentTemp"}}]},g={command:[{type:"enum",name:"auto",ref:{value:"thermoAuto"}},{type:"enum",name:"away",ref:{value:"thermoAway"}},{type:"time",name:"away until",ref:{value:"thermoAwayUntil",ext:"%time"}},{type:"enum",
name:"frost-guard",ref:{value:"thermoHg"}},{type:"time",name:"frost-guard until",ref:{value:"thermoHgUntil",ext:"%time"}}],status:[{type:"enum",name:"mode",ref:{value:"mode",options:["schedule","away","frost_guard"]}},{type:"int",name:"mode end time",ref:{value:"tempEnd"}},{type:"string",name:"mode end time string",ref:{value:"tempEndStr"}}]};return{SYS:"netatmo",getGatewayType:function(){return[{sys:this.SYS,name:"Netatmo (Online)",port:443}]},getGatewayDeviceType:function(a){return[{sys:this.SYS,
type:"NAMain",name:"Base Station"},{sys:this.SYS,type:"NAModule1",name:"Outdoor module"},{sys:this.SYS,type:"NAModule4",name:"Additional indoor module"},{sys:this.SYS,type:"NAModule3",name:"Rain gauge module"},{sys:this.SYS,type:"NAModule2",name:"Wind gauge module"},{sys:this.SYS,type:"NATherm1",name:"Thermostat"},{sys:this.SYS,type:"NHC",name:"Home Coach"}]},_checkInfo:function(a,b,d){if(a)if(a.gateway)if(a.type)if(a.address)if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;
var c;for(c=0;c<b.length;c++)if(b[c].index===a.gateway){var e=b[c];break}e?d():d(new m(h.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else d(new m(h.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else d(new m(h.INVALID,"address is invalid"));else d(new m(h.INVALID,"type is invalid"));else d(new m(h.INVALID,"gateway is invalid"));else d(new m(h.INVALID,"info is invalid"))},createGateway:function(a,b,d){a?a.refreshToken||a.username&&a.password?d(null,a):d(new m(h.INVALID,"refreshToken is invalid")):
d(new m(h.INVALID,"info is invalid"))},updateGateway:function(a,b,d,f){b?b.refreshToken||b.username&&b.password?f(null,b):f(new m(h.INVALID,"refreshToken is invalid")):f(new m(h.INVALID,"info is invalid"))},deleteGateway:function(a,b,d){d()},createDevice:function(a,b,d){this._checkInfo(a,b,function(b){d(b,a)})},updateDevice:function(a,b,d){this._checkInfo(a,b,function(b){d(b,a)})},deleteDevice:function(a,b,d){d(null,a)},applyUIFilter:function(a,b){var c=function(a,b){if("*"==a)return!0;for(var c=
!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},d=function(a,b,d){var e=[];switch(d.catagory){case "command":a.command&&a.command.forEach(function(a){c(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){c(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},e=function(a,b){var c=[],e=this.getCommandStatusMap(a);e&&(a=d(e,a,b),c=c.concat(a));return c};if(!a.sys)return null;var g=JSON.parse(JSON.stringify(a)),
h=null;switch(b.catagory){case "command":h=e.call(this,a,b);g.command=h;break;case "status":h=e.call(this,a,b);g.status=h;break;default:return null}return h&&0!=h.length?g:null},applyIPEventFilter:function(a,b){if(!a.sys)return null;b=JSON.parse(JSON.stringify(a));a=this.getIPevtMap(a);if(!a)return b;b.ipevt=a.ipevt;return b},getCommandStatusMap:function(b){var c={command:[],status:[]};switch(b.type){case "NAMain":c.status.push(a[25]);c.status.push(a[26]);break;case "NAModule1":case "NAModule2":case "NAModule3":case "NAModule4":case "NATherm1":c.status.push(a[21]);
c.status.push(a[22]);c.status.push(a[23]);c.status.push(a[24]);"NATherm1"==b.type&&(c.status.push(a[27]),c.status.push(a[28]),c.status.push(a[29]),c.status.push(a[30]),c.status.push(a[31]),c.status.push(a[32]));break;case "NHC":c.status.push(a[25]),c.status.push(a[26])}"NATherm1"==b.type&&(c.command=d);if(b.dashboard_data)for(var e in b.dashboard_data)if(b.dashboard_data.hasOwnProperty(e))switch(e){case "AbsolutePressure":c.status.push(a[0]);break;case "CO2":c.status.push(a[1]);break;case "Humidity":c.status.push(a[2]);
c.status.push(a[37]);break;case "Noise":c.status.push(a[3]);break;case "Pressure":c.status.push(a[4]);break;case "Rain":c.status.push(a[5]);break;case "sum_rain_1":c.status.push(a[6]);break;case "sum_rain_24":c.status.push(a[7]);break;case "Temperature":c.status.push(a[8]);break;case "date_max_temp":c.status.push(a[9]);c.status.push(a[33]);break;case "date_min_temp":c.status.push(a[10]);c.status.push(a[34]);break;case "max_temp":c.status.push(a[11]);break;case "min_temp":c.status.push(a[12]);break;
case "WindAngle":c.status.push(a[13]);c.status.push(a[38]);break;case "WindStrength":c.status.push(a[14]);break;case "GustAngle":c.status.push(a[15]);break;case "GustStrength":c.status.push(a[16]);break;case "time_utc":c.status.push(a[17]);c.status.push(a[35]);break;case "date_max_wind_str":c.status.push(a[18]);c.status.push(a[36]);break;case "max_wind_angle":c.status.push(a[19]);break;case "max_wind_str":c.status.push(a[20]);break;case "temp_trend":c.status.push(a[39]);break;case "pressure_trend":c.status.push(a[40]);
break;case "health_idx":c.status.push(a[41]),c.status.push(a[42])}return c},getCommandStatusMap2:function(d){var c={command:[],status:[]},e=null;switch(d.type){case "NAMain":e="time_utc Temperature CO2 Humidity Noise Pressure AbsolutePressure min_temp max_temp date_min_temp date_max_temp temp_trend pressure_trend".split(" ");c.status.push(a[25]);c.status.push(a[26]);break;case "NAModule1":e="time_utc Temperature Humidity min_temp max_temp date_min_temp date_max_temp temp_trend".split(" ");c.status.push(a[21]);
c.status.push(a[22]);c.status.push(a[23]);c.status.push(a[24]);break;case "NAModule2":e="time_utc WindStrength WindAngle GustStrength GustAngle max_wind_str max_wind_angle date_max_wind_str".split(" ");c.status.push(a[21]);c.status.push(a[22]);c.status.push(a[23]);c.status.push(a[24]);break;case "NAModule3":e=["time_utc","Rain","sum_rain_24","sum_rain_1"];c.status.push(a[21]);c.status.push(a[22]);c.status.push(a[23]);c.status.push(a[24]);break;case "NAModule4":e="time_utc Temperature CO2 Humidity Pressure AbsolutePressure min_temp max_temp date_min_temp date_max_temp temp_trend".split(" ");
c.status.push(a[21]);c.status.push(a[22]);c.status.push(a[23]);c.status.push(a[24]);break;case "NATherm1":c.status.push(a[21]);c.status.push(a[22]);c.status.push(a[23]);c.status.push(a[24]);break;case "NRV":c.status.push(a[21]);c.status.push(a[22]);c.status.push(a[23]);c.status.push(a[24]);break;case "NAPlug":c.status.push(a[21]);c.status.push(a[22]);c.status.push(a[25]);c.status.push(a[26]);break;case "NHC":e="time_utc Temperature CO2 Humidity Noise Pressure AbsolutePressure health_idx min_temp max_temp date_min_temp date_max_temp".split(" ");
c.status.push(a[25]);c.status.push(a[26]);break;case "room":c=b;break;case "home":c=g}e&&e.forEach(function(b){switch(b){case "AbsolutePressure":c.status.push(a[0]);break;case "CO2":c.status.push(a[1]);break;case "Humidity":c.status.push(a[2]);c.status.push(a[37]);break;case "Noise":c.status.push(a[3]);break;case "Pressure":c.status.push(a[4]);break;case "Rain":c.status.push(a[5]);break;case "sum_rain_1":c.status.push(a[6]);break;case "sum_rain_24":c.status.push(a[7]);break;case "Temperature":c.status.push(a[8]);
break;case "date_max_temp":c.status.push(a[9]);c.status.push(a[33]);break;case "date_min_temp":c.status.push(a[10]);c.status.push(a[34]);break;case "max_temp":c.status.push(a[11]);break;case "min_temp":c.status.push(a[12]);break;case "WindAngle":c.status.push(a[13]);c.status.push(a[38]);break;case "WindStrength":c.status.push(a[14]);break;case "GustAngle":c.status.push(a[15]);break;case "GustStrength":c.status.push(a[16]);break;case "time_utc":c.status.push(a[17]);c.status.push(a[35]);break;case "date_max_wind_str":c.status.push(a[18]);
c.status.push(a[36]);break;case "max_wind_angle":c.status.push(a[19]);break;case "max_wind_str":c.status.push(a[20]);break;case "temp_trend":c.status.push(a[39]);break;case "pressure_trend":c.status.push(a[40]);break;case "health_idx":c.status.push(a[41]),c.status.push(a[42])}});return c},getIPevtMap:function(a){return(a=this.getCommandStatusMap(a))?{ipevt:a.status}:null},calcFeltTemp:function(a,b,d){if(d&&"object"==typeof d&&0===d.feel_like_algo)d=243.5,b=Math.log(.01*b)+17.67*a/(d+a),b=a+.5555*
(6.11*Math.exp(5417.753*(1/273.16-1/(d*b/(17.67-b)+273.15)))-10);else{d=[-42.379,2.04901523,10.14333127,-.22475541,-.00683783,-.05481717,.00122874,8.5282E-4,-1.99E-6];a=9*a/5+32;var c=a*a,e=b*b;b=d[0]+d[1]*a+d[2]*b+d[3]*a*b+d[4]*c+d[5]*e+d[6]*c*b+d[7]*a*e+d[8]*c*e;b=5*(b-32)/9}return Math.round(10*b)/10},supportSmartWidget:function(a){return a&&a.type?0<=["home","room"].indexOf(a.type):!1},applySmartWidgetFilter:function(a,b,d,f,g){if(!b||!b.type)return!1;d=[];if("home"===b.type){b={"%auto%":{value:"thermoAuto"},
"%away%":{value:"thermoAway"},"%awayUntil%":{value:"thermoAwayUntil",ext:"%time"},"%frostGuard%":{value:"thermoHg"},"%frostGuardUntil%":{value:"thermoHgUntil",ext:"%time"}};var c={"%mode%":{value:"mode",options:["schedule","away","frost_guard"]}};d.push("netatmo_thermo")}else if("room"===b.type)b={"%auto%":{value:"thermoAuto"},"%thermoUp%":{value:"thermoUp"},"%thermoDown%":{value:"thermoDown"},"%thermoManu%":{value:"thermoManu",ext:"%f",extMeta:"7-30",scale:.5}},c={"%mode%":{value:"mode",options:"manual max off schedule away hg".split(" ")},
"%setTemp%":{value:"manuT",extMeta:"7-30",scale:.5},"%currentTemp%":{value:"currentTemp"}},d.push("netatmo_thermo");else return!1;return a._injectToSmartWidgetTemplate(f,d,g,b,c)}}}();xnm.aio.netatmo.DM.getCommandStatusMap=xnm.aio.netatmo.DM.getCommandStatusMap2;xnm.aio.netatmo.Cloud=xnm.aio.netatmo.Client;
xnm.aio.netatmo.Handler=function(){var m=function(){this._updateListener=[]};m.prototype.Client=xnm.aio.netatmo.Client;m.prototype.Cloud=xnm.aio.netatmo.Cloud;m.prototype.MNetatmo=xnm.aio.netatmo.MNetatmo;m.prototype.devicemanager=xnm.aio.netatmo.DM;m.prototype.registModule=function(h){h.register(this.devicemanager.SYS,"netatmo")};m.prototype.resolveGateway=function(h){return h.refreshToken||h.username&&h.password?new xnm.aio.netatmo.Cloud(h.username,h.password,h.refreshToken):null};m.prototype.getDeviceCommands=
function(h,a){h=(h=xnm.aio.netatmo.DM.applyUIFilter(h,{catagory:"command",elems:"*"}))?h.command:[];a&&a(null,h)};m.prototype.getDeviceStatus=function(h,a){h=(h=xnm.aio.netatmo.DM.applyUIFilter(h,{catagory:"status",elems:"*"}))?h.status:[];a&&a(null,h)};m.prototype.login=function(h,a){(h=this.resolveGateway(h))?h.auth(function(d,b){d?a&&a(d):a&&a(d,{refreshToken:b.refresh_token})}):a&&a(Error("gateway json format invalid"))};m.prototype.doCommand=function(h,a,d,b){(h=this.resolveGateway(h))?h.executeCommandCreator(a,
d,function(a){b&&b(a)}):b&&b(Error("gateway json format invalid"))};m.prototype.doStatus=function(h,a,d,b,g){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:h,device:d,status:b}],function(a,b){a?g&&g(a):g&&g(null,b[0])}):g&&g(Error("gateway json format invalid"))};m.prototype.getDeviceList=function(h,a){(h=this.resolveGateway(h))?h.getDeviceList(a):a&&a(Error("gateway json format invalid"))};m.prototype.getCamList=function(h,a){(h=this.resolveGateway(h))?h.getCamList(a):a&&a(Error("gateway json format invalid"))};
m.prototype.pause=function(h){xnm.aio.netatmo.Cloud.pause(h)};m.prototype.addUpdateListener=function(h){h&&-1==this._updateListener.indexOf(h)&&this._updateListener.push(h)};m.prototype.getDevice=function(h){return new this.MNetatmo(h)};m.prototype.setMNetatmoCloudUrl=function(h){this.MNetatmo.CLOUD_URL=h};return m}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.netatmo.Handler);
