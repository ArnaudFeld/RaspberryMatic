var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.netatmo=xnm.aio.netatmo||{};
xnm.aio.netatmo.Cloud=function(){var k={},e={},f={},t={},g=function(a){return a.refreshToken?a.refreshToken:a.user?e[a.user]:null},c=function(a){var b=g(a);if(!b)return null;k[b]||(k[b]={cloud:a});return k[b].cred?k[b].cred:{refresh_token:b}},m=function(a,b){var d=b.refresh_token;a.refreshToken||(a.refreshToken=d);a.user&&(e[a.user]=d);k[d]||(k[d]={cloud:a});k[d].cred=b;b.expires_in&&(b._expireTime=(new Date).getTime()+1E3*b.expires_in-6E5)},r=function(a){return(a=c(a))&&a._expireTime?(new Date).getTime()>
a._expireTime:!1},w=function(a){var b=g(a);if(!b)return null;k[b]||(k[b]={cloud:a});k[b].weather||(k[b].weather={updateData:{running:!1,error:null}});return k[b].weather},x=function(a){a=w(a);a.timer&&clearTimeout(a.timer);a.updateData={running:!0,error:null}},u=function(a,b,d){var l=g(a),h=w(a);h.updateData={running:!1,error:b};try{if(!b&&d){var c=require("xnm.aio.netatmo.js")._updateListener;if(c&&0<c.length)for(var n=0;n<c.length;n++)c[n]&&c[n].updateWeather&&c[n].updateWeather(a,h.data,d)}}catch(A){}h.timer&&
clearTimeout(h.timer);c=y(a);b?h.data=null:d&&(h.data=d);d=h.tmpCBs;h.tmpCBs=[];if(d)for(n=0;n<d.length;n++)if(b)d[n](b);else a.getWeatherStatus(d[n]);b?h.timer=setTimeout(function(){k[l].cloud.getStationsData(null)},6E4):(a=y(a),c&&a&&c==a&&1>h.retry?(h.retry=h.retry?h.retry+1:1,c=60*h.retry,h.delay=c,h.timer=setTimeout(function(){k[l].cloud.getStationsData(null)},1E3*c)):(h.retry=0,(b=h.delay)||(b=0),c=6E5,a&&(d=Math.round((new Date).getTime()/1E3),d>a&&(c=600-(d-a)%600+30)),require("x.logger.js").getLogger("xnm.aio.netatmo.Cloud").log("debug",
"weather station next poll in t:"+c/60+" min delay:"+b),h.timer=setTimeout(function(){k[l].cloud.getStationsData(null)},1E3*c+1E3*b)))},y=function(a){a=w(a);if(!a.data)return 0;for(var b=0;b<a.data.length;b++)if(a.data[b]&&a.data[b].dashboard_data&&a.data[b].dashboard_data.time_utc)return a.data[b].dashboard_data.time_utc;return 0},z=function(a){var b=g(a);if(!b)return null;k[b]||(k[b]={cloud:a});k[b].homecoach||(k[b].homecoach={updateData:{running:!1,error:null}});return k[b].homecoach},F=function(a){a=
z(a);a.timer&&clearTimeout(a.timer);a.updateData={running:!0,error:null}},C=function(a,b,d){var c=g(a),h=z(a);h.updateData={running:!1,error:b};try{if(!b&&d){var e=require("xnm.aio.netatmo.js")._updateListener;if(e&&0<e.length)for(var n=0;n<e.length;n++)e[n]&&e[n].updateHomeCoach&&e[n].updateHomeCoach(a,h.data,d)}}catch(A){}h.timer&&clearTimeout(h.timer);e=B(a);b?h.data=null:d&&(h.data=d);d=h.tmpCBs;h.tmpCBs=[];if(d)for(n=0;n<d.length;n++)if(b)d[n](b);else a.getWeatherStatus(d[n]);b?h.timer=setTimeout(function(){k[c].cloud.getHomeCoachsData(null)},
6E4):(a=B(a),e&&a&&e==a&&1>h.retry?(h.retry=h.retry?h.retry+1:1,e=60*h.retry,h.delay=e,h.timer=setTimeout(function(){k[c].cloud.getHomeCoachsData(null)},1E3*e)):(h.retry=0,(b=h.delay)||(b=0),e=6E5,a&&(d=Math.round((new Date).getTime()/1E3),d>a&&(e=600-(d-a)%600+30)),h.timer=setTimeout(function(){k[c].cloud.getHomeCoachsData(null)},1E3*e+1E3*b)))},B=function(a){a=z(a);if(!a.data)return 0;for(var b=0;b<a.data.length;b++)if(a.data[b]&&a.data[b].dashboard_data&&a.data[b].dashboard_data.time_utc)return a.data[b].dashboard_data.time_utc;
return 0},v=function(a){var b=g(a);if(!b)return null;k[b]||(k[b]={cloud:a});k[b].thermo||(k[b].thermo={updateData:{running:!1,error:null}});return k[b].thermo},G=function(a){a=v(a);a.timer&&clearTimeout(a.timer);a.updateData={running:!0,error:null}},D=function(a,b,d){var c=g(a),h=v(a);try{if(!b&&d){var e=require("xnm.aio.netatmo.js")._updateListener;if(e&&0<e.length)for(var n=0;n<e.length;n++)e[n]&&e[n].updateThermo&&e[n].updateThermo(a,h.data,d)}}catch(A){}h.timer&&clearTimeout(h.timer);h.updateData=
{running:!1,error:b};b?h.data=null:d&&(h.data=d);d=h.tmpCBs;h.tmpCBs=[];if(d)for(e=0;e<d.length;e++)if(b)d[e](b);else a.getThermoStatus(d[e]);h.timer=b?setTimeout(function(){k[c].cloud.getThermostatsData(null)},6E4):setTimeout(function(){k[c].cloud.getThermostatsData(null)},18E5)},E=function(a,b){var d=g(a);if(!b.module)return 60;a=v(a);a.duration||(k[d].thermo.duration={});d=a.duration[b.module];if(!d){a:{if(b.module&&XC&&XC.localStorage){if(d=XC.localStorage.getItem("netatmo"))try{d=JSON.parse(d)}catch(l){}if(d&&
d.duration){d=d.duration[b.module];break a}}d=null}a.duration[b.module]=d}d||(d=60);return d},H=function(a,b,d){a=v(a);a.duration||(a.duration={});if(b.module&&(a.duration[b.module]=d,b.module&&XC&&XC.localStorage)){if(a=XC.localStorage.getItem("netatmo"))try{a=JSON.parse(a)}catch(l){}a&&"object"==typeof a||(a={});a.duration||(a.duration={});a.duration[b.module]=d;XC.localStorage.setItem("netatmo",JSON.stringify(a))}},I=function(a,b){a=v(a);if(a.data)for(var d=0;d<a.data.length;d++){var c=a.data[d];
if(c&&c._id==b.address&&c.modules)for(var h=0;h<c.modules.length;h++){var e=c.modules[h];if(e&&e._id==b.module)return e.setpoint}}return null},p=function(a,b,d){this._logger=require("x.logger.js").getLogger("xnm.aio.netatmo.Cloud");this.user=a;this.password=b;this.refreshToken=d;this._scope="read_station read_thermostat read_homecoach write_thermostat read_camera access_camera read_presence access_presence".split(" ");this._scopeFallback="read_station read_thermostat read_homecoach write_thermostat read_camera access_camera read_presence".split(" ")};
p.prototype.executeCommandCreator=function(a,b,d){if(b&&b.value){var c=this,h={},e=E(this,a);I(this,a);switch(b.value){case "thermoAuto":h.setpoint_mode="program";break;case "thermoAway":h.setpoint_mode="away";break;case "thermoHg":h.setpoint_mode="hg";break;case "thermoOff":h.setpoint_mode="off";break;case "thermoMax":h.setpoint_mode="max";h.setpoint_endtime=Math.round(((new Date).getTime()+6E4*e)/1E3);break;case "thermoManu":if(null==b.ext||"undefined"==typeof b.ext){d&&d(Error("command ext invalid"));
return}var n=b.ext;"string"==typeof b.ext&&(n=parseFloat(b.ext));5.5>n&&(n=5.5);30<n&&(n=30);h.setpoint_mode="manual";h.setpoint_endtime=Math.round(((new Date).getTime()+6E4*e)/1E3);h.setpoint_temp=n;break;case "tempDuration":if(null==b.ext||"undefined"==typeof b.ext){d&&d(Error("command ext invalid"));return}e=b.ext;"string"==typeof b.ext&&(e=parseFloat(b.ext));15>e&&(e=15);720<e&&(e=720);H(this,a,e);d&&d();return;default:d&&d(Error("unknow command"))}this.setThermPoint(a,h,function(b){if(b)d&&d(b);
else{b=v(c);b.data||(b.data=[]);var e;for(e=0;e<b.data.length;e++)if(b.data[e]&&b.data[e]._id==a.address){var l=b.data[e];break}l||(l={_id:a.address,modules:[]},b.data.push(l));for(e=0;e<l.modules.length;e++)if(l.modules[e]&&l.modules[e]._id==a.module){var n=l.modules[e];break}n||(n={_id:a.module},l.modules.push(n));n.setpoint=h;d&&d()}})}else d&&d(Error("command format invalid"))};p.prototype.getStatesCreator=function(a,b,d){b?this.getAllStatus(function(a,h){for(var c=[],e=0;e<b.length;e++){var l=
b[e];if(l.id){var g,q="?";if(!a&&h&&l.device&&l.device.type&&(g="NAMain"==l.device.type||"NHC"==l.device.type?l.device.address:l.device.address+"|"+l.device.module)&&l.status&&l.status.value&&(g=h[g]))if("tempFelt"==l.status.value)q=g.temp,g=g.hum,q="undefined"!=typeof q&&"undefined"!=typeof g?"NHC"==l.device.type?xnm.aio.netatmo.DM.calcFeltTemp(q,g,t):xnm.aio.netatmo.DM.calcFeltTemp(q,g,f):"?";else if("winDName"==l.status.value)q=g.winD,null===q||"undefined"==typeof q?q="?":(q=Number(q),q=isNaN(q)?
"?":23<q&&68>=q?"NO":68<q&&113>=q?"O":113<q&&158>=q?"SO":158<q&&203>=q?"S":203<q&&248>=q?"SW":248<q&&293>=q?"W":293<q&&338>=q?"NW":"N");else if(q=g[l.status.value],null==q||"undefined"==typeof q)q="?";c.push({id:l.id,status:q})}}d&&d(null,c)}):d&&d(Error("deviceList is null"))};p.prototype.getAllStatus=function(a){var b=this,d={};this.getWeatherStatus(function(c,h){c?a&&a(c):b.getThermoStatus(function(c,e){c?a&&a(c):b.getHomeCoachStatus(function(b,c){if(b)a&&a(b);else{for(var l in h)h.hasOwnProperty(l)&&
(d[l]=h[l]);for(l in e)e.hasOwnProperty(l)&&(d[l]=e[l]);for(l in c)c.hasOwnProperty(l)&&(d[l]=c[l]);a&&a(null,d)}})})})};p.prototype.getDeviceList=function(a){var b=this;this.getStationsData(function(d,c){d?a&&a(d):b.getThermostatsData(function(d,e){d?a&&a(d):b.getHomeCoachsData(function(b,d){if(b)a&&a(b);else{b={weather:[],thermostat:[]};if(c){for(var h=[],l=0;l<c.length;l++){var g=c[l];if(g&&g._id&&g.type){var f=g.station_name,n=g.module_name,m={address:g._id,type:g.type,name:f+" ("+n+")"};m.dashboard_data=
g.dashboard_data;m.modules=[];if(g.modules)for(var k=0;k<g.modules.length;k++)g.modules[k]&&g.modules[k]._id&&g.modules[k].type&&(n=g.modules[k].module_name,m.modules.push({address:g._id,module:g.modules[k]._id,type:g.modules[k].type,name:f+" ("+n+")",dashboard_data:g.modules[k].dashboard_data}));h.push(m)}}b.weather=h}if(e){h=[];for(l=0;l<e.length;l++)if((g=e[l])&&g._id&&g.type&&(f=g.station_name,g.modules))for(m=0;m<g.modules.length;m++)g.modules[m]&&g.modules[m]._id&&g.modules[m].type&&(n=g.modules[m].module_name,
h.push({address:g._id,module:g.modules[m]._id,type:g.modules[m].type,name:f+" ("+n+")"}));b.thermostat=h}if(d){h=[];for(l=0;l<d.length;l++)(g=d[l])&&g._id&&g.type&&(f=g.module_name,n={address:g._id,type:g.type,name:g.name},f&&(n.name+=" ("+f+")"),n.dashboard_data=g.dashboard_data,n.modules=[],h.push(n));b.homecoach=h}a&&a(null,b)}})})})};p.prototype.getCamList=function(a){var b=this;this.getCamsData(function(d,e){if(d)a&&a(d);else{d={cam:[]};if(e){for(var h=[],g=0;g<e.length;g++)if(e[g]&&e[g].id){var l=
e[g].name,f=e[g].cameras;if(f)for(var m=0;m<f.length;m++)if(f[m]&&f[m].id){var k="welcome";"NACamera"==f[m].type?k="welcome":"NOC"==f[m].type&&(k="presence");k&&(k={sys:"cam",type:"system",manufacturer:"netatmo",model:k,address:f[m].id},f[m].name&&(k.name=f[m].name+(l?" ("+l+")":"")),h.push(k))}}d.cam=h}e=c(b);if(d.cam&&0<d.cam.length)for(h=0;h<d.cam.length;h++)d.cam[h].refreshToken=e.refresh_token;a&&a(null,d)}})};p.prototype.getWeatherStatus=function(a){var b=function(a,b){var d={};if(b)for(var h=
0;h<b.length;h++){var c=b[h];if(c&&c._id){var e=a._resolveStationStatus(c);e&&(d[c._id]=e);if(c.modules)for(var g=0;g<c.modules.length;g++)(e=a._resolveModuleStatus(c.modules[g]))&&(d[c._id+"|"+c.modules[g]._id]=e)}}return d};this._logger.log("debug","getWeatherStatus");var d=w(this),c=this,h=a;a=null;d&&d.data?(a=b(this,d.data),h&&h(null,a),h=null):this.getStationsData(function(a){a?(h&&h(a),h=null):h&&c.getWeatherStatus(h)})};p.prototype.getHomeCoachStatus=function(a){var b=function(a,b){var d=
{};if(b)for(var h=0;h<b.length;h++){var c=b[h];if(c&&c._id){var e=a._resolveHomeCoachStatus(c);e&&(d[c._id]=e)}}return d};this._logger.log("debug","getHomeCoachStatus");var d=z(this),c=this,h=a;a=null;d&&d.data?(a=b(this,d.data),h&&h(null,a),h=null):this.getHomeCoachsData(function(a){a?(h&&h(a),h=null):h&&c.getHomeCoachStatus(h)})};p.prototype.getThermoStatus=function(a){var b=function(a,b){for(var d={},h=0;h<b.length;h++){var c=b[h];if(c&&c._id&&c.modules)for(var e=0;e<c.modules.length;e++){var g=
a._resolveModuleStatus(c.modules[e]);g&&(d[c._id+"|"+c.modules[e]._id]=g)}}return d},d=v(this),c=this,h=a,e=null;d.updateData.running?(d.tmpCBs||(d.tmpCBs=[]),d.tmpCBs.push(a)):d.data?(e=b(this,d.data),h&&h(null,e),h=null):this.getThermostatsData(function(a){a?(h&&h(a),h=null):h&&c.getThermoStatus(h)})};p.prototype.getCamUrl=function(a,b){var d=this;this._refreshToken(this.refreshToken,function(c,h){if(c)h&&h.error&&(c=Error(h.error),c._code="auth_error"),b&&b(c);else{if(h&&h.access_token)var e=h.access_token;
e?h&&h.scope&&-1==h.scope.indexOf("access_camera")?b&&b(null,"scop_error"):d._getCamsData(e,function(c,h){if(c)h&&h.error&&(c=Error(h.error),c._code="api_error"),b&&b(c);else if(c=null,h.body&&h.body.homes&&(c=h.body.homes),c){for(h=0;h<c.length;h++)if(c[h]&&c[h].cameras){for(var e=c[h].cameras,g=0;g<e.length;g++)if(e[g]&&e[g].id==a&&e[g].vpn_url){var l=e[g];break}if(l)break}l?1==l.is_local?d._getLocalCamUrl(l.vpn_url,function(a,d){b&&b(a,d)}):b&&b(null,l.vpn_url+"/live/index.m3u8"):b&&b("no cam with address:"+
a)}else b&&b("get cams data reponse invalid")}):b&&b(Error("auth response invalid"))}})};p.prototype._resolveStationStatus=function(a){var b={};null!=a.wifi_status&&"undefined"!=typeof a.wifi_status&&(b.wifi=a.wifi_status,b.wifiStatus=86<=b.wifi?"bad":71<=b.wifi?"middle":56<=b.wifi?"good":"very_good");if(a.dashboard_data&&(a=this._resolveDashboard(a.dashboard_data)))for(var d in a)a.hasOwnProperty(d)&&(b[d]=a[d]);return b};p.prototype._resolveModuleStatus=function(a){var b={};null!=a.rf_status&&"undefined"!=
typeof a.rf_status&&(b.rf=a.rf_status,b.rfStatus=90<=b.rf?"very_low":80<=b.rf?"low":70<=b.rf?"medium":60<=b.rf?"high":"full");if(null!=a.battery_vp&&"undefined"!=typeof a.battery_vp)switch(b.bat=a.battery_vp,a.type){case "NAModule4":b.batStatus=5640<=b.bat?"full":5280<=b.bat?"high":4920<=b.bat?"medium":4560<=b.bat?"low":"very_low";break;case "NAModule1":case "NAModule3":b.batStatus=5500<=b.bat?"full":5E3<=b.bat?"high":4500<=b.bat?"medium":4E3<=b.bat?"low":"very_low";break;case "NAModule2":b.batStatus=
5900<=b.bat?"full":5180<=b.bat?"high":4770<=b.bat?"medium":4360<=b.bat?"low":"very_low";break;case "NATherm1":b.batStatus=4100<=b.bat?"full":3600<=b.bat?"high":3300<=b.bat?"medium":3E3<=b.bat?"low":"very_low"}var d,c;if("NATherm1"==a.type&&(d=this._resolveThermoStat(a)))for(c in d)d.hasOwnProperty(c)&&(b[c]=d[c]);if(a.dashboard_data&&(d=this._resolveDashboard(a.dashboard_data)))for(c in d)d.hasOwnProperty(c)&&(b[c]=d[c]);return b};p.prototype._resolveHomeCoachStatus=function(a){var b={};null!=a.wifi_status&&
"undefined"!=typeof a.wifi_status&&(b.wifi=a.wifi_status,b.wifiStatus=86<=b.wifi?"bad":71<=b.wifi?"middle":56<=b.wifi?"good":"very_good");if(a.dashboard_data&&(a=this._resolveDashboard(a.dashboard_data)))for(var d in a)a.hasOwnProperty(d)&&(b[d]=a[d]);return b};p.prototype._resolveThermoStat=function(a){var b={};if(a.setpoint){switch(a.setpoint.setpoint_mode){case "program":var d="auto";break;case "away":d="away";break;case "hg":d="frost-guard";break;case "manual":d="manu";break;case "off":d="off";
break;case "max":d="boost"}d&&(b.mode=d);null!=a.setpoint.setpoint_temp&&"undefined"!=typeof a.setpoint.setpoint_temp&&(b.manuT=a.setpoint.setpoint_temp);if(null!=a.setpoint.setpoint_endtime&&"undefined"!=typeof a.setpoint.setpoint_endtime)if(b.tempEnd=a.setpoint.setpoint_endtime,b.tempEndStr=(new Date(1E3*a.setpoint.setpoint_endtime)).toLocaleString(),"undefined"!=typeof dateFormat&&dateFormat)try{b.tempEndStr=dateFormat(b.tempEndStr,"dd mm yyyy, HH:MM:ss")}catch(l){}else b.tempEndStr=b.tempEndStr.toLocaleString()}a.measured&&
(null!=a.measured.time&&"undefined"!=typeof a.measured.time&&(b.mesureT=a.measured.time),null!=a.measured.temperature&&"undefined"!=typeof a.measured.temperature&&(b.currentTemp=a.measured.temperature));b.tempDuration=E(this,{module:a._id});return b};p.prototype._resolveDashboard=function(a){var b=function(a,b){return null!=a[b]&&"undefined"!=typeof a[b]},d={};b(a,"AbsolutePressure")&&(d.absPres=a.AbsolutePressure);b(a,"CO2")&&(d.co2=a.CO2);b(a,"Humidity")&&(d.hum=a.Humidity);b(a,"Noise")&&(d.noise=
a.Noise);b(a,"Pressure")&&(d.pres=a.Pressure);b(a,"Rain")&&(d.rain=a.Rain);b(a,"sum_rain_1")&&(d.rain1h=a.sum_rain_1);b(a,"sum_rain_24")&&(d.rain24h=a.sum_rain_24);b(a,"Temperature")&&(d.temp=a.Temperature);if(b(a,"date_max_temp")){d.timeMaxTemp=a.date_max_temp;var c=1E3*a.date_max_temp;d.timeMaxTempStr=new Date(c);d.timeMaxTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(d.timeMaxTempStr,"dd mm yyyy, HH:MM:ss"):d.timeMaxTempStr.toLocaleString()}b(a,"date_min_temp")&&(d.timeMinTemp=a.date_min_temp,
c=1E3*a.date_min_temp,d.timeMinTempStr=new Date(c),d.timeMinTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(d.timeMinTempStr,"dd.mm.yyyy, HH:MM:ss"):d.timeMinTempStr.toLocaleString());b(a,"max_temp")&&(d.maxTemp=a.max_temp);b(a,"min_temp")&&(d.minTemp=a.min_temp);b(a,"WindAngle")&&(d.winD=a.WindAngle);b(a,"WindStrength")&&(d.winS=a.WindStrength);b(a,"GustAngle")&&(d.gwinD=a.GustAngle);b(a,"GustStrength")&&(d.gwinS=a.GustStrength);b(a,"time_utc")&&(d.mesureT=a.time_utc,c=1E3*a.time_utc,
d.mesureTStr=new Date(c),d.mesureTStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(d.mesureTStr,"dd.mm.yyyy, HH:MM:ss"):d.mesureTStr.toLocaleString());b(a,"date_max_wind_str")&&(d.timeMaxWind=a.date_max_wind_str,c=1E3*a.date_max_wind_str,d.timeMaxWindStr=new Date(c),d.timeMaxWindStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(d.timeMaxWindStr,"dd.mm.yyyy, HH:MM:ss"):d.timeMaxWindStr.toLocaleString());b(a,"max_wind_angle")&&(d.maxWinD=a.max_wind_angle);b(a,"max_wind_str")&&(d.maxWinS=
a.max_wind_str);b(a,"temp_trend")&&(d.tempTrend=a.temp_trend);b(a,"pressure_trend")&&(d.presTrend=a.pressure_trend);if(b(a,"health_idx"))switch(d.healthIdxLvl=a.health_idx,parseInt(d.healthIdx)){case 0:d.healthIdx="healthy";break;case 1:d.healthIdx="fine";break;case 2:d.healthIdx="fair";break;case 3:d.healthIdx="poor";break;case 4:d.healthIdx="unhealthy"}return d};p.prototype.auth=function(a){this._logger.log("debug","auth");var b=c(this),d=this;b?b.access_token?r(this)?this._refreshToken(b.refresh_token,
function(b,c){b?(c&&c.error&&(b=Error(c.error),b._code="refresh_token_error"),a&&a(b)):(m(d,c),a&&a(null,c))}):a&&a(null,b):this._refreshToken(b.refresh_token,function(b,c){b?(c&&c.error&&(b=Error(c.error),b._code="refresh_token_error"),a&&a(b)):(m(d,c),a&&a(null,c))}):this._auth(this._scope.join(" "),function(b,c){if(b){if(c)try{if(c=JSON.parse(c),c.error&&(b=Error(c.error),b._code="auth_error","invalid_request"==c.error&&-1!=d._scope.indexOf("access_presence"))){d._scope=d._scopeFallback;d.auth(a);
return}}catch(J){}a&&a(b)}else m(d,c),a&&a(null,c)})};p.prototype.setThermPoint=function(a,b,d){if(a&&a.address&&a.module)if(b&&b.setpoint_mode)if("max"!=b.setpoint_mode||b.setpoint_endtime)if("manual"!=b.setpoint_mode||b.setpoint_endtime&&b.setpoint_temp){var e=this;this.auth(function(h){h?d&&d(h):e._setThermPoint(c(e).access_token,a.address,a.module,b.setpoint_mode,b.setpoint_endtime,b.setpoint_temp,function(a,b){a?(b&&b.error&&(a=Error(b.error),a._code="api_error"),d&&d(a)):d&&d(null,b)})})}else d&&
d(Error("param format invalid"));else d&&d(Error("param format invalid"));else d&&d(Error("param format invalid"));else d&&d(Error("device format invalid"))};p.prototype.getStationsData=function(a){this._logger.log("debug","getStationsData");var b=this;this.auth(function(d){d?a&&a(d):(d=w(b))&&d.updateData&&d.updateData.running?(d.tmpCBs||(d.tmpCBs=[]),d.tmpCBs.push(a)):(x(b),b._getStationsData(c(b).access_token,null,function(d,c){d?(c&&c.error&&(d=Error(c.error),d._code="api_error"),u(b,d,null),
a&&a(d)):(d=null,c.body&&c.body.devices&&(d=c.body.devices),c.body&&c.body.user&&c.body.user.administrative&&(f=c.body.user.administrative),u(b,null,d),a&&a(null,d))}))})};p.prototype.getThermostatsData=function(a){var b=this;this.auth(function(d){d?a&&a(d):(d=v(this))&&d.updateData&&d.updateData.running?(d.tmpCBs||(d.tmpCBs=[]),d.tmpCBs.push(a)):(G(b),b._getThermostatsData(c(b).access_token,null,function(d,c){d?(c&&c.error&&(d=Error(c.error),d._code="api_error"),D(b,d,null),a&&a(d)):(d=null,c.body&&
c.body.devices&&(d=c.body.devices),D(b,null,d),a&&a(null,d))}))})};p.prototype.getHomeCoachsData=function(a){this._logger.log("debug","getHomeCoachsData");var b=this;this.auth(function(d){d?a&&a(d):(d=z(this))&&d.updateData&&d.updateData.running?(d.tmpCBs||(d.tmpCBs=[]),d.tmpCBs.push(a)):(F(b),b._getHomeCoachsData(c(b).access_token,null,function(d,c){d?(c&&c.error&&(d=Error(c.error),d._code="api_error"),C(b,d,null),a&&a(d)):(d=null,c.body&&c.body.devices&&(d=c.body.devices),c.body&&c.body.user&&c.body.user.administrative&&
(t=c.body.user.administrative),C(b,null,d),a&&a(null,d))}))})};p.prototype.getCamsData=function(a){this._logger.log("debug","getCamsData");var b=this;this.auth(function(d){d?a&&a(d):b._getCamsData(c(b).access_token,function(b,d){b?(d&&d.error&&(b=Error(d.error),b._code="api_error"),a&&a(b)):(b=null,d.body&&d.body.homes&&(b=d.body.homes),a&&a(null,b))})})};p.prototype._auth=function(a,b){this._logger.log("trace","_auth");this._doRequest("POST","/oauth2/token",{grant_type:"password",client_id:"564b2c5245a1e3173cb21d3b",
client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",username:this.user,password:this.password,scope:a},b)};p.prototype._refreshToken=function(a,b){this._logger.log("trace","_refreshToken");this._doRequest("POST","/oauth2/token",{grant_type:"refresh_token",client_id:"564b2c5245a1e3173cb21d3b",client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",refresh_token:a},b)};p.prototype._setThermPoint=function(a,b,d,c,e,g,f){a={access_token:a,device_id:b,module_id:d,setpoint_mode:c};e&&(a.setpoint_endtime=
e);g&&(a.setpoint_temp=g);this._doRequest("GET","/api/setthermpoint",a,f)};p.prototype._getStationsData=function(a,b,d){this._logger.log("debug","_getStationsData");a={access_token:a};b&&(a.device_id=b);this._doRequest("GET","/api/getstationsdata",a,d)};p.prototype._getHomeCoachsData=function(a,b,d){this._logger.log("debug","_getHomeCoachsData");a={access_token:a};b&&(a.device_id=b);this._doRequest("GET","/api/gethomecoachsdata",a,d)};p.prototype._getThermostatsData=function(a,b,d){a={access_token:a};
b&&(a.device_id=b);this._doRequest("GET","/api/getthermostatsdata",a,d)};p.prototype._getCamsData=function(a,b){this._doRequest("GET","/api/gethomedata",{access_token:a},b)};p.prototype._getLocalCamUrl=function(a,b){var d=this;this._logger.log("trace","ping cam "+a);this._doUrlRequest("get",a+"/command/ping",null,function(c,e){!c&&e&&e.local_url?d._doUrlRequest("get",e.local_url+"/command/ping",null,function(d,c){d||!c||c.local_url!=e.local_url?b&&b(null,a+"/live/index.m3u8"):b&&b(null,c.local_url+
"/live/index.m3u8")}):b&&b(null,a+"/live/index.m3u8")})};p.prototype._doRequest=function(a,b,d,c){this._doUrlRequest(a,"https://api.netatmo.net"+b,d,c)};p.prototype._doUrlRequest=function(a,b,d,c){var e=this,g=c;this._logger.log("trace","send "+a+" req to:"+b+" data:"+JSON.stringify(d));$.ajax({url:b,type:a,timeout:1E4,dataType:"json",data:d,cache:!1,success:function(a){e._logger.log("trace","http request success:"+JSON.stringify(a));c&&c(null,a)},error:function(a,b,d){b="http request error:"+(a?
a.status:"0")+"-"+b;e._logger.log("warn","http request error:"+b);b=Error(b);d&&(e._logger.log("warn","http request http error:"+d),b.httpError=!0,b.statusCode=a?a.status:0);g&&(g(b,a?a.responseText:null),g=null)}})};p.prototype.toJSON=function(){return{sys:xnm.aio.netatmo.DM.SYS,username:this.user,password:this.password}};p.prototype.equalsTo=function(a){return a&&a instanceof p?this.user==a.user&&this.password==a.password:!1};p.pause=function(a){for(var b in k)if(k.hasOwnProperty(b)){var d=k[b];
d&&d.weather&&d.weather.timer&&clearTimeout(d.weather.timer);d&&d.thermo&&d.thermo.timer&&clearInterval(d.thermo.timer)}k={};a&&a()};return p}();
xnm.aio.netatmo.MNetatmo=function(){var k=function(e){this._logger=require("x.logger.js").getLogger("xnm.aio.netatmo.MNetatmo");this._interval=0;this._on={};this._updateInterval=12E4;this._url=null;this._username=e?e.username:null;this._password=e?e.password:null;this._basicAuth=e?e.basicAuth:null};k.CLOUD_URL="cloud.mediola.com";k.prototype={_doUpdate:function(e){var f=this;APP.isInDemoMode||this.getStates(null,function(k,g){if(g&&g.XC_SUC){XC.debugf("[MNetatmo] Received update.");for(var c in g.XC_SUC){k=
g.XC_SUC[c];for(var m in k){var r=k[m],w=c+"_"+m;if(r.states)for(var t in r.states)CommandHandler.setState(w+":"+t,r.states[t],!0)}}e&&e();if(Array.isArray(f._on.update))for(g={type:"update"},c=0;c<f._on.update.length;c++)(m=f._on.update[c])&&m(g)}})},_sendRequest:function(e,f){"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var k=require("https"),g=this._getURL();g=g.replace("https://","");e={host:g,method:"GET",path:e||"/",headers:{}};(g=this._getBasicAuthHeader())&&
(e.headers.Authorization=g);var c=this,m=f,r=k.request(e,function(e){e.setEncoding("utf-8");var g="";e.on("data",function(c){g+=c});e.on("end",function(){c._logger.log("trace","http reponse:"+g+" statusCode:"+e.statusCode);if(200!=e.statusCode)m&&m(Error("http response with code:"+e.statusCode),null);else try{var f=JSON.parse(g);f&&f.XC_SUC?m&&m(null,f.XC_SUC):f&&f.XC_ERR?m&&m(Error(f.XC_ERR.msg)):m&&m(Error("http reponse format valid"));m=null}catch(y){c._logger.log("trace","http reponse is not valid json:"+
y.message),m&&m(y,null),m=null}})});r.setTimeout(1E4,function(){c._logger.log("trace","http request timeout");r.abort();m&&m(Error("http timeout"));m=null});r.on("error",function(e){c._logger.log("trace","http request error:"+e.message);m&&m(e);m=null});r.end()},_getURL:function(){return this._url?this._url:k.CLOUD_URL},_getBasicAuthHeader:function(){return this._basicAuth?this._basicAuth:this._username?"Basic "+(new Buffer(this._username+":"+(this._password?this._password:""))).toString("base64"):
null},_getStates:function(e){this._sendRequest("/netatmo/getStates",e)},addEventListener:function(e,f){this._on[e]||(this._on[e]=[]);this._on[e].push(f)},setUrl:function(e){this._url=e},getDevices:function(e){this._sendRequest("/netatmo/getDevices",e)},getStates:function(e,f,k){this._getStates(function(g,c){if(g)k&&k(null);else if(f){g={};for(var m in c){var r=c[m];if(r)for(var t in r)if(f&&f.address==t){var x=r[t];if(x&&x.states){g=x.states;break}}}if(e)for(var u in g)e.setState(f.id+":"+u,g[u]);
k&&k(g)}else k&&k(c)})},removeEventListener:function(e,f){if(this._on[e])for(var k=0;k<this._on[e].length;k++)if(this._on[e][k]===f){this._on[e].splice(k,1);break}},startUpdating:function(e){if(!this._interval)if(APP.isInDemoMode)XC.debugf("[MNetatmo.startUpdating] Ignored. App is in demo mode.");else{var f=this;XC.debugf("[MNetatmo.startUpdating] Start.");this._doUpdate();this._interval=setInterval(function(){f._doUpdate()},this._updateInterval)}},stopUpdating:function(){clearInterval(this._interval);
XC.debugf("[MNetatmo.stopUpdating] Stop.")}};return k}();
xnm.aio.netatmo.DM=function(){var k=function(e,c){this.code=e;this.message=c;this.stack=Error().stack};k.prototype=Error();k.prototype.name="NetatmoDmError";k.prototype.code=0;k.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var e=k.ERROR_CODE,f=[{type:"float",name:"absolute pressure",ref:{value:"absPres"}},{type:"int",name:"co2",ref:{value:"co2"}},{type:"int",name:"humidity",ref:{value:"hum"}},{type:"int",name:"noise",ref:{value:"noise"}},{type:"float",
name:"pressure",ref:{value:"pres"}},{type:"float",name:"rain",ref:{value:"rain"}},{type:"float",name:"rain last hour",ref:{value:"rain1h"}},{type:"float",name:"rain today",ref:{value:"rain24h"}},{type:"float",name:"temperature",ref:{value:"temp"}},{type:"int",name:"time max temperatue",ref:{value:"timeMaxTemp"}},{type:"int",name:"time min temperatue",ref:{value:"timeMinTemp"}},{type:"float",name:"max temperatue",ref:{value:"maxTemp"}},{type:"float",name:"min temperatue",ref:{value:"minTemp"}},{type:"int",
name:"wind direction",ref:{value:"winD"}},{type:"float",name:"wind speed",ref:{value:"winS"}},{type:"int",name:"gust wind direction",ref:{value:"gwinD"}},{type:"float",name:"gust wind speed",ref:{value:"gwinS"}},{type:"int",name:"last measure time",ref:{value:"mesureT"}},{type:"int",name:"time max wind",ref:{value:"timeMaxWind"}},{type:"int",name:"max wind direction",ref:{value:"maxWinD"}},{type:"float",name:"max wind speed",ref:{value:"maxWinS"}},{type:"float",name:"rf level",ref:{value:"rf"}},{type:"enum",
name:"rf status",ref:{value:"rfStatus",options:["very_low","low","medium","high","full"]}},{type:"float",name:"battery level",ref:{value:"bat",extMeta:"3000-6000"}},{type:"enum",name:"battery status",ref:{value:"batStatus",options:["very_low","low","medium","high","full"]}},{type:"float",name:"wifi level",ref:{value:"wifi"}},{type:"enum",name:"wifi status",ref:{value:"wifiStatus",options:["bad","middle","good","very_good"]}},{type:"enum",name:"mode",ref:{value:"mode",options:"auto away frost-guard manu off boost".split(" ")}},
{type:"float",name:"manual temperature",ref:{value:"manuT",extMeta:"5.5-30",scale:"0.5"}},{type:"int",name:"manual/boost endtime",ref:{value:"tempEnd"}},{type:"float",name:"measured temperature",ref:{value:"currentTemp"}},{type:"int",name:"manual/boost duration",ref:{value:"tempDuration",extMeta:"15-720",scale:"15"}},{type:"string",name:"manual/boost endtime string",ref:{value:"tempEndStr"}},{type:"string",name:"time string max temperatue",ref:{value:"timeMaxTempStr"}},{type:"string",name:"time string min temperatue",
ref:{value:"timeMinTempStr"}},{type:"string",name:"last measure time string",ref:{value:"mesureTStr"}},{type:"string",name:"time string max wind",ref:{value:"timeMaxWindStr"}},{type:"float",name:"felt temperature",ref:{value:"tempFelt"}},{type:"string",name:"wind direction named",ref:{value:"winDName",options:"N NO O SO S SW W NW".split(" ")}},{type:"enum",name:"temperature trend",ref:{value:"tempTrend",options:["up","down","stable"]}},{type:"enum",name:"pressure trend",ref:{value:"presTrend",options:["up",
"down","stable"]}},{type:"enum",name:"health index",ref:{value:"healthIdx",options:["healthy","fine","fair","poor","unhealthy"]}},{type:"int",name:"health index level",ref:{value:"healthIdxLvl",extMeta:"0-4"}}],t=[{type:"enum",name:"auto",ref:{value:"thermoAuto"}},{type:"enum",name:"away",ref:{value:"thermoAway"}},{type:"enum",name:"frost-guard",ref:{value:"thermoHg"}},{type:"enum",name:"off",ref:{value:"thermoOff"}},{type:"enum",name:"max",ref:{value:"thermoMax"}},{type:"float",name:"manu",ref:{value:"thermoManu",
ext:"%f",extMeta:"5.5-30",scale:"0.5"}},{type:"enum",name:"up",ref:{value:"thermoUp"}},{type:"enum",name:"down",ref:{value:"thermoDown"}},{type:"int",name:"manual/boost duration",ref:{value:"tempDuration",ext:"%d",extMeta:"15-720",scale:"15"}}];return{SYS:"netatmo",getGatewayType:function(){return[{sys:this.SYS,name:"Netatmo (Online)",port:443}]},getGatewayDeviceType:function(e){return[{sys:this.SYS,type:"NAMain",name:"Base Station"},{sys:this.SYS,type:"NAModule1",name:"Outdoor module"},{sys:this.SYS,
type:"NAModule4",name:"Additional indoor module"},{sys:this.SYS,type:"NAModule3",name:"Rain gauge module"},{sys:this.SYS,type:"NAModule2",name:"Wind gauge module"},{sys:this.SYS,type:"NATherm1",name:"Thermostat"},{sys:this.SYS,type:"NHC",name:"Home Coach"}]},_checkInfo:function(g,c,f){if(g)if(g.gateway)if(g.type)if(g.address)if(c.data&&c.data.gateways&&0!==c.data.gateways.length){c=c.data.gateways;var m;for(m=0;m<c.length;m++)if(c[m].index===g.gateway){var t=c[m];break}t?f():f(new k(e.NOT_FOUND,"gateway with index "+
g.gateway+" not exists"))}else f(new k(e.NOT_FOUND,"gateway with index "+g.gateway+" not exists"));else f(new k(e.INVALID,"address is invalid"));else f(new k(e.INVALID,"type is invalid"));else f(new k(e.INVALID,"gateway is invalid"));else f(new k(e.INVALID,"info is invalid"))},createGateway:function(g,c,f){g?g.refreshToken||g.username&&g.password?f(null,g):f(new k(e.INVALID,"refreshToken is invalid")):f(new k(e.INVALID,"info is invalid"))},updateGateway:function(g,c,f,r){c?c.refreshToken||c.username&&
c.password?r(null,c):r(new k(e.INVALID,"refreshToken is invalid")):r(new k(e.INVALID,"info is invalid"))},deleteGateway:function(e,c,f){f()},createDevice:function(e,c,f){this._checkInfo(e,c,function(c){f(c,e)})},updateDevice:function(e,c,f){this._checkInfo(e,c,function(c){f(c,e)})},deleteDevice:function(e,c,f){f(null,e)},applyUIFilter:function(e,c){var g=function(c,e){if("*"==c)return!0;for(var g=!1,f=0;f<c.length;f++)if(c[f]==e){g=!0;break}return g},f=function(c,e,f){var k=[];switch(f.catagory){case "command":c.command&&
c.command.forEach(function(c){g(f.elems,c.type)&&(c=JSON.parse(JSON.stringify(c)),k.push(c))});break;case "status":c.status&&c.status.forEach(function(c){g(f.elems,c.type)&&(c=JSON.parse(JSON.stringify(c)),k.push(c))})}return k},k=function(c,e){var g=[],k=this.getCommandStatusMap(c);k&&(c=f(k,c,e),g=g.concat(c));return g};if(!e.sys)return null;var t=JSON.parse(JSON.stringify(e)),u=null;switch(c.catagory){case "command":u=k.call(this,e,c);t.command=u;break;case "status":u=k.call(this,e,c);t.status=
u;break;default:return null}return u&&0!=u.length?t:null},applyIPEventFilter:function(e,c){if(!e.sys)return null;c=JSON.parse(JSON.stringify(e));e=this.getIPevtMap(e);if(!e)return c;c.ipevt=e.ipevt;return c},getCommandStatusMap:function(e){var c={command:[],status:[]};switch(e.type){case "NAMain":c.status.push(f[25]);c.status.push(f[26]);break;case "NAModule1":case "NAModule2":case "NAModule3":case "NAModule4":case "NATherm1":c.status.push(f[21]);c.status.push(f[22]);c.status.push(f[23]);c.status.push(f[24]);
"NATherm1"==e.type&&(c.status.push(f[27]),c.status.push(f[28]),c.status.push(f[29]),c.status.push(f[30]),c.status.push(f[31]),c.status.push(f[32]));break;case "NHC":c.status.push(f[25]),c.status.push(f[26])}"NATherm1"==e.type&&(c.command=t);if(e.dashboard_data)for(var g in e.dashboard_data)if(e.dashboard_data.hasOwnProperty(g))switch(g){case "AbsolutePressure":c.status.push(f[0]);break;case "CO2":c.status.push(f[1]);break;case "Humidity":c.status.push(f[2]);c.status.push(f[37]);break;case "Noise":c.status.push(f[3]);
break;case "Pressure":c.status.push(f[4]);break;case "Rain":c.status.push(f[5]);break;case "sum_rain_1":c.status.push(f[6]);break;case "sum_rain_24":c.status.push(f[7]);break;case "Temperature":c.status.push(f[8]);break;case "date_max_temp":c.status.push(f[9]);c.status.push(f[33]);break;case "date_min_temp":c.status.push(f[10]);c.status.push(f[34]);break;case "max_temp":c.status.push(f[11]);break;case "min_temp":c.status.push(f[12]);break;case "WindAngle":c.status.push(f[13]);c.status.push(f[38]);
break;case "WindStrength":c.status.push(f[14]);break;case "GustAngle":c.status.push(f[15]);break;case "GustStrength":c.status.push(f[16]);break;case "time_utc":c.status.push(f[17]);c.status.push(f[35]);break;case "date_max_wind_str":c.status.push(f[18]);c.status.push(f[36]);break;case "max_wind_angle":c.status.push(f[19]);break;case "max_wind_str":c.status.push(f[20]);break;case "temp_trend":c.status.push(f[39]);break;case "pressure_trend":c.status.push(f[40]);break;case "health_idx":c.status.push(f[41]),
c.status.push(f[42])}return c},getIPevtMap:function(e){return(e=this.getCommandStatusMap(e))?{ipevt:e.status}:null},calcFeltTemp:function(e,c,f){if(f&&"object"==typeof f&&0===f.feel_like_algo)f=243.5,c=Math.log(.01*c)+17.67*e/(f+e),c=e+.5555*(6.11*Math.exp(5417.753*(1/273.16-1/(f*c/(17.67-c)+273.15)))-10);else{f=[-42.379,2.04901523,10.14333127,-.22475541,-.00683783,-.05481717,.00122874,8.5282E-4,-1.99E-6];e=9*e/5+32;var g=e*e,k=c*c;c=f[0]+f[1]*e+f[2]*c+f[3]*e*c+f[4]*g+f[5]*k+f[6]*g*c+f[7]*e*k+f[8]*
g*k;c=5*(c-32)/9}return Math.round(10*c)/10}}}();
xnm.aio.netatmo.Handler=function(){var k=function(){this._updateListener=[]};k.prototype.Cloud=xnm.aio.netatmo.Cloud;k.prototype.MNetatmo=xnm.aio.netatmo.MNetatmo;k.prototype.devicemanager=xnm.aio.netatmo.DM;k.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"netatmo")};k.prototype.resolveGateway=function(e){return e.refreshToken||e.username&&e.password?new xnm.aio.netatmo.Cloud(e.username,e.password,e.refreshToken):null};k.prototype.getDeviceCommands=function(e,f){e=(e=xnm.aio.netatmo.DM.applyUIFilter(e,
{catagory:"command",elems:"*"}))?e.command:[];f&&f(null,e)};k.prototype.getDeviceStatus=function(e,f){e=(e=xnm.aio.netatmo.DM.applyUIFilter(e,{catagory:"status",elems:"*"}))?e.status:[];f&&f(null,e)};k.prototype.login=function(e,f){(e=this.resolveGateway(e))?e.auth(function(e,g){e?f&&f(e):f&&f(e,{refreshToken:g.refresh_token})}):f&&f(Error("gateway json format invalid"))};k.prototype.doCommand=function(e,f,k,g){(e=this.resolveGateway(e))?e.executeCommandCreator(f,k,function(c){g&&g(c)}):g&&g(Error("gateway json format invalid"))};
k.prototype.doStatus=function(e,f,k,g,c){(f=this.resolveGateway(f))?f.getStatesCreator(null,[{id:e,device:k,status:g}],function(e,f){e?c&&c(e):c&&c(null,f[0])}):c&&c(Error("gateway json format invalid"))};k.prototype.getDeviceList=function(e,f){(e=this.resolveGateway(e))?e.getDeviceList(f):f&&f(Error("gateway json format invalid"))};k.prototype.getCamList=function(e,f){(e=this.resolveGateway(e))?e.getCamList(f):f&&f(Error("gateway json format invalid"))};k.prototype.pause=function(e){xnm.aio.netatmo.Cloud.pause(e)};
k.prototype.addUpdateListener=function(e){e&&-1==this._updateListener.indexOf(e)&&this._updateListener.push(e)};k.prototype.getDevice=function(e){return new this.MNetatmo(e)};k.prototype.setMNetatmoCloudUrl=function(e){this.MNetatmo.CLOUD_URL=e};return k}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.netatmo.Handler);
