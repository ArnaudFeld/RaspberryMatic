var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.kt=xnm.aio.kt||{},xnm.aio.kt.Socket=function(e,t,i){this.ip=e,this.port=28530,this.uuid=t,this._state="?",i&&(this._manuCode=i.manuCode,this._authCode=i.authCode,this._deviceType=i.deviceType),this.CommandHandler=null;},xnm.aio.kt.Socket.prototype._sendMessage=function(e,t){for(var i=[1,0],o=this.uuid.replace(/-/g,""),s=0;s<6;s++)i.push(parseInt(o.substr(2*s,2),16));for(i.push(e.length+7),i.push(0),i.push(0),i.push(0),i.push(this._manuCode),i.push(this._authCode[0]),i.push(this._authCode[1]),i.push(this._deviceType),s=0;s<e.length;s++)i.push(e[s]);var n=new Buffer(i);console.log("send packet",n.toString("hex"));var a=require("dgram").createSocket("udp4");a.send(n,0,n.length,this.port,this.ip,function(e,i){a.close(),t&&setTimeout(function(){t.call();},1e3);});},xnm.aio.kt.Socket.prototype.getState=function(e){this._sendMessage([2,0,0,0,0]);var t=this;setTimeout(function(){e(t._state);},3e3);},xnm.aio.kt.Socket.prototype.executeCommand=function(e,t,i){var o=this,s=[1,0,0,0,255];if("on"==t)s[3]=255;else if("toggle"==t)return void this.getState(function(e){"on"==e||"off"==e?("off"==e&&(s[3]=255),o._sendMessage(s,function(){o._sendMessage(s,i);})):i&&i.call();});o._sendMessage(s,function(){o._sendMessage(s,i);});},xnm.aio.kt.Socket.prototype.getStates=function(e,t,i){var o=this;this.CommandHandler=e,this.getState(function(e){var s={state:e};t&&o.CommandHandler.setState?o.CommandHandler.setState(t.id,e):o.CommandHandler.receivedState&&o.CommandHandler.receivedState("kt",o.uuid,s),i&&i(s);});},xnm.aio.kt.Socket.prototype.getStateValues=function(e){return e;},xnm.aio.kt.Discovery=function(){this.Devices={},this.callback=null,this._sockets=[];var e=require("os");if(require("dgram"),e&&e.networkInterfaces){var t=e.networkInterfaces();for(var i in t)for(var o=t[i],s=0;s<o.length;s++)this._addDiscoverSocket(28530,o[s]);}else this._addDiscoverSocket(28530,null);},xnm.aio.kt.Discovery.prototype._getMAC=function(e){for(var t="",i=0;i<5;i++)t+=XC.getHexVal(e[i],2).toUpperCase()+"-";return t+XC.getHexVal(e[i],2).toUpperCase();},xnm.aio.kt.Discovery.prototype._receivedData=function(e,t){var i,o,s;t=t.toString("hex"),t=new Buffer(t,"hex"),XC.debugf("Received data from "+e+" ("+t.length+")"),XC.debugf(t.toString("hex")),t.length>1&&(i=t[0]),t.length>2&&(o=t[1]),t.length>8&&(r=t.slice(2,8)),t.length>9&&(s=t[8]),t.slice(9);var n=!1;if(64&o&&(n=!0),console.log(i,o,r,s,n),44==t.length&&35==t[16]){var a={manuCode:t[12],authCode:[t[13],t[14]],deviceType:t[15]},r=this._getMAC(t.slice(21,27));this.Devices[e]=new xnm.aio.kt.Socket(e,r,a),this.callback&&this.Devices[e]&&this.callback(this.Devices[e]);}else 21==t.length&&2==t[16]&&this.Devices[e]&&(255==t[t.length-2]?this.Devices[e]._state="on":this.Devices[e]._state="off",this.Devices[e].CommandHandler&&this.Devices[e].CommandHandler.receivedState&&this.Devices[e].CommandHandler.receivedState("kt",this.Devices[e].uuid,{state:this.Devices[e]._state}));},xnm.aio.kt.Discovery.prototype._addDiscoverSocket=function(e,t){var i,o=require("dgram"),s=this;t?"IPv4"==t.family&&0==t.internal&&((i=o.createSocket("udp4")).on("listening",function(){i.setBroadcast(!0);}),i.on("message",function(e,t){s._receivedData(t.address,e);}),i.bind(e,t.address),this._sockets.push(i)):((i=o.createSocket("udp4")).on("message",function(e,t){s._receivedData(t.address,e);}),i.bind(e),this._sockets.push(i));},xnm.aio.kt.Discovery.prototype._sendDiscoveryMessages=function(e,t,i,o){e=new Buffer([1,0,255,255,255,255,255,255,14,0,0,0,202,253,102,33,35,255,255,255,255,255,255]);for(var s=0;s<2;s++)for(var n=0;n<this._sockets.length;n++)this._sockets[n].send(e,0,e.length,28530,"255.255.255.255");},xnm.aio.kt.Discovery.prototype.discoverDevices=function(){this._sendDiscoveryMessages();},xnm.aio.kt.Handler=function(){this._Discovery=new xnm.aio.kt.Discovery(),this._Discovery.discoverDevices();},xnm.aio.kt.Handler.prototype.discoverDevices=function(e){e&&(this._Discovery.callback=e),this._Discovery.discoverDevices();},xnm.aio.kt.Handler.prototype.getStateValues=function(e,t){return new xnm.aio.kt.Socket().getStateValues(t);},xnm.aio.kt.Handler.prototype.getDeviceCommandList=function(e,t){var i=[];return i.push({id:window.XC_Text.on,cmd:"on"}),i.push({id:window.XC_Text.off,cmd:"off"}),i;},xnm.aio.kt.Handler.prototype.getDevice=function(e){for(var t in this._Discovery.Devices)if(e.address&&this._Discovery.Devices[t].uuid==e.address)return this._Discovery.Devices[t];return null;},xnm.aio.kt.Handler.prototype.Socket=xnm.aio.kt.Socket,"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.kt.Handler());