var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(g){var c=0;return function(){return c<g.length?{done:!1,value:g[c++]}:{done:!0}}};$jscomp.arrayIterator=function(g){return{next:$jscomp.arrayIteratorImpl(g)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(g,c,a){g!=Array.prototype&&g!=Object.prototype&&(g[c]=a.value)};$jscomp.getGlobal=function(g){g=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,g];for(var c=0;c<g.length;++c){var a=g[c];if(a&&a.Math==Math)return a}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(g,c){this.$jscomp$symbol$id_=g;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:c})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function g(a){if(this instanceof g)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(a||"")+"_"+c++,a)}var c=0;return g}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var g=$jscomp.global.Symbol.iterator;g||(g=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[g]&&$jscomp.defineProperty(Array.prototype,g,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var g=$jscomp.global.Symbol.asyncIterator;g||(g=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(g){$jscomp.initSymbolIterator();g={next:g};g[$jscomp.global.Symbol.iterator]=function(){return this};return g};
$jscomp.iteratorFromArray=function(g,c){$jscomp.initSymbolIterator();g instanceof String&&(g+="");var a=0,b={next:function(){if(a<g.length){var f=a++;return{value:c(f,g[f]),done:!1}}b.next=function(){return{done:!0,value:void 0}};return b.next()}};b[Symbol.iterator]=function(){return b};return b};
$jscomp.polyfill=function(g,c,a,b){if(c){a=$jscomp.global;g=g.split(".");for(b=0;b<g.length-1;b++){var f=g[b];f in a||(a[f]={});a=a[f]}g=g[g.length-1];b=a[g];c=c(b);c!=b&&null!=c&&$jscomp.defineProperty(a,g,{configurable:!0,writable:!0,value:c})}};$jscomp.polyfill("Array.prototype.keys",function(g){return g?g:function(){return $jscomp.iteratorFromArray(this,function(c){return c})}},"es6","es3");var x=x||{};x.hub=x.hub||{};x.hub.commandman=x.hub.commandman||{};
x.hub.commandman.MacroExecutor=function(){var g=function(c,a,b){this._id=-1;this._commandHandler=c;this._callback=b;this._commands=[];this._currentCommand=0;this._canceling=!1;this._cancelCB=null;this._pause=250;if(a&&a.commands){"undefined"!=typeof a.pause&&null!==a.pause&&!isNaN(a.pause)&&0<=a.pause&&(this._pause=Math.max(Math.round(a.pause),1));this._commands=a.commands;c=[];for(a=this._commands.length-1;0<=a;a--)this._commands[a].removed||c.push(this._commands[a]);this._commands=c;window&&window.XCHost&&
window.XCHost.getType&&"iOS"==window.XCHost.getType()&&XC.callHost("SYSTEM","startBGThread");this._executeNextCommand(!0)}};g.prototype.cancel=function(c){this._canceling=!0;this._cancelCB=c};g.prototype._executeNextCommand=function(c){if(this._canceling){this._canceling=!1;var a=this._cancelCB;this._cancelCB=null;c=this._callback;this._callback=null;a&&a();c&&c(Error("canceld"))}else if(this._commandHandler&&0<this._commands.length){a=this._commands.pop();var b=this;if("command"==a.classid){var f=
{cmd:a.action.ref,device:a.action.device};f.cmd||(f.cmd={value:a.action.value});f.cmd&&null!==a.action.ext&&"undefined"!=typeof a.action.ext&&(f.cmd.ext=a.action.ext);a.action.path&&(f.cmd.path=a.action.path);"http_request"==a.action.type?this._commandHandler._doHTTPRequest({url:a.action.value,method:a.action.method,headers:a.action.headers,body:a.action.body},function(){b._executeNextCommand()}):c?this._commandHandler._executeCommand(f,function(){b._executeNextCommand()}):setTimeout(function(){b._commandHandler._executeCommand(f,
function(){b._executeNextCommand()})},b._pause)}else"navigate"==a.classid?(c={type:null},1===a.history?c.type="page_next":-1===a.history?c.type="page_prev":a.page?(c.type="navigate",c.data=a.page):c.type="refresh",b._commandHandler._doAction(c),setTimeout(function(){b._executeNextCommand(!0)},b._pause)):"sleep"==a.classid&&setTimeout(function(){b._executeNextCommand(!0)},a.time)}else this._callback&&this._callback()};return g}();
x.hub.commandman.CommandHandler=function(){var g=function(a){try{var b=JSON.parse(JSON.stringify(a));"undefined"!=typeof b.username&&null!=b.username&&(b.username="xxxxxx");"undefined"!=typeof b.password&&null!=b.password&&(b.password="xxxxxx");return b}catch(f){return a}},c=function(a,b){this._logger=require("x.logger.js").getLogger("x.hub.commandman.CommandHandler");this._id=b;this._commandHandler=require("m.aio.commandhandler.js").CentralHandler;this._deviceManager=a;this._deviceManager||(this._deviceManager=
require("./x.hub.deviceman.js").deviceManager);this._macroExecutors=[]};c.prototype.init=function(a,b){this._logger.log("info","init command manager");b&&b()};c.prototype.executeCommandWithRef=function(a,b,c,d,e){var f,h=this._deviceManager;if(a&&b){var k=h.findDevice(a,b);if(!k){e&&e({error:Error("device not found")});return}k.info&&k.info.gateway&&(f=h.findGatewayWithIndex(k.info.gateway))}else if(c){if(f=h.findGateway(c),!f){e&&e({error:Error("gateway not found")});return}}else{e&&e({error:Error("device/gateway reference invalid")});
return}if(k&&k.info){var g=JSON.parse(JSON.stringify(k.info));g.deviceName=b}if(f&&f.info){var l=JSON.parse(JSON.stringify(f.info));l.gatewayName=c;l.__neoInfo={db:this._id,index:f.index}}this.executeCommand(g,l,d,e)};c.prototype.getStateWithRef=function(a,b,c,d,e){var f,h=this._deviceManager;if(a&&b){var k=h.findDevice(a,b);if(!k){e&&e({error:Error("device not found")});return}k.info&&k.info.gateway&&(f=h.findGatewayWithIndex(k.info.gateway))}else if(c){if(f=h.findGateway(c),!f){e&&e({error:Error("gateway not found")});
return}}else{e&&e({error:Error("device/gateway reference invalid")});return}if(k&&k.info){var g=JSON.parse(JSON.stringify(k.info));g.deviceName=b}if(f&&f.info){var l=JSON.parse(JSON.stringify(f.info));l.gatewayName=c;l.__neoInfo={db:this._id,index:f.index}}this.getState(g,l,d,e)};c.prototype.executeCommandWithIdx=function(a,b,c,d){var e,f=this._deviceManager;if(a){var h=f.findDeviceWithIndex(a);if(!h){d&&d({error:Error("device not found")});return}h.info&&h.info.gateway&&(e=f.findGatewayWithIndex(h.info.gateway))}else if(b){if(e=
f.findGatewayWithIndex(b),!e){d&&d({error:Error("gateway not found")});return}}else{d&&d({error:Error("device/gateway reference invalid")});return}if(h&&h.info){var k=JSON.parse(JSON.stringify(h.info));k.deviceName=h.name}if(e&&e.info){var g=JSON.parse(JSON.stringify(e.info));g.gatewayName=e.name;g.__neoInfo={db:this._id,index:e.index}}this.executeCommand(k,g,c,d)};c.prototype.getStateWithIdx=function(a,b,c,d,e){if(c&&Array.isArray(c))this.getStatesWithIdx(a,b,c,d,e);else{var f;e=this._deviceManager;
if(a){var h=e.findDeviceWithIndex(a);if(!h){d&&d({error:Error("device not found")});return}h.info&&h.info.gateway&&(f=e.findGatewayWithIndex(h.info.gateway))}else if(b){if(f=e.findGatewayWithIndex(b),!f){d&&d({error:Error("gateway not found")});return}}else{d&&d({error:Error("device/gateway reference invalid")});return}if(h&&h.info){var g=JSON.parse(JSON.stringify(h.info));g.deviceName=h.name}if(f&&f.info){var m=JSON.parse(JSON.stringify(f.info));m.gatewayName=f.name;m.__neoInfo={db:this._id,index:f.index}}this.getState(g,
m,c,d)}};c.prototype.getStatesWithIdx=function(a,b,c,d,e){var f;e=this._deviceManager;if(a){var h=e.findDeviceWithIndex(a);if(!h){d&&d({error:Error("device not found")});return}h.info&&h.info.gateway&&(f=e.findGatewayWithIndex(h.info.gateway))}else if(b){if(f=e.findGatewayWithIndex(b),!f){d&&d({error:Error("gateway not found")});return}}else{d&&d({error:Error("device/gateway reference invalid")});return}if(h&&h.info){var g=JSON.parse(JSON.stringify(h.info));g.deviceName=h.name}if(f&&f.info){var m=
JSON.parse(JSON.stringify(f.info));m.gatewayName=f.name;m.__neoInfo={db:this._id,index:f.index}}a=[];for(b=0;b<c.length;b++)e=c[b],e.id&&e.value&&a.push({id:e.id,device:g,status:e});this.getMultiStatesLegacy(g,m,a,function(a){if(a.error)d&&d(a);else{var b={data:{}};a.data&&a.data.forEach(function(a){a&&a.id&&(b.data[a.id]=a.status)});d&&d(b)}})};c.prototype.executeCommand=function(a,b,c,d){if(a||b)if(c){var e=null;b&&b.sys&&(e=b.sys);!e&&a&&a.sys&&(e=a.sys);if(e){if(("aio"==e||"neoserver"==e)&&c&&
"cfOn"==c.value||"cfOff"==c.value){if(!b||!b.__neoInfo||!b.__neoInfo.index){d&&d({});return}if(this._deviceManager.getOwnIdx()==b.__neoInfo.index){d&&d({});return}}if((e=require("x.hub.moduleman.js").modulemanager.getModule(e))&&e.executeCommand){var f={};a&&(f=JSON.parse(JSON.stringify(a)));b&&(f.gateway=JSON.parse(JSON.stringify(b)));this._logger.log("trace","do command:"+g(a));this._logger.log("trace","command:"+JSON.stringify(c));e.executeCommand(f,c,d)}else this.executeCommandLegacy(a,b,c,d)}else d&&
d({error:Error("no sys parameter")})}else d&&d({error:Error("no command")});else d&&d({error:Error("no device or gateway")})};c.prototype.getState=function(a,b,c,d){if(!c||Array.isArray(c))this.getStates(a,b,c,d);else if(a||b)if(c){var e=null;b&&b.sys&&(e=b.sys);!e&&a&&a.sys&&(e=a.sys);if(e)if((e=require("x.hub.moduleman.js").modulemanager.getModule(e))&&e.getState){var f={};a&&(f=JSON.parse(JSON.stringify(a)));b&&(f.gateway=JSON.parse(JSON.stringify(b)));e.getState(f,c.value,function(a){d&&d(a)})}else this.getStateLegacy(a,
b,c,d);else d&&d({error:Error("no sys parameter")})}else d&&d({error:Error("no command")});else d&&d({error:Error("no device or gateway")})};c.prototype.executeCommandLegacy=function(a,b,c,d){if(a||b)if(c){var e=null;b&&b.sys&&(e=b.sys);!e&&a&&a.sys&&(e=a.sys);if(e){var f=require("m.aio.modulemanager.js").getModule(e);if(f){var h;b&&(h=f.resolveGateway(b));b=null;var g=this._deviceManager;g&&(b=g.getDeviceInfo());!h&&a&&(h=f.resolveDevice(a,b));h?this._commandHandler.executeCommand(e,h,a,c,function(b,
e){if(a&&"cam"==a.sys&&c&&"snapshot"==c.value&&!b&&e)try{require("x.hub.camman.js").saveSnapshot(a,e,function(){})}catch(n){}d&&d({error:b,data:e})}):d&&d(Error("can not generate host"))}else d&&d({error:Error("no module can handle sys:"+e)})}else d&&d({error:Error("no sys parameter")})}else d&&d({error:Error("no command")});else d&&d({error:Error("no device or gateway")})};c.prototype.getStateLegacy=function(a,b,c,d){if(a||b)if(c){var e=null;b&&b.sys&&(e=b.sys);!e&&a&&a.sys&&(e=a.sys);if(e){var f=
require("m.aio.modulemanager.js").getModule(e);if(f){var h;b&&(h=f.resolveGateway(b));b=null;var g=this._deviceManager;g&&(b=g.getDeviceInfo());!h&&a&&(h=f.resolveDevice(a,b));h?this._commandHandler.getStates(e,h,[{id:"alias",device:a,status:c}],function(a,b){a?d&&d(a):(a=null,b[0]&&(a=b[0].status),d&&d({data:{value:a}}))}):d&&d({error:Error("can not generate host")})}else d&&d({error:Error("no module can handle sys:"+e)})}else d&&d({error:Error("no sys parameter")})}else d&&d({error:Error("no status")});
else d&&d({error:Error("no device or gateway")})};c.prototype.getStates=function(a,b,c,d){if(a||b){var e=null;b&&b.sys&&(e=b.sys);!e&&a&&a.sys&&(e=a.sys);if(e)if((e=require("x.hub.moduleman.js").modulemanager.getModule(e))&&e.updateStates){var f={};a&&(f=JSON.parse(JSON.stringify(a)));b&&(f.gateway=JSON.parse(JSON.stringify(b)));e.updateStates(f,function(a){d&&d(a)},c)}else this.getStatesLegacy(a,b,c,d);else d&&d({error:Error("no sys parameter")})}else d&&d({error:Error("no device or gateway")})};
c.prototype.getStatesLegacy=function(a,b,c,d){if(a||b){var e=null;b&&b.sys&&(e=b.sys);!e&&a&&a.sys&&(e=a.sys);if(e){var f=require("m.aio.modulemanager.js").getModule(e);if(f){var g;b&&(g=f.resolveGateway(b));b=null;var k=this._deviceManager;k&&(b=k.getDeviceInfo());!g&&a&&(g=f.resolveDevice(a,b));g?this._commandHandler.getStatesForSingleDevice(e,g,a,c,function(a,b){a?d&&d(a):d&&d({data:b})}):d&&d({error:Error("can not generate host")})}else d&&d({error:Error("no module can handle sys:"+e)})}else d&&
d({error:Error("no sys parameter")})}else d&&d({error:Error("no device or gateway")})};c.prototype.getMultiStatesLegacy=function(a,b,c,d){if(a||b)if(c){var e=null;b&&b.sys&&(e=b.sys);!e&&a&&a.sys&&(e=a.sys);if(e){var f=require("m.aio.modulemanager.js").getModule(e);if(f){var g;b&&(g=f.resolveGateway(b));b=null;var k=this._deviceManager;k&&(b=k.getDeviceInfo());!g&&a&&(g=f.resolveDevice(a,b));g?this._commandHandler.getStates(e,g,c,function(a,b){a?d&&d(a):d&&d({data:b})}):d&&d({error:Error("can not generate host")})}else d&&
d({error:Error("no module can handle sys:"+e)})}else d&&d({error:Error("no sys parameter")})}else d&&d({error:Error("no device list")});else d&&d({error:Error("no device or gateway")})};c.prototype.execute=function(a,b,c,d,e){this._handler.execute(a,b,c,d,e)};c.prototype._executeCommand=function(a,b){a&&a.device&&a.cmd?a.device.name&&a.device.room?this.executeCommandWithRef(a.device.room,a.device.name,null,a.cmd,b):a.device.name?this.executeCommandWithRef(null,null,a.device.name,a.cmd,b):b&&b({error:Error("cmd object has no valid device")}):
b&&b({error:Error("cmd object format invalid")})};c.prototype._doAction=function(a,b){b&&b({})};c.prototype._doHTTPRequest=function(a,b){var c=null,d="GET",e=null,g=null;"string"===typeof a?c=a:(g=a.body||g,e=a.headers||e,d=a.method||d,c=a.url);a=String(c).toLowerCase();0===a.indexOf("http:")||0===a.indexOf("https:")?(c=require("url").parse(c),a="https:"==c.protocol?require("https"):require("http"),d={host:c.hostname,method:d,path:c.path,port:c.port,protocol:c.protocol},e&&"object"===typeof e&&(d.headers=
e),c.auth&&(d.auth=c.auth),e=a.request(d,function(a){b&&b()}),e.on("error",function(a){XC.debugf(a);b&&b()}),"string"===typeof g&&e.write(g),e.end()):(0<c.indexOf("://")&&window.XC&&window.XC.callHost&&window.XC.callHost("SYSTEM","startApp",{scheme:c}),b&&b())};c.prototype.executeMacro=function(a,b,c){var d=this,e=new x.hub.commandman.MacroExecutor(this,a,function(a){for(var c=-1,f=0;f<d._macroExecutors.length;f++)if(d._macroExecutors[f]==e){c=1;break}-1!=c&&d._macroExecutors.slice(c,1);b&&b({error:a})});
e._id=this._macroExecutors.length+1;this._macroExecutors.push(e);c&&c({id:e._id})};c.prototype.cancelMacro=function(a,b){for(var c=null,d=-1,e=0;e<this._macroExecutors.length;e++){var g=this._macroExecutors[e];if(g&&g._id==a){d=e;c=g;break}}c?(-1!=d&&this._macroExecutors.slice(d,1),c.cancel(function(){b&&b({})})):b&&b()};c.prototype.updateGeneralDeviceStates=function(a,b){var c=this;a||(a=1E4);this._deviceManager.getAllGeneralDevice(function(d,e){if(d)b&&b(d);else if(e&&0!=e.length){var f={};d=[];
for(var g=0;g<e.length;g++){var k=e[g];if(k._origin&&k._origin.info&&k.details&&k.details.states){var m=k._origin;m.states=k.details.states;k._origin.info.gateway?(k=k._origin.info.gateway,f[k]||(f[k]=[]),f[k].push(m)):d.push(m)}}var l=b,n={};e=Object.keys(f);var q=0,r=e.length+d.length;setTimeout(function(){l&&(l(null,n),l=null)},a);e.forEach(function(a){c._updateGeneralGatewayDeviceStates(a,f[a],function(a,b){if(!a&&b)for(var c in b)n[c]=b[c];q++;q==r&&l&&(l(null,n),l=null)})});d.forEach(function(a){c._updateGeneralIPDeviceStats(a,
function(a,b,c){!a&&c&&(n[b]=c);q++;q==r&&l&&(l(null,n),l=null)})})}else b&&b(null,{})})};c.prototype._updateGeneralGatewayDeviceStates=function(a,b,c){var d=this._deviceManager.findGatewayWithIndex(a);if(d)if(d.info){d=JSON.parse(JSON.stringify(d.info));d.__neoInfo={db:this._id,index:a};a=[];for(var e=0;e<b.length;e++){var f=b[e];if(f&&f.info&&f.states)for(var g in f.states)a.push({id:f.index+":"+g,device:f.info,status:f.states[g]})}this._updateGeneralStates(null,d,a,function(a,b){if(a)c&&c(a);else{a=
{};if(b)for(var d=0;d<b.length;d++){var e=b[d];if(e.id){var f=e.id.indexOf(":");if(-1!=f){var g=parseInt(e.id.substr(0,f));if(f=e.id.substr(f+1))a[g]||(a[g]={}),a[g][f]=e.status}}}c&&c(null,a)}})}else c&&c(Error("invalid gateway json"));else c&&c(Error("no such gateway"))};c.prototype._updateGeneralStates=function(a,b,c,d){if(a||b)if(c){var e=null;b&&b.sys&&(e=b.sys);!e&&a&&a.sys&&(e=a.sys);if(e){var f=require("x.hub.moduleman.js").modulemanager.getModule(e);if(f&&f.updateGeneralStates)e={},a&&(e=
JSON.parse(JSON.stringify(a))),b&&(e.gateway=JSON.parse(JSON.stringify(b))),f.updateGeneralStates(deviceJSON,gatewayJSON,c,function(a){d&&d(a)});else if(f=require("m.aio.modulemanager.js").getModule(e)){var g;b&&(g=f.resolveGateway(b));b=null;var k=this._deviceManager;k&&(b=k.getDeviceInfo());!g&&a&&(g=f.resolveDevice(a,b));g?this._commandHandler.getStates(e,g,c,function(a,b){d&&d(a,b)}):d&&d({error:Error("can not generate host")})}else d&&d({error:Error("no module can handle sys:"+e)})}else d&&d({error:Error("no sys parameter")})}else d&&
d({error:Error("no device list")});else d&&d({error:Error("no device or gateway")})};return c}();
x.hub.commandman.CommandHandlerV6=function(){var g=function(){this._logger=require("x.logger.js").getLogger("x.hub.commandman.CommandHandlerV6")};g.prototype.executeCommandWithCommandInfo=function(c,a,b){if(c)if(c.id)this.executeDeviceCommandWithId(c.id,c,a,b);else if(void 0!=c.rule&&null!=c.rule)this.executeRuleCommandWithId(c.rule,c,a,b);else if(void 0!=c.device&&null!=c.device){var f=c.device.mod;f?"cloud"==f?(c=Error("not support"),c.code="000005",a&&a(c)):this.executeDeviceCommandWithJson(c.device,
c.device.gateway,c,a):this.executeCommandMediola(c.device,c,a,b)}else c.command?this.executeCommandRaw(c,a):c.legacycloudaction?this.executeLegacyCloudAction(c.legacycloudaction,a,b):c.cloudaction?this.executeCloudAction(c.cloudaction,a,b):(c=Error("invalid parameter"),c.code="000005",a&&a(c));else c=Error("invalid parameter"),c.code="000005",a&&a(c)};g.prototype.executeCommandRaw=function(c,a){if(c&&c.command){var b="GET";c.value&&(b="POST");var f=require("url").parse(c.command),d=f.pathname;f=f.query;
var e={};f&&(e=require("querystring").parse(f));c={method:b,url:c.command,path:d,query:e,body:c.value?JSON.stringify(c.value):null,json:c.value,size:c.value?(new Buffer(JSON.stringify(c.value),"utf8")).length:0,hasValidAuth:!0};this._logger.log("trace","execute command raw "+JSON.stringify(c));var g=this;require("x.hub.js").getServer().doRequest(d,c,function(b){g._logger.log("trace","execute command raw return:"+JSON.stringify(b));var c=null;if(b)try{(c=JSON.parse(b))&&c.XC_SUC?a&&a(null,c.XC_SUC):
c&&c.XC_ERR?a&&a(Error(b)):a&&a(Error(d+" request return invalid format"))}catch(m){a&&a(m)}else a&&a(Error(d+" request return null"))})}else a&&a(Error("invalid command json"))};g.prototype.executeCommandMediola=function(c,a,b){if(c&&(c.id||c.sys))if(a&&(a.command||a.cmd))if(c.id){a={method:"POST",url:"/cmd",query:{},json:{XC_FNC:"SendGenericCmd",id:c.id,data:{cmd:a.command?a.command:a.cmd,value:a.value}}};this._logger.log("trace","execute command local directly "+JSON.stringify(a));var f=this;c=
require("x.hub.js").getServer();c.doRequest("/cmd",a,function(a){f._logger.log("trace","execute command local directly return:"+JSON.stringify(a));var c=null;if(a)try{(c=JSON.parse(a))&&c.XC_SUC?b&&b(null,c.XC_SUC):c&&c.XC_ERR?b&&b(Error(a)):b&&b(Error("/cmd request return invalid format"))}catch(p){b&&b(p)}else b&&b(Error("/cmd request return null"))})}else{c={XC_FNC:"SendSC",type:c.sys,address:c.address,data:a.command?a.command:a.cmd};if(void 0!=a.value&&null!=a.value){if(void 0==c.data||null==
c.data)c.data="";c.data+=a.value}a={method:"GET",url:"/cmd?"+require("querystring").stringify(c),path:"/cmd",query:c,body:null,json:null,size:0,hasValidAuth:!0};this._logger.log("trace","execute command mediola "+JSON.stringify(a));f=this;c=require("x.hub.js").getServer();c.doRequest("/cmd",a,function(a){f._logger.log("trace","execute command mediola return:"+JSON.stringify(a));var c=null;if(a)try{(c=JSON.parse(a))&&c.XC_SUC?b&&b(null,c.XC_SUC):c&&c.XC_ERR?b&&b(Error(a)):b&&b(Error("/cmd request return invalid format"))}catch(p){b&&
b(p)}else b&&b(Error("/cmd request return null"))})}else b&&b(Error("invalid command json"));else b&&b(Error("invalid device json"))};g.prototype.executeDeviceCommandWithId=function(c,a,b,f){var d=require("x.hub.deviceman.js").deviceManagerV6,e=d.getDevice(c);if(e)if("cloud"==f&&e.restricted)a=Error("invalid parameter"),a.code="000005",b&&b(a);else{f=null;if(e.gateway&&(f=d.getGateway(e.gateway),!f)){a=Error("invalid parameter");a.code="000005";b&&b(a);return}this.executeDeviceCommandWithJson(e,f,
a,function(a){a||d.setBufferedStates(c,null);b&&b(a)})}else a=Error("invalid parameter"),a.code="000005",b&&b(a)};g.prototype.executeDeviceCommandWithJson=function(c,a,b,f){var d=c.mod;a&&a.type&&(d=a.type);"alpha"==d&&(d="moehlenhoff");try{var e=require("x.hub.m."+d+".js");if(e&&e.executeCommandV6)e.executeCommandV6(c,a,b,function(a){a&&(a.code="000000");f&&f(a)});else{var g=Error("invalid parameter");g.code="000005";f&&f(g)}}catch(h){g=Error("invalid parameter"),g.code="000005",f&&f(g)}};g.prototype.executeRuleCommandWithId=
function(c,a,b,f){c?(c=require("x.hub.rule.js").getRuleManager().getRule(c))?c.executeCommand(a,function(a){a&&!a.code&&(a.code="000005");b&&b(a)}):(a=Error("invalid parameter"),a.code="000005",b&&b(a)):(a=Error("invalid parameter"),a.code="000005",b&&b(a))};g.prototype.executeLegacyCloudAction=function(c,a,b){this._logger.log("trace","execute legacy cloud action "+c+" from: "+b);var f=null;localStorage&&(f=localStorage.getItem("x.hub.v5.SID"));if(f){var d=parseInt(c,16);b=new Buffer(32);b.writeUInt8(Math.floor(256*
Math.random()),0);var e=Math.round((new Date).getTime()/1E3);b.writeInt32BE(e,1);b.writeUInt8(1,5);b.writeUInt8(1,6);for(e=0;e<f.length/2;e++){var g=f.substr(2*e,2);g=parseInt(g,16);b.writeUInt8(g,e+7)}b=Buffer.concat([b,new Buffer(f,"hex")]);b.writeUInt8(1,23);255<d?(b.writeUInt8(2,5),b.writeUInt8(2,23),b.writeInt16BE(d,24)):b.writeUInt8(d,24);this._logger.log("trace","execute legacy cloud action "+c+" plain buffer: "+b.toString("hex").substr(0,8)+" ...");d=require("crypto");e=new Buffer([42,115,
204,166,146,83,35,244,99,130,213,30,57,56,21,227]);g=new Buffer([118,76,69,24,233,5,91,82,57,245,163,255,98,147,114,52]);f="";d=d.createCipheriv("aes-128-cbc",e,g);d.setAutoPadding(!1);f+=d.update(b,null,"hex");f+=d.final("hex");this._logger.log("trace","execute legacy cloud action "+c+" encrypted: "+f.substr(0,8)+" ...");b=require("x.hub.js").getServer();var h=this;b.isCloudConnected()?(this._logger.log("trace","execute legacy cloud action "+c+" via cloud connection"),b={event:{type:"LEGACYRA",data:f}},
require("x.hub.js").server._cloudConnect.sendMessageActive(b,function(b){h._logger.log("trace","execute legacy cloud action "+c+" via cloud connection "+(b?"failed: "+b.message:"success"));a&&a(b)})):(this._logger.log("trace","execute legacy cloud action "+c+" via http request"),b=b.getCloudServer(),b=require("http").request({host:b,port:8888,path:"/legacy/ra",method:"POST",headers:{"Content-Type":"application/octet-stream",Connection:"close"}},function(b){b.setEncoding("utf8");var d="";b.on("data",
function(a){d+=a});b.on("end",function(){h._logger.log("trace","execute legacy cloud action "+c+" via http response:"+b.statusCode+" - "+d);var e;200!=b.statusCode&&(e=Error("http request failed with status code:"+b.statusCode));a&&(a(e),a=null)})}),b.setTimeout(5E3,function(){h._logger.log("trace","execute legacy cloud action "+c+" via http timeout");a&&(a(Error("http timeout")),calback=null)}),b.on("error",function(b){h._logger.log("trace","execute legacy cloud action "+c+" via http failed:"+b.message);
a&&(a(Error("http error: "+b.message)),calback=null)}),b.write(new Buffer(f,"hex")),b.end())}else this._logger.log("trace","execute legacy cloud action "+c+" failed: no sid"),a&&a(Error("no sid"))};g.prototype.executeCloudAction=function(c,a,b){this._logger.log("trace","execute cloud action "+c+" from: "+b);b=require("x.hub.js").getServer();if(b.isCloudConnected()){var f=this;b._cloudConnect.sendMessageActive({event:{type:"ACTION",data:c}},function(b){f._logger.log("trace","execute cloud action "+
c+" via cloud connection "+(b?"failed: "+b.message:"success"));a&&a(b)})}else this._logger.log("trace","execute cloud action "+c+" failed: cloud connection not connected"),a&&a(Error("cloud connection not connected"))};g.prototype.getBufferedDeviceStates=function(c){var a=require("x.hub.deviceman.js").deviceManagerV6.getAllBufferedStates();c&&c(null,a)};g.prototype.getDeviceStatesWithStateInfo=function(c,a,b){c?void 0!=c.id&&null!=c.id?this.getDeviceStatesWithId(c.id,a,b):void 0!=c.device&&null!=
c.device?c.device.mod?(c=Error("not support get states with "+JSON.stringify(c)),c.code="000005",a&&a(c)):this.getDeviceStatesMediola(c.device,a,b):void 0!=c.rule&&null!=c.rule?this.getRuleStatesWithId(c.rule,a,b):(c=Error("invalid parameter"),c.code="000005",a&&a(c)):a&&a(Error("state info is null"))};g.prototype.getDeviceStatesMediola=function(c,a,b){if(c&&(c.id||c.sys))if(c.id){b={method:"GET",url:"/cmd?XC_FNC=getStates",query:{XC_FNC:"getStates"}};this._logger.log("trace","get states local directly "+
JSON.stringify(b));var f=this;require("x.hub.js").getServer().doRequest("/cmd",b,function(b){f._logger.log("trace","get states local directly return:"+JSON.stringify(b));var d=null;if(b){try{d=JSON.parse(b)}catch(h){a&&a(h);return}if(d&&d.XC_ERR)a&&a(Error(b));else if(d&&d.XC_SUC){b=d.XC_SUC;for(d=0;d<b.length;d++){var g=b[d];if(g&&g.state&&g.sid==c.id){a&&a(null,g.state);return}}a&&a(null,null)}else a&&a(Error("/cmd request return invalid format"))}else a&&a(Error("/cmd request return null"))})}else a&&
a(Error("not support get state for device "+JSON.stringify(c)));else a&&a(Error("invalid device json"))};g.prototype.getDeviceStatesWithId=function(c,a,b){if(c){var f,d=require("x.hub.deviceman.js").deviceManagerV6;if(f=d.getDevice(c))if("cloud"==b&&f.restricted)f=Error("invalid parameter"),f.code="000005",a&&a(f);else{b=null;if(f.gateway&&(b=d.getGateway(f.gateway),!b)){f=Error("invalid parameter");f.code="000005";a&&a(f);return}this.getDeviceStatesWithJson(f,b,function(b,f){!b&&f&&d.setBufferedStates(c,
f);a&&a(b,f)})}else f=Error("invalid parameter"),f.code="000005",a&&a(f)}else f=Error("invalid parameter"),f.code="000005",a&&a(f)};g.prototype.getDeviceStatesWithJson=function(c,a,b){var f=c.mod;a&&a.type&&(f=a.type);"alpha"==f&&(f="moehlenhoff");try{var d=require("x.hub.m."+f+".js");if(d&&d.getStatesV6)d.getStatesV6(c,a,function(a,c){a&&(a.code="000000");b&&b(a,c)});else{var e=Error("invalid parameter");e.code="000005";b&&b(e)}}catch(p){e=Error("invalid parameter"),e.code="000005",b&&b(e)}};g.prototype.getRuleStatesWithId=
function(c,a,b){c?(b=require("x.hub.rule.js").getRuleManager().getRule(c),b||(c=Error("invalid parameter"),c.code="000005",a&&a(c)),b.getStates(function(b,c){a&&a(b,c)})):(c=Error("invalid parameter"),c.code="000005",a&&a(c))};return g}();
x.hub.commandman.Handler=function(){var g=function(){this.commandHandler=new x.hub.commandman.CommandHandler(require("./x.hub.deviceman.js").deviceManager,1);this.commandHandler2=new x.hub.commandman.CommandHandler(require("./x.hub.deviceman.js").deviceManager2,2);this.commandHandlerV6=new x.hub.commandman.CommandHandlerV6};g.prototype.CommandHandler=x.hub.commandman.CommandHandler;g.prototype.init=function(c,a){"CA"==global.HARDWARE_VERSION?this._config(c):this._configOld(c);this.commandHandler.init(a)};
g.prototype._config=function(c){var a=this;c=require("x.hub.js").getServer();c.addRoute("/xhub/commandman/executeCommand",{method:"POST"},function(b,c){(b=b.json)?a.commandHandler.executeCommand(b.device,b.gateway,b.command,function(b){c.json(a._toRestfulResponse(b.error,"ok"))}):c.json(a._toRestfulResponse({code:"000001",message:"invalid argument"}))});c.addRoute("/xhub/commandman/getState",{method:"POST"},function(b,c){(b=b.json)?a.commandHandler.getState(b.device,b.gateway,b.status,function(b){c.json(a._toRestfulResponse(b.error,
b.data))}):c.json(a._toRestfulResponse({code:"000001",message:"invalid argument"}))});c.addRoute("/api/command",function(b,c){var d=b.json;d||"GET"!=b.method||(d=b.query);a.commandHandlerV6.executeCommandWithCommandInfo(d,function(a){a?c.json({XC_ERR:{code:a.code,msg:a.message}}):c.json({XC_SUC:{}})},b.source)});c.addRoute("/api/state",function(b,c){var d=b.json;d||"GET"!=b.method||(d=b.query);a.commandHandlerV6.getDeviceStatesWithStateInfo(d,function(a,b){a?c.json({XC_ERR:{code:a.code,msg:a.message}}):
c.json({XC_SUC:b})},b.source)});c.addRoute("/api/states",function(b,c){a.commandHandlerV6.getBufferedDeviceStates(function(a,b){a?c.json({XC_ERR:{code:a.code,msg:a.message}}):c.json({XC_SUC:b})})})};g.prototype._configOld=function(c){var a=require("body-parser");c.use("/xhub/commandman",a.json({limit:"50mb"}));c.post("/xhub/commandman/executeCommand",function(a,b){this.commandHandler.executeCommand(a.body.device,a.body.gateway,a.body.command,function(a){b.json(this._toRestfulResponse(a.error,"ok"))}.bind(this))}.bind(this));
c.post("/xhub/commandman/getState",function(a,b){this.commandHandler.getState(a.body.device,a.body.gateway,a.body.status,function(a){b.json(this._toRestfulResponse(a.error,a.data))}.bind(this))}.bind(this));var b=this;c=require("x.hub.js").getServer();c.addRoute("/api/command",function(a,c){b.commandHandlerV6.executeCommandWithCommandInfo(a.query,function(a){a?c.json({XC_ERR:{code:a.code,msg:a.message}}):c.json({XC_SUC:{}})},a.source)});c.addRoute("/api/state",function(a,c){b.commandHandlerV6.getDeviceStatesWithId(a.query?
a.query.id:null,function(a,b){a?c.json({XC_ERR:{code:a.code,msg:a.message}}):c.json({XC_SUC:b})},a.source)});c.addRoute("/api/states",function(a,c){b.commandHandlerV6.getBufferedDeviceStates(function(a,b){a?c.json({XC_ERR:{code:a.code,msg:a.message}}):c.json({XC_SUC:b})})})};g.prototype._toRestfulResponse=function(c,a){return c?{status:"fail",message:c.message,code:c.code?c.code:0}:{status:"success",data:a}};return g}();module.exports=new x.hub.commandman.Handler;
