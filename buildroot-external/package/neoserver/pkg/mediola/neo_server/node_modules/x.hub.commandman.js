var x=x||{};x.hub=x.hub||{};x.hub.commandman=x.hub.commandman||{};require("x.logger.js").setLevel("trace","x.hub.commandman");
x.hub.commandman.MacroExecutor=function(){var g=function(b,a,e){this._id=-1;this._commandHandler=b;this._callback=e;this._commands=[];this._currentCommand=0;this._canceling=!1;this._cancelCB=null;this._pause=250;if(a&&a.commands){"undefined"!=typeof a.pause&&null!==a.pause&&!isNaN(a.pause)&&0<=a.pause&&(this._pause=Math.max(Math.round(a.pause),1));this._commands=a.commands;b=[];for(a=this._commands.length-1;0<=a;a--)this._commands[a].removed||b.push(this._commands[a]);this._commands=b;window&&window.XCHost&&
window.XCHost.getType&&"iOS"==window.XCHost.getType()&&XC.callHost("SYSTEM","startBGThread");this._executeNextCommand(!0)}};g.prototype.cancel=function(b){this._canceling=!0;this._cancelCB=b};g.prototype._executeNextCommand=function(b){if(this._canceling){this._canceling=!1;var a=this._cancelCB;this._cancelCB=null;b=this._callback;this._callback=null;a&&a();b&&b(Error("canceld"))}else if(this._commandHandler&&0<this._commands.length){var a=this._commands.pop(),e=this;if("command"==a.classid){var c=
{cmd:a.action.ref,device:a.action.device};c.cmd||(c.cmd={value:a.action.value});c.cmd&&null!==a.action.ext&&"undefined"!=typeof a.action.ext&&(c.cmd.ext=a.action.ext);a.action.path&&(c.cmd.path=a.action.path);"http_request"==a.action.type?this._commandHandler._doHTTPRequest(a.action.value,function(){e._executeNextCommand()}):b?this._commandHandler._executeCommand(c,function(){e._executeNextCommand()}):setTimeout(function(){e._commandHandler._executeCommand(c,function(){e._executeNextCommand()})},
e._pause)}else"navigate"==a.classid?(b={type:null},1===a.history?b.type="page_next":-1===a.history?b.type="page_prev":a.page?(b.type="navigate",b.data=a.page):b.type="refresh",e._commandHandler._doAction(b),setTimeout(function(){e._executeNextCommand(!0)},e._pause)):"sleep"==a.classid&&setTimeout(function(){e._executeNextCommand(!0)},a.time)}else this._callback&&this._callback()};return g}();
x.hub.commandman.CommandHandler=function(){var g=function(b,a){this._logger=require("x.logger.js").getLogger("x.hub.commandman.CommandHandler");this._id=a;this._commandHandler=require("m.aio.commandhandler.js").CentralHandler;this._deviceManager=b;this._deviceManager||(this._deviceManager=require("./x.hub.deviceman.js").deviceManager);this._macroExecutors=[]};g.prototype.init=function(b,a){this._logger.log("info","init command manager");a&&a()};g.prototype.executeCommandWithRef=function(b,a,e,c,d){var f,
h,l=this._deviceManager;if(b&&a){f=l.findDevice(b,a);if(!f){d&&d({error:Error("device not found")});return}f.info&&f.info.gateway&&(h=l.findGatewayWithIndex(f.info.gateway))}else if(e){if(h=l.findGateway(e),!h){d&&d({error:Error("gateway not found")});return}}else{d&&d({error:Error("device/gateway reference invalid")});return}var k,g;f&&f.info&&(k=JSON.parse(JSON.stringify(f.info)),k.deviceName=a);h&&h.info&&(g=JSON.parse(JSON.stringify(h.info)),g.gatewayName=e,g.__neoInfo={db:this._id,index:h.index});
this.executeCommand(k,g,c,d)};g.prototype.getStateWithRef=function(b,a,e,c,d){var f,h,l=this._deviceManager;if(b&&a){f=l.findDevice(b,a);if(!f){d&&d({error:Error("device not found")});return}f.info&&f.info.gateway&&(h=l.findGatewayWithIndex(f.info.gateway))}else if(e){if(h=l.findGateway(e),!h){d&&d({error:Error("gateway not found")});return}}else{d&&d({error:Error("device/gateway reference invalid")});return}var g,m;f&&f.info&&(g=JSON.parse(JSON.stringify(f.info)),g.deviceName=a);h&&h.info&&(m=JSON.parse(JSON.stringify(h.info)),
m.gatewayName=e,m.__neoInfo={db:this._id,index:h.index});this.getState(g,m,c,d)};g.prototype.executeCommandWithIdx=function(b,a,e,c){var d,f,h=this._deviceManager;if(b){d=h.findDeviceWithIndex(b);if(!d){c&&c({error:Error("device not found")});return}d.info&&d.info.gateway&&(f=h.findGatewayWithIndex(d.info.gateway))}else if(a){if(f=h.findGatewayWithIndex(a),!f){c&&c({error:Error("gateway not found")});return}}else{c&&c({error:Error("device/gateway reference invalid")});return}var g,k;d&&d.info&&(g=
JSON.parse(JSON.stringify(d.info)),g.deviceName=d.name);f&&f.info&&(k=JSON.parse(JSON.stringify(f.info)),k.gatewayName=f.name,k.__neoInfo={db:this._id,index:f.index});this.executeCommand(g,k,e,c)};g.prototype.getStateWithIdx=function(b,a,e,c,d){if(e&&Array.isArray(e))this.getStatesWithIdx(b,a,e,c,d);else{var f,h;d=this._deviceManager;if(b){f=d.findDeviceWithIndex(b);if(!f){c&&c({error:Error("device not found")});return}f.info&&f.info.gateway&&(h=d.findGatewayWithIndex(f.info.gateway))}else if(a){if(h=
d.findGatewayWithIndex(a),!h){c&&c({error:Error("gateway not found")});return}}else{c&&c({error:Error("device/gateway reference invalid")});return}var g,k;f&&f.info&&(g=JSON.parse(JSON.stringify(f.info)),g.deviceName=f.name);h&&h.info&&(k=JSON.parse(JSON.stringify(h.info)),k.gatewayName=h.name,k.__neoInfo={db:this._id,index:h.index});this.getState(g,k,e,c)}};g.prototype.getStatesWithIdx=function(b,a,e,c,d){var f,h;d=this._deviceManager;if(b){f=d.findDeviceWithIndex(b);if(!f){c&&c({error:Error("device not found")});
return}f.info&&f.info.gateway&&(h=d.findGatewayWithIndex(f.info.gateway))}else if(a){if(h=d.findGatewayWithIndex(a),!h){c&&c({error:Error("gateway not found")});return}}else{c&&c({error:Error("device/gateway reference invalid")});return}var g,k;f&&f.info&&(g=JSON.parse(JSON.stringify(f.info)),g.deviceName=f.name);h&&h.info&&(k=JSON.parse(JSON.stringify(h.info)),k.gatewayName=h.name,k.__neoInfo={db:this._id,index:h.index});b=[];for(a=0;a<e.length;a++)d=e[a],d.id&&d.value&&b.push({id:d.id,device:g,
status:d});this.getMultiStatesLegacy(g,k,b,function(a){if(a.error)c&&c(a);else{var b={data:{}};a.data&&a.data.forEach(function(a){a&&a.id&&(b.data[a.id]=a.status)});c&&c(b)}})};g.prototype.executeCommand=function(b,a,e,c){if(b||a)if(e){var d=null;a&&a.sys&&(d=a.sys);!d&&b&&b.sys&&(d=b.sys);if(d)if(d=require("x.hub.moduleman.js").modulemanager.getModule(d)){var f={};b&&(f=JSON.parse(JSON.stringify(b)));a&&(f.gateway=JSON.parse(JSON.stringify(a)));this._logger.log("trace","do command:"+JSON.stringify(f));
this._logger.log("trace","command:"+JSON.stringify(e));d.executeCommand(f,e,c)}else this.executeCommandLegacy(b,a,e,c);else c&&c({error:Error("no sys parameter")})}else c&&c({error:Error("no command")});else c&&c({error:Error("no device or gateway")})};g.prototype.getState=function(b,a,e,c){if(!e||Array.isArray(e))this.getStates(b,a,e,c);else if(b||a)if(e){var d=null;a&&a.sys&&(d=a.sys);!d&&b&&b.sys&&(d=b.sys);if(d)if(d=require("x.hub.moduleman.js").modulemanager.getModule(d)){var f={};b&&(f=JSON.parse(JSON.stringify(b)));
a&&(f.gateway=JSON.parse(JSON.stringify(a)));d.getState(f,e.value,function(a){c&&c(a)})}else this.getStateLegacy(b,a,e,c);else c&&c({error:Error("no sys parameter")})}else c&&c({error:Error("no command")});else c&&c({error:Error("no device or gateway")})};g.prototype.executeCommandLegacy=function(b,a,e,c){if(b||a)if(e){var d=null;a&&a.sys&&(d=a.sys);!d&&b&&b.sys&&(d=b.sys);if(d){var f=require("m.aio.modulemanager.js").getModule(d);if(f){var h;a&&(h=f.resolveGateway(a));a=null;var g=this._deviceManager;
g&&(a=g.getDeviceInfo());!h&&b&&(h=f.resolveDevice(b,a));h?this._commandHandler.executeCommand(d,h,b,e,function(a,d){if(b&&"cam"==b.sys&&e&&"snapshot"==e.value&&!a&&d)try{require("x.hub.camman.js").saveSnapshot(b,d,function(){})}catch(f){}c&&c({error:a,data:d})}):c&&c(Error("can not generate host"))}else c&&c({error:Error("no module can handle sys:"+d)})}else c&&c({error:Error("no sys parameter")})}else c&&c({error:Error("no command")});else c&&c({error:Error("no device or gateway")})};g.prototype.getStateLegacy=
function(b,a,e,c){if(b||a)if(e){var d=null;a&&a.sys&&(d=a.sys);!d&&b&&b.sys&&(d=b.sys);if(d){var f=require("m.aio.modulemanager.js").getModule(d);if(f){var h;a&&(h=f.resolveGateway(a));a=null;var g=this._deviceManager;g&&(a=g.getDeviceInfo());!h&&b&&(h=f.resolveDevice(b,a));h?this._commandHandler.getStates(d,h,[{id:"alias",device:b,status:e}],function(a,b){if(a)c&&c(a);else{var d=null;b[0]&&(d=b[0].status);c&&c({data:{value:d}})}}):c&&c({error:Error("can not generate host")})}else c&&c({error:Error("no module can handle sys:"+
d)})}else c&&c({error:Error("no sys parameter")})}else c&&c({error:Error("no status")});else c&&c({error:Error("no device or gateway")})};g.prototype.getStates=function(b,a,e,c){if(b||a){var d=null;a&&a.sys&&(d=a.sys);!d&&b&&b.sys&&(d=b.sys);if(d)if((d=require("x.hub.moduleman.js").modulemanager.getModule(d))&&d.updateStates){var f={};b&&(f=JSON.parse(JSON.stringify(b)));a&&(f.gateway=JSON.parse(JSON.stringify(a)));d.updateStates(f,function(a){c&&c(a)},e)}else this.getStatesLegacy(b,a,e,c);else c&&
c({error:Error("no sys parameter")})}else c&&c({error:Error("no device or gateway")})};g.prototype.getStatesLegacy=function(b,a,e,c){if(b||a){var d=null;a&&a.sys&&(d=a.sys);!d&&b&&b.sys&&(d=b.sys);if(d){var f=require("m.aio.modulemanager.js").getModule(d);if(f){var h;a&&(h=f.resolveGateway(a));a=null;var g=this._deviceManager;g&&(a=g.getDeviceInfo());!h&&b&&(h=f.resolveDevice(b,a));h?this._commandHandler.getStatesForSingleDevice(d,h,b,e,function(a,b){a?c&&c(a):c&&c({data:b})}):c&&c({error:Error("can not generate host")})}else c&&
c({error:Error("no module can handle sys:"+d)})}else c&&c({error:Error("no sys parameter")})}else c&&c({error:Error("no device or gateway")})};g.prototype.getMultiStatesLegacy=function(b,a,e,c){if(b||a)if(e){var d=null;a&&a.sys&&(d=a.sys);!d&&b&&b.sys&&(d=b.sys);if(d){var f=require("m.aio.modulemanager.js").getModule(d);if(f){var h;a&&(h=f.resolveGateway(a));a=null;var g=this._deviceManager;g&&(a=g.getDeviceInfo());!h&&b&&(h=f.resolveDevice(b,a));h?this._commandHandler.getStates(d,h,e,function(a,
b){a?c&&c(a):c&&c({data:b})}):c&&c({error:Error("can not generate host")})}else c&&c({error:Error("no module can handle sys:"+d)})}else c&&c({error:Error("no sys parameter")})}else c&&c({error:Error("no device list")});else c&&c({error:Error("no device or gateway")})};g.prototype.execute=function(b,a,e,c,d){this._handler.execute(b,a,e,c,d)};g.prototype._executeCommand=function(b,a){b&&b.device&&b.cmd?b.device.name&&b.device.room?this.executeCommandWithRef(b.device.room,b.device.name,null,b.cmd,a):
b.device.name?this.executeCommandWithRef(null,null,b.device.name,b.cmd,a):a&&a({error:Error("cmd object has no valid device")}):a&&a({error:Error("cmd object format invalid")})};g.prototype._doAction=function(b,a){a&&a({})};g.prototype._doHTTPRequest=function(b,a){var e=String(b).toLowerCase();0===e.indexOf("http:")||0===e.indexOf("https:")?(e=require("url").parse(b),e=("https:"==e.protocol?require("https"):require("http")).request({host:e.hostname,method:"GET",path:e.path,port:e.port,protocol:e.protocol},
function(b){a&&a()}),e.on("error",function(b){XC.debugf(b);a&&a()}),e.end()):(0<b.indexOf("://")&&window.XC&&window.XC.callHost&&window.XC.callHost("SYSTEM","startApp",{scheme:b}),a&&a())};g.prototype.executeMacro=function(b,a,e){var c=this,d=new x.hub.commandman.MacroExecutor(this,b,function(b){for(var e=-1,g=0;g<c._macroExecutors.length;g++)if(c._macroExecutors[g]==d){e=1;break}-1!=e&&c._macroExecutors.slice(e,1);a&&a({error:b})});d._id=this._macroExecutors.length+1;this._macroExecutors.push(d);
e&&e({id:d._id})};g.prototype.cancelMacro=function(b,a){for(var e=null,c=-1,d=0;d<this._macroExecutors.length;d++){var f=this._macroExecutors[d];if(f&&f._id==b){c=d;e=f;break}}e?(-1!=c&&this._macroExecutors.slice(c,1),e.cancel(function(){a&&a({})})):a&&a()};return g}();
x.hub.commandman.Handler=function(){var g=function(){this.commandHandler=new x.hub.commandman.CommandHandler(require("./x.hub.deviceman.js").deviceManager,1);this.commandHandler2=new x.hub.commandman.CommandHandler(require("./x.hub.deviceman.js").deviceManager2,2)};g.prototype.CommandHandler=x.hub.commandman.CommandHandler;g.prototype.init=function(b,a){this._config(b);this.commandHandler.init(a)};g.prototype._config=function(b){var a=require("body-parser");b.use("/xhub/commandman",a.json({limit:"50mb"}));
b.post("/xhub/commandman/executeCommand",function(a,b){this.commandHandler.executeCommand(a.body.device,a.body.gateway,a.body.command,function(a){b.json(this._toRestfulResponse(a.error,"ok"))}.bind(this))}.bind(this));b.post("/xhub/commandman/getState",function(a,b){this.commandHandler.getState(a.body.device,a.body.gateway,a.body.status,function(a){b.json(this._toRestfulResponse(a.error,a.data))}.bind(this))}.bind(this))};g.prototype._toRestfulResponse=function(b,a){return b?{status:"fail",message:b.message,
code:b.code?b.code:0}:{status:"success",data:a}};return g}();module.exports=new x.hub.commandman.Handler;
