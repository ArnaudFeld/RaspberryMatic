var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(h){var f=0;return function(){return f<h.length?{done:!1,value:h[f++]}:{done:!0}}};$jscomp.arrayIterator=function(h){return{next:$jscomp.arrayIteratorImpl(h)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(h,f,e){h!=Array.prototype&&h!=Object.prototype&&(h[f]=e.value)};$jscomp.getGlobal=function(h){h=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,h];for(var f=0;f<h.length;++f){var e=h[f];if(e&&e.Math==Math)return e}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(h,f){this.$jscomp$symbol$id_=h;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:f})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function h(e){if(this instanceof h)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(e||"")+"_"+f++,e)}var f=0;return h}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var h=$jscomp.global.Symbol.iterator;h||(h=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[h]&&$jscomp.defineProperty(Array.prototype,h,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var h=$jscomp.global.Symbol.asyncIterator;h||(h=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(h){$jscomp.initSymbolIterator();h={next:h};h[$jscomp.global.Symbol.iterator]=function(){return this};return h};
$jscomp.iteratorFromArray=function(h,f){$jscomp.initSymbolIterator();h instanceof String&&(h+="");var e=0,a={next:function(){if(e<h.length){var c=e++;return{value:f(c,h[c]),done:!1}}a.next=function(){return{done:!0,value:void 0}};return a.next()}};a[Symbol.iterator]=function(){return a};return a};
$jscomp.polyfill=function(h,f,e,a){if(f){e=$jscomp.global;h=h.split(".");for(a=0;a<h.length-1;a++){var c=h[a];c in e||(e[c]={});e=e[c]}h=h[h.length-1];a=e[h];f=f(a);f!=a&&null!=f&&$jscomp.defineProperty(e,h,{configurable:!0,writable:!0,value:f})}};$jscomp.polyfill("Array.prototype.keys",function(h){return h?h:function(){return $jscomp.iteratorFromArray(this,function(f){return f})}},"es6","es3");var x=x||{};x.hub=x.hub||{};x.hub.commandman=x.hub.commandman||{};
x.hub.commandman.MacroExecutor=function(){var h=function(f,e,a){this._id=-1;this._commandHandler=f;this._callback=a;this._commands=[];this._currentCommand=0;this._canceling=!1;this._cancelCB=null;this._pause=250;if(e&&e.commands){"undefined"!=typeof e.pause&&null!==e.pause&&!isNaN(e.pause)&&0<=e.pause&&(this._pause=Math.max(Math.round(e.pause),1));this._commands=e.commands;f=[];for(e=this._commands.length-1;0<=e;e--)this._commands[e].removed||f.push(this._commands[e]);this._commands=f;window&&window.XCHost&&
window.XCHost.getType&&"iOS"==window.XCHost.getType()&&XC.callHost("SYSTEM","startBGThread");this._executeNextCommand(!0)}};h.prototype.cancel=function(f){this._canceling=!0;this._cancelCB=f};h.prototype._executeNextCommand=function(f){if(this._canceling){this._canceling=!1;var e=this._cancelCB;this._cancelCB=null;f=this._callback;this._callback=null;e&&e();f&&f(Error("canceld"))}else if(this._commandHandler&&0<this._commands.length){e=this._commands.pop();var a=this;if("command"==e.classid){var c=
{cmd:e.action.ref,device:e.action.device};c.cmd||(c.cmd={value:e.action.value});c.cmd&&null!==e.action.ext&&"undefined"!=typeof e.action.ext&&(c.cmd.ext=e.action.ext);e.action.path&&(c.cmd.path=e.action.path);"http_request"==e.action.type?this._commandHandler._doHTTPRequest({url:e.action.value,method:e.action.method,headers:e.action.headers,body:e.action.body},function(){a._executeNextCommand()}):f?this._commandHandler._executeCommand(c,function(){a._executeNextCommand()}):setTimeout(function(){a._commandHandler._executeCommand(c,
function(){a._executeNextCommand()})},a._pause)}else"navigate"==e.classid?(f={type:null},1===e.history?f.type="page_next":-1===e.history?f.type="page_prev":e.page?(f.type="navigate",f.data=e.page):f.type="refresh",a._commandHandler._doAction(f),setTimeout(function(){a._executeNextCommand(!0)},a._pause)):"sleep"==e.classid&&setTimeout(function(){a._executeNextCommand(!0)},e.time)}else this._callback&&this._callback()};return h}();
x.hub.commandman.CommandHandler=function(){var h=function(e){try{var a=JSON.parse(JSON.stringify(e));"undefined"!=typeof a.username&&null!=a.username&&(a.username="xxxxxx");"undefined"!=typeof a.password&&null!=a.password&&(a.password="xxxxxx");return a}catch(c){return e}},f=function(e,a){this._logger=require("x.logger.js").getLogger("x.hub.commandman.CommandHandler");this._id=a;this._commandHandler=require("m.aio.commandhandler.js").CentralHandler;this._deviceManager=e;this._deviceManager||(this._deviceManager=
require("./x.hub.deviceman.js").deviceManager);this._macroExecutors=[]};f.prototype.init=function(e,a){this._logger.log("info","init command manager");a&&a()};f.prototype.executeCommandWithRef=function(e,a,c,b,d){var g,k=this._deviceManager;if(e&&a){var l=k.findDevice(e,a);if(!l){d&&d({error:Error("device not found")});return}l.info&&l.info.gateway&&(g=k.findGatewayWithIndex(l.info.gateway))}else if(c){if(g=k.findGateway(c),!g){d&&d({error:Error("gateway not found")});return}}else{d&&d({error:Error("device/gateway reference invalid")});
return}if(l&&l.info){var f=JSON.parse(JSON.stringify(l.info));f.deviceName=a}if(g&&g.info){var h=JSON.parse(JSON.stringify(g.info));h.gatewayName=c;h.__neoInfo={db:this._id,index:g.index}}this.executeCommand(f,h,b,d)};f.prototype.getStateWithRef=function(e,a,c,b,d){var g,k=this._deviceManager;if(e&&a){var l=k.findDevice(e,a);if(!l){d&&d({error:Error("device not found")});return}l.info&&l.info.gateway&&(g=k.findGatewayWithIndex(l.info.gateway))}else if(c){if(g=k.findGateway(c),!g){d&&d({error:Error("gateway not found")});
return}}else{d&&d({error:Error("device/gateway reference invalid")});return}if(l&&l.info){var f=JSON.parse(JSON.stringify(l.info));f.deviceName=a}if(g&&g.info){var h=JSON.parse(JSON.stringify(g.info));h.gatewayName=c;h.__neoInfo={db:this._id,index:g.index}}this.getState(f,h,b,d)};f.prototype.executeCommandWithIdx=function(e,a,c,b){var d,g=this._deviceManager;if(e){var k=g.findDeviceWithIndex(e);if(!k){b&&b({error:Error("device not found")});return}k.info&&k.info.gateway&&(d=g.findGatewayWithIndex(k.info.gateway))}else if(a){if(d=
g.findGatewayWithIndex(a),!d){b&&b({error:Error("gateway not found")});return}}else{b&&b({error:Error("device/gateway reference invalid")});return}if(k&&k.info){var l=JSON.parse(JSON.stringify(k.info));l.deviceName=k.name}if(d&&d.info){var f=JSON.parse(JSON.stringify(d.info));f.gatewayName=d.name;f.__neoInfo={db:this._id,index:d.index}}this.executeCommand(l,f,c,b)};f.prototype.getStateWithIdx=function(e,a,c,b,d){if(c&&Array.isArray(c))this.getStatesWithIdx(e,a,c,b,d);else{var g;d=this._deviceManager;
if(e){var k=d.findDeviceWithIndex(e);if(!k){b&&b({error:Error("device not found")});return}k.info&&k.info.gateway&&(g=d.findGatewayWithIndex(k.info.gateway))}else if(a){if(g=d.findGatewayWithIndex(a),!g){b&&b({error:Error("gateway not found")});return}}else{b&&b({error:Error("device/gateway reference invalid")});return}if(k&&k.info){var l=JSON.parse(JSON.stringify(k.info));l.deviceName=k.name}if(g&&g.info){var f=JSON.parse(JSON.stringify(g.info));f.gatewayName=g.name;f.__neoInfo={db:this._id,index:g.index}}this.getState(l,
f,c,b)}};f.prototype.getStatesWithIdx=function(e,a,c,b,d){var g;d=this._deviceManager;if(e){var k=d.findDeviceWithIndex(e);if(!k){b&&b({error:Error("device not found")});return}k.info&&k.info.gateway&&(g=d.findGatewayWithIndex(k.info.gateway))}else if(a){if(g=d.findGatewayWithIndex(a),!g){b&&b({error:Error("gateway not found")});return}}else{b&&b({error:Error("device/gateway reference invalid")});return}if(k&&k.info){var l=JSON.parse(JSON.stringify(k.info));l.deviceName=k.name}if(g&&g.info){var f=
JSON.parse(JSON.stringify(g.info));f.gatewayName=g.name;f.__neoInfo={db:this._id,index:g.index}}e=[];for(a=0;a<c.length;a++)d=c[a],d.id&&d.value&&e.push({id:d.id,device:l,status:d});this.getMultiStatesLegacy(l,f,e,function(a){if(a.error)b&&b(a);else{var c={data:{}};a.data&&a.data.forEach(function(a){a&&a.id&&(c.data[a.id]=a.status)});b&&b(c)}})};f.prototype.executeCommand=function(e,a,c,b){if(e||a)if(c){var d=null;a&&a.sys&&(d=a.sys);!d&&e&&e.sys&&(d=e.sys);if(d){if(("aio"==d||"neoserver"==d)&&c&&
"cfOn"==c.value||"cfOff"==c.value){if(!a||!a.__neoInfo||!a.__neoInfo.index){b&&b({});return}if(this._deviceManager.getOwnIdx()==a.__neoInfo.index){b&&b({});return}}if((d=require("x.hub.moduleman.js").modulemanager.getModule(d))&&d.executeCommand){var g={};e&&(g=JSON.parse(JSON.stringify(e)));a&&(g.gateway=JSON.parse(JSON.stringify(a)));this._logger.log("trace","do command:"+JSON.stringify(h(e)));this._logger.log("trace","command:"+JSON.stringify(c));d.executeCommand(g,c,b)}else this.executeCommandLegacy(e,
a,c,b)}else b&&b({error:Error("no sys parameter")})}else b&&b({error:Error("no command")});else b&&b({error:Error("no device or gateway")})};f.prototype.getState=function(e,a,c,b){if(!c||Array.isArray(c))this.getStates(e,a,c,b);else if(e||a)if(c){var d=null;a&&a.sys&&(d=a.sys);!d&&e&&e.sys&&(d=e.sys);if(d)if((d=require("x.hub.moduleman.js").modulemanager.getModule(d))&&d.getState){var g={};e&&(g=JSON.parse(JSON.stringify(e)));a&&(g.gateway=JSON.parse(JSON.stringify(a)));d.getState(g,c.value,function(a){b&&
b(a)})}else this.getStateLegacy(e,a,c,b);else b&&b({error:Error("no sys parameter")})}else b&&b({error:Error("no command")});else b&&b({error:Error("no device or gateway")})};f.prototype.executeCommandLegacy=function(e,a,c,b){if(e||a)if(c){var d=null;a&&a.sys&&(d=a.sys);!d&&e&&e.sys&&(d=e.sys);if(d){var g=require("m.aio.modulemanager.js").getModule(d);if(g){var k;a&&(k=g.resolveGateway(a));a=null;var l=this._deviceManager;l&&(a=l.getDeviceInfo());!k&&e&&(k=g.resolveDevice(e,a));k?this._commandHandler.executeCommand(d,
k,e,c,function(a,d){if(e&&"cam"==e.sys&&c&&"snapshot"==c.value&&!a&&d)try{require("x.hub.camman.js").saveSnapshot(e,d,function(){})}catch(m){}b&&b({error:a,data:d})}):b&&b(Error("can not generate host"))}else b&&b({error:Error("no module can handle sys:"+d)})}else b&&b({error:Error("no sys parameter")})}else b&&b({error:Error("no command")});else b&&b({error:Error("no device or gateway")})};f.prototype.getStateLegacy=function(e,a,c,b){if(e||a)if(c){var d=null;a&&a.sys&&(d=a.sys);!d&&e&&e.sys&&(d=
e.sys);if(d){var g=require("m.aio.modulemanager.js").getModule(d);if(g){var k;a&&(k=g.resolveGateway(a));a=null;var l=this._deviceManager;l&&(a=l.getDeviceInfo());!k&&e&&(k=g.resolveDevice(e,a));k?this._commandHandler.getStates(d,k,[{id:"alias",device:e,status:c}],function(a,c){a?b&&b(a):(a=null,c[0]&&(a=c[0].status),b&&b({data:{value:a}}))}):b&&b({error:Error("can not generate host")})}else b&&b({error:Error("no module can handle sys:"+d)})}else b&&b({error:Error("no sys parameter")})}else b&&b({error:Error("no status")});
else b&&b({error:Error("no device or gateway")})};f.prototype.getStates=function(e,a,c,b){if(e||a){var d=null;a&&a.sys&&(d=a.sys);!d&&e&&e.sys&&(d=e.sys);if(d)if((d=require("x.hub.moduleman.js").modulemanager.getModule(d))&&d.updateStates){var g={};e&&(g=JSON.parse(JSON.stringify(e)));a&&(g.gateway=JSON.parse(JSON.stringify(a)));d.updateStates(g,function(a){b&&b(a)},c)}else this.getStatesLegacy(e,a,c,b);else b&&b({error:Error("no sys parameter")})}else b&&b({error:Error("no device or gateway")})};
f.prototype.getStatesLegacy=function(e,a,c,b){if(e||a){var d=null;a&&a.sys&&(d=a.sys);!d&&e&&e.sys&&(d=e.sys);if(d){var g=require("m.aio.modulemanager.js").getModule(d);if(g){var k;a&&(k=g.resolveGateway(a));a=null;var l=this._deviceManager;l&&(a=l.getDeviceInfo());!k&&e&&(k=g.resolveDevice(e,a));k?this._commandHandler.getStatesForSingleDevice(d,k,e,c,function(a,c){a?b&&b(a):b&&b({data:c})}):b&&b({error:Error("can not generate host")})}else b&&b({error:Error("no module can handle sys:"+d)})}else b&&
b({error:Error("no sys parameter")})}else b&&b({error:Error("no device or gateway")})};f.prototype.getMultiStatesLegacy=function(e,a,c,b){if(e||a)if(c){var d=null;a&&a.sys&&(d=a.sys);!d&&e&&e.sys&&(d=e.sys);if(d){var g=require("m.aio.modulemanager.js").getModule(d);if(g){var k;a&&(k=g.resolveGateway(a));a=null;var l=this._deviceManager;l&&(a=l.getDeviceInfo());!k&&e&&(k=g.resolveDevice(e,a));k?this._commandHandler.getStates(d,k,c,function(a,c){a?b&&b(a):b&&b({data:c})}):b&&b({error:Error("can not generate host")})}else b&&
b({error:Error("no module can handle sys:"+d)})}else b&&b({error:Error("no sys parameter")})}else b&&b({error:Error("no device list")});else b&&b({error:Error("no device or gateway")})};f.prototype.execute=function(e,a,c,b,d){this._handler.execute(e,a,c,b,d)};f.prototype._executeCommand=function(e,a){e&&e.device&&e.cmd?e.device.name&&e.device.room?this.executeCommandWithRef(e.device.room,e.device.name,null,e.cmd,a):e.device.name?this.executeCommandWithRef(null,null,e.device.name,e.cmd,a):a&&a({error:Error("cmd object has no valid device")}):
a&&a({error:Error("cmd object format invalid")})};f.prototype._doAction=function(e,a){a&&a({})};f.prototype._doHTTPRequest=function(e,a){var c=null,b="GET",d=null,g=null;"string"===typeof e?c=e:(g=e.body||g,d=e.headers||d,b=e.method||b,c=e.url);e=String(c).toLowerCase();0===e.indexOf("http:")||0===e.indexOf("https:")?(c=require("url").parse(c),e="https:"==c.protocol?require("https"):require("http"),b={host:c.hostname,method:b,path:c.path,port:c.port,protocol:c.protocol},d&&"object"===typeof d&&(b.headers=
d),c.auth&&(b.auth=c.auth),d=e.request(b,function(b){a&&a()}),d.on("error",function(b){XC.debugf(b);a&&a()}),"string"===typeof g&&d.write(g),d.end()):(0<c.indexOf("://")&&window.XC&&window.XC.callHost&&window.XC.callHost("SYSTEM","startApp",{scheme:c}),a&&a())};f.prototype.executeMacro=function(e,a,c){var b=this,d=new x.hub.commandman.MacroExecutor(this,e,function(c){for(var e=-1,g=0;g<b._macroExecutors.length;g++)if(b._macroExecutors[g]==d){e=1;break}-1!=e&&b._macroExecutors.slice(e,1);a&&a({error:c})});
d._id=this._macroExecutors.length+1;this._macroExecutors.push(d);c&&c({id:d._id})};f.prototype.cancelMacro=function(e,a){for(var c=null,b=-1,d=0;d<this._macroExecutors.length;d++){var g=this._macroExecutors[d];if(g&&g._id==e){b=d;c=g;break}}c?(-1!=b&&this._macroExecutors.slice(b,1),c.cancel(function(){a&&a({})})):a&&a()};f.prototype.updateGeneralDeviceStates=function(e,a){var c=this;e||(e=1E4);this._deviceManager.getAllGeneralDevice(function(b,d){if(b)a&&a(b);else if(d&&0!=d.length){var g={};b=[];
for(var k=0;k<d.length;k++){var l=d[k];if(l._origin&&l._origin.info&&l.details&&l.details.states){var f=l._origin;f.states=l.details.states;l._origin.info.gateway?(l=l._origin.info.gateway,g[l]||(g[l]=[]),g[l].push(f)):b.push(f)}}var h=a,m={};d=Object.keys(g);var n=0,q=d.length+b.length;setTimeout(function(){h&&(h(null,m),h=null)},e);d.forEach(function(a){c._updateGeneralGatewayDeviceStates(a,g[a],function(a,b){if(!a&&b)for(var c in b)m[c]=b[c];n++;n==q&&h&&(h(null,m),h=null)})});b.forEach(function(a){c._updateGeneralIPDeviceStats(a,
function(a,b,c){!a&&c&&(m[b]=c);n++;n==q&&h&&(h(null,m),h=null)})})}else a&&a(null,{})})};f.prototype._updateGeneralGatewayDeviceStates=function(e,a,c){var b=this._deviceManager.findGatewayWithIndex(e);if(b)if(b.info){b=JSON.parse(JSON.stringify(b.info));b.__neoInfo={db:this._id,index:e};e=[];for(var d=0;d<a.length;d++){var g=a[d];if(g&&g.info&&g.states)for(var k in g.states)e.push({id:g.index+":"+k,device:g.info,status:g.states[k]})}this._updateGeneralStates(null,b,e,function(a,b){if(a)c&&c(a);else{a=
{};if(b)for(var d=0;d<b.length;d++){var e=b[d];if(e.id){var g=e.id.indexOf(":");if(-1!=g){var k=parseInt(e.id.substr(0,g));if(g=e.id.substr(g+1))a[k]||(a[k]={}),a[k][g]=e.status}}}c&&c(null,a)}})}else c&&c(Error("invalid gateway json"));else c&&c(Error("no such gateway"))};f.prototype._updateGeneralStates=function(e,a,c,b){if(e||a)if(c){var d=null;a&&a.sys&&(d=a.sys);!d&&e&&e.sys&&(d=e.sys);if(d){var g=require("x.hub.moduleman.js").modulemanager.getModule(d);if(g&&g.updateGeneralStates)d={},e&&(d=
JSON.parse(JSON.stringify(e))),a&&(d.gateway=JSON.parse(JSON.stringify(a))),g.updateGeneralStates(deviceJSON,gatewayJSON,c,function(a){b&&b(a)});else if(g=require("m.aio.modulemanager.js").getModule(d)){var k;a&&(k=g.resolveGateway(a));a=null;var f=this._deviceManager;f&&(a=f.getDeviceInfo());!k&&e&&(k=g.resolveDevice(e,a));k?this._commandHandler.getStates(d,k,c,function(a,c){b&&b(a,c)}):b&&b({error:Error("can not generate host")})}else b&&b({error:Error("no module can handle sys:"+d)})}else b&&b({error:Error("no sys parameter")})}else b&&
b({error:Error("no device list")});else b&&b({error:Error("no device or gateway")})};return f}();
x.hub.commandman.CommandHandlerV6=function(){var h=require("xnm.aio.gateway.js").GatewayV6,f=function(){var a=function(a){h.call(this);this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.gateway.GatewayLocal");this._options=a};a.prototype=new h;a.prototype.constructor=a;a.prototype._executeRequest=function(a,b,d,e){this._executeRequestLocal(a,b,d,e)};a.prototype._executeRequestLocal=function(a,b,d,e){this._executeRequestV5(a,b,d,e)};
a.prototype._executeRequestV5=function(a,b,d,e){if("/"==a.charAt(0))var c=a;else{c="/cmd";var g=b;b={};b.XC_FNC=a;if(g)for(var f in g)"XC_FNC"!=f&&(b[f]=g[f])}f=g=a=null;var h=c,m=0,n="GET";d&&"POST"==d.method?(n="POST",b&&(this._options.command_source&&b.data&&(b.data.source=this._options.command_source),g=b,a=JSON.stringify(b),m=a.length)):b&&(this._options.command_source&&b.data&&(b.source=this._options.command_source),h=c+"?"+require("querystring").stringify(b),f=b);b={method:n,url:h,path:c,query:f?
f:{},body:a,json:g,size:m,hasValidAuth:!0};this._logger.log("trace","execute command mediola "+JSON.stringify(b));var q=this;require("x.hub.js").getServer().doRequest(c,b,function(a){q._logger.log("trace","execute command mediola return:"+JSON.stringify(a));var b=null;if(a)try{(b=JSON.parse(a))&&b.XC_SUC?e&&e(null,b.XC_SUC):b&&b.XC_ERR?e&&e(Error(a),b.XC_ERR):e&&e(Error(c+" request return invalid format"))}catch(r){e&&e(r)}else e&&e(Error(c+" request return null"))})};return a}(),e=function(a){this._logger=
require("x.logger.js").getLogger("x.hub.commandman.CommandHandlerV6");this._deviceManager=a};e.prototype.executeCommandWithCommandInfo=function(a,c,b){if(a)if(a.id)this.executeDeviceCommandWithId(a.id,a,c,b?b.source:null);else if(void 0!=a.rule&&null!=a.rule)this.executeRuleCommandWithId(a.rule,a,c,b);else if(void 0!=a.group&&null!=a.group)this.executeGroupCommandWithId(a.group,a,c,b);else if(void 0!=a.device&&null!=a.device){var d=a.device.mod;d?"cloud"==d?(d=a.device,this.executeCloudCommand(d,
a,c,b?b.source:null)):this.executeDeviceCommandWithJson(a.device,a.device.gateway,a,c):(d=a.device,this.executeCommandMediola(d,a,c,b?b.source:null))}else a.command?this.executeCommandRaw(a,c):a.legacycloudaction?this.executeLegacyCloudAction(a.legacycloudaction,c,b?b.source:null):a.cloudaction?this.executeCloudAction(a.cloudaction,c,b?b.source:null):(a=Error("invalid parameter"),a.code="000005",c&&c(a));else a=Error("invalid parameter"),a.code="000005",c&&c(a)};e.prototype.executeCommandRaw=function(a,
c){if(a&&a.command){var b="GET";a.value&&(b="POST");var d=require("url").parse(a.command),e=d.pathname;d=d.query;var f={};d&&(f=require("querystring").parse(d));a={method:b,url:a.command,path:e,query:f,body:a.value?JSON.stringify(a.value):null,json:a.value,size:a.value?(new Buffer(JSON.stringify(a.value),"utf8")).length:0,hasValidAuth:!0};this._logger.log("trace","execute command raw "+JSON.stringify(a));var l=this;require("x.hub.js").getServer().doRequest(e,a,function(a){l._logger.log("trace","execute command raw return:"+
JSON.stringify(a));var b=null;if(a)try{(b=JSON.parse(a))&&b.XC_SUC?c&&c(null,b.XC_SUC):b&&b.XC_ERR?c&&c(Error(a)):c&&c(Error(e+" request return invalid format"))}catch(m){c&&c(m)}else c&&c(Error(e+" request return null"))})}else c&&c(Error("invalid command json"))};e.prototype.executeCommandMediola=function(a,c,b){if(a&&(a.id||a.sys))if(c&&(c.command||c.cmd)){var d=this._getGateway(a.gateway,c);if(d)if(a=JSON.parse(JSON.stringify(a)),a=this._convertDevice(a,c),c=this._convertCommand(a,c),a.id)d._executeRequest("SendGenericCmd",
{id:a.id,data:{cmd:c.value,value:c.ext}},{method:"POST"},function(a){b&&b(a)});else{var e=require("xnm.aio.gateway.js").devicemanager.getSystem(a);e&&e.executeCommandCreator?e.executeCommandCreator(d,a,c,function(a){b&&b(a)}):b&&b(Error("unknown device type"))}else b&&b(Error("unknown or invalid gateway"))}else b&&b(Error("invalid command json"));else b&&b(Error("invalid device json"))};e.prototype.executeDeviceCommandWithId=function(a,c,b,d){var e=require("x.hub.deviceman.js").deviceManagerV6,f=
e.getDevice(a);if(f)if("cloud"==d&&f.restricted)c=Error("invalid parameter"),c.code="000005",b&&b(c);else{d=null;if(f.gateway&&(d=e.getGateway(f.gateway),!d)){c=Error("invalid parameter");c.code="000005";b&&b(c);return}this.executeDeviceCommandWithJson(f,d,c,function(c){c||e.setBufferedStates(a,null);b&&b(c)})}else c=Error("invalid parameter"),c.code="000005",b&&b(c)};e.prototype.executeDeviceCommandWithJson=function(a,c,b,d){var e=a.mod;c&&c.type&&(e=c.type);"alpha"==e&&(e="moehlenhoff");try{var f=
require("x.hub.m."+e+".js");if(f&&f.executeCommandV6)f.executeCommandV6(a,c,b,function(a){a&&(a.code="000000");d&&d(a)});else{var l=Error("invalid parameter");l.code="000005";d&&d(l)}}catch(p){l=Error("invalid parameter"),l.code="000005",d&&d(l)}};e.prototype.executeRuleCommandWithId=function(a,c,b,d){if(d)if("webserver"==d.source){if(1==d.locked&&0==d.pinMatch){c=Error("access denied (locked)");c.code="000007";b&&b(c);return}}else if("cloud"==d.source&&1==d.locked&&(0==d.pinMatch||0==d.rcs)){c=Error("access denied (locked)");
c.code="000007";b&&b(c);return}a?(a=require("x.hub.rule.js").getRuleManager().getRule(a))?a.executeCommand(c,function(a){a&&!a.code&&(a.code="000005");b&&b(a)}):(c=Error("invalid parameter"),c.code="000005",b&&b(c)):(c=Error("invalid parameter"),c.code="000005",b&&b(c))};e.prototype.executeGroupCommandWithId=function(a,c,b,d){if(a)if(c){var e=require("x.hub.group.js").getGroupManager();e.getGroup(a)?(d&&("webserver"==d.source||"cloud"==d.source)&&b&&(b(),b=null),e.executeGroupCommand(a,c,function(a){a&&
!a.code&&(a.code="000005");b&&b(a)})):(a=Error("invalid parameter"),a.code="000005",b&&b(a))}else a=Error("invalid parameter"),a.code="000005",b&&b(a);else a=Error("invalid parameter"),a.code="000005",b&&b(a)};e.prototype.executeCloudCommand=function(a,c,b,d){this._logger.log("trace","execute cloud device: "+JSON.stringify(a)+" command: "+JSON.stringify(c));d=require("x.hub.js").getServer();if(d.isCloudConnected()){var e=this,f={command:{sys:a.sys,data:a.data,command:c.command}};c.value&&(f.command.value=
c.value);d._cloudConnect.sendMessageWithType(f,6,function(d){e._logger.log("trace","execute cloud device: "+JSON.stringify(a)+" command: "+JSON.stringify(c)+" "+(d?"failed: "+d.message:"success"));b&&b(d)})}else this._logger.log("trace","execute cloud command failed: cloud connection not connected"),b&&b(Error("cloud connection not connected"))};e.prototype.executeLegacyCloudAction=function(a,c,b){this._logger.log("trace","execute legacy cloud action "+a+" from: "+b);var d=null;localStorage&&(d=localStorage.getItem("x.hub.v5.SID"));
if(d){var e=parseInt(a,16);b=new Buffer(32);b.writeUInt8(Math.floor(256*Math.random()),0);var f=Math.round((new Date).getTime()/1E3);b.writeInt32BE(f,1);b.writeUInt8(1,5);b.writeUInt8(1,6);for(f=0;f<d.length/2;f++){var l=d.substr(2*f,2);l=parseInt(l,16);b.writeUInt8(l,f+7)}b=Buffer.concat([b,new Buffer(d,"hex")]);b.writeUInt8(1,23);255<e?(b.writeUInt8(2,5),b.writeUInt8(2,23),b.writeInt16BE(e,24)):b.writeUInt8(e,24);this._logger.log("trace","execute legacy cloud action "+a+" plain buffer: "+b.toString("hex").substr(0,
8)+" ...");e=require("crypto");f=new Buffer([42,115,204,166,146,83,35,244,99,130,213,30,57,56,21,227]);l=new Buffer([118,76,69,24,233,5,91,82,57,245,163,255,98,147,114,52]);d="";e=e.createCipheriv("aes-128-cbc",f,l);e.setAutoPadding(!1);d+=e.update(b,null,"hex");d+=e.final("hex");this._logger.log("trace","execute legacy cloud action "+a+" encrypted: "+d.substr(0,8)+" ...");b=require("x.hub.js").getServer();var h=this;b.isCloudConnected()?(this._logger.log("trace","execute legacy cloud action "+a+
" via cloud connection"),b={event:{type:"LEGACYRA",data:d}},require("x.hub.js").server._cloudConnect.sendMessageActive(b,function(b){h._logger.log("trace","execute legacy cloud action "+a+" via cloud connection "+(b?"failed: "+b.message:"success"));c&&c(b)})):(this._logger.log("trace","execute legacy cloud action "+a+" via http request"),b=b.getCloudServer(),b=require("http").request({host:b,port:8888,path:"/legacy/ra",method:"POST",headers:{"Content-Type":"application/octet-stream",Connection:"close"}},
function(b){b.setEncoding("utf8");var d="";b.on("data",function(a){d+=a});b.on("end",function(){h._logger.log("trace","execute legacy cloud action "+a+" via http response:"+b.statusCode+" - "+d);var e;200!=b.statusCode&&(e=Error("http request failed with status code:"+b.statusCode));c&&(c(e),c=null)})}),b.setTimeout(5E3,function(){h._logger.log("trace","execute legacy cloud action "+a+" via http timeout");c&&(c(Error("http timeout")),calback=null)}),b.on("error",function(b){h._logger.log("trace",
"execute legacy cloud action "+a+" via http failed:"+b.message);c&&(c(Error("http error: "+b.message)),calback=null)}),b.write(new Buffer(d,"hex")),b.end())}else this._logger.log("trace","execute legacy cloud action "+a+" failed: no sid"),c&&c(Error("no sid"))};e.prototype.executeCloudAction=function(a,c,b){this._logger.log("trace","execute cloud action "+a+" from: "+b);b=require("x.hub.js").getServer();if(b.isCloudConnected()){var d=this;b._cloudConnect.sendMessageActive({event:{type:"ACTION",data:a}},
function(b){d._logger.log("trace","execute cloud action "+a+" via cloud connection "+(b?"failed: "+b.message:"success"));c&&c(b)})}else this._logger.log("trace","execute cloud action "+a+" failed: cloud connection not connected"),c&&c(Error("cloud connection not connected"))};e.prototype.getBufferedDeviceStates=function(a){var c=require("x.hub.deviceman.js").deviceManagerV6.getAllBufferedStates();a&&a(null,c)};e.prototype.getDeviceStatesWithStateInfo=function(a,c,b){if(a)if(void 0!=a.id&&null!=a.id)this.getDeviceStatesWithId(a.id,
c,b);else if(void 0!=a.device&&null!=a.device){var d=a.device.mod;d?"cloud"==d?(a=Error("not support get states with "+JSON.stringify(a)),a.code="000005",c&&c(a)):this.getDeviceStatesWithJson(a.device,a.device.gateway,c):this.getDeviceStatesMediola(a.device,c,b)}else void 0!=a.rule&&null!=a.rule?this.getRuleStatesWithId(a.rule,c,b):(a=Error("invalid parameter"),a.code="000005",c&&c(a));else c&&c(Error("state info is null"))};e.prototype.getDeviceStatesMediola=function(a,c,b){if(a&&(a.id||a.sys))if(b=
this._getGateway(a.gateway)){var d=this._convertDevice(a);if(d){var e=this._getSystem(d),f=this;this._logger.log("trace","get states from gateway "+JSON.stringify(a.gateway));b._executeRequest("getStates",null,null,function(b,g){if(b)c&&c(b);else{b=null;for(var h=0;h<g.length;h++){var k=g[h];if(k){if(a.id&&k.sid==a.id&&k.state){b=k.state;break}if(e&&e._handleState&&(k=e._handleState(d,k))&&Object.keys(k)){b=k;break}}}b&&(b=f._convertStates(d,b));c&&c(null,b)}})}else c&&c(Error("invalid device"))}else c&&
c(Error("unknown or invalid gateway"));else c&&c(Error("invalid device json"))};e.prototype.getDeviceStatesWithId=function(a,c,b){if(a){var d,e=require("x.hub.deviceman.js").deviceManagerV6;if(d=e.getDevice(a))if("cloud"==b&&d.restricted)d=Error("invalid parameter"),d.code="000005",c&&c(d);else{b=null;if(d.gateway&&(b=e.getGateway(d.gateway),!b)){d=Error("invalid parameter");d.code="000005";c&&c(d);return}this.getDeviceStatesWithJson(d,b,function(b,d){!b&&d&&e.setBufferedStates(a,d);c&&c(b,d)})}else d=
Error("invalid parameter"),d.code="000005",c&&c(d)}else d=Error("invalid parameter"),d.code="000005",c&&c(d)};e.prototype.getDeviceStatesWithJson=function(a,c,b){var d=a.mod;c&&c.type&&(d=c.type);"alpha"==d&&(d="moehlenhoff");try{var e=require("x.hub.m."+d+".js");if(e&&e.getStatesV6)e.getStatesV6(a,c,function(a,c){a&&(a.code="000000");b&&b(a,c)});else{var f=Error("invalid parameter");f.code="000005";b&&b(f)}}catch(l){f=Error("invalid parameter"),f.code="000005",b&&b(f)}};e.prototype.getRuleStatesWithId=
function(a,c,b){a?(b=require("x.hub.rule.js").getRuleManager().getRule(a),b||(a=Error("invalid parameter"),a.code="000005",c&&c(a)),b.getStates(function(a,b){c&&c(a,b)})):(a=Error("invalid parameter"),a.code="000005",c&&c(a))};e.prototype._getGateway=function(a,c){if(!a)return a={},c&&c.source&&(a.command_source=c.source),new f(a);c=a;if("object"!=typeof c&&(c=require("x.hub.deviceman.js").deviceManagerV6.getGateway(c),!c))return null;c=this._convertGateway(c);return require("xnm.aio.gateway.js").resolveGateway(c)};
e.prototype._convertDevice=function(a,c){var b=JSON.parse(JSON.stringify(a));b.data=b.type;"light"==b.data&&(b.data="switch");b.type=b.sys;b.sys="aio";if("IT"==b.type)b.address&&-1==b.address.indexOf(".")&&(a=require("xnm.aio.gateway.js").devicemanager.getSystem({type:"IT"}),a=a._resolveAddress(b.address),"object"==typeof a?(b.address=a.address,b.data="bell"):b.address=a);else if("HM"==b.type||"HMIP"==b.type){if("HMIP"==b.type||b.address&&"HMIP"==b.address.substr(0,4).toUpperCase())b._ver="v5+";"v5+"==
b._ver?(b.type="HM","switch"==a.type||"light"==a.type?b.data="ip_switch":"dimmer"==a.type?b.data="ip_dimmer":"heater"==a.type?b.data="ip_heater":"shutter"==a.type?b.data="ip_blind":"blind"==a.type?b.data="ip_jalousie":"sensor"==a.type?"water"==a.subtype&&(b.data="ip_water"):a.type||(b.data=c&&c.command?"up"==c.command||"down"==c.command||"brightness"==c.command?"ip_dimmer":"stop"==c.command||"position"==c.command?"ip_blind":"lamella"==c.command?"ip_jalousie":"temperature"==c.command||"mode"==c.command?
"ip_heater":"ip_switch":"ip_switch")):"shutter"==a.type?b.data="blind":"sensor"==a.type?("illumination"==a.subtype&&(b.data="lux"),"weather"==a.subtype&&(b.data="weather_station")):a.type||(b.data=c&&c.command?"up"==c.command||"down"==c.command||"brightness"==c.command?"dimmer":"stop"==c.command||"position"==c.command||"lamella"==c.command?"blind":"temperature"==c.command||"mode"==c.command?"heater":"switch":"switch")}else"R2"==b.type?"shutter"==a.type?b.data="blind":"blind"==a.type&&(b.data="blind"):
"FS20"==b.type||"FS"==b.type?(b.type="FS20",b.address&&-1==b.address.indexOf(".")&&(a=require("xnm.aio.gateway.js").devicemanager.getSystem({type:"FS20"}),a=a._resolveAddress(b.address),b.address=a)):"KP"==b.type||"KOPP"==b.type?b.type="KOPP":"BK"==b.type?"shutter"==b.data&&(b.data="blind"):"DY"==b.type?"shutter"==b.data&&(b.data="blind"):"DY2"==b.type?"shutter"==b.data&&(b.data="blind"):"SL"==b.type?"shutter"==b.data&&(b.data="blind"):"RT"==b.type&&"shutter"==b.data&&(b.data="jalousie");return b};
e.prototype._convertCommand=function(a,c){var b=c.command?c.command:c.cmd,d=b,e=c.value;if(a.id)return"brightness"==d?d="dimTo":"position"==d?d="moveTo":"temperature"==d?d="tempTo":"lamella"==d?d="lamellaTo":"mode"!=d||"auto"!=e&&"manu"!=e&&"boost"!=e||(d="boost"==e?"boostOn":e,e=""),("HM"==a.type&&"v5+"==a._ver||"CL"==a.sys||"BL"==a.sys)&&"moveTo"==d&&(e=100-parseInt(e)),{value:d,ext:e};"brightness"==b&&(d="dimTo");"position"==b&&(d="moveTo");if("HM"==a.type){if("blind"==a.data||"ip_blind"==a.data||
"ip_jalousie"==a.data)"up"==b?d="moveUp":"down"==b&&(d="moveDown");else if("dimmer"==a.data||"ip_dimmer"==a.data)"up"==b?d="dimUp":"down"==b&&(d="dimDown");else if("heater"==a.data||"ip_heater"==a.data)"up"==b?d="tempUp":"down"==b?d="tempDown":"mode"==b?"auto"==c.value?d="ip_heater"==a.data?"auto":"setAuto":"manu"==c.value?d="ip_heater"==a.data?"manu":"setManu":"boost"==c.value&&(d="ip_heater"==a.data?"boostOn":"setBoost"):"boostOff"==b&&(d="boostOff");"temperature"==b?d="tempTo":"position"==b?d=
"moveTo":"lamella"==b&&(d="lamellaTo");"v5+"==a._ver&&"moveTo"==d&&(e=100-e)}else"FS"==a.type||"FS20"==a.type?"up"==b?"dimmer"==a.data?d="dimUp":"shutter"==a.data&&(d="moveUp"):"down"==b&&("dimmer"==a.data?d="dimDown":"shutter"==a.data&&(d="moveDown")):"KP"==a.type||"KOPP"==a.type?"up"==b?d="on":"down"==b&&(d="off"):"CF3"==a.type||"CF4"==a.type?"brightness"==b?d="bri":"color"==b?"CF3"==a.type?d="rgb":"CF4"==a.type&&(d="rgbw"):"scene"==b&&(d="scene"+c.value):"IN"==a.type?"fan"==a.data?"up"==b?d="levelUp":
"down"==b?d="levelDown":"level"==b?d="level"+c.value:"mode"==b&&("auto"==c.value?d="auto":"turbo"==c.value&&(d="turbo")):"blind"==a.data&&("up"==b?d="moveUp":"down"==b?d="moveDown":"scene"==b?d="gotoP":"position"==b&&(d="position")):"BK"==a.type?"blind"==a.data&&("up"==b?d="moveUp3s":"down"==b?d="moveDown3s":"stepUp"==b?d="moveUp":"stepDown"==b?d="moveDown":"position"==b&&(1==c.value?d="pos1":2==c.value&&(d="pos2"))):"DY"==a.type?"blind"==a.data&&("up"==b?d="moveUp":"down"==b?d="moveDown":"stepUp"==
b?d="up":"stepDown"==b&&(d="down")):"DY2"==a.type?"blind"==a.data&&("up"==b?d="moveUp":"down"==b?d="moveDown":"stepUp"==b?d="up":"stepDown"==b&&(d="down")):"ER"==a.type?"shutter"==a.data&&("up"==b?d="3sUp":"down"==b?d="3sDown":"position"==b&&("air"==c.value?d="doubleUp":"shadow"==c.value&&(d="doubleDown"))):"SL"==a.type?"blind"==a.data&&("up"==b?d="moveUp":"down"==b?d="moveDown":"stepUp"==b?d="on":"stepDown"==b&&(d="off")):"RT"==a.type?"up"==b?d="fullUp":"down"==b?d="fullDown":"stepUp"==b?d="up":
"stepDown"==b&&(d="down"):"WA"==a.type?"up"==b?d="moveUp":"down"==b?d="moveDown":"stepUp"==b?d="up":"stepDown"==b&&(d="down"):"WR"==a.type?"up"==b?d="moveUp":"down"==b&&(d="moveDown"):"CL"==a.type?"moveTo"==d&&(e=100-e):"BL"==a.type&&"moveTo"==d&&(e=100-e);return{value:d,ext:e}};e.prototype._convertGateway=function(a){a=JSON.parse(JSON.stringify(a));a.sys="aio";a.ip=a.address;a.username=a.user;a.password=a.pwd;a.version="ca";1==a.legacy&&(a.version="e1");return a};e.prototype._getSystem=function(a){return require("xnm.aio.gateway.js").devicemanager.getSystem(a)};
e.prototype.resolveDeviceStates=function(a,c){var b=c.value,d=c.source;c=c.type;var e=null,f=!1;if(a.id&&a.id==b.id)e=b.state;else if(a.device){if(a.device.gateway){if("ST"==d)return null;if("object"==typeof a.device.gateway){if(a.device.gateway.address!=d)return null}else{var h=this._deviceManager.getGateway(a.device.gateway);if(!h||h.address!=d)return null}}d=this._convertDevice(a.device);if(a.device.id&&b.sid==a.device.id&&(f=!0,e=b.state,b.changed)){h={};for(var p in e)-1!=b.changed.indexOf(p)&&
(h[p]=e[p]);e=h}if(!f&&a.device.address){if(!d)return null;a=this._getSystem(d);if(!a)return null;"state"==c?a._handleState&&(e=a._handleState(d,b)):a._handleUdpState&&(e=a._handleUdpState(d,b))}e&&(e=this._convertStates(d,e))}return e?e:null};e.prototype._convertStates=function(a,c){c=JSON.parse(JSON.stringify(c));"IW"==a.type?(c.state=c.windowState,delete c.windowState):"IT"==a.type?c.windowState?(c.state=c.windowState,delete c.windowState):c.doorState&&(c.state=c.doorState,delete c.doorState):
"HM"==a.type&&("v5+"==a._ver?"undefined"!=typeof c.blindLevel&&null!=c.blindLevel&&(c.position=100-parseInt(c.blindLevel)):("undefined"!=typeof c.blindState&&null!=c.blindState&&(c.position=c.blindState),"lux"==a.data?c.illumination=c.state:"blind"==a.data?c.position=c.blindState:"weather_station"==a.data&&(c.temperature=c.temp,delete c.temp,c.humidity=c.hum,delete c.hum,c.speed=c.winS,delete c.winS,c.direction=c.winD,delete c.winD,c.rain="on"==c.rain)));return c};e.prototype.matchDeviceState=function(a,
c){if(!a||!c)return!1;var b=c.value;b||(b="state");var d=c.states,e="==";!d&&c.comp&&(c.comp.operator&&(e=c.comp.operator),void 0!=c.comp.value&&null!=c.comp.value&&(d=[c.comp.value]));if(!d)return!1;c=a[b];if(void 0==c||null==c)return!1;a=!1;switch(e){case "==":a="true"==c||1==c?-1!=d.indexOf("true")||-1!=d.indexOf(!0):"false"==c||0==c?-1!=d.indexOf("false")||-1!=d.indexOf(!1):-1!=d.indexOf(c);break;case "!=":a="true"==c||1==c?-1==d.indexOf("true")||-1==d.indexOf(!0):"false"==c||0==c?-1==d.indexOf("false")||
-1==d.indexOf(!1):-1==d.indexOf(c);break;case ">=":a=parseFloat(c)>=parseFloat(d[0]);break;case ">":a=parseFloat(c)>parseFloat(d[0]);break;case "<=":a=parseFloat(c)<=parseFloat(d[0]);break;case "<":a=parseFloat(c)<parseFloat(d[0])}return a};return e}();
x.hub.commandman.Handler=function(){var h=function(){this.commandHandler=new x.hub.commandman.CommandHandler(require("./x.hub.deviceman.js").deviceManager,1);this.commandHandler2=new x.hub.commandman.CommandHandler(require("./x.hub.deviceman.js").deviceManager2,2);this.commandHandlerV6=new x.hub.commandman.CommandHandlerV6(require("./x.hub.deviceman.js").deviceManagerV6)};h.prototype.CommandHandler=x.hub.commandman.CommandHandler;h.prototype.CommandHandlerV6=x.hub.commandman.CommandHandlerV6;h.prototype.init=
function(f,e){"CA"==global.HARDWARE_VERSION?this._config(f):this._configOld(f);this.commandHandler.init(e)};h.prototype._config=function(f){var e=this;f=require("x.hub.js").getServer();f.addRoute("/xhub/commandman/executeCommand",{method:"POST"},function(a,c){(a=a.json)?e.commandHandler.executeCommand(a.device,a.gateway,a.command,function(a){c.json(e._toRestfulResponse(a.error,"ok"))}):c.json(e._toRestfulResponse({code:"000001",message:"invalid argument"}))});f.addRoute("/xhub/commandman/getState",
{method:"POST"},function(a,c){(a=a.json)?e.commandHandler.getState(a.device,a.gateway,a.status,function(a){c.json(e._toRestfulResponse(a.error,a.data))}):c.json(e._toRestfulResponse({code:"000001",message:"invalid argument"}))});f.addRoute("/api/command",function(a,c){var b=a.json;b||"GET"!=a.method||(b=a.query);e.commandHandlerV6.executeCommandWithCommandInfo(b,function(a){a?c.json({XC_ERR:{code:a.code,msg:a.message}}):c.json({XC_SUC:{}})},a)});f.addRoute("/api/state",function(a,c){var b=a.json;
b||"GET"!=a.method||(b=a.query);e.commandHandlerV6.getDeviceStatesWithStateInfo(b,function(a,b){a?c.json({XC_ERR:{code:a.code,msg:a.message}}):c.json({XC_SUC:b})},a.source)});f.addRoute("/api/states",function(a,c){e.commandHandlerV6.getBufferedDeviceStates(function(a,d){a?c.json({XC_ERR:{code:a.code,msg:a.message}}):c.json({XC_SUC:d})})})};h.prototype._configOld=function(f){var e=require("body-parser");f.use("/xhub/commandman",e.json({limit:"50mb"}));f.post("/xhub/commandman/executeCommand",function(a,
b){this.commandHandler.executeCommand(a.body.device,a.body.gateway,a.body.command,function(a){b.json(this._toRestfulResponse(a.error,"ok"))}.bind(this))}.bind(this));f.post("/xhub/commandman/getState",function(a,b){this.commandHandler.getState(a.body.device,a.body.gateway,a.body.status,function(a){b.json(this._toRestfulResponse(a.error,a.data))}.bind(this))}.bind(this));var a=this;f=require("x.hub.js").getServer();f.addRoute("/api/command",function(c,b){a.commandHandlerV6.executeCommandWithCommandInfo(c.query,
function(a){a?b.json({XC_ERR:{code:a.code,msg:a.message}}):b.json({XC_SUC:{}})},c.source)});f.addRoute("/api/state",function(c,b){a.commandHandlerV6.getDeviceStatesWithId(c.query?c.query.id:null,function(a,c){a?b.json({XC_ERR:{code:a.code,msg:a.message}}):b.json({XC_SUC:c})},c.source)});f.addRoute("/api/states",function(c,b){a.commandHandlerV6.getBufferedDeviceStates(function(a,c){a?b.json({XC_ERR:{code:a.code,msg:a.message}}):b.json({XC_SUC:c})})})};h.prototype._toRestfulResponse=function(f,e){return f?
{status:"fail",message:f.message,code:f.code?f.code:0}:{status:"success",data:e}};return h}();module.exports=new x.hub.commandman.Handler;
