var m=m||{};m.aio=m.aio||{};m.aio.templatemanager=m.aio.templatemanager||{};m.aio.templatemanager.OPTIONS={host:"localhost",port:8080,path:"",headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}};m.aio.templatemanager.SysTemplateUploader=function(b,a,c){this.authHeader=b;this.skinName=a;this.templateName=c};
m.aio.templatemanager.SysTemplateUploader.prototype={upload:function(b,a){var c=this;require("m.aio.configmanager.js").trace(b,function(b,e){b?a&&a(b):c._processPage(e,a)})},_processPage:function(b,a){var c=b.getChild("pagecontent"),c=this._removeDevice(JSON.parse(JSON.stringify(c.content))),d="/creatorneo/template/uploadSysTemplate?",d=d+("skin="+encodeURI(this.skinName)),d=d+("&name="+encodeURI(this.templateName)),e=this;this._doPostRequest(d,null,JSON.stringify(c),function(c,f){if(c)a&&a(c);else if(f){try{f=
JSON.parse(f)}catch(n){a&&a("upload system template response json invalid");return}if(f.id){var h=b.getFolderPath(),k=h.substr(0,h.length-2)+".png",l=require("fs");l.exists(k,function(b){b?l.readFile(k,function(b,c){b?a&&a():(d="/creatorneo/template/uploadSysTemplateThumb?",d+="id="+f.id,e._doPostRequest(d,{"Content-Type":"application/octet-stream"},c,function(b){a&&a(b)}))}):a&&a()})}else a&&a("upload system template response has not template id")}else a&&a("upload system template response invalid")})},
_removeDevice:function(b){delete b.action;b.labels&&b.labels.forEach(function(a){delete a.action;delete a.status});b.infos&&b.infos.forEach(function(a){delete a.action;delete a.status});b.buttons&&b.buttons.forEach(function(a){delete a.action;delete a.status});b.sliders&&b.sliders.forEach(function(a){delete a.action;delete a.status});b.colorchoosers&&b.colorchoosers.forEach(function(a){delete a.action;delete a.status});b.analogmeters&&b.analogmeters.forEach(function(a){delete a.action;delete a.status});
b.cams&&b.cams.forEach(function(a){a.cam&&delete a.cam.device});b.webpages&&b.webpages.forEach(function(a){a.webpage&&delete a.webpage.device});return b},_doPostRequest:function(b,a,c,d){var e=d,g=JSON.parse(JSON.stringify(m.aio.templatemanager.OPTIONS));g.path+=b;g.method="POST";this.authHeader&&(g.auth=this.authHeader);a&&Object.keys(a).forEach(function(b){g.headers[b]=a[b]});var f="";b=require("http").request(g,function(a){a.setEncoding("utf8");a.on("data",function(a){f+=a});a.on("end",function(){200==
a.statusCode?e&&e(null,f):e&&e(Error("http error with status code:"+a.statusCode),f);e=null})});b.on("error",function(a){e&&(e(a),e=null)});b.write(c);b.end()}};m.aio.templatemanager.Handler=function(){this._configmanager=null};
m.aio.templatemanager.Handler.prototype={init:function(b,a,c,d){this._configmanager=b;a&&(m.aio.templatemanager.OPTIONS.host=a,m.aio.templatemanager.OPTIONS.host=a,m.aio.templatemanager.OPTIONS.host=a);c&&0<c&&(m.aio.templatemanager.OPTIONS.port=c,m.aio.templatemanager.OPTIONS.port=c,m.aio.templatemanager.OPTIONS.port=c);process&&"local"==process.env.CLOUD&&(m.aio.templatemanager.OPTIONS.path="/webservice",m.aio.templatemanager.OPTIONS.path="/webservice",m.aio.templatemanager.OPTIONS.path="/webservice");
d&&d()},uploadSystemTemplate:function(b,a,c,d,e){b&&a&&c&&d?(new m.aio.templatemanager.SysTemplateUploader(b,a,c)).upload(d,e):e&&e(Error("invalid parameter"))},submitUserTemplate:function(b,a,c){b&&b.tenantIdx&&b.remoteIdx&&b.remotePageIdxes||c&&c(Error("options invalid"))}};"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.templatemanager.Handler);
