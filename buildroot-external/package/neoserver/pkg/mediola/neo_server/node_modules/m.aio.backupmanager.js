var m=m||{};m.aio=m.aio||{};m.aio.backupmanager=m.aio.backupmanager||{};
m.aio.backupmanager.BackupManager=function(){var e=function(){this._logger=require("x.logger.js").getLogger("m.aio.backupmanager.BackupManager");this._restoreListener=this._fm=null};e.prototype.BACKUP_DIR="backups";e.prototype.init=function(a,b,f){this._fm=a;this._restoreListener=b;f&&f()};e.prototype.getBackups=function(a){var b=require("fs-extra"),f=require("path"),h=require("async"),c=this._getBackupDir(),g=[];b.ensureDir(c,function(d){d?a&&a(d):b.readdir(c,function(b,d){b?a&&a(b):h.eachLimit(d,
10,function(b,a){var d=f.extname(b),c=f.basename(b),c=c.substr(0,c.length-d.length).toLowerCase();if(d&&".zip"==d.toLowerCase()&&c&&!(6>=c.length)&&"backup"==c.substr(0,6)&&(d=c.indexOf("_"),-1!=d&&d!=c.length-1)){var h=c.substr(d+1);h.match(/^\d+$/)&&(h=parseInt(h,10),g.push({file:b,name:c.substr(0,d),time:h}))}a()}.bind(this),function(b){a&&a(b,g)})})})};e.prototype.restoreBackup=function(a,b){var f=require("fs-extra"),h=require("path"),c=this._getBackupDir(),g=this._fm.getUserRootDataPath(),d=
this,e=h.join(c,a),c=h.basename(a),n=h.extname(a),l=c.substr(0,c.length-n.length);f.stat(e,function(a){a?(d._logger.log("warn","restore backup 1 error:"+a.message),b&&b(a)):d._unzip(e,l,function(a,c){if(a)d._logger.log("warn","restore backup 2 error:"+a.message),b&&b(a);else{var e=d._getBackupContentDirs();d._deleteCurrentFolders(e,function(a){if(a)d._logger.log("warn","restore backup 3 error:"+a.message),b&&b(a);else try{for(a=0;a<e.length;a++)f.copySync(h.join(c,e[a]),h.join(g,e[a]));d._restoreListener?
d._restoreListener(function(a){a?(d._logger.log("warn","restore backup 5 error:"+a.message),b&&b(a)):f.remove(c,function(){b&&b()})}):f.remove(c,function(){b&&b()})}catch(n){d._logger.log("warn","restore backup 4 error:"+n.message),b&&b(n)}})}})})};e.prototype.createBackup=function(a){var b=require("fs-extra"),f=require("path"),h=this._getBackupDir(),c=this;b.ensureDir(h,function(e){e?(c._logger.log("warn","create backup 1 error:"+e.message),a&&a(e)):b.readdir(h,function(d,e){if(d)c._logger.log("warn",
"create backup 2 error:"+d.message),a&&a(d);else{var g=c._findBackupPrefix(e),l=c._getBackupContentDirs(),q=c._fm.getUserRootDataPath(),k=g+"_"+Math.round((new Date).getTime()/1E3)+".zip",g=require("archiver"),k=b.createWriteStream(f.join(h,k)),g=g("zip");k.on("error",function(b){c._logger.log("warn","create backup 3 error:"+b.message);a&&(a(b),a=null)});k.on("close",function(){a&&(a(),a=null)});g.on("error",function(b){c._logger.log("warn","create backup 4 error:"+b.message);a&&(a(b),a=null)});g.pipe(k);
for(k=0;k<l.length;k++)g.directory(f.join(q,l[k]),l[k]);g.finalize()}})})};e.prototype.deleteBackup=function(a,b){var f=require("fs-extra"),e=require("path"),c=this._getBackupDir();f.ensureDir(c,function(g){g?b&&b(g):f.remove(e.join(c,a),function(a){b&&b(a)})})};e.prototype._getBackupDir=function(){return require("path").join(this._fm.getUserRootDataPath(),this.BACKUP_DIR)};e.prototype._getBackupContentDirs=function(){return["tenants","resources"]};e.prototype._findBackupPrefix=function(a){for(var b=
0,f="backup"+b;this._hasBackupWithPrefix(f,a);)b++,f="backup"+b;return f};e.prototype._hasBackupWithPrefix=function(a,b){for(var f=0;f<b.length;f++)if(b[f]&&b[f].substr(0,a.length)==a)return!0;return!1};e.prototype._unzip=function(a,b,f){var e=require("adm-zip"),c=this._fm.getTmpDir(),g=require("path"),d=require("fs-extra");a=new e(a);b=g.join(c,b);try{d.existsSync(b)&&d.removeSync(b),d.ensureDirSync(b),a.extractAllTo(b,!0),f&&f(null,b)}catch(p){f&&f(p)}};e.prototype._deleteCurrentFolders=function(a,
b){var f=require("fs-extra"),e=require("path"),c=this._fm.getUserRootDataPath();try{for(var g=0;g<a.length;g++)f.removeSync(e.join(c,a[g]));b()}catch(d){b(d)}};return e}();m.aio.backupmanager.Handler=m.aio.backupmanager.BackupManager;"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.backupmanager.Handler);
