var m=m||{};m.aio=m.aio||{};m.aio.backupmanager=m.aio.backupmanager||{};
m.aio.backupmanager.BackupManager=function(){var e=function(){this._logger=require("x.logger.js").getLogger("m.aio.backupmanager.BackupManager");this._restoreListener=this._fm=null};e.prototype.BACKUP_DIR="backups";e.prototype.init=function(a,b,f){this._fm=a;this._restoreListener=b;f&&f()};e.prototype.getBackups=function(a){var b=require("fs-extra"),f=require("path"),h=require("async"),d=this._getBackupDir(),g=[];b.ensureDir(d,function(c){c?a&&a(c):b.readdir(d,function(b,c){b?a&&a(b):h.eachLimit(c,
10,function(b,a){var c=f.extname(b),d=f.basename(b);d=d.substr(0,d.length-c.length).toLowerCase();if(c&&".zip"==c.toLowerCase()&&d&&!(6>=d.length)&&"backup"==d.substr(0,6)&&(c=d.indexOf("_"),-1!=c&&c!=d.length-1)){var h=d.substr(c+1);h.match(/^\d+$/)&&(h=parseInt(h,10),g.push({file:b,name:d.substr(0,c),time:h}))}a()}.bind(this),function(b){a&&a(b,g)})})})};e.prototype.restoreBackup=function(a,b){var f=require("fs-extra"),h=require("path"),d=this._getBackupDir(),g=this._fm.getUserRootDataPath(),c=
this,e=h.join(d,a);d=h.basename(a);a=h.extname(a);var p=d.substr(0,d.length-a.length);f.stat(e,function(a){a?(c._logger.log("warn","restore backup 1 error:"+a.message),b&&b(a)):c._unzip(e,p,function(a,d){if(a)c._logger.log("warn","restore backup 2 error:"+a.message),b&&b(a);else{var e=c._getBackupContentDirs();c._deleteCurrentFolders(e,function(a){if(a)c._logger.log("warn","restore backup 3 error:"+a.message),b&&b(a);else try{for(a=0;a<e.length;a++)f.copySync(h.join(d,e[a]),h.join(g,e[a]));c._restoreListener?
c._restoreListener(function(a){a?(c._logger.log("warn","restore backup 5 error:"+a.message),b&&b(a)):f.remove(d,function(){b&&b()})}):f.remove(d,function(){b&&b()})}catch(l){c._logger.log("warn","restore backup 4 error:"+l.message),b&&b(l)}})}})})};e.prototype.createBackup=function(a){var b=require("fs-extra"),f=require("path"),h=this._getBackupDir(),d=this;b.ensureDir(h,function(e){e?(d._logger.log("warn","create backup 1 error:"+e.message),a&&a(e)):b.readdir(h,function(c,e){if(c)d._logger.log("warn",
"create backup 2 error:"+c.message),a&&a(c);else{var g=d._findBackupPrefix(e);c=d._getBackupContentDirs();e=d._fm.getUserRootDataPath();var k=g+"_"+Math.round((new Date).getTime()/1E3)+".zip";g=require("archiver");k=b.createWriteStream(f.join(h,k));g=g("zip");k.on("error",function(b){d._logger.log("warn","create backup 3 error:"+b.message);a&&(a(b),a=null)});k.on("close",function(){a&&(a(),a=null)});g.on("error",function(b){d._logger.log("warn","create backup 4 error:"+b.message);a&&(a(b),a=null)});
g.pipe(k);for(k=0;k<c.length;k++)g.directory(f.join(e,c[k]),c[k]);g.finalize()}})})};e.prototype.deleteBackup=function(a,b){var f=require("fs-extra"),e=require("path"),d=this._getBackupDir();f.ensureDir(d,function(g){g?b&&b(g):f.remove(e.join(d,a),function(a){b&&b(a)})})};e.prototype._getBackupDir=function(){return require("path").join(this._fm.getUserRootDataPath(),this.BACKUP_DIR)};e.prototype._getBackupContentDirs=function(){return["tenants","resources"]};e.prototype._findBackupPrefix=function(a){for(var b=
0,f="backup"+b;this._hasBackupWithPrefix(f,a);)b++,f="backup"+b;return f};e.prototype._hasBackupWithPrefix=function(a,b){for(var f=0;f<b.length;f++)if(b[f]&&b[f].substr(0,a.length)==a)return!0;return!1};e.prototype._unzip=function(a,b,f){var e=require("adm-zip"),d=this._fm.getTmpDir(),g=require("path"),c=require("fs-extra");a=new e(a);b=g.join(d,b);try{c.existsSync(b)&&c.removeSync(b),c.ensureDirSync(b),a.extractAllTo(b,!0),f&&f(null,b)}catch(n){f&&f(n)}};e.prototype._deleteCurrentFolders=function(a,
b){var e=require("fs-extra"),h=require("path"),d=this._fm.getUserRootDataPath();try{for(var g=0;g<a.length;g++)e.removeSync(h.join(d,a[g]));b()}catch(c){b(c)}};return e}();m.aio.backupmanager.Handler=m.aio.backupmanager.BackupManager;"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.backupmanager.Handler);
