var m=m||{};m.aio=m.aio||{};m.aio.backupmanager=m.aio.backupmanager||{};
m.aio.backupmanager.BackupManager=function(){var g=function(){this._logger=require("x.logger.js").getLogger("m.aio.backupmanager.BackupManager");this._restoreListener=this._fm=null};g.prototype.BACKUP_DIR="backups";g.prototype.init=function(a,b,f){this._fm=a;this._restoreListener=b;f&&f()};g.prototype.getBackups=function(a){var b=require("fs-extra"),f=require("path"),k=require("async"),d=this._getBackupDir(),e=[];b.ensureDir(d,function(c){c?a&&a(c):b.readdir(d,function(b,d){b?a&&a(b):k.eachLimit(d,
10,function(b,a){var d=f.extname(b),h=f.basename(b);h=h.substr(0,h.length-d.length).toLowerCase();if(d&&".zip"==d.toLowerCase()&&h&&!(6>=h.length)&&"backup"==h.substr(0,6)&&(d=h.indexOf("_"),-1!=d&&d!=h.length-1)){var c=h.substr(d+1);c.match(/^\d+$/)&&(c=parseInt(c,10),e.push({file:b,name:h.substr(0,d),time:c}))}a()}.bind(this),function(b){a&&a(b,e)})})})};g.prototype.restoreBackup=function(a,b){var f=require("fs-extra"),k=require("path"),d=this._getBackupDir(),e=this._fm.getUserRootDataPath(),c=
this,g=k.join(d,a);d=k.basename(a);a=k.extname(a);var l=d.substr(0,d.length-a.length);f.stat(g,function(a){a?(c._logger.log("warn","restore backup 1 error:"+a.message),b&&b(a)):c._unzip(g,l,function(a,d){if(a)c._logger.log("warn","restore backup 2 error:"+a.message),b&&b(a);else{var h=c._getBackupContentDirs();c._deleteCurrentFolders(h,function(a){if(a)c._logger.log("warn","restore backup 3 error:"+a.message),b&&b(a);else try{for(a=0;a<h.length;a++)f.copySync(k.join(d,h[a]),k.join(e,h[a]));c._restoreListener?
c._restoreListener(function(a){a?(c._logger.log("warn","restore backup 5 error:"+a.message),b&&b(a)):f.remove(d,function(){b&&b()})}):f.remove(d,function(){b&&b()})}catch(r){c._logger.log("warn","restore backup 4 error:"+r.message),b&&b(r)}})}})})};g.prototype.createBackup=function(a){var b=require("fs-extra"),f=require("path"),k=this._getBackupDir(),d=this;d._logger.log("debug","Backup dir: "+k);b.ensureDir(k,function(e){e?(d._logger.log("warn","create backup 1 error:"+e.message),a&&a(e)):b.readdir(k,
function(c,e){if(c)d._logger.log("warn","create backup 2 error:"+c.message),a&&a(c);else{c=d._findBackupPrefix(e);var g=d._getBackupContentDirs(),p=d._fm.getUserRootDataPath(),q=c+"_"+Math.round((new Date).getTime()/1E3)+".zip";d._logger.log("debug","ZIP file to create: "+q);var n=["ssse3","sse4_1","sse4_2"];XC.hasCPUFeatures(n,function(c){d._logger.log("debug","Checked CPU for features: "+n.join(", ")+". Result: "+c);if(c){var e=require("archiver");c=b.createWriteStream(f.join(k,q));e=e("zip");c.on("error",
function(b){d._logger.log("warn","create backup 3 error:"+b.message);a&&(a(b),a=null)});c.on("close",function(){a&&(a(),a=null)});e.on("error",function(b){d._logger.log("warn","create backup 4 error:"+b.message);a&&(a(b),a=null)});e.pipe(c);for(c=0;c<g.length;c++)d._logger.log("debug","Adding directory: "+g[c]),e.directory(f.join(p,g[c]),g[c]);d._logger.log("debug","Calling ZIP finalize.");e.finalize()}else{var h=new (require("jszip")),l=Date.now(),t=function(a){h.folder(a);for(var c=b.readdirSync(f.join(p,
a),{withFileTypes:!0}),d=0;d<c.length;d++){var e=c[d];if(e.isFile()){var g=e.name.toLowerCase();".ds_store"!==g&&"thumbs.db"!==g&&(g=f.join(p,a,e.name),g=b.readFileSync(g),e=e.name,a&&(e=a+"/"+e),h.file(e,g))}else e.isDirectory()&&t(a+"/"+e.name)}};for(c=0;c<g.length;c++)t(g[c]);d._logger.log("debug","Listed all folders and files in "+(Date.now()-l)+" ms.");l=Date.now();h.generateNodeStream({compression:"DEFLATE",compressionOptions:{level:6},streamFiles:!0,type:"nodebuffer"}).pipe(b.createWriteStream(f.join(k,
q))).on("finish",function(){d._logger.log("debug","Backup ZIP has been created: "+q);d._logger.log("debug","Creating the ZIP took "+(Date.now()-l)+" ms.");a&&(a(),a=null)})}})}})})};g.prototype.deleteBackup=function(a,b){var f=require("fs-extra"),g=require("path"),d=this._getBackupDir();f.ensureDir(d,function(e){e?b&&b(e):f.remove(g.join(d,a),function(a){b&&b(a)})})};g.prototype._getBackupDir=function(){return require("path").join(this._fm.getUserRootDataPath(),this.BACKUP_DIR)};g.prototype._getBackupContentDirs=
function(){return["tenants","resources"]};g.prototype._findBackupPrefix=function(a){for(var b=0,f="backup"+b;this._hasBackupWithPrefix(f,a);)b++,f="backup"+b;return f};g.prototype._hasBackupWithPrefix=function(a,b){for(var f=0;f<b.length;f++)if(b[f]&&b[f].substr(0,a.length)==a)return!0;return!1};g.prototype._unzip=function(a,b,f){var g=this._fm.getTmpDir(),d=require("path"),e=require("fs-extra"),c=d.join(g,b);try{e.existsSync(c)&&e.removeSync(c),e.ensureDirSync(c)}catch(p){f&&f(p);return}var n=this,
l=["ssse3","sse4_1","sse4_2"];XC.hasCPUFeatures(l,function(b){n._logger.log("debug","Checked CPU for features: "+l.join(", ")+". Result: "+b);if(b){n._logger.log("debug","Unzipping backup file with ADM-ZIP.");b=Date.now();var d=new (require("adm-zip"))(a);try{d.extractAllTo(c,!0),n._logger.log("debug","Finished unzipping after "+(Date.now()-b)+" ms."),f&&f(null,c)}catch(u){f&&f(u)}}else XC.unzip(a,c,n._logger,f)})};g.prototype._deleteCurrentFolders=function(a,b){var f=require("fs-extra"),g=require("path"),
d=this._fm.getUserRootDataPath();try{for(var e=0;e<a.length;e++)f.removeSync(g.join(d,a[e]));b()}catch(c){b(c)}};return g}();m.aio.backupmanager.Handler=m.aio.backupmanager.BackupManager;"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.backupmanager.Handler);
