var m=m||{};m.aio=m.aio||{};m.aio.syncmanager=m.aio.syncmanager||{};m.aio.syncmanager.PROTOCOL="https";m.aio.syncmanager.HOST="127.0.0.1";m.aio.syncmanager.PORT=8080;m.aio.syncmanager.PATH="";m.aio.syncmanager.HEADERS={"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"};
m.aio.syncmanager.RemotesDownloader=function(d,b,c,a){this._logger=require("x.logger.js").getLogger("RemotesDownloader");this._host=d;this._port=b;this._username=c?c:"";this._password=a?a:""};m.aio.syncmanager.RemotesDownloader.PROTOCOL="https";m.aio.syncmanager.RemotesDownloader.OPTIONS={host:"127.0.0.1",port:8080,path:"",headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}};
m.aio.syncmanager.RemotesDownloader.prototype.downloadRemoteList=function(d){this._logger.log("debug","download remotes list from account:"+this._username);this._doRemoteDownloadReq(function(b,c){if(b)d&&d(b);else if(c.infos){var a={remotes:[],info:c};if(0!=c.infos.length)for(var e=0;e<c.infos.length;e++)c.infos[e].name&&a.remotes.push({name:c.infos[e].name,encrypt:c.infos[e].encrypt?!0:!1});d&&d(null,a)}else d&&d(Error("download response format invalid"))})};
m.aio.syncmanager.RemotesDownloader.prototype.download=function(d,b){this._logger.log("debug","download remotes from account:"+this._username);var c=this;this._doRemoteDownloadReq(function(a,e){a?b&&b(a):e.infos?0==e.infos.length?b&&b():c._doDownloadRemotes(d,e.credential,e.infos,function(a){b&&b(a)}):b&&b(Error("download response format invalid"))})};
m.aio.syncmanager.RemotesDownloader.prototype._doRemoteDownloadReq=function(d){this._doGetRequest("/creatorneo/remote/requestDownload",null,function(b,c){if(b)d&&d(b);else try{var a=JSON.parse(c);d&&d(null,a)}catch(e){d&&d(e)}})};
m.aio.syncmanager.RemotesDownloader.prototype._doDownloadRemotes=function(d,b,c,a){var e=new m.aio.syncmanager.RemoteDownloader({host:this._host,port:this._port,username:this._username,password:this._password,credential:b}),g=new function(){this.idx=0;this.cb=a;this._onFinish=function(a){a?this.cb&&this.cb(a):(this.idx+=1,this.idx==c.length?this.cb&&this.cb():e.download(d,c[idx],function(a){g._onFinish.call(g,a)}))}};e.download(d,c[0],function(a){g._onFinish.call(g,a)})};
m.aio.syncmanager.RemotesDownloader.prototype._doGetRequest=function(d,b,c){var a=c,e=JSON.parse(JSON.stringify(m.aio.syncmanager.RemotesDownloader.OPTIONS));e.host=this._host?this._host:e.host;e.port=this._port?this._port:e.port;e.path+=d;e.method="GET";this._username&&this._password&&(e.auth=this._username+":"+this._password);b&&Object.keys(b).forEach(function(a){e.headers[a]=b[a]});var g="";d=require(m.aio.syncmanager.RemotesDownloader.PROTOCOL).request(e,function(c){c.setEncoding("utf8");c.on("data",
function(a){g+=a});c.on("end",function(){200==c.statusCode?a&&a(null,g):a&&a(Error("http error with status code:"+c.statusCode),g);a=null})});d.on("error",function(c){a&&(a(c),a=null)});d.end()};m.aio.syncmanager.RemotesDownloader.prototype._decrypt=function(d,b){try{return require("x.crypt.js").AES.decodeString(d,b).trim()}catch(c){return console.log(c),null}};
m.aio.syncmanager.RemotesDownloader.prototype._findRemote=function(d,b){if(!d||!b||!b.infos||0==b.infos.length)return null;for(var c=0;c<b.infos.length;c++)if(b.infos[c].name==d)return b.infos[c];return null};
m.aio.syncmanager.RemoteDownloader=function(d,b){var c=require("x.logger.js");this._logger=c?c.getLogger("RemoteDownloader"):{log:function(){}};this._listener=b;this._host=d.host;this._port=d.port;this._username=d.username?d.username:"";this._password=d.password?d.password:"";this._override="true"==d.override;this._s3cred=d.credential;this._remotePassword=d.remotePassword;this._encrypted=!1;this._s3cred&&(this._s3Client=new (require("aws-sdk").S3)({apiVersion:"2006-03-01",region:"eu-central-1",accessKeyId:d.credential.accessKeyId,
secretAccessKey:d.credential.secretAccessKey,sessionToken:d.credential.sessionToken}))};m.aio.syncmanager.RemoteDownloader.PROTOCOL="https";m.aio.syncmanager.RemoteDownloader.OPTIONS={host:"127.0.0.1",port:8080,path:"",headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}};
m.aio.syncmanager.RemoteDownloader.prototype.download=function(d,b,c){this._logger.log("trace","download remote:"+b.name);var a=this,e,g=require("path");if(b.name){if(this._listener&&this._listener.onProgress)this._listener.onDownloadProgress(0,"start download");if(b.resources&&0!=b.resources.length){if(b.encrypt){this._encrypted=!0;if(!this._remotePassword){c&&(e=Error("no remote password"),e.code=1,c(e));return}if(this._decrypt(b.encrypt,this._remotePassword)!=b.name){c&&(e=Error("remote password error"),
e.code=2,c(e));return}}var f=require("fs"),h=d+g.sep+b.name;try{var k=f.existsSync(h);if(k&&!this._override){c&&(e=Error("remote:"+b.name+" already exists"),e.code=3,c(e));return}if(k&&this._override){var l=(new Date).getTime();f.renameSync(h,h+"_"+l);this._deldir(h+"_"+l)}}catch(n){c&&c(n);return}if(this._listener&&this._listener.onProgress)this._listener.onDownloadProgress(1,"start to download files",{filesCount:b.resources.length});this._mkdir(d+g.sep+b.name,function(){var e=c,f=0,h=function(c){if(e&&
a._listener&&a._listener.onProgress)a._listener.onDownloadProgress(2,"one file download finish");f+=1;c?e&&(e(c),e=null):f==b.resources.length?e&&(e(),e=null):a._downloadFile(d+g.sep+b.name,b.resources[f],h)};a._downloadFile(d+g.sep+b.name,b.resources[f],h)})}else c&&c()}else c&&c(Error("remote info has no remote name"))};
m.aio.syncmanager.RemoteDownloader.prototype._downloadFile=function(d,b,c){var a=this;this._logger.log("trace","download file:"+b.file);b.file?"device_db"===b.file?c&&c():b.file.match(/^resources.*/)&&this._s3cred?this._downloadFileFromS3(d,b,function(e){a._logger.log("trace","download file finish:"+b.file);e&&a._logger.log("trace","download file "+b.file+" from s3 error:"+e.message);c&&c(e)}):this._downloadFileFromServer(d,b,function(e){a._logger.log("trace","download file finish:"+b.file);if(e)a._logger.log("trace",
"download file "+b.file+" from server error:"+e.message),c&&c(e);else if("device_db"==b.file&&a._encrypted){e=require("path");var g=b.file.replace(/\//g,e.sep);a._decryptFile(d+e.sep+g,function(a){c&&c(a)})}else c&&c()}):c&&c(Error("file info has no file path"))};
m.aio.syncmanager.RemoteDownloader.prototype._downloadFileFromServer=function(d,b,c){if(b.ref){var a=require("path"),e=require("fs"),g=b.file.replace(/\//g,a.sep),f=d+a.sep+g;this._logger.log("trace","download file to:"+f);d=f.lastIndexOf(a.sep);d=f.substr(0,d);try{e.mkdirRecursiveSync(d)}catch(h){c&&c(h);return}d=require(m.aio.syncmanager.RemoteDownloader.PROTOCOL);var a=this._host?this._host:m.aio.syncmanager.RemoteDownloader.OPTIONS.host,g=this._port?this._port:m.aio.syncmanager.RemoteDownloader.OPTIONS.port,
k=m.aio.syncmanager.RemoteDownloader.OPTIONS.path+"/creatorneo/remote/downloadFile";b=b.ref.split("/");for(var l=0;l<b.length;l++)b[l]=encodeURI(b[l]);b=m.aio.syncmanager.RemoteDownloader.PROTOCOL+"://"+a+":"+g+k+"/"+b.join("/");a=this._username?encodeURIComponent(this._username):"";g=this._password?encodeURIComponent(this._password):"";b+="?username="+a+"&password="+g;this._logger.log("trace","download file url:"+b);var n=e.createWriteStream(f);d.get(b,function(a){a.pipe(n);n.on("finish",function(){n.close(c)})}).on("error",
function(a){e.unlink(f);c&&c(a)})}else c&&c(Error("file info has no ref"))};
m.aio.syncmanager.RemoteDownloader.prototype._downloadFileFromS3=function(d,b,c){if(this._s3Client)if(b.ref){var a=require("path"),e=require("fs"),g=b.file.replace(/\//g,a.sep),f=d+a.sep+g;this._logger.log("trace","download file to:"+f);d=f.lastIndexOf(a.sep);d=f.substr(0,d);try{e.mkdirRecursiveSync(d)}catch(h){c&&c(h);return}this._s3Client.getObject({Bucket:"mediola-creator",Key:"resources/"+b.ref},function(a,b){a?c&&c(a):e.writeFile(f,b.Body,function(a){c&&c(a)})})}else c&&c(Error("file info has no ref"));
else c&&c(Error("s3 client not properly initialized"))};m.aio.syncmanager.RemoteDownloader.prototype._mkdir=function(d,b){var c=require("fs");try{c.mkdirSync(d)}catch(a){this._logger.log("warn","creator folder "+d+" error:"+a.message)}b&&b()};m.aio.syncmanager.RemoteDownloader.prototype._deldir=function(d){var b=require("fs"),c=this;b.existsSync(d)&&(b.readdirSync(d).forEach(function(a,e){var g=d+"/"+a;b.lstatSync(g).isDirectory()?c._deldir(g):b.unlinkSync(g)}),b.rmdirSync(d))};
m.aio.syncmanager.RemoteDownloader.prototype._decrypt=function(d,b){try{return require("x.crypt.js").AES.decodeString(d,b).trim()}catch(c){return console.log(c),null}};m.aio.syncmanager.RemoteDownloader.prototype._decryptFile=function(d,b){var c=this,a=require("fs"),e=d+".bak";a.rename(d,e,function(g){g?b&&b(g):a.readFile(e,{encoding:"utf8"},function(g,h){if(g)b&&b(g);else{var k=c._decrypt(h,c._remotePassword);k?a.writeFile(d,k,function(c){c?b&&b(c):a.unlink(e,function(a){b&&b(a)})}):b&&b(Error("decrypt error"))}})})};
m.aio.syncmanager.RemoteUploader=function(d,b){var c=require("x.logger.js");this._logger=c?c.getLogger("RemoteUploader"):{log:function(){}};this._username=d.username?d.username:"";this._password=d.password?d.password:"";this._remotePassword=d.remotePassword?d.remotePassword:"";this._listener=b};m.aio.syncmanager.RemoteUploader.PROTOCOL="https";
m.aio.syncmanager.RemoteUploader.OPTIONS={host:"127.0.0.1",port:8080,path:"",headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}};
m.aio.syncmanager.RemoteUploader.prototype.upload=function(d,b,c,a){if(d)if(c){this._logger.log("debug","upload remote:"+c.id);var e=this;this._logger.log("trace","send upload remote request.");if(this._listener&&this._listener.onProgress)this._listener.onProgress(0,"start upload");this._doRemoteUploadReq(d,b,c,function(g,f){g?(e._logger.log("trace","send upload remote request error:"+g.stack),a&&a(g)):f.resources?(e._logger.log("trace","upload data one by one."),e._uploadResources(d,b,c,f,function(c,
b){c?a&&a(c):(e._logger.log("trace","send upload remote finish request."),e._finishUploadRemote(d,b,function(c){a&&a(c)}))})):a&&a(Error("server return format error"))})}else a&&a(Error("remote is null"));else a&&a(Error("license is empty"))};
m.aio.syncmanager.RemoteUploader.prototype._doRemoteUploadReq=function(d,b,c,a){var e=this,g=new m.aio.syncmanager.Assembler;if(this._listener&&this._listener.onProgress)this._listener.onProgress(1,"assemble files");g.generateRemoteUploadReq(b,c,function(c,b){if(e._listener&&e._listener.onProgress)e._listener.onProgress(2,"inform server for upcoming upload");e._doPostRequest("/creatorneo/remote/requestUpload?license="+d,null,JSON.stringify(b),function(c,b){if(c)a&&a(c);else try{var e=JSON.parse(b);
a&&a(null,e)}catch(d){a&&a(d)}})})};
m.aio.syncmanager.RemoteUploader.prototype._uploadResources=function(d,b,c,a,e){if(a&&a.resources){var g=new (require("aws-sdk").S3)({apiVersion:"2006-03-01",region:"eu-central-1",accessKeyId:a.credential.accessKeyId,secretAccessKey:a.credential.secretAccessKey,sessionToken:a.credential.sessionToken});if(this._listener&&this._listener.onProgress)this._listener.onProgress(3,"start to upload files",{filesCount:a.resources.length});var f=this;require("async").eachLimit(a.resources,5,function(a,e){if(a.exists&&
a.file&&"device_db"!=a.file){if(f._listener&&f._listener.onProgress)f._listener.onProgress(4,"one file upload finish");e()}else if(a.file)a.file.match(/^resources.*/)?f._uploadFileToS3(g,b,c,a,function(c){a.success=c?!1:!0;if(f._listener&&f._listener.onProgress)f._listener.onProgress(4,"one file upload finish");e(c)}):f._uploadFileToServer(d,b,c,a,function(c){a.success=c?!1:!0;if(f._listener&&f._listener.onProgress)f._listener.onProgress(4,"one file upload finish");e(c)});else{a.success=!1;if(f._listener&&
f._listener.onProgress)f._listener.onProgress(4,"one file upload finish");e(Error("resource index has no file parameter"))}},function(c){e&&e(c,a)})}else e&&e(Error("no resource to upload in the req"))};
m.aio.syncmanager.RemoteUploader.prototype._uploadFileToServer=function(d,b,c,a,e){this._logger.log("trace","upload remote file:"+a.file);var g=this,f=require("fs"),h=require("path");c=c.getFolderPath();b=b.getFolderPath();switch(a.file){case "device_db":f.readFile(c+h.sep+a.file,function(c,b){if(c)e&&e(c);else{"device_db"==a.file&&g._remotePassword&&(b=g._encrypt(b,g._remotePassword));var f="/creatorneo/remote/uploadFile?license="+d,h={"Remote-File-Ref-Base64":!0,"Remote-File-Ref":(new Buffer(a.ref)).toString("base64"),
"Remote-File-MD5":a.md5,"Remote-File-SHA1":a.sha1,"Remote-File-Size":a.size};g._doPostRequest(f,h,b,function(c,b){c&&g._logger.log("trace","upload remote file "+a.file+" error:"+b);e&&e(c)})}});break;case "macros_db":case "deviceinfo.xml":f.readFile(b+h.sep+a.file,function(c,b){if(c)e&&e(c);else{"device_db"==a.file&&g._remotePassword&&(b=g._encrypt(b,g._remotePassword));var f="/creatorneo/remote/uploadFile?license="+d,h={"Remote-File-Ref-Base64":!0,"Remote-File-Ref":(new Buffer(a.ref)).toString("base64"),
"Remote-File-MD5":a.md5,"Remote-File-SHA1":a.sha1,"Remote-File-Size":a.size};g._doPostRequest(f,h,b,function(c,b){c&&g._logger.log("trace","upload remote file "+a.file+" error:"+b);e&&e(c)})}});break;default:f.readFile(c+h.sep+a.file,function(c,b){if(c)e&&e(c);else{var f="/creatorneo/remote/uploadFile?license="+d,h={"Remote-File-Ref-Base64":!0,"Remote-File-Ref":(new Buffer(a.ref)).toString("base64"),"Remote-File-MD5":a.md5,"Remote-File-SHA1":a.sha1,"Remote-File-Size":a.size};g._doPostRequest(f,h,
b,function(c,b){c&&g._logger.log("trace","upload remote file "+a.file+" error:"+b);e&&e(c)})}})}};
m.aio.syncmanager.RemoteUploader.prototype._uploadFileToS3=function(d,b,c,a,e){this._logger.log("trace","upload remote resource:"+a.file);b=require("fs");var g=require("path");c=c.getFolderPath();var f=e;e=b.createReadStream(c+g.sep+a.file);e.on("error",function(a){f&&(f(a),f=null)});d.putObject({Bucket:"mediola-creator",Key:"resources/"+a.ref,Body:e},function(c){a.success=c?!1:!0;f&&(f(c),f=null)}).on("error",function(a){f&&(f(a),f=null)})};
m.aio.syncmanager.RemoteUploader.prototype._finishUploadRemote=function(d,b,c){if(this._listener&&this._listener.onProgress)this._listener.onProgress(5,"finalize the upload porcess");this._remotePassword&&(b.encrypt=this._encrypt(b.name,this._remotePassword));this._doPostRequest("/creatorneo/remote/finishUpload?license="+d,null,JSON.stringify(b),function(a,b){c&&c(a,b)})};
m.aio.syncmanager.RemoteUploader.prototype._doPostRequest=function(d,b,c,a){var e=a,g=JSON.parse(JSON.stringify(m.aio.syncmanager.RemoteUploader.OPTIONS));g.path+=d;g.method="POST";this._username&&this._password&&(g.auth=this._username+":"+this._password);b&&Object.keys(b).forEach(function(a){g.headers[a]=b[a]});var f="";d=require(m.aio.syncmanager.RemoteUploader.PROTOCOL).request(g,function(a){a.setEncoding("utf8");a.on("data",function(a){f+=a});a.on("end",function(){200==a.statusCode?e&&e(null,
f):e&&e(Error("http error with status code:"+a.statusCode),f);e=null})});d.on("error",function(a){e&&(e(a),e=null)});d.write(c);d.end()};m.aio.syncmanager.RemoteUploader.prototype._encrypt=function(d,b){return require("x.crypt.js").AES.encodeString(d,b).trim()};m.aio.syncmanager.Assembler=function(){};
m.aio.syncmanager.Assembler.prototype={generateRemoteDownloadRsp:function(d,b,c,a){var e=this;this._getRemoteDatabaseInfo(b,c,function(c,f){c?a&&a(c):(f&&f.forEach(function(a){a.file&&(a.ref="tenant/"+d.index+"/remote/"+b.index+"/"+a.file)}),e._getRemoteInfo(b,function(c,e){c?a&&a(c):(e.resources&&e.resources.forEach(function(a){a.file&&"device_db"!=a.file&&"macros_db"!=a.file&&"deviceinfo.xml"!=a.file&&(a.ref="tenant/"+d.index+"/remote/"+b.index+"/"+a.file,f.push(a))}),e.resources=f,a&&a(null,e))}))})},
generateRemoteUploadReq:function(d,b,c){this.generateRemoteDownloadRsp(d,b,"from_upload_req",c)},_getRemoteInfo:function(d,b){var c=require("unorm"),a=d.getFolderPath(),e={name:c.nfc(d.id),resources:[]};this._getFilesInfos(a,function(a,c){a?b&&b(a):(c&&(e.resources=c),b&&b(null,e))})},_getRemoteDatabaseInfo:function(d,b,c){var a=this,e=d.getFolderPath(),g=require("async"),f=require("fs"),h=require("fs-extra");g.parallel([function(c){var g=d.getDeviceFile();g?f.exists(g,function(d){d?a._getFileInfos(g,
e,function(a,e){if("from_download"==b)try{h.removeSync(g)}catch(d){}c(a,e)}):c()}):c()},function(c){var b=d.getMacrosFile();b?f.exists(b,function(d){d?a._getFileInfos(b,e,function(a,b){c(a,b)}):c()}):c()},function(c){var b=d.getDeviceinfoFile();b?f.exists(b,function(d){d?a._getFileInfos(b,e,function(a,b){c(a,b)}):c()}):c()}],function(a,b){var e=[];b&&b.forEach(function(a){a&&e.push(a)});c&&c(a,e)})},_getTenantDatabaseInfo:function(d,b){var c=this,a=d.getFolderPath(),e=require("async"),g=require("fs");
e.parallel([function(b){var e=d.getDeviceFile();e?g.exists(e,function(d){d?c._getFileInfos(e,a,function(a,c){b(a,c)}):b()}):b()},function(b){var e=d.getMacrosFile();e?g.exists(e,function(d){d?c._getFileInfos(e,a,function(a,c){b(a,c)}):b()}):b()},function(b){var e=d.getDeviceinfoFile();e?g.exists(e,function(d){d?c._getFileInfos(e,a,function(a,c){b(a,c)}):b()}):b()}],function(a,c){var e=[];c&&c.forEach(function(a){a&&e.push(a)});b&&b(a,e)})},_listAllFiles:function(d,b){var c=require("fs"),a=require("path"),
e=[],g=this,f=function(h,k){if(k>=h.length)b(null,e);else{var l=a.join(d,h[k]);c.stat(l,function(a,c){a?b(a,e):c.isDirectory()?g._listAllFiles(l,function(a,c){a?b(a,e):(Array.isArray(c)&&(e=e.concat(c)),f(h,k+1))}):(e.push(l),f(h,k+1))})}};c.readdir(d,function(a,c){a?b&&b(a,e):f(c,0)})},_getFilesInfos:function(d,b){var c=[],a=require("async"),e=require("path"),g=this;this._listAllFiles(d,function(f,h){f?b&&b(f):a.eachLimit(h,50,function(a,b){if(0==e.basename(a).indexOf("."))b();else{var f=a.replace(d,
"");"controls"==f.substr(1,8)&&".p"!=f.substr(f.length-2)?b():"resources_"==f.substr(1,10)?b():g._getFileInfos(a,d,function(a,e){a?b(a):(e&&c.push(e),b())})}},function(a){b&&b(a,c)})})},_getFileInfos:function(d,b,c){var a=require("fs"),e=require("path"),g=require("unorm");b=e.relative(b,d);b=g.nfc(b);d=g.nfc(d);"\\"==e.sep&&(b=b.replace(/\\/g,"/"));var e=e.basename(d),f={file:b,name:e},h=this;a.stat(d,function(a,b){a?c(a):b.isFile()?(f.size=b.size,h._md5(d,function(a,b){a?c(a):(f.md5=b,h._sha1(d,
function(a,b){a?c(a):(f.sha1=b,c(null,f))}))})):c(Error(d+" is not a file"))})},_md5:function(d,b){var c=require("fs"),a=require("crypto").createHash("md5"),e=c.createReadStream(d);e.on("readable",function(){for(var c;null!==(c=e.read());)a.update(c)}).on("end",function(){b(null,a.digest("base64"))})},_sha1:function(d,b){var c=require("fs"),a=require("crypto").createHash("sha1"),e=c.createReadStream(d);e.on("readable",function(){for(var c;null!==(c=e.read());)a.update(c)}).on("end",function(){b(null,
a.digest("base64"))})}};
m.aio.syncmanager.UserDBUploader=function(){var d=function(b,c){this._logger=require("x.logger.js").getLogger("UserDBUploader");this._username=b.username?b.username:"";this._password=b.password?b.password:"";this._listener=c};d.prototype.upload=function(b,c){if(b){var a=this;this._upload(b,function(b){if(b){if(a._logger.log("trace","upload user database error:"+b.stack),a._listener&&a._listener.onError)a._listener.onError({error:b.message,error_code:b.code})}else if(a._logger.log("trace","upload user database success"),
a._listener&&a._listener.onSuccess)a._listener.onSuccess(4);c&&c(b)})}else{if(this._listener&&this._listener.onError)this._listener.onError({error:"no such tenant",error_code:100});c&&c(Error("tenant is null"))}};d.prototype._upload=function(b,c){this._logger.log("debug","upload user db:"+b.index);var a=this;this._zipUserDB(b,function(b,d){b?(a._logger.log("trace","zip user database error:"+b.stack),c&&c(b)):(a._logger.log("trace","zip user database ok"),a._requestUpload(function(b,e){b?(a._logger.log("trace",
"send upload request error:"+b.stack),c&&c(b)):(a._logger.log("trace","send upload request ok"),a._uploadZip(d,e,function(b){b?(a._logger.log("trace","upload zip error:"+b.stack),c&&c(b)):(a._logger.log("trace","upload zip ok"),a._finishUpload(e.ref,function(b){b?a._logger.log("trace","finish user database upload error:"+b.stack):a._logger.log("trace","finish user database upload ok");c&&c(b)}))}))}))})};d.prototype._zipUserDB=function(b,c){var a=this;this._reportProgress(0,"zip user database",function(){a._logger.log("trace",
"zip the user database.");var e=require("path"),d=b.getDeviceFile(),f=b.getDeviceFile()+".enc",h=b.getMacrosFile();b.getDeviceinfoFile();for(var k=b.getFolderPath()+e.sep+"automation",l=require("m.aio.filemanager.js"),n=require("fs"),p=Math.round((new Date).getTime()/1E3),r=0,l=l.getTmpDir(),q=e.join(l,p+".zip");a._fileExistsSync(q);){r++;p++;if(10<r){c&&c(Error("can not create temp file"));return}q=e.join(l,p+".zip")}a._logger.log("trace","zip file:"+q);p=require("archiver");e=n.createWriteStream(q);
p=p("zip");e.on("error",function(b){a._logger.log("warn","create user database error:"+b.message);c&&(c(b),c=null)});e.on("close",function(){c&&(c(null,q),c=null)});p.pipe(e);a._fileExistsSync(d)&&p.append(n.createReadStream(d),{name:"device_db"});a._fileExistsSync(h)&&p.append(n.createReadStream(h),{name:"macros_db"});a._fileExistsSync(f)&&p.append(n.createReadStream(f),{name:"device_db.enc"});if(a._fileExistsSync(k))if(n.statSync(k).isDirectory())p.directory(k,"automation");else{d=Error("Automation folder is not a directory: "+
k);a._logger.log("error",d.message);c&&c(d);c=null;return}p.finalize()})};d.prototype._requestUpload=function(b){var c=this;this._reportProgress(1,"send upload request",function(){c._logger.log("trace","send upload user database request.");c._doRequest("POST","/creatorneo/userdb/requestUpload",null,null,function(a,c){if(c)try{c=JSON.parse(c)}catch(d){a=d,a.code=103}a||(c&&"success"==c.status?c.result&&c.result.ref&&c.result.credential||(a=Error("request upload response foramt error"),a.code=102):
(a=Error("request upload response error:"+c.message),a.code=101));a&&!a.code&&(a.code=100);b&&b(a,c&&c.result)})})};d.prototype._uploadZip=function(b,c,a){var e=this;this._reportProgress(2,"upload zip file",function(){e._logger.log("trace","upload zip file with ref:"+c.ref);var d=new (require("aws-sdk").S3)({apiVersion:"2006-03-01",region:"eu-central-1",accessKeyId:c.credential.accessKeyId,secretAccessKey:c.credential.secretAccessKey,sessionToken:c.credential.sessionToken}),f=require("fs");require("path");
var h=a,f=f.createReadStream(b);f.on("error",function(a){h&&(a.code=201,h(a),h=null)});d.putObject({Bucket:"mediola-creator",Key:"user_db/"+c.ref,Body:f},function(a){h&&(a&&(a.code=202),h(a),h=null)}).on("error",function(a){h&&(a.code=203,h(a),h=null)})})};d.prototype._finishUpload=function(b,c){var a=this;this._reportProgress(3,"finish upload",function(){a._logger.log("trace","finish upload zip file ref:"+b);a._doRequest("POST","/creatorneo/userdb/finishUpload?ref="+b,null,null,function(a,b){if(b)try{b=
JSON.parse(b)}catch(d){a=d,a.code=303}a||b&&"success"==b.status||(a=Error("request upload response error:"+b.message),a.code=301);a&&!a.code&&(a.code=300);c&&c(a)})})};d.prototype._reportProgress=function(b,c,a){if(this._listener&&this._listener.onProgress)this._listener.onProgress(b,c,null,a);else a&&a()};d.prototype._fileExistsSync=function(b){var c=require("fs");try{c.statSync(b)}catch(a){if("ENOENT"==a.code)return!1}return!0};d.prototype._doRequest=function(b,c,a,e,d){var f=d;d=require(m.aio.syncmanager.PROTOCOL);
var h={host:m.aio.syncmanager.HOST,port:m.aio.syncmanager.PORT,path:m.aio.syncmanager.PATH,headers:m.aio.syncmanager.HEADERS};h.path+=c;h.method=b;this._username&&this._password&&(h.auth=this._username+":"+this._password);a&&Object.keys(a).forEach(function(c){h.headers[c]=a[c]});var k="";b=d.request(h,function(a){a.setEncoding("utf8");a.on("data",function(a){k+=a});a.on("end",function(){200==a.statusCode?f&&f(null,k):f&&f(Error("http error with status code:"+a.statusCode),k);f=null})});b.on("error",
function(a){f&&(f(a),f=null)});e&&b.write(e);b.end()};return d}();
m.aio.syncmanager.UserDBDownloader=function(){var d=function(b,c){this._logger=require("x.logger.js").getLogger("UserDBDownloader");this._username=b.username?b.username:"";this._password=b.password?b.password:"";this._listener=c};d.prototype.download=function(b,c){if(b){var a=this;this._download(b,function(b){if(b){if(a._logger.log("trace","download user database error:"+b.stack),a._listener&&a._listener.onError)a._listener.onError({error:b.message,error_code:b.code})}else if(a._logger.log("trace",
"download user database success"),a._listener&&a._listener.onSuccess)a._listener.onSuccess(4);c&&c(b)})}else{if(this._listener&&this._listener.onError)this._listener.onError({error:"no such tenant",error_code:100});c&&c(Error("tenant is null"))}};d.prototype._download=function(b,c){this._logger.log("debug","download user db:"+b.index);var a=this;this._requestDownload(function(e,d){e?(a._logger.log("trace","send download request error:"+e.stack),c&&c(e)):a._downloadZip(d,function(e,d){e?(a._logger.log("trace",
"download zip file error:"+e.stack),c&&c(e)):a._unzipFile(d,function(e,d){e?(a._logger.log("trace","unzip file error:"+e.stack),c&&c(e)):a._reloadUserDB(d,b,function(b){b&&a._logger.log("trace","reload user database error:"+b.stack);c&&c(b)})})})})};d.prototype._requestDownload=function(b){var c=this;this._reportProgress(0,"send download request",function(){c._logger.log("trace","send download user database request.");c._doRequest("GET","/creatorneo/userdb/requestDownload",null,null,function(a,c){if(c)try{c=
JSON.parse(c)}catch(d){a=d,a.code=103}a||(c&&"success"==c.status?c.result&&c.result.ref&&c.result.credential||(a=Error("request download response foramt error"),a.code=102):(a=Error("request download response error:"+c.message),a.code=101));a&&!a.code&&(a.code=100);b&&b(a,c.result)})})};d.prototype._downloadZip=function(b,c){var a=this;this._reportProgress(1,"download zip file",function(){a._logger.log("trace","download zip file with ref:"+b.ref);for(var e=require("m.aio.filemanager.js"),d=require("path"),
f=require("fs"),h=Math.round((new Date).getTime()/1E3),k=0,e=e.getTmpDir(),l=d.join(e,h+".zip");a._fileExistsSync(l);){k++;h++;if(10<k){c&&c(Error("can not create temp file"));return}l=d.join(e,h+".zip")}a._logger.log("trace","zip file:"+l);(new (require("aws-sdk").S3)({apiVersion:"2006-03-01",region:"eu-central-1",accessKeyId:b.credential.accessKeyId,secretAccessKey:b.credential.secretAccessKey,sessionToken:b.credential.sessionToken})).getObject({Bucket:"mediola-creator",Key:"user_db/"+b.ref},function(a,
b){a?(a.code=201,c&&c(a)):f.writeFile(l,b.Body,function(a){a&&(a.code=203);c&&c(a,l)})})})};d.prototype._unzipFile=function(b,c){var a=this;this._reportProgress(2,"unzip file",function(){var e=require("m.aio.filemanager.js"),d=require("path");require("fs");for(var f=Math.round((new Date).getTime()/1E3),h=0,k=e.getTmpDir(),e=d.join(k,f+"");a._fileExistsSync(e);){h++;f++;if(10<h){d=Error("can not create temp folder");d.code=301;c&&c(d);return}e=d.join(k,f++)}a._logger.log("trace","unzip to folder:"+
e);try{require("fs-extra").ensureDirSync(e)}catch(l){l.code=201;c&&c(l);return}d=new (require("adm-zip"))(b);try{d.extractAllTo(e,!0),c&&c(null,e)}catch(n){n.code=202,c&&c(n)}})};d.prototype._reloadUserDB=function(b,c,a){var e=require("fs"),d=require("fs-extra"),f=this;this._reportProgress(3,"load user database",function(){var h=require("path"),k=c.getDeviceFile(),l=c.getDeviceFile()+".enc",n=c.getMacrosFile(),p=c.getDeviceinfoFile(),r=h.join(c.getFolderPath(),"automation"),q=h.join(b,"device_db"),
t=h.join(b,"device_db.enc"),u=h.join(b,"macros_db"),v=h.join(b,"deviceinfo.xml"),h=h.join(b,"automation");f._copyFolder(h,r,function(b){b?(b.code=303,a&&a(b)):f._copyFile(v,p,function(b){b?(b.code=301,a&&a(b)):f._copyFile(u,n,function(b){if(b)b.code=302,a&&a(b);else{try{d.removeSync(l)}catch(h){}e.existsSync(t)?f._copyFile(t,l,function(b){if(b)b.code=302,a&&a(b);else{var e=require("m.aio.devicemanager.js");require("m.aio.macromanager.js").reloadTenant(c,function(){e.reloadTenant(c,function(){a&&a()})})}}):
f._copyFile(q,k,function(b){if(b)b.code=302,a&&a(b);else{var e=require("m.aio.devicemanager.js");require("m.aio.macromanager.js").reloadTenant(c,function(){e.reloadTenant(c,function(){a&&a()})})}})}})})})})};d.prototype._reportProgress=function(b,c,a){if(this._listener&&this._listener.onProgress)this._listener.onProgress(b,c,null,a);else a&&a()};d.prototype._fileExistsSync=function(b){var c=require("fs");try{c.statSync(b)}catch(a){if("ENOENT"==a.code)return!1}return!0};d.prototype._copyFile=function(b,
c,a){var e=require("fs");this._fileExistsSync(b)?e.readFile(b,function(b,d){b?a&&a(b):e.writeFile(c,d,function(b){a&&a(b)})}):e.writeFile(c,"",function(b){a&&a(b)})};d.prototype._copyFolder=function(b,c,a){var e=require("fs-extra"),d=this;e.remove(c,function(f){f?a&&a(f):d._fileExistsSync(b)?e.move(b,c,{overwrite:!0},function(b){a&&a(b)}):a&&a()})};d.prototype._doRequest=function(b,c,a,e,d){var f=d;d=require(m.aio.syncmanager.PROTOCOL);var h={host:m.aio.syncmanager.HOST,port:m.aio.syncmanager.PORT,
path:m.aio.syncmanager.PATH,headers:m.aio.syncmanager.HEADERS};h.path+=c;h.method=b;this._username&&this._password&&(h.auth=this._username+":"+this._password);a&&Object.keys(a).forEach(function(b){h.headers[b]=a[b]});var k="";b=d.request(h,function(a){a.setEncoding("utf8");a.on("data",function(a){k+=a});a.on("end",function(){200==a.statusCode?f&&f(null,k):f&&f(Error("http error with status code:"+a.statusCode),k);f=null})});b.on("error",function(a){f&&(f(a),f=null)});e&&b.write(e);b.end()};return d}();
m.aio.syncmanager.SyncManager=function(){this._configmanager=null};
m.aio.syncmanager.SyncManager.prototype={init:function(d,b,c,a){this._configmanager=d;b&&(m.aio.syncmanager.RemoteUploader.OPTIONS.host=b,m.aio.syncmanager.RemotesDownloader.OPTIONS.host=b,m.aio.syncmanager.RemoteDownloader.OPTIONS.host=b,m.aio.syncmanager.HOST=b);c&&0<c&&(m.aio.syncmanager.RemoteUploader.OPTIONS.port=c,m.aio.syncmanager.RemotesDownloader.OPTIONS.port=c,m.aio.syncmanager.RemoteDownloader.OPTIONS.port=c,m.aio.syncmanager.PORT=c,process&&"local"!=process.env.CLOUD&&80==c&&(m.aio.syncmanager.RemoteUploader.OPTIONS.port=
443,m.aio.syncmanager.RemotesDownloader.OPTIONS.port=443,m.aio.syncmanager.RemoteDownloader.OPTIONS.port=443,m.aio.syncmanager.PORT=443),process&&"dev"==process.env.CLOUD&&(m.aio.syncmanager.RemoteUploader.OPTIONS.port=80,m.aio.syncmanager.RemotesDownloader.OPTIONS.port=80,m.aio.syncmanager.RemoteDownloader.OPTIONS.port=80,m.aio.syncmanager.PORT=80));process&&"local"==process.env.CLOUD?(m.aio.syncmanager.RemoteUploader.OPTIONS.path="/webservice",m.aio.syncmanager.RemotesDownloader.OPTIONS.path="/webservice",
m.aio.syncmanager.RemoteDownloader.OPTIONS.path="/webservice",m.aio.syncmanager.PATH="/webservice",m.aio.syncmanager.RemoteUploader.PROTOCOL="http",m.aio.syncmanager.RemotesDownloader.PROTOCOL="http",m.aio.syncmanager.RemoteDownloader.PROTOCOL="http",m.aio.syncmanager.PROTOCOL="http"):process&&"dev"==process.env.CLOUD&&(m.aio.syncmanager.RemoteUploader.PROTOCOL="http",m.aio.syncmanager.RemotesDownloader.PROTOCOL="http",m.aio.syncmanager.RemoteDownloader.PROTOCOL="http",m.aio.syncmanager.PROTOCOL=
"http");a&&a()},uploadRemote:function(d,b,c,a,e){if(c&&c.username&&c.password){var g=this;this._configmanager.trace("config/tenants/"+d,function(f,h){f?e&&e(f):h.license&&h.license.licenseTxt?g._configmanager.trace("config/tenants/"+d+"/remotes/"+b,function(b,d){if(b)e&&e(b);else{var f=require("m.aio.devicemanager.js");f.saveRemote(d,function(b){b?e&&e(b):(new m.aio.syncmanager.RemoteUploader(c,a)).upload(h.license.licenseTxt,h,d,function(a){f.clearRemoteDB(d,function(){e&&e(a)})})})}}):e&&e(Error("no license"))})}else e&&
e(Error("options format invalid"))},downloadRemote:function(d,b,c,a,e,g){a&&a.username&&a.password?this._configmanager.trace("config/tenants/"+d,function(d,h){if(d)g&&g(d);else if(h.license&&h.license.licenseTxt)if(h.isAccessible()){var k=(new m.aio.syncmanager.RemotesDownloader)._findRemote(b,c);if(k){a.credential=c.credential;var l=h.getRemotes().getFolderPath();(new m.aio.syncmanager.RemoteDownloader(a,e)).download(l,k,function(a){a?g&&g(a):setTimeout(function(){h.reloadRemotes(function(a){g&&
g(a)})},100)})}else g&&g(Error("no such remote:"+b))}else g&&g(Error("not permitted"));else g&&g(Error("no license"))}):g&&g(Error("options format invalid"))},downloadRemoteList:function(d,b,c){(new m.aio.syncmanager.RemotesDownloader(null,null,d,b)).downloadRemoteList(c)},testRemotePassword:function(d,b,c,a){if(d)if(b)if(c){var e=new m.aio.syncmanager.RemotesDownloader;(c=e._findRemote(d,c))?c.encrypt?(b=e._decrypt(c.encrypt,b),a&&a(null,b==d)):a&&a(null,!0):a&&a(Error("no such remote:"+d))}else a&&
a(Error("info is null"));else a&&a(Error("remote password is null"));else a&&a(Error("remote name is null"))},requestDownload:function(d){var b=this;this._configmanager.trace("config/tenants",function(c,a){if(c)d&&d(c);else{var e=null;a.getChildren()?(a.getChildren().forEach(function(a){a.isDefault()&&(e=a)}),e&&e.license&&!e.license.isTestLicense()&&e.license.valid?b.requestDownloadTenant(e.index,d):e&&e.license&&e.license.isTestLicense()?(c=Error("can not download from test license"),c.code=400,
d&&d(c,null)):d&&d(null,{infos:[]})):d&&d(null,{infos:[]})}})},requestDownloadTenant:function(d,b){this._configmanager.trace("config/tenants/"+d,function(c,a){if(c)b&&b(c);else if(a.isAccessible()){var e={infos:[]},g=a.getRemotes();g&&0!=g.size()?require("m.aio.devicemanager.js").deleteUnlicensed(d,function(c){if(c)b&&b(c);else{var d=0,k=new m.aio.syncmanager.Assembler;g.getChildren().forEach(function(c){k.generateRemoteDownloadRsp(a,c,"from_download",function(a,c){d+=1;a||e.infos.push(c);d==g.size()&&
b&&b(null,e)})})}}):b&&b(null,e)}else b&&b(Error("not permitted"))})},getTenantFile:function(d,b,c){d&&b?this._configmanager.trace("config/tenants/"+d,function(a,d){if(a)c&&c(a);else{var g=require("path");b=b.replace(/\//g,g.sep);var f=d.getFolderPath();f?c&&c(null,f+g.sep+b):c&&c(Error("tenant has no folder"))}}):c&&c(Error("parameter invalid"))},getRemoteFile:function(d,b,c,a){d&&b&&c?this._configmanager.trace("config/tenants/"+d+"/remotes/"+b,function(b,d){if(b)a&&a(b);else{var f=require("path");
c=c.replace(/\//g,f.sep);var h=d.getFolderPath();h?a&&a(null,h+f.sep+c):a&&a(Error("remote has no folder"))}}):a&&a(Error("parameter invalid"))},getRemoteDeviceDBData:function(d,b,c,a){d&&b&&c?require("m.aio.devicemanager.js").getDeviceDBForRemote(d,function(b,c){a&&a(b,c)}):a&&a(Error("parameter invalid"))},uploadUserDB:function(d,b,c,a){if(b&&b.username&&b.password)this._configmanager.trace("config/tenants/"+d,function(d,g){if(d){if(c&&c.onError)c.onError({error:d.message,error_code:100});a&&a(d)}else if(g.license&&
g.license.licenseTxt)(new m.aio.syncmanager.UserDBUploader(b,c)).upload(g,function(b){a&&a(b)});else{if(c&&c.onError)c.onError({error:"no license",error_code:100});a&&a(Error("no license"))}});else{if(c&&c.onError)c.onError({error:"options format invalid",error_code:100});a&&a(Error("options format invalid"))}},downloadUserDB:function(d,b,c,a){if(b&&b.username&&b.password)this._configmanager.trace("config/tenants/"+d,function(d,g){if(d){if(c&&c.onError)c.onError({error:d.message,error_code:100});
a&&a(d)}else if(g.license&&g.license.licenseTxt)(new m.aio.syncmanager.UserDBDownloader(b,c)).download(g,function(b){a&&a(b)});else{if(c&&c.onError)c.onError({error:"no license",error_code:100});a&&a(Error("no license"))}});else{if(c&&c.onError)c.onError({error:"options format invalid",error_code:100});a&&a(Error("options format invalid"))}},_downloadRemotes:function(d,b,c){b&&b.host&&b.port?(new m.aio.syncmanager.RemotesDownloader(b.host,b.port,b.username,b.password)).download(d,function(a){c&&c(a)}):
c&&c(Error("options format invalid"))}};m.aio.syncmanager.Handler=m.aio.syncmanager.SyncManager;m.aio.syncmanager.Handler.prototype.RemotesDownloader=m.aio.syncmanager.RemotesDownloader;m.aio.syncmanager.Handler.prototype.RemoteDownloader=m.aio.syncmanager.RemoteDownloader;"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.syncmanager.Handler);
