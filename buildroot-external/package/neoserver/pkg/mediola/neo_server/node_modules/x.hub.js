require("x.core.js");require("x.logger.js").setLevel("info","x.hub.Server");var x=x||{};x.hub=x.hub||{};
x.hub.Server=function(d,c,a){this.HWV="EB";this.VERSION="0.0.0";this.DEFAULT_NAME="XHUB";this.VID="FFFF";this.hostType="A20";this._port=null;this._stmPort=d;this._hmPort=c;this._signalPin=a;this._cloudConnect=this._hmSerial=this._stmUSB=null;this._pwd="";this._onCustomSerialEvent=this._onSerialEvent=null;this._app=require("express")();this._httpserver=require("http").createServer(this._app);this._commandFunctions={};this._cmdFunctions={};this._logger={log:function(){}};try{var b=require("x.logger.js");
b&&(this._logger=b.getLogger("x.hub.Server"));var e=require("x.hub.eventbus.js");e&&(e.on("udpevent",this.onUdpEvt.bind(this)),e.on("status",this.onStatusEvt.bind(this)))}catch(l){}localStorage&&(localStorage.getItem("x.hub.Server.timezone")||localStorage.setItem("x.hub.Server.timezone","8C"),localStorage.getItem("x.hub.Server.geo.lat")||localStorage.setItem("x.hub.Server.geo.lat","1392"),localStorage.getItem("x.hub.Server.geo.long")||localStorage.setItem("x.hub.Server.geo.long","035C"),localStorage.getItem("x.hub.Server.pwd")&&
(this._pwd=localStorage.getItem("x.hub.Server.pwd")))};
x.hub.Server.prototype.start=function(d){this._port=d;this._name=this.DEFAULT_NAME;localStorage&&localStorage.getItem("x.hub.Server.name")&&(this._name=localStorage.getItem("x.hub.Server.name"));this._vid=this.VID;localStorage&&localStorage.getItem("x.hub.Server.vid")&&(this._vid=localStorage.getItem("x.hub.Server.vid"));this._startup=Math.round((new Date).getTime()/1E3);this._startServer();this._startUDPServer(1901);if(this._stmPort){var c=this;this._stmUSB=new (require("x.hub.v5.js").USBSerial)(this._stmPort,
this._signalPin);this._stmUSB.on("data",function(a){if(a&&a.type&&a.data)if(80==a.type&&c._onSerialEvent){a=a.data.toString();var b=null;8<a.length&&"{XC_EVT}"==a.substr(0,8)?(a=a.substr(8),b="EVT"):4<a.length&&"EVT:"==a.substr(0,4)?(a=a.substr(4),b="EVT"):4<a.length&&"STA:"==a.substr(0,4)&&(a=a.substr(4),b="STA");c._onSerialEvent(a,b)}else 82==a.type&&c._onCustomSerialEvent&&c._onCustomSerialEvent(a.data)})}};
x.hub.Server.prototype.startSTM=function(d){if(this._stmPort){var c=this;this._stmUSB=new (require("x.hub.v5.js").USBSerial)(this._stmPort,this._signalPin,d);this._stmUSB.on("data",function(a){if(a&&a.type&&a.data)if(80==a.type&&c._onSerialEvent){a=a.data.toString();var b=null;8<a.length&&"{XC_EVT}"==a.substr(0,8)?(a=a.substr(8),b="EVT"):4<a.length&&"EVT:"==a.substr(0,4)?(a=a.substr(4),b="EVT"):4<a.length&&"STA:"==a.substr(0,4)&&(a=a.substr(4),b="STA");c._onSerialEvent(a,b)}else 82==a.type&&c._onCustomSerialEvent&&
c._onCustomSerialEvent(a.data)})}};
x.hub.Server.prototype.startWebserver=function(d,c){this._port=d;this._name=this.DEFAULT_NAME;localStorage&&localStorage.getItem("x.hub.Server.name")&&(this._name=localStorage.getItem("x.hub.Server.name"));this._vid=this.VID;localStorage&&localStorage.getItem("x.hub.Server.vid")&&(this._vid=localStorage.getItem("x.hub.Server.vid"));this._startup=Math.round((new Date).getTime()/1E3);var a=0;this._startServer(function(){console.log("************* ++++++++++++++++++ **************");console.log("************* http server started **************");
console.log("************* ++++++++++++++++++ **************");a++;2==a&&c&&c()});this._startUDPServer(1901,function(){console.log("************* ++++++++++++++++++ **************");console.log("************* upd server started **************");console.log("************* ++++++++++++++++++ **************");a++;2==a&&c&&c()})};x.hub.Server.prototype.on=function(d,c){"serialevent"==d?this._onSerialEvent=c:"customserialevent"==d&&(this._onCustomSerialEvent=c)};
x.hub.Server.prototype._getServerFromReq=function(d){if(d.query.server)return d.query.server;var c=null;d.ip?c=d.ip:d.connection.remoteAddress&&(c=d.connection.remoteAddress);c&&-1<c.indexOf(":")&&c.indexOf(".")>c.indexOf(":")?c=c.substr(c.lastIndexOf(":")+1):"::1"==c&&(c="localhost");return c};x.hub.Server.prototype.enableCloudConnect=function(d){this._cloudConnect=d;d.init(this)};
x.hub.Server.prototype.restart=function(d){XC.debugf("RESTART!");var c=this;setTimeout(function(){"A20"==c.hostType?require("x.hub.v5.js").Native.reboot():process.exit(0)},d)};x.hub.Server.prototype.resHasError=function(d){var c=null;try{c=JSON.parse(d)}catch(a){c=null}return c&&c.XC_ERR?!0:!1};
x.hub.Server.prototype._doSTMCommandRequest=function(d,c,a){this._stmUSB&&d&&-1<d.indexOf("?")?(d=d.substr(d.indexOf("?")+1),this._stmUSB.sendCommand(16,d,function(b){b&&b.data?XC.debugf(d+" --\x3e "+b.data.toString()):b&&b.error?XC.debugf(d+" --\x3e FAIL:"+b.error):XC.debugf(d+" --\x3e FAIL");if(b&&b.data){var e="XC_SUC";b.error&&(e="XC_ERR");c?a("{"+e+"}"+b.data.toString()):a('{"'+e+'": '+b.data.toString()+"}")}else c?a("{XC_ERR}internal error"):b&&b.error?a(JSON.stringify({XC_ERR:{code:"000000",
msg:b.error}})):a('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})):c?a("{XC_ERR}invalid request"):a('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')};x.hub.Server.prototype.doSTMCommand=function(d,c){this._doSTMCommandRequest("/cmd?"+d,!1,function(a){var b=null;try{b=JSON.parse(a)}catch(e){b=null}c&&c(b)})};x.hub.Server.prototype.doSTMRequest=function(d,c,a){this._stmUSB?this._stmUSB.sendCommand(d,c,function(b){b?b.error?a(null):a(b.data):a(null)}):a(null)};
x.hub.Server.prototype.setCommandFunc=function(d,c){this._commandFunctions[d.toLowerCase()]=c};x.hub.Server.prototype.setCmdFunc=function(d,c){this._cmdFunctions[d.toLowerCase()]=c};
x.hub.Server.prototype.doRequest=function(d,c,a){var b=require("os");if("/"==d){var e=String(this._name).replace(/</g,"&lt;").replace(/>/g,"&gt;"),e='<!DOCTYPE html>\n<html>\n<head>\n<meta http-equiv="content-type" content="text/html; charset=utf-8" />\n'+("<title>"+e+"</title>\n"),e=e+'<script>function setHMconfigRef() {var hmconfig = document.getElementById("hmconfig"); if(hmconfig){hmconfig.href = window.location.protocol + "//" + window.location.hostname + ":81/";}}\x3c/script>\n',e=e+"</head>\n",
e=e+'<body style="background-color: #FFFFFF; font-family: Helvetica, Arial, sans-serif;" onload="setHMconfigRef()">\n',e=e+'<table style="border-radius: 0px 0px 8px 8px; border: 1px #999 solid; -moz-box-shadow: 0px 5px 8px #888; -webkit-box-shadow: 2px 5px 8px #888; box-shadow: 0px 5px 8px #888; position: absolute; height: 220px; width: 420px; margin: -110px 0px 0px -210px; top: 50%; left: 50%; color: #777; background-color: #fafafa; font-size: 15px;" border="0" cellspacing="0">\n',e=e+"<tbody>\n",
e=e+'<tr style="height: 48px; background-color: #666; color: #FFFFFF; font-size: 20px;">',e=e+('<th colspan="3">'+this._name+"</th>\n"),e=e+"</tr>\n",e=e+'<tr style="height: 28px;"><td style="width: 70px;">&nbsp;</td><td style="width: 150px;">&nbsp;</td><td>&nbsp;</td></tr>\n',e=e+('<tr style="height: 30px;"><td>&nbsp;</td><td>device:</td><td><b>'+this.DEFAULT_NAME+"</b></td></tr>\n"),e=e+('<tr style="height: 30px;"><td>&nbsp;</td><td>version:</td><td><b>'+this.HWV+" ("+this.VERSION+")</b></td></tr>\n"),
l=Math.round((new Date).getTime()/1E3)-this._startup,h=Math.floor(l/86400),l=l-86400*h;d=Math.floor(l/3600);var l=l-3600*d,g=Math.floor(l/60),e=e+('<tr style="height: 30px;"><td>&nbsp;</td><td>uptime:</td><td><b>'+h+"d "+d+"h "+g+"m "+(l-60*g)+"s</b></td></tr>\n");b&&b.freemem&&(e+='<tr style="height: 30px;"><td>&nbsp;</td><td>memory:</td><td><b>'+Math.floor(b.freemem()/1E3)+"</b></td></tr>\n");e+='<tr style="height: 0px;"><td colspan="3">&nbsp;</td></tr>\n';e+='<tr style="height: 32px;"><td colspan="3" style="font-size: 13px; text-align: center;">&copy;&nbsp;2018 mediola - connected living AG</td></tr>\n';
e+="</tbody>\n</table>\n</body>\n</html>";a(e)}else if("/info"==d){var f={XC_SUC:{name:this._name,mhv:"XH I-"+this.hostType,msv:this.VERSION,hwv:this.HWV,vid:this._vid,start:this._startup,time:Math.round((new Date).getTime()/1E3)}};d="8C";var g="1392",k="035C";localStorage.getItem("x.hub.Server.timezone")&&(d=localStorage.getItem("x.hub.Server.timezone"));localStorage.getItem("x.hub.Server.geo.lat")&&(g=localStorage.getItem("x.hub.Server.geo.lat"));localStorage.getItem("x.hub.Server.geo.long")&&(k=
localStorage.getItem("x.hub.Server.geo.long"));f.XC_SUC.loc=(d+g+k).toUpperCase();localStorage.getItem("x.hub.v5.config")&&(f.XC_SUC.cfg=localStorage.getItem("x.hub.v5.config"));localStorage.getItem("x.hub.v5.cloudServer")&&localStorage.getItem("x.hub.v5.cloudPort")?f.XC_SUC.server=localStorage.getItem("x.hub.v5.cloudServer")+":"+localStorage.getItem("x.hub.v5.cloudPort"):(d=require("x.hub.v5.js").CloudConnect,f.XC_SUC.server=d.prototype.CLOUD_SERVER+":"+d.prototype.CLOUD_SERVER_PORT);localStorage.getItem("x.hub.v5.SID")&&
(f.XC_SUC.sid=localStorage.getItem("x.hub.v5.SID"));localStorage.getItem("x.hub.taskman.NEO_SERVER")&&(f.XC_SUC.neoserver=localStorage.getItem("x.hub.taskman.NEO_SERVER"));localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE")&&(f.XC_SUC.ccu_init_state=localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE"));localStorage.getItem("x.hub.Server.DISABLE_ST_STATES")&&(f.XC_SUC.disable_st_states=localStorage.getItem("x.hub.Server.DISABLE_ST_STATES"));b&&b.freemem&&(f.XC_SUC.mem=Math.floor(b.freemem()/1E3));try{global.LOAD_MODULES&&
-1!=global.LOAD_MODULES.indexOf("enocean")&&(l=require("x.hub.m.enocean.js"))&&(h=l.getEnoceanInfo(),f.XC_SUC.enocean=h)}catch(p){}if("A20"==this.hostType){f.XC_SUC.SAFE_MODE=global.SAFE_MODE;var b=require("x.hub.v5.js"),m=function(a){return{ip:a.IP,sn:a.SN,gw:a.GW,dhcp:a.DHCP,dns:a.DNS,mac:a.MAC,ntp:a.NTP}};b.Native.getIPData(function(b){var e=null,c=null;Array.isArray(b.eth0)&&(e=m(b.eth0[0]));Array.isArray(b.wlan0)&&(c=m(b.wlan0[0]));b=e||c;for(var d in b)f.XC_SUC[d]=b[d];f.XC_SUC.primary_net=
b===e?"eth0":"wlan0";f.XC_SUC.cfg&&b&&(e=parseInt(f.XC_SUC.cfg,16),e=!0===b.dhcp?e&-129:e|128,f.XC_SUC.cfg=e.toString(16),2>f.XC_SUC.cfg.length&&(f.XC_SUC.cfg="0"+f.XC_SUC.cfg),f.XC_SUC.cfg=f.XC_SUC.cfg.toUpperCase());b!=c&&c&&(f.XC_SUC.wlan0=c);a(JSON.stringify(f))})}else if(require("dgram"),b&&b.networkInterfaces){b=b.networkInterfaces();for(e in b)if(b.hasOwnProperty(e))for(l=b[e],h=0;h<l.length;h++)"IPv4"==l[h].family&&!1===l[h].internal&&(d=this._getIPData(l[h]),g=null,c&&c.headers&&c.headers.host&&
(g=c.headers.host,k=g.indexOf(":"),-1!=k&&(g=g.substr(0,k))),!g||g!=d.IP&&"localhost"!=g&&"127.0.0.1"!=g||(f.XC_SUC.ip=d.IP,f.XC_SUC.sn=d.SN,f.XC_SUC.gw=d.GW,f.XC_SUC.dns=d.DNS,f.XC_SUC.mac=d.MAC));a(JSON.stringify(f))}}else if("/set"==d)c.query.rgb&&6==c.query.rgb.length&&(b=require("x.hub.v5.js"),b.setRGBColor(c.query.rgb)),a('{"XC_SUC": {}}');else if("/cmd"==d)if((b=c.query.XC_FNC)&&this._cmdFunctions[b.toLowerCase()]){var n=this;this._cmdFunctions[b.toLowerCase()](c,function(b){b?a(b):n._doSTMCommandRequest(c.url,
!1,a)})}else this._doSTMCommandRequest(c.url,!1,a);else"/executeCommand"==d?(b=require("x.logger.js").getLogger("GeneralExecuteCommand API"),b.log("trace","general execute command:"+JSON.stringify(c.query)),c.query&&c.query.data?(e=c.query.type,b=c.query.data,b.device&&!b.device.sys&&(b.device.sys=e),b.gateway&&!b.gateway.sys&&(b.gateway.sys=e),e=require("x.hub.commandman.js"),e.commandHandler.executeCommand(b.device,b.gateway,b.command,function(b){b.error?a('{"XC_ERR":{"code":"000000","msg":"'+b.error.message+
'"}}'):a('{"XC_SUC":{}}')})):a('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')):"/getStates"==d?(b=require("x.logger.js").getLogger("GeneralGetStates API"),b.log("trace","general get states:"+JSON.stringify(c.query)),c.query&&c.query.data?(e=c.query.type,b=c.query.data,b.device&&!b.device.sys&&(b.device.sys=e),b.gateway&&!b.gateway.sys&&(b.gateway.sys=e),e=require("x.hub.commandman.js"),b.deviceList?e.commandHandler.getMultiStatesLegacy(b.device,b.gateway,b.deviceList,function(b){b.error?
a('{"XC_ERR":{"code":"000000","msg":"'+b.error.message+'"}}'):b&&b.data?a(JSON.stringify({XC_SUC:{data:JSON.stringify(b.data)}})):a('{"XC_SUC":{}}')}):e.commandHandler.getState(b.device,b.gateway,b.status,function(b){b.error?a('{"XC_ERR":{"code":"000000","msg":"'+b.error.message+'"}}'):b&&b.data?a(JSON.stringify({XC_SUC:{data:JSON.stringify(b.data)}})):a('{"XC_SUC":{}}')})):a('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')):a('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')};
x.hub.Server.prototype._preHandleRequest=function(d,c,a){if("POST"==d.method&&"application/octet-stream"!=d.header("content-type"))if(d.json)d.query=d.json;else if("text/plain"!=d.header("content-type")&&"text/xml"!=d.header("content-type")&&"application/xml"!=d.header("content-type")){c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');return}var b=!0;if(this._pwd&&0<this._pwd.length){b=!1;if(!d.query.at&&d.query.auth){var e=require("x.crypt.js");d.query.at=e.MD5(unescape(encodeURI(d.query.auth+
"_SALT!")))}d.query.at&&d.query.at==this._pwd&&(b=!0)}b?a():c.send('{"XC_ERR":{"code":"000007", "msg":"access denied"}}')};
x.hub.Server.prototype._startServer=function(d){this._app.set("case sensitive routing",!0);var c=this;this._app.use(function(a,b,e){b.header("Access-Control-Allow-Origin","*");b.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Authorization");XC.debugf("REQ: "+a.url);if("/"==a.url)c.doRequest("/",{query:{}},function(a){b.send(a)});else if("POST"==a.method&&"application/octet-stream"!=a.header("content-type")){var d=new Buffer([]);a.on("data",function(a){d=Buffer.concat([d,
a])});a.on("end",function(){a.body=d.toString("utf8");a.json=null;try{a.json=JSON.parse(d)}catch(h){}c._preHandleRequest(a,b,e)})}else c._preHandleRequest(a,b,e)});this._app.get("/info",function(a,b){c.doRequest("/info",a,function(a){b.send(a)})});this._app.get("/set",function(a,b){c.doRequest("/set",a,function(a){b.send(a)})});this._app.get("/cmd",function(a,b){c.doRequest("/cmd",a,function(a){b.send(a)})});this._app.post("/cmd",function(a,b){c.doRequest("/cmd",a,function(a){b.send(a)})});this._app.get("/command",
function(a,b){XC.debugf("command: "+a.url);var e=a.query.XC_FNC;if(e&&c._commandFunctions[e.toLowerCase()])c._commandFunctions[e.toLowerCase()](a,b);else c._doSTMCommandRequest(a.url,!0,function(a){b.send(a)})});this._app.post("/executeCommand",function(a,b){c.doRequest("/executeCommand",a,function(a){b.send(a)})});this._app.post("/getStates",function(a,b){c.doRequest("/getStates",a,function(a){b.send(a)})});this._app.get("/config",function(a,b){var e=!0,d=!1;a.query.name&&0<a.query.name.length&&
(c._name=a.query.name,localStorage&&localStorage.setItem("x.hub.Server.name",a.query.name));a.query.vid&&0<a.query.vid.length&&(c._vid=a.query.vid,localStorage&&localStorage.setItem("x.hub.Server.vid",a.query.vid));if(a.query.pwd||""==a.query.pwd)d=require("x.crypt.js"),0===a.query.pwd.length?(c._pwd="",a.query.cloud=0):c._pwd=d.MD5(unescape(encodeURI(a.query.pwd+"_SALT!"))),localStorage&&localStorage.setItem("x.hub.Server.pwd",c._pwd),d=!0;if(a.query.loc){var h,g,f;2==a.query.loc.length?h=a.query.loc:
8==a.query.loc.length?(g=a.query.loc.substr(0,4),f=a.query.loc.substr(4)):10==a.query.loc.length&&(h=a.query.loc.substr(0,2),g=a.query.loc.substr(2,4),f=a.query.loc.substr(6));h&&localStorage&&localStorage.setItem("x.hub.Server.timezone",h);g&&localStorage&&localStorage.setItem("x.hub.Server.geo.lat",g);f&&localStorage&&localStorage.setItem("x.hub.Server.geo.long",f);var k=require("x.hub.eventbus.js");k.emit("locationchange",{timezone:h,lat:g,long:f})}a.query.neoserver&&localStorage&&(localStorage.setItem("x.hub.taskman.NEO_SERVER",
a.query.neoserver),k=require("x.hub.eventbus.js"),k.emit("neoserver_activation",a.query.neoserver));a.query.ccu_init_state&&localStorage&&(localStorage.setItem("x.hub.m.hm.CCU_INIT_STATE",a.query.ccu_init_state),k=require("x.hub.eventbus.js"),k.emit("x.hub.m.hm.CCU_INIT_STATE",a.query.ccu_init_state));a.query.disable_st_states&&localStorage&&localStorage.setItem("x.hub.Server.DISABLE_ST_STATES",a.query.disable_st_states);"A20"==c.hostType&&(g={},a.query.ip&&a.query.sn&&a.query.gw&&a.query.dns&&(g.IP=
a.query.ip,g.SN=a.query.sn,g.GW=a.query.gw,g.DNS=a.query.dns,g.DHCP=!1),a.query.dhcp&&1==a.query.dhcp&&(g={DHCP:!0}),a.query.ntp&&(g.NTP=a.query.ntp),a.query.mac&&(g.MAC=a.query.mac),0<Object.keys(g).length&&(e=!1,h=require("x.hub.v5.js"),h.Native.setIPData(c,g,function(a){a?b.send('{"XC_SUC":{}}'):b.send('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})));a.query.sid&&localStorage&&(localStorage.setItem("x.hub.v5.SID",a.query.sid),d=!0);a.query.ckey&&localStorage&&(localStorage.setItem("x.hub.v5.cloudKey",
a.query.ckey),d=!0);a.query.cserver&&localStorage&&(localStorage.setItem("x.hub.v5.cloudServer",a.query.cserver),d=!0);a.query.cport&&localStorage&&(localStorage.setItem("x.hub.v5.cloudPort",a.query.cport),d=!0);a.query.cloud&&localStorage&&(d=255,localStorage.getItem("x.hub.v5.config")&&(d=parseInt(localStorage.getItem("x.hub.v5.config"),16)),d=1==a.query.cloud?d&-65:d|64,d=d.toString(16),2>d.length&&(d="0"+d),localStorage.setItem("x.hub.v5.config",d.toUpperCase()),d=!0);if("A20"==c.hostType&&a.query.year&&
a.query.month&&a.query.date&&a.query.hour&&a.query.minute){e=!1;g=parseInt(a.query.year);f=parseInt(a.query.month);var k=parseInt(a.query.date),p=parseInt(a.query.hour),m=parseInt(a.query.minute);if(isNaN(g)||1970>g||9999<g){b.send('{"XC_ERR":{"code":"000000", "msg":"year invalid"}}');return}if(isNaN(f)||1>f||12<f){b.send('{"XC_ERR":{"code":"000000", "msg":"month invalid"}}');return}if(isNaN(k)||1>k||31<k){b.send('{"XC_ERR":{"code":"000000", "date":"year invalid"}}');return}if(isNaN(p)||0>p||23<p){b.send('{"XC_ERR":{"code":"000000", "date":"hour invalid"}}');
return}if(isNaN(m)||0>m||59<m){b.send('{"XC_ERR":{"code":"000000", "date":"minute invalid"}}');return}h=require("x.hub.v5.js");h.Native.setDateTime(g,f,k,p,m,function(a){a?(require("x.hub.eventbus.js").emit("timechange",{}),b.send('{"XC_SUC":{}}')):b.send('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})}d&&c._cloudConnect&&c._cloudConnect.init(c);e&&b.send('{"XC_SUC": {}}')});this._app.get("/getKey",function(a,b){var e=require("x.hub.v5.js"),c={XC_SUC:{}};localStorage.getItem("x.hub.v5.cloudKey")&&
(c.XC_SUC.cloud=localStorage.getItem("x.hub.v5.cloudKey"));e.getPublicKey(function(a){c.XC_SUC.key=a;b.end(JSON.stringify(c))})});this._app.get("/peripheral",function(a,b){require("x.hub.peripheralman.js").getUSBDevicesShortInfo(function(a){a?a.error?b.end(JSON.stringify({XC_ERR:{code:"000001",msg:a.error}})):a.data?b.end(JSON.stringify({XC_SUC:a.data})):b.end(JSON.stringify({XC_ERR:{code:"000001",msg:"get peripheral internal error"}})):b.end(JSON.stringify({XC_ERR:{code:"000001",msg:"get peripheral internal error"}}))})});
this._hmPort?this._app.get("/hmtest",function(a,b){c._doHMTestRequest(a.query,b)}):"A20"==this.hostType&&this._app.get("/hmtest",function(a,b){require("x.hub.v5.js").Native.checkHMSerial(function(a){"OK"==a?b.send('{"XC_SUC":{}}'):b.send('{"XC_ERR":{"msg":"'+a+'"}}')})});this._app.get("/update",function(a,b){var e=c._getServerFromReq(a),d="80",h=null;a.query.port&&(d=a.query.port);a.query.url&&(h=a.query.url);a.query.server&&(e=a.query.server);e&&d&&h?"A20"==c.hostType?require("x.hub.v5.js").Native.updateFirmware(e,
d,h,function(a){b.send(a);c.resHasError(a)||c.restart(1E3)}):b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'):b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/updateST",function(a,b){var e=!1,d=c._getServerFromReq(a),h="80",g=null;a.query.live&&"0"!=a.query.live&&"false"!=a.query.live&&(e=!0);a.query.port&&(h=a.query.port);a.query.url&&(g=a.query.url);a.query.server&&(d=a.query.server);if(d&&h&&g)if("A20"==c.hostType){var f=require("x.hub.v5.js");e?
f.Native.updateSTFirmware(d,h,g,b):f.Native.updateSTFirmware(d,h,g,null,function(a){b.send(a)})}else e?b.send("ERROR."):b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else e?b.send("ERROR."):b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.post("/updateV5PFW",function(a,b){require("x.hub.v5.js").Native.updateV5PFirmware(a,b,function(a){c.resHasError(a)||c.restart(1E3)})});this._app.get("/backup",function(a,b){var e=require("x.crypt.js"),d=require("x.hub.v5.js");
if("A20"==c.hostType&&a.query.native&&"0"!=a.query.native&&"false"!=a.query.native)d.Native.backup(c,b);else{var h=null;a.query.enc&&"0"!=a.query.enc&&"false"!=a.query.enc&&(a.query.at?h=a.query.at:a.query.auth&&(h=e.MD5(unescape(encodeURI(a.query.auth+"_SALT!")))));d.backup(c,b,h)}});this._app.get("/restore",function(a,b){var e=c._getServerFromReq(a),d="80",h=null;a.query.port&&(d=a.query.port);a.query.url&&(h=a.query.url);if(e&&d&&h){var g=require("x.hub.v5.js");if("A20"==c.hostType&&a.query.native&&
"0"!=a.query.native&&"false"!=a.query.native)g.Native.restore(c,"http://"+e+":"+d+h,function(a){b.send(a);c.resHasError(a)||c.restart(1E3)});else{var f=null;a.query.key?f=a.query.key:a.query.at?f=a.query.at:a.query.auth&&(f=crypt.MD5(unescape(encodeURI(a.query.auth+"_SALT!"))));g.restore(c,"http://"+e+":"+d+h,f,function(a){b.send(a);c.resHasError(a)||c.restart(1E3)})}}else b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/getLogs",function(a,b){var e=require("x.hub.v5.js");
"A20"==c.hostType?e.getLogs(b):"A1"==c.HWV?e.getNeoServerLogs(b):b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/clearLogs",function(a,b){var e=require("x.hub.v5.js");"A20"==c.hostType?e.clearLogs(function(){b.send('{"XC_SUC":{}}')}):b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/getPorts",function(a,b){require("x.hub.v5.js").getSerialPorts(function(a){b.send(a)})});this._app.get("/reset",function(a,b){b.send('{"XC_SUC":{}}');c.restart(1E3)});
this._app.get("/refurbish",function(a,b){require("x.hub.v5.js").Native.setIPData(c,{DHCP:!0},function(a){a?c._stmUSB.reset(function(){require("x.hub.v5.js").resetST(function(){b.status(200).json({XC_SUC:{}})})}):b.send('{"XC_ERR":{"code":"000000", "msg":"enable dhcp failed"}}')})});this._app.get("/resetST",function(a,b){c._stmUSB.reset(function(){require("x.hub.v5.js").resetST(function(){b.status(200).json({XC_SUC:{}})})})});this._app.get("/rebootST",function(a,b){c._stmUSB.reset(function(){require("x.hub.v5.js").rebootST(function(){b.status(200).json({XC_SUC:{}})})})});
this._app.get("/resetHM",function(a,b){require("x.hub.v5.js").Native.resetHM(function(a){a?(b.status(200).json({XC_SUC:{}}),c.restart(100)):b.status(200).json({XC_ERR:{code:"000000",message:"reset homematic failed"}})})});this._app.get("/resetZwave",function(a,b){require("x.hub.v5.js").Native.resetZway(function(a){a?(b.status(200).json({XC_SUC:{}}),c.restart(100)):b.status(200).json({XC_ERR:{code:"000000",message:"reset zwave failed"}})})});this._app.get("/resetZigbee",function(a,b){require("x.hub.v5.js").Native.resetZigbee(function(a){a?
(b.status(200).json({XC_SUC:{}}),c.restart(100)):b.status(200).json({XC_ERR:{code:"000000",message:"reset zigbee failed"}})})});this._app.get("/resetKNX",function(a,b){require("x.hub.m.knx.js").reset(function(a){a&&!a.error?b.status(200).json({XC_SUC:{}}):b.status(200).json({XC_ERR:{code:"000000",message:"reset knx failed"}})})});this._app.get("/mountUSB",function(a,b){require("x.hub.v5.js").mountUSB(function(a){a.error?b.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).json({XC_SUC:{}})})});
this._app.get("/setBackupUSB",function(a,b){a.query.path?require("x.hub.v5.js").setBackupUsbPath(a.query.path,function(){b.status(200).json({XC_SUC:{}})}):b.status(500).json({XC_ERR:{code:"000000",msg:"no usb path"}})});this._app.post("/backupDeviceXML",function(a,b){var e=a.body;require("x.hub.v5.js").saveDeviceXMLforBackup(e,function(a){a.error?b.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).json({XC_SUC:{}})})});this._app.post("/backupMacrosXML",function(a,b){var e=
a.body;require("x.hub.v5.js").saveMacrosXMLforBackup(e,function(a){a.error?b.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).json({XC_SUC:{}})})});this._app.post("/backupIrcodesXML",function(a,b){var e=a.body;require("x.hub.v5.js").saveIrcodesXMLforBackup(e,function(a){a.error?b.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).json({XC_SUC:{}})})});this._app.get("/backupLocal",function(a,b){var e=require("x.crypt.js"),d=require("x.hub.v5.js"),
h=null;a.query.key&&(h=e.MD5(unescape(encodeURI(a.query.key+"_SALT!"))));d.backupLocal(c,h,function(a){a.error?b.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).json({XC_SUC:{file:a.data}})})});this._app.get("/unmountUSB",function(a,b){require("x.hub.v5.js").unmountUSB(function(a){a.error?b.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).json({XC_SUC:{}})})});this._app.get("/listUsbBackups",function(a,b){require("x.hub.v5.js").listUsbBackups(function(a){a.error?
b.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).json({XC_SUC:a.data})})});this._app.get("/deleteUsbBackup",function(a,b){var c=a.query.file;c?require("x.hub.v5.js").deleteBackup(c,function(a){a.error?b.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).json({XC_SUC:{}})}):b.status(200).json({XC_ERR:{code:"000000",msg:"file name is null"}})});this._app.get("/loadBackup",function(a,b){var c=require("x.hub.v5.js"),d=require("x.crypt.js"),h=a.query.file;
if(h){var g=null;a.query.key&&(g=d.MD5(unescape(encodeURI(a.query.key+"_SALT!"))));c.loadBackup(h,g,function(a){a.error?b.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).json({XC_SUC:{}})})}else b.status(200).json({XC_ERR:{code:"000000",msg:"file name is null"}})});this._app.get("/loadBackupDeviceXML",function(a,b){require("x.hub.v5.js").loadDeviceXML(function(a){a.error?b.status(400).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).end(a.data)})});this._app.get("/loadBackupMacroXML",
function(a,b){require("x.hub.v5.js").loadMacroXML(function(a){a.error?b.status(400).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).end(a.data)})});this._app.get("/loadBackupIrcodesXML",function(a,b){require("x.hub.v5.js").loadIrcodesXML(function(a){a.error?b.status(400).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).end(a.data)})});this._app.get("/restoreLocal",function(a,b){require("x.hub.v5.js").restoreLocal(c,function(a){a.error?b.status(200).json({XC_ERR:{code:"000000",
msg:a.error.message}}):(b.status(200).json({XC_SUC:{}}),c.restart(1E3))})});this._app.get("/testReadOnly",function(a,b){require("x.hub.v5.js").testReadOnly(function(a){a?b.status(200).json({XC_SUC:{readonly:!0,message:a.message}}):b.status(200).json({XC_SUC:{readonly:!1}})})});this._app.get("/fixReadOnly",function(a,b){require("x.hub.v5.js").fixReadOnly(b,function(a){a?b.status(200).json({XC_ERR:{code:"01001",message:a.message}}):b.status(200).json({XC_SUC:{}})})});this._app.get("/scan",function(a,
b){require("x.hub.v5.js").Native.scanWiFi(function(a,c){if(a)b.send(a.message);else if(c){b.send('{"XC_SUC":'+JSON.stringify(c)+"}");return}b.send('{"XC_ERR":{"msg":"Scanning wifis failed."}}')})});this._app.get("/connect",function(a,b){a.query.ssid&&a.query.pwd?require("x.hub.v5.js").Native.connectWiFi(a.query.ssid,a.query.pwd,function(a){a?b.send('{"XC_SUC":{}}'):b.send('{"XC_ERR":{"msg":"failed to connect"}}')}):b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/configWLAN",
function(a,b){var c={};a.query.ip&&a.query.sn&&a.query.gw&&a.query.dns&&(c.IP=a.query.ip,c.SN=a.query.sn,c.GW=a.query.gw,c.DNS=a.query.dns,c.DHCP=!1);a.query.dhcp&&1==a.query.dhcp&&(c={DHCP:!0});a.query.ntp&&(c.NTP=a.query.ntp);a.query.mac&&(c.MAC=a.query.mac);0<Object.keys(c).length?require("x.hub.v5.js").Native.setWLANData(c,function(a){a?b.send('{"XC_SUC":{}}'):b.send('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')}):b.send('{"XC_SUC": {}}')});this._app.get("/tm/http",function(a,b){var c=
require("x.hub.taskman.js");if(c&&c.taskManager)c.taskManager.onHttpEvt(a.query,function(a,c){a?b.send('{"XC_ERR":{"msg":'+a.message+"}}"):c?b.send('{"XC_SUC":{}}'):b.send('{"XC_ERR":{"msg":"no such trigger"}}')});else b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("*",function(a,b){XC.debugf("INVALID REQ: "+a.url);b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.use(function(a,b,c,d){XC.debugf(a);c.send({XC_ERR:{code:"000001",msg:"exception"}})});
this._httpserver.listen(this._port,function(){var a=c._httpserver.address().port;XC.debugf("listening on port "+a+"...");d&&d()})};
x.hub.Server.prototype._getIPData=function(d){var c={};c.IP=d.address;c.PT=this._port;c.SN="255.255.255.0";d.netmask&&(c.SN=d.netmask);c.GW="0.0.0.0";var a=null;try{a=require("netroute")}catch(b){}if(a&&(a=a.getInfo())&&a.IPv4)for(var e=0;e<a.IPv4.length;e++)if("0.0.0.0"==a.IPv4[e].destination){c.GW=a.IPv4[e].gateway;break}c.DNS="0.0.0.0";(a=require("dns"))&&a.getServers&&(a=a.getServers())&&0<a.length&&(c.DNS=a[0]);c.MAC="00-00-00-00-00-00";d.mac&&(c.MAC=d.mac.replace(/:/g,"-"));return c};
x.hub.Server.prototype.sendUDPMessage=function(d){this._udpSocket&&(d=new Buffer(d),this._udpSocket.send(d,0,d.length,1901,"239.255.255.250"),this._udpSocket.send(d,0,d.length,1901,"255.255.255.255"))};
x.hub.Server.prototype._startUDPServer=function(d,c){var a=require("dgram"),b=this,e;try{e=this._udpSocket=a.createSocket({reuseAddr:!0,type:"udp4"})}catch(l){e=this._udpSocket=a.createSocket("udp4")}e.on("listening",function(){e.address();XC.debugf("listening on udp port "+d+"...");e.setBroadcast(!0);c&&c()});e.on("message",function(a,c){e.address();if(a&&a.length&&3<=a.length&&71==a[0]&&69==a[1]&&84==a[2]){b._logger.log("trace","receive gateway discovery request");var d=function(a,d){var f="DHCP:"+
(a.DHCP?"TRUE":"FALSE")+"\nHWV:"+b.HWV+"\nVER:"+b.VERSION+"\nVID:"+b._vid+"\nNAME:"+b._name,f=f+("\nIP:"+a.IP),f=f+("\nPT:"+a.PT),f=f+("\nSN:"+a.SN),f=f+("\nGW:"+a.GW),f=f+("\nDNS:"+a.DNS),f=f+("\nMAC:"+a.MAC);d&&(f+="\nTMP_ID:"+d);f+="\n";b._logger.log("trace","send gateway discovery response:"+f);f=new Buffer(f);e.send(f,0,f.length,c.port,c.address);e.send(f,0,f.length,1901,"239.255.255.250");e.send(f,0,f.length,1901,"255.255.255.255")};if("A20"==b.hostType)require("x.hub.v5.js").Native.getIPData(function(a){var c=
function(){return Math.floor(65536*(1+Math.random())).toString(16).substr(1)},c=c()+c(),e;for(e in a)for(var g=0;g<a[e].length;g++)a[e][g].PT=b._port,d(a[e][g],c)});else{var k=require("os");if(k&&k.networkInterfaces){var k=k.networkInterfaces(),l;for(l in k)if(k.hasOwnProperty(l))for(var m=k[l],n=0;n<m.length;n++)"IPv4"==m[n].family&&!1===m[n].internal&&d(b._getIPData(m[n]))}}}else if(a&&a.length&&4<=a.length&&69==a[0]&&86==a[1]&&84==a[2]){if(k=a.toString(),4<k.length){l=null;try{l=JSON.parse(k.substr(4))}catch(q){}l&&
(k=require("x.hub.eventbus.js"),k.emit("gatewayevent",l,c,"EVT"))}}else if(a&&a.length&&4<=a.length&&83==a[0]&&84==a[1]&&65==a[2]&&(k=a.toString(),4<k.length)){l=null;try{l=JSON.parse(k.substr(4))}catch(r){}l&&(k=require("x.hub.eventbus.js"),k.emit("gatewayevent",l,c,"STA"))}});e.on("error",function(a){XC.debugf("udp port error");e.close()});e.on("close",function(){});e.bind(d)};
x.hub.Server.prototype.onUdpEvt=function(d,c){c||(c="EVT");this._logger.log("trace","send "+c+" event:"+JSON.stringify(d));this.sendUDPMessage(c+":"+JSON.stringify(d)+"\r\n")};x.hub.Server.prototype.onStatusEvt=function(d){};x.hub.Server.prototype.getTimeZone=function(){var d="8C";localStorage&&localStorage.getItem("x.hub.Server.timezone")&&(d=localStorage.getItem("x.hub.Server.timezone"));return d};
x.hub.Server.prototype.setTimeZoneCompatiable=function(d,c){if(!d||isNaN(parseInt(d,16)))c&&c(Error("timezone invalid"));else{var a=parseInt(d,16),a=((a>>4&1?-1:1)*(a&15)+11&31|(a>>5&1)<<7).toString(16).toUpperCase();2>a.length&&(a="0"+a);a&&localStorage&&localStorage.setItem("x.hub.Server.timezone",a);var b=localStorage.getItem("x.hub.Server.geo.lat"),e=localStorage.getItem("x.hub.Server.geo.long");require("x.hub.eventbus.js").emit("locationchange",{timezone:a,lat:b,long:e});c&&c()}};
x.hub.Server.prototype.getTimeZoneCompatiable=function(d){var c=this.getTimeZone(),c=parseInt(c,16),a=(c&31)-11,c=((0!=(c&128)?1:0)<<5|(0>a?1:0)<<4|(0<a?a:0-a)).toString(16).toUpperCase();2>c.length&&(c="0"+c);d&&d(null,c)};x.hub.Handler=function(){this.server=null};x.hub.Handler.prototype.Server=x.hub.Server;"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.Handler);
