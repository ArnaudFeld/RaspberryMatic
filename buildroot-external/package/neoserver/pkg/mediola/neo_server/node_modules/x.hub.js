var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(d,c,a){d!=Array.prototype&&d!=Object.prototype&&(d[c]=a.value)};$jscomp.getGlobal=function(d){return"undefined"!=typeof window&&window===d?d:"undefined"!=typeof global&&null!=global?global:d};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var d=0;return function(c){return $jscomp.SYMBOL_PREFIX+(c||"")+d++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var d=$jscomp.global.Symbol.iterator;d||(d=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[d]&&$jscomp.defineProperty(Array.prototype,d,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(d){var c=0;return $jscomp.iteratorPrototype(function(){return c<d.length?{done:!1,value:d[c++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(d){$jscomp.initSymbolIterator();d={next:d};d[$jscomp.global.Symbol.iterator]=function(){return this};return d};$jscomp.iteratorFromArray=function(d,c){$jscomp.initSymbolIterator();d instanceof String&&(d+="");var a=0,b={next:function(){if(a<d.length){var e=a++;return{value:c(e,d[e]),done:!1}}b.next=function(){return{done:!0,value:void 0}};return b.next()}};b[Symbol.iterator]=function(){return b};return b};
$jscomp.polyfill=function(d,c,a,b){if(c){a=$jscomp.global;d=d.split(".");for(b=0;b<d.length-1;b++){var e=d[b];e in a||(a[e]={});a=a[e]}d=d[d.length-1];b=a[d];c=c(b);c!=b&&null!=c&&$jscomp.defineProperty(a,d,{configurable:!0,writable:!0,value:c})}};$jscomp.polyfill("Array.prototype.keys",function(d){return d?d:function(){return $jscomp.iteratorFromArray(this,function(c){return c})}},"es6","es3");require("x.core.js");var x=x||{};x.hub=x.hub||{};
x.hub.Dispatcher=function(){var d=function(c){this._expressApp=c;this._routes=[]};d.prototype.add=function(c,a,b){if(!c||!b)throw Error("invalid arguments");this._routes.push({path:c,opts:a,callback:b})};d.prototype.doRequest=function(c,a,b,e){var d=this,g=function(a,b,c,k){d._findRoute(a,b,function(a,d){a?a.callback(c,k,function(){g(d+1,b,c,k)}):e()})};g(0,c,a,b)};d.prototype._findRoute=function(c,a,b){for(;c<this._routes.length;c++){var e=this._routes[c];if(e&&0==e.path.indexOf(a)){b(e,c);return}}b(null,
-1)};d.prototype.init=function(){var c=this;this._expressApp.use("/",function(a,b,e){c.doRequest(a.path,a,b,e)})};return d}();
x.hub.Auth=function(){var d=function(){};d.prototype.auth=function(c,a){if(!a||!a.pwd)return!0;if(!c.query.at&&c.query.auth){var b=require("x.crypt.js");c.query.at=b.MD5(unescape(encodeURI(c.query.auth+"_SALT!")))}return c.query.at&&c.query.at==a.pwd?!0:c.headers&&c.headers.authorization?this._checkAuthHeader(c.headers.authorization,a):!1};d.prototype._checkAuthHeader=function(c,a){return c&&"Basic "==c.substr(0,6)?(c=c.substr(6).trim(),(c=(new Buffer(c,"base64")).toString().split(":")[1])?require("x.crypt.js").MD5(unescape(encodeURI(c+
"_SALT!")))==a.pwd:!1):!1};return d}();
x.hub.Server=function(d,c,a){this._logger=require("x.logger.js").getLogger("x.hub.Server");this.HWV="EB";this.VERSION="0.0.0";this.DEFAULT_NAME="XHUB";this.VID="FFFF";this.hostType="A20";this._port=null;this._stmPort=d;this._hmPort=c;this._signalPin=a;this._cloudConnect=this._hmSerial=this._stmUSB=null;this._pwd="";this._onCustomSerialEvent=this._onSerialEvent=null;this._app=require("express")();this._dispatcher=new x.hub.Dispatcher(this._app);this._httpserver=require("http").createServer(this._app);
this._commandFunctions={};this._cmdFunctions={};this._logger={log:function(){}};try{var b=require("x.logger.js");b&&(this._logger=b.getLogger("x.hub.Server"));var e=require("x.hub.eventbus.js");e&&(e.on("udpevent",this.onUdpEvt.bind(this)),e.on("status",this.onStatusEvt.bind(this)))}catch(k){}localStorage&&(localStorage.getItem("x.hub.Server.timezone")||localStorage.setItem("x.hub.Server.timezone","8C"),localStorage.getItem("x.hub.Server.geo.lat")||localStorage.setItem("x.hub.Server.geo.lat","1392"),
localStorage.getItem("x.hub.Server.geo.long")||localStorage.setItem("x.hub.Server.geo.long","035C"),localStorage.getItem("x.hub.Server.pwd")&&(this._pwd=localStorage.getItem("x.hub.Server.pwd")));this._auth=new x.hub.Auth};x.hub.Server.prototype.auth=function(d){return this._auth.auth(d,{pwd:this._pwd})};
x.hub.Server.prototype.getNetworkSettings=function(d){if("A20"==this.hostType)require("x.hub.v5.js").Native.getIPData(function(a){d&&d(null,a)});else{var c={},a=require("os");if(a&&a.networkInterfaces){a=a.networkInterfaces();for(var b in a){c[b]||(c[b]=[]);for(var e=a[b],k=0;k<e.length;k++)if("IPv4"==e[k].family&&!1===e[k].internal){var g=this._getIPData(e[k]);c[b].push(g)}}}d&&d(null,c)}};
x.hub.Server.prototype._getIPData=function(d){var c={};c.IP=d.address;c.PT=this._port;c.SN="255.255.255.0";d.netmask&&(c.SN=d.netmask);c.GW="0.0.0.0";var a=null;try{a=require("netroute")}catch(e){}if(a&&(a=a.getInfo())&&a.IPv4)for(var b=0;b<a.IPv4.length;b++)if("0.0.0.0"==a.IPv4[b].destination){c.GW=a.IPv4[b].gateway;break}c.DNS="0.0.0.0";(a=require("dns"))&&a.getServers&&(a=a.getServers())&&0<a.length&&(c.DNS=a[0]);c.MAC="00-00-00-00-00-00";d.mac&&(c.MAC=d.mac.replace(/:/g,"-"));return c};
x.hub.Server.prototype.addRoute=function(d,c,a){"function"==typeof c&&(a=c,c=null);return this._dispatcher.add(d,c,a)};
x.hub.Server.prototype.start=function(d){this._port=d;this._name=this.DEFAULT_NAME;localStorage&&localStorage.getItem("x.hub.Server.name")&&(this._name=localStorage.getItem("x.hub.Server.name"));this._vid=this.VID;localStorage&&localStorage.getItem("x.hub.Server.vid")&&(this._vid=localStorage.getItem("x.hub.Server.vid"));this._startup=Math.round((new Date).getTime()/1E3);this._startServer();this._startUDPServer(1901);if(this._stmPort){var c=this;this._stmUSB=new (require("x.hub.v5.js").USBSerial)(this._stmPort,
this._signalPin);this._stmUSB.on("data",function(a){if(a&&a.type&&a.data)if(80==a.type&&c._onSerialEvent){a=a.data.toString();var b=null;8<a.length&&"{XC_EVT}"==a.substr(0,8)?(a=a.substr(8),b="EVT"):4<a.length&&"EVT:"==a.substr(0,4)?(a=a.substr(4),b="EVT"):4<a.length&&"STA:"==a.substr(0,4)&&(a=a.substr(4),b="STA");c._onSerialEvent(a,b)}else 82==a.type&&c._onCustomSerialEvent&&c._onCustomSerialEvent(a.data)})}};
x.hub.Server.prototype.startSTM=function(d){if(this._stmPort){var c=this;this._stmUSB=new (require("x.hub.v5.js").USBSerial)(this._stmPort,this._signalPin,d);this._stmUSB.on("data",function(a){if(a&&a.type&&a.data)if(80==a.type&&c._onSerialEvent){a=a.data.toString();var b=null;8<a.length&&"{XC_EVT}"==a.substr(0,8)?(a=a.substr(8),b="EVT"):4<a.length&&"EVT:"==a.substr(0,4)?(a=a.substr(4),b="EVT"):4<a.length&&"STA:"==a.substr(0,4)&&(a=a.substr(4),b="STA");c._onSerialEvent(a,b)}else 82==a.type&&c._onCustomSerialEvent&&
c._onCustomSerialEvent(a.data)})}};
x.hub.Server.prototype.startWebserver=function(d,c){this._port=d;this._name=this.DEFAULT_NAME;localStorage&&localStorage.getItem("x.hub.Server.name")&&(this._name=localStorage.getItem("x.hub.Server.name"));this._vid=this.VID;localStorage&&localStorage.getItem("x.hub.Server.vid")&&(this._vid=localStorage.getItem("x.hub.Server.vid"));this._startup=Math.round((new Date).getTime()/1E3);var a=0;this._startServer(function(){console.log("************* ++++++++++++++++++ **************");console.log("************* http server started **************");
console.log("************* ++++++++++++++++++ **************");a++;2==a&&c&&c()});this._startUDPServer(1901,function(){console.log("************* ++++++++++++++++++ **************");console.log("************* upd server started **************");console.log("************* ++++++++++++++++++ **************");a++;2==a&&c&&c()})};x.hub.Server.prototype.on=function(d,c){"serialevent"==d?this._onSerialEvent=c:"customserialevent"==d&&(this._onCustomSerialEvent=c)};
x.hub.Server.prototype._getServerFromReq=function(d){if(d.query.server)return d.query.server;var c=null;d.ip?c=d.ip:d.connection.remoteAddress&&(c=d.connection.remoteAddress);c&&-1<c.indexOf(":")&&c.indexOf(".")>c.indexOf(":")?c=c.substr(c.lastIndexOf(":")+1):"::1"==c&&(c="localhost");return c};x.hub.Server.prototype.enableCloudConnect=function(d){this._cloudConnect=d;d.init(this)};
x.hub.Server.prototype.restart=function(d){XC.debugf("RESTART!");var c=this;setTimeout(function(){"A20"==c.hostType?require("x.hub.v5.js").Native.reboot():process.exit(0)},d)};x.hub.Server.prototype.resHasError=function(d){var c=null;try{c=JSON.parse(d)}catch(a){c=null}return c&&c.XC_ERR?!0:!1};
x.hub.Server.prototype._doSTMCommandRequest=function(d,c,a){this._stmUSB&&d&&-1<d.indexOf("?")?(d=d.substr(d.indexOf("?")+1),this._stmUSB.sendCommand(16,d,function(b){b&&b.data?XC.debugf(d+" --\x3e "+b.data.toString()):b&&b.error?XC.debugf(d+" --\x3e FAIL:"+b.error):XC.debugf(d+" --\x3e FAIL");if(b&&b.data){var e="XC_SUC";b.error&&(e="XC_ERR");c?a("{"+e+"}"+b.data.toString()):a('{"'+e+'": '+b.data.toString()+"}")}else c?a("{XC_ERR}internal error"):b&&b.error?a(JSON.stringify({XC_ERR:{code:"000000",
msg:b.error}})):a('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})):c?a("{XC_ERR}invalid request"):a('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')};x.hub.Server.prototype.doSTMCommand=function(d,c){this._doSTMCommandRequest("/cmd?"+d,!1,function(a){var b=null;try{b=JSON.parse(a)}catch(e){b=null}c&&c(b)})};x.hub.Server.prototype.doSTMRequest=function(d,c,a){this._stmUSB?this._stmUSB.sendCommand(d,c,function(b){b?b.error?a(null):a(b.data):a(null)}):a(null)};
x.hub.Server.prototype.setCommandFunc=function(d,c){this._commandFunctions[d.toLowerCase()]=c};x.hub.Server.prototype.setCmdFunc=function(d,c){this._cmdFunctions[d.toLowerCase()]=c};
x.hub.Server.prototype.doRequest=function(d,c,a){var b=require("os");if("/"==d){var e='<!DOCTYPE html>\n<html>\n<head>\n<meta http-equiv="content-type" content="text/html; charset=utf-8" />\n'+("<title>"+String(this._name).replace(/</g,"&lt;").replace(/>/g,"&gt;")+"</title>\n")+'<script>function setHMconfigRef() {var hmconfig = document.getElementById("hmconfig"); if(hmconfig){hmconfig.href = window.location.protocol + "//" + window.location.hostname + ":81/";}}\x3c/script>\n';e=e+'</head>\n<body style="background-color: #FFFFFF; font-family: Helvetica, Arial, sans-serif;" onload="setHMconfigRef()">\n<table style="border-radius: 0px 0px 8px 8px; border: 1px #999 solid; -moz-box-shadow: 0px 5px 8px #888; -webkit-box-shadow: 2px 5px 8px #888; box-shadow: 0px 5px 8px #888; position: absolute; height: 220px; width: 420px; margin: -110px 0px 0px -210px; top: 50%; left: 50%; color: #777; background-color: #fafafa; font-size: 15px;" border="0" cellspacing="0">\n<tbody>\n<tr style="height: 48px; background-color: #666; color: #FFFFFF; font-size: 20px;">'+
('<th colspan="3">'+this._name+"</th>\n");e=e+'</tr>\n<tr style="height: 28px;"><td style="width: 70px;">&nbsp;</td><td style="width: 150px;">&nbsp;</td><td>&nbsp;</td></tr>\n'+('<tr style="height: 30px;"><td>&nbsp;</td><td>device:</td><td><b>'+this.DEFAULT_NAME+"</b></td></tr>\n");e+='<tr style="height: 30px;"><td>&nbsp;</td><td>version:</td><td><b>'+this.HWV+" ("+this.VERSION+")</b></td></tr>\n";var k=Math.round((new Date).getTime()/1E3)-this._startup,g=Math.floor(k/86400);k-=86400*g;d=Math.floor(k/
3600);k-=3600*d;var h=Math.floor(k/60);e+='<tr style="height: 30px;"><td>&nbsp;</td><td>uptime:</td><td><b>'+g+"d "+d+"h "+h+"m "+(k-60*h)+"s</b></td></tr>\n";b&&b.freemem&&(e+='<tr style="height: 30px;"><td>&nbsp;</td><td>memory:</td><td><b>'+Math.floor(b.freemem()/1E3)+"</b></td></tr>\n");a(e+'<tr style="height: 0px;"><td colspan="3">&nbsp;</td></tr>\n<tr style="height: 32px;"><td colspan="3" style="font-size: 13px; text-align: center;">&copy;&nbsp;2018 mediola - connected living AG</td></tr>\n</tbody>\n</table>\n</body>\n</html>')}else if("/info"==
d){var f={XC_SUC:{name:this._name,mhv:"XH I-"+this.hostType,msv:this.VERSION,hwv:this.HWV,vid:this._vid,start:this._startup,time:Math.round((new Date).getTime()/1E3)}};d="8C";h="1392";var l="035C";localStorage.getItem("x.hub.Server.timezone")&&(d=localStorage.getItem("x.hub.Server.timezone"));localStorage.getItem("x.hub.Server.geo.lat")&&(h=localStorage.getItem("x.hub.Server.geo.lat"));localStorage.getItem("x.hub.Server.geo.long")&&(l=localStorage.getItem("x.hub.Server.geo.long"));f.XC_SUC.loc=(d+
h+l).toUpperCase();localStorage.getItem("x.hub.v5.config")&&(f.XC_SUC.cfg=localStorage.getItem("x.hub.v5.config"));localStorage.getItem("x.hub.v5.cloudServer")&&localStorage.getItem("x.hub.v5.cloudPort")?f.XC_SUC.server=localStorage.getItem("x.hub.v5.cloudServer")+":"+localStorage.getItem("x.hub.v5.cloudPort"):(d=require("x.hub.v5.js").CloudConnect,f.XC_SUC.server=d.prototype.CLOUD_SERVER+":"+d.prototype.CLOUD_SERVER_PORT);localStorage.getItem("x.hub.v5.SID")&&(f.XC_SUC.sid=localStorage.getItem("x.hub.v5.SID"));
localStorage.getItem("x.hub.taskman.NEO_SERVER")&&(f.XC_SUC.neoserver=localStorage.getItem("x.hub.taskman.NEO_SERVER"));localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE")&&(f.XC_SUC.ccu_init_state=localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE"));localStorage.getItem("x.hub.Server.DISABLE_ST_STATES")&&(f.XC_SUC.disable_st_states=localStorage.getItem("x.hub.Server.DISABLE_ST_STATES"));b&&b.freemem&&(f.XC_SUC.mem=Math.floor(b.freemem()/1E3));try{global.LOAD_MODULES&&-1!=global.LOAD_MODULES.indexOf("enocean")&&
(k=require("x.hub.m.enocean.js"))&&(g=k.getEnoceanInfo(),f.XC_SUC.enocean=g)}catch(q){}if("A20"==this.hostType){f.XC_SUC.SAFE_MODE=global.SAFE_MODE;e=require("x.hub.v5.js");var n=function(a){return{ip:a.IP,sn:a.SN,gw:a.GW,dhcp:a.DHCP,dns:a.DNS,mac:a.MAC,ntp:a.NTP}};e.Native.getIPData(function(b){var c=null,e=null;Array.isArray(b.eth0)&&(c=n(b.eth0[0]));Array.isArray(b.wlan0)&&(e=n(b.wlan0[0]));b=c||e;for(var d in b)f.XC_SUC[d]=b[d];f.XC_SUC.primary_net=b===c?"eth0":"wlan0";f.XC_SUC.cfg&&b&&(c=parseInt(f.XC_SUC.cfg,
16),c=!0===b.dhcp?c&-129:c|128,f.XC_SUC.cfg=c.toString(16),2>f.XC_SUC.cfg.length&&(f.XC_SUC.cfg="0"+f.XC_SUC.cfg),f.XC_SUC.cfg=f.XC_SUC.cfg.toUpperCase());b!=e&&e&&(f.XC_SUC.wlan0=e);a(JSON.stringify(f))})}else if(require("dgram"),b&&b.networkInterfaces){b=b.networkInterfaces();for(e in b)if(b.hasOwnProperty(e))for(k=b[e],g=0;g<k.length;g++)"IPv4"==k[g].family&&!1===k[g].internal&&(d=this._getIPData(k[g]),h=null,c&&c.headers&&c.headers.host&&(h=c.headers.host,l=h.indexOf(":"),-1!=l&&(h=h.substr(0,
l))),!h||h!=d.IP&&"localhost"!=h&&"127.0.0.1"!=h||(f.XC_SUC.ip=d.IP,f.XC_SUC.sn=d.SN,f.XC_SUC.gw=d.GW,f.XC_SUC.dns=d.DNS,f.XC_SUC.mac=d.MAC));a(JSON.stringify(f))}}else if("/set"==d)c.query.rgb&&6==c.query.rgb.length&&(e=require("x.hub.v5.js"),e.setRGBColor(c.query.rgb)),a('{"XC_SUC": {}}');else if("/cmd"==d)if((e=c.query.XC_FNC)&&this._cmdFunctions[e.toLowerCase()]){var p=this;this._cmdFunctions[e.toLowerCase()](c,function(b){b?a(b):p._doSTMCommandRequest(c.url,!1,a)})}else this._doSTMCommandRequest(c.url,
!1,a);else if("/executeCommand"==d)e=require("x.logger.js").getLogger("GeneralExecuteCommand API"),e.log("trace","general execute command:"+JSON.stringify(c.query)),c.query&&c.query.data?(b=c.query.type,e=c.query.data,e.device&&!e.device.sys&&(e.device.sys=b),e.gateway&&!e.gateway.sys&&(e.gateway.sys=b),b=require("x.hub.commandman.js"),b.commandHandler.executeCommand(e.device,e.gateway,e.command,function(b){b.error?a('{"XC_ERR":{"code":"000000","msg":"'+b.error.message+'"}}'):a('{"XC_SUC":{}}')})):
a('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/getStates"==d)e=require("x.logger.js").getLogger("GeneralGetStates API"),e.log("trace","general get states:"+JSON.stringify(c.query)),c.query&&c.query.data?(b=c.query.type,e=c.query.data,e.device&&!e.device.sys&&(e.device.sys=b),e.gateway&&!e.gateway.sys&&(e.gateway.sys=b),b=require("x.hub.commandman.js"),e.deviceList?b.commandHandler.getMultiStatesLegacy(e.device,e.gateway,e.deviceList,function(b){b.error?a('{"XC_ERR":{"code":"000000","msg":"'+
b.error.message+'"}}'):b&&b.data?a(JSON.stringify({XC_SUC:{data:JSON.stringify(b.data)}})):a('{"XC_SUC":{}}')}):b.commandHandler.getState(e.device,e.gateway,e.status,function(b){b.error?a('{"XC_ERR":{"code":"000000","msg":"'+b.error.message+'"}}'):b&&b.data?a(JSON.stringify({XC_SUC:{data:JSON.stringify(b.data)}})):a('{"XC_SUC":{}}')})):a('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else{var m=a;e={json:function(a){m&&(m(JSON.stringify(a)),m=null)},send:function(a){m&&(m(a),m=null)},status:function(){},
end:function(){m&&(m(),m=null)}};this._dispatcher.doRequest(d,c,e,function(){m&&(m('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'),m=null)})}};
x.hub.Server.prototype._preHandleRequest=function(d,c,a){if("POST"==d.method&&"application/octet-stream"!=d.header("content-type"))if(d.json)d.query=d.json;else if("text/plain"!=d.header("content-type")&&"text/xml"!=d.header("content-type")&&"application/xml"!=d.header("content-type")){c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');return}this.auth(d)?a():c.send('{"XC_ERR":{"code":"000007", "msg":"access denied"}}')};
x.hub.Server.prototype._startServer=function(d){this._app.set("case sensitive routing",!0);var c=this;this._app.use(function(a,b,e){b.header("Access-Control-Allow-Origin","*");b.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Authorization");require("x.logger.js").getLogger("x.hub.Server.Access").log("debug","REQ:"+a.url);if("/"==a.url)c.doRequest("/",{query:{}},function(a){b.send(a)});else if("POST"==a.method&&"application/octet-stream"!=a.header("content-type")){var d=
new Buffer([]);a.on("data",function(a){d=Buffer.concat([d,a])});a.on("end",function(){a.body=d.toString("utf8");a.json=null;try{a.json=JSON.parse(d)}catch(g){}c._preHandleRequest(a,b,e)})}else c._preHandleRequest(a,b,e)});this._app.get("/info",function(a,b){c.doRequest("/info",a,function(a){b.send(a)})});this._app.get("/set",function(a,b){c.doRequest("/set",a,function(a){b.send(a)})});this._app.get("/cmd",function(a,b){c.doRequest("/cmd",a,function(a){b.send(a)})});this._app.post("/cmd",function(a,
b){c.doRequest("/cmd",a,function(a){b.send(a)})});this._app.get("/command",function(a,b){XC.debugf("command: "+a.url);var e=a.query.XC_FNC;if(e&&c._commandFunctions[e.toLowerCase()])c._commandFunctions[e.toLowerCase()](a,b);else c._doSTMCommandRequest(a.url,!0,function(a){b.send(a)})});this._app.post("/executeCommand",function(a,b){c.doRequest("/executeCommand",a,function(a){b.send(a)})});this._app.post("/getStates",function(a,b){c.doRequest("/getStates",a,function(a){b.send(a)})});this._app.get("/config",
function(a,b){var e=!0,d=!1;a.query.name&&0<a.query.name.length&&(c._name=a.query.name,localStorage&&localStorage.setItem("x.hub.Server.name",a.query.name));a.query.vid&&0<a.query.vid.length&&(c._vid=a.query.vid,localStorage&&localStorage.setItem("x.hub.Server.vid",a.query.vid));if(a.query.pwd||""==a.query.pwd)d=require("x.crypt.js"),0===a.query.pwd.length?(c._pwd="",a.query.cloud=0):c._pwd=d.MD5(unescape(encodeURI(a.query.pwd+"_SALT!"))),localStorage&&localStorage.setItem("x.hub.Server.pwd",c._pwd),
d=!0;if(a.query.loc){if(2==a.query.loc.length)var g=a.query.loc;else if(8==a.query.loc.length){var h=a.query.loc.substr(0,4);var f=a.query.loc.substr(4)}else 10==a.query.loc.length&&(g=a.query.loc.substr(0,2),h=a.query.loc.substr(2,4),f=a.query.loc.substr(6));g&&localStorage&&localStorage.setItem("x.hub.Server.timezone",g);h&&localStorage&&localStorage.setItem("x.hub.Server.geo.lat",h);f&&localStorage&&localStorage.setItem("x.hub.Server.geo.long",f);var l=require("x.hub.eventbus.js");l.emit("locationchange",
{timezone:g,lat:h,long:f})}a.query.neoserver&&localStorage&&(localStorage.setItem("x.hub.taskman.NEO_SERVER",a.query.neoserver),l=require("x.hub.eventbus.js"),l.emit("neoserver_activation",a.query.neoserver));a.query.ccu_init_state&&localStorage&&(localStorage.setItem("x.hub.m.hm.CCU_INIT_STATE",a.query.ccu_init_state),l=require("x.hub.eventbus.js"),l.emit("x.hub.m.hm.CCU_INIT_STATE",a.query.ccu_init_state));a.query.disable_st_states&&localStorage&&localStorage.setItem("x.hub.Server.DISABLE_ST_STATES",
a.query.disable_st_states);"A20"==c.hostType&&(h={},a.query.ip&&a.query.sn&&a.query.gw&&a.query.dns&&(h.IP=a.query.ip,h.SN=a.query.sn,h.GW=a.query.gw,h.DNS=a.query.dns,h.DHCP=!1),a.query.dhcp&&1==a.query.dhcp&&(h={DHCP:!0}),a.query.ntp&&(h.NTP=a.query.ntp),a.query.mac&&(h.MAC=a.query.mac),0<Object.keys(h).length&&(e=!1,g=require("x.hub.v5.js"),g.Native.setIPData(c,h,function(a){a?b.send('{"XC_SUC":{}}'):b.send('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})));a.query.sid&&localStorage&&
(localStorage.setItem("x.hub.v5.SID",a.query.sid),d=!0);a.query.ckey&&localStorage&&(localStorage.setItem("x.hub.v5.cloudKey",a.query.ckey),d=!0);a.query.cserver&&localStorage&&(localStorage.setItem("x.hub.v5.cloudServer",a.query.cserver),d=!0);a.query.cport&&localStorage&&(localStorage.setItem("x.hub.v5.cloudPort",a.query.cport),d=!0);a.query.cloud&&localStorage&&(d=255,localStorage.getItem("x.hub.v5.config")&&(d=parseInt(localStorage.getItem("x.hub.v5.config"),16)),d=1==a.query.cloud?d&-65:d|64,
d=d.toString(16),2>d.length&&(d="0"+d),localStorage.setItem("x.hub.v5.config",d.toUpperCase()),d=!0);if("A20"==c.hostType&&a.query.year&&a.query.month&&a.query.date&&a.query.hour&&a.query.minute){e=!1;h=parseInt(a.query.year);f=parseInt(a.query.month);l=parseInt(a.query.date);var n=parseInt(a.query.hour);a=parseInt(a.query.minute);if(isNaN(h)||1970>h||9999<h){b.send('{"XC_ERR":{"code":"000000", "msg":"year invalid"}}');return}if(isNaN(f)||1>f||12<f){b.send('{"XC_ERR":{"code":"000000", "msg":"month invalid"}}');
return}if(isNaN(l)||1>l||31<l){b.send('{"XC_ERR":{"code":"000000", "date":"year invalid"}}');return}if(isNaN(n)||0>n||23<n){b.send('{"XC_ERR":{"code":"000000", "date":"hour invalid"}}');return}if(isNaN(a)||0>a||59<a){b.send('{"XC_ERR":{"code":"000000", "date":"minute invalid"}}');return}g=require("x.hub.v5.js");g.Native.setDateTime(h,f,l,n,a,function(a){a?(require("x.hub.eventbus.js").emit("timechange",{}),b.send('{"XC_SUC":{}}')):b.send('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})}d&&
c._cloudConnect&&c._cloudConnect.init(c);e&&b.send('{"XC_SUC": {}}')});this._app.get("/getKey",function(a,b){a=require("x.hub.v5.js");var c={XC_SUC:{}};localStorage.getItem("x.hub.v5.cloudKey")&&(c.XC_SUC.cloud=localStorage.getItem("x.hub.v5.cloudKey"));a.getPublicKey(function(a){c.XC_SUC.key=a;b.end(JSON.stringify(c))})});this._app.get("/peripheral",function(a,b){require("x.hub.peripheralman.js").getUSBDevicesShortInfo(function(a){a?a.error?b.end(JSON.stringify({XC_ERR:{code:"000001",msg:a.error}})):
a.data?b.end(JSON.stringify({XC_SUC:a.data})):b.end(JSON.stringify({XC_ERR:{code:"000001",msg:"get peripheral internal error"}})):b.end(JSON.stringify({XC_ERR:{code:"000001",msg:"get peripheral internal error"}}))})});this._hmPort?this._app.get("/hmtest",function(a,b){c._doHMTestRequest(a.query,b)}):"A20"==this.hostType&&this._app.get("/hmtest",function(a,b){require("x.hub.v5.js").Native.checkHMSerial(function(a){"OK"==a?b.send('{"XC_SUC":{}}'):b.send('{"XC_ERR":{"msg":"'+a+'"}}')})});this._app.get("/update",
function(a,b){var d=c._getServerFromReq(a),k="80",g=null;a.query.port&&(k=a.query.port);a.query.url&&(g=a.query.url);a.query.server&&(d=a.query.server);d&&k&&g?"A20"==c.hostType?require("x.hub.v5.js").Native.updateFirmware(d,k,g,function(a){b.send(a);c.resHasError(a)||c.restart(1E3)}):b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'):b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/updateST",function(a,b){var d=!1,k=c._getServerFromReq(a),g="80",h=null;
a.query.live&&"0"!=a.query.live&&"false"!=a.query.live&&(d=!0);a.query.port&&(g=a.query.port);a.query.url&&(h=a.query.url);a.query.server&&(k=a.query.server);k&&g&&h?"A20"==c.hostType?(a=require("x.hub.v5.js"),d?a.Native.updateSTFirmware(k,g,h,b):a.Native.updateSTFirmware(k,g,h,null,function(a){b.send(a)})):d?b.send("ERROR."):b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'):d?b.send("ERROR."):b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.post("/updateV5PFW",
function(a,b){require("x.hub.v5.js").Native.updateV5PFirmware(a,b,function(a){c.resHasError(a)||c.restart(1E3)})});this._app.get("/backup",function(a,b){var d=require("x.crypt.js"),k=require("x.hub.v5.js");if("A20"==c.hostType&&a.query.native&&"0"!=a.query.native&&"false"!=a.query.native)k.Native.backup(c,b);else{var g=null;a.query.enc&&"0"!=a.query.enc&&"false"!=a.query.enc&&(a.query.at?g=a.query.at:a.query.auth&&(g=d.MD5(unescape(encodeURI(a.query.auth+"_SALT!")))));k.backup(c,b,g)}});this._app.get("/restore",
function(a,b){var d=c._getServerFromReq(a),k="80",g=null;a.query.port&&(k=a.query.port);a.query.url&&(g=a.query.url);if(d&&k&&g){var h=require("x.hub.v5.js");if("A20"==c.hostType&&a.query.native&&"0"!=a.query.native&&"false"!=a.query.native)h.Native.restore(c,"http://"+d+":"+k+g,function(a){b.send(a);c.resHasError(a)||c.restart(1E3)});else{var f=null;a.query.key?f=a.query.key:a.query.at?f=a.query.at:a.query.auth&&(f=crypt.MD5(unescape(encodeURI(a.query.auth+"_SALT!"))));h.restore(c,"http://"+d+":"+
k+g,f,function(a){b.send(a);c.resHasError(a)||c.restart(1E3)})}}else b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/getLogs",function(a,b){a=require("x.hub.v5.js");"A20"==c.hostType?a.getLogs(b):"A1"==c.HWV?a.getNeoServerLogs(b):b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/clearLogs",function(a,b){a=require("x.hub.v5.js");"A20"==c.hostType?a.clearLogs(function(){b.send('{"XC_SUC":{}}')}):b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});
this._app.get("/getPorts",function(a,b){require("x.hub.v5.js").getSerialPorts(function(a){b.send(a)})});this._app.get("/reset",function(a,b){b.send('{"XC_SUC":{}}');c.restart(1E3)});this._app.get("/refurbish",function(a,b){require("x.hub.v5.js").Native.setIPData(c,{DHCP:!0},function(a){a?c._stmUSB.reset(function(){require("x.hub.v5.js").resetST(function(){b.status(200).json({XC_SUC:{}})})}):b.send('{"XC_ERR":{"code":"000000", "msg":"enable dhcp failed"}}')})});this._app.get("/resetST",function(a,
b){c._stmUSB.reset(function(){require("x.hub.v5.js").resetST(function(){b.status(200).json({XC_SUC:{}})})})});this._app.get("/rebootST",function(a,b){c._stmUSB.reset(function(){require("x.hub.v5.js").rebootST(function(){b.status(200).json({XC_SUC:{}})})})});this._app.get("/resetHM",function(a,b){require("x.hub.v5.js").Native.resetHM(function(a){a?(b.status(200).json({XC_SUC:{}}),c.restart(100)):b.status(200).json({XC_ERR:{code:"000000",message:"reset homematic failed"}})})});this._app.get("/resetZwave",
function(a,b){require("x.hub.v5.js").Native.resetZway(function(a){a?(b.status(200).json({XC_SUC:{}}),c.restart(100)):b.status(200).json({XC_ERR:{code:"000000",message:"reset zwave failed"}})})});this._app.get("/resetZigbee",function(a,b){require("x.hub.v5.js").Native.resetZigbee(function(a){a?(b.status(200).json({XC_SUC:{}}),c.restart(100)):b.status(200).json({XC_ERR:{code:"000000",message:"reset zigbee failed"}})})});this._app.get("/resetKNX",function(a,b){require("x.hub.m.knx.js").reset(function(a){a&&
!a.error?b.status(200).json({XC_SUC:{}}):b.status(200).json({XC_ERR:{code:"000000",message:"reset knx failed"}})})});this._app.get("/mountUSB",function(a,b){require("x.hub.v5.js").mountUSB(function(a){a.error?b.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).json({XC_SUC:{}})})});this._app.get("/setBackupUSB",function(a,b){a.query.path?require("x.hub.v5.js").setBackupUsbPath(a.query.path,function(){b.status(200).json({XC_SUC:{}})}):b.status(500).json({XC_ERR:{code:"000000",
msg:"no usb path"}})});this._app.post("/backupDeviceXML",function(a,b){a=a.body;require("x.hub.v5.js").saveDeviceXMLforBackup(a,function(a){a.error?b.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).json({XC_SUC:{}})})});this._app.post("/backupMacrosXML",function(a,b){a=a.body;require("x.hub.v5.js").saveMacrosXMLforBackup(a,function(a){a.error?b.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).json({XC_SUC:{}})})});this._app.post("/backupIrcodesXML",
function(a,b){a=a.body;require("x.hub.v5.js").saveIrcodesXMLforBackup(a,function(a){a.error?b.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).json({XC_SUC:{}})})});this._app.get("/backupLocal",function(a,b){var d=require("x.crypt.js"),k=require("x.hub.v5.js"),g=null;a.query.key&&(g=d.MD5(unescape(encodeURI(a.query.key+"_SALT!"))));k.backupLocal(c,g,function(a){a.error?b.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).json({XC_SUC:{file:a.data}})})});
this._app.get("/unmountUSB",function(a,b){require("x.hub.v5.js").unmountUSB(function(a){a.error?b.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).json({XC_SUC:{}})})});this._app.get("/listUsbBackups",function(a,b){require("x.hub.v5.js").listUsbBackups(function(a){a.error?b.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).json({XC_SUC:a.data})})});this._app.get("/deleteUsbBackup",function(a,b){(a=a.query.file)?require("x.hub.v5.js").deleteBackup(a,
function(a){a.error?b.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).json({XC_SUC:{}})}):b.status(200).json({XC_ERR:{code:"000000",msg:"file name is null"}})});this._app.get("/loadBackup",function(a,b){var c=require("x.hub.v5.js"),d=require("x.crypt.js"),g=a.query.file;if(g){var h=null;a.query.key&&(h=d.MD5(unescape(encodeURI(a.query.key+"_SALT!"))));c.loadBackup(g,h,function(a){a.error?b.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).json({XC_SUC:{}})})}else b.status(200).json({XC_ERR:{code:"000000",
msg:"file name is null"}})});this._app.get("/loadBackupDeviceXML",function(a,b){require("x.hub.v5.js").loadDeviceXML(function(a){a.error?b.status(400).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).end(a.data)})});this._app.get("/loadBackupMacroXML",function(a,b){require("x.hub.v5.js").loadMacroXML(function(a){a.error?b.status(400).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).end(a.data)})});this._app.get("/loadBackupIrcodesXML",function(a,b){require("x.hub.v5.js").loadIrcodesXML(function(a){a.error?
b.status(400).json({XC_ERR:{code:"000000",msg:a.error.message}}):b.status(200).end(a.data)})});this._app.get("/restoreLocal",function(a,b){require("x.hub.v5.js").restoreLocal(c,function(a){a.error?b.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):(b.status(200).json({XC_SUC:{}}),c.restart(1E3))})});this._app.get("/testReadOnly",function(a,b){require("x.hub.v5.js").testReadOnly(function(a){a?b.status(200).json({XC_SUC:{readonly:!0,message:a.message}}):b.status(200).json({XC_SUC:{readonly:!1}})})});
this._app.get("/fixReadOnly",function(a,b){require("x.hub.v5.js").fixReadOnly(b,function(a){a?b.status(200).json({XC_ERR:{code:"01001",message:a.message}}):b.status(200).json({XC_SUC:{}})})});this._app.get("/scan",function(a,b){require("x.hub.v5.js").Native.scanWiFi(function(a,c){if(a)b.send(a.message);else if(c){b.send('{"XC_SUC":'+JSON.stringify(c)+"}");return}b.send('{"XC_ERR":{"msg":"Scanning wifis failed."}}')})});this._app.get("/connect",function(a,b){a.query.ssid&&a.query.pwd?require("x.hub.v5.js").Native.connectWiFi(a.query.ssid,
a.query.pwd,function(a){a?b.send('{"XC_SUC":{}}'):b.send('{"XC_ERR":{"msg":"failed to connect"}}')}):b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/configWLAN",function(a,b){var c={};a.query.ip&&a.query.sn&&a.query.gw&&a.query.dns&&(c.IP=a.query.ip,c.SN=a.query.sn,c.GW=a.query.gw,c.DNS=a.query.dns,c.DHCP=!1);a.query.dhcp&&1==a.query.dhcp&&(c={DHCP:!0});a.query.ntp&&(c.NTP=a.query.ntp);a.query.mac&&(c.MAC=a.query.mac);0<Object.keys(c).length?require("x.hub.v5.js").Native.setWLANData(c,
function(a){a?b.send('{"XC_SUC":{}}'):b.send('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')}):b.send('{"XC_SUC": {}}')});this._app.get("/tm/http",function(a,b){var c=require("x.hub.taskman.js");if(c&&c.taskManager)c.taskManager.onHttpEvt(a.query,function(a,c){a?b.send('{"XC_ERR":{"msg":'+a.message+"}}"):c?b.send('{"XC_SUC":{}}'):b.send('{"XC_ERR":{"msg":"no such trigger"}}')});else b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._dispatcher.init();this._app.get("*",
function(a,b){XC.debugf("INVALID REQ: "+a.url);b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.use(function(a,b,c,d){XC.debugf(a);c.send({XC_ERR:{code:"000001",msg:"exception"}})});this._httpserver.listen(this._port,function(){var a=c._httpserver.address().port;c._logger.log("info","listening on port "+a+"...");d&&d()})};
x.hub.Server.prototype.sendUDPMessage=function(d){this._udpSocket&&(d=new Buffer(d),this._udpSocket.send(d,0,d.length,1901,"239.255.255.250"),this._udpSocket.send(d,0,d.length,1901,"255.255.255.255"))};
x.hub.Server.prototype._startUDPServer=function(d,c){var a=require("dgram"),b=this;try{var e=this._udpSocket=a.createSocket({reuseAddr:!0,type:"udp4"})}catch(k){e=this._udpSocket=a.createSocket("udp4")}e.on("listening",function(){b._logger.log("info","listening on udp port "+d+"...");e.setBroadcast(!0);c&&c()});e.on("message",function(a,c){e.address();if(a&&a.length&&3<=a.length&&71==a[0]&&69==a[1]&&84==a[2]){b._logger.log("trace","receive gateway discovery request");var d=function(a,d){var f="DHCP:"+
(a.DHCP?"TRUE":"FALSE")+"\nHWV:"+b.HWV+"\nVER:"+b.VERSION+"\nVID:"+b._vid+"\nNAME:"+b._name;f+="\nIP:"+a.IP;f+="\nPT:"+a.PT;f+="\nSN:"+a.SN;f+="\nGW:"+a.GW;f+="\nDNS:"+a.DNS;f+="\nMAC:"+a.MAC;d&&(f+="\nTMP_ID:"+d);f+="\n";b._logger.log("trace","send gateway discovery response:"+f);a=new Buffer(f);e.send(a,0,a.length,c.port,c.address);e.send(a,0,a.length,1901,"239.255.255.250");e.send(a,0,a.length,1901,"255.255.255.255")};b.getNetworkSettings(function(a,c){if(!a&&c){a=null;"A20"==b.hostType&&(a=function(){return Math.floor(65536*
(1+Math.random())).toString(16).substr(1)},a=a()+a());for(var e in c)for(var f=0;f<c[e].length;f++)c[e][f].PT=b._port,d(c[e][f],a)}})}else if(a&&a.length&&4<=a.length&&69==a[0]&&86==a[1]&&84==a[2]){var f=a.toString();if(4<f.length){a=null;try{a=JSON.parse(f.substr(4))}catch(l){}a&&(f=require("x.hub.eventbus.js"),f.emit("gatewayevent",a,c,"EVT"))}}else if(a&&a.length&&4<=a.length&&83==a[0]&&84==a[1]&&65==a[2]&&(f=a.toString(),4<f.length)){a=null;try{a=JSON.parse(f.substr(4))}catch(l){}a&&(f=require("x.hub.eventbus.js"),
f.emit("gatewayevent",a,c,"STA"))}});e.on("error",function(a){b._logger.log();XC.debugf("udp port error");e.close()});e.on("close",function(){});e.bind(d)};x.hub.Server.prototype.onUdpEvt=function(d,c){c||(c="EVT");this._logger.log("trace","send "+c+" event:"+JSON.stringify(d));this.sendUDPMessage(c+":"+JSON.stringify(d)+"\r\n")};x.hub.Server.prototype.onStatusEvt=function(d){};
x.hub.Server.prototype.getTimeZone=function(){var d="8C";localStorage&&localStorage.getItem("x.hub.Server.timezone")&&(d=localStorage.getItem("x.hub.Server.timezone"));return d};
x.hub.Server.prototype.setTimeZoneCompatiable=function(d,c){if(!d||isNaN(parseInt(d,16)))c&&c(Error("timezone invalid"));else{d=parseInt(d,16);d=((d>>4&1?-1:1)*(d&15)+11&31|(d>>5&1)<<7).toString(16).toUpperCase();2>d.length&&(d="0"+d);d&&localStorage&&localStorage.setItem("x.hub.Server.timezone",d);var a=localStorage.getItem("x.hub.Server.geo.lat"),b=localStorage.getItem("x.hub.Server.geo.long");require("x.hub.eventbus.js").emit("locationchange",{timezone:d,lat:a,long:b});c&&c()}};
x.hub.Server.prototype.getTimeZoneCompatiable=function(d){var c=this.getTimeZone();c=parseInt(c,16);var a=(c&31)-11;c=((0!=(c&128)?1:0)<<5|(0>a?1:0)<<4|(0<a?a:0-a)).toString(16).toUpperCase();2>c.length&&(c="0"+c);d&&d(null,c)};x.hub.Handler=function(){this.server=null};x.hub.Handler.prototype.Server=x.hub.Server;x.hub.Handler.prototype.getServer=function(){return this.server};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.Handler);
