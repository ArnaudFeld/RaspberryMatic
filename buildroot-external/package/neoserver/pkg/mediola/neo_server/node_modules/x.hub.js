var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(d){var b=0;return function(){return b<d.length?{done:!1,value:d[b++]}:{done:!0}}};$jscomp.arrayIterator=function(d){return{next:$jscomp.arrayIteratorImpl(d)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(d,b,a){d!=Array.prototype&&d!=Object.prototype&&(d[b]=a.value)};$jscomp.getGlobal=function(d){d=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,d];for(var b=0;b<d.length;++b){var a=d[b];if(a&&a.Math==Math)return a}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(d,b){this.$jscomp$symbol$id_=d;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:b})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function d(a){if(this instanceof d)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(a||"")+"_"+b++,a)}var b=0;return d}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var d=$jscomp.global.Symbol.iterator;d||(d=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[d]&&$jscomp.defineProperty(Array.prototype,d,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var d=$jscomp.global.Symbol.asyncIterator;d||(d=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(d){$jscomp.initSymbolIterator();d={next:d};d[$jscomp.global.Symbol.iterator]=function(){return this};return d};
$jscomp.iteratorFromArray=function(d,b){$jscomp.initSymbolIterator();d instanceof String&&(d+="");var a=0,c={next:function(){if(a<d.length){var e=a++;return{value:b(e,d[e]),done:!1}}c.next=function(){return{done:!0,value:void 0}};return c.next()}};c[Symbol.iterator]=function(){return c};return c};
$jscomp.polyfill=function(d,b,a,c){if(b){a=$jscomp.global;d=d.split(".");for(c=0;c<d.length-1;c++){var e=d[c];e in a||(a[e]={});a=a[e]}d=d[d.length-1];c=a[d];b=b(c);b!=c&&null!=b&&$jscomp.defineProperty(a,d,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.keys",function(d){return d?d:function(){return $jscomp.iteratorFromArray(this,function(b){return b})}},"es6","es3");require("x.core.js");var x=x||{};x.hub=x.hub||{};
x.hub.Dispatcher=function(){var d=function(b){this._expressApp=b;this._routes=[]};d.prototype.add=function(b,a,c){if(!b||!c)throw Error("invalid arguments");this._routes.push({path:b,opts:a,callback:c})};d.prototype.doRequest=function(b,a,c,e){var d=this,f=function(a,c,b,h){d._findRoute(a,c,function(a,d){a?a.callback(b,h,function(){f(d+1,c,b,h)}):e()})};f(0,b,a,c)};d.prototype._findRoute=function(b,a,c){for(;b<this._routes.length;b++){var e=this._routes[b];if(e&&0==e.path.indexOf(a)){c(e,b);return}}c(null,
-1)};d.prototype.init=function(){var b=this;this._expressApp.use("/",function(a,c,e){b.doRequest(a.path,a,c,e)})};return d}();
x.hub.Auth=function(){var d=function(){};d.prototype.auth=function(b,a){if(!a||!a.pwd)return!0;if(!b.query.at&&b.query.auth){var c=require("x.crypt.js");b.query.at=c.MD5(unescape(encodeURI(b.query.auth+"_SALT!")))}return b.query.at&&b.query.at==a.pwd?!0:b.headers&&b.headers.authorization?this._checkAuthHeader(b.headers.authorization,a):!1};d.prototype._checkAuthHeader=function(b,a){return b&&"Basic "==b.substr(0,6)?(b=b.substr(6).trim(),(b=(new Buffer(b,"base64")).toString().split(":")[1])?require("x.crypt.js").MD5(unescape(encodeURI(b+
"_SALT!")))==a.pwd:!1):!1};return d}();
x.hub.Server=function(d,b,a){this._logger=require("x.logger.js").getLogger("x.hub.Server");this.HWV="EB";this.VERSION="0.0.0";this.DEFAULT_NAME="XHUB";this.VID="FFFF";this.hostType="A20";this._port=null;this._stmPort=d;this._hmPort=b;this._signalPin=a;this._cloudConnect=this._hmSerial=this._stmUSB=null;this._pwd="";this._onCustomSerialEvent=this._onSerialEvent=null;this._app=require("express")();this._dispatcher=new x.hub.Dispatcher(this._app);this._httpserver=require("http").createServer(this._app);
this._commandFunctions={};this._cmdFunctions={};this._logger={log:function(){}};try{var c=require("x.logger.js");c&&(this._logger=c.getLogger("x.hub.Server"));var e=require("x.hub.eventbus.js");e&&(e.on("udpevent",this.onUdpEvt.bind(this)),e.on("status",this.onStatusEvt.bind(this)))}catch(h){}localStorage&&(localStorage.getItem("x.hub.Server.timezone")||localStorage.setItem("x.hub.Server.timezone","8C"),localStorage.getItem("x.hub.Server.geo.lat")||localStorage.setItem("x.hub.Server.geo.lat","1392"),
localStorage.getItem("x.hub.Server.geo.long")||localStorage.setItem("x.hub.Server.geo.long","035C"),localStorage.getItem("x.hub.Server.pwd")&&(this._pwd=localStorage.getItem("x.hub.Server.pwd")));this._auth=new x.hub.Auth};x.hub.Server.prototype.auth=function(d){return this._auth.auth(d,{pwd:this._pwd})};
x.hub.Server.prototype.getNetworkSettings=function(d){if("A20"==this.hostType)require("x.hub.v5.js").Native.getIPData(function(a){d&&d(null,a)});else{var b={},a=require("os");if(a&&a.networkInterfaces){a=a.networkInterfaces();for(var c in a){b[c]||(b[c]=[]);for(var e=a[c],h=0;h<e.length;h++)if("IPv4"==e[h].family&&!1===e[h].internal){var f=this._getIPData(e[h]);b[c].push(f)}}}d&&d(null,b)}};
x.hub.Server.prototype._getIPData=function(d){var b={};b.IP=d.address;b.PT=this._port;b.SN="255.255.255.0";d.netmask&&(b.SN=d.netmask);b.GW="0.0.0.0";var a=null;try{a=require("netroute")}catch(e){}if(a&&(a=a.getInfo())&&a.IPv4)for(var c=0;c<a.IPv4.length;c++)if("0.0.0.0"==a.IPv4[c].destination){b.GW=a.IPv4[c].gateway;break}b.DNS="0.0.0.0";(a=require("dns"))&&a.getServers&&(a=a.getServers())&&0<a.length&&(b.DNS=a[0]);b.MAC="00-00-00-00-00-00";d.mac&&(b.MAC=d.mac.replace(/:/g,"-"));return b};
x.hub.Server.prototype.addRoute=function(d,b,a){"function"==typeof b&&(a=b,b=null);return this._dispatcher.add(d,b,a)};
x.hub.Server.prototype.start=function(d){this._port=d;this._name=this.DEFAULT_NAME;localStorage&&localStorage.getItem("x.hub.Server.name")&&(this._name=localStorage.getItem("x.hub.Server.name"));this._vid=this.VID;localStorage&&localStorage.getItem("x.hub.Server.vid")&&(this._vid=localStorage.getItem("x.hub.Server.vid"));this._startup=Math.round((new Date).getTime()/1E3);this._startServer();this._startUDPServer(1901);if(this._stmPort){var b=this;this._stmUSB=new (require("x.hub.v5.js").USBSerial)(this._stmPort,
this._signalPin);this._stmUSB.on("data",function(a){if(a&&a.type&&a.data)if(80==a.type&&b._onSerialEvent){a=a.data.toString();var c=null;8<a.length&&"{XC_EVT}"==a.substr(0,8)?(a=a.substr(8),c="EVT"):4<a.length&&"EVT:"==a.substr(0,4)?(a=a.substr(4),c="EVT"):4<a.length&&"STA:"==a.substr(0,4)&&(a=a.substr(4),c="STA");b._onSerialEvent(a,c)}else 82==a.type&&b._onCustomSerialEvent&&b._onCustomSerialEvent(a.data)})}};
x.hub.Server.prototype.startSTM=function(d){if(this._stmPort){var b=this;this._stmUSB=new (require("x.hub.v5.js").USBSerial)(this._stmPort,this._signalPin,d);this._stmUSB.on("data",function(a){if(a&&a.type&&a.data)if(80==a.type&&b._onSerialEvent){a=a.data.toString();var c=null;8<a.length&&"{XC_EVT}"==a.substr(0,8)?(a=a.substr(8),c="EVT"):4<a.length&&"EVT:"==a.substr(0,4)?(a=a.substr(4),c="EVT"):4<a.length&&"STA:"==a.substr(0,4)&&(a=a.substr(4),c="STA");b._onSerialEvent(a,c)}else 82==a.type&&b._onCustomSerialEvent&&
b._onCustomSerialEvent(a.data)})}};
x.hub.Server.prototype.startWebserver=function(d,b){this._port=d;this._name=this.DEFAULT_NAME;localStorage&&localStorage.getItem("x.hub.Server.name")&&(this._name=localStorage.getItem("x.hub.Server.name"));this._vid=this.VID;localStorage&&localStorage.getItem("x.hub.Server.vid")&&(this._vid=localStorage.getItem("x.hub.Server.vid"));this._startup=Math.round((new Date).getTime()/1E3);var a=0;this._startServer(function(){console.log("************* ++++++++++++++++++ **************");console.log("************* http server started **************");
console.log("************* ++++++++++++++++++ **************");a++;2==a&&b&&b()});this._startUDPServer(1901,function(){console.log("************* ++++++++++++++++++ **************");console.log("************* upd server started **************");console.log("************* ++++++++++++++++++ **************");a++;2==a&&b&&b()})};x.hub.Server.prototype.on=function(d,b){"serialevent"==d?this._onSerialEvent=b:"customserialevent"==d&&(this._onCustomSerialEvent=b)};
x.hub.Server.prototype._getServerFromReq=function(d){if(d.query.server)return d.query.server;var b=null;d.ip?b=d.ip:d.connection.remoteAddress&&(b=d.connection.remoteAddress);b&&-1<b.indexOf(":")&&b.indexOf(".")>b.indexOf(":")?b=b.substr(b.lastIndexOf(":")+1):"::1"==b&&(b="localhost");return b};x.hub.Server.prototype.enableCloudConnect=function(d){this._cloudConnect=d;d.init(this)};
x.hub.Server.prototype.restart=function(d){XC.debugf("RESTART!");var b=this;setTimeout(function(){"A20"==b.hostType?require("x.hub.v5.js").Native.reboot():process.exit(0)},d)};x.hub.Server.prototype.resHasError=function(d){var b=null;try{b=JSON.parse(d)}catch(a){b=null}return b&&b.XC_ERR?!0:!1};
x.hub.Server.prototype._doSTMCommandRequest=function(d,b,a){this._stmUSB&&d&&-1<d.indexOf("?")?(d=d.substr(d.indexOf("?")+1),this._stmUSB.sendCommand(16,d,function(c){c&&c.data?XC.debugf(d+" --\x3e "+c.data.toString()):c&&c.error?XC.debugf(d+" --\x3e FAIL:"+c.error):XC.debugf(d+" --\x3e FAIL");if(c&&c.data){var e="XC_SUC";c.error&&(e="XC_ERR");b?a("{"+e+"}"+c.data.toString()):a('{"'+e+'": '+c.data.toString()+"}")}else b?a("{XC_ERR}internal error"):c&&c.error?a(JSON.stringify({XC_ERR:{code:"000000",
msg:c.error}})):a('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})):b?a("{XC_ERR}invalid request"):a('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')};x.hub.Server.prototype.doSTMCommand=function(d,b){this._doSTMCommandRequest("/cmd?"+d,!1,function(a){var c=null;try{c=JSON.parse(a)}catch(e){c=null}b&&b(c)})};x.hub.Server.prototype.doSTMRequest=function(d,b,a){this._stmUSB?this._stmUSB.sendCommand(d,b,function(c){c?c.error?a(null):a(c.data):a(null)}):a(null)};
x.hub.Server.prototype.setCommandFunc=function(d,b){this._commandFunctions[d.toLowerCase()]=b};x.hub.Server.prototype.setCmdFunc=function(d,b){this._cmdFunctions[d.toLowerCase()]=b};
x.hub.Server.prototype.doRequest=function(d,b,a){var c=require("os");if("/"==d){var e='<!DOCTYPE html>\n<html>\n<head>\n<meta http-equiv="content-type" content="text/html; charset=utf-8" />\n<title>'+(String(this._name).replace(/</g,"&lt;").replace(/>/g,"&gt;")+'</title>\n<script>function setHMconfigRef() {var hmconfig = document.getElementById("hmconfig"); if(hmconfig){hmconfig.href = window.location.protocol + "//" + window.location.hostname + ":81/";}}\x3c/script>\n');e=e+'</head>\n<body style="background-color: #FFFFFF; font-family: Helvetica, Arial, sans-serif;" onload="setHMconfigRef()">\n<table style="border-radius: 0px 0px 8px 8px; border: 1px #999 solid; -moz-box-shadow: 0px 5px 8px #888; -webkit-box-shadow: 2px 5px 8px #888; box-shadow: 0px 5px 8px #888; position: absolute; height: 220px; width: 420px; margin: -110px 0px 0px -210px; top: 50%; left: 50%; color: #777; background-color: #fafafa; font-size: 15px;" border="0" cellspacing="0">\n<tbody>\n<tr style="height: 48px; background-color: #666; color: #FFFFFF; font-size: 20px;"><th colspan="3">'+
(this._name+"</th>\n");e=e+'</tr>\n<tr style="height: 28px;"><td style="width: 70px;">&nbsp;</td><td style="width: 150px;">&nbsp;</td><td>&nbsp;</td></tr>\n<tr style="height: 30px;"><td>&nbsp;</td><td>device:</td><td><b>'+(this.DEFAULT_NAME+"</b></td></tr>\n");e+='<tr style="height: 30px;"><td>&nbsp;</td><td>version:</td><td><b>'+this.HWV+" ("+this.VERSION+")</b></td></tr>\n";var h=Math.round((new Date).getTime()/1E3)-this._startup,f=Math.floor(h/86400);h-=86400*f;d=Math.floor(h/3600);h-=3600*d;var g=
Math.floor(h/60);e+='<tr style="height: 30px;"><td>&nbsp;</td><td>uptime:</td><td><b>'+f+"d "+d+"h "+g+"m "+(h-60*g)+"s</b></td></tr>\n";c&&c.freemem&&(e+='<tr style="height: 30px;"><td>&nbsp;</td><td>memory:</td><td><b>'+Math.floor(c.freemem()/1E3)+"</b></td></tr>\n");a(e+'<tr style="height: 0px;"><td colspan="3">&nbsp;</td></tr>\n<tr style="height: 32px;"><td colspan="3" style="font-size: 13px; text-align: center;">&copy;&nbsp;2018 mediola - connected living AG</td></tr>\n</tbody>\n</table>\n</body>\n</html>')}else if("/info"==
d){var k={XC_SUC:{name:this._name,mhv:"XH I-"+this.hostType,msv:this.VERSION,hwv:this.HWV,vid:this._vid,start:this._startup,time:Math.round((new Date).getTime()/1E3)}};d="8C";g="1392";var l="035C";localStorage.getItem("x.hub.Server.timezone")&&(d=localStorage.getItem("x.hub.Server.timezone"));localStorage.getItem("x.hub.Server.geo.lat")&&(g=localStorage.getItem("x.hub.Server.geo.lat"));localStorage.getItem("x.hub.Server.geo.long")&&(l=localStorage.getItem("x.hub.Server.geo.long"));k.XC_SUC.loc=(d+
g+l).toUpperCase();localStorage.getItem("x.hub.v5.config")&&(k.XC_SUC.cfg=localStorage.getItem("x.hub.v5.config"));localStorage.getItem("x.hub.v5.cloudServer")&&localStorage.getItem("x.hub.v5.cloudPort")?k.XC_SUC.server=localStorage.getItem("x.hub.v5.cloudServer")+":"+localStorage.getItem("x.hub.v5.cloudPort"):(d=require("x.hub.v5.js").CloudConnect,k.XC_SUC.server=d.prototype.CLOUD_SERVER+":"+d.prototype.CLOUD_SERVER_PORT);localStorage.getItem("x.hub.v5.SID")&&(k.XC_SUC.sid=localStorage.getItem("x.hub.v5.SID"));
localStorage.getItem("x.hub.taskman.NEO_SERVER")&&(k.XC_SUC.neoserver=localStorage.getItem("x.hub.taskman.NEO_SERVER"));localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE")&&(k.XC_SUC.ccu_init_state=localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE"));localStorage.getItem("x.hub.Server.DISABLE_ST_STATES")&&(k.XC_SUC.disable_st_states=localStorage.getItem("x.hub.Server.DISABLE_ST_STATES"));c&&c.freemem&&(k.XC_SUC.mem=Math.floor(c.freemem()/1E3));try{global.LOAD_MODULES&&-1!=global.LOAD_MODULES.indexOf("enocean")&&
(h=require("x.hub.m.enocean.js"))&&(f=h.getEnoceanInfo(),k.XC_SUC.enocean=f)}catch(q){}if("A20"==this.hostType){k.XC_SUC.SAFE_MODE=global.SAFE_MODE;e=require("x.hub.v5.js");var n=function(a){return{ip:a.IP,sn:a.SN,gw:a.GW,dhcp:a.DHCP,dns:a.DNS,mac:a.MAC,ntp:a.NTP}};e.Native.getIPData(function(c){var b=null,e=null;Array.isArray(c.eth0)&&(b=n(c.eth0[0]));Array.isArray(c.wlan0)&&(e=n(c.wlan0[0]));c=b||e;for(var d in c)k.XC_SUC[d]=c[d];k.XC_SUC.primary_net=c===b?"eth0":"wlan0";k.XC_SUC.cfg&&c&&(b=parseInt(k.XC_SUC.cfg,
16),b=!0===c.dhcp?b&-129:b|128,k.XC_SUC.cfg=b.toString(16),2>k.XC_SUC.cfg.length&&(k.XC_SUC.cfg="0"+k.XC_SUC.cfg),k.XC_SUC.cfg=k.XC_SUC.cfg.toUpperCase());c!=e&&e&&(k.XC_SUC.wlan0=e);a(JSON.stringify(k))})}else if("CA"!=this.HWV&&(require("dgram"),c&&c.networkInterfaces)){c=c.networkInterfaces();for(e in c)if(c.hasOwnProperty(e))for(h=c[e],f=0;f<h.length;f++)"IPv4"==h[f].family&&!1===h[f].internal&&(d=this._getIPData(h[f]),g=null,b&&b.headers&&b.headers.host&&(g=b.headers.host,l=g.indexOf(":"),-1!=
l&&(g=g.substr(0,l))),!g||g!=d.IP&&"localhost"!=g&&"127.0.0.1"!=g||(k.XC_SUC.ip=d.IP,k.XC_SUC.sn=d.SN,k.XC_SUC.gw=d.GW,k.XC_SUC.dns=d.DNS,k.XC_SUC.mac=d.MAC));a(JSON.stringify(k))}}else if("/set"==d)b.query.rgb&&6==b.query.rgb.length&&(e=require("x.hub.v5.js"),e.setRGBColor(b.query.rgb)),a('{"XC_SUC": {}}');else if("/cmd"==d)if((e=b.query.XC_FNC)&&this._cmdFunctions[e.toLowerCase()]){var p=this;this._cmdFunctions[e.toLowerCase()](b,function(c){c?a(c):"POST"==b.method?p._doSTMCommandRequest(b,!1,a):
p._doSTMCommandRequest(b.url,!1,a)})}else"POST"==b.method?this._doSTMCommandRequest(b,!1,a):this._doSTMCommandRequest(b.url,!1,a);else if("/executeCommand"==d)e=require("x.logger.js").getLogger("GeneralExecuteCommand API"),e.log("trace","general execute command:"+JSON.stringify(b.query)),b.query&&b.query.data?(c=b.query.type,e=b.query.data,e.device&&!e.device.sys&&(e.device.sys=c),e.gateway&&!e.gateway.sys&&(e.gateway.sys=c),c=require("x.hub.commandman.js"),c.commandHandler.executeCommand(e.device,
e.gateway,e.command,function(c){c.error?a('{"XC_ERR":{"code":"000000","msg":"'+c.error.message+'"}}'):a('{"XC_SUC":{}}')})):a('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/getStates"==d)e=require("x.logger.js").getLogger("GeneralGetStates API"),e.log("trace","general get states:"+JSON.stringify(b.query)),b.query&&b.query.data?(c=b.query.type,e=b.query.data,e.device&&!e.device.sys&&(e.device.sys=c),e.gateway&&!e.gateway.sys&&(e.gateway.sys=c),c=require("x.hub.commandman.js"),e.deviceList?
c.commandHandler.getMultiStatesLegacy(e.device,e.gateway,e.deviceList,function(c){c.error?a('{"XC_ERR":{"code":"000000","msg":"'+c.error.message+'"}}'):c&&c.data?a(JSON.stringify({XC_SUC:{data:JSON.stringify(c.data)}})):a('{"XC_SUC":{}}')}):c.commandHandler.getState(e.device,e.gateway,e.status,function(c){c.error?a('{"XC_ERR":{"code":"000000","msg":"'+c.error.message+'"}}'):c&&c.data?a(JSON.stringify({XC_SUC:{data:JSON.stringify(c.data)}})):a('{"XC_SUC":{}}')})):a('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');
else{var m=a;e={json:function(a){m&&(m(JSON.stringify(a)),m=null)},send:function(a){m&&(m(a),m=null)},status:function(){},end:function(){m&&(m(),m=null)}};this._dispatcher.doRequest(d,b,e,function(){m&&(m('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'),m=null)})}};
x.hub.Server.prototype._preHandleRequest=function(d,b,a){if("POST"==d.method&&"application/octet-stream"!=d.header("content-type"))if(d.json){if(d.query&&0<Object.keys(d.query).length&&this.auth(d)){d.query=d.json;a();return}d.query=d.json}else if("text/plain"!=d.header("content-type")&&"text/xml"!=d.header("content-type")&&"application/xml"!=d.header("content-type")){b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');return}this.auth(d)?a():b.send('{"XC_ERR":{"code":"000007", "msg":"access denied"}}')};
x.hub.Server.prototype._startServer=function(d){this._app.set("case sensitive routing",!0);var b=this;this._app.use(function(a,c,e){c.header("Access-Control-Allow-Origin","*");c.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Authorization");require("x.logger.js").getLogger("x.hub.Server.Access").log("debug","REQ:"+a.url);if("/"==a.url)b.doRequest("/",{query:{}},function(a){c.send(a)});else if("POST"==a.method&&"application/octet-stream"!=a.header("content-type")){var d=
new Buffer([]);a.on("data",function(a){d=Buffer.concat([d,a])});a.on("end",function(){a.body=d.toString("utf8");a.json=null;try{a.json=JSON.parse(d)}catch(f){}b._preHandleRequest(a,c,e)})}else b._preHandleRequest(a,c,e)});this._app.get("/info",function(a,c){try{b.doRequest("/info",a,function(a){c.send(a)})}catch(e){console.error(e)}});this._app.get("/set",function(a,c){b.doRequest("/set",a,function(a){c.send(a)})});this._app.get("/cmd",function(a,c){b.doRequest("/cmd",a,function(a){c.send(a)})});
this._app.post("/cmd",function(a,c){b.doRequest("/cmd",a,function(a){c.send(a)})});this._app.get("/command",function(a,c){XC.debugf("command: "+a.url);var e=a.query.XC_FNC;if(e&&b._commandFunctions[e.toLowerCase()])b._commandFunctions[e.toLowerCase()](a,c);else b._doSTMCommandRequest(a.url,!0,function(a){c.send(a)})});this._app.post("/executeCommand",function(a,c){b.doRequest("/executeCommand",a,function(a){c.send(a)})});this._app.post("/getStates",function(a,c){b.doRequest("/getStates",a,function(a){c.send(a)})});
this._app.get("/config",function(a,c){var e=!0,d=!1;a.query.name&&0<a.query.name.length&&(b._name=a.query.name,localStorage&&localStorage.setItem("x.hub.Server.name",a.query.name));a.query.vid&&0<a.query.vid.length&&(b._vid=a.query.vid,localStorage&&localStorage.setItem("x.hub.Server.vid",a.query.vid));if(a.query.pwd||""==a.query.pwd)d=require("x.crypt.js"),0===a.query.pwd.length?(b._pwd="",a.query.cloud=0):b._pwd=d.MD5(unescape(encodeURI(a.query.pwd+"_SALT!"))),localStorage&&localStorage.setItem("x.hub.Server.pwd",
b._pwd),d=!0;if(a.query.loc){if(2==a.query.loc.length)var f=a.query.loc;else if(8==a.query.loc.length){var g=a.query.loc.substr(0,4);var k=a.query.loc.substr(4)}else 10==a.query.loc.length&&(f=a.query.loc.substr(0,2),g=a.query.loc.substr(2,4),k=a.query.loc.substr(6));f&&localStorage&&localStorage.setItem("x.hub.Server.timezone",f);g&&localStorage&&localStorage.setItem("x.hub.Server.geo.lat",g);k&&localStorage&&localStorage.setItem("x.hub.Server.geo.long",k);if("CA"==b.HWV){e=!1;var l=require("x.hub.v6.js");
l.setTZData(f,function(a){a?c.json({XC_ERR:{code:"000000",msg:a.message}}):c.json({XC_SUC:{}})})}l=require("x.hub.eventbus.js");l.emit("locationchange",{timezone:f,lat:g,long:k})}a.query.neoserver&&localStorage&&(localStorage.setItem("x.hub.taskman.NEO_SERVER",a.query.neoserver),l=require("x.hub.eventbus.js"),l.emit("neoserver_activation",a.query.neoserver));a.query.ccu_init_state&&localStorage&&(localStorage.setItem("x.hub.m.hm.CCU_INIT_STATE",a.query.ccu_init_state),l=require("x.hub.eventbus.js"),
l.emit("x.hub.m.hm.CCU_INIT_STATE",a.query.ccu_init_state));a.query.disable_st_states&&localStorage&&localStorage.setItem("x.hub.Server.DISABLE_ST_STATES",a.query.disable_st_states);if("A20"==b.hostType||"CA"==b.HWV)g={},a.query.ip&&a.query.sn&&a.query.gw&&a.query.dns&&(g.IP=a.query.ip,g.SN=a.query.sn,g.GW=a.query.gw,g.DNS=a.query.dns,g.DHCP=!1),a.query.dhcp&&1==a.query.dhcp&&(g={DHCP:!0}),a.query.ntp&&(g.NTP=a.query.ntp),a.query.mac&&(g.MAC=a.query.mac),0<Object.keys(g).length&&("EA"==b.HWV?(e=!1,
f=require("x.hub.v5.js"),f.Native.setIPData(b,g,function(a){a?(c.send('{"XC_SUC":{}}'),b.restart(1E3)):c.send('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})):"CA"==b.HWV&&(e=!1,l=require("x.hub.v6.js"),l.setIPData(g,function(a,e){a?c.json({XC_ERR:{code:"000000",msg:a.message}}):(c.json({XC_SUC:{}}),e&&b.restart(1E3))})));a.query.sid&&localStorage&&(localStorage.setItem("x.hub.v5.SID",a.query.sid),d=!0);a.query.ckey&&localStorage&&(localStorage.setItem("x.hub.v5.cloudKey",a.query.ckey),
d=!0);a.query.cserver&&localStorage&&(localStorage.setItem("x.hub.v5.cloudServer",a.query.cserver),d=!0);a.query.cport&&localStorage&&(localStorage.setItem("x.hub.v5.cloudPort",a.query.cport),d=!0);a.query.cloud&&localStorage&&(d=255,localStorage.getItem("x.hub.v5.config")&&(d=parseInt(localStorage.getItem("x.hub.v5.config"),16)),d=1==a.query.cloud?d&-65:d|64,d=d.toString(16),2>d.length&&(d="0"+d),localStorage.setItem("x.hub.v5.config",d.toUpperCase()),d=!0);if("A20"==b.hostType&&a.query.year&&a.query.month&&
a.query.date&&a.query.hour&&a.query.minute){e=!1;g=parseInt(a.query.year);k=parseInt(a.query.month);l=parseInt(a.query.date);var n=parseInt(a.query.hour);a=parseInt(a.query.minute);if(isNaN(g)||1970>g||9999<g){c.send('{"XC_ERR":{"code":"000000", "msg":"year invalid"}}');return}if(isNaN(k)||1>k||12<k){c.send('{"XC_ERR":{"code":"000000", "msg":"month invalid"}}');return}if(isNaN(l)||1>l||31<l){c.send('{"XC_ERR":{"code":"000000", "date":"year invalid"}}');return}if(isNaN(n)||0>n||23<n){c.send('{"XC_ERR":{"code":"000000", "date":"hour invalid"}}');
return}if(isNaN(a)||0>a||59<a){c.send('{"XC_ERR":{"code":"000000", "date":"minute invalid"}}');return}f=require("x.hub.v5.js");f.Native.setDateTime(g,k,l,n,a,function(a){a?(require("x.hub.eventbus.js").emit("timechange",{}),c.send('{"XC_SUC":{}}')):c.send('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})}d&&b._cloudConnect&&b._cloudConnect.init(b);e&&c.send('{"XC_SUC": {}}')});this._app.get("/getKey",function(a,c){a=require("x.hub.v5.js");var b={XC_SUC:{}};localStorage.getItem("x.hub.v5.cloudKey")&&
(b.XC_SUC.cloud=localStorage.getItem("x.hub.v5.cloudKey"));a.getPublicKey(function(a){b.XC_SUC.key=a;c.end(JSON.stringify(b))})});this._app.get("/peripheral",function(a,c){require("x.hub.peripheralman.js").getUSBDevicesShortInfo(function(a){a?a.error?c.end(JSON.stringify({XC_ERR:{code:"000001",msg:a.error}})):a.data?c.end(JSON.stringify({XC_SUC:a.data})):c.end(JSON.stringify({XC_ERR:{code:"000001",msg:"get peripheral internal error"}})):c.end(JSON.stringify({XC_ERR:{code:"000001",msg:"get peripheral internal error"}}))})});
this._hmPort?this._app.get("/hmtest",function(a,c){b._doHMTestRequest(a.query,c)}):"A20"==this.hostType&&this._app.get("/hmtest",function(a,c){require("x.hub.v5.js").Native.checkHMSerial(function(a){"OK"==a?c.send('{"XC_SUC":{}}'):c.send('{"XC_ERR":{"msg":"'+a+'"}}')})});this._app.get("/update",function(a,c){var e=b._getServerFromReq(a),d="80",f=null;a.query.port&&(d=a.query.port);a.query.url&&(f=a.query.url);a.query.server&&(e=a.query.server);e&&d&&f?"A20"==b.hostType?require("x.hub.v5.js").Native.updateFirmware(e,
d,f,function(a){c.send(a);b.resHasError(a)||b.restart(1E3)}):c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'):c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/updateST",function(a,c){if("CA"==global.HARDWARE_VERSION)b._platform.updateSTM(null,c,function(){});else{var e=!1,d=b._getServerFromReq(a),f="80",g=null;a.query.live&&"0"!=a.query.live&&"false"!=a.query.live&&(e=!0);a.query.port&&(f=a.query.port);a.query.url&&(g=a.query.url);a.query.server&&(d=
a.query.server);d&&f&&g?"A20"==b.hostType?(a=require("x.hub.v5.js"),e?a.Native.updateSTFirmware(d,f,g,c):a.Native.updateSTFirmware(d,f,g,null,function(a){c.send(a)})):e?c.send("ERROR."):c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'):e?c.send("ERROR."):c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')}});this._app.post("/updateST",function(a,c){"CA"==global.HARDWARE_VERSION?b._platform.updateSTM(a,c,function(){}):c.json({XC_ERR:{code:"000001",msg:"invalid request"}})});
this._app.post("/updateV5PFW",function(a,c){require("x.hub.v5.js").Native.updateV5PFirmware(a,c,function(a){b.resHasError(a)||b.restart(1E3)})});this._app.get("/backup",function(a,c){var e=require("x.crypt.js"),d=require("x.hub.v5.js");if("A20"==b.hostType&&a.query.native&&"0"!=a.query.native&&"false"!=a.query.native)d.Native.backup(b,c);else{var f=null;a.query.enc&&"0"!=a.query.enc&&"false"!=a.query.enc&&(a.query.at?f=a.query.at:a.query.auth&&(f=e.MD5(unescape(encodeURI(a.query.auth+"_SALT!")))));
d.backup(b,c,f)}});this._app.get("/restore",function(a,c){var e=b._getServerFromReq(a),d="80",f=null;a.query.port&&(d=a.query.port);a.query.url&&(f=a.query.url);if(e&&d&&f){var g=require("x.hub.v5.js");if("A20"==b.hostType&&a.query.native&&"0"!=a.query.native&&"false"!=a.query.native)g.Native.restore(b,"http://"+e+":"+d+f,function(a){c.send(a);b.resHasError(a)||b.restart(1E3)});else{var k=null;a.query.key?k=a.query.key:a.query.at?k=a.query.at:a.query.auth&&(k=crypt.MD5(unescape(encodeURI(a.query.auth+
"_SALT!"))));g.restore(b,"http://"+e+":"+d+f,k,function(a){c.send(a);b.resHasError(a)||b.restart(1E3)})}}else c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/getLogs",function(a,c){a=require("x.hub.v5.js");"A20"==b.hostType?a.getLogs(c):"A1"==b.HWV?a.getNeoServerLogs(c):c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/clearLogs",function(a,c){a=require("x.hub.v5.js");"A20"==b.hostType?a.clearLogs(function(){c.send('{"XC_SUC":{}}')}):
c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/getPorts",function(a,c){require("x.hub.v5.js").getSerialPorts(function(a){c.send(a)})});this._app.get("/reset",function(a,c){c.send('{"XC_SUC":{}}');b.restart(1E3)});this._app.get("/refurbish",function(a,c){require("x.hub.v5.js").Native.setIPData(b,{DHCP:!0},function(a){a?b._stmUSB.reset(function(){require("x.hub.v5.js").resetST(function(){c.status(200).json({XC_SUC:{}})})}):c.send('{"XC_ERR":{"code":"000000", "msg":"enable dhcp failed"}}')})});
this._app.get("/resetST",function(a,c){"CA"==global.HARDWARE_VERSION?b._platform._stm.reset(function(a){a?c.json({XC_ERR:{msg:a.message}}):c.json({XC_SUC:{}})}):b._stmUSB.reset(function(){require("x.hub.v5.js").resetST(function(){c.status(200).json({XC_SUC:{}})})})});this._app.get("/rebootST",function(a,c){"CA"==global.HARDWARE_VERSION?b._platform._stm.reboot(function(a){a?c.json({XC_ERR:{msg:a.message}}):c.json({XC_SUC:{}})}):b._stmUSB.reset(function(){require("x.hub.v5.js").rebootST(function(){c.status(200).json({XC_SUC:{}})})})});
this._app.get("/resetHM",function(a,c){require("x.hub.v5.js").Native.resetHM(function(a){a?(c.status(200).json({XC_SUC:{}}),b.restart(100)):c.status(200).json({XC_ERR:{code:"000000",message:"reset homematic failed"}})})});this._app.get("/resetZwave",function(a,c){require("x.hub.v5.js").Native.resetZway(function(a){a?(c.status(200).json({XC_SUC:{}}),b.restart(100)):c.status(200).json({XC_ERR:{code:"000000",message:"reset zwave failed"}})})});this._app.get("/resetZigbee",function(a,c){require("x.hub.v5.js").Native.resetZigbee(function(a){a?
(c.status(200).json({XC_SUC:{}}),b.restart(100)):c.status(200).json({XC_ERR:{code:"000000",message:"reset zigbee failed"}})})});this._app.get("/resetKNX",function(a,c){require("x.hub.m.knx.js").reset(function(a){a&&!a.error?c.status(200).json({XC_SUC:{}}):c.status(200).json({XC_ERR:{code:"000000",message:"reset knx failed"}})})});this._app.get("/mountUSB",function(a,c){require("x.hub.v5.js").mountUSB(function(a){a.error?c.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):c.status(200).json({XC_SUC:{}})})});
this._app.get("/setBackupUSB",function(a,c){a.query.path?require("x.hub.v5.js").setBackupUsbPath(a.query.path,function(){c.status(200).json({XC_SUC:{}})}):c.status(500).json({XC_ERR:{code:"000000",msg:"no usb path"}})});this._app.post("/backupDeviceXML",function(a,c){a=a.body;require("x.hub.v5.js").saveDeviceXMLforBackup(a,function(a){a.error?c.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):c.status(200).json({XC_SUC:{}})})});this._app.post("/backupMacrosXML",function(a,c){a=a.body;
require("x.hub.v5.js").saveMacrosXMLforBackup(a,function(a){a.error?c.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):c.status(200).json({XC_SUC:{}})})});this._app.post("/backupIrcodesXML",function(a,c){a=a.body;require("x.hub.v5.js").saveIrcodesXMLforBackup(a,function(a){a.error?c.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):c.status(200).json({XC_SUC:{}})})});this._app.get("/backupLocal",function(a,c){var d=require("x.crypt.js"),h=require("x.hub.v5.js"),f=null;a.query.key&&
(f=d.MD5(unescape(encodeURI(a.query.key+"_SALT!"))));h.backupLocal(b,f,function(a){a.error?c.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):c.status(200).json({XC_SUC:{file:a.data}})})});this._app.get("/unmountUSB",function(a,c){require("x.hub.v5.js").unmountUSB(function(a){a.error?c.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):c.status(200).json({XC_SUC:{}})})});this._app.get("/listUsbBackups",function(a,c){require("x.hub.v5.js").listUsbBackups(function(a){a.error?
c.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):c.status(200).json({XC_SUC:a.data})})});this._app.get("/deleteUsbBackup",function(a,c){(a=a.query.file)?require("x.hub.v5.js").deleteBackup(a,function(a){a.error?c.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):c.status(200).json({XC_SUC:{}})}):c.status(200).json({XC_ERR:{code:"000000",msg:"file name is null"}})});this._app.get("/loadBackup",function(a,c){var b=require("x.hub.v5.js"),d=require("x.crypt.js"),f=a.query.file;
if(f){var g=null;a.query.key&&(g=d.MD5(unescape(encodeURI(a.query.key+"_SALT!"))));b.loadBackup(f,g,function(a){a.error?c.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):c.status(200).json({XC_SUC:{}})})}else c.status(200).json({XC_ERR:{code:"000000",msg:"file name is null"}})});this._app.get("/loadBackupDeviceXML",function(a,c){require("x.hub.v5.js").loadDeviceXML(function(a){a.error?c.status(400).json({XC_ERR:{code:"000000",msg:a.error.message}}):c.status(200).end(a.data)})});this._app.get("/loadBackupMacroXML",
function(a,c){require("x.hub.v5.js").loadMacroXML(function(a){a.error?c.status(400).json({XC_ERR:{code:"000000",msg:a.error.message}}):c.status(200).end(a.data)})});this._app.get("/loadBackupIrcodesXML",function(a,c){require("x.hub.v5.js").loadIrcodesXML(function(a){a.error?c.status(400).json({XC_ERR:{code:"000000",msg:a.error.message}}):c.status(200).end(a.data)})});this._app.get("/restoreLocal",function(a,c){require("x.hub.v5.js").restoreLocal(b,function(a){a.error?c.status(200).json({XC_ERR:{code:"000000",
msg:a.error.message}}):(c.status(200).json({XC_SUC:{}}),b.restart(1E3))})});this._app.get("/testReadOnly",function(a,c){require("x.hub.v5.js").testReadOnly(function(a){a?c.status(200).json({XC_SUC:{readonly:!0,message:a.message}}):c.status(200).json({XC_SUC:{readonly:!1}})})});this._app.get("/fixReadOnly",function(a,c){require("x.hub.v5.js").fixReadOnly(c,function(a){a?c.status(200).json({XC_ERR:{code:"01001",message:a.message}}):c.status(200).json({XC_SUC:{}})})});this._app.get("/scan",function(a,
c){require("x.hub.v5.js").Native.scanWiFi(function(a,b){if(a)c.send(a.message);else if(b){c.send('{"XC_SUC":'+JSON.stringify(b)+"}");return}c.send('{"XC_ERR":{"msg":"Scanning wifis failed."}}')})});this._app.get("/connect",function(a,c){a.query.ssid&&a.query.pwd?require("x.hub.v5.js").Native.connectWiFi(a.query.ssid,a.query.pwd,function(a){a?c.send('{"XC_SUC":{}}'):c.send('{"XC_ERR":{"msg":"failed to connect"}}')}):c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/configWLAN",
function(a,c){var b={};a.query.ip&&a.query.sn&&a.query.gw&&a.query.dns&&(b.IP=a.query.ip,b.SN=a.query.sn,b.GW=a.query.gw,b.DNS=a.query.dns,b.DHCP=!1);a.query.dhcp&&1==a.query.dhcp&&(b={DHCP:!0});a.query.ntp&&(b.NTP=a.query.ntp);a.query.mac&&(b.MAC=a.query.mac);0<Object.keys(b).length?require("x.hub.v5.js").Native.setWLANData(b,function(a){a?c.send('{"XC_SUC":{}}'):c.send('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')}):c.send('{"XC_SUC": {}}')});this._app.get("/tm/http",function(a,c){var b=
require("x.hub.taskman.js");if(b&&b.taskManager)b.taskManager.onHttpEvt(a.query,function(a,b){a?c.send('{"XC_ERR":{"msg":'+a.message+"}}"):b?c.send('{"XC_SUC":{}}'):c.send('{"XC_ERR":{"msg":"no such trigger"}}')});else c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._dispatcher.init();this._app.get("*",function(a,c){XC.debugf("INVALID REQ: "+a.url);c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.use(function(a,c,b,d){XC.debugf(a);b.send({XC_ERR:{code:"000001",
msg:"exception"}})});this._httpserver.listen(this._port,function(){var a=b._httpserver.address().port;b._logger.log("info","listening on port "+a+"...");d&&d()})};x.hub.Server.prototype.sendUDPMessage=function(d){this._udpSocket&&(d=new Buffer(d),this._udpSocket.send(d,0,d.length,1901,"239.255.255.250"),this._udpSocket.send(d,0,d.length,1901,"255.255.255.255"))};
x.hub.Server.prototype._startUDPServer=function(d,b){var a=require("dgram"),c=this;try{var e=this._udpSocket=a.createSocket({reuseAddr:!0,type:"udp4"})}catch(h){e=this._udpSocket=a.createSocket("udp4")}e.on("listening",function(){c._logger.log("info","listening on udp port "+d+"...");e.setBroadcast(!0);b&&b()});e.on("message",function(a,b){e.address();if(a&&a.length&&3<=a.length&&71==a[0]&&69==a[1]&&84==a[2]){c._logger.log("trace","receive gateway discovery request");var d=function(a,d){var g="DHCP:"+
(a.DHCP?"TRUE":"FALSE")+"\nHWV:"+c.HWV+"\nVER:"+c.VERSION+"\nVID:"+c._vid+"\nNAME:"+c._name;g+="\nIP:"+a.IP;g+="\nPT:"+a.PT;g+="\nSN:"+a.SN;g+="\nGW:"+a.GW;g+="\nDNS:"+a.DNS;g+="\nMAC:"+a.MAC;d&&(g+="\nTMP_ID:"+d);g+="\n";c._logger.log("trace","send gateway discovery response:"+g);a=new Buffer(g);e.send(a,0,a.length,b.port,b.address);e.send(a,0,a.length,1901,"239.255.255.250");e.send(a,0,a.length,1901,"255.255.255.255")};c.getNetworkSettings(function(a,b){if(!a&&b){a=null;"A20"==c.hostType&&(a=function(){return Math.floor(65536*
(1+Math.random())).toString(16).substr(1)},a=a()+a());for(var e in b)for(var g=0;g<b[e].length;g++)b[e][g].PT=c._port,d(b[e][g],a)}})}else if(a&&a.length&&4<=a.length&&69==a[0]&&86==a[1]&&84==a[2]){var f=a.toString();if(4<f.length){a=null;try{a=JSON.parse(f.substr(4))}catch(l){}a&&(f=require("x.hub.eventbus.js"),f.emit("gatewayevent",a,b,"EVT"))}}else if(a&&a.length&&4<=a.length&&83==a[0]&&84==a[1]&&65==a[2]&&(f=a.toString(),4<f.length)){a=null;try{a=JSON.parse(f.substr(4))}catch(l){}a&&(f=require("x.hub.eventbus.js"),
f.emit("gatewayevent",a,b,"STA"))}});e.on("error",function(a){c._logger.log();XC.debugf("udp port error");e.close()});e.on("close",function(){});e.bind(d)};x.hub.Server.prototype.onUdpEvt=function(d,b){b||(b="EVT");this._logger.log("trace","send "+b+" event:"+JSON.stringify(d));this.sendUDPMessage(b+":"+JSON.stringify(d)+"\r\n")};x.hub.Server.prototype.onStatusEvt=function(d){};
x.hub.Server.prototype.getTimeZone=function(){var d="8C";localStorage&&localStorage.getItem("x.hub.Server.timezone")&&(d=localStorage.getItem("x.hub.Server.timezone"));return d};
x.hub.Server.prototype.setTimeZoneCompatiable=function(d,b){if(!d||isNaN(parseInt(d,16)))b&&b(Error("timezone invalid"));else{d=parseInt(d,16);d=((d>>4&1?-1:1)*(d&15)+11&31|(d>>5&1)<<7).toString(16).toUpperCase();2>d.length&&(d="0"+d);d&&localStorage&&localStorage.setItem("x.hub.Server.timezone",d);var a=localStorage.getItem("x.hub.Server.geo.lat"),c=localStorage.getItem("x.hub.Server.geo.long");require("x.hub.eventbus.js").emit("locationchange",{timezone:d,lat:a,long:c});b&&b()}};
x.hub.Server.prototype.getTimeZoneCompatiable=function(d){var b=this.getTimeZone();b=parseInt(b,16);var a=(b&31)-11;b=((0!=(b&128)?1:0)<<5|(0>a?1:0)<<4|(0<a?a:0-a)).toString(16).toUpperCase();2>b.length&&(b="0"+b);d&&d(null,b)};
x.hub.ServerV6=function(){var d=function(b,a,c){x.hub.Server.call(this,b,a,c);this._platform=require("x.hub.v6.js");var d=this;this._platform._stm.on("event",function(a,b){d._onSerialEvent(a,b)})};require("util").inherits(d,x.hub.Server);d.prototype.doRequest=function(b,a,c){if("/info"==b){var d={XC_SUC:{name:this._name,mhv:"XH I-"+this.hostType,msv:this.VERSION,hwv:this.HWV,vid:this._vid,start:this._startup,time:Math.round((new Date).getTime()/1E3)}},h="1392",f="035C";localStorage.getItem("x.hub.Server.geo.lat")&&
(h=localStorage.getItem("x.hub.Server.geo.lat"));localStorage.getItem("x.hub.Server.geo.long")&&(f=localStorage.getItem("x.hub.Server.geo.long"));localStorage.getItem("x.hub.v5.config")&&(d.XC_SUC.cfg=localStorage.getItem("x.hub.v5.config"));localStorage.getItem("x.hub.v5.cloudServer")&&localStorage.getItem("x.hub.v5.cloudPort")?d.XC_SUC.server=localStorage.getItem("x.hub.v5.cloudServer")+":"+localStorage.getItem("x.hub.v5.cloudPort"):(b=require("x.hub.v5.js").CloudConnect,d.XC_SUC.server=b.prototype.CLOUD_SERVER+
":"+b.prototype.CLOUD_SERVER_PORT);localStorage.getItem("x.hub.v5.SID")&&(d.XC_SUC.sid=localStorage.getItem("x.hub.v5.SID"));localStorage.getItem("x.hub.taskman.NEO_SERVER")&&(d.XC_SUC.neoserver=localStorage.getItem("x.hub.taskman.NEO_SERVER"));localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE")&&(d.XC_SUC.ccu_init_state=localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE"));localStorage.getItem("x.hub.Server.DISABLE_ST_STATES")&&(d.XC_SUC.disable_st_states=localStorage.getItem("x.hub.Server.DISABLE_ST_STATES"));
(b=require("os"))&&b.freemem&&(d.XC_SUC.mem=Math.floor(b.freemem()/1E3));try{if(global.LOAD_MODULES&&-1!=global.LOAD_MODULES.indexOf("enocean")){var g=require("x.hub.m.enocean.js");if(g){var k=g.getEnoceanInfo();d.XC_SUC.enocean=k}}}catch(l){}this._platform&&this._platform._network&&this._platform._network.getNetwork(function(a,b){if(!a&&b){var e=function(a){return a?{ip:a.ip,sn:a.subnet,gw:a.router,dhcp:a.dhcp,dns:a.dns?a.dns.join(","):a.dns,mac:a.mac}:null};a=Object.keys(b);if(0==a.length)return;
var g=b.eth0?"eth0":b.wlan0?"wlan0":a[0],f=e(b.eth0);a=e(b.wlan0);f||a||(f=e(b[g]));b=f?f:a;d.XC_SUC.primary_net=g;for(g in b)d.XC_SUC[g]=b[g];d.XC_SUC.cfg&&b&&(e=parseInt(d.XC_SUC.cfg,16),e=!0===b.dhcp?e&-129:e|128,d.XC_SUC.cfg=e.toString(16),2>d.XC_SUC.cfg.length&&(d.XC_SUC.cfg="0"+d.XC_SUC.cfg),d.XC_SUC.cfg=d.XC_SUC.cfg.toUpperCase());b!=a&&a&&(d.XC_SUC.wlan0=a)}c(JSON.stringify(d))});this._platform&&this._platform._time&&(this._platform._time.getNTPServers(function(a,b){!a&&b&&(d.XC_SUC.ntp=b.join(","))}),
this._platform._time.getTimezoneEncoded(function(a,b){!a&&b&&(d.XC_SUC.loc=(b+h+f).toUpperCase())}))}else x.hub.Server.prototype.doRequest.call(this,b,a,c)};d.prototype._doSTMCommandRequest=function(b,a,c){if(b){var d=this._platform._stm;if(d)if("string"==typeof b){var h=b;-1<h.indexOf("?")&&(h=h.substr(h.indexOf("?")+1));d.sendCommand(16,h,function(b){b&&b.data?XC.debugf(h+" --\x3e "+b.data.toString()):b&&b.error?XC.debugf(h+" --\x3e FAIL:"+b.error):XC.debugf(h+" --\x3e FAIL");if(b&&b.data){var d=
"XC_SUC";b.error&&(d="XC_ERR");a?c("{"+d+"}"+b.data.toString()):c('{"'+d+'": '+b.data.toString()+"}")}else a?c("{XC_ERR}internal error"):b&&b.error?c(JSON.stringify({XC_ERR:{code:"000000",msg:b.error}})):c('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})}else{if("POST"==b.method){var f=17;b=b.json?JSON.stringify(b.json):b.body}else f=16,b=reqeust.url,-1<b.indexOf("?")&&(b=b.substr(b.indexOf("?")+1));d.sendCommand(f,b,function(b){b&&b.data?XC.debugf(h+" --\x3e "+b.data.toString()):b&&b.error?
XC.debugf(h+" --\x3e FAIL:"+b.error):XC.debugf(h+" --\x3e FAIL");if(b&&b.data){var d="XC_SUC";b.error&&(d="XC_ERR");a?c("{"+d+"}"+b.data.toString()):c('{"'+d+'": '+b.data.toString()+"}")}else a?c("{XC_ERR}internal error"):b&&b.error?c(JSON.stringify({XC_ERR:{code:"000000",msg:b.error}})):c('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})}else a?c("{XC_ERR}no stm"):c('{"XC_ERR":{"code":"000001", "msg":"no stm"}}')}else a?c("{XC_ERR}invalid request"):c('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')};
d.prototype.setLED=function(b,a){if(b&&"string"==typeof b&&b.match(/^([a-fA-F0-9]){4}/g)){var c=this._platform._led;if(c){var d=parseInt(b.substr(0,2),16);b=parseInt(b.substr(2,2),16);var h;switch(b){case 0:var f=h=b=0;break;case 1:b=0;h=255;f=0;break;case 2:h=b=0;f=255;break;case 3:b=255;f=h=0;break;case 4:h=b=255;f=0;break;case 5:f=h=b=255;break;case 6:b=255;h=0;f=255;break;case 7:b=0;f=h=255;break;default:a&&a(Error("invalid set led color:"+b));return}0===d?c.setColor(b,h,f,function(b){a&&a(b)}):
1==d?c.saveColor(b,h,f,function(b){a&&a(b)}):a&&a(Error("invalid set led command:"+d))}else a&&a(Error("no led"))}else a&&a(Error("invalid set led data: "+b))};d.prototype.restart=function(b){XC.debugf("RESTART!");var a=this;setTimeout(function(){a._platform.reboot()},b)};d.prototype.reset=function(b,a){var c=require("fs"),d=require("fs-extra");switch(b){case "passwords":c.existsSync("./data/localstorage/x.hub.Server.pwd")&&d.removeSync("./data/localstorage/x.hub.Server.pwd");a&&a(null,!1);break;
case "network":this._platform.reset("network",function(b,c){a&&a(b,c)});break;case "factory":c.existsSync("./data")&&d.emptyDirSync("./data");this._platform.reset("factory",function(b,c){a&&a(b,c)});break;default:a&&a(Error("unknonw reset mode: "+b))}};return d}();x.hub.Handler=function(){this.server=null};x.hub.Handler.prototype.Server=x.hub.Server;x.hub.Handler.prototype.ServerV6=x.hub.ServerV6;x.hub.Handler.prototype.getServer=function(){return this.server};
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.Handler);
