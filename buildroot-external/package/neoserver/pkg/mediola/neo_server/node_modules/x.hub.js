var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(e){var b=0;return function(){return b<e.length?{done:!1,value:e[b++]}:{done:!0}}};$jscomp.arrayIterator=function(e){return{next:$jscomp.arrayIteratorImpl(e)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(e,b,a){e!=Array.prototype&&e!=Object.prototype&&(e[b]=a.value)};$jscomp.getGlobal=function(e){e=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,e];for(var b=0;b<e.length;++b){var a=e[b];if(a&&a.Math==Math)return a}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(e,b){this.$jscomp$symbol$id_=e;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:b})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function e(a){if(this instanceof e)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(a||"")+"_"+b++,a)}var b=0;return e}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var e=$jscomp.global.Symbol.iterator;e||(e=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[e]&&$jscomp.defineProperty(Array.prototype,e,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var e=$jscomp.global.Symbol.asyncIterator;e||(e=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(e){$jscomp.initSymbolIterator();e={next:e};e[$jscomp.global.Symbol.iterator]=function(){return this};return e};
$jscomp.iteratorFromArray=function(e,b){$jscomp.initSymbolIterator();e instanceof String&&(e+="");var a=0,d={next:function(){if(a<e.length){var c=a++;return{value:b(c,e[c]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
$jscomp.polyfill=function(e,b,a,d){if(b){a=$jscomp.global;e=e.split(".");for(d=0;d<e.length-1;d++){var c=e[d];c in a||(a[c]={});a=a[c]}e=e[e.length-1];d=a[e];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(a,e,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.keys",function(e){return e?e:function(){return $jscomp.iteratorFromArray(this,function(b){return b})}},"es6","es3");require("x.core.js");var x=x||{};x.hub=x.hub||{};
x.hub.Dispatcher=function(){var e=function(b){this._expressApp=b;this._routes=[]};e.prototype.add=function(b,a,d){if(!b||!d)throw Error("invalid arguments");this._routes.push({path:b,opts:a,callback:d})};e.prototype.doRequest=function(b,a,d,c){var h=this,g=function(a,d,b,e){h._findRoute(a,d,function(a,h){a?a.callback(b,e,function(){g(h+1,d,b,e)}):c()})};g(0,b,a,d)};e.prototype._findRoute=function(b,a,d){for(;b<this._routes.length;b++){var c=this._routes[b];if(c&&0==c.path.indexOf(a)){d(c,b);return}}d(null,
-1)};e.prototype.init=function(){var b=this;this._expressApp.use("/",function(a,d,c){b.doRequest(a.path,a,d,c)})};return e}();
x.hub.Auth=function(){var e=function(){};e.prototype.auth=function(b,a){if(!a||!a.pwd)return!0;if(!b.query.at&&b.query.auth){var d=require("x.crypt.js");b.query.at=d.MD5(unescape(encodeURI(b.query.auth+"_SALT!")))}return b.query.at&&b.query.at==a.pwd?!0:b.headers&&b.headers.authorization?this._checkAuthHeader(b.headers.authorization,a):!1};e.prototype._checkAuthHeader=function(b,a){return b&&"Basic "==b.substr(0,6)?(b=b.substr(6).trim(),(b=(new Buffer(b,"base64")).toString().split(":")[1])?require("x.crypt.js").MD5(unescape(encodeURI(b+
"_SALT!")))==a.pwd:!1):!1};return e}();x.hub.Error=function(){var e=function(b,a){Error.call(this,b);this.code=a?a:"000000"};require("util").inherits(e,Error);return e}();
x.hub.Dispatcher2=function(){var e=function(b,a){this._expressApp=b;this._server=a;this._routes=[]};e.prototype.add=function(b,a,d){if(!b)throw Error("invalid arguments");a&&"function"==typeof a&&!d&&(d=a,a=null);if(!d)throw Error("invalid arguments");this._routes.push({path:b,opts:a,callback:d})};e.prototype.doRequest=function(b,a,d){var c=this,h=function(a,b,e){c._findRoute(a,b,function(a,g){if(a)try{c._doRoute(a,b,e,function(){h(g+1,b,e)})}catch(p){e.json({XC_ERR:{code:"000000",msg:p.message}})}else d()})};
h(0,b,a)};e.prototype._doRoute=function(b,a,d,c){var e=function(a,c,d,b,g,e){"cloud"==c.source?(c.hasValidAuth=!0,e()):(b=b.auth(c,g),c.hasValidAuth=b,a.opts&&0==a.opts.auth?e():b?e():d.json({XC_ERR:{code:"000007",msg:"access denied"}}))},g=this._server._auth,k={pwd:this._server._pwd};(function(a,c,d,b){if("cloud"==c.source)b();else if(a.opts&&"stream"==a.opts.body)b();else if("POST"!=c.method&&"PUT"!=c.method||"application/octet-stream"==c.header("content-type"))b();else{var g=new Buffer([]);c.on("data",
function(a){g=Buffer.concat([g,a])});c.on("end",function(){c.size=g.length;c.body=g.toString("utf8");c.json=null;if(!a.opts||!a.opts.body||"json"==a.opts.body)try{c.json=JSON.parse(g)}catch(t){}b()})}})(b,a,d,function(){e(b,a,d,g,k,function(){b.callback(a,d,function(){c()})})})};e.prototype._findRoute=function(b,a,d){for(var c=function(a,c){return"/"==c&&a!=c?!1:c.length<=a.length&&a.substr(0,c.length)==c?!0:"*"==c?!0:!1},e=function(a,c){return 0!=(("webserver"==a?1:"cloud"==a?2:3)&c)},g=a.path;b<
this._routes.length;b++){var k=this._routes[b];if(k&&k.path&&c(g,k.path)){if(k.opts){if(k.opts.method&&a.method&&a.method.toLowerCase()!=k.opts.method.toLowerCase())continue;if(k.opts.source&&!e(a.source,k.opts.source))continue}d(k,b);return}}d(null,-1)};e.prototype.init=function(){var b=this;this._expressApp.use("/",function(a,d,c){b.doRequest(a,d,c)})};return e}();
x.hub.Auth2=function(){var e=function(){};e.prototype.auth=function(b,a){if(!a||!a.pwd)return!0;var d=require("x.crypt.js");if(b.query){if(b.query.at){if(b.query.at==a.pwd)return delete b.query.at,!0;delete b.query.at}if(b.query.auth){if(d.MD5(unescape(encodeURI(b.query.auth+"_SALT!")))==a.pwd)return delete b.query.auth,!0;delete b.query.auth}}if(b.json){if(b.json.at){if(b.json.at==a.pwd)return delete b.json.at,!0;delete b.json.at}if(b.json.auth){if(d.MD5(unescape(encodeURI(b.json.auth+"_SALT!")))==
a.pwd)return delete b.json.auth,!0;delete b.json.auth}}return b.headers&&b.headers.authorization?this._checkAuthHeader(b.headers.authorization,a):!1};e.prototype._checkAuthHeader=function(b,a){return b&&"Basic "==b.substr(0,6)?(b=b.substr(6).trim(),(b=(new Buffer(b,"base64")).toString().split(":")[1])?require("x.crypt.js").MD5(unescape(encodeURI(b+"_SALT!")))==a.pwd:!1):!1};return e}();
x.hub.Server=function(e,b,a){this._logger=require("x.logger.js").getLogger("x.hub.Server");this.HWV="EB";this.VERSION="0.0.0";this.DEFAULT_NAME="XHUB";this.VID="FFFF";this.hostType="A20";this._port=null;this._stmPort=e;this._hmPort=b;this._signalPin=a;this._cloudConnect=this._hmSerial=this._stmUSB=null;this._pwd="";this._onCustomSerialEvent=this._onSerialEvent=null;this._app=require("express")();this._dispatcher=new x.hub.Dispatcher(this._app);this._httpserver=require("http").createServer(this._app);
this._commandFunctions={};this._cmdFunctions={};this._logger={log:function(){}};try{var d=require("x.logger.js");d&&(this._logger=d.getLogger("x.hub.Server"));var c=require("x.hub.eventbus.js");c&&(c.on("udpevent",this.onUdpEvt.bind(this)),c.on("status",this.onStatusEvt.bind(this)))}catch(h){}localStorage&&("EA"==global.HARDWARE_VERSION&&(localStorage.getItem("x.hub.Server.timezone")||localStorage.setItem("x.hub.Server.timezone","8C")),localStorage.getItem("x.hub.Server.geo.lat")||localStorage.setItem("x.hub.Server.geo.lat",
"1392"),localStorage.getItem("x.hub.Server.geo.long")||localStorage.setItem("x.hub.Server.geo.long","035C"),localStorage.getItem("x.hub.Server.pwd")&&(this._pwd=localStorage.getItem("x.hub.Server.pwd")));this._auth=new x.hub.Auth};x.hub.Server.prototype.auth=function(e){return this._auth.auth(e,{pwd:this._pwd})};
x.hub.Server.prototype.getNetworkSettings=function(e){if("A20"==this.hostType)require("x.hub.v5.js").Native.getIPData(function(a){e&&e(null,a)});else{var b={},a=require("os");if(a&&a.networkInterfaces){a=a.networkInterfaces();for(var d in a){b[d]||(b[d]=[]);for(var c=a[d],h=0;h<c.length;h++)if("IPv4"==c[h].family&&!1===c[h].internal){var g=this._getIPData(c[h]);b[d].push(g)}}}e&&e(null,b)}};
x.hub.Server.prototype._getIPData=function(e){var b={};b.IP=e.address;b.PT=this._port;b.SN="255.255.255.0";e.netmask&&(b.SN=e.netmask);b.GW="0.0.0.0";var a=null;try{a=require("netroute")}catch(c){}if(a&&(a=a.getInfo())&&a.IPv4)for(var d=0;d<a.IPv4.length;d++)if("0.0.0.0"==a.IPv4[d].destination){b.GW=a.IPv4[d].gateway;break}b.DNS="0.0.0.0";(a=require("dns"))&&a.getServers&&(a=a.getServers())&&0<a.length&&(b.DNS=a[0]);b.MAC="00-00-00-00-00-00";e.mac&&(b.MAC=e.mac.replace(/:/g,"-"));return b};
x.hub.Server.prototype.addRoute=function(e,b,a){"function"==typeof b&&(a=b,b=null);return this._dispatcher.add(e,b,a)};
x.hub.Server.prototype.start=function(e){this._port=e;this._name=this.DEFAULT_NAME;localStorage&&localStorage.getItem("x.hub.Server.name")&&(this._name=localStorage.getItem("x.hub.Server.name"));this._vid=this.VID;localStorage&&localStorage.getItem("x.hub.Server.vid")&&(this._vid=localStorage.getItem("x.hub.Server.vid"));this._startup=Math.round((new Date).getTime()/1E3);this._startServer();this._startUDPServer(1901);if(this._stmPort){var b=this;this._stmUSB=new (require("x.hub.v5.js").USBSerial)(this._stmPort,
this._signalPin);this._stmUSB.on("data",function(a){if(a&&a.type&&a.data)if(80==a.type&&b._onSerialEvent){a=a.data.toString();var d=null;8<a.length&&"{XC_EVT}"==a.substr(0,8)?(a=a.substr(8),d="EVT"):4<a.length&&"EVT:"==a.substr(0,4)?(a=a.substr(4),d="EVT"):4<a.length&&"STA:"==a.substr(0,4)&&(a=a.substr(4),d="STA");b._onSerialEvent(a,d)}else 82==a.type&&b._onCustomSerialEvent&&b._onCustomSerialEvent(a.data)})}};
x.hub.Server.prototype.startSTM=function(e){if(this._stmPort){var b=this;this._stmUSB=new (require("x.hub.v5.js").USBSerial)(this._stmPort,this._signalPin,e);this._stmUSB.on("data",function(a){if(a&&a.type&&a.data)if(80==a.type&&b._onSerialEvent){a=a.data.toString();var d=null;8<a.length&&"{XC_EVT}"==a.substr(0,8)?(a=a.substr(8),d="EVT"):4<a.length&&"EVT:"==a.substr(0,4)?(a=a.substr(4),d="EVT"):4<a.length&&"STA:"==a.substr(0,4)&&(a=a.substr(4),d="STA");b._onSerialEvent(a,d)}else 82==a.type&&b._onCustomSerialEvent&&
b._onCustomSerialEvent(a.data)})}};
x.hub.Server.prototype.startWebserver=function(e,b){this._port=e;this._name=this.DEFAULT_NAME;localStorage&&localStorage.getItem("x.hub.Server.name")&&(this._name=localStorage.getItem("x.hub.Server.name"));this._vid=this.VID;localStorage&&localStorage.getItem("x.hub.Server.vid")&&(this._vid=localStorage.getItem("x.hub.Server.vid"));this._startup=Math.round((new Date).getTime()/1E3);var a=0;this._startServer(function(){console.log("************* ++++++++++++++++++ **************");console.log("******* http server ("+
e+") started ********");console.log("************* ++++++++++++++++++ **************");a++;2==a&&b&&b()});this._startUDPServer(1901,function(){console.log("************* ++++++++++++++++++ **************");console.log("********** upd server (1901) started **********");console.log("************* ++++++++++++++++++ **************");a++;2==a&&b&&b()})};x.hub.Server.prototype.on=function(e,b){"serialevent"==e?this._onSerialEvent=b:"customserialevent"==e&&(this._onCustomSerialEvent=b)};
x.hub.Server.prototype._getServerFromReq=function(e){if(e.query.server)return e.query.server;var b=null;e.ip?b=e.ip:e.connection.remoteAddress&&(b=e.connection.remoteAddress);b&&-1<b.indexOf(":")&&b.indexOf(".")>b.indexOf(":")?b=b.substr(b.lastIndexOf(":")+1):"::1"==b&&(b="localhost");return b};x.hub.Server.prototype.enableCloudConnect=function(e){this._cloudConnect=e;e.init(this)};
x.hub.Server.prototype.restart=function(e){XC.debugf("RESTART!");var b=this;setTimeout(function(){"A20"==b.hostType?require("x.hub.v5.js").Native.reboot():process.exit(0)},e)};x.hub.Server.prototype.resHasError=function(e){var b=null;try{b=JSON.parse(e)}catch(a){b=null}return b&&b.XC_ERR?!0:!1};
x.hub.Server.prototype._doSTMCommandRequest=function(e,b,a){this._stmUSB&&e&&-1<e.indexOf("?")?(e=e.substr(e.indexOf("?")+1),this._stmUSB.sendCommand(16,e,function(d){d&&d.data?XC.debugf(e+" --\x3e "+d.data.toString()):d&&d.error?XC.debugf(e+" --\x3e FAIL:"+d.error):XC.debugf(e+" --\x3e FAIL");if(d&&d.data){var c="XC_SUC";d.error&&(c="XC_ERR");b?a("{"+c+"}"+d.data.toString()):a('{"'+c+'": '+d.data.toString()+"}")}else b?a("{XC_ERR}internal error"):d&&d.error?a(JSON.stringify({XC_ERR:{code:"000000",
msg:d.error}})):a('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})):b?a("{XC_ERR}invalid request"):a('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')};x.hub.Server.prototype.doSTMCommand=function(e,b){this._doSTMCommandRequest("/cmd?"+e,!1,function(a){var d=null;try{d=JSON.parse(a)}catch(c){d=null}b&&b(d)})};x.hub.Server.prototype.doSTMRequest=function(e,b,a){this._stmUSB?this._stmUSB.sendCommand(e,b,function(d){d?d.error?a(null):a(d.data):a(null)}):a(null)};
x.hub.Server.prototype.setCommandFunc=function(e,b){this._commandFunctions[e.toLowerCase()]=b};x.hub.Server.prototype.setCmdFunc=function(e,b){this._cmdFunctions[e.toLowerCase()]=b};
x.hub.Server.prototype.doRequest=function(e,b,a){var d=require("os");if("/"==e){var c='<!DOCTYPE html>\n<html>\n<head>\n<meta http-equiv="content-type" content="text/html; charset=utf-8" />\n<title>'+(String(this._name).replace(/</g,"&lt;").replace(/>/g,"&gt;")+'</title>\n<script>function setHMconfigRef() {var hmconfig = document.getElementById("hmconfig"); if(hmconfig){hmconfig.href = window.location.protocol + "//" + window.location.hostname + ":81/";}}\x3c/script>\n');c=c+'</head>\n<body style="background-color: #FFFFFF; font-family: Helvetica, Arial, sans-serif;" onload="setHMconfigRef()">\n<table style="border-radius: 0px 0px 8px 8px; border: 1px #999 solid; -moz-box-shadow: 0px 5px 8px #888; -webkit-box-shadow: 2px 5px 8px #888; box-shadow: 0px 5px 8px #888; position: absolute; height: 220px; width: 420px; margin: -110px 0px 0px -210px; top: 50%; left: 50%; color: #777; background-color: #fafafa; font-size: 15px;" border="0" cellspacing="0">\n<tbody>\n<tr style="height: 48px; background-color: #666; color: #FFFFFF; font-size: 20px;"><th colspan="3">'+
(this._name+"</th>\n");c=c+'</tr>\n<tr style="height: 28px;"><td style="width: 70px;">&nbsp;</td><td style="width: 150px;">&nbsp;</td><td>&nbsp;</td></tr>\n<tr style="height: 30px;"><td>&nbsp;</td><td>device:</td><td><b>'+(this.DEFAULT_NAME+"</b></td></tr>\n");c+='<tr style="height: 30px;"><td>&nbsp;</td><td>version:</td><td><b>'+this.HWV+" ("+this.VERSION+")</b></td></tr>\n";var h=Math.round((new Date).getTime()/1E3)-this._startup,g=Math.floor(h/86400);h-=86400*g;e=Math.floor(h/3600);h-=3600*e;var k=
Math.floor(h/60);c+='<tr style="height: 30px;"><td>&nbsp;</td><td>uptime:</td><td><b>'+g+"d "+e+"h "+k+"m "+(h-60*k)+"s</b></td></tr>\n";d&&d.freemem&&(c+='<tr style="height: 30px;"><td>&nbsp;</td><td>memory:</td><td><b>'+Math.floor(d.freemem()/1E3)+"</b></td></tr>\n");a(c+'<tr style="height: 0px;"><td colspan="3">&nbsp;</td></tr>\n<tr style="height: 32px;"><td colspan="3" style="font-size: 13px; text-align: center;">&copy;&nbsp;2018 mediola - connected living AG</td></tr>\n</tbody>\n</table>\n</body>\n</html>')}else if("/info"==
e){var f={XC_SUC:{name:this._name,mhv:"XH I-"+this.hostType,msv:this.VERSION,hwv:this.HWV,vid:this._vid,start:this._startup,time:Math.round((new Date).getTime()/1E3)}};e="8C";k="1392";var m="035C";localStorage.getItem("x.hub.Server.timezone")&&(e=localStorage.getItem("x.hub.Server.timezone"));localStorage.getItem("x.hub.Server.geo.lat")&&(k=localStorage.getItem("x.hub.Server.geo.lat"));localStorage.getItem("x.hub.Server.geo.long")&&(m=localStorage.getItem("x.hub.Server.geo.long"));f.XC_SUC.loc=(e+
k+m).toUpperCase();localStorage.getItem("x.hub.v5.config")&&(f.XC_SUC.cfg=localStorage.getItem("x.hub.v5.config"));localStorage.getItem("x.hub.v5.cloudServer")&&localStorage.getItem("x.hub.v5.cloudPort")?f.XC_SUC.server=localStorage.getItem("x.hub.v5.cloudServer")+":"+localStorage.getItem("x.hub.v5.cloudPort"):(e=require("x.hub.v5.js").CloudConnect,f.XC_SUC.server=e.prototype.CLOUD_SERVER+":"+e.prototype.CLOUD_SERVER_PORT);localStorage.getItem("x.hub.v5.SID")&&(f.XC_SUC.sid=localStorage.getItem("x.hub.v5.SID"));
localStorage.getItem("x.hub.taskman.NEO_SERVER")&&(f.XC_SUC.neoserver=localStorage.getItem("x.hub.taskman.NEO_SERVER"));localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE")&&(f.XC_SUC.ccu_init_state=localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE"));localStorage.getItem("x.hub.Server.DISABLE_ST_STATES")&&(f.XC_SUC.disable_st_states=localStorage.getItem("x.hub.Server.DISABLE_ST_STATES"));d&&d.freemem&&(f.XC_SUC.mem=Math.floor(d.freemem()/1E3));try{global.LOAD_MODULES&&-1!=global.LOAD_MODULES.indexOf("enocean")&&
(h=require("x.hub.m.enocean.js"))&&(g=h.getEnoceanInfo(),f.XC_SUC.enocean=g)}catch(t){}if("A20"==this.hostType){f.XC_SUC.SAFE_MODE=global.SAFE_MODE;c=require("x.hub.v5.js");var n=function(a){return{ip:a.IP,sn:a.SN,gw:a.GW,dhcp:a.DHCP,dns:a.DNS,mac:a.MAC,ntp:a.NTP}};c.Native.getIPData(function(c){var d=null,b=null;Array.isArray(c.eth0)&&(d=n(c.eth0[0]));Array.isArray(c.wlan0)&&(b=n(c.wlan0[0]));c=d||b;for(var g in c)f.XC_SUC[g]=c[g];f.XC_SUC.primary_net=c===d?"eth0":"wlan0";f.XC_SUC.cfg&&c&&(d=parseInt(f.XC_SUC.cfg,
16),d=!0===c.dhcp?d&-129:d|128,f.XC_SUC.cfg=d.toString(16),2>f.XC_SUC.cfg.length&&(f.XC_SUC.cfg="0"+f.XC_SUC.cfg),f.XC_SUC.cfg=f.XC_SUC.cfg.toUpperCase());c!=b&&b&&(f.XC_SUC.wlan0=b);a(JSON.stringify(f))})}else if(require("dgram"),d&&d.networkInterfaces){d=d.networkInterfaces();for(c in d)if(d.hasOwnProperty(c))for(h=d[c],g=0;g<h.length;g++)"IPv4"==h[g].family&&!1===h[g].internal&&(e=this._getIPData(h[g]),k=null,b&&b.headers&&b.headers.host&&(k=b.headers.host,m=k.indexOf(":"),-1!=m&&(k=k.substr(0,
m))),!k||k!=e.IP&&"localhost"!=k&&"127.0.0.1"!=k||(f.XC_SUC.ip=e.IP,f.XC_SUC.sn=e.SN,f.XC_SUC.gw=e.GW,f.XC_SUC.dns=e.DNS,f.XC_SUC.mac=e.MAC));a(JSON.stringify(f))}}else if("/set"==e)b.query.rgb&&6==b.query.rgb.length&&(c=require("x.hub.v5.js"),c.setRGBColor(b.query.rgb)),a('{"XC_SUC": {}}');else if("/cmd"==e)if((c=b.query.XC_FNC)&&this._cmdFunctions[c.toLowerCase()]){var p=this;this._cmdFunctions[c.toLowerCase()](b,function(c){c?a(c):"POST"==b.method?p._doSTMCommandRequest(b,!1,a):p._doSTMCommandRequest(b.url,
!1,a)})}else"POST"==b.method?this._doSTMCommandRequest(b,!1,a):this._doSTMCommandRequest(b.url,!1,a);else if("/executeCommand"==e)c=require("x.logger.js").getLogger("GeneralExecuteCommand API"),c.log("trace","general execute command:"+JSON.stringify(b.query)),b.query&&b.query.data?(d=b.query.type,c=b.query.data,c.device&&!c.device.sys&&(c.device.sys=d),c.gateway&&!c.gateway.sys&&(c.gateway.sys=d),d=require("x.hub.commandman.js"),d.commandHandler.executeCommand(c.device,c.gateway,c.command,function(c){c.error?
a('{"XC_ERR":{"code":"000000","msg":"'+c.error.message+'"}}'):a('{"XC_SUC":{}}')})):a('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/getStates"==e)c=require("x.logger.js").getLogger("GeneralGetStates API"),c.log("trace","general get states:"+JSON.stringify(b.query)),b.query&&b.query.data?(d=b.query.type,c=b.query.data,c.device&&!c.device.sys&&(c.device.sys=d),c.gateway&&!c.gateway.sys&&(c.gateway.sys=d),d=require("x.hub.commandman.js"),c.deviceList?d.commandHandler.getMultiStatesLegacy(c.device,
c.gateway,c.deviceList,function(c){c.error?a('{"XC_ERR":{"code":"000000","msg":"'+c.error.message+'"}}'):c&&c.data?a(JSON.stringify({XC_SUC:{data:JSON.stringify(c.data)}})):a('{"XC_SUC":{}}')}):d.commandHandler.getState(c.device,c.gateway,c.status,function(c){c.error?a('{"XC_ERR":{"code":"000000","msg":"'+c.error.message+'"}}'):c&&c.data?a(JSON.stringify({XC_SUC:{data:JSON.stringify(c.data)}})):a('{"XC_SUC":{}}')})):a('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else{var l=a;c={json:function(a){l&&
(l(JSON.stringify(a)),l=null)},send:function(a){l&&(l(a),l=null)},status:function(){},end:function(){l&&(l(),l=null)}};this._dispatcher.doRequest(e,b,c,function(){l&&(l('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'),l=null)})}};
x.hub.Server.prototype._preHandleRequest=function(e,b,a){if("POST"==e.method&&"application/octet-stream"!=e.header("content-type"))if(e.json){if(e.query&&0<Object.keys(e.query).length&&this.auth(e)){e.query=e.json;a();return}e.query=e.json}else if("text/plain"!=e.header("content-type")&&"text/xml"!=e.header("content-type")&&"application/xml"!=e.header("content-type")){b.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');return}this.auth(e)?a():b.send('{"XC_ERR":{"code":"000007", "msg":"access denied"}}')};
x.hub.Server.prototype._startServer=function(e){this._app.set("case sensitive routing",!0);var b=this;this._app.use(function(a,d,c){d.header("Access-Control-Allow-Origin","*");d.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Authorization");require("x.logger.js").getLogger("x.hub.Server.Access").log("debug","REQ:"+a.url);if("/"==require("url").parse(a.url).pathname)b.doRequest("/",a,function(a){d.send(a)});else if("POST"==a.method&&"application/octet-stream"!=
a.header("content-type")){var e=new Buffer([]);a.on("data",function(a){e=Buffer.concat([e,a])});a.on("end",function(){a.body=e.toString("utf8");a.json=null;try{a.json=JSON.parse(e)}catch(g){}b._preHandleRequest(a,d,c)})}else b._preHandleRequest(a,d,c)});this._app.get("/info",function(a,d){try{b.doRequest("/info",a,function(a){d.send(a)})}catch(c){console.error(c)}});this._app.get("/set",function(a,d){b.doRequest("/set",a,function(a){d.send(a)})});this._app.get("/cmd",function(a,d){b.doRequest("/cmd",
a,function(a){d.send(a)})});this._app.post("/cmd",function(a,d){b.doRequest("/cmd",a,function(a){d.send(a)})});this._app.get("/command",function(a,d){XC.debugf("command: "+a.url);var c=a.query.XC_FNC;if(c&&b._commandFunctions[c.toLowerCase()])b._commandFunctions[c.toLowerCase()](a,d);else b._doSTMCommandRequest(a.url,!0,function(a){d.send(a)})});this._app.post("/executeCommand",function(a,d){b.doRequest("/executeCommand",a,function(a){d.send(a)})});this._app.post("/getStates",function(a,d){b.doRequest("/getStates",
a,function(a){d.send(a)})});this._app.get("/config",function(a,d){var c=!0,e=!1;a.query.name&&0<a.query.name.length&&(b._name=a.query.name,localStorage&&localStorage.setItem("x.hub.Server.name",a.query.name));a.query.vid&&0<a.query.vid.length&&(b._vid=a.query.vid,localStorage&&localStorage.setItem("x.hub.Server.vid",a.query.vid));if(a.query.pwd||""==a.query.pwd)e=require("x.crypt.js"),0===a.query.pwd.length?(b._pwd="",a.query.cloud=0):b._pwd=e.MD5(unescape(encodeURI(a.query.pwd+"_SALT!"))),localStorage&&
localStorage.setItem("x.hub.Server.pwd",b._pwd),e=!0;if(a.query.loc){if(2==a.query.loc.length)var g=a.query.loc;else if(8==a.query.loc.length){var k=a.query.loc.substr(0,4);var f=a.query.loc.substr(4)}else 10==a.query.loc.length&&(g=a.query.loc.substr(0,2),k=a.query.loc.substr(2,4),f=a.query.loc.substr(6));g&&localStorage&&localStorage.setItem("x.hub.Server.timezone",g);k&&localStorage&&localStorage.setItem("x.hub.Server.geo.lat",k);f&&localStorage&&localStorage.setItem("x.hub.Server.geo.long",f);
if("A1"==b.HWV)c=!1,b._platform.setLocation(k,f,function(a){a?d.json({XC_ERR:{code:"000000",msg:"set coordinate failed: "+a.message}}):b._platform.setTZData(g,function(a){a?d.json({XC_ERR:{code:"000000",msg:"set timezone failed: "+a.message}}):d.json({XC_SUC:{}})})});else{var m=require("x.hub.eventbus.js");m.emit("locationchange",{timezone:g,lat:k,long:f})}}a.query.neoserver&&localStorage&&(localStorage.setItem("x.hub.taskman.NEO_SERVER",a.query.neoserver),m=require("x.hub.eventbus.js"),m.emit("neoserver_activation",
a.query.neoserver));a.query.ccu_init_state&&localStorage&&(localStorage.setItem("x.hub.m.hm.CCU_INIT_STATE",a.query.ccu_init_state),m=require("x.hub.eventbus.js"),m.emit("x.hub.m.hm.CCU_INIT_STATE",a.query.ccu_init_state));a.query.disable_st_states&&localStorage&&localStorage.setItem("x.hub.Server.DISABLE_ST_STATES",a.query.disable_st_states);if("A20"==b.hostType||"CA"==b.HWV)f={},a.query.ip&&a.query.sn&&a.query.gw&&a.query.dns&&(f.IP=a.query.ip,f.SN=a.query.sn,f.GW=a.query.gw,f.DNS=a.query.dns,f.DHCP=
!1),a.query.dhcp&&1==a.query.dhcp&&(f={DHCP:!0}),a.query.ntp&&(f.NTP=a.query.ntp),a.query.mac&&(f.MAC=a.query.mac),0<Object.keys(f).length&&("EA"==b.HWV?(c=!1,k=require("x.hub.v5.js"),k.Native.setIPData(b,f,function(a){a?(d.send('{"XC_SUC":{}}'),b.restart(1E3)):d.send('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})):"CA"==b.HWV&&(c=!1,require("x.hub.v6.js").setIPData(f,function(a,c){a?d.json({XC_ERR:{code:"000000",msg:a.message}}):(d.json({XC_SUC:{}}),c&&b.restart(1E3))})));a.query.sid&&
localStorage&&(localStorage.setItem("x.hub.v5.SID",a.query.sid),e=!0);a.query.ckey&&localStorage&&(localStorage.setItem("x.hub.v5.cloudKey",a.query.ckey),e=!0);a.query.cserver&&localStorage&&(localStorage.setItem("x.hub.v5.cloudServer",a.query.cserver),e=!0);a.query.cport&&localStorage&&(localStorage.setItem("x.hub.v5.cloudPort",a.query.cport),e=!0);a.query.cloud&&localStorage&&(e=255,localStorage.getItem("x.hub.v5.config")&&(e=parseInt(localStorage.getItem("x.hub.v5.config"),16)),e=1==a.query.cloud?
e&-65:e|64,e=e.toString(16),2>e.length&&(e="0"+e),localStorage.setItem("x.hub.v5.config",e.toUpperCase()),e=!0);if("A20"==b.hostType&&a.query.year&&a.query.month&&a.query.date&&a.query.hour&&a.query.minute){c=!1;f=parseInt(a.query.year);m=parseInt(a.query.month);var n=parseInt(a.query.date),p=parseInt(a.query.hour);a=parseInt(a.query.minute);if(isNaN(f)||1970>f||9999<f){d.send('{"XC_ERR":{"code":"000000", "msg":"year invalid"}}');return}if(isNaN(m)||1>m||12<m){d.send('{"XC_ERR":{"code":"000000", "msg":"month invalid"}}');
return}if(isNaN(n)||1>n||31<n){d.send('{"XC_ERR":{"code":"000000", "date":"year invalid"}}');return}if(isNaN(p)||0>p||23<p){d.send('{"XC_ERR":{"code":"000000", "date":"hour invalid"}}');return}if(isNaN(a)||0>a||59<a){d.send('{"XC_ERR":{"code":"000000", "date":"minute invalid"}}');return}k=require("x.hub.v5.js");k.Native.setDateTime(f,m,n,p,a,function(a){a?(require("x.hub.eventbus.js").emit("timechange",{}),d.send('{"XC_SUC":{}}')):d.send('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})}e&&
b._cloudConnect&&b._cloudConnect.init(b);c&&d.send('{"XC_SUC": {}}')});this._app.get("/getKey",function(a,d){a=require("x.hub.v5.js");var c={XC_SUC:{}};localStorage.getItem("x.hub.v5.cloudKey")&&(c.XC_SUC.cloud=localStorage.getItem("x.hub.v5.cloudKey"));a.getPublicKey(function(a){c.XC_SUC.key=a;d.end(JSON.stringify(c))})});this._app.get("/peripheral",function(a,d){require("x.hub.peripheralman.js").getUSBDevicesShortInfo(function(a){a?a.error?d.end(JSON.stringify({XC_ERR:{code:"000001",msg:a.error}})):
a.data?d.end(JSON.stringify({XC_SUC:a.data})):d.end(JSON.stringify({XC_ERR:{code:"000001",msg:"get peripheral internal error"}})):d.end(JSON.stringify({XC_ERR:{code:"000001",msg:"get peripheral internal error"}}))})});this._hmPort?this._app.get("/hmtest",function(a,d){b._doHMTestRequest(a.query,d)}):"A20"==this.hostType&&this._app.get("/hmtest",function(a,d){require("x.hub.v5.js").Native.checkHMSerial(function(a){"OK"==a?d.send('{"XC_SUC":{}}'):d.send('{"XC_ERR":{"msg":"'+a+'"}}')})});this._app.get("/update",
function(a,d){var c=b._getServerFromReq(a),e="80",g=null;a.query.port&&(e=a.query.port);a.query.url&&(g=a.query.url);a.query.server&&(c=a.query.server);c&&e&&g?"A20"==b.hostType?require("x.hub.v5.js").Native.updateFirmware(c,e,g,function(a){d.send(a);b.resHasError(a)||b.restart(1E3)}):d.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'):d.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/updateST",function(a,d){if("CA"==global.HARDWARE_VERSION)b._platform.updateSTM(null,
d,function(){});else{var c=!1,e=b._getServerFromReq(a),g="80",k=null;a.query.live&&"0"!=a.query.live&&"false"!=a.query.live&&(c=!0);a.query.port&&(g=a.query.port);a.query.url&&(k=a.query.url);a.query.server&&(e=a.query.server);e&&g&&k?"A20"==b.hostType?(a=require("x.hub.v5.js"),c?a.Native.updateSTFirmware(e,g,k,d):a.Native.updateSTFirmware(e,g,k,null,function(a){d.send(a)})):c?d.send("ERROR."):d.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'):c?d.send("ERROR."):d.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')}});
this._app.post("/updateST",function(a,d){"CA"==global.HARDWARE_VERSION?b._platform.updateSTM(a,d,function(){}):d.json({XC_ERR:{code:"000001",msg:"invalid request"}})});this._app.post("/updateV5PFW",function(a,d){require("x.hub.v5.js").Native.updateV5PFirmware(a,d,function(a){b.resHasError(a)||b.restart(1E3)})});this._app.get("/backup",function(a,d){var c=require("x.crypt.js"),e=require("x.hub.v5.js");if("A20"==b.hostType&&a.query.native&&"0"!=a.query.native&&"false"!=a.query.native)e.Native.backup(b,
d);else{var g=null;a.query.enc&&"0"!=a.query.enc&&"false"!=a.query.enc&&(a.query.at?g=a.query.at:a.query.auth&&(g=c.MD5(unescape(encodeURI(a.query.auth+"_SALT!")))));e.backup(b,d,g)}});this._app.get("/restore",function(a,d){var c=b._getServerFromReq(a),e="80",g=null;a.query.port&&(e=a.query.port);a.query.url&&(g=a.query.url);if(c&&e&&g){var k=require("x.hub.v5.js");if("A20"==b.hostType&&a.query.native&&"0"!=a.query.native&&"false"!=a.query.native)k.Native.restore(b,"http://"+c+":"+e+g,function(a){d.send(a);
b.resHasError(a)||b.restart(1E3)});else{var f=null;a.query.key?f=a.query.key:a.query.at?f=a.query.at:a.query.auth&&(f=crypt.MD5(unescape(encodeURI(a.query.auth+"_SALT!"))));k.restore(b,"http://"+c+":"+e+g,f,function(a){d.send(a);b.resHasError(a)||b.restart(1E3)})}}else d.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/getLogs",function(a,d){a=require("x.hub.v5.js");"A20"==b.hostType?a.getLogs(d):"A1"==b.HWV?a.getNeoServerLogs(d):d.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});
this._app.get("/clearLogs",function(a,d){a=require("x.hub.v5.js");"A20"==b.hostType?a.clearLogs(function(){d.send('{"XC_SUC":{}}')}):d.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/getPorts",function(a,d){require("x.hub.v5.js").getSerialPorts(function(a){d.send(a)})});this._app.get("/reset",function(a,d){d.send('{"XC_SUC":{}}');b.restart(1E3)});this._app.get("/refurbish",function(a,d){require("x.hub.v5.js").Native.setIPData(b,{DHCP:!0},function(a){a?b._stmUSB.reset(function(){require("x.hub.v5.js").resetST(function(){d.status(200).json({XC_SUC:{}})})}):
d.send('{"XC_ERR":{"code":"000000", "msg":"enable dhcp failed"}}')})});this._app.get("/resetST",function(a,d){"CA"==global.HARDWARE_VERSION?b._platform._stm.reset(function(a){a?d.json({XC_ERR:{msg:a.message}}):d.json({XC_SUC:{}})}):b._stmUSB.reset(function(){require("x.hub.v5.js").resetST(function(){d.status(200).json({XC_SUC:{}})})})});this._app.get("/rebootST",function(a,d){"CA"==global.HARDWARE_VERSION?b._platform._stm.reboot(function(a){a?d.json({XC_ERR:{msg:a.message}}):d.json({XC_SUC:{}})}):
b._stmUSB.reset(function(){require("x.hub.v5.js").rebootST(function(){d.status(200).json({XC_SUC:{}})})})});this._app.get("/resetHM",function(a,d){require("x.hub.v5.js").Native.resetHM(function(a){a?(d.status(200).json({XC_SUC:{}}),b.restart(100)):d.status(200).json({XC_ERR:{code:"000000",message:"reset homematic failed"}})})});this._app.get("/resetZwave",function(a,d){require("x.hub.v5.js").Native.resetZway(function(a){a?(d.status(200).json({XC_SUC:{}}),b.restart(100)):d.status(200).json({XC_ERR:{code:"000000",
message:"reset zwave failed"}})})});this._app.get("/resetZigbee",function(a,d){require("x.hub.v5.js").Native.resetZigbee(function(a){a?(d.status(200).json({XC_SUC:{}}),b.restart(100)):d.status(200).json({XC_ERR:{code:"000000",message:"reset zigbee failed"}})})});this._app.get("/resetKNX",function(a,d){require("x.hub.m.knx.js").reset(function(a){a&&!a.error?d.status(200).json({XC_SUC:{}}):d.status(200).json({XC_ERR:{code:"000000",message:"reset knx failed"}})})});this._app.get("/mountUSB",function(a,
d){require("x.hub.v5.js").mountUSB(function(a){a.error?d.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):d.status(200).json({XC_SUC:{}})})});this._app.get("/setBackupUSB",function(a,d){a.query.path?require("x.hub.v5.js").setBackupUsbPath(a.query.path,function(){d.status(200).json({XC_SUC:{}})}):d.status(500).json({XC_ERR:{code:"000000",msg:"no usb path"}})});this._app.post("/backupDeviceXML",function(a,d){a=a.body;require("x.hub.v5.js").saveDeviceXMLforBackup(a,function(a){a.error?
d.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):d.status(200).json({XC_SUC:{}})})});this._app.post("/backupMacrosXML",function(a,d){a=a.body;require("x.hub.v5.js").saveMacrosXMLforBackup(a,function(a){a.error?d.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):d.status(200).json({XC_SUC:{}})})});this._app.post("/backupIrcodesXML",function(a,d){a=a.body;require("x.hub.v5.js").saveIrcodesXMLforBackup(a,function(a){a.error?d.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):
d.status(200).json({XC_SUC:{}})})});this._app.get("/backupLocal",function(a,d){var c=require("x.crypt.js"),e=require("x.hub.v5.js"),g=null;a.query.key&&(g=c.MD5(unescape(encodeURI(a.query.key+"_SALT!"))));e.backupLocal(b,g,function(a){a.error?d.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):d.status(200).json({XC_SUC:{file:a.data}})})});this._app.get("/unmountUSB",function(a,d){require("x.hub.v5.js").unmountUSB(function(a){a.error?d.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):
d.status(200).json({XC_SUC:{}})})});this._app.get("/listUsbBackups",function(a,d){require("x.hub.v5.js").listUsbBackups(function(a){a.error?d.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):d.status(200).json({XC_SUC:a.data})})});this._app.get("/deleteUsbBackup",function(a,d){(a=a.query.file)?require("x.hub.v5.js").deleteBackup(a,function(a){a.error?d.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):d.status(200).json({XC_SUC:{}})}):d.status(200).json({XC_ERR:{code:"000000",
msg:"file name is null"}})});this._app.get("/loadBackup",function(a,d){var c=require("x.hub.v5.js"),b=require("x.crypt.js"),g=a.query.file;if(g){var e=null;a.query.key&&(e=b.MD5(unescape(encodeURI(a.query.key+"_SALT!"))));c.loadBackup(g,e,function(a){a.error?d.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):d.status(200).json({XC_SUC:{}})})}else d.status(200).json({XC_ERR:{code:"000000",msg:"file name is null"}})});this._app.get("/loadBackupDeviceXML",function(a,d){require("x.hub.v5.js").loadDeviceXML(function(a){a.error?
d.status(400).json({XC_ERR:{code:"000000",msg:a.error.message}}):d.status(200).end(a.data)})});this._app.get("/loadBackupMacroXML",function(a,d){require("x.hub.v5.js").loadMacroXML(function(a){a.error?d.status(400).json({XC_ERR:{code:"000000",msg:a.error.message}}):d.status(200).end(a.data)})});this._app.get("/loadBackupIrcodesXML",function(a,d){require("x.hub.v5.js").loadIrcodesXML(function(a){a.error?d.status(400).json({XC_ERR:{code:"000000",msg:a.error.message}}):d.status(200).end(a.data)})});
this._app.get("/restoreLocal",function(a,d){require("x.hub.v5.js").restoreLocal(b,function(a){a.error?d.status(200).json({XC_ERR:{code:"000000",msg:a.error.message}}):(d.status(200).json({XC_SUC:{}}),b.restart(1E3))})});this._app.get("/testReadOnly",function(a,d){require("x.hub.v5.js").testReadOnly(function(a){a?d.status(200).json({XC_SUC:{readonly:!0,message:a.message}}):d.status(200).json({XC_SUC:{readonly:!1}})})});this._app.get("/fixReadOnly",function(a,d){require("x.hub.v5.js").fixReadOnly(d,
function(a){a?d.status(200).json({XC_ERR:{code:"01001",message:a.message}}):d.status(200).json({XC_SUC:{}})})});this._app.get("/scan",function(a,d){require("x.hub.v5.js").Native.scanWiFi(function(a,b){if(a)d.send(a.message);else if(b){d.send('{"XC_SUC":'+JSON.stringify(b)+"}");return}d.send('{"XC_ERR":{"msg":"Scanning wifis failed."}}')})});this._app.get("/connect",function(a,d){a.query.ssid&&a.query.pwd?require("x.hub.v5.js").Native.connectWiFi(a.query.ssid,a.query.pwd,function(a){a?d.send('{"XC_SUC":{}}'):
d.send('{"XC_ERR":{"msg":"failed to connect"}}')}):d.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/configWLAN",function(a,d){var c={};a.query.ip&&a.query.sn&&a.query.gw&&a.query.dns&&(c.IP=a.query.ip,c.SN=a.query.sn,c.GW=a.query.gw,c.DNS=a.query.dns,c.DHCP=!1);a.query.dhcp&&1==a.query.dhcp&&(c={DHCP:!0});a.query.ntp&&(c.NTP=a.query.ntp);a.query.mac&&(c.MAC=a.query.mac);0<Object.keys(c).length?require("x.hub.v5.js").Native.setWLANData(c,function(a){a?d.send('{"XC_SUC":{}}'):
d.send('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')}):d.send('{"XC_SUC": {}}')});this._app.get("/tm/http",function(a,d){var c=require("x.hub.taskman.js");if(c&&c.taskManager)c.taskManager.onHttpEvt(a.query,function(a,c){a?d.send('{"XC_ERR":{"msg":'+a.message+"}}"):c?d.send('{"XC_SUC":{}}'):d.send('{"XC_ERR":{"msg":"no such trigger"}}')});else d.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._dispatcher.init();this._app.get("*",function(a,d){XC.debugf("INVALID REQ: "+
a.url);d.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.use(function(a,d,c,b){XC.debugf(a);c.send({XC_ERR:{code:"000001",msg:"exception"}})});this._httpserver.listen(this._port,function(){var a=b._httpserver.address().port;b._logger.log("info","listening on port "+a+"...");e&&e()})};
x.hub.Server.prototype.sendUDPMessage=function(e){if(this._udpSocket){var b=e.substr(0,4);if("EVT:"==b||"STA:"==b)try{var a=JSON.parse(e.substr(4));a.__srcId=this._udpSocket.__srcId;e=b+JSON.stringify(a)}catch(d){}e=new Buffer(e);this._udpSocket.send(e,0,e.length,1901,"239.255.255.250");this._udpSocket.send(e,0,e.length,1901,"255.255.255.255")}};
x.hub.Server.prototype._startUDPServer=function(e,b){var a=require("dgram"),d=this,c=require("crypto").randomBytes(4).toString("hex");try{var h=this._udpSocket=a.createSocket({reuseAddr:!0,type:"udp4"})}catch(g){h=this._udpSocket=a.createSocket("udp4")}h.__srcId=c;h.on("listening",function(){d._logger.log("info","listening on udp port "+e+"...");h.setBroadcast(!0);b&&b()});h.on("message",function(a,c){h.address();if(a&&a.length&&3<=a.length&&71==a[0]&&69==a[1]&&84==a[2]){d._logger.log("trace","receive gateway discovery request");
var b=function(a,b){var e="DHCP:"+(a.DHCP?"TRUE":"FALSE")+"\nHWV:"+d.HWV+"\nVER:"+d.VERSION+"\nVID:"+d._vid+"\nNAME:"+d._name;e+="\nIP:"+a.IP;e+="\nPT:"+a.PT;e+="\nSN:"+a.SN;e+="\nGW:"+a.GW;e+="\nDNS:"+a.DNS;e+="\nMAC:"+a.MAC;b&&(e+="\nTMP_ID:"+b);e+="\n";d._logger.log("trace","send gateway discovery response:"+e.replace(/(?:\r\n|\r|\n)/g," | "));a=new Buffer(e);h.send(a,0,a.length,c.port,c.address);h.send(a,0,a.length,1901,"239.255.255.250");h.send(a,0,a.length,1901,"255.255.255.255")};d.getNetworkSettings(function(a,
c){if(!a&&c){a=null;"A20"==d.hostType&&(a=function(){return Math.floor(65536*(1+Math.random())).toString(16).substr(1)},a=a()+a());for(var e in c)for(var g=0;g<c[e].length;g++)c[e][g].PT=d._port,b(c[e][g],a)}})}else if(a&&a.length&&4<=a.length&&69==a[0]&&86==a[1]&&84==a[2]){var e=a.toString();if(4<e.length){a=null;try{a=JSON.parse(e.substr(4))}catch(n){}a&&a.__srcId!=h.__srcId&&(delete a.__srcId,e=require("x.hub.eventbus.js"),e.emit("gatewayevent",a,c,"EVT"))}}else if(a&&a.length&&4<=a.length&&83==
a[0]&&84==a[1]&&65==a[2]&&(e=a.toString(),4<e.length)){a=null;try{a=JSON.parse(e.substr(4))}catch(n){}a&&a.__srcId!=h.__srcId&&(delete a.__srcId,e=require("x.hub.eventbus.js"),e.emit("gatewayevent",a,c,"STA"))}});h.on("error",function(a){d._logger.log();XC.debugf("udp port error");h.close()});h.on("close",function(){});h.bind(e)};x.hub.Server.prototype.onUdpEvt=function(e,b){b||(b="EVT");this._logger.log("trace","send "+b+" event:"+JSON.stringify(e));this.sendUDPMessage(b+":"+JSON.stringify(e)+"\r\n")};
x.hub.Server.prototype.onStatusEvt=function(e){};x.hub.Server.prototype.getTimeZone=function(){var e="8C";localStorage&&localStorage.getItem("x.hub.Server.timezone")&&(e=localStorage.getItem("x.hub.Server.timezone"));return e};
x.hub.Server.prototype.setTimeZoneCompatiable=function(e,b){if(!e||isNaN(parseInt(e,16)))b&&b(Error("timezone invalid"));else{e=parseInt(e,16);e=((e>>4&1?-1:1)*(e&15)+11&31|(e>>5&1)<<7).toString(16).toUpperCase();2>e.length&&(e="0"+e);e&&localStorage&&localStorage.setItem("x.hub.Server.timezone",e);var a=localStorage.getItem("x.hub.Server.geo.lat"),d=localStorage.getItem("x.hub.Server.geo.long");require("x.hub.eventbus.js").emit("locationchange",{timezone:e,lat:a,long:d});b&&b()}};
x.hub.Server.prototype.getTimeZoneCompatiable=function(e){var b=this.getTimeZone();b=parseInt(b,16);var a=(b&31)-11;b=((0!=(b&128)?1:0)<<5|(0>a?1:0)<<4|(0<a?a:0-a)).toString(16).toUpperCase();2>b.length&&(b="0"+b);e&&e(null,b)};
x.hub.ServerNEO=function(){var e=function(b,a,d){x.hub.Server.call(this,b,a,d);this._dispatcher=new x.hub.Dispatcher2(this._app,this);this._auth=new x.hub.Auth2;this._platform=require("x.hub.neo_server.js")};require("util").inherits(e,x.hub.Server);e.prototype._routes=[{path:"/info",options:{method:"GET"}},{path:"/cmd",options:null},{path:"/command",options:null},{path:"/config",options:{method:"GET",source:1}},{path:"/executeCommand",options:{method:"POST"}},{path:"/getStates",options:{method:"POST"}},
{path:"/getKey",options:{method:"GET"}},{path:"/backup",options:{method:"GET"}},{path:"/restore",options:{method:"POST",body:"stream"}},{path:"/reset",options:{method:"GET"}},{path:"/log",options:{method:"GET",source:1}},{path:"/getLogs",options:{method:"GET",source:1}},{path:"/log",options:{method:"DELETE"}},{path:"/tm/http",options:{method:"GET"}},{path:"/",options:{method:"GET",auth:0}}];e.prototype.addRoute=function(b,a,d){"function"==typeof a&&(d=a,a=null);return this._dispatcher.add(b,a,d)};
e.prototype._setDefaultRoutes=function(){var b=this,a=function(a,c){var d=null;d=require("url").parse(a.url).pathname;d="/"==d?"/":"/"+d.split("/")[1];b.doRequest(d,a,c,function(a){void 0!=a&&null!=a&&("object"==typeof a?c.json(a):c.send(a))})};this._routes.forEach(function(d){b.addRoute(d.path,d.options,a)})};e.prototype._startServer=function(b){var a=this;this._setDefaultRoutes();this._app.set("case sensitive routing",!0);this._app.use(function(a,c,b){c.header("Access-Control-Allow-Origin","*");
c.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Authorization");var d=require("x.logger.js").getLogger("x.hub.Server.Access");d.log("debug",a.method+":"+a.url);a.source="webserver";c.on("finish",function(){d.log("debug",a.method+":"+a.url+" -> HTTP:"+c.statusCode)});b()});this._dispatcher.init();this._app.use("*",function(a,c){require("x.logger.js").getLogger("x.hub.Server.Access").log("debug","INVALID "+a.method+" REQ:"+a.url);c.json({XC_ERR:{code:"000001",
msg:"invalid request"}})});this._app.use(function(a,c,b,e){require("x.logger.js").getLogger("x.hub.Server.Access").log("warn","error: "+a.message+" stack:"+a.stack);b.json({XC_ERR:{code:"000002",msg:a.stack}})});this._httpserver.listen(this._port,function(){var d=a._httpserver.address().port;a._logger.log("info","listening on port "+d+"...");b&&b()})};e.prototype.doRequest=function(b,a,d,c){!c&&d&&"function"==typeof d&&(c=d,d=null);if("/info"==b)this._info(a,function(a,d){a?c&&c(JSON.stringify({XC_ERR:{code:"000000",
msg:a.message}})):c&&c(JSON.stringify({XC_SUC:d}))});else if("/command"==b)if((b=a.query.XC_FNC)&&this._commandFunctions[b.toLowerCase()])this._commandFunctions[b.toLowerCase()](a,d);else c&&c('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/cmd"==b)if(b=a.query.XC_FNC,!b&&a.json&&a.json.XC_FNC&&(b=a.json.XC_FNC,a.query=a.json),b&&this._cmdFunctions[b.toLowerCase()])this._cmdFunctions[b.toLowerCase()](a,function(a){c&&c(a?a:'{"XC_ERR":{"code":"000002", "msg":"invalid request"}}')});
else c&&c('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/config"==b)this._config(a,function(a,d){a?c&&c(JSON.stringify({XC_ERR:{code:"000000",msg:a.message}})):c&&c(JSON.stringify({XC_SUC:d?d:{}}))});else if("/executeCommand"==b)b=require("x.logger.js").getLogger("GeneralExecuteCommand API"),a.json&&(a.query=a.json),b.log("trace","general execute command:"+JSON.stringify(a.query)),a.query&&a.query.data?(b=a.query.type,a=a.query.data,a.device&&!a.device.sys&&(a.device.sys=b),a.gateway&&
!a.gateway.sys&&(a.gateway.sys=b),b=require("x.hub.commandman.js"),b.commandHandler.executeCommand(a.device,a.gateway,a.command,function(a){a.error?c('{"XC_ERR":{"code":"000000","msg":"'+a.error.message+'"}}'):c('{"XC_SUC":{}}')})):c('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/getStates"==b)b=require("x.logger.js").getLogger("GeneralGetStates API"),b.log("trace","general get states:"+JSON.stringify(a.query)),a.json&&(a.query=a.json),a.query&&a.query.data?(b=a.query.type,a=a.query.data,
a.device&&!a.device.sys&&(a.device.sys=b),a.gateway&&!a.gateway.sys&&(a.gateway.sys=b),b=require("x.hub.commandman.js"),a.deviceList?b.commandHandler.getMultiStatesLegacy(a.device,a.gateway,a.deviceList,function(a){a.error?c('{"XC_ERR":{"code":"000000","msg":"'+a.error.message+'"}}'):a&&a.data?c(JSON.stringify({XC_SUC:{data:JSON.stringify(a.data)}})):c('{"XC_SUC":{}}')}):b.commandHandler.getState(a.device,a.gateway,a.status,function(a){a.error?c('{"XC_ERR":{"code":"000000","msg":"'+a.error.message+
'"}}'):a&&a.data?c(JSON.stringify({XC_SUC:{data:JSON.stringify(a.data)}})):c('{"XC_SUC":{}}')})):c('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/getKey"==b){var e={XC_SUC:{}};localStorage.getItem("x.hub.v5.cloudKey")&&(e.XC_SUC.cloud=localStorage.getItem("x.hub.v5.cloudKey"));require("x.hub.v5.js").getPublicKey(function(a){e.XC_SUC.key=a;c&&c(e)})}else if("/backup"==b)this._platform.backup(a,d,function(){c&&c()});else if("/restore"==b)this._platform.restore(a,d,function(){c&&
c()});else if("/reset"==b)b="factory",a.query&&a.query.type&&(b=a.query.type),this.reset(b,function(a){a?c&&c(JSON.stringify({XC_ERR:{code:"000000",msg:a.message}})):c&&c('{"XC_SUC":{}}')});else if("/log"==b||"/getLogs"==b)a.method&&"get"==a.method.toLowerCase()?this.getLogs(function(a,b,e){if(a)d.status(500),d.json({XC_ERR:{code:"100000",msg:a.message}}),c&&c();else{var g=require("fs-extra");d.setHeader("Content-disposition","attachment; filename="+b);d.sendFile(e,null,function(a){g.removeSync(e);
a&&(d.status(500),d.json({XC_ERR:{code:"100000",msg:a.message}}));c&&c(a)})}}):a.method&&"delete"==a.method.toLowerCase()&&this.clearLogs(function(a){a?c&&c({XC_ERR:{code:"100000",msg:a.message}}):c&&c({XC_SUC:{}})});else if("/tm"==b)if("/tm/http"==require("url").parse(a.url).pathname)require("x.hub.taskman.js").taskManager.onHttpEvt(a.query,function(a,d){a?c&&c('{"XC_ERR":{"msg":'+a.message+"}}"):d?c&&c('{"XC_SUC":{}}'):c&&c('{"XC_ERR":{"msg":"no such trigger"}}')});else c&&c(JSON.stringify({XC_ERR:{code:"000000",
msg:"invalid request"}}));else x.hub.Server.prototype.doRequest.call(this,b,a,c)};e.prototype._info=function(b,a){var d={name:this._name,mhv:"XH I-"+this.hostType,msv:this.VERSION,hwv:this.HWV,vid:this._vid,start:this._startup,time:Math.round((new Date).getTime()/1E3)},c=this;require("async").parallel([function(a){localStorage.getItem("x.hub.v5.config")&&(d.cfg=localStorage.getItem("x.hub.v5.config"));localStorage.getItem("x.hub.v5.SID")&&(d.sid=localStorage.getItem("x.hub.v5.SID"));localStorage.getItem("x.hub.taskman.NEO_SERVER")&&
(d.neoserver=localStorage.getItem("x.hub.taskman.NEO_SERVER"));var c=require("os");c&&c.freemem&&(d.mem=Math.floor(c.freemem()/1E3));a()},function(a){d.server=c.getCloudServer()+":"+c.getCloudPort();a()},function(a){c.getTZ(function(c,b){!c&&b&&(d.loc||(d.loc=""),d.loc=(b+d.loc).toUpperCase());a()})},function(a){c.getLocation(function(c,b,e){!c&&b&&e&&(d.loc||(d.loc=""),d.loc+=(b+e).toUpperCase());a()})},function(a){c._platform._network.getNetwork(function(c,e){if(!c&&e){c=null;if(b&&b.headers&&b.headers.host){c=
b.headers.host;var g=c.indexOf(":");-1!=g&&(c=c.substr(0,g))}for(var h in e)if(g=e[h],c&&(c==g.ip||"localhost"==c||"127.0.0.1"==c)){d.ip=g.ip;d.sn=g.subnet;d.gw=g.router;d.dns=g.dns?g.dns[0]:null;d.mac=g.mac;break}}a()})}],function(){a&&a(null,d)})};e.prototype._config=function(b,a){var d=this,c=!1,e;require("async").series([function(a){b.query.name&&(d._name=b.query.name,localStorage&&localStorage.setItem("x.hub.Server.name",b.query.name));b.query.vid&&(d._vid=b.query.vid,localStorage&&localStorage.setItem("x.hub.Server.vid",
b.query.vid));if(b.query.pwd||""==b.query.pwd){var e=require("x.crypt.js");0===b.query.pwd.length?(d._pwd="",b.query.cloud=0):d._pwd=e.MD5(unescape(encodeURI(b.query.pwd+"_SALT!")));localStorage&&localStorage.setItem("x.hub.Server.pwd",d._pwd);c=!0}b.query.neoserver&&(localStorage&&localStorage.setItem("x.hub.taskman.NEO_SERVER",b.query.neoserver),require("x.hub.eventbus.js").emit("neoserver_activation",b.query.neoserver));b.query.sid&&localStorage&&(localStorage.setItem("x.hub.v5.SID",b.query.sid),
c=!0);a()},function(a){if(localStorage&&(b.query.ckey&&(d.setCloudKey(b.query.ckey),c=!0),b.query.cserver&&(d.setCloudServer(b.query.cserver),c=!0),b.query.cport&&(d.setCloudPort(b.query.cport),c=!0),void 0!=b.query.cloud&&null!=b.query.cloud)){var e=255;localStorage.getItem("x.hub.v5.config")&&(e=parseInt(localStorage.getItem("x.hub.v5.config"),16));e=1==b.query.cloud?e&-65:e|64;e=e.toString(16);2>e.length&&(e="0"+e);localStorage.setItem("x.hub.v5.config",e.toUpperCase());c=!0}a()},function(a){if(b.query.loc){if(2==
b.query.loc.length)var c=b.query.loc;else if(8==b.query.loc.length){var g=b.query.loc.substr(0,4);var h=b.query.loc.substr(4)}else 10==b.query.loc.length&&(c=b.query.loc.substr(0,2),g=b.query.loc.substr(2,4),h=b.query.loc.substr(6));d.setTZ(c,function(c){c&&(e=c);d.setLocation(g,h,function(c){c&&(e=c);a()})})}else a()}],function(){c&&d._cloudConnect&&d._cloudConnect.init(d);a&&a(e)})};e.prototype.setLocation=function(b,a,d){this._logger.log("debug","set location lat="+b+" long="+a);b&&a?(localStorage&&
(localStorage.setItem("x.hub.Server.geo.lat",b),localStorage.setItem("x.hub.Server.geo.long",a)),d&&d(),process.nextTick(function(){require("x.hub.eventbus.js").emit("locationchange",{lat:b,long:a})})):d&&d(Error("invalid arguments"))};e.prototype.getLocation=function(b){if(localStorage){var a=localStorage.getItem("x.hub.Server.geo.lat");var d=localStorage.getItem("x.hub.Server.geo.long")}a&&d||(a="1392",d="035C");b&&b(null,a,d)};e.prototype.setTZ=function(b,a){this._platform.setTZData(b,a)};e.prototype.getTZ=
function(b){this._platform.getTZData(b)};e.prototype.getTimezoneSync=function(){return this._platform.getTimezoneSync()};e.prototype.getCloudServer=function(){return this._cloudConnect.getCloudServer()};e.prototype.setCloudServer=function(b){return this._cloudConnect.setCloudServer(b)};e.prototype.getCloudPort=function(){return this._cloudConnect.getCloudPort()};e.prototype.setCloudPort=function(b){return this._cloudConnect.setCloudPort(b)};e.prototype.setCloudKey=function(b){return this._cloudConnect.setCloudKey(b)};
e.prototype.isCloudConnected=function(){return this._cloudConnect.isConnected()};e.prototype.getLogs=function(b){require("x.hub.logman.js").compressLogs(function(a,d,c){b&&b(a,d,c)})};e.prototype.clearLogs=function(b){require("x.hub.logman.js").clearLogs(function(a){b&&b(a)})};e.prototype.reset=function(b,a){var d=require("fs"),c=require("fs-extra"),e=require("path"),g=require("x.hub.fileman.js").fileManager.getUserRootDataPath();switch(b){case "passwords":b=e.join(g,"localstorage","x.hub.Server.pwd");
d.existsSync(b)&&c.removeSync(b);a&&a(null,!0);break;case "factory":d.existsSync(g)&&c.emptyDirSync(g);a&&a(null,!0);break;default:a&&a(Error("unknonw reset mode: "+b))}};return e}();
x.hub.ServerV6=function(){var e=function(){var a=function(a,d){this._expressApp=a;this._server=d;this._routes=[]};a.prototype.add=function(a,d,b){if(!a)throw Error("invalid arguments");d&&"function"==typeof d&&!b&&(b=d,d=null);if(!b)throw Error("invalid arguments");this._routes.push({path:a,opts:d,callback:b})};a.prototype.doRequest=function(a,d,b){var c=this,e=function(a,d,g){c._findRoute(a,d,function(a,f){if(a)try{c._doRoute(a,d,g,function(){e(f+1,d,g)})}catch(u){g.json({XC_ERR:{code:"000000",msg:u.message}})}else b()})};
e(0,a,d)};a.prototype._doRoute=function(a,d,b,e){var c=function(a,c,d,b,e,g){"cloud"==c.source?(c.hasValidAuth=!0,g()):(b=b.auth(c,e),c.hasValidAuth=b,a.opts&&0==a.opts.auth?g():b?g():d.json({XC_ERR:{code:"000007",msg:"access denied"}}))},g=this._server._auth,h={pwd:this._server._pwd};(function(a,c,d,b){if("cloud"==c.source)b();else if(a.opts&&"stream"==a.opts.body)b();else if("POST"!=c.method&&"PUT"!=c.method||"application/octet-stream"==c.header("content-type"))b();else{var e=new Buffer([]);c.on("data",
function(a){e=Buffer.concat([e,a])});c.on("end",function(){c.size=e.length;c.body=e.toString("utf8");c.json=null;if(!a.opts||!a.opts.body||"json"==a.opts.body)try{c.json=JSON.parse(e)}catch(r){}b()})}})(a,d,b,function(){c(a,d,b,g,h,function(){a.callback(d,b,function(){e()})})})};a.prototype._findRoute=function(a,d,b){for(var c=function(a,c){return"/"==c&&a!=c?!1:c.length<=a.length&&a.substr(0,c.length)==c?!0:"*"==c?!0:!1},e=function(a,c){return 0!=(("webserver"==a?1:"cloud"==a?2:3)&c)},g=d.path;a<
this._routes.length;a++){var h=this._routes[a];if(h&&h.path&&c(g,h.path)){if(h.opts){if(h.opts.method&&d.method&&d.method.toLowerCase()!=h.opts.method.toLowerCase())continue;if(h.opts.source&&!e(d.source,h.opts.source))continue}b(h,a);return}}b(null,-1)};a.prototype.init=function(){var a=this;this._expressApp.use("/",function(c,d,b){a.doRequest(c,d,b)})};return a}(),b=function(){var a=function(){};a.prototype.auth=function(a,d){if(!d||!d.pwd)return!0;var c=require("x.crypt.js");if(a.query&&(a.query.at&&
a.query.at==d.pwd||a.query.auth&&c.MD5(unescape(encodeURI(a.query.auth+"_SALT!")))==d.pwd))return!0;if(a.json){if(a.json.at){if(a.json.at==d.pwd)return delete a.json.at,!0;delete a.json.at}if(a.json.auth){if(c.MD5(unescape(encodeURI(a.json.auth+"_SALT!")))==d.pwd)return delete a.json.auth,!0;delete a.json.auth}}return a.headers&&a.headers.authorization?this._checkAuthHeader(a.headers.authorization,d):!1};a.prototype._checkAuthHeader=function(a,d){return a&&"Basic "==a.substr(0,6)?(a=a.substr(6).trim(),
(a=(new Buffer(a,"base64")).toString().split(":")[1])?require("x.crypt.js").MD5(unescape(encodeURI(a+"_SALT!")))==d.pwd:!1):!1};return a}(),a=function(a,c,h){x.hub.Server.call(this,a,c,h);this._dispatcher=new e(this._app,this);this._auth=new b;this._platform=require("x.hub.v6.js");var d=this;this._platform._stm.on("event",function(a,c){d._onSerialEvent(a,c)})};require("util").inherits(a,x.hub.Server);a.prototype._routes=[{path:"/info",options:{method:"GET"}},{path:"/cmd",options:null},{path:"/command",
options:null},{path:"/config",options:{method:"GET",source:1}},{path:"/wifi",options:{method:"GET",source:1}},{path:"/executeCommand",options:{method:"POST"}},{path:"/getStates",options:{method:"POST"}},{path:"/getKey",options:{method:"GET"}},{path:"/peripheral",options:{method:"GET"}},{path:"/update",options:null},{path:"/backup",options:{method:"GET"}},{path:"/restore",options:{method:"POST",body:"stream"}},{path:"/reset",options:{method:"GET"}},{path:"/reboot",options:{method:"GET"}},{path:"/log",
options:{method:"GET",source:1}},{path:"/getLogs",options:{method:"GET",source:1}},{path:"/log",options:{method:"DELETE"}},{path:"/tm/http",options:{method:"GET"}},{path:"/",options:{method:"GET",auth:0}}];a.prototype.addRoute=function(a,c,b){"function"==typeof c&&(b=c,c=null);return this._dispatcher.add(a,c,b)};a.prototype._setDefaultRoutes=function(){var a=this,c=function(c,d){var b=null;b=require("url").parse(c.url).pathname;b="/"==b?"/":"/"+b.split("/")[1];a.doRequest(b,c,d,function(a){void 0!=
a&&null!=a&&("object"==typeof a?d.json(a):d.send(a))})};this._routes.forEach(function(d){a.addRoute(d.path,d.options,c)})};a.prototype._startServer=function(a){var c=this;this._setDefaultRoutes();this._app.set("case sensitive routing",!0);this._app.use(function(a,c,d){c.header("Access-Control-Allow-Origin","*");c.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Authorization");var b=require("x.logger.js").getLogger("x.hub.Server.Access");b.log("debug",a.method+
":"+a.url);a.source="webserver";c.on("finish",function(){b.log("debug",a.method+":"+a.url+" -> HTTP:"+c.statusCode)});d()});this._dispatcher.init();this._app.use("*",function(a,c){XC.debugf("INVALID REQ: "+a.url);c.json({XC_ERR:{code:"000001",msg:"invalid request"}})});this._app.use(function(a,c,d,b){XC.debugf(a);d.json({XC_ERR:{code:"000002",msg:a.stack}})});this._httpserver.listen(this._port,function(){var d=c._httpserver.address().port;c._logger.log("info","listening on port "+d+"...");a&&a()})};
a.prototype.doRequest=function(a,c,b,e){!e&&b&&"function"==typeof b&&(e=b,b=null);var d=this;if("/"==a){var f='<!DOCTYPE html>\n<html>\n<head>\n<meta http-equiv="content-type" content="text/html; charset=utf-8" />\n<title>'+(String(this._name).replace(/</g,"&lt;").replace(/>/g,"&gt;")+'</title>\n<script>function setZwaveConfigRef() {var zwaveconfig = document.getElementById("zwaveconfig"); if(zwaveconfig){zwaveconfig.href = window.location.protocol + "//" + window.location.hostname + ":9000/";}}\x3c/script>\n');
f=f+'</head>\n<body style="background-color: #FFFFFF; font-family: Helvetica, Arial, sans-serif;" onload="setZwaveConfigRef()">\n<table style="border-radius: 0px 0px 8px 8px; border: 1px #999 solid; -moz-box-shadow: 0px 5px 8px #888; -webkit-box-shadow: 2px 5px 8px #888; box-shadow: 0px 5px 8px #888; position: absolute; height: 220px; width: 420px; margin: -110px 0px 0px -210px; top: 50%; left: 50%; color: #777; background-color: #fafafa; font-size: 15px;" border="0" cellspacing="0">\n<tbody>\n<tr style="height: 48px; background-color: #666; color: #FFFFFF; font-size: 20px;"><th colspan="3">'+
(this._name+"</th>\n");f=f+'</tr>\n<tr style="height: 28px;"><td style="width: 70px;">&nbsp;</td><td style="width: 150px;">&nbsp;</td><td>&nbsp;</td></tr>\n<tr style="height: 30px;"><td>&nbsp;</td><td>device:</td><td><b>'+(this.DEFAULT_NAME+"</b></td></tr>\n");f+='<tr style="height: 30px;"><td>&nbsp;</td><td>version:</td><td><b>'+this.HWV+" ("+this.VERSION+")</b></td></tr>\n";var g=Math.round((new Date).getTime()/1E3)-this._startup;a=Math.floor(g/86400);g-=86400*a;var h=Math.floor(g/3600);g-=3600*
h;var p=Math.floor(g/60);f+='<tr style="height: 30px;"><td>&nbsp;</td><td>uptime:</td><td><b>'+a+"d "+h+"h "+p+"m "+(g-60*p)+"s</b></td></tr>\n";(a=require("os"))&&a.freemem&&(f+='<tr style="height: 30px;"><td>&nbsp;</td><td>memory:</td><td><b>'+Math.floor(a.freemem()/1E3)+"</b></td></tr>\n");e(f+'<tr style="height: 30px;"><td>&nbsp;</td><td>zwave:</td><td><b><a href=":9000/" id="zwaveconfig">Expert UI</a></b></td></tr>\n<tr style="height: 0px;"><td colspan="3">&nbsp;</td></tr>\n<tr style="height: 32px;"><td colspan="3" style="font-size: 13px; text-align: center;">&copy;&nbsp;2020 mediola - connected living AG</td></tr>\n</tbody>\n</table>\n</body>\n</html>')}else if("/info"==
a){var l={XC_SUC:{name:this._name,mhv:"XH I-"+this.hostType,msv:this.VERSION,hwv:this.HWV,vid:this._vid,start:this._startup,time:Math.round((new Date).getTime()/1E3)}},t="1392",u="035C";localStorage.getItem("x.hub.Server.geo.lat")&&(t=localStorage.getItem("x.hub.Server.geo.lat"));localStorage.getItem("x.hub.Server.geo.long")&&(u=localStorage.getItem("x.hub.Server.geo.long"));localStorage.getItem("x.hub.v5.config")&&(l.XC_SUC.cfg=localStorage.getItem("x.hub.v5.config"));localStorage.getItem("x.hub.v5.cloudServer")&&
localStorage.getItem("x.hub.v5.cloudPort")?l.XC_SUC.server=localStorage.getItem("x.hub.v5.cloudServer")+":"+localStorage.getItem("x.hub.v5.cloudPort"):(a=require("x.hub.v5.js").CloudConnect,l.XC_SUC.server=a.prototype.CLOUD_SERVER+":"+a.prototype.CLOUD_SERVER_PORT);localStorage.getItem("x.hub.v5.SID")&&(l.XC_SUC.sid=localStorage.getItem("x.hub.v5.SID"));localStorage.getItem("x.hub.taskman.NEO_SERVER")&&(l.XC_SUC.neoserver=localStorage.getItem("x.hub.taskman.NEO_SERVER"));localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE")&&
(l.XC_SUC.ccu_init_state=localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE"));localStorage.getItem("x.hub.Server.DISABLE_ST_STATES")&&(l.XC_SUC.disable_st_states=localStorage.getItem("x.hub.Server.DISABLE_ST_STATES"));(a=require("os"))&&a.freemem&&(l.XC_SUC.mem=Math.floor(a.freemem()/1E3));try{global.LOAD_MODULES&&-1!=global.LOAD_MODULES.indexOf("enocean")&&(f=require("x.hub.m.enocean.js"))&&(g=f.getEnoceanInfo(),l.XC_SUC.enocean=g)}catch(y){}f=require("async");f.parallel([function(a){d._platform.getExtraInfo(function(d,
c){!d&&c&&(l.XC_SUC.extra=c);a()})},function(a){d._platform._time.getNTPServers(function(d,c){!d&&c&&(l.XC_SUC.ntp=c.join(","));a()})},function(a){d._platform._time.getTimezoneEncoded(function(d,c){!d&&c&&(l.XC_SUC.loc=(c+t+u).toUpperCase());a()})},function(a){l.XC_SUC.mediola_mac=d._platform._network.getMediolaMac();d._platform._network.getNetwork(function(c,d){if(!c&&d){var b=function(a){return a?{ip:a.ip,sn:a.subnet,gw:a.router,dhcp:a.dhcp,dns:a.dns?a.dns.join(","):a.dns,mac:a.mac?a.mac.replace(/:/g,
"-"):null}:null},e=Object.keys(d);if(0==e.length)return;c=b(d.eth0);var f=b(d.wlan0),g=null;d.eth0||d.wlan0||(g=b(d[e[0]]));d=null;c&&c.ip?(d=c,l.XC_SUC.primary_net="eth0"):f&&f.ip?(d=f,l.XC_SUC.primary_net="wlan0"):g&&g.ip&&(d=f,l.XC_SUC.primary_net=e[0]);for(var h in d)l.XC_SUC[h]=d[h];l.XC_SUC.cfg&&d&&(h=parseInt(l.XC_SUC.cfg,16),h=!0===d.dhcp?h&-129:h|128,l.XC_SUC.cfg=h.toString(16),2>l.XC_SUC.cfg.length&&(l.XC_SUC.cfg="0"+l.XC_SUC.cfg),l.XC_SUC.cfg=l.XC_SUC.cfg.toUpperCase());l.XC_SUC.eth0=c;
l.XC_SUC.wlan0=f}a()})}],function(){e(JSON.stringify(l))})}else if("/command"==a)if((f=c.query.XC_FNC)&&this._commandFunctions[f.toLowerCase()])this._commandFunctions[f.toLowerCase()](c,b);else this._doSTMCommandRequest(c.url,!0,function(a){b.send(a)});else if("/cmd"==a)if(f=c.query.XC_FNC,!f&&c.json&&c.json.XC_FNC&&(f=c.json.XC_FNC,c.query=c.json),f&&this._cmdFunctions[f.toLowerCase()])this._cmdFunctions[f.toLowerCase()](c,function(a){a?e(a):"POST"==c.method?d._doSTMCommandRequest(c,!1,e):d._doSTMCommandRequest(c.url,
!1,e)});else"POST"==c.method?this._doSTMCommandRequest(c,!1,e):this._doSTMCommandRequest(c.url,!1,e);else if("/config"==a){var q=!1,r,v=!1,w=null;!c.query||1!=c.query.poweroff&&"true"!=c.query.poweroff&&1!=c.query.poweroff||(w=!0);f=require("async");f.series([function(a){c.query.name&&(d._name=c.query.name,localStorage&&localStorage.setItem("x.hub.Server.name",c.query.name));c.query.vid&&(d._vid=c.query.vid,localStorage&&localStorage.setItem("x.hub.Server.vid",c.query.vid));if(c.query.pwd||""==c.query.pwd){var b=
require("x.crypt.js");0===c.query.pwd.length?(d._pwd="",c.query.cloud=0):d._pwd=b.MD5(unescape(encodeURI(c.query.pwd+"_SALT!")));localStorage&&localStorage.setItem("x.hub.Server.pwd",d._pwd);q=!0}c.query.neoserver&&localStorage&&(localStorage.setItem("x.hub.taskman.NEO_SERVER",c.query.neoserver),b=require("x.hub.eventbus.js"),b.emit("neoserver_activation",c.query.neoserver));c.query.ccu_init_state&&localStorage&&(localStorage.setItem("x.hub.m.hm.CCU_INIT_STATE",c.query.ccu_init_state),b=require("x.hub.eventbus.js"),
b.emit("x.hub.m.hm.CCU_INIT_STATE",c.query.ccu_init_state));c.query.disable_st_states&&localStorage&&localStorage.setItem("x.hub.Server.DISABLE_ST_STATES",c.query.disable_st_states);c.query.sid&&localStorage&&(localStorage.setItem("x.hub.v5.SID",c.query.sid),q=!0);c.query.ckey&&localStorage&&(localStorage.setItem("x.hub.v5.cloudKey",c.query.ckey),q=!0);c.query.cserver&&localStorage&&(localStorage.setItem("x.hub.v5.cloudServer",c.query.cserver),q=!0);c.query.cport&&localStorage&&(localStorage.setItem("x.hub.v5.cloudPort",
c.query.cport),q=!0);c.query.cloud&&localStorage&&(b=255,localStorage.getItem("x.hub.v5.config")&&(b=parseInt(localStorage.getItem("x.hub.v5.config"),16)),b=1==c.query.cloud?b&-65:b|64,b=b.toString(16),2>b.length&&(b="0"+b),localStorage.setItem("x.hub.v5.config",b.toUpperCase()),q=!0);a()},function(a){if(c.query.loc){if(2==c.query.loc.length)var b=c.query.loc;else if(8==c.query.loc.length){var e=c.query.loc.substr(0,4);var f=c.query.loc.substr(4)}else 10==c.query.loc.length&&(b=c.query.loc.substr(0,
2),e=c.query.loc.substr(2,4),f=c.query.loc.substr(6));d.setTimeZoneCompatiable(b,function(c){c&&(r=c);d.setLocation(e,f,function(d){d&&(r=d);a()})})}else a()},function(a){var b={};c.query.ip&&c.query.sn&&c.query.gw&&c.query.dns&&(b.IP=c.query.ip,b.SN=c.query.sn,b.GW=c.query.gw,b.DNS=c.query.dns,b.DHCP=!1);c.query.dhcp&&1==c.query.dhcp&&(b={DHCP:!0});c.query.ntp&&(b.NTP=c.query.ntp);c.query.mac&&(b.MAC=c.query.mac);0>=Object.keys(b).length?a():d._platform.setIPData(b,function(d,c){d?r=d:v=c;a()})}],
function(){q&&d._cloudConnect&&d._cloudConnect.init(d);e&&(r?e(JSON.stringify({XC_ERR:{code:"000001",msg:r.message}})):e('{"XC_SUC": {}}'));1==w?d.poweroff(1E3):v&&d.restart(1E3)})}else if("/executeCommand"==a)f=require("x.logger.js").getLogger("GeneralExecuteCommand API"),c.json&&(c.query=c.json),f.log("trace","general execute command:"+JSON.stringify(c.query)),c.query&&c.query.data?(g=c.query.type,f=c.query.data,f.device&&!f.device.sys&&(f.device.sys=g),f.gateway&&!f.gateway.sys&&(f.gateway.sys=
g),g=require("x.hub.commandman.js"),g.commandHandler.executeCommand(f.device,f.gateway,f.command,function(a){a.error?e('{"XC_ERR":{"code":"000000","msg":"'+a.error.message+'"}}'):e('{"XC_SUC":{}}')})):e('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/getStates"==a)f=require("x.logger.js").getLogger("GeneralGetStates API"),f.log("trace","general get states:"+JSON.stringify(c.query)),c.json&&(c.query=c.json),c.query&&c.query.data?(g=c.query.type,f=c.query.data,f.device&&!f.device.sys&&
(f.device.sys=g),f.gateway&&!f.gateway.sys&&(f.gateway.sys=g),g=require("x.hub.commandman.js"),f.deviceList?g.commandHandler.getMultiStatesLegacy(f.device,f.gateway,f.deviceList,function(a){a.error?e('{"XC_ERR":{"code":"000000","msg":"'+a.error.message+'"}}'):a&&a.data?e(JSON.stringify({XC_SUC:{data:JSON.stringify(a.data)}})):e('{"XC_SUC":{}}')}):g.commandHandler.getState(f.device,f.gateway,f.status,function(a){a.error?e('{"XC_ERR":{"code":"000000","msg":"'+a.error.message+'"}}'):a&&a.data?e(JSON.stringify({XC_SUC:{data:JSON.stringify(a.data)}})):
e('{"XC_SUC":{}}')})):e('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/getKey"==a)l={XC_SUC:{}},localStorage.getItem("x.hub.v5.cloudKey")&&(l.XC_SUC.cloud=localStorage.getItem("x.hub.v5.cloudKey")),require("x.hub.v5.js").getPublicKey(function(a){l.XC_SUC.key=a;e&&e(l)});else if("/peripheral"==a)require("x.hub.peripheralman.js").getUSBDevicesShortInfo(function(a){a?a.error?e&&e(JSON.stringify({XC_ERR:{code:"000001",msg:a.error}})):a.data?e&&e(JSON.stringify({XC_SUC:a.data})):e&&
e(JSON.stringify({XC_ERR:{code:"000001",msg:"get peripheral internal error"}})):e&&e(JSON.stringify({XC_ERR:{code:"000001",msg:"get peripheral internal error"}}))});else if("/update"==a)c.method&&"post"==c.method.toLowerCase()&&c.query&&"st"==c.query.type?d._platform.updateSTM(c,b,function(){e&&e()}):c.query&&"st"==c.query.type?d._platform.updateSTM(null,b,function(){e&&e()}):d._platform.updateFirmware(c.query?c.query.url:null,function(a,c){a?b.json({XC_ERR:{code:a.code?a.code:"000000",msg:a.message}}):
(b.json({XC_SUC:{}}),c&&d._platform.reboot(null,1E3));e&&e()});else if("/backup"==a)d._platform.backup(c,b,function(){e&&e()});else if("/restore"==a)d._platform.restore(c,b,function(){e&&e()});else if("/reset"==a)c.query&&c.query.type?"st"==c.query.type?d._platform._stm.reset(function(a){a?e&&e({XC_ERR:{msg:a.message}}):e&&e({XC_SUC:{}})}):"st_reboot"==c.query.type?d._platform._stm.reboot(function(a){a?e&&e({XC_ERR:{msg:a.message}}):e&&e({XC_SUC:{}})}):"knx"==c.query.type?require("x.hub.m.knx.js").reset(function(a){a&&
!a.error?e&&e({XC_SUC:{}}):e&&e({XC_ERR:{code:"000000",message:"reset knx failed"}})}):"zwave"==c.query.type&&d._platform._zwayServer.reset(function(a){a?e&&e({XC_ERR:{msg:a.message}}):e&&e({XC_SUC:{}})}):(e&&e('{"XC_SUC":{}}'),d.restart(1E3));else if("/reboot"==a)e&&e('{"XC_SUC":{}}'),f=null,c.query&&c.query.mode&&"recovery"==c.query.mode&&(f="recovery"),d._platform.reboot(f,1E3);else if("/wifi"==a)switch(f=c.path,f=f.substr(5),f){case "/scan":d._platform._network.scanWifi(c.query,function(a,d){a?
e&&e(JSON.stringify({XC_ERR:{code:a.code?a.code:"000000",msg:a.message}})):e&&e(JSON.stringify({XC_SUC:d?d:[]}))});break;case "/connect":d._platform._network.connectWifi(c.query,function(a){a?e&&e(JSON.stringify({XC_ERR:{code:a.code?a.code:"000000",msg:a.message}})):(e&&e(JSON.stringify({XC_SUC:{}})),d.restart(1E3))});break;case "/disconnect":d._platform._network.disconnectWifi(c.query,function(a){a?e&&e(JSON.stringify({XC_ERR:{code:a.code?a.code:"000000",msg:a.message}})):(e&&e(JSON.stringify({XC_SUC:{}})),
d.restart(1E3))});break;case "/info":d._platform._network.getWifiInfo(c.query,function(a,d){a?e&&e(JSON.stringify({XC_ERR:{code:a.code?a.code:"000000",msg:a.message}})):e&&e(JSON.stringify({XC_SUC:d}))});break;case "/config":f={};"true"==c.query.dhcp||1==c.query.dhcp||1==c.query.dhcp?f={dhcp:!0}:c.query.ip&&c.query.sn&&c.query.gw&&c.query.dns&&(f.ip=c.query.ip,f.subnet=c.query.sn,f.router=c.query.gw,f.dns=c.query.dns?c.query.dns.split(","):[],f.dhcp=!1);if(0>=Object.keys(f).length){e&&e(JSON.stringify({XC_SUC:{}}));
break}d._platform._network.setNetwork("wlan0",f,function(a){a?e&&e(JSON.stringify({XC_ERR:{code:a.code?a.code:"000000",msg:a.message}})):(e&&e(JSON.stringify({XC_SUC:{}})),d.restart(1E3))});break;default:e&&e({XC_ERR:{code:"000001",message:"invalid request"}})}else if("/log"==a||"/getLogs"==a)c.method&&"get"==c.method.toLowerCase()?d.getLogs(function(a,d,c){if(a)b.status(500),b.json({XC_ERR:{code:"100000",msg:a.message}}),e&&e();else{var f=require("fs-extra");b.setHeader("Content-disposition","attachment; filename="+
d);b.sendFile(c,null,function(a){f.removeSync(c);a&&(b.status(500),b.json({XC_ERR:{code:"100000",msg:a.message}}));e&&e(a)})}}):c.method&&"delete"==c.method.toLowerCase()&&d.clearLogs(function(a){a?e&&e({XC_ERR:{code:"100000",msg:a.message}}):e&&e({XC_SUC:{}})});else if("/tm"==a)if(f=require("url").parse(c.url).pathname,"/tm/http"==f)require("x.hub.taskman.js").taskManager.onHttpEvt(c.query,function(a,d){a?e&&e('{"XC_ERR":{"msg":'+a.message+"}}"):d?e&&e('{"XC_SUC":{}}'):e&&e('{"XC_ERR":{"msg":"no such trigger"}}')});
else e&&e(JSON.stringify({XC_ERR:{code:"000000",msg:"invalid request"}}));else x.hub.Server.prototype.doRequest.call(this,a,c,e)};a.prototype._doSTMCommandRequest=function(a,c,b){if(a){var d=this._platform._stm;if(d){var e=this;if("string"==typeof a){var f=16;var h=a;-1<h.indexOf("?")&&(h=h.substr(h.indexOf("?")+1))}else"POST"==a.method?(f=17,h=a.json?JSON.stringify(a.json):a.body):(f=16,h=reqeust.url,-1<h.indexOf("?")&&(h=h.substr(h.indexOf("?")+1)));d.sendCommand(f,h,function(a){a&&a.data?e._logger.log("trace",
h+" --\x3e "+a.data.toString()):a&&a.error?e._logger.log("trace",h+" --\x3e FAIL:"+a.error):e._logger.log("trace",h+" --\x3e FAIL");if(a&&a.data){var d="XC_SUC";a.error&&(d="XC_ERR");c?b("{"+d+"}"+a.data.toString()):b('{"'+d+'": '+a.data.toString()+"}")}else c?b("{XC_ERR}internal error"):a&&a.error?b(JSON.stringify({XC_ERR:{code:"000000",msg:a.error}})):b('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})}else c?b("{XC_ERR}no stm"):b('{"XC_ERR":{"code":"000001", "msg":"no stm"}}')}else c?b("{XC_ERR}invalid request"):
b('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')};a.prototype.setLED=function(a,c){if(a&&"string"==typeof a&&a.match(/^([a-fA-F0-9]){4}/g)){var b=this._platform._led;if(b){var d=parseInt(a.substr(0,2),16);a=parseInt(a.substr(2,2),16);var e;switch(a){case 0:var f=e=a=0;break;case 1:a=0;e=255;f=0;break;case 2:e=a=0;f=255;break;case 3:a=255;f=e=0;break;case 4:e=a=255;f=0;break;case 5:f=e=a=255;break;case 6:a=255;e=0;f=255;break;case 7:a=0;f=e=255;break;default:c&&c(Error("invalid set led color:"+
a));return}0===d?b.setColor(a,e,f,function(a){c&&c(a)}):1==d?b.saveColor(a,e,f,function(a){c&&c(a)}):c&&c(Error("invalid set led command:"+d))}else c&&c(Error("no led"))}else c&&c(Error("invalid set led data: "+a))};a.prototype.restart=function(a){this._platform.reboot(null,a)};a.prototype.poweroff=function(a){this._platform.poweroff(a)};a.prototype.reset=function(a,c){var b=require("fs"),d=require("fs-extra");switch(a){case "passwords":b.existsSync("./data/localstorage/x.hub.Server.pwd")&&d.removeSync("./data/localstorage/x.hub.Server.pwd");
c&&c(null,!0);break;case "network":this._platform.reset("network",function(a,b){c&&c(a,b)});break;case "factory":b.existsSync("./data")&&d.emptyDirSync("./data");this._platform.reset("factory",function(a,b){c&&c(a,b)});break;default:c&&c(Error("unknonw reset mode: "+a))}};a.prototype.getTimezoneSync=function(){return this._platform.getTimezoneSync()};a.prototype.setTimeZoneCompatiable=function(a,b){this._platform.setTZData(a,function(c){c||process.nextTick(function(){require("x.hub.eventbus.js").emit("locationchange",
{timezone:a})});b&&b(c)})};a.prototype.getTimeZoneCompatiable=function(a){this._platform.getTZData(a)};a.prototype.setLocation=function(a,b,e){this._platform.setLocation(a,b,function(c){c||process.nextTick(function(){require("x.hub.eventbus.js").emit("locationchange",{lat:a,long:b})});e&&e(c)})};a.prototype.getLocation=function(a){this._platform.getLocation(function(b,d,e){a&&a(b,d,e)})};a.prototype.getLogs=function(a){var b=require("x.hub.fileman.js").fileManager.getUserLogPath(),d=require("os").tmpdir(),
e=require("path"),k=require("fs-extra"),f=require("archiver"),m="logs_"+(new Date).toISOString().substr(0,16).replace(/T/g,"").replace(/-/g,"").replace(/:/g,"")+".zip",n=e.join(d,m);d=k.createWriteStream(n);f=f("zip");d.on("close",function(){a&&(a(null,m,n),a=null)});d.on("error",function(b){a&&(a(b),a=null)});f.on("error",function(b){a&&(a(b),a=null)});f.pipe(d);f.directory(b);f.finalize()};a.prototype.clearLogs=function(a){require("x.hub.logman.js").clearLogs(function(b){a&&a(b)})};a.prototype.getCloudServer=
function(){return this._cloudConnect.getCloudServer()};a.prototype.getCloudPort=function(){return this._cloudConnect.getCloudPort()};a.prototype.isCloudConnected=function(){return this._cloudConnect.isConnected()};return a}();x.hub.Handler=function(){this.server=null};x.hub.Handler.prototype.Server=x.hub.Server;x.hub.Handler.prototype.ServerNEO=x.hub.ServerNEO;x.hub.Handler.prototype.ServerV6=x.hub.ServerV6;x.hub.Handler.prototype.getServer=function(){return this.server};
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.Handler);
