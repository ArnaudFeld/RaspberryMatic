var util=require("util"),EventEmitter=require("events");require("x.logger.js").setLevel("info","x.hub.m.hue");require("x.logger.js").setLevel("info","xnm.aio.hue");var x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.hue=x.hub.m.hue||{};x.hub.m.hue.HUE_MODULE=require("xnm.aio.hue.js");
x.hub.m.hue.Monitor=function(){var c=function(a){this._logger=require("x.logger.js").getLogger("x.hub.m.hue.Monitor");this._running=!1;this._bridge=a;this._devices={};this._sensors={}};c.prototype.start=function(a){this._logger.log("debug","start monitor for:"+this._bridge.ip);this._running||(this._running=!0,this._getAllSensors());a&&a()};c.prototype.addStateDevice=function(a,b){a&&a.address&&(this._devices[a.address]=a);b&&b()};c.prototype._getAllSensors=function(){var a=this;this._logger.log("trace",
"get all sensors for:"+this._bridge.ip);x.hub.m.hue.HUE_MODULE.Sensor.getAllSensors(this._bridge,function(b,d){b?(a._logger.log("trace","get all sensors for:"+a._bridge.ip+" error:"+b.message),setTimeout(function(){a._getAllSensors()},1E3)):(!b&&d&&a._receiveSensors(d),a._running&&a._getAllSensors())})};c.prototype._receiveSensors=function(a){var b=function(a){for(var b={},d=0;d<a.length;d++){var c=a[d].getAddress(),g=a[d].getStates();b[c]=g}return b},d=b(this._sensors),b=b(a);this._sensors=a;for(var g=
0;g<a.length;g++){var c=a[g],e=c.getAddress();if(this._devices[e]){var c=c.getType(),f=d[e],h=b[e];if(h)switch(c){case "ZLLPresence":this._produceEvent(this._devices[e],"motion",f?f.motion:null,h.motion);break;case "ZLLSwitch":this._produceEvent(this._devices[e],"levent",f?f.levent:null,h.levent);break;case "ZGPSwitch":this._produceEvent(this._devices[e],"levent",f?f.levent:null,h.levent)}}}};c.prototype._produceEvent=function(a,b,d,c){d!=c&&(console.log("receive new status",JSON.stringify({address:a.address,
key:b,value:c})),require("x.hub.eventbus.js").emit("status",{module:"hue",device:a,gateway:a.gateway,data:{key:b,value:c,oldvalue:d,changed:!0}}))};return c}();
x.hub.m.hue.Handler=function(){var c=function(){this._monitors={}};util.inherits(c,EventEmitter);c.prototype.init=function(a){a&&a()};c.prototype.getSystems=function(){return["hue"]};c.prototype.addStateDevice=function(a,b){a?a.gateway?this._startMonitor(a.gateway,function(d,c){d?b&&b({error:d}):c.addStateDevice(a,function(a){b&&b({error:a})})}):b&&b(Error("device gateway format invalid")):b&&b({error:Error("device json format invalid")})};c.prototype.getAllStates=function(){return[]};c.prototype.getStates=
function(a){return null};c.prototype.getState=function(a,b,d){a?a.gateway?x.hub.m.hue.HUE_MODULE.doStatus("xhub",a.gateway,a,{value:b},function(a,b){a?d&&d({error:a}):b?d&&d({data:{value:b.status}}):d&&d({error:Error("do status failed")})}):d&&d(Error("device gateway format invalid")):d&&d({error:Error("device json format invalid")})};c.prototype.executeCommand=function(a,b,d){x.hub.m.hue.HUE_MODULE.doCommand(a.gateway,a,b,d)};c.prototype.checkDeviceMatch=function(a,b){return b&&b.device&&a&&a.device&&
b.gateway&&a.gateway&&b.gateway.ip==a.gateway.ip?b.device.address==a.device.address:!1};c.prototype._startMonitor=function(a,b){if(a&&a.ip){var d=a.ip;if(this._monitors[d])b&&b(null,this._monitors[d]);else{var c=x.hub.m.hue.HUE_MODULE.resolveGateway(a);c?(c=new x.hub.m.hue.Monitor(c),this._monitors[d]=c,c.start(),b&&b(null,c)):b&&b(Error("hue gateway format invalid"))}}else b&&b(Error("harmony hub format invalid"))};return c}();
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.hue.Handler);
