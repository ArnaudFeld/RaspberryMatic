var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.hue=x.hub.m.hue||{};x.hub.m.hue.HUE_MODULE=require("xnm.aio.hue.js");
x.hub.m.hue.Monitor=function(){var d=function(a){this._logger=require("x.logger.js").getLogger("x.hub.m.hue.Monitor");this._running=!1;this._bridge=a;this._devices={};this._sensors={}};d.prototype.start=function(a){this._logger.log("debug","start monitor for:"+this._bridge.ip);this._running||(this._running=!0,this._getAllSensors());a&&a()};d.prototype.addStateDevice=function(a,b){a&&a.address&&(this._devices[a.address]=a);b&&b()};d.prototype._getAllSensors=function(){var a=this;this._logger.log("trace",
"get all sensors for:"+this._bridge.ip);x.hub.m.hue.HUE_MODULE.Sensor.getAllSensors(this._bridge,function(b,c){b?(a._logger.log("trace","get all sensors for:"+a._bridge.ip+" error:"+b.message),setTimeout(function(){a._getAllSensors()},1E3)):(!b&&c&&a._receiveSensors(c),a._running&&a._getAllSensors())})};d.prototype._receiveSensors=function(a){var b=function(a){for(var b={},c=0;c<a.length;c++){var e=a[c].getAddress(),d=a[c].getStates();b[e]=d}return b},c=b(this._sensors);b=b(a);this._sensors=a;for(var d=
0;d<a.length;d++){var h=a[d],g=h.getAddress();if(this._devices[g]){h=h.getType();var e=c[g],f=b[g],k=!1;if(f)switch(h){case "ZLLLightLevel":this._produceEvent(this._devices[g],"lightlevel",e?e.lightlevel:null,f.lightlevel);this._produceEvent(this._devices[g],"dark",e?e.dark:null,f.dark);this._produceEvent(this._devices[g],"daylight",e?e.daylight:null,f.daylight);this._produceEvent(this._devices[g],"battery",e?e.battery:null,f.battery);break;case "ZLLTemperature":this._produceEvent(this._devices[g],
"temperature",e?e.temperature:null,f.temperature);this._produceEvent(this._devices[g],"battery",e?e.battery:null,f.battery);break;case "ZLLPresence":this._produceEvent(this._devices[g],"motion",e?e.motion:null,f.motion);break;case "ZLLSwitch":e&&(k=!1,f.ltime!=e.ltime&&(k=!0),this._produceEvent(this._devices[g],"levent",e?e.levent:null,f.levent),f.btn1event&&this._produceEvent(this._devices[g],"btn1event",e.btn1event,f.btn1event,k),f.btn2event&&this._produceEvent(this._devices[g],"btn2event",e.btn2event,
f.btn2event,k),f.btn3event&&this._produceEvent(this._devices[g],"btn3event",e.btn3event,f.btn3event,k),f.btn4event&&this._produceEvent(this._devices[g],"btn4event",e.btn4event,f.btn4event,k),this._produceEvent(this._devices[g],"battery",e.battery,f.battery));break;case "ZGPSwitch":e&&(k=!1,f.ltime!=e.ltime&&(k=!0),this._produceEvent(this._devices[g],"levent",e?e.levent:null,f.levent,k))}}}};d.prototype._produceEvent=function(a,b,c,d,h){if(c!=d||h)this._logger.log("debug","receive new status:"+JSON.stringify({address:a.address,
key:b,value:d})),h=c,c==d&&(h=null),require("x.hub.eventbus.js").emit("status",{module:"hue",device:a,gateway:a.gateway,data:{key:b,value:d,oldvalue:h,changed:!0}})};return d}();
x.hub.m.hue.Handler=function(){var d=function(){this._monitors={}};util.inherits(d,EventEmitter);d.prototype.init=function(a){a&&a()};d.prototype.getSystems=function(){return["hue"]};d.prototype.addStateDevice=function(a,b){a?a.gateway?this._startMonitor(a.gateway,function(c,d){c?b&&b({error:c}):d.addStateDevice(a,function(a){b&&b({error:a})})}):b&&b(Error("device gateway format invalid")):b&&b({error:Error("device json format invalid")})};d.prototype.getAllStates=function(){return[]};d.prototype.getStates=
function(a){return null};d.prototype.getState=function(a,b,c){a?a.gateway?x.hub.m.hue.HUE_MODULE.doStatus("xhub",a.gateway,a,{value:b},function(a,b){a?c&&c({error:a}):b?c&&c({data:{value:b.status}}):c&&c({error:Error("do status failed")})}):c&&c(Error("device gateway format invalid")):c&&c({error:Error("device json format invalid")})};d.prototype.executeCommand=function(a,b,c){x.hub.m.hue.HUE_MODULE.doCommand(a.gateway,a,b,c)};d.prototype.checkDeviceMatch=function(a,b){return b&&b.device&&a&&a.device&&
b.gateway&&a.gateway&&b.gateway.ip==a.gateway.ip?b.device.address==a.device.address:!1};d.prototype._startMonitor=function(a,b){if(a&&a.ip){var c=a.ip;this._monitors[c]?b&&b(null,this._monitors[c]):(a=x.hub.m.hue.HUE_MODULE.resolveGateway(a))?(a=new x.hub.m.hue.Monitor(a),this._monitors[c]=a,a.start(),b&&b(null,a)):b&&b(Error("hue gateway format invalid"))}else b&&b(Error("harmony hub format invalid"))};return d}();
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.hue.Handler);
