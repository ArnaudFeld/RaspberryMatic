var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{},x.hub.m=x.hub.m||{},x.hub.m.hue=x.hub.m.hue||{},x.hub.m.hue.HUE_MODULE=require("xnm.aio.hue.js"),x.hub.m.hue.Monitor=function(){var e=function e(_e){this._logger=require("x.logger.js").getLogger("x.hub.m.hue.Monitor"),this._running=!1,this._bridge=_e,this._devices={},this._sensors={};};return e.prototype.start=function(e){this._logger.log("debug","start monitor for:"+this._bridge.ip),this._running||(this._running=!0,this._getAllSensors()),e&&e();},e.prototype.addStateDevice=function(e,t){e&&e.address&&(this._devices[e.address]=e),t&&t();},e.prototype._getAllSensors=function(){var e=this;this._logger.log("trace","get all sensors for:"+this._bridge.ip),x.hub.m.hue.HUE_MODULE.Sensor.getAllSensors(this._bridge,function(t,r){t?(e._logger.log("trace","get all sensors for:"+e._bridge.ip+" error:"+t.message),setTimeout(function(){e._getAllSensors();},1e3)):(!t&&r&&e._receiveSensors(r),e._running&&e._getAllSensors());});},e.prototype._receiveSensors=function(e){var t=function t(e){for(var t={},r=0;r<e.length;r++){var n=e[r].getAddress(),i=e[r].getStates();t[n]=i;}return t;},r=t(this._sensors),n=t(e);this._sensors=e;for(var i=0;i<e.length;i++){var s=e[i],o=s.getAddress();if(this._devices[o]){var a=s.getType(),u=r[o],v=n[o],h=!1;if(v)switch(a){case"ZLLLightLevel":this._produceEvent(this._devices[o],"lightlevel",u?u.lightlevel:null,v.lightlevel),this._produceEvent(this._devices[o],"dark",u?u.dark:null,v.dark),this._produceEvent(this._devices[o],"daylight",u?u.daylight:null,v.daylight),this._produceEvent(this._devices[o],"battery",u?u.battery:null,v.battery);break;case"ZLLTemperature":this._produceEvent(this._devices[o],"temperature",u?u.temperature:null,v.temperature),this._produceEvent(this._devices[o],"battery",u?u.battery:null,v.battery);break;case"ZLLPresence":this._produceEvent(this._devices[o],"motion",u?u.motion:null,v.motion);break;case"ZLLSwitch":u&&(h=!1,v.ltime!=u.ltime&&(h=!0),this._produceEvent(this._devices[o],"levent",u?u.levent:null,v.levent),v.btn1event&&this._produceEvent(this._devices[o],"btn1event",u.btn1event,v.btn1event,h),v.btn2event&&this._produceEvent(this._devices[o],"btn2event",u.btn2event,v.btn2event,h),v.btn3event&&this._produceEvent(this._devices[o],"btn3event",u.btn3event,v.btn3event,h),v.btn4event&&this._produceEvent(this._devices[o],"btn4event",u.btn4event,v.btn4event,h),this._produceEvent(this._devices[o],"battery",u.battery,v.battery));break;case"ZGPSwitch":u&&(h=!1,v.ltime!=u.ltime&&(h=!0),this._produceEvent(this._devices[o],"levent",u?u.levent:null,v.levent,h));}}}},e.prototype._produceEvent=function(e,t,r,n,i){if(r!=n||i){this._logger.log("debug","receive new status:"+JSON.stringify({address:e.address,key:t,value:n}));var s=r;r==n&&(s=null);var o={key:t,value:n,oldvalue:s,changed:!0};require("x.hub.eventbus.js").emit("status",{module:"hue",device:e,gateway:e.gateway,data:o});}},e;}(),x.hub.m.hue.Handler=function(){var e=function e(){this._monitors={};};return util.inherits(e,EventEmitter),e.prototype.init=function(e){e&&e();},e.prototype.getSystems=function(){return["hue"];},e.prototype.addStateDevice=function(e,t){e?e.gateway?this._startMonitor(e.gateway,function(r,n){r?t&&t({error:r}):n.addStateDevice(e,function(e){t&&t({error:e});});}):t&&t(new Error("device gateway format invalid")):t&&t({error:new Error("device json format invalid")});},e.prototype.getAllStates=function(){return[];},e.prototype.getStates=function(e){return e&&e.gateway&&e.gateway.ip,null;},e.prototype.getState=function(e,t,r){e?e.gateway?x.hub.m.hue.HUE_MODULE.doStatus("xhub",e.gateway,e,{value:t},function(e,t){e?r&&r({error:e}):t?r&&r({data:{value:t.status}}):r&&r({error:new Error("do status failed")});}):r&&r(new Error("device gateway format invalid")):r&&r({error:new Error("device json format invalid")});},e.prototype.executeCommand=function(e,t,r){x.hub.m.hue.HUE_MODULE.doCommand(e.gateway,e,t,r);},e.prototype.checkDeviceMatch=function(e,t){return!!(t&&t.device&&e&&e.device&&t.gateway&&e.gateway&&t.gateway.ip==e.gateway.ip&&t.device.address==e.device.address);},e.prototype._startMonitor=function(e,t){if(e&&e.ip){var r=e.ip;if(this._monitors[r])t&&t(null,this._monitors[r]);else{var n=x.hub.m.hue.HUE_MODULE.resolveGateway(e);if(n){var i=new x.hub.m.hue.Monitor(n);this._monitors[r]=i,i.start(),t&&t(null,i);}else t&&t(new Error("hue gateway format invalid"));}}else t&&t(new Error("harmony hub format invalid"));},e;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.hue.Handler());