var x=x||{};x.upnp=x.upnp||{};
x.upnp._DeviceCache={_cache:{},setDescLoaded:function(b,a){this._cache[b]||(this._cache[b]={});this._cache[b].loaded=a},addTarget:function(b,a){this._cache[b]&&(this._cache[b].targets||(this._cache[b].targets=[]),-1==this._cache[b].targets.indexOf(a)&&this._cache[b].targets.push(a))},putDevice:function(b,a,c){this._cache[b]||(this._cache[b]={loaded:!0});this._cache[b].device=a;this.addTarget(b,c)},getDevice:function(b){return(b=b?this._cache[b]:null)?b.device:null},getDeviceCache:function(b){return b?this._cache[b]:
null},removeDevices:function(b){for(var a=0;a<b.length;a++)delete this._cache[b[a]]},getDevices:function(){return this._cache},getDevicesWithTarget:function(b){var a=[],c;for(c in this._cache)if(this._cache.hasOwnProperty(c)){var d=this._cache[c];d.targets&&-1!=d.targets.indexOf(b)&&d.device&&a.push(d.device)}return a},removeDevicesWithTarget:function(b){var a={},c;for(c in this._cache){var d=!1,g=this._cache[c];g.targets&&-1!=g.targets.indexOf(b)&&g.device&&(d=!0);d||(a[c]=g)}this._cache=a}};
x.upnp._SSDPCache={_cache:{},putSSDP:function(b,a){if(b&&a){var c=a.getUUID();if(c){var d=a.getMaxAge(),g=Math.round((new Date).getTime()/1E3);this._cache[c]={ip:b,expire:g+d,location:a.location}}}},removeExpired:function(){var b=[],a=Math.round((new Date).getTime()/1E3),c;for(c in this._cache)if(this._cache.hasOwnProperty(c)){var d=this._cache[c].expire;-1==d?b.push(c):a>d&&b.push(c)}x.upnp._DeviceCache.removeDevices(b);for(a=0;a<b.length;a++)delete this._cache[b[a]]}};
x.upnp.SSDP=function(){var b=function(){this._usnObj=null};b.prototype.getUUID=function(){return this._usnObj?this._usnObj.uuid:null};b.prototype.getMaxAge=function(){if(!this["cache-control"])return-1;var a=this["cache-control"],a=a.replace("max-age",""),a=a.replace("=",""),a=parseInt(a.trim()),a=parseInt(a);return isNaN(a)?-1:a};b.resolve=function(a){if(!a)return null;a=a.split("\n");var c=new b;switch(a[0].trim()){case "HTTP/1.1 200 OK":c.type="RESULT";break;case "NOTIFY * HTTP/1.1":c.type="NOTIFY";
break;case "M-SEARCH * HTTP/1.1":c.type="M-SEARCH";break;default:return null}for(var d=1;d<a.length&&"\r"!=a[d];d++){var g=a[d].trim(),f=g.indexOf(":");if(-1!=f){var e=g.substr(0,f),g=g.substr(f+1);e&&(c[e.toLowerCase()]=g.trim())}}if(!c.usn)return null;c._usnObj=x.upnp.Util.parseUSN(c.usn);return c};return b}();
x.upnp.UDPListener=function(){var b=function(){"undefined"!=typeof require&&require?(this._logger=require("x.logger.js").getLogger("x.upnp.UDPListener"),require("x.logger.js").setLevel("info","x.upnp.UDPListener")):this._logger={log:{}};this._callbacks=[];this._sockets=[];var a=require("os");require("dgram");if(a&&a.networkInterfaces){var a=a.networkInterfaces(),c;for(c in a)for(var d=a[c],g=0;g<d.length;g++)this._addDiscoverSocket(d[g])}else this._addDiscoverSocket(null)};b.prototype._addDiscoverSocket=
function(a){var c=require("dgram"),d=this;a?"IPv4"==a.family&&0==a.internal&&(c=c.createSocket("udp4"),c.bind(null,a.address),c.on("message",function(a,c){d._onResponse(a,c)}),this._sockets.push(c)):(c=c.createSocket("udp4"),c.on("message",function(a,c){d._onResponse(a,c)}),this._sockets.push(c))};b.prototype.addCallback=function(a){a&&-1==this._callbacks.indexOf(a)&&this._callbacks.push(a)};b.prototype.removeCallback=function(a){a&&(a=this._callbacks.indexOf(a),-1!=a&&this._callbacks.splice(a,1))};
b.prototype.sendMessage=function(a,c,d){a=new Buffer(a);for(var g=0;g<this._sockets.length;g++)this._sockets[g].send(a,0,a.length,d,c)};b.prototype._onResponse=function(a,c){var d=a.toString();this._logger.log("trace","receive ssdp");this._logger.log("trace",d);var g=x.upnp.SSDP.resolve(d);g&&(x.upnp._SSDPCache.putSSDP(c.address,g),this._callbacks.forEach(function(a){a&&a(c.address,g)}))};return b}();
x.upnp.DescLoader=function(){var b=function(a,c){this.ip=a;this.port=80;this.uuid=c;this.subtype=this.type=this.name=null;"undefined"!=typeof require&&require?(this._logger=require("x.logger.js").getLogger("x.upnp.DescLoader"),require("x.logger.js").setLevel("info","x.upnp.DescLoader")):this._logger={log:{}}};b.prototype.load=function(a,c){var d=require("url").parse(a);d.port&&(this.port=d.port);var g=this;this._loadDeviceDesc2(a,function(a,d){if(a)c&&c(a);else{var b=g._parseDesc(d);b?c&&c(null,b):
c&&c(Error("device desc parse error"))}})};b.prototype._loadDeviceDesc=function(a,c){var d=this;this._logger.log("trace","load device descriptin from url:"+a);var g=c;$.ajax({url:a,type:"get",timeout:5E3,dataType:"text",cache:!0,success:function(a){d._logger.log("trace","http request success:"+a);g&&(g(null,a),g=null)},error:function(a,c){var b="http request error:"+(a?a.status:"0")+"-"+c;d._logger.log("trace",b);g&&(g(Error(b)),g=null)}})};b.prototype._loadDeviceDesc2=function(a,c){this._logger.log("trace",
"load device descriptin from url:"+a);var d=require("url").parse(a),d={host:d.hostname,port:d.port,path:d.path,method:"GET"},g=this,b="",e=require("http"),h=c;try{var k=e.request(d,function(a){a.on("data",function(a){b+=a});a.on("end",function(){if(200==a.statusCode)g._logger.log("trace","http request success:"+b),h&&h(null,b);else{var c="http request error:"+a.statusCode+"-"+b;g._logger.log("trace",c);h&&h(Error(c))}h=null})});k.setTimeout&&k.setTimeout(2E3,function(){k.abort()});if(k.on&&"function"==
typeof k.on)k.on("error",function(a){a||(a=Error("http request error"));h&&h(a);h=null});k.end()}catch(l){h&&h(l),h=null}};b.prototype._parseDesc=function(a){-1!=a.indexOf('xmlns:ms=" urn:microsoft-com:wmc-1-0"')&&(a=a.replace('xmlns:ms=" urn:microsoft-com:wmc-1-0"','xmlns:ms="urn:microsoft-com:wmc-1-0"'));var c=null;try{c=$($.parseXML(a))}catch(d){}if(!c)return null;a=c.find("device");if(!a||0==a.length)return null;a=$(a[0]);var g=this._parseDescXml(a);if(!g)return null;g.embeddedDevices=[];var b=
this;c.find("deviceList device").each(function(){var a=$(this);(a=b._parseDescXml(a))&&g.embeddedDevices.push(a)});return g};b.prototype._parseDescXml=function(a){if(!a)return null;var c=null,d=a.find("friendlyName");0<d.length&&(this.name=$(d[0]).text(),0==this.name.indexOf("Philips hue")?this.type="hue":0==this.name.indexOf("WeMo Switch")||0==this.name.indexOf("WeMo Insight")?(this.type="wemo",0==this.name.indexOf("WeMo Insight")&&(this.subtype="insight")):0<this.name.indexOf("Sonos")&&(this.type=
"sonos"));(d=a.find("deviceType"))&&0<d.length&&(this.deviceType=$(d[0]).text());(d=a.find("manufacturer"))&&0<d.length&&(this.manufacturer=$(d[0]).text());(d=a.find("modelName"))&&0<d.length&&(this.modelName=$(d[0]).text());(d=a.find("modelDescription"))&&0<d.length&&(this.modelDescription=$(d[0]).text());(d=a.find("serialNumber"))&&0<d.length&&(this.serialNumber=$(d[0]).text());d=a.find("UDN");0<d.length&&(c=$(d[0]).text());d=a.find("X_DLNACAP");0<d.length&&(this.X_DLNACAP=$(d[0]).text());if(!this.name||
!this.deviceType||!c)return null;6<c.length&&"uuid:"==c.substr(0,5)&&!this.uuid&&(this.uuid=c.substr(5));c=x.upnp.Util.parseURN(this.deviceType);if(!c)return null;d=null;c.device&&"MediaServer"==c.device.type?d=this.parseServer(a):c.device&&"MediaRenderer"==c.device.type?d=this.parseRenderer(a):(d=new x.upnp.Device,d.init(this.ip,this.port,this.uuid,{name:this.name,type:this.type,subtype:this.subtype,modelName:this.modelName,manufacturer:this.manufacturer,modelDescription:this.modelDescription,deviceType:this.deviceType,
dlnaCap:this.X_DLNACAP,serialNumber:this.serialNumber}));return d};b.prototype.parseServer=function(a){var c=null,d=null;a.find("serviceList service").each(function(){var a=$(this),b=a.find("serviceType"),a=a.find("controlURL");if(0<b.length&&0<a.length)if(b=$(b[0]).text(),(a=$(a[0]).text())&&"/"==a.charAt(0)||(a="/"+a),-1!=b.indexOf("ContentDirectory"))c={type:b,url:a};else if("urn:schemas-upnp-org:service:ConnectionManager:1"==b||"urn:schemas-upnp-org:service:ConnectionManager:2"==b)d={type:b,url:a}});
return c&&d?(a=new x.upnp.MediaServer,a.init(this.ip,this.port,this.uuid,{name:this.name,type:this.type,subtype:this.subtype,modelName:this.modelName,manufacturer:this.manufacturer,modelDescription:this.modelDescription,deviceType:this.deviceType,dlnaCap:this.X_DLNACAP,serialNumber:this.serialNumber}),a.contentDirectory=c,a.connectionManager=d,a):null};b.prototype.parseRenderer=function(a){var c=null,d=null,b=null,f=null,e=null;a.find("serviceList service").each(function(){var a=$(this),k=a.find("serviceType"),
a=a.find("controlURL");0<k.length&&0<a.length&&(k=$(k[0]).text(),(a=$(a[0]).text())&&"/"==a.charAt(0)||(a="/"+a),-1!=k.indexOf("GroupRenderingControl")?f={type:k,url:a}:-1!=k.indexOf("RenderingControl")?c={type:k,url:a}:-1!=k.indexOf("ConnectionManager")?d={type:k,url:a}:-1!=k.indexOf("AVTransport")?b={type:k,url:a}:-1!=k.indexOf("Queue")&&(e={type:k,url:a}))});return c&&b?(a=new x.upnp.MediaRenderer,a.init(this.ip,this.port,this.uuid,{name:this.name,type:this.type,subtype:this.subtype,modelName:this.modelName,
manufacturer:this.manufacturer,modelDescription:this.modelDescription,deviceType:this.deviceType,dlnaCap:this.X_DLNACAP,serialNumber:this.serialNumber}),a.renderingControl=c,a.connectionManager=d,a.avTransport=b,a.groupRenderingControl=f,a.queue=e,a):null};return b}();
x.upnp.DiscoveryService=function(){var b=function(a){this._udpListener=a;this._callbacks={};this._autoSearchITV=null;var c=this;this._udpListener.addCallback(function(a,b){c._onReceiveSSDP(a,b)})};b.prototype.M_SEARCH='M-SEARCH * HTTP/1.1\r\nHost: 239.255.255.250:1900\r\nMan: "ssdp:discover"\r\nMX: 5\r\n';b.prototype._findDevice=function(a,c){c&&this._callbacks["ssdp:all"]&&this._callbacks["ssdp:all"].forEach(function(a){a&&a(c)});c&&this._callbacks[a]&&this._callbacks[a].forEach(function(a){a&&a(c)})};
b.prototype.addCallback=function(a,c){a||(a="upnp:rootdevice");this._callbacks[a]||(this._callbacks[a]=[]);c&&-1==this._callbacks[a].indexOf(c)&&this._callbacks[a].push(c)};b.prototype.removeCallback=function(a,c){a||(a="upnp:rootdevice");if(this._callbacks[a]&&c){var d=this._callbacks[a].indexOf(c);-1!=d&&this._callbacks[a].splice(d,1)}};b.prototype.startAutoSearch=function(){if(!this._autoSearchITV){var a=this;this._autoSearchITV=setInterval(function(){a.discoverTarget("upnp:rootdevice")},3E4);
this.discoverTarget("upnp:rootdevice")}};b.prototype.stopAutoSearch=function(){this._autoSearchITV&&(clearInterval(this._autoSearchITV),this._autoSearchITV=null)};b.prototype.discoverWithTimeout=function(a,c){this.discoverTargetWithTimeout("upnp:rootdevice",a,c)};b.prototype.discoverTargetWithTimeout=function(a,c,d){var b=function(a){a&&b.devices.push(a)};b.devices=[];this.addCallback(a,b);var f=this;this.discoverTarget(a);setTimeout(function(){f.removeCallback(a,b);d&&d(b.devices)},c)};b.prototype.discoverTarget=
function(a){x.upnp._SSDPCache.removeExpired();x.upnp._DeviceCache.removeDevicesWithTarget(a);this._udpListener.sendMessage(this.M_SEARCH+"ST: "+a+"\r\n\r\n","239.255.255.250",1900)};b.prototype._onReceiveSSDP=function(a,c){if("RESULT"==c.type){var d=c.getUUID(),b=c.st,f=x.upnp._DeviceCache.getDeviceCache(d);if(f&&f.device)f.targets&&-1!=f.targets.indexOf(b)||(x.upnp._DeviceCache.addTarget(d,b),this._findDevice(b,f.device));else if(!f||!f.loaded){var e=this;x.upnp._DeviceCache.setDescLoaded(d,!0);
(new x.upnp.DescLoader(a,d)).load(c.location,function(a,c){a||!c?x.upnp._DeviceCache.setDescLoaded(d,!1):(x.upnp._DeviceCache.putDevice(d,c,b),e._findDevice(b,c))})}}};return b}();
x.upnp.Util={parseUSN:function(b){if(!b||5>=b.length||"uuid:"!=b.substr(0,5))return null;var a={},c=b.indexOf("::",5);if(5==c)return null;if(-1==c)return a.uuid=b.substr(5),a;a.uuid=b.substring(5,c);if(b=b.substr(c+2))a.urn=this.parseURN(b);return a},parseURN:function(b){if(!b)return null;if("upnp:rootdevice"==b.substr(0,15))return{domain:"upnp",device:{type:"rootdevice"}};if("urn:"==b.substr(0,4)){var a=null;if(b=b.substr(4))b=b.split(":"),b[0]&&(a={domain:b[0]},"device"==b[1]&&b[2]&&b[3]?a.device=
{type:b[2],ver:b[3]}:"service"==b[1]&&b[2]&&b[3]&&(a.service={type:b[2],ver:b[3]}));return a}return null},findTag:function(b,a,c){var d=b.find(a);return d&&0<d.length?d:c?(d=b.find(c+"\\:"+a))&&0<d.length?d:d=this._iterateTag(b,a,c):[]},_iterateTag:function(b,a,c){var d=[],g=b.prop("tagName");g&&(g!=a&&g!=c+":"+a||d.push(b));if((b=b.children())&&0<b.length)for(g=0;g<b.length;g++){var f=this._iterateTag($(b[g]),a,c);f&&0<f.length&&(d=d.concat(f))}return d}};
x.upnp.SOAPClient=function(){var b=function(){"undefined"!=typeof require&&require?(this._logger=require("x.logger.js").getLogger("x.upnp.SOAPClient"),require("x.logger.js").setLevel("info","x.upnp.SOAPClient")):this._logger={log:{}}};b.prototype._getSOAPMessage=function(a){return a='<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"><s:Body>'+a+"</s:Body>\n</s:Envelope>"};b.prototype.doRequest=function(a,c,d,b){d=this._getSOAPMessage(d);
var f=require("url").parse(a);c={host:f.hostname,port:f.port,path:f.path,method:"POST",headers:{"Content-Type":'text/xml; charset="utf-8"',"Content-Length":d.length,SOAPACTION:c,"User-Agent":"",Connection:"close"}};var e=this,h=require("http");c.port||(c.port=80);"https"==f.protocol&&(h=require("https"),"undefined"!=typeof process&&process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),c.port||(c.port=443));this._logger.log("trace","send post to url:"+a);this._logger.log("trace","with headers:"+
JSON.stringify(c.headers));this._logger.log("trace","with data:"+d);var k=b,l=h.request(c,function(a){var c="";a.setEncoding("utf8");a.on("data",function(a){c+=a});a.on("end",function(){e._logger.log("trace","http reponse status code:"+a.statusCode);e._logger.log("trace","http reponse:"+c);var d;200!=a.statusCode&&(d=Error("http reponse status code:"+a.statusCode));k&&k(d,c,a.statusCode);k=null})});l.setTimeout&&l.setTimeout(2E4,function(){l.abort()});if(l.on&&"function"==typeof l.on)l.on("error",
function(a){a||(a=Error("soap request error"));e._logger.log("trace","soap request error:"+a.message);k&&k(a);k=null});l.write(d);l.end()};return b}();
x.upnp.Device=function(){var b=function(){this.serialNumber=this.modelDescription=this.manufacturer=this.modelName=this.deviceType=this.subtype=this.type=this.name=this.uuid=this.port=this.ip=null};b.prototype.init=function(a,c,d,b){this.ip=a;this.port=c;this.uuid=d;for(var f in b)b.hasOwnProperty(f)&&(this[f]=b[f])};b.prototype._parseItemMetaData=function(a){var c=null,d=null,b=null;(b=a.find("container"))&&b[0]&&(d=$(b[0]),b=d.getAttributes(),c=JSON.parse(JSON.stringify(b)));(a=a.find("item"))&&
a[0]&&(d=$(a[0]),b=d.getAttributes(),c=JSON.parse(JSON.stringify(b)));if(d)for(d=d.children(),a=0;a<d.length;a++)if(b=$(d[a])){var f=b.prop("tagName"),e=f.indexOf(":");-1!=e&&(f=f.substr(e+1));c[f]=b.text()}return c};b.prototype._maskMetaData=function(a){a=a.replace(/&/g,"&amp;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");a=a.replace(/'/g,"&apos;");a=a.replace(/\r/g,"");a=a.replace(/\n/g,"");return a=a.replace(/\t/g,"")};b.prototype._unmaskMetaData=function(a){if(!a)return a;a=a.replace(/&lt;/g,
"<");a=a.replace(/&gt;/g,">");a=a.replace(/&amp;/g,"&");a=a.replace(/&quot;/g,'"');return a=a.replace(/&apos;/g,"'")};b.prototype._parseSOAPResponse=function(a,c){if(!a)return null;var b;try{b=$($.parseXML(a))}catch(g){return null}return b?(b=x.upnp.Util.findTag(b,c,"u"))&&0<b.length?$(b[0]):null:null};b.prototype.getURL=function(a){var c="http://"+this.ip;this.port&&80!=this.port&&(c+=":"+this.port);return c+a};b.prototype._getDuration=function(a){var c=a.split(":");3==c.length&&(a=3600*parseInt(c[0])+
60*parseInt(c[1])+parseInt(c[2]));return a};b.prototype._doSOAPRequest=function(a,c,b,g,f){var e="<u:"+b+' xmlns:u="'+c+'">',h;for(h in g)if(g.hasOwnProperty(h))var k=g[h]+"",e=e+("<"+h+">"+(k?this._maskMetaData(k):"")+"</"+h+">");var l=this;this._doRequest(a,'"'+c+"#"+b+'"',e+("</u:"+b+">"),function(a,c){if(a)f&&f(a);else{var e=l._parseSOAPResponse(c,b+"Response");e?f&&f(null,e):f&&f(Error(b+" reponse format invalid"))}})};b.prototype._doRequest=function(a,c,b,g){(new x.upnp.SOAPClient).doRequest(a,
c,b,function(a,c){g&&g(null,c)})};return b}();
x.upnp.MediaServer=function(){var b=function(){this.connectionManager=this.contentDirectory=null};b.prototype=new x.upnp.Device;b.prototype.constructor=b;b.prototype.search=function(a,c,b,g){var f=this;c||(c="dc:title,upnp:artist,upnp:album,upnp:albumArtURI,res,res@protocolInfo,res@duration,res@resolution,res@size");var e;e='<u:Search xmlns:u="urn:schemas-upnp-org:service:ContentDirectory:1"><ContainerID>0</ContainerID>'+("<SearchCriteria>"+a+"</SearchCriteria>");e+="<Filter>"+c+"</Filter>";e+="<StartingIndex>"+
b+"</StartingIndex>";e+="<RequestedCount>"+this.chunkSize+"</RequestedCount>";e+="<SortCriteria></SortCriteria>";e+="</u:Search>";(new XCUPNPSOAPRequest).doRequest(this.getURL(this.contentDirectory),'"urn:schemas-upnp-org:service:ContentDirectory:1#Search"',e,function(e){if(e=f._parseSOAPResponse(e,!0)){var k=0,l=[];try{var m=$($.parseXML(e)),l=f._getItems(m),k=$(m.children()[0]).children().length}catch(n){}k==f.chunkSize?(setTimeout(function(){f.search(a,c,b+f.chunkSize,g)},0),g(l,!1)):g(l,!0)}})};
b.prototype.browseMetaData=function(a,c){this._browseMetaData(a,function(a,b){a?c&&c(a):b&&b?c&&c(a,b):c&&c(Error("meta data invalid"))})};b.prototype.browseChildren=function(a,c,b,g,f){this._browseChildren(a,"*",c,b,null,function(a,c){if(a)f&&f(a);else if(c&&c.result){for(var b=[],d=0;d<c.result.length;d++){var m=c.result[d];g&&m["class"]?"object.container"==m["class"]?b.push(m):-1!=g.indexOf(m["class"])&&b.push(m):b.push(m)}f&&f(null,b,c.totalMatches)}else f&&f(null,[],0)})};b.prototype._getRes=
function(a){var c=null,b=0;a.find("res").each(function(){var a=$(this),f=a.attr("size");if(!c||f&&f>b)c=a,b=f});return c};b.prototype._getItems=function(a){var c=[],b=this;a.find("container").each(function(){var a=$(this),f=x.upnp.Util.findTag(a,"title","dc"),e=x.upnp.Util.findTag(a,"class","upnp");if(0<e.length&&0<f.length){e=$(e[0]).text();f=$(f[0]).text();f={type:"container","class":e,parentID:a.attr("parentID"),id:a.attr("id"),title:f};if(e=b._getRes(a)){var h=e.text(),k=null;e.attr("duration")&&
(k=b._getDuration(e.attr("duration")));f.res={url:h,dur:k}}a=x.upnp.Util.findTag(a,"albumArtURI","upnp");0<a.length&&(f.albumArtURI=$(a[0]).text());c.push(f)}});a.find("item").each(function(){var a=$(this),f=x.upnp.Util.findTag(a,"class","upnp"),e=x.upnp.Util.findTag(a,"title","dc");if(0<f.length&&0<e.length){var f=$(f[0]).text(),e=$(e[0]).text(),e={type:"item",parentID:a.attr("parentID"),id:a.attr("id"),"class":f,title:e},h=b._getRes(a,f);if(h){var k=h.text(),l=null;h.attr("duration")&&(l=b._getDuration(h.attr("duration")));
e.res={url:k,dur:l}}0==f.indexOf("object.item.audioItem")&&(e.info={},f=x.upnp.Util.findTag(a,"genre","upnp"),0<f.length&&(e.info.genre=$(f[0]).text()),f=x.upnp.Util.findTag(a,"artist","upnp"),0<f.length&&(e.info.artist=$(f[0]).text()),f=x.upnp.Util.findTag(a,"album","upnp"),0<f.length&&(e.info.album=$(f[0]).text()),f=x.upnp.Util.findTag(a,"albumArtURI","upnp"),0<f.length&&(e.info.albumArtURI=$(f[0]).text()));c.push(e)}});return c};b.prototype._browseMetaData=function(a,c){var b=this;this._browse(a,
"BrowseMetadata","*",0,0,null,function(a,f){if(a)c&&c(a);else{if(f.result)try{var e=$($.parseXML(f.result));f.meta=b._parseItemMetaData(e)}catch(h){c&&c(h);return}c(null,f)}})};b.prototype._browseChildren=function(a,c,b,g,f,e){var h=this;this._browse(a,"BrowseDirectChildren",c,b,g,f,function(a,c){if(a)e&&e(a);else{if(c.result)try{var b=$($.parseXML(c.result));c.result=h._getItems(b)}catch(d){e&&e(d);return}e(null,c)}})};b.prototype._browse=function(a,c,b,g,f,e,h){c||(c="BrowseDirectChildren");b||
(b="");e||(e="");a={ObjectID:a,BrowseFlag:c,Filter:b,StartingIndex:g,RequestedCount:f,SortCriteria:e};this._doSOAPRequest(this.getURL(this.contentDirectory.url),this.contentDirectory.type,"Browse",a,function(a,c){if(a)h&&h(a);else{var b={},d=c.find("Result");d&&0<d.length&&(b.result=$(d[0]).text());(d=c.find("NumberReturned"))&&0<d.length&&(b.numberReturned=$(d[0]).text());(d=c.find("TotalMatches"))&&0<d.length&&(b.totalMatches=$(d[0]).text());(d=c.find("UpdateID"))&&0<d.length&&(b.updateID=$(d[0]).text());
h&&h(null,b)}})};return b}();
x.upnp.MediaRenderer=function(){var b=function(){this.avTransport=this.connectionManager=this.renderingControl=null};b.prototype=new x.upnp.Device;b.prototype.constructor=b;b.prototype.PLAY_MODE="NORMAL SHUFFLE REPEAT_ONE REPEAT_ALL RANDOM DIRECT_1 INTRO".split(" ");b.prototype.TRANSPORT_STATE="STOPPED PLAYING TRANSITIONING PAUSED_PLAYBACK PAUSED_RECORDING RECORDING NO_MEDIA_PRESENT".split(" ");b.prototype.getPlayState=function(a){this.getPlayState_cbs||(this.getPlayState_cbs=[]);var c=this.getPlayState_cbs.length;
a&&-1==this.getPlayState_cbs.indexOf(a)&&this.getPlayState_cbs.push(a);if(0==c){var b=this,g=function(a,c){var g=b.getPlayState_cbs;b.getPlayState_cbs=[];g.forEach(function(b){b&&b(a,c)})};this._getTransportInfo(0,function(a,b){g&&g(a,b?b.currentTransportState:null)})}};b.prototype.getPlayInfo=function(a){this.getPlayInfo_cbs||(this.getPlayInfo_cbs=[]);var b=this.getPlayInfo_cbs.length;a&&-1==this.getPlayInfo_cbs.indexOf(a)&&this.getPlayInfo_cbs.push(a);if(0==b){var d=function(a,b){var c=g.getPlayInfo_cbs;
g.getPlayInfo_cbs=[];c.forEach(function(c){c&&c(a,b)})},g=this;this._getPositionInfo(0,function(a,b){if(a)d&&d(a);else{var c={};b.trackDuration&&(c.duration=b.trackDuration,c.durationSec=g._getDuration(b.trackDuration));b.relTime&&(c.position=b.relTime,c.positionSec=g._getDuration(b.relTime));c.trackMetaDataRaw=b.trackMetaDataRaw;c.trackMetaData=b.trackMetaData;d&&d(null,c)}})}};b.prototype.getMediaInfo=function(a){this.getMediaInfo_cbs||(this.getMediaInfo_cbs=[]);var b=this.getMediaInfo_cbs.length;
a&&-1==this.getMediaInfo_cbs.indexOf(a)&&this.getMediaInfo_cbs.push(a);if(0==b){var d=function(a,b){var c=g.getMediaInfo_cbs;g.getMediaInfo_cbs=[];c.forEach(function(c){c&&c(a,b)})},g=this;this._getMediaInfo(0,function(a,b){d&&d(a,b)})}};b.prototype.getPlayMode=function(a){this.getPlayMode_cbs||(this.getPlayMode_cbs=[]);var b=this.getPlayMode_cbs.length;a&&-1==this.getPlayMode_cbs.indexOf(a)&&this.getPlayMode_cbs.push(a);if(0==b){var d=function(a,b){var c=g.getPlayMode_cbs;g.getPlayMode_cbs=[];c.forEach(function(c){c&&
c(a,b)})},g=this;this._getTransportSettings(0,function(a,b){d&&d(a,b?b.playMode:null)})}};b.prototype.playResource=function(a,b,d){var g=this;this._setAVTransportURI(0,a.url,b,function(a){a?d&&d(a):g.play(d)})};b.prototype.playContainer=function(a,b,d){var g="dlna-playcontainer://"+encodeURIComponent("uuid:"+a.server_uuid)+"?sid="+encodeURIComponent("urn:upnp-org:serviceId:ContentDirectory")+"&cid="+encodeURIComponent(a.containerID)+"&md=0";"undefined"!=typeof a.firstIdx&&null!=a.firstIdx&&(g+="&fii="+
a.firstIdx);var f=this;this._setAVTransportURI(0,g,b,function(a){a?d&&d(a):f.play(d)})};b.prototype.play=function(a){this._play(0,1,a)};b.prototype.pause=function(a){this._pause(0,a)};b.prototype.stop=function(a){this._stop(0,a)};b.prototype.previous=function(a){this._previous(0,1,a)};b.prototype.next=function(a){this._next(0,1,a)};b.prototype.seekRelTime=function(a,b){this._seek(0,"REL_TIME",a,b)};b.prototype.seekRelTimeSec=function(a,b){for(var d=a%60,g=(a-d)/60%60,f=(a-d-60*g)/3600,d=d+"";2>d.length;)d=
"0"+d;for(g+="";2>g.length;)g="0"+g;for(f+="";2>f.length;)f="0"+f;this._seek(0,"REL_TIME",f+":"+g+":"+d,b)};b.prototype.seekTrack=function(a,b){this._seek(0,"TRACK_NR",a,b)};b.prototype.setPlayMode=function(a,b){this._setPlayMode(0,a,b)};b.prototype.mute=function(a){this._setMute(0,"Master",1,a)};b.prototype.unmute=function(a){this._setMute(0,"Master",0,a)};b.prototype.toggleMute=function(a){var b=this;this.isMuted(function(d,g){d?a&&a(d):g?b.unmute(a):b.mute(a)})};b.prototype.isMuted=function(a){this.isMuted_cbs||
(this.isMuted_cbs=[]);var b=this.isMuted_cbs.length;a&&-1==this.isMuted_cbs.indexOf(a)&&this.isMuted_cbs.push(a);if(0==b){var d=function(a,b){var c=g.isMuted_cbs;g.isMuted_cbs=[];c.forEach(function(c){c&&c(a,b)})},g=this;this._getMute(0,"Master",function(a,b){a?d&&d(a):d&&d(null,"1"==b.mute)})}};b.prototype.setVolume=function(a,b){a=parseInt(a);0>a&&(a=0);100<a&&(a=100);this._setVolume(0,"Master",a,b)};b.prototype.volumeUp=function(a){var b=this;this.getVolume(function(d,g){d||100==g?a&&a(d):b.setVolume(g+
5,a)})};b.prototype.volumeDown=function(a){var b=this;this.getVolume(function(d,g){d||0==g?a&&a(d):b.setVolume(g-5,a)})};b.prototype.getVolume=function(a){this.getVolume_cbs||(this.getVolume_cbs=[]);var b=this.getVolume_cbs.length;a&&-1==this.getVolume_cbs.indexOf(a)&&this.getVolume_cbs.push(a);if(0==b){var d=function(a,b){var c=g.getVolume_cbs;g.getVolume_cbs=[];c.forEach(function(c){c&&c(a,b)})},g=this;this._getVolume(0,"Master",function(a,b){a?d&&d(a):d&&d(null,parseInt(b.volume))})}};b.prototype._setAVTransportURI=
function(a,b,d,g){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"SetAVTransportURI",{InstanceID:a,CurrentURI:b,CurrentURIMetaData:d},g)};b.prototype._seek=function(a,b,d,g){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"Seek",{InstanceID:a,Unit:b,Target:d},g)};b.prototype._play=function(a,b,d){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"Play",{InstanceID:a,Speed:b},d)};b.prototype._pause=function(a,b){this._doSOAPRequest(this.getURL(this.avTransport.url),
this.avTransport.type,"Pause",{InstanceID:a},b)};b.prototype._stop=function(a,b){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"Stop",{InstanceID:a},b)};b.prototype._previous=function(a,b,d){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"Previous",{InstanceID:a,Speed:b},d)};b.prototype._next=function(a,b,d){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"Next",{InstanceID:a,Speed:b},d)};b.prototype._setPlayMode=
function(a,b,d){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"SetPlayMode",{InstanceID:a,NewPlayMode:b},d)};b.prototype._getTransportInfo=function(a,b){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"GetTransportInfo",{InstanceID:a},function(a,g){if(a)b&&b(a);else{var f={},e=g.find("CurrentTransportState");0<e.length&&(f.currentTransportState=$(e[0]).text());e=g.find("CurrentTransportStatus");0<e.length&&(f.currentTransportStatus=$(e[0]).text());
e=g.find("CurrentSpeed");0<e.length&&(f.currentSpeed=$(e[0]).text());b&&b(null,f)}})};b.prototype._getPositionInfo=function(a,b){var d=this;this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"GetPositionInfo",{InstanceID:a},function(a,f){if(a)b&&b(a);else{var e={},h=f.find("Track");0<h.length&&(e.track=$(h[0]).text());h=f.find("TrackDuration");0<h.length&&(e.trackDuration=$(h[0]).text());h=f.find("TrackMetaData");if(0<h.length)if(h=$(h[0]).text())try{var k=$($.parseXML(h));
e.trackMetaDataRaw=k;e.trackMetaData=d._parseItemMetaData(k)}catch(l){b&&b(l);return}else e.trackMetaDataRaw="",e.trackMetaData=null;h=f.find("TrackURI");0<h.length&&(e.trackURI=$(h[0]).text());h=f.find("RelTime");0<h.length&&(e.relTime=$(h[0]).text());h=f.find("AbsTime");0<h.length&&(e.absTime=$(h[0]).text());h=f.find("RelCount");0<h.length&&(e.relCount=$(h[0]).text());h=f.find("AbsCount");0<h.length&&(e.absCount=$(h[0]).text());b&&b(null,e)}})};b.prototype._getMediaInfo=function(a,b){var d=this;
this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"GetMediaInfo",{InstanceID:a},function(a,f){if(a)b&&b(a);else{var e,h,k={};e=f.find("NrTracks");0<e.length&&(k.nrTracks=$(e[0]).text());e=f.find("MediaDuration");0<e.length&&(k.mediaDuration=$(e[0]).text());e=f.find("CurrentURI");0<e.length&&(k.currentURI=$(e[0]).text());e=f.find("CurrentURIMetaData");if(0<e.length)if((e=$(e[0]).text())&&"null"!=e.toLowerCase())try{h=$($.parseXML(e)),k.currentURIMetaDataRaw=h,k.currentURIMetaData=
d._parseItemMetaData(h)}catch(l){b&&b(l);return}else k.currentURIMetaDataRaw="",k.currentURIMetaData=null;e=f.find("NextURI");0<e.length&&(k.nextURI=$(e[0]).text());e=f.find("NextURIMetaData");if(0<e.length)if(e=$(e[0]).text())try{h=$($.parseXML(e)),k.nextURIMetaDataRaw=h,k.nextURIMetaData=d._parseItemMetaData(h)}catch(m){b&&b(m);return}else k.nextURIMetaDataRaw="",k.nextURIMetaData=null;e=f.find("PlayMedium");0<e.length&&(k.playMedium=$(e[0]).text());e=f.find("RecordMedium");0<e.length&&(k.ecordMedium=
$(e[0]).text());e=f.find("WriteStatus");0<e.length&&(k.writeStatus=$(e[0]).text());b&&b(null,k)}})};b.prototype._getTransportSettings=function(a,b){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"GetTransportSettings",{InstanceID:a},function(a,g){if(a)b&&b(a);else{var f={},e=g.find("PlayMode");0<e.length&&(f.playMode=$(e[0]).text());e=g.find("RecQualityMode");0<e.length&&(f.recQualityMode=$(e[0]).text());b&&b(null,f)}})};b.prototype._setMute=function(a,b,d,g){this._doSOAPRequest(this.getURL(this.renderingControl.url),
this.renderingControl.type,"SetMute",{InstanceID:a,Channel:b,DesiredMute:d},g)};b.prototype._getMute=function(a,b,d){this._doSOAPRequest(this.getURL(this.renderingControl.url),this.renderingControl.type,"GetMute",{InstanceID:a,Channel:b},function(a,b){if(a)d&&d(a);else{var c={},h=b.find("CurrentMute");0<h.length&&(c.mute=$(h[0]).text());d&&d(null,c)}})};b.prototype._setVolume=function(a,b,d,g){this._doSOAPRequest(this.getURL(this.renderingControl.url),this.renderingControl.type,"SetVolume",{InstanceID:a,
Channel:b,DesiredVolume:d},g)};b.prototype._getVolume=function(a,b,d){this._doSOAPRequest(this.getURL(this.renderingControl.url),this.renderingControl.type,"GetVolume",{InstanceID:a,Channel:b},function(a,b){if(a)d&&d(a);else{var c={},h=b.find("CurrentVolume");0<h.length&&(c.volume=$(h[0]).text());d&&d(null,c)}})};return b}();
x.upnp.XCUPNP=function(){var b=function(){this._udpListener=new x.upnp.UDPListener;this._discoveryService=new x.upnp.DiscoveryService(this._udpListener)};b.prototype.MediaServer=x.upnp.MediaServer;b.prototype.MediaRenderer=x.upnp.MediaRenderer;b.prototype.Device=x.upnp.Device;b.prototype.DescLoader=x.upnp.DescLoader;b.prototype.discoverDevices=function(a){this.discoverTargetWithTimeout("upnp:rootdevice",5E3,a)};b.prototype.discoverDevicesWithTarget=function(a,b){this.discoverTargetWithTimeout(a,5E3,
b)};b.prototype.discoverDevicesWithTimeout=function(a,b){this.discoverTargetWithTimeout("upnp:rootdevice",a,b)};b.prototype.discoverTargetWithTimeout=function(a,b,d){this._discoveryService.addCallback(a,d);this._discoveryService.discoverTarget(a);var g=this;setTimeout(function(){g._discoveryService.removeCallback(a,d)},b)};b.prototype.getDiscoveryService=function(){return this._discoveryService};return b}();var XCUPNP=x.upnp.XCUPNP;
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.upnp.XCUPNP);
