var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.m10T=xnm.aio.m10T||{};xnm.aio.m10T.IBus=function(c,d,b){this._type=c;this._host=d;this._port=b;this._socket=null;this._timeout=2E3;this._callback=null};
xnm.aio.m10T.IBus.prototype._openSocket=function(c){var d=c;this._socket=require("net").connect({port:this._port,host:this._host});this._socket.setTimeout(this._timeout);this._socket.setEncoding("binary");var b=this;this._socket.on("connect",function(){var a=new Buffer(b._type);b._socket.write(a)});this._socket.on("data",function(a){a=new Buffer(a,"binary");var c=[];if(2<=a.length&&79==a[0]&&75==a[1])if(d)b._socket.write(new Buffer(d)),d=null;else{if(3<a.length)for(var f=3;f<a.length;f++)c.push(a[f]);
b._callback&&b._callback({error:null,data:c})}else b._callback&&b._callback({error:"socket data error",data:null})});this._socket.on("error",function(a){b._socket.destroy();b._socket=null;b._callback&&b._callback({error:"socket error",data:null})});this._socket.on("timeout",function(){b._socket.destroy();b._socket=null;b._callback&&b._callback({error:"socket timeout",data:null})});this._socket.on("close",function(){b._socket=null});this._socket._doConnect&&"function"==typeof this._socket._doConnect&&
this._socket._doConnect()};xnm.aio.m10T.IBus.prototype.send=function(c,d,b){this._callback=b;c=d?[87,58].concat(d).concat(c):[87,58].concat(c);this._socket?this._socket.write(new Buffer(c)):this._openSocket(c)};xnm.aio.m10T.IBus.prototype.receive=function(c,d,b){if("SPI"==this._type){d=[];for(var a=0;a<c;a++)d.push(0);this.send(d,null,function(a){b&&b(a)})}else this._callback=b,bytes=[82,58].concat([d,c]),this._socket?this._socket.write(new Buffer(bytes)):this._openSocket(bytes)};
xnm.aio.m10T.IBus.prototype.end=function(){this._socket&&(this._socket.write(new Buffer("E:")),this._socket.destroy(),this._socket=null)};xnm.aio.m10T.STMSPIBootloader=function(c){this._spi=c;this._retryCnt=0};xnm.aio.m10T.STMSPIBootloader.prototype.start=function(c){var d=this;this._spi.send([90,0,0,121],null,function(b){b.data&&4==b.data.length&&121==b.data[2]?c&&c(!0):40>d._retryCnt++?setTimeout(function(){d.start(c)},100):c&&c(!1)})};
xnm.aio.m10T.STMSPIBootloader.prototype.sendGet=function(c){var d=this;this._spi.send([90,0,255,0,0,121],null,function(b){b.data&&6==b.data.length&&121==b.data[4]?d._spi.receive(14,null,function(b){c&&c(b.data)}):c&&c()})};
xnm.aio.m10T.STMSPIBootloader.prototype.readFlash=function(c,d){var b=c>>0&255,a=c>>8&255,e=c>>16&255;c=c>>24&255;var f=this;this._spi.send([90,17,238,0,0,121,c,e,a,b,c^e^a^b,0,0,121,255,0,0,0,121],null,function(b){b.data&&19==b.data.length&&121==b.data[4]&&121==b.data[12]&&121==b.data[17]?f._spi.receive(257,null,function(b){d&&d(b.data)}):d&&d()})};
xnm.aio.m10T.STMSPIBootloader.prototype.eraseFlash=function(c){var d=this;this._spi.send([90,68,187,0,0,121,255,255,0],null,function(b){b.data&&9==b.data.length&&121==b.data[4]?d._waitForACK(1E3,10,c):c&&c()})};
xnm.aio.m10T.STMSPIBootloader.prototype.writeFlash=function(c,d,b){var a=c>>0&255,e=c>>8&255,f=c>>16&255;c=c>>24&255;var g=c^f^e^a,h=this;this._spi.send([90,49,206,0,0,121,c,f,e,a,g,0,0,121],null,function(a){if(a.data&&14==a.data.length&&121==a.data[4]&&121==a.data[12]){a=[d.length-1].concat(d);for(var c=g=0;c<a.length;c++)g^=a[c];a=a.concat([g]);h._spi.send(a,null,function(a){h._waitForACK(100,5,b)})}else b&&b()})};xnm.aio.m10T.STMSPIBootloader.prototype.end=function(){this._spi.end()};
xnm.aio.m10T.STMSPIBootloader.prototype._waitForACK=function(c,d,b){if(1>d)b&&b(!1);else{var a=this;setTimeout(function(){a._spi.send([0,0,121],null,function(e){e.data&&121==e.data[1]?b&&b(!0):a._waitForACK(c,d-1,b)})},c)}};xnm.aio.m10T.STMUpdater=function(c,d,b){this._file=c;this._host=this._bootloader=null;this.hostType="A20";this.auth=this.at=null;this._offset=0;d&&(this._offset=d);this._fixedSize=b;this._callback=null;this._retries=this._bytesWritten=this._bytesToWrite=0};
xnm.aio.m10T.STMUpdater.prototype._writeNextBlock=function(){var c=this;require("fs").readFileBinary(this._file,this._offset+this._bytesWritten,256,function(d,b){if(!d&&b){d=[];b=new Buffer(XC.getBytes(b,!0));for(d=Array.prototype.slice.call(b,0);256>d.length;)d.push(255);var a=!1;c._bootloader.writeFlash(134217728+c._bytesWritten,d,function(b){a||(a=!0,b?(c._retries=0,c._bytesWritten+=256,c._bytesWritten>=c._bytesToWrite?(c._bootloader.end(),c._resetViaNet(!1,function(){c._callback&&c._callback({error:null,
state:100})})):(c._callback&&c._callback({error:null,state:Math.floor(c._bytesWritten/c._bytesToWrite*100)}),c._writeNextBlock())):12>c._retries?(c._retries++,setTimeout(function(){c._writeNextBlock()},500)):(c._bootloader.end(),c._callback&&c._callback({error:"failed to write ("+c._bytesWritten+")",state:0})))})}else c._callback&&(c._bootloader.end(),c._callback&&c._callback({error:"failed to read file ("+c._bytesWritten+")",state:0}))})};
xnm.aio.m10T.STMUpdater.prototype._resetViaNet=function(c,d){var b="";this.at?b="&at="+this.at:this.auth&&(b="&auth="+this.auth);var a=3;c&&(a=0);var e=this;$.ajax({type:"GET",url:"http://"+e._host+"/set?io0="+a+b,timeout:2E3,cache:!1,complete:function(a){$.ajax({type:"GET",url:"http://"+e._host+"/set?io3=0&t=50"+b,timeout:2E3,cache:!1,complete:function(b){d&&d()}})}})};
xnm.aio.m10T.STMUpdater.prototype._startSPIBootloader=function(c){var d="http://"+this._host+"/custom/startSPIBL";this.at?d+="?at="+this.at:this.auth&&(d+="?auth="+this.auth);$.ajax({type:"GET",url:d,timeout:3E3,cache:!1,complete:function(b){b&&b.responseText&&(b=b.responseText);if(b){var a=null;try{a=$.parseJSON(b)}catch(e){}if(a&&a.XC_SUC){c&&c(!0);return}}c&&c(!1)}})};
xnm.aio.m10T.STMUpdater.prototype.startNetUpdate=function(c,d){var b=new xnm.aio.m10T.IBus("SPI",c,8081);this._bootloader=new xnm.aio.m10T.STMSPIBootloader(b);this._host=c;this._callback=d;this._bytesWritten=this._bytesToWrite=0;var a=this;require("fs").stat(this._file,function(b,c){b?d&&d({error:"invalid update file",state:0}):(a._bytesToWrite=a._fixedSize?a._fixedSize:c.size,a._startSPIBootloader(function(b){b?a._bootloader.eraseFlash(function(b){b?a._writeNextBlock():(a._bootloader.end(),d&&d({error:"failed to erase flash",
state:0}))}):(a._bootloader.end(),d&&d({error:"failed to start bootloader",state:0}))}))})};
xnm.aio.m10T.STMUpdater.prototype.startDFUUpdate=function(c,d){this._callback=d;this._bytesWritten=this._bytesToWrite=0;if(!require("fs").existsSync(this._file)&&d)d({error:"invalid dfu file",state:0});else{c='"'+c+'" -t 1024 -d 0483:df11 -a 0 -s 0x08000000:leave -D '+this._file;d=require("child_process").exec;c=d(c);var b=this;c.stdout.on("data",function(a){a=""+a;if("."==a)b._bytesWritten+=1024,b._callback&&(a=Math.floor(b._bytesWritten/b._bytesToWrite*100),b._callback({error:null,state:a}));else if(a&&
1<a.length&&"-"==a.charAt(0))a=a.substr(1),b._callback&&"100"!=a&&b._callback({error:null,state:a});else if(a&&1===a.indexOf("Download"))a=a.split("%")[0].split(" "),a=Number(a[a.length-1]),b._callback&&!isNaN(a)&&100!=a&&b._callback({error:null,state:a});else if(a){var d=a.indexOf(", size = ");-1<d&&(b._bytesToWrite=parseInt(a.substr(d+9)))}});c.on("error",function(a){b._callback&&b._callback({error:"failed to start dfu-util",state:0})});c.on("close",function(a){0==a||74==a&&100==lastProgress?b._callback&&
b._callback({error:null,state:100}):b._callback&&b._callback({error:"failed to flash via dfu-util",state:0})})}};xnm.aio.m10T.STMUpdater.prototype.resetST=function(c){var d=require("child_process").exec,b="/sys/class/gpio/gpio240/value",a="/sys/class/gpio/gpio241/value";"PI2"==this.hostType&&(b="/sys/class/gpio/gpio21/value",a="/sys/class/gpio/gpio20/value");c?d("echo 1 > "+b):d("echo 0 > "+b);d("echo 1 > "+a);d("echo 0 > "+a);d("echo 1 > "+a);d("echo 0 > "+b)};
xnm.aio.m10T.STMUpdater.prototype.startSPIUpdate=function(c,d){this._bootloader=new xnm.aio.m10T.STMSPIBootloader(c);this._callback=d;this._bytesWritten=this._bytesToWrite=0;var b=this;require("fs").stat(this._file,function(a,c){a?d&&d({error:"invalid update file",state:0}):(b.resetST(!0),b._bytesToWrite=b._fixedSize?b._fixedSize:c.size,b._bootloader.start(function(a){a?b._bootloader.eraseFlash(function(a){a?b._writeNextBlock():(b._bootloader.end(),d&&d({error:"failed to erase flash",state:0}))}):
(b._bootloader.end(),d&&d({error:"failed to start bootloader",state:0}))}))})};xnm.aio.m10T.STMUSBSerial=function(){this._onTimeout=this._onData=this._onError=this._timeoutTimer=this._serialPort=this._port=null;this._useChromeAPI=!1;this._connId=this._connectionInfo=null;try{require("serialport")}catch(c){console.warn(c),"undefined"!==typeof chrome&&"undefined"!==typeof chrome.serial&&(this._useChromeAPI=!0)}};
xnm.aio.m10T.STMUSBSerial.prototype.on=function(c,d){"error"==c?this._onError=d:"data"==c?this._onData=d:"timeout"==c&&(this._onTimeout=d)};
xnm.aio.m10T.STMUSBSerial.prototype.open=function(c,d,b){b||(b=230400);if(this._useChromeAPI)this._chromeOpen(c,d,b);else{this._port=c;this._baudrate=b;var a=require("serialport");if(a){this._serialPort=a.SerialPort?new a.SerialPort(c,{baudrate:b}):new a(c,{baudRate:b});var e=this;this._serialPort.on("open",function(){d&&d();e._serialPort.flush();e._serialPort.on("data",function(b){e._timeoutTimer&&(clearTimeout(e._timeoutTimer),e._timeoutTimer=null);e._onData&&e._onData(b)})});this._serialPort.on("error",
function(){e._serialPort=null;e._timeoutTimer&&(clearTimeout(e._timeoutTimer),e._timeoutTimer=null);e._onError&&e._onError()})}else e._onError&&e._onError()}};xnm.aio.m10T.STMUSBSerial.prototype.write=function(c,d,b){if(this._useChromeAPI)this._chromeWrite(c,d,b);else if(this._serialPort){var a=this;this._serialPort.write(c,function(a){a&&console.error(a);b&&b(a)});d&&(this._timeoutTimer&&clearTimeout(this._timeoutTimer),this._timeoutTimer=setTimeout(function(){a._onTimeout&&a._onTimeout()},d))}};
xnm.aio.m10T.STMUSBSerial.prototype.flush=function(){this._useChromeAPI?this._chromeFlush():this._serialPort&&this._serialPort.flush()};xnm.aio.m10T.STMUSBSerial.prototype.close=function(){this._useChromeAPI?this._chromeClose():(this._serialPort&&this._serialPort.close(),this._timeoutTimer&&(clearTimeout(this._timeoutTimer),this._timeoutTimer=null),this._onTimeout=this._onData=this._onError=null)};
xnm.aio.m10T.STMUSBSerial.prototype.generateCommandMessage=function(c,d){var b=c;if(d){b=[31];b.push(d);for(d=0;d<c.length;d++)if("string"==typeof c)b.push(c.charCodeAt(d));else{var a=c[d];31!=a&&4!=a&&27!=a||b.push(27);b.push(a)}b.push(0);b.push(4)}return b};
xnm.aio.m10T.STMUSBSerial.prototype._chromeOpen=function(c,d,b){var a=this;null!==this._connId||this._port?console.warn("Serial port connection already open."):"darwin"===process.platform&&0>String(c).indexOf("/tty.")?console.warn('[STMUSBSerial._chromeOpen] Port does not contain "tty", ignoring:',c):(this._port=c,this._baudrate=b,b={bitrate:this._baudrate,persistent:!0},chrome.serial.onReceiveError.addListener(function(b){console.error("[STMUSBSerial._chromeOpen] Error. Current connection: "+a._connId,
b);a._onError&&a._onError();a._chromeClose()}),chrome.serial.connect(c,b,function(b){b?(console.log("[STMUSBSerial._chromeOpen] Connection info:",b),a._connectionInfo=b,a._connId=b.connectionId,chrome.serial.onReceive.addListener(function(b){console.debug("[STMUSBSerial._chromeOpen] Received:",b);b&&b.connectionId===a._connId&&(a._timeoutTimer&&(clearTimeout(a._timeoutTimer),a._timeoutTimer=null),a._onData&&(b=Buffer.from(b.data),a._onData(b)))}),chrome.serial.flush(a._connId,function(b){d&&d()})):
(console.error("[STMUSBSerial._chromeOpen] Failed to connect to port: "+c),console.error("[STMUSBSerial._chromeOpen] runtime.lastError:",chrome.runtime.lastError),a._chromeClose())}))};
xnm.aio.m10T.STMUSBSerial.prototype._chromeWrite=function(c,d,b){if(null!==this._connId){var a=this;c=new Uint8Array(c);chrome.serial.send(a._connId,c,function(b){console.log("[STMUSBSerial._chromeWrite] send:",b)});a._timeoutTimer&&clearTimeout(a._timeoutTimer);d&&(a._timeoutTimer=setTimeout(function(){a._onTimeout&&a._onTimeout()},d))}};xnm.aio.m10T.STMUSBSerial.prototype._chromeFlush=function(){null!==this._connId&&chrome.serial.flush(this._connId,function(c){})};
xnm.aio.m10T.STMUSBSerial.prototype._chromeClose=function(){if(null!==this._connId){var c=this._connId;chrome.serial.disconnect(this._connId,function(d){console.log("[STMUSBSerial._chromeOpen] Connection to "+c+" has been closed. ("+d+")")})}this._connId=this._connectionInfo=null;this._timeoutTimer&&(clearTimeout(this._timeoutTimer),this._timeoutTimer=null);this._onTimeout=this._onData=this._onError=this._port=null};
xnm.aio.m10T.ESPUpdater=function(c,d,b,a){this._file=c;this._offset=this._filesize=0;d&&(this._offset=d);this._fixedSize=b;this._md5=null;a&&(this._md5=a);this._useNewHeader=!0;this._callback=null;this._blockSize=496;this._retries=this._bytesSent=0};
xnm.aio.m10T.ESPUpdater.prototype._getNextSerialFlashData=function(c,d){require("fs").readFileBinary(this._file,this._offset+this._bytesSent,this._blockSize,function(b,a){if(!b&&a){var e=a.length/2;b=[192,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(var f=239,g=0;g<a.length;g+=2){var h=parseInt(a[g]+a[g+1],16);f^=h;b.push(h)}b[3]=e+16&255;b[4]=(e+16&65280)>>8;b[5]=f;b[9]=e&255;b[10]=(e&65280)>>8;b[13]=c&255;b[14]=(c&65280)>>8;a=[192];for(g=1;g<b.length;g++){h=b[g];if(192==h||219==h)a.push(219),
h=208+((h&240)>>4);a.push(h)}a.push(192);d&&d(a)}else d&&d()})};
xnm.aio.m10T.ESPUpdater.prototype.startSerialUpdate=function(c,d,b){this._callback=d;this._blockSize=1024;this._bytesSent=0;var a=this;require("fs").stat(this._file,function(e,f){if(e)d&&d({error:"invalid update file",state:0});else{a._filesize=a._fixedSize?a._fixedSize:f.size;var g=new xnm.aio.m10T.STMUSBSerial,h=!1,k=!1,l=0,n=[192,0,8,36,0,221,0,0,0,7,7,18,32];for(e=0;32>e;e++)n.push(85);n.push(192);var m=new Buffer([]);g.on("error",function(){d&&d({error:"serial port error",state:0})});g.on("data",
function(d){var c=!1;m=Buffer.concat([m,d]);var e=-1,f=null;for(d=0;d<m.length;d++)if(192==m[d])if(0>e)e=d;else if(f=m.slice(e,e+d+1),12==f.length&&0==f[9]&&0==f[10])if(!h&&8==f[2]||!k&&2==f[2]||3==f[2]){m=new Buffer([]);g.flush();c=!0;break}else e=d;else e=d;if(c)if(h||k)if(h=!0,k?a._bytesSent+=a._blockSize:k=!0,a._bytesSent<a._filesize)a._callback&&a._callback({error:null,state:Math.floor(a._bytesSent/a._filesize*100)}),c=Math.round(a._bytesSent/a._blockSize),a._bytesSent+a._blockSize>a._filesize&&
(a._blockSize=a._filesize-a._bytesSent),a._getNextSerialFlashData(c,function(b){b?(a._lastCRC=b[5],setTimeout(function(){g.write(b,500)},5)):a._callback&&a._callback({error:"failed to read update file",state:0})});else{var n=[192,0,4,4,0,a._lastCRC,0,0,0,1,0,0,0,192];setTimeout(function(){g.write(n);setTimeout(function(){a._callback&&a._callback({error:null,state:100});g.close()},250)},50)}else{h=!0;var l=[192,0,2,16,0,26,0,0,0,0,240,3,0,0,2,0,0,0,4,0,0,0,0,0,0,192];l[11]=7;l[10]=0;1==b&&(l[11]=63);
c=239;for(d=10;d<l.length-1;d++)c^=l[d];l[5]=c;setTimeout(function(){g.write(l,6E4)},20)}});g.on("timeout",function(){h?(d&&d({error:"serial timeout",state:0}),g.close()):5>l?(g.write(n,500),l++):(g.close(),d&&d({error:"failed to connect",state:0}))});g.open(c,function(){g.write([31,48,0,4]);setTimeout(function(){g.write(n,500)},250)})}})};
xnm.aio.m10T.ESPUpdater.prototype._sendNextNetPackage=function(c,d){var b=this;b._bytesSent<b._filesize&&(b._bytesSent+b._blockSize>b._filesize&&(b._blockSize=b._filesize-b._bytesSent),require("fs").readFileBinary(b._file,b._offset+b._bytesSent,b._blockSize,function(a,e){!a&&e?(a="443A",b._bytesSent+b._blockSize==b._filesize?a="453A":b._useNewHeader&&(a="4E3A"+XC.getHexVal(b._bytesSent/b._blockSize+1,4)),e=new Buffer(XC.getBytes(a+e,!0)),c.write(e),b._bytesSent+=b._blockSize):(c.destroy(),d&&d({error:"failed to read file",
state:0}))}))};
xnm.aio.m10T.ESPUpdater.prototype._createUpdateSocket=function(c,d,b){var a=this,e={port:d,host:c},f=require("net").connect(e);f.setTimeout(1E3);f.setNoDelay&&f.setNoDelay(!1);f.setEncoding("binary");f.on("connect",function(){var b=new Buffer("UPD");a._useNewHeader&&0!=a._retries&&(b=new Buffer("UP2"));f.write(b)});f.on("data",function(e){e=new Buffer(e,"binary");if(2==e.length&&79==e[0]&&75==e[1])a._md5&&!a._md5Sent?(e=new Buffer("M:"+a._md5),f.write(e),a._md5Sent=!0):(a._retries=0,b&&b({error:null,
state:Math.floor(a._bytesSent/a._filesize*100)}),a._bytesSent<a._filesize?(a._bytesSent+a._blockSize>a._filesize&&(a._blockSize=a._filesize-a._bytesSent),require("fs").readFileBinary(a._file,a._offset+a._bytesSent,a._blockSize,function(d,c){!d&&c?(d="443A",a._bytesSent+a._blockSize==a._filesize?d="453A":a._useNewHeader&&(d="4E3A"+XC.getHexVal(a._bytesSent/a._blockSize+1,4)),c=new Buffer(XC.getBytes(d+c,!0)),f.write(c),a._bytesSent+=a._blockSize):b&&b({error:"failed to read file",state:0})})):f.destroy());
else if(5==e.length&&"ERROR"==e.toString()&&a._md5&&a._md5Sent&&0==a._bytesSent){a._md5=null;var g=b;b=null;setTimeout(function(){a.startNetUpdate(c,d,g)},0)}else 5==e.length&&"ERROR"==e.toString()&&a._useNewHeader&&a._bytesSent==a._blockSize?(a._useNewHeader=!1,g=b,b=null,setTimeout(function(){a.startNetUpdate(c,d,g)},0)):(f.destroy(),b&&b({error:"failed to flash block",state:0}))});f.on("error",function(a){b&&b({error:"socket error",state:0})});f.on("timeout",function(){a._useNewHeader&&2>a._retries?
(a._retries++,a._bytesSent-=a._blockSize,f.destroy(),a._createUpdateSocket(c,d,b)):(b&&b({error:"socket timeout",state:0}),f.destroy())});f.on("close",function(){});f._doConnect&&"function"==typeof f._doConnect&&f._doConnect()};
xnm.aio.m10T.ESPUpdater.prototype.startNetUpdate=function(c,d,b){this._callback=b;this._blockSize=496;this._retries=this._bytesSent=0;this._md5Sent=!1;var a=this;require("fs").stat(this._file,function(e,f){e?b&&b({error:"invalid update file",state:0}):(a._filesize=a._fixedSize?a._fixedSize:f.size,a._createUpdateSocket(c,d,b))})};xnm.aio.m10T.V5Updater=function(){this.auth=this.at=null;this.useMD5=!1;this.useNewHeader=!0};
xnm.aio.m10T.V5Updater.prototype.parseHeader=function(c){var d=null,b=c.indexOf("HEADER@");0===b&&(d=c.substr(7),0<(b=d.indexOf("@HEADER"))&&(d=d.substr(0,b)));if(d&&d.length&&0<d.length&&(b=d.split("@"),2==b.length&&(d=b[0].split("_"),b=b[1].split("_"),5<=d.length&&5<=b.length))){var a=d[0],e=d[1],f=parseInt(d[d.length-2],10),g=d[d.length-1];d=d.slice(2,d.length-2).join("_");d=[a,e,d,f,g];e=b[0];f=b[1];var h=parseInt(b[b.length-2],10);a=b[b.length-1];b=b.slice(2,b.length-2).join("_");b=[e,f,b,h,
a];e=g.split("-");2===e.length?(g=parseInt(e[0],10),d[4]=g,d.push(e[1])):(g=parseInt(g,10),d[4]=g);g=a.split("-");2===g.length?(a=parseInt(g[0],10),b[4]=a,b.push(g[1])):(a=parseInt(a,10),b[4]=a);return{esp:d,st:b,offset:c.length+1}}return null};
xnm.aio.m10T.V5Updater.prototype.getFileInfos=function(c,d){var b=require("fs");b.stat(c,function(a,e){if(a)d(a,null);else{a=require("crypto");var f=b.createReadStream(c),g=a.createHash("md5"),h=new Buffer([]);g.setEncoding("hex");f.on("data",function(b){h=Buffer.concat([h,b])});f.on("end",function(){g.end();e.md5=g.read();var b=h;for(var a=Array(256),c=0;256>c;c++){for(var f=c<<24&4294967295,p=0;8>p;p++)0!=(f&-2147483648)?(f<<=1,f^=79764919):f<<=1;a[c]=f&4294967295}c=4294967295;for(f=0;f<b.length;f++)c=
(c^(b[f]&255)<<24)&4294967295,p=c>>24&255,c=c<<8&4294967295,c=(c^a[p])&4294967295;b=XC.getHexVal(c>>>16,4)+XC.getHexVal(c&65535,4);e.crc32=b;d(null,e)});f.pipe(g)}})};
xnm.aio.m10T.V5Updater.prototype.packFile=function(c,d,b,a,e,f,g){var h=require("fs"),k=this;k.getFileInfos(b,function(l,n){l?g&&g("invalid file"):k.getFileInfos(a,function(k,l){if(k)g&&g("invalid file");else{k="HEADER@"+("esp_"+e+"_"+c+"_0_"+n.size+"-"+n.md5)+"@"+("st_"+e+"_"+d+"_"+n.size+"_"+l.size+"-"+l.crc32)+"@HEADER\r\n";h.existsSync(f)&&h.unlinkSync(f);var m=h.createWriteStream(f);m.write(k);var p=h.createReadStream(b);p.on("end",function(){p=h.createReadStream(a);p.on("end",function(){m.end();
g&&g()});p.pipe(m,{end:!1})});p.pipe(m,{end:!1})}})})};
xnm.aio.m10T.V5Updater.prototype.packFileV5Plus=function(c,d,b,a,e,f,g){var h=require("fs");h.stat(b,function(k,l){k?g&&g("invalid file"):h.stat(a,function(k,m){if(k)g&&g("invalid file");else{k=0;var n="a20_"+e+"_"+c+"_"+k+"_"+l.size;k+=l.size;m="HEADER@"+n+"@"+("st_"+e+"_"+d+"_"+k+"_"+m.size)+"@HEADER\r\n";h.existsSync(f)&&h.unlinkSync(f);var r=h.createWriteStream(f);r.write(m);var q=h.createReadStream(b);q.on("end",function(){q=h.createReadStream(a);q.on("end",function(){r.end();g&&g()});q.pipe(r,
{end:!1})});q.pipe(r,{end:!1})}})})};
xnm.aio.m10T.V5Updater.prototype.updateFirmware=function(c,d,b){var a=require("fs"),e=this;a.existsSync(d)?a.stat(d,function(f,g){f||a.readFileLine(d,1,function(a,f){var g=!1;if(!a&&f){var h=e.parseHeader(f);if(h){a=null;e.useMD5&&(a=h.st[5]);var k=new xnm.aio.m10T.STMUpdater(d,h.offset+h.st[3],h.st[4],a);k.at=e.at;k.auth=e.auth;k.startNetUpdate(c,function(a){a.error&&b?b(a):(b&&b({error:null,state:Math.floor(a.state/2)}),100==a.state&&(a=null,e.useMD5&&(a=h.esp[5]),k=new xnm.aio.m10T.ESPUpdater(d,
h.offset,h.esp[4],a),k.startNetUpdate(c,8081,function(a){a.error&&b?b(a):b&&b({error:null,state:Math.floor(50+a.state/2)})})))});g=!0}}!g&&b&&b({error:"invalid firmware file",state:0})})}):b&&b({error:"file does not exist",state:0})};
xnm.aio.m10T.V5Updater.prototype.updateFirmwareInReverseOrder=function(c,d,b){var a=require("fs"),e=this;a.existsSync(d)?a.stat(d,function(f,g){f?b&&b({error:f.message,state:0}):a.readFileLine(d,1,function(a,f){var g=!1;if(!a&&f){var h=e.parseHeader(f);if(h){a=null;e.useMD5&&(a=h.esp[5]);var k=new xnm.aio.m10T.ESPUpdater(d,h.offset,h.esp[4],a);k.startNetUpdate(c,8081,function(a){if(a&&a.error)b&&b(a);else{var f=Math.floor(a.state/2);b&&b({error:null,state:f});if(100===a.state){var g=function(){var a=
null;e.useMD5&&(a=h.st[5]);k=new xnm.aio.m10T.STMUpdater(d,h.offset+h.st[3],h.st[4],a);k.at=e.at;k.auth=e.auth;k.startNetUpdate(c,function(a){a&&a.error?b&&b(a):(a=Math.floor(50+a.state/2),b&&b({error:null,state:a}))})};setTimeout(function(){g()},15E3)}}});g=!0}}g||b&&b({error:"[04] invalid firmware file",state:0})})}):b&&b({error:"[02] file does not exist",state:0})};
xnm.aio.m10T.V5Updater.prototype._updateFirmwareWithRetries_phase1=function(c,d,b,a,e,f){var g=this,h=null;this.useMD5&&(h=e.st[5]);h=new xnm.aio.m10T.STMUpdater(d,e.offset+e.st[3],e.st[4],h);h.at=g.at;h.auth=g.auth;h.startNetUpdate(c,function(h){h.error?(f&&f({error:h.error,state:h.state,phase:1,retriesLeft:a}),0===h.state&&0<a&&setTimeout(function(){g._updateFirmwareWithRetries_phase1(c,d,b,a-1,e,f)},2E3)):(f&&f({error:null,state:Math.floor(h.state/2)}),100==h.state&&g._updateFirmwareWithRetries_phase2(c,
d,b,e,f))})};xnm.aio.m10T.V5Updater.prototype._updateFirmwareWithRetries_phase2=function(c,d,b,a,e){var f=this,g=null;this.useMD5&&(g=a.esp[5]);(new xnm.aio.m10T.ESPUpdater(d,a.offset,a.esp[4],g)).startNetUpdate(c,8081,function(g){g.error?(e&&e({error:g.error,state:g.state,phase:2,retriesLeft:b}),0<b&&setTimeout(function(){f._updateFirmwareWithRetries_phase2(c,d,b-1,a,e)},2E3)):e&&e({error:null,state:Math.floor(50+g.state/2)})})};
xnm.aio.m10T.V5Updater.prototype.updateFirmwareWithRetries=function(c,d,b,a){var e=require("fs"),f=this;b=Number(b);0>b||isNaN(b)?a&&a({error:'Invalid value for parameter "retries". Has to be a number >= 0.',state:0}):e.existsSync(d)?e.stat(d,function(g,h){g?a&&a({error:g.message,state:0}):e.readFileLine(d,1,function(e,g){!e&&g?(e=f.parseHeader(g))?f._updateFirmwareWithRetries_phase1(c,d,b,b,e,a):a&&a({error:"Failed to parse firmware file header.",state:0}):a&&a({error:"Invalid firmare file.",state:0})})}):
a&&a({error:"File does not exist.",state:0})};xnm.aio.m10T.V5Updater.prototype.isDFUConnected=function(c,d,b){var a=require("child_process").exec;c=a('"'+c+'" -l');var e=!1;c.stdout.on("data",function(a){a&&-1<a.toString().indexOf(d)&&(e=!0)});c.on("error",function(a){});c.on("close",function(a){b&&b(e)})};
xnm.aio.m10T.V5Updater.prototype.waitForDFUConnect=function(c,d,b,a){var e=this;this.isDFUConnected(c,d,function(f){f?a&&a(!0):0<b?setTimeout(function(){e.waitForDFUConnect(c,d,b-.5,a)},500):a&&a(!1)})};
xnm.aio.m10T.V5Updater.prototype.waitForSerialConnection=function(c,d,b){if(this._useChromeAPI)this._chromeWaitForSerialConnection(c,d,b);else{var a=this;require("serialport").list(function(e,f){void 0==f&&(f=[]);if(b&&f&&b.length<f.length)for(e=0;e<f.length;e++){for(var g=!0,h=0;h<b.length;h++)if(f[e].comName==b[h].comName){g=!1;break}if(g){var k=f[e].comName;setTimeout(function(){d&&d(k)},1E3)}}else 0<c?setTimeout(function(){a.waitForSerialConnection(c-.5,d,f)},500):d&&d(null)})}};
xnm.aio.m10T.V5Updater.prototype._chromeWaitForSerialConnection=function(c,d,b){var a=this,e=function(a){setTimeout(function(){d&&d(a)},1E3)};chrome.serial.getDevices(function(f){Array.isArray(f)||(f=[]);if(b&&b.length<f.length)for(var g=0;g<f.length;g++){for(var h=!0,k=0;k<b.length;k++)if(f[g].path==b[k].path){h=!1;break}h&&e(f[g].path)}else 0<c?setTimeout(function(){a._chromeWaitForSerialConnection(c-.5,d,f)},500):d&&d(null)})};xnm.aio.m10T.Handler=function(){};
xnm.aio.m10T.Handler.prototype.IBus=xnm.aio.m10T.IBus;xnm.aio.m10T.Handler.prototype.STMUpdater=xnm.aio.m10T.STMUpdater;xnm.aio.m10T.Handler.prototype.ESPUpdater=xnm.aio.m10T.ESPUpdater;xnm.aio.m10T.Handler.prototype.V5Updater=xnm.aio.m10T.V5Updater;xnm.aio.m10T.Handler.prototype.STMUSBSerial=xnm.aio.m10T.STMUSBSerial;"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.m10T.Handler);
