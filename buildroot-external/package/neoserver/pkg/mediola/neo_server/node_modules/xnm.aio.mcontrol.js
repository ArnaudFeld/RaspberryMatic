var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,d,e){a instanceof String&&(a=String(a));for(var g=a.length,f=0;f<g;f++){var b=a[f];if(d.call(e,b,f,a))return{i:f,v:b}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,d,e){a!=Array.prototype&&a!=Object.prototype&&(a[d]=e.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,d,e,g){if(d){e=$jscomp.global;a=a.split(".");for(g=0;g<a.length-1;g++){var f=a[g];f in e||(e[f]={});e=e[f]}a=a[a.length-1];g=e[a];d=d(g);d!=g&&null!=d&&$jscomp.defineProperty(e,a,{configurable:!0,writable:!0,value:d})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(d,a){return $jscomp.findInternal(this,d,a).v}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.mcontrol=xnm.aio.mcontrol||{};
xnm.aio.mcontrol.MControl=function(){var a={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&apos;"},d=function(b){return b.replace(/[<>&"']/g,function(c){return a[c]})},e=function(b,c,h){this.device=b;this.command=c;this.callback=h;this._socket=null};e.prototype.run=function(b){var c=this;b._connect({onError:function(b){c._finish(b)},onTimeout:function(){c._finish(Error("response timeout"))},onData:function(){c._socket.end();c._finish()},onClose:function(){c._finish()}},function(h,d){h?c._finish(h):
(c._socket=d,h=b._buildCommand(c.device,c.command),d.write(h,"utf8"))})};e.prototype._finish=function(b){this.callback&&this.callback(b);this.callback=null};var g=function(b,c){this.deviceList=b;this.callback=c;this._socket=null;this._block="";this._responseComplete=!1};g.prototype.run=function(b){var c=this;b._connect({onError:function(b){c._finish(b)},onTimeout:function(){c._responseComplete||c._finish(Error("response timeout"))},onData:function(b){c._block+=b;c._handleRsp()},onClose:function(){c._finish()}},
function(h,d){h?c._finish(h):(c._socket=d,h=b._buildStatus(c.deviceList),d.write(h,"utf8"))})};g.prototype._finish=function(b,c){this.callback&&this.callback(b,c);this.callback=null};g.prototype._handleRsp=function(){var b=this._block.indexOf("\n");if(!(0>=b))if("XML"!=this._block.substr(0,b))this._block="";else{var c=this._block.indexOf("\n",b+1);0>c||(b=this._block.substr(b+1,c-b-1),b=parseInt(b),this._block.length<b+4+9||(this._responseComplete=!0,c=this._block.substr(c+1),0==c.charCodeAt(c.length-
1)&&(c=c.substr(0,c.length-1)),this._parseStatus(c),this._socket.end()))}};g.prototype._parseStatus=function(b){var c=[];$($.parseXML(b)).find("return").each(function(){var b=$(this),d=b.attr("name");b=b.attr("value");c.push({id:d,status:b})});this._finish(null,c)};var f=function(b,c){var d=require("x.logger.js");this._logger=d?d.getLogger("xnm.aio.mcontrol.MControl"):{log:function(){}};this.ip=b;this.port=c;this.port||(this.port=8082)};f.prototype.REQ='<?xml version="1.0"?>\n<mctrlmessage>\n<request name="@1" module="@2">\n@3</request>\n</mctrlmessage>\n';
f.prototype.PARAM='<param name="@1" value="@2" />\n';f.prototype.executeCommandCreator=function(b,c,d){var a=c.ext;c.value&&"do"!=c.value&&"setInt"!=c.value&&"setFloat"!=c.value&&(a=c.value+(null!=a&&"undefined"!=typeof a?a:""));this.executeCommand(b.address,a,function(c){d&&d(c)})};f.prototype.getStatesCreator=function(b,c,d){if(c)if(0==c.length)d&&d(null,[]);else{b={};for(var a=0;a<c.length;a++)c[a]&&c[a].id&&c[a].device&&c[a].device.address&&(b[c[a].id]=c[a].device.address);this.getStates(b,function(b,
a){if(b)d&&d(b);else{b={};for(var h=0;h<c.length;h++)c[h]&&c[h].id&&c[h].status&&c[h].status.value&&(b[c[h].id]=c[h].status.value);h=[];a||(a=[]);for(var e=0;e<a.length;e++){var f=a[e].status;"intVal"==b[a[e].id]?(f=parseInt(f),isNaN(f)||h.push({id:a[e].id,status:f})):"floatVal"==b[a[e].id]?(f=parseFloat(f),isNaN(f)||h.push({id:a[e].id,status:f})):h.push({id:a[e].id,status:a[e].status})}d&&d(null,h)}})}else d&&d(Error("deviceList is null"))};f.prototype.executeCommand=function(b,c,a){b&&null!=c&&
"undefined"!=typeof c?(new e(b,c,a)).run(this):a&&a(Error("argument invalid"))};f.prototype.getStates=function(b,c){b?(new g(b,c)).run(this):c&&c(Error("deviceList is null"))};f.prototype._buildCommand=function(b,c){var a=f.prototype.PARAM.replace("@1","command");b=b.split(".");a=a.replace("@2",d(b[0]+"."+(b[1]?b[1]+".":"")+c));c=f.prototype.REQ.replace("@1","ExecuteCommand");c=c.replace("@2","hcontrol");c=c.replace("@3",a);a=c.length;for(a=a.toString();8>a.length;)a="0"+a;return"MCM:PLUGIN\nXML\n"+
a+"\n"+c};f.prototype._buildStatus=function(b){var a="",e;for(e in b)if(b.hasOwnProperty(e)){var g=f.prototype.PARAM.replace("@1",d(e));g=g.replace("@2",d(b[e]));a+=g}b=f.prototype.REQ.replace("@1","GetStates");b=b.replace("@2","hcontrol");b=b.replace("@3",a);a=b.length;for(a=a.toString();8>a.length;)a="0"+a;return"MCM:PLUGIN\nXML\n"+a+"\n"+b};f.prototype._connect=function(a,c){var b=this,d={port:this.port,host:this.ip},e=!1,f=c,g=require("net").connect(d);a.__socket=g;g.setTimeout(1E4);g.setEncoding("utf8");
g.on("connect",function(){b._logger.log("trace","connect tcp to:"+b.ip);e=!0;if(f){var c=a.__socket;delete a.__socket;f(null,c)}});g.on("data",function(c){b._logger.log("trace","receive from tcp:"+b.ip+" data:"+c);a.onData(c)});g.on("error",function(c){e?(b._logger.log("trace","tcp:"+b.ip+" error:"+c.message),g.end(),a.onError(c)):(b._logger.log("trace","tcp:"+b.ip+" connection error:"+c.message),f&&(f(c),f=null))});g.on("timeout",function(){e?(b._logger.log("trace","tcp:"+b.ip+" data timeout"),g.end(),
a.onTimeout()):(b._logger.log("trace","tcp:"+b.ip+" connection timeout"),g.end(),f&&(f(Error("connection timeout")),f=null))});g.on("close",function(){b._logger.log("trace","tcp:"+b.ip+" close socket");a.onClose()});g._doConnect&&"function"==typeof g._doConnect&&g._doConnect()};f.prototype.toJSON=function(){return{sys:xnm.aio.mcontrol.DM.SYS,ip:this.ip,port:this.port}};f.prototype.equalsTo=function(a){return a&&a instanceof f?this.ip==a.ip&&this.port==a.port:!1};return f}();
xnm.aio.mcontrol.DMError=function(a,d){this.code=a;this.message=d;this.stack=Error().stack};xnm.aio.mcontrol.DMError.prototype=Error();xnm.aio.mcontrol.DMError.prototype.name="MControlDMError";xnm.aio.mcontrol.DMError.prototype.code=0;xnm.aio.mcontrol.DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};
xnm.aio.mcontrol.DM={SYS:"mcontrol",MAP:{command:[{type:"string",name:"do",ref:{value:"do",ext:"%s"}},{type:"int",name:"set integer value",ref:{value:"setInt",ext:"%d"}},{type:"float",name:"set float value",ref:{value:"setFloat",ext:"%f"}}],status:[{type:"string",name:"value",ref:{value:"state"}},{type:"int",name:"value as integer",ref:{value:"intVal"}},{type:"float",name:"value as float",ref:{value:"floatVal"}}]},getGatewayType:function(){return[{sys:this.SYS,name:"mControl",port:8082}]},createGateway:function(a,
d,e){d=xnm.aio.mcontrol.DMError;var g=xnm.aio.mcontrol.DMError.ERROR_CODE;a?a.ip?e(null,a):e(new d(g.INVALID,"ip is invalid")):e(new d(g.INVALID,"info is invalid"))},updateGateway:function(a,d,e,g){a=xnm.aio.mcontrol.DMError;e=xnm.aio.mcontrol.DMError.ERROR_CODE;d?d.ip?g(null,d):g(new a(e.INVALID,"ip is invalid")):g(new a(e.INVALID,"update is invalid"))},deleteGateway:function(a,d,e){e()},createDevice:function(a,d,e){var g=xnm.aio.mcontrol.DMError,f=xnm.aio.mcontrol.DMError.ERROR_CODE;if(a)if(a.gateway)if(a.address)if(d.data&&
d.data.gateways&&0!==d.data.gateways.length){d=d.data.gateways;var b;for(b=0;b<d.length;b++)if(d[b].index===a.gateway){var c=d[b];break}c?e(null,a):e(new g(f.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else e(new g(f.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else e(new g(f.INVALID,"address is invalid"));else e(new g(f.INVALID,"gateway is invalid"));else e(new g(f.INVALID,"info is invalid"))},updateDevice:function(a,d,e){var g=xnm.aio.mcontrol.DMError,f=xnm.aio.mcontrol.DMError.ERROR_CODE;
if(a)if(a.gateway)if(a.address)if(d.data&&d.data.gateways&&0!==d.data.gateways.length){d=d.data.gateways;var b;for(b=0;b<d.length;b++)if(d[b].index===a.gateway){var c=d[b];break}c?e(null,a):e(new g(f.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else e(new g(f.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else e(new g(f.INVALID,"address is invalid"));else e(new g(f.INVALID,"gateway is invalid"));else e(new g(f.INVALID,"info is invalid"))},deleteDevice:function(a,d,e){e()},
applyUIFilter:function(a,d){var e=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},g=function(a,b,c){var d=[];switch(c.catagory){case "command":a.command&&a.command.forEach(function(a){e(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))});break;case "status":a.status&&a.status.forEach(function(a){e(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))})}return d},f=function(a,b){var c=[],d=JSON.parse(JSON.stringify(xnm.aio.mcontrol.DM.MAP));
d&&(a=g(d,a,b),c=c.concat(a));return c};if(!a)return null;var b=JSON.parse(JSON.stringify(a)),c=null;switch(d.catagory){case "command":c=f(a,d);b.command=c;break;case "status":c=f(a,d);b.status=c;break;default:return null}return c&&0!=c.length?b:null}};
xnm.aio.mcontrol.Handler=function(){var a=function(){};a.prototype.MControl=xnm.aio.mcontrol.MControl;a.prototype.devicemanager=xnm.aio.mcontrol.DM;a.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"mcontrol")};a.prototype.resolveGateway=function(a){return a&&a.ip?new xnm.aio.mcontrol.MControl(a.ip,a.port):null};a.prototype.getDeviceCommands=function(a,e){a=(a=xnm.aio.mcontrol.DM.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];e&&e(null,a)};a.prototype.getDeviceStatus=
function(a,e){a=(a=xnm.aio.mcontrol.DM.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];e&&e(null,a)};a.prototype.doCommand=function(a,e,g,f){(a=this.resolveGateway(a))?a.executeCommandCreator(e,g,function(a){f&&f(a)}):f&&f(Error("gateway json format invalid"))};a.prototype.doStatus=function(a,e,g,f,b){(e=this.resolveGateway(e))?e.getStatesCreator(null,[{id:a,device:g,status:f}],function(a,d){a?b&&b(a):b&&b(null,d[0])}):b&&b(Error("gateway json format invalid"))};return a}();
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.mcontrol.Handler);
