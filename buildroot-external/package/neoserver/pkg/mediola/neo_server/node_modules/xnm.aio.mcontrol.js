var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.mcontrol=xnm.aio.mcontrol||{},xnm.aio.mcontrol.MControl=function(){var t={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&apos;"},e=function e(_e){return _e.replace(/[<>&"']/g,function(e){return t[e];});},n=function n(t,e,_n){this.device=t,this.command=e,this.callback=_n,this._socket=null;};n.prototype.run=function(t){var e=this,n={onError:function onError(t){e._finish(t);},onTimeout:function onTimeout(){e._finish(new Error("response timeout"));},onData:function onData(){e._socket.end(),e._finish();},onClose:function onClose(){e._finish();}};t._connect(n,function(n,o){if(n)e._finish(n);else{e._socket=o;var r=t._buildCommand(e.device,e.command);o.write(r,"utf8");}});},n.prototype._finish=function(t){this.callback&&this.callback(t),this.callback=null;};var o=function o(t,e){this.deviceList=t,this.callback=e,this._socket=null,this._block="",this._responseComplete=!1;};o.prototype.run=function(t){var e=this,n={onError:function onError(t){e._finish(t);},onTimeout:function onTimeout(){e._responseComplete||e._finish(new Error("response timeout"));},onData:function onData(t){e._block+=t,e._handleRsp();},onClose:function onClose(){e._finish();}};t._connect(n,function(n,o){if(n)e._finish(n);else{e._socket=o;var r=t._buildStatus(e.deviceList);o.write(r,"utf8");}});},o.prototype._finish=function(t,e){this.callback&&this.callback(t,e),this.callback=null;},o.prototype._handleRsp=function(){var t=this._block.indexOf("\n");if(!(t<=0))if("XML"==this._block.substr(0,t)){var e=this._block.indexOf("\n",t+1);if(!(e<0)){var n=this._block.substr(t+1,e-t-1);if(n=parseInt(n),!(this._block.length<n+4+9)){this._responseComplete=!0;var o=this._block.substr(e+1);0==o.charCodeAt(o.length-1)&&(o=o.substr(0,o.length-1)),this._parseStatus(o),this._socket.end();}}}else this._block="";},o.prototype._parseStatus=function(t){var e=$($.parseXML(t)),n=[];e.find("return").each(function(){var t=$(this),e=t.attr("name"),o=t.attr("value");n.push({id:e,status:o});}),this._finish(null,n);};var r=function r(t,e){var n=require("x.logger.js");this._logger=n?n.getLogger("xnm.aio.mcontrol.MControl"):{log:function log(){}},this.ip=t,this.port=e,this.port||(this.port=8082);};return r.prototype.REQ='<?xml version="1.0"?>\n<mctrlmessage>\n<request name="@1" module="@2">\n@3</request>\n</mctrlmessage>\n',r.prototype.PARAM='<param name="@1" value="@2" />\n',r.prototype.executeCommandCreator=function(t,e,n){var o=e.ext;e.value&&"do"!=e.value&&"setInt"!=e.value&&"setFloat"!=e.value&&(o=e.value+(null!=o&&void 0!==o?o:"")),this.executeCommand(t.address,o,function(t){n&&n(t);});},r.prototype.getStatesCreator=function(t,e,n){if(e){if(0!=e.length){for(var o={},r=0;r<e.length;r++)e[r]&&e[r].id&&e[r].device&&e[r].device.address&&(o[e[r].id]=e[r].device.address);this.getStates(o,function(t,o){if(t)n&&n(t);else{for(var r={},a=0;a<e.length;a++)e[a]&&e[a].id&&e[a].status&&e[a].status.value&&(r[e[a].id]=e[a].status.value);var i=[];o||(o=[]);for(var s=0;s<o.length;s++){var l,c=o[s].status;"intVal"==r[o[s].id]?(l=parseInt(c),isNaN(l)||i.push({id:o[s].id,status:l})):"floatVal"==r[o[s].id]?(l=parseFloat(c),isNaN(l)||i.push({id:o[s].id,status:l})):i.push({id:o[s].id,status:o[s].status});}n&&n(null,i);}});}else n&&n(null,[]);}else n&&n(new Error("deviceList is null"));},r.prototype.executeCommand=function(t,e,o){t&&null!=e&&void 0!==e?new n(t,e,o).run(this):o&&o(new Error("argument invalid"));},r.prototype.getStates=function(t,e){t?new o(t,e).run(this):e&&e(new Error("deviceList is null"));},r.prototype._buildCommand=function(t,n){var o=r.prototype.PARAM.replace("@1","command"),a=t.split("."),i=a[0]+"."+(a[1]?a[1]+".":"")+n;o=o.replace("@2",e(i));var s=r.prototype.REQ.replace("@1","ExecuteCommand"),l=(s=(s=s.replace("@2","hcontrol")).replace("@3",o)).length;for(l=l.toString();l.length<8;)l="0"+l;return"MCM:PLUGIN\nXML\n"+l+"\n"+s;},r.prototype._buildStatus=function(t){var n="";for(var o in t)if(t.hasOwnProperty(o)){var a=r.prototype.PARAM.replace("@1",e(o));n+=a=a.replace("@2",e(t[o]));}var i=r.prototype.REQ.replace("@1","GetStates"),s=(i=(i=i.replace("@2","hcontrol")).replace("@3",n)).length;for(s=s.toString();s.length<8;)s="0"+s;return"MCM:PLUGIN\nXML\n"+s+"\n"+i;},r.prototype._connect=function(t,e){var n=this,o={port:this.port,host:this.ip},r=!1,a=e,i=require("net").connect(o);t.__socket=i,i.setTimeout(1e4),i.setEncoding("utf8"),i.on("connect",function(){if(n._logger.log("trace","connect tcp to:"+n.ip),r=!0,a){var e=t.__socket;delete t.__socket,a(null,e);}}),i.on("data",function(e){n._logger.log("trace","receive from tcp:"+n.ip+" data:"+e),t.onData(e);}),i.on("error",function(e){r?(n._logger.log("trace","tcp:"+n.ip+" error:"+e.message),i.end(),t.onError(e)):(n._logger.log("trace","tcp:"+n.ip+" connection error:"+e.message),a&&(a(e),a=null));}),i.on("timeout",function(){r?(n._logger.log("trace","tcp:"+n.ip+" data timeout"),i.end(),t.onTimeout()):(n._logger.log("trace","tcp:"+n.ip+" connection timeout"),i.end(),a&&(a(new Error("connection timeout")),a=null));}),i.on("close",function(){n._logger.log("trace","tcp:"+n.ip+" close socket"),t.onClose();}),i._doConnect&&"function"==typeof i._doConnect&&i._doConnect();},r.prototype.toJSON=function(){return{sys:xnm.aio.mcontrol.DM.SYS,ip:this.ip,port:this.port};},r.prototype.equalsTo=function(t){return!!t&&t instanceof r&&this.ip==t.ip&&this.port==t.port;},r;}(),xnm.aio.mcontrol.DMError=function(t,e){this.code=t,this.message=e,this.stack=new Error().stack;},xnm.aio.mcontrol.DMError.prototype=new Error(),xnm.aio.mcontrol.DMError.prototype.name="MControlDMError",xnm.aio.mcontrol.DMError.prototype.code=0,xnm.aio.mcontrol.DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},xnm.aio.mcontrol.DM={SYS:"mcontrol",MAP:{command:[{type:"string",name:"do",ref:{value:"do",ext:"%s"}},{type:"int",name:"set integer value",ref:{value:"setInt",ext:"%d"}},{type:"float",name:"set float value",ref:{value:"setFloat",ext:"%f"}}],status:[{type:"string",name:"value",ref:{value:"state"}},{type:"int",name:"value as integer",ref:{value:"intVal"}},{type:"float",name:"value as float",ref:{value:"floatVal"}}]},getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"mControl",port:8082}];},createGateway:function createGateway(t,e,n){var o=xnm.aio.mcontrol.DMError,r=xnm.aio.mcontrol.DMError.ERROR_CODE;t?t.ip?n(null,t):n(new o(r.INVALID,"ip is invalid")):n(new o(r.INVALID,"info is invalid"));},updateGateway:function updateGateway(t,e,n,o){var r=xnm.aio.mcontrol.DMError,a=xnm.aio.mcontrol.DMError.ERROR_CODE;e?e.ip?o(null,e):o(new r(a.INVALID,"ip is invalid")):o(new r(a.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(t,e,n){n();},createDevice:function createDevice(t,e,n){var o=xnm.aio.mcontrol.DMError,r=xnm.aio.mcontrol.DMError.ERROR_CODE;if(t){if(t.gateway){if(t.address){if(e.data&&e.data.gateways&&0!==e.data.gateways.length){var a,i,s=e.data.gateways;for(a=0;a<s.length;a++)if(s[a].index===t.gateway){i=s[a];break;}i?n(null,t):n(new o(r.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else n(new o(r.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else n(new o(r.INVALID,"address is invalid"));}else n(new o(r.INVALID,"gateway is invalid"));}else n(new o(r.INVALID,"info is invalid"));},updateDevice:function updateDevice(t,e,n){var o=xnm.aio.mcontrol.DMError,r=xnm.aio.mcontrol.DMError.ERROR_CODE;if(t){if(t.gateway){if(t.address){if(e.data&&e.data.gateways&&0!==e.data.gateways.length){var a,i,s=e.data.gateways;for(a=0;a<s.length;a++)if(s[a].index===t.gateway){i=s[a];break;}i?n(null,t):n(new o(r.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else n(new o(r.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else n(new o(r.INVALID,"address is invalid"));}else n(new o(r.INVALID,"gateway is invalid"));}else n(new o(r.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(t,e,n){n();},applyUIFilter:function applyUIFilter(t,e){var n=function n(t,e){if("*"==t)return!0;for(var n=!1,o=0;o<t.length;o++)if(t[o]==e){n=!0;break;}return n;},o=function o(t,e){var o=[],r=null,a=JSON.parse(JSON.stringify(xnm.aio.mcontrol.DM.MAP));return a&&(r=function(t,e,o){var r=[];switch(o.catagory){case"command":t.command&&t.command.forEach(function(t){if(n(o.elems,t.type)){var e=JSON.parse(JSON.stringify(t));r.push(e);}});break;case"status":t.status&&t.status.forEach(function(t){if(n(o.elems,t.type)){var e=JSON.parse(JSON.stringify(t));r.push(e);}});}return r;}(a,0,e),o=o.concat(r)),o;};if(!t)return null;var r=JSON.parse(JSON.stringify(t)),a=null;switch(e.catagory){case"command":a=o(0,e),r.command=a;break;case"status":a=o(0,e),r.status=a;break;default:return null;}return a&&0!=a.length?r:null;}},xnm.aio.mcontrol.Handler=function(){var t=function t(){};return t.prototype.MControl=xnm.aio.mcontrol.MControl,t.prototype.devicemanager=xnm.aio.mcontrol.DM,t.prototype.registModule=function(t){t.register(this.devicemanager.SYS,"mcontrol");},t.prototype.resolveGateway=function(t){return t&&t.ip?new xnm.aio.mcontrol.MControl(t.ip,t.port):null;},t.prototype.getDeviceCommands=function(t,e){var n=xnm.aio.mcontrol.DM.applyUIFilter(t,{catagory:"command",elems:"*"}),o=n?n.command:[];e&&e(null,o);},t.prototype.getDeviceStatus=function(t,e){var n=xnm.aio.mcontrol.DM.applyUIFilter(t,{catagory:"status",elems:"*"}),o=n?n.status:[];e&&e(null,o);},t.prototype.doCommand=function(t,e,n,o){var r=this.resolveGateway(t);r?r.executeCommandCreator(e,n,function(t){o&&o(t);}):o&&o(new Error("gateway json format invalid"));},t.prototype.doStatus=function(t,e,n,o,r){var a=this.resolveGateway(e);if(a){var i=[{id:t,device:n,status:o}];a.getStatesCreator(null,i,function(t,e){t?r&&r(t):r&&r(null,e[0]);});}else r&&r(new Error("gateway json format invalid"));},t;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.mcontrol.Handler());