var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.mcontrol=xnm.aio.mcontrol||{};
xnm.aio.mcontrol.MControl=function(){var e={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&apos;"},b=function(c){return c.replace(/[<>&"']/g,function(a){return e[a]})},d=function(c,a,h){this.device=c;this.command=a;this.callback=h;this._socket=null};d.prototype.run=function(c){var a=this;c._connect({onError:function(c){a._finish(c)},onTimeout:function(){a._finish(Error("response timeout"))},onData:function(){a._socket.end();a._finish()},onClose:function(){a._finish()}},function(h,b){if(h)a._finish(h);
else{a._socket=b;var e=c._buildCommand(a.device,a.command);b.write(e,"utf8")}})};d.prototype._finish=function(c){this.callback&&this.callback(c);this.callback=null};var g=function(c,a){this.deviceList=c;this.callback=a;this._socket=null;this._block="";this._responseComplete=!1};g.prototype.run=function(c){var a=this;c._connect({onError:function(c){a._finish(c)},onTimeout:function(){a._responseComplete||a._finish(Error("response timeout"))},onData:function(c){a._block+=c;a._handleRsp()},onClose:function(){a._finish()}},
function(h,b){if(h)a._finish(h);else{a._socket=b;var e=c._buildStatus(a.deviceList);b.write(e,"utf8")}})};g.prototype._finish=function(c,a){this.callback&&this.callback(c,a);this.callback=null};g.prototype._handleRsp=function(){var c=this._block.indexOf("\n");if(!(0>=c))if("XML"!=this._block.substr(0,c))this._block="";else{var a=this._block.indexOf("\n",c+1);0>a||(c=this._block.substr(c+1,a-c-1),c=parseInt(c),this._block.length<c+4+9||(this._responseComplete=!0,a=this._block.substr(a+1),0==a.charCodeAt(a.length-
1)&&(a=a.substr(0,a.length-1)),this._parseStatus(a),this._socket.end()))}};g.prototype._parseStatus=function(c){var a=[];$($.parseXML(c)).find("return").each(function(){var c=$(this),b=c.attr("name"),c=c.attr("value");a.push({id:b,status:c})});this._finish(null,a)};var f=function(c,a){var h=require("x.logger.js");this._logger=h?h.getLogger("xnm.aio.mcontrol.MControl"):{log:function(){}};this.ip=c;this.port=a;this.port||(this.port=8082)};f.prototype.REQ='<?xml version="1.0"?>\n<mctrlmessage>\n<request name="@1" module="@2">\n@3</request>\n</mctrlmessage>\n';
f.prototype.PARAM='<param name="@1" value="@2" />\n';f.prototype.executeCommandCreator=function(c,a,h){var b=a.ext;a.value&&"do"!=a.value&&"setInt"!=a.value&&"setFloat"!=a.value&&(b=a.value+(null!=b&&"undefined"!=typeof b?b:""));this.executeCommand(c.address,b,function(a){h&&h(a)})};f.prototype.getStatesCreator=function(c,a,h){if(a)if(0==a.length)h&&h(null,[]);else{c={};for(var b=0;b<a.length;b++)a[b]&&a[b].id&&a[b].device&&a[b].device.address&&(c[a[b].id]=a[b].device.address);this.getStates(c,function(c,
b){if(c)h&&h(c);else{for(var e={},d=0;d<a.length;d++)a[d]&&a[d].id&&a[d].status&&a[d].status.value&&(e[a[d].id]=a[d].status.value);d=[];b||(b=[]);for(var g=0;g<b.length;g++){var f;f=b[g].status;"intVal"==e[b[g].id]?(f=parseInt(f),isNaN(f)||d.push({id:b[g].id,status:f})):"floatVal"==e[b[g].id]?(f=parseFloat(f),isNaN(f)||d.push({id:b[g].id,status:f})):d.push({id:b[g].id,status:b[g].status})}h&&h(null,d)}})}else h&&h(Error("deviceList is null"))};f.prototype.executeCommand=function(c,a,b){c&&null!=a&&
"undefined"!=typeof a?(new d(c,a,b)).run(this):b&&b(Error("argument invalid"))};f.prototype.getStates=function(c,a){c?(new g(c,a)).run(this):a&&a(Error("deviceList is null"))};f.prototype._buildCommand=function(c,a){for(var h=f.prototype.PARAM.replace("@1","command"),d=c.split("."),h=h.replace("@2",b(d[0]+"."+(d[1]?d[1]+".":"")+a)),d=f.prototype.REQ.replace("@1","ExecuteCommand"),d=d.replace("@2","hcontrol"),d=d.replace("@3",h),h=d.length,h=h.toString();8>h.length;)h="0"+h;return"MCM:PLUGIN\nXML\n"+
h+"\n"+d};f.prototype._buildStatus=function(c){var a="",d;for(d in c)if(c.hasOwnProperty(d))var e=f.prototype.PARAM.replace("@1",b(d)),e=e.replace("@2",b(c[d])),a=a+e;c=f.prototype.REQ.replace("@1","GetStates");c=c.replace("@2","hcontrol");c=c.replace("@3",a);a=c.length;for(a=a.toString();8>a.length;)a="0"+a;return"MCM:PLUGIN\nXML\n"+a+"\n"+c};f.prototype._connect=function(c,a){var b=this,d={port:this.port,host:this.ip},e=!1,g=a,f=require("net").connect(d);c.__socket=f;f.setTimeout(1E4);f.setEncoding("utf8");
f.on("connect",function(){b._logger.log("trace","connect tcp to:"+b.ip);e=!0;if(g){var a=c.__socket;delete c.__socket;g(null,a)}});f.on("data",function(a){b._logger.log("trace","receive from tcp:"+b.ip+" data:"+a);c.onData(a)});f.on("error",function(a){e?(b._logger.log("trace","tcp:"+b.ip+" error:"+a.message),f.end(),c.onError(a)):(b._logger.log("trace","tcp:"+b.ip+" connection error:"+a.message),g&&(g(a),g=null))});f.on("timeout",function(){e?(b._logger.log("trace","tcp:"+b.ip+" data timeout"),f.end(),
c.onTimeout()):(b._logger.log("trace","tcp:"+b.ip+" connection timeout"),f.end(),g&&(g(Error("connection timeout")),g=null))});f.on("close",function(){b._logger.log("trace","tcp:"+b.ip+" close socket");c.onClose()});f._doConnect&&"function"==typeof f._doConnect&&f._doConnect()};f.prototype.toJSON=function(){return{sys:xnm.aio.mcontrol.DM.SYS,ip:this.ip,port:this.port}};f.prototype.equalsTo=function(b){return b&&b instanceof f?this.ip==b.ip&&this.port==b.port:!1};return f}();
xnm.aio.mcontrol.DMError=function(e,b){this.code=e;this.message=b;this.stack=Error().stack};xnm.aio.mcontrol.DMError.prototype=Error();xnm.aio.mcontrol.DMError.prototype.name="MControlDMError";xnm.aio.mcontrol.DMError.prototype.code=0;xnm.aio.mcontrol.DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};
xnm.aio.mcontrol.DM={SYS:"mcontrol",MAP:{command:[{type:"string",name:"do",ref:{value:"do",ext:"%s"}},{type:"int",name:"set integer value",ref:{value:"setInt",ext:"%d"}},{type:"float",name:"set float value",ref:{value:"setFloat",ext:"%f"}}],status:[{type:"string",name:"value",ref:{value:"state"}},{type:"int",name:"value as integer",ref:{value:"intVal"}},{type:"float",name:"value as float",ref:{value:"floatVal"}}]},getGatewayType:function(){return[{sys:this.SYS,name:"mControl",port:8082}]},createGateway:function(e,
b,d){b=xnm.aio.mcontrol.DMError;var g=xnm.aio.mcontrol.DMError.ERROR_CODE;e?e.ip?d(null,e):d(new b(g.INVALID,"ip is invalid")):d(new b(g.INVALID,"info is invalid"))},updateGateway:function(e,b,d,g){e=xnm.aio.mcontrol.DMError;d=xnm.aio.mcontrol.DMError.ERROR_CODE;b?b.ip?g(null,b):g(new e(d.INVALID,"ip is invalid")):g(new e(d.INVALID,"update is invalid"))},deleteGateway:function(e,b,d){d()},createDevice:function(e,b,d){var g=xnm.aio.mcontrol.DMError,f=xnm.aio.mcontrol.DMError.ERROR_CODE;if(e)if(e.gateway)if(e.address)if(b.data&&
b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var c,a;for(c=0;c<b.length;c++)if(b[c].index===e.gateway){a=b[c];break}a?d(null,e):d(new g(f.NOT_FOUND,"gateway with index "+e.gateway+" not exists"))}else d(new g(f.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));else d(new g(f.INVALID,"address is invalid"));else d(new g(f.INVALID,"gateway is invalid"));else d(new g(f.INVALID,"info is invalid"))},updateDevice:function(e,b,d){var g=xnm.aio.mcontrol.DMError,f=xnm.aio.mcontrol.DMError.ERROR_CODE;
if(e)if(e.gateway)if(e.address)if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var c,a;for(c=0;c<b.length;c++)if(b[c].index===e.gateway){a=b[c];break}a?d(null,e):d(new g(f.NOT_FOUND,"gateway with index "+e.gateway+" not exists"))}else d(new g(f.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));else d(new g(f.INVALID,"address is invalid"));else d(new g(f.INVALID,"gateway is invalid"));else d(new g(f.INVALID,"info is invalid"))},deleteDevice:function(e,b,d){d()},applyUIFilter:function(e,
b){var d=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},g=function(a,b,c){var f=[];switch(c.catagory){case "command":a.command&&a.command.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),f.push(a))});break;case "status":a.status&&a.status.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),f.push(a))})}return f},f=function(a,b){var c=[],d=null;if(d=JSON.parse(JSON.stringify(xnm.aio.mcontrol.DM.MAP)))d=g(d,
a,b),c=c.concat(d);return c};if(!e)return null;var c=JSON.parse(JSON.stringify(e)),a=null;switch(b.catagory){case "command":a=f(e,b);c.command=a;break;case "status":a=f(e,b);c.status=a;break;default:return null}return a&&0!=a.length?c:null}};
xnm.aio.mcontrol.Handler=function(){var e=function(){};e.prototype.MControl=xnm.aio.mcontrol.MControl;e.prototype.devicemanager=xnm.aio.mcontrol.DM;e.prototype.registModule=function(b){b.register(this.devicemanager.SYS,"mcontrol")};e.prototype.resolveGateway=function(b){return b&&b.ip?new xnm.aio.mcontrol.MControl(b.ip,b.port):null};e.prototype.getDeviceCommands=function(b,d){var e=xnm.aio.mcontrol.DM.applyUIFilter(b,{catagory:"command",elems:"*"}),e=e?e.command:[];d&&d(null,e)};e.prototype.getDeviceStatus=
function(b,d){var e=xnm.aio.mcontrol.DM.applyUIFilter(b,{catagory:"status",elems:"*"}),e=e?e.status:[];d&&d(null,e)};e.prototype.doCommand=function(b,d,e,f){(b=this.resolveGateway(b))?b.executeCommandCreator(d,e,function(b){f&&f(b)}):f&&f(Error("gateway json format invalid"))};e.prototype.doStatus=function(b,d,e,f,c){(d=this.resolveGateway(d))?d.getStatesCreator(null,[{id:b,device:e,status:f}],function(a,b){a?c&&c(a):c&&c(null,b[0])}):c&&c(Error("gateway json format invalid"))};return e}();
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.mcontrol.Handler);
