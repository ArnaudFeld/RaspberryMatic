var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.osram=xnm.aio.osram||{};xnm.aio.osram.DMError=function(){var g=function(f,a){this.code=f;this.message=a;this.stack=Error().stack};g.prototype=Error();g.prototype.name="OsramDmError";g.prototype.code=0;g.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return g}();
xnm.aio.osram.Lightify=function(){var g={_arr2str:function(a){for(var c="",b=0,d=0,e=0,f=0;b<a.length&&0!=a[b];)d=a[b],128>d?(c+=String.fromCharCode(d),b++):191<d&&224>d?(e=a[b+1],c+=String.fromCharCode((d&31)<<6|e&63),b+=2):(e=a[b+1],f=a[b+2],c+=String.fromCharCode((d&15)<<12|(e&63)<<6|f&63),b+=3);return c},_hex2arr:function(a){for(var c=[],b=0;b<a.length;b+=2)c.push(parseInt(a.substr(b,2),16));return c},_arr2hex:function(a){for(var c="",b=0;b<a.length;b++){for(var d=a[b].toString(16);2>d.length;)d=
"0"+d;c+=d.toUpperCase()}return c}},f=function(a,c,b){this._logger=require("x.logger.js").getLogger("xnm.aio.osram.Lightify");this.uuid=b;this.ip=a;this.port=c;if(!c||0>c)this.port=4E3;f._SB.addBuffer(this);this._socket=null};f.SO_TIMEOUT=5E3;f._SB={_buffer:{},addBuffer:function(a){var c=this.getBuffer(a);c||(c={lightify:a,dataBuffer:"",packetBuffer:[],reqId:0,status:0},this._buffer[a.ip+":"+a.port]=c);return c},getBuffer:function(a){return this._buffer[a.ip+":"+a.port]},_getNextReqId:function(a){a=
this.getBuffer(a);a.reqId+=1;return a.reqId},addPacket:function(a,c,b){var d=this.addBuffer(a),e=this._getNextReqId(a);c.reqId=e;c={reqId:e,frame:c,callback:b,timeout:null};e=d.packetBuffer.length;switch(d.status){case 0:d.packetBuffer.push(c);d.status=1;d.lightify._connect();break;case 1:d.packetBuffer.push(c);break;case 2:d.packetBuffer.push(c);0==e&&this._sendNextPacket(a);break;case 3:b(Error("socket is closing"))}},removePacket:function(a,c){c.timeout&&(clearTimeout(c.timeout),c.timeout=null);
var b=this.getBuffer(a);if(b&&b.packetBuffer){for(var d=-1,e=0;e<b.packetBuffer.length;e++)if(b.packetBuffer[e]===c){d=e;break}-1!=d&&b.packetBuffer.splice(d,1)}},_sendNextPacket:function(a){var c=this.getBuffer(a);c&&c.packetBuffer&&c.packetBuffer[0]&&this._sendPacket(a,c.packetBuffer[0])},_sendPacket:function(a,c){var b=this.getBuffer(a);if(b&&b.lightify){var d=this;c.timeout=setTimeout(function(){c.timeout=null;d.removePacket(a,c);d._sendNextPacket(a);c.callback&&c.callback(Error("frame response timeout"))},
5E3);b.lightify._logger.log("debug","send frame:"+JSON.stringify(c.frame));b.lightify._send(c.frame.flag,c.frame.cmd,c.frame.reqId,c.frame.payload)}},_clearPackets:function(a,c){var b=this.getBuffer(a);if(b&&b.packetBuffer){var d,e=[];for(d=0;d<b.packetBuffer.length;d++)e.push(b.packetBuffer[d]);b.packetBuffer=[];for(d=0;d<e.length;d++)e[d]&&e[d].callback&&(e[d].timeout&&clearTimeout(e[d].timeout),e[d].callback(c),e[d].callback=null)}},_resolveData:function(a){var c=this.getBuffer(a);if(c&&c.dataBuffer&&
4<c.dataBuffer.length){var b=parseInt(c.dataBuffer.substr(0,2),16),b=(parseInt(c.dataBuffer.substr(2,2),16)<<8)+b;if(c.dataBuffer.length>=4+2*b){var d=c.dataBuffer.substr(0,4+2*b);c.dataBuffer=c.dataBuffer.substr(4+2*b);(b=a._hex2frame(d))&&this._onFrame(a,b);c.dataBuffer&&this._resolveData(a)}}},_onFrame:function(a,c){var b=this.getBuffer(a);if(b&&b.packetBuffer){for(var d=null,e=0;e<b.packetBuffer.length;e++)if(b.packetBuffer[e]&&b.packetBuffer[e].reqId==c.reqId){d=b.packetBuffer[e];break}d&&(this.removePacket(a,
d),this._sendNextPacket(a),d.callback&&d.callback(null,c))}},_onSocketConnect:function(a){var c=this.getBuffer(a);c&&(c.status=2,this._sendNextPacket(a))},_onSocketTimeout:function(a){var c=this.getBuffer(a);c&&1==c.status&&(c.status=0,this._clearPackets(a,Error("socket connection timeout")))},_onSocketError:function(a,c){var b=this.getBuffer(a);if(b)switch(b.status){case 0:case 1:case 3:b.status=0;break;case 2:b.status=3,a._close()}this._clearPackets(a,c)},_onSocketClose:function(a){var c=this.getBuffer(a);
c&&(c.status=0,this._clearPackets(a,Error("socket closed")))},_onSocketData:function(a,c){var b=this.getBuffer(a);b&&(b.dataBuffer+=c);this._resolveData(a)}};f.prototype.executeCommandCreator=function(a,c,b){a?c?this._doCommand(a,c,b):b&&b(Error("command is null")):b&&b(Error("device is null"))};f.prototype.executeCommand=function(a,c,b){var d={};6==c.length||8==c.length?(d.value="rgbw",d.ext=c):4==c.length?(d.value="ct",d.ext=parseInt(c)):2==c.length&&0<=parseInt(c)&&100>=parseInt(c)?(d.value="bri",
d.ext=c):d.value=c;this.executeCommandCreator(a,d,b)};f.prototype.getStateValues=function(a,c){var b={};c&&(b.state=c.onoff?"on":"off",c.level&&(b.bri=c.level));return b};f.prototype.getStates=function(a,c,b){this.getStatesCreator(a,c,b)};f.prototype.getStatesCreator=function(a,c,b){var d=this;this.CommandHandler=a;this._getAllNodeState(function(a,f){!a&&f&&d._logger.log("debug","get all node state response:"+JSON.stringify(f));var g={};if(f)for(var h=Object.keys(f),k=0;k<h.length;k++)g[h[k]]=d._resolveRawState(f[h[k]]);
if(f&&d.CommandHandler&&d.CommandHandler.receivedState)for(var l in f)d.CommandHandler.receivedState("lightify",l,f[l]);if(c){h=[];for(k=0;k<c.length;k++)if((l=c[k])&&l.id){var m="?";l.device&&l.device.address&&l.status&&l.status.value&&!a&&g&&(g[l.device.address]&&(m=g[l.device.address][l.status.value]),null==m&&"undefined"==typeof m&&(m="?"));h.push({id:l.id,status:m})}b&&b(null,h)}else b&&b(Error("deviceList is null"))})};f.prototype.listNodes=function(a){this._networkListNodes(function(c,b){if(c)a&&
a(c);else{var d=[];if(b)for(var e=0;e<b.length;e++)if(b[e]&&b[e].id64){var f={type:"light",data:b[e].type,name:b[e].name,address:b[e].id64};"10"==b[e].type&&(f.type="plug");d.push(f)}a&&a(null,d)}})};f.prototype.listZones=function(a){this._networkListZones(function(c,b){if(c)a&&a(c);else{var d=[];if(b)for(var e=0;e<b.length;e++)b[e]&&b[e].id&&d.push({type:"group",data:"00",address:b[e].id,name:b[e].name});a&&a(null,d)}})};f.prototype._doCommand=function(a,c,b){if(a&&c)if(c.value){var d=this;switch(c.value){case "toggle":case "up":case "down":this._getAllNodeState(function(e,
f){if(e)b&&b(e);else{var g=f[a.address];if(g)switch(c.value){case "toggle":d._doCommand(a,{value:g.onoff?"off":"on"},function(a,c){b&&b(a,c)});break;case "up":case "down":var h=g.level;if("up"==c.value)h=0==g.onoff?10:h+10;else if(0==g.onoff){b&&b(null);break}else h-=10;100<h&&(h=100);0>h&&(h=0);d._doCommand(a,{value:"bri",ext:h},function(a,c){b&&b(a,c)});break;default:b&&b(null)}else b&&b(Error("no such device in network"))}});break;case "bri":if(0==parseInt(c.ext)){this._doCommand(a,{value:"bri",
ext:1},function(c,f){c?b&&b(c):d._doCommand(a,{value:"off"},function(a,c){b&&b(a,c)})});break}default:this._buildCommandReq(a,c,function(a,c){a?b&&b(a):(d._logger.log("debug","send command frame:"+JSON.stringify(c)),f._SB.addPacket(d,c,function(a,e){a?(d._logger.log("debug","receive command response error:"+a.message),b&&b(a)):(d._logger.log("debug","receive command response:"+JSON.stringify(e)),(a=d._statusError(e.status))?(d._logger.log("debug","receive command response status error:"+a.message),
b&&b(a)):b&&b(null,c))}))})}}else b&&b(Error("command invalid"));else b&&b(Error("invalid parameters"))};f.prototype._getAllNodeState=function(a){this._networkListNodes(function(c,b){if(c)a&&a(c);else{var d={};if(b)for(var e=0;e<b.length;e++)b[e]&&b[e].id64&&(d[b[e].id64]={online:parseInt(b[e].online,16),onoff:parseInt(b[e].onoff,16),level:parseInt(b[e].level,16),colorTemp:parseInt(b[e].cct.substr(2,2)+b[e].cct.substr(0,2),16),red:parseInt(b[e].red,16),green:parseInt(b[e].green,16),blue:parseInt(b[e].blue,
16),white:parseInt(b[e].white,16)});a&&a(null,d)}})};f.prototype._networkListNodes=function(a){this._logger.log("debug","send network list node request");var c=this;f._SB.addPacket(this,{flag:0,cmd:19,payload:[1]},function(b,d){b?(c._logger.log("debug","receive network list node response error:"+b.message),a&&a(b)):(c._logger.log("debug","receive network_list_nodes response:"+JSON.stringify(d)),b=c._statusError(d.status),a&&a(b,d.nodes))})};f.prototype._networkListZones=function(a){this._logger.log("debug",
"send network list zones request");var c=this;f._SB.addPacket(this,{flag:2,cmd:30,payload:[]},function(b,d){b?(c._logger.log("debug","receive network list zones response error:"+b.message),a&&a(b)):(c._logger.log("debug","receive network_list_zones response:"+JSON.stringify(d)),b=c._statusError(d.status),a&&a(b,d.zones))})};f.prototype._buildCommandReq=function(a,c,b){if(a&&a.address&&c&&c.value){var d=!1;4==a.address.length&&(d=!0);var e=d?2:0;switch(c.value){case "on":case "off":a=a.address;d&&
(a+="000000000000");a=g._hex2arr(a);a.push("on"==c.value?1:0);d=50;break;case "bri":if(null==c.ext||"undefined"==typeof c.ext){b(Error("command invalid"));return}e|=128;c=parseInt(c.ext);100<c&&(c=100);0>c&&(c=0);a=a.address;d&&(a+="000000000000");a=g._hex2arr(a);a.push(c);a=a.concat([1,0]);d=49;break;case "ct":if(null==c.ext||"undefined"==typeof c.ext){b(Error("command invalid"));return}e|=128;c=parseInt(c.ext);2E3>c&&(c=2E3);a=a.address;d&&(a+="000000000000");a=g._hex2arr(a);a.push(c&255);a.push(c>>
8&255);a=a.concat([1,0]);d=51;break;case "rgbwS":case "rgbw":if(!c.ext){b(Error("command invalid"));return}c=g._hex2arr(c.ext);4>c.length&&c.push(0);4<c.length&&(c=c.slice(0,4));a=a.address;d&&(a+="000000000000");a=g._hex2arr(a);a=a.concat(c);a=a.concat([1,0]);d=54;break;case "effect":if(!c.ext){b(Error("command invalid"));return}a=a.address;d&&(a+="000000000000");a=g._hex2arr(a);if("none"==c.ext)a.push(0),a=a.concat([0,0]);else if("colorloop"==c.ext)a.push(1),a=a.concat([15,0]);else{b(Error("command invalid"));
return}d=55;break;default:b(Error("unknow command:"+c.value),null);return}b(null,{flag:e,cmd:d,payload:a})}else b(Error("build command req parameters invalid"))};f.prototype._resolveRawState=function(a){var c=a.red.toString(16);2!=c.length&&(c="0"+c);var b=a.green.toString(16);2!=b.length&&(b="0"+b);var d=a.blue.toString(16);2!=d.length&&(d="0"+d);var e=a.white.toString(16);2!=e.length&&(e="0"+e);return{power:a.onoff?"on":"off",bri:a.onoff?a.level:0,ct:a.colorTemp,rgbw:(c+b+d+e).toUpperCase()}};f.prototype._statusError=
function(a){var c=null;switch(a){case 16:case 17:case 18:case 21:case 255:c=Error("error code:"+a)}return c};f.prototype._buildFrame=function(a,c,b,d){var e=[],f=6+d.length;e.push(f&255);e.push(f>>8&255);e.push(a);e.push(c);e.push(b&255);e.push(b>>8&255);e.push(b>>16&255);e.push(b>>24&255);return e=e.concat(d)};f.prototype._connect=function(){this._logger.log("trace","connect");var a=this,c=!1,b=require("net").connect({port:this.port,host:this.ip});b.setTimeout(f.SO_TIMEOUT);b.setEncoding("hex");
b.on("connect",function(){a._logger.log("trace","connect to lightify:"+a.ip);c=!0;a._socket=b;f._SB._onSocketConnect(a,b)});b.on("data",function(c){a._logger.log("trace","receive from lightify:"+a.ip+" data:"+c);f._SB._onSocketData(a,c)});b.on("error",function(b){c?a._logger.log("trace","lightify:"+a.ip+" error:"+b.message):a._logger.log("trace","lightify:"+a.ip+" connection error:"+b.message);f._SB._onSocketError(a,b)});b.on("timeout",function(){c?a._logger.log("trace","hub:"+a.ip+" data timeout"):
a._logger.log("trace","lightify:"+a.ip+" connection timeout");f._SB._onSocketTimeout(a)});b.on("close",function(){a._logger.log("trace","hub:"+a.ip+" close socket");f._SB._onSocketClose(a)});b._doConnect&&"function"==typeof b._doConnect&&b._doConnect()};f.prototype._send=function(a,c,b,d,e){a=this._buildFrame(a,c,b,d);this._sendRaw(a,function(a){e&&e(a,b)})};f.prototype._sendRaw=function(a,c){this._logger.log("trace","send to lightify:"+this.ip+" data:"+g._arr2hex(a));this._socket.write(new Buffer(a));
c&&c()};f.prototype._close=function(){this._logger.log("trace","close");this._socket&&this._socket.end()};f.prototype._hex2frame=function(a){var c=g._hex2arr(a);if(6>(c[1]<<8)+c[0])return null;a={flag:c[2],cmd:c[3]};a.reqId=c[4]+(c[5]<<8)+(c[6]<<16)+(c[7]<<24);a.payload=c.slice(8);a.valid=!1;switch(a.cmd){case 19:if(3<=a.payload.length&&(a.valid=!0,a.status=a.payload[0],a.num=a.payload[1]+(a.payload[2]<<8),a.nodes=[],0<a.num))for(c=0;c<a.num&&!(a.payload.length<3+50*(c+1));c++){var b=a.payload.slice(3+
50*c,3+50*(c+1)),d={};d.id16=g._arr2hex(b.slice(0,2));d.id64=g._arr2hex(b.slice(2,10));d.type=g._arr2hex(b.slice(10,11));d.majorVer=g._arr2hex(b.slice(11,12));d.minorVer=g._arr2hex(b.slice(12,13));d.patchVer=g._arr2hex(b.slice(13,14));d.buildVer=g._arr2hex(b.slice(14,15));d.online=g._arr2hex(b.slice(15,16));d.groupMember=g._arr2hex(b.slice(16,18));d.onoff=g._arr2hex(b.slice(18,19));d.level=g._arr2hex(b.slice(19,20));d.cct=g._arr2hex(b.slice(20,22));d.red=g._arr2hex(b.slice(22,23));d.green=g._arr2hex(b.slice(23,
24));d.blue=g._arr2hex(b.slice(24,25));d.white=g._arr2hex(b.slice(25,26));d.name=b.slice(26,42);d.name=g._arr2str(d.name);a.nodes.push(d)}break;case 30:if(3<=a.payload.length&&(a.valid=!0,a.status=a.payload[0],a.num=a.payload[1]+(a.payload[2]<<8),a.zones=[],0<a.num))for(c=0;c<a.num&&!(a.payload.length<3+18*(c+1));c++)b={},b.id=a.payload.slice(3+18*c,18*c+5),b.id=g._arr2hex(b.id),b.name=a.payload.slice(18*c+5,18*c+21),b.name=g._arr2str(b.name),a.zones.push(b);break;case 49:case 50:case 51:case 54:case 55:12<=
a.payload.length&&(a.valid=!0,a.status=a.payload[0],a.result=a.payload.slice(3));break;case 98:13<=a.payload.length&&(a.valid=!0,a.status=a.payload[0],a.num=a.payload[1]+(a.payload[2]<<8),a.result=a.payload.slice(3,12),a.onoff=a.payload[12]);break;case 104:13<=a.payload.length&&(a.valid=!0,a.status=a.payload[0],a.num=a.payload[1]+(a.payload[2]<<8),a.result=a.payload.slice(3,12),a.online=a.payload[12],a.onoff=a.payload[13],a.level=a.payload[14],a.colorTemp=a.payload[15]+(a.payload[16]<<8),a.red=a.payload[17],
a.green=a.payload[18],a.blue=a.payload[19],a.white=a.payload[20]);break;default:a.valid=!0}return a};f.prototype.toJSON=function(){return{sys:xnm.aio.osram.Lightify.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid}};f.prototype.equalsTo=function(a){return a&&a instanceof f?this.ip==a.ip&&this.port==a.port:!1};f.parseJSON=function(a){return a.ip?new f(a.ip,a.port):null};f.discoveryWithTimeout=function(a,c){var b=require("x.mdns.js");b.clearRecordBuffer();b.discoverServiceWithTimeout("_http._tcp.local",
a,function(a,b){if(a)c&&c(a);else{for(var g=[],n=0;n<b.length;n++){var h=b[n];if(h.target&&h.ip&&0<h.ip.length&&0==h.target.indexOf("Lightify")){var k=h.target.substr(9),k=k.replace(".local",""),h=new f(h.ip[0]);h.uuid=k;g.push(h)}}c&&c(a,g)}})};return f}();
xnm.aio.osram.Lightify.DM=function(){var g=xnm.aio.osram.DMError,f=xnm.aio.osram.DMError.ERROR_CODE,a=function(a,b,d){if(a)if(a.gateway)if(a.type)if(null==a.data||"undefined"==typeof a.data)d(new g(f.INVALID,"data is invalid"));else if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var e,p;for(e=0;e<b.length;e++)if(b[e].index===a.gateway){p=b[e];break}p?d():d(new g(f.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else d(new g(f.NOT_FOUND,"gateway with index "+a.gateway+
" not exists"));else d(new g(f.INVALID,"type is invalid"));else d(new g(f.INVALID,"gateway is invalid"));else d(new g(f.INVALID,"info is invalid"))};return{SYS:"lightify",MAP:{onoff:{command:[{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}}],status:[{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}}]},dimmable:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},
{type:"int",name:"brightness",ref:{value:"bri",ext:"%d",extMeta:"0-100"}}],status:[{type:"int",name:"brightness",ref:{value:"bri",extMeta:"0-100"}}]},colortemp:{command:[{type:"int",name:"color temperature",ref:{value:"ct",ext:"%d",extMeta:"2700-6500",scale:"38"}}],status:[{type:"int",name:"color temperature",ref:{value:"ct",extMeta:"2700-6500",scale:"38"}}]},colorlight:{command:[{type:"string",name:"rgbw color",ref:{value:"rgbwS",ext:"%s"}},{type:"rgbw",name:"rgbw color",ref:{value:"rgbw",ext:"%s"}},
{type:"enum",name:"effect",ref:{value:"effect",ext:"%e",extMeta:["none","colorloop"]}}],status:[{type:"rgbw",name:"rgbw color",ref:{value:"rgbw"}}]},extendcolor:{},group:{command:[{type:"int",name:"do scene",ref:{value:"doScene",ext:"%d"}}]}},registModule:function(a){a.register(this.SYS,"osram")},getGatewayType:function(){return{sys:this.SYS,name:"OSRAM LIGHTIFY / LEDvance Gateway",port:4E3}},getGatewayDeviceType:function(){var a={sys:this.SYS,type:"light",name:"Light",subtypes:[]};a.subtypes.push({id:"OnOff Light",
data:1});a.subtypes.push({id:"Color Dimmer Light",data:2});a.subtypes.push({id:"Dimmer Light",data:4});a.subtypes.push({id:"Color Light",data:8});a.subtypes.push({id:"Extended Color Light",data:10});return[a,{sys:this.SYS,type:"group",name:"Group"}]},createGateway:function(a,b,d){a?a.ip?d(null,a):d(new g(f.INVALID,"ip is invalid")):d(new g(f.INVALID,"info is invalid"))},updateGateway:function(a,b,d,e){b?b.ip?e(null,b):e(new g(f.INVALID,"ip is invalid")):e(new g(f.INVALID,"update is invalid"))},deleteGateway:function(a,
b,d){d()},createDevice:function(c,b,d){a(c,b,function(a){d(a,c)})},updateDevice:function(c,b,d){a(c,b,function(a){d(a,c)})},deleteDevice:function(a,b,d){d(null,a)},getCommandStatusMap:function(a){var b=function(a){return JSON.parse(JSON.stringify(a))};if(!a)return null;var d={command:[],status:[]},e=0;if("light"==a.type||"plug"==a.type)e=10,null!=a.data&&"undefined"!=typeof a.data&&(e=parseInt(a.data,16));switch(e){case 0:d.command=d.command.concat(b(this.MAP.group.command));d.command=d.command.concat(b(this.MAP.colorlight.command));
d.command=d.command.concat(b(this.MAP.colortemp.command));d.command.push(b(this.MAP.dimmable.command[2]));d.command.push(b(this.MAP.onoff.command[1]));d.command.push(b(this.MAP.onoff.command[2]));break;case 10:case 8:d.command=d.command.concat(b(this.MAP.colorlight.command)),d.status=d.status.concat(b(this.MAP.colorlight.status));case 2:a=b(this.MAP.colortemp.command);var f=b(this.MAP.colortemp.status);if(10==e){for(var g=0;g<a.length;g++)a[g]&&a[g].ref&&"ct"==a[g].ref.value&&(a[g].ref.extMeta="2000-6500",
a[g].ref.scale="15");for(g=0;g<f.length;g++)f[g]&&f[g].ref&&"ct"==f[g].ref.value&&(a[g].ref.extMeta="2000-6500",a[g].ref.scale="15")}d.command=d.command.concat(a);d.status=d.status.concat(f);case 4:d.command=d.command.concat(b(this.MAP.dimmable.command)),d.status=d.status.concat(b(this.MAP.dimmable.status));case 1:case 16:d.command=d.command.concat(b(this.MAP.onoff.command)),d.status=d.status.concat(b(this.MAP.onoff.status))}0==e&&delete d.status;return d}}}();
xnm.aio.osram.DM=function(){var g=xnm.aio.osram.DMError,f=xnm.aio.osram.DMError.ERROR_CODE;return{getGatewayType:function(){var a=[],c;for(c in xnm.aio.osram)if(xnm.aio.osram.hasOwnProperty(c)){var b=xnm.aio.osram[c];b&&b.DM&&b.DM.getGatewayType&&(b=b.DM.getGatewayType())&&a.push(b)}return a},getGatewayDeviceType:function(a){var c=[],b;for(b in xnm.aio.osram)if(xnm.aio.osram.hasOwnProperty(b)){var d=xnm.aio.osram[b];d&&d.DM&&d.DM.getGatewayDeviceType&&(d=d.DM.getGatewayDeviceType(a))&&(Array.isArray(d)?
c=c.concat(d):c.push(d))}return c},getIPDeviceType:function(a,c){var b=[],d;for(d in xnm.aio.osram)if(xnm.aio.osram.hasOwnProperty(d)){var e=xnm.aio.osram[d];e&&e.DM&&e.DM.getIPDeviceType&&(e=e.DM.getIPDeviceType(a,c))&&b.push(e)}return b},_getSystem:function(a){for(var c in xnm.aio.osram)if(xnm.aio.osram.hasOwnProperty(c)){var b=xnm.aio.osram[c];if(b&&b.DM&&b.DM.SYS&&b.DM.SYS==a)return b}return null},_checkSystemMethod:function(a,c,b){if(a)if(a.sys){var d=this._getSystem(a.sys);d&&d.DM&&d.DM[c]?
b&&b(null,d):b&&b(new g(f.INVALID,"no such sys:"+a.sys))}else b&&b(new g(f.INVALID,"sys is invalid"));else b&&b(new g(f.INVALID,"info is invalid"))},createGateway:function(a,c,b){this._checkSystemMethod(a,"createGateway",function(d,e){d?b&&b(d):e.DM.createGateway(a,c,b)})},updateGateway:function(a,c,b,d){this._checkSystemMethod(c,"updateGateway",function(e,f){e?d&&d(e):f.DM.updateGateway(a,c,b,d)})},deleteGateway:function(a,c,b){this._checkSystemMethod(a,"deleteGateway",function(d,e){d?b&&b(d):e.DM.deleteGateway(a,
c,b)})},createDevice:function(a,c,b){this._checkSystemMethod(a,"createDevice",function(d,e){d?b&&b(d):e.DM.createDevice(a,c,b)})},updateDevice:function(a,c,b){this._checkSystemMethod(a,"updateDevice",function(d,e){d?b&&b(d):e.DM.updateDevice(a,c,b)})},deleteDevice:function(a,c,b){this._checkSystemMethod(a,"deleteDevice",function(d,e){d?b&&b(d):e.DM.deleteDevice(a,c,b)})},applyUIFilter:function(a,c){var b=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},
d=function(a,c,d){var e=[];switch(d.catagory){case "command":a.command&&a.command.forEach(function(a){b(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){b(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},e=function(a,b){var c=[],e=null,f;a.sys&&(e=this._getSystem(a.sys))&&e.DM&&e.DM.getCommandStatusMap&&(f=e.DM.getCommandStatusMap(a));f&&(e=d(f,a,b),c=c.concat(e));return c};if(!a.sys)return null;var f=
JSON.parse(JSON.stringify(a)),g=null;switch(c.catagory){case "command":g=e.call(this,a,c);f.command=g;break;case "status":g=e.call(this,a,c);f.status=g;break;default:return null}return g&&0!=g.length?f:null}}}();
xnm.aio.osram.Handler=function(){var g=function(){};g.prototype.devicemanager=xnm.aio.osram.DM;g.prototype.Lightify=xnm.aio.osram.Lightify;g.prototype.registModule=function(f){for(var a in xnm.aio.osram)if(xnm.aio.osram.hasOwnProperty(a)){var c=xnm.aio.osram[a];c&&c.DM&&c.DM.registModule&&c.DM.registModule(f)}};g.prototype.getStateValues=function(f,a){return(new xnm.aio.osram.Lightify).getStateValues(f,a)};g.prototype.resolveGateway=function(f){switch(f.sys){case xnm.aio.osram.Lightify.DM.SYS:return xnm.aio.osram.Lightify.parseJSON(f);
default:return null}};g.prototype.getDeviceCommands=function(f,a){var c=xnm.aio.osram.DM.applyUIFilter(f,{catagory:"command",elems:"*"}),c=c?c.command:[];a&&a(null,c)};g.prototype.getDeviceCommandList=function(f,a){var c=[];if("color-light"==f.data||"ext-color-light"==f.data||"group"==f.data)a||c.push({id:window.XC_Text.colorvalue,cmd:"colorvalue"});c.push({id:window.XC_Text.on,cmd:"on"});c.push({id:window.XC_Text.off,cmd:"off"});if(("dimmer"==f.data||"color-temp-dimmer"==f.data||"color-light"==f.data||
"ext-color-light"==f.data||"group"==f.data)&&!a)for(var b=0;100>=b;b+=5)c.push({id:window.XC_Text.dimTo+b+"%",cmd:""+b});if(("color-temp-dimmer"==f.data||"color-light"==f.data||"ext-color-light"==f.data||"group"==f.data)&&!a)for(b=2700;6500>=b;b+=380)c.push({id:window.XC_Text.colortemp+b,cmd:""+b});return c};g.prototype.getDeviceStatus=function(f,a){var c=xnm.aio.osram.DM.applyUIFilter(f,{catagory:"status",elems:"*"}),c=c?c.status:[];a&&a(null,c)};g.prototype.doCommand=function(f,a,c,b){(f=this.resolveGateway(f))?
f.executeCommandCreator(a,c,function(a){b&&b(a)}):b&&b(Error("gateway json format invalid"))};g.prototype.doStatus=function(f,a,c,b,d){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:f,device:c,status:b}],function(a,b){a?d&&d(a):d&&d(null,b[0])}):d&&d(Error("gateway json format invalid"))};g.prototype.searchLightifyWithTimeout=function(f,a){xnm.aio.osram.Lightify.discoveryWithTimeout(f,a)};g.prototype.getDeviceList=function(f,a){var c=this.resolveGateway(f);c?c instanceof xnm.aio.osram.Lightify?
c.listNodes(function(b,d){b?a&&a(b):c.listZones(function(b,c){if(b)a&&a(b);else{var f={lights:d,groups:c};a&&a(null,f)}})}):a&&a(Error("gateway do not support get device list")):a&&a(Error("gateway json format invalid"))};return g}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.osram.Handler);
