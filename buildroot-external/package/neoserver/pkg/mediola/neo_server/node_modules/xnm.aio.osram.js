var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.osram=xnm.aio.osram||{},xnm.aio.osram.DMError=function(){var e=function e(_e,t){this.code=_e,this.message=t,this.stack=new Error().stack;};return(e.prototype=new Error()).name="OsramDmError",e.prototype.code=0,e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},e;}(),xnm.aio.osram.Lightify=function(){var e=function e(_e2){for(var t="",a=0,o=0,r=0,n=0;a<_e2.length&&0!=_e2[a];)(o=_e2[a])<128?(t+=String.fromCharCode(o),a++):o>191&&o<224?(r=_e2[a+1],t+=String.fromCharCode((31&o)<<6|63&r),a+=2):(r=_e2[a+1],n=_e2[a+2],t+=String.fromCharCode((15&o)<<12|(63&r)<<6|63&n),a+=3);return t;},t=function t(e){for(var t=[],a=0;a<e.length;a+=2)t.push(parseInt(e.substr(a,2),16));return t;},a=function a(e){for(var t="",a=0;a<e.length;a++){for(var o=e[a].toString(16);o.length<2;)o="0"+o;t+=o.toUpperCase();}return t;},o=function o(e,t,a){this._logger=require("x.logger.js").getLogger("xnm.aio.osram.Lightify"),this.uuid=a,this.ip=e,this.port=t,(!t||t<0)&&(this.port=4e3),o._SB.addBuffer(this),this._socket=null;};return o.SO_TIMEOUT=5e3,o._SB={_buffer:{},addBuffer:function addBuffer(e){var t=this.getBuffer(e);return t||(t={lightify:e,dataBuffer:"",packetBuffer:[],reqId:0,status:0},this._buffer[e.ip+":"+e.port]=t),t;},getBuffer:function getBuffer(e){return this._buffer[e.ip+":"+e.port];},_getNextReqId:function _getNextReqId(e){var t=this.getBuffer(e);return t.reqId+=1,t.reqId;},addPacket:function addPacket(e,t,a){var o=this.addBuffer(e),r=this._getNextReqId(e);t.reqId=r;var n={reqId:r,frame:t,callback:a,timeout:null},i=o.packetBuffer.length;switch(o.status){case 0:o.packetBuffer.push(n),o.status=1,o.lightify._connect();break;case 1:o.packetBuffer.push(n);break;case 2:o.packetBuffer.push(n),0==i&&this._sendNextPacket(e);break;case 3:a(new Error("socket is closing"));}},removePacket:function removePacket(e,t){t.timeout&&(clearTimeout(t.timeout),t.timeout=null);var a=this.getBuffer(e);if(a&&a.packetBuffer){for(var o=-1,r=0;r<a.packetBuffer.length;r++)if(a.packetBuffer[r]===t){o=r;break;}-1!=o&&a.packetBuffer.splice(o,1);}},_sendNextPacket:function _sendNextPacket(e){var t=this.getBuffer(e);t&&t.packetBuffer&&t.packetBuffer[0]&&this._sendPacket(e,t.packetBuffer[0]);},_sendPacket:function _sendPacket(e,t){var a=this.getBuffer(e);if(a&&a.lightify){var o=this;t.timeout=setTimeout(function(){t.timeout=null,o.removePacket(e,t),o._sendNextPacket(e),t.callback&&t.callback(new Error("frame response timeout"));},5e3),a.lightify._logger.log("debug","send frame:"+JSON.stringify(t.frame)),a.lightify._send(t.frame.flag,t.frame.cmd,t.frame.reqId,t.frame.payload);}},_clearPackets:function _clearPackets(e,t){var a=this.getBuffer(e);if(a&&a.packetBuffer){var o,r=[];for(o=0;o<a.packetBuffer.length;o++)r.push(a.packetBuffer[o]);for(a.packetBuffer=[],o=0;o<r.length;o++)r[o]&&r[o].callback&&(r[o].timeout&&clearTimeout(r[o].timeout),r[o].callback(t),r[o].callback=null);}},_resolveData:function _resolveData(e){var t=this.getBuffer(e);if(t&&t.dataBuffer&&t.dataBuffer.length>4){var a=parseInt(t.dataBuffer.substr(0,2),16),o=(parseInt(t.dataBuffer.substr(2,2),16)<<8)+a;if(t.dataBuffer.length>=4+2*o){var r=t.dataBuffer.substr(0,4+2*o);t.dataBuffer=t.dataBuffer.substr(4+2*o);var n=e._hex2frame(r);n&&this._onFrame(e,n),t.dataBuffer&&this._resolveData(e);}}},_onFrame:function _onFrame(e,t){var a=this.getBuffer(e);if(a&&a.packetBuffer){for(var o=null,r=0;r<a.packetBuffer.length;r++)if(a.packetBuffer[r]&&a.packetBuffer[r].reqId==t.reqId){o=a.packetBuffer[r];break;}o&&(this.removePacket(e,o),this._sendNextPacket(e),o.callback&&o.callback(null,t));}},_onSocketConnect:function _onSocketConnect(e){var t=this.getBuffer(e);t&&(t.status=2,this._sendNextPacket(e));},_onSocketTimeout:function _onSocketTimeout(e){var t=this.getBuffer(e);t&&1==t.status&&(t.status=0,this._clearPackets(e,new Error("socket connection timeout")));},_onSocketError:function _onSocketError(e,t){var a=this.getBuffer(e);if(a)switch(a.status){case 0:case 1:case 3:a.status=0;break;case 2:a.status=3,e._close();}this._clearPackets(e,t);},_onSocketClose:function _onSocketClose(e){var t=this.getBuffer(e);t&&(t.status=0,this._clearPackets(e,new Error("socket closed")));},_onSocketData:function _onSocketData(e,t){var a=this.getBuffer(e);a&&(a.dataBuffer+=t),this._resolveData(e);}},o.prototype.executeCommandCreator=function(e,t,a){e?t?this._doCommand(e,t,a):a&&a(new Error("command is null")):a&&a(new Error("device is null"));},o.prototype.executeCommand=function(e,t,a){var o={};6==t.length||8==t.length?(o.value="rgbw",o.ext=t):4==t.length?(o.value="ct",o.ext=parseInt(t)):2==t.length&&parseInt(t)>=0&&parseInt(t)<=100?(o.value="bri",o.ext=t):o.value=t,this.executeCommandCreator(e,o,a);},o.prototype.getStateValues=function(e,t){var a={};return t&&(t.onoff?a.state="on":a.state="off",t.level&&(a.bri=t.level)),a;},o.prototype.getStates=function(e,t,a){this.getStatesCreator(e,t,a);},o.prototype.getStatesCreator=function(e,t,a){var o=this;this.CommandHandler=e,this._getAllNodeState(function(e,r){!e&&r&&o._logger.log("debug","get all node state response:"+JSON.stringify(r));var n={};if(r)for(var i=Object.keys(r),s=0;s<i.length;s++)n[i[s]]=o._resolveRawState(r[i[s]]);if(r&&o.CommandHandler&&o.CommandHandler.receivedState)for(var c in r)o.CommandHandler.receivedState("lightify",c,r[c]);if(t){for(var u=[],l=0;l<t.length;l++){var f=t[l];if(f&&f.id){var d="?";f.device&&f.device.address&&f.status&&f.status.value&&!e&&n&&(n[f.device.address]&&(d=n[f.device.address][f.status.value]),null==d&&void 0===d&&(d="?")),u.push({id:f.id,status:d});}}a&&a(null,u);}else a&&a(new Error("deviceList is null"));});},o.prototype.listNodes=function(e){this._networkListNodes(function(t,a){if(t)e&&e(t);else{var o=[];if(a)for(var r=0;r<a.length;r++)if(a[r]&&a[r].id64){var n={type:"light",data:a[r].type,name:a[r].name,address:a[r].id64};"10"==a[r].type&&(n.type="plug"),o.push(n);}e&&e(null,o);}});},o.prototype.listZones=function(e){this._networkListZones(function(t,a){if(t)e&&e(t);else{var o=[];if(a)for(var r=0;r<a.length;r++)a[r]&&a[r].id&&o.push({type:"group",data:"00",address:a[r].id,name:a[r].name});e&&e(null,o);}});},o.prototype._doCommand=function(e,t,a){if(e&&t){if(t.value){var r=this;switch(t.value){case"toggle":case"up":case"down":this._getAllNodeState(function(o,n){if(o)a&&a(o);else{var i=n[e.address];if(i)switch(t.value){case"toggle":r._doCommand(e,{value:i.onoff?"off":"on"},function(e,t){a&&a(e,t);});break;case"up":case"down":var s=i.level;if("up"==t.value)0==i.onoff?s=10:s+=10;else{if(0==i.onoff)return void(a&&a(null));s-=10;}s>100&&(s=100),s<0&&(s=0),r._doCommand(e,{value:"bri",ext:s},function(e,t){a&&a(e,t);});break;default:a&&a(null);}else a&&a(new Error("no such device in network"));}});break;case"bri":if(0==parseInt(t.ext)){this._doCommand(e,{value:"bri",ext:1},function(t,o){t?a&&a(t):r._doCommand(e,{value:"off"},function(e,t){a&&a(e,t);});});break;}default:this._buildCommandReq(e,t,function(e,t){e?a&&a(e):(r._logger.log("debug","send command frame:"+JSON.stringify(t)),o._SB.addPacket(r,t,function(e,o){return e?(r._logger.log("debug","receive command response error:"+e.message),void(a&&a(e))):(r._logger.log("debug","receive command response:"+JSON.stringify(o)),(e=r._statusError(o.status))?(r._logger.log("debug","receive command response status error:"+e.message),void(a&&a(e))):void(a&&a(null,t)));}));});}}else a&&a(new Error("command invalid"));}else a&&a(new Error("invalid parameters"));},o.prototype._getAllNodeState=function(e){this._networkListNodes(function(t,a){if(t)e&&e(t);else{var o={};if(a)for(var r=0;r<a.length;r++)a[r]&&a[r].id64&&(o[a[r].id64]={online:parseInt(a[r].online,16),onoff:parseInt(a[r].onoff,16),level:parseInt(a[r].level,16),colorTemp:parseInt(a[r].cct.substr(2,2)+a[r].cct.substr(0,2),16),red:parseInt(a[r].red,16),green:parseInt(a[r].green,16),blue:parseInt(a[r].blue,16),white:parseInt(a[r].white,16)});e&&e(null,o);}});},o.prototype._networkListNodes=function(e){this._logger.log("debug","send network list node request");var t=this;o._SB.addPacket(this,{flag:0,cmd:19,payload:[1]},function(a,o){if(a)return t._logger.log("debug","receive network list node response error:"+a.message),void(e&&e(a));t._logger.log("debug","receive network_list_nodes response:"+JSON.stringify(o)),a=t._statusError(o.status),e&&e(a,o.nodes);});},o.prototype._networkListZones=function(e){this._logger.log("debug","send network list zones request");var t=this;o._SB.addPacket(this,{flag:2,cmd:30,payload:[]},function(a,o){if(a)return t._logger.log("debug","receive network list zones response error:"+a.message),void(e&&e(a));t._logger.log("debug","receive network_list_zones response:"+JSON.stringify(o)),a=t._statusError(o.status),e&&e(a,o.zones);});},o.prototype._buildCommandReq=function(e,a,o){if(e&&e.address&&a&&a.value){var r=!1;4==e.address.length&&(r=!0);var n,i,s=r?2:0;switch(a.value){case"on":case"off":i=e.address,r&&(i+="000000000000"),(i=t(i)).push("on"==a.value?1:0),n=50;break;case"bri":if(null==a.ext||void 0===a.ext)return void o(new Error("command invalid"));s|=128;var c=parseInt(a.ext);c>100&&(c=100),c<0&&(c=0),i=e.address,r&&(i+="000000000000"),(i=t(i)).push(c),i=i.concat([1,0]),n=49;break;case"ct":if(null==a.ext||void 0===a.ext)return void o(new Error("command invalid"));s|=128;var u=parseInt(a.ext);u>6500&&(c=6500),u<2e3&&(u=2e3),i=e.address,r&&(i+="000000000000"),(i=t(i)).push(255&u),i.push(u>>8&255),i=i.concat([1,0]),n=51;break;case"rgbwS":case"rgbw":if(!a.ext)return void o(new Error("command invalid"));var l=t(a.ext);l.length<4&&l.push(0),l.length>4&&(l=l.slice(0,4)),i=e.address,r&&(i+="000000000000"),i=(i=(i=t(i)).concat(l)).concat([1,0]),n=54;break;case"effect":if(!a.ext)return void o(new Error("command invalid"));if(i=e.address,r&&(i+="000000000000"),i=t(i),"none"==a.ext)i.push(0),i=i.concat([0,0]);else{if("colorloop"!=a.ext)return void o(new Error("command invalid"));i.push(1),i=i.concat([15,0]);}n=55;break;default:return void o(new Error("unknow command:"+a.value),null);}o(null,{flag:s,cmd:n,payload:i});}else o(new Error("build command req parameters invalid"));},o.prototype._resolveRawState=function(e){var t=e.red.toString(16);2!=t.length&&(t="0"+t);var a=e.green.toString(16);2!=a.length&&(a="0"+a);var o=e.blue.toString(16);2!=o.length&&(o="0"+o);var r=e.white.toString(16);return 2!=r.length&&(r="0"+r),{power:e.onoff?"on":"off",bri:e.onoff?e.level:0,ct:e.colorTemp,rgbw:(t+a+o+r).toUpperCase()};},o.prototype._statusError=function(e){var t=null;switch(e){case 16:case 17:case 18:case 21:case 255:t=new Error("error code:"+e);}return t;},o.prototype._buildFrame=function(e,t,a,o){var r=[],n=6+o.length;return r.push(255&n),r.push(n>>8&255),r.push(e),r.push(t),r.push(255&a),r.push(a>>8&255),r.push(a>>16&255),r.push(a>>24&255),r.concat(o);},o.prototype._connect=function(){this._logger.log("trace","connect");var e=this,t=!1,a=require("net"),r={port:this.port,host:this.ip},n=a.connect(r);n.setTimeout(o.SO_TIMEOUT),n.setEncoding("hex"),n.on("connect",function(){e._logger.log("trace","connect to lightify:"+e.ip),t=!0,e._socket=n,o._SB._onSocketConnect(e,n);}),n.on("data",function(t){e._logger.log("trace","receive from lightify:"+e.ip+" data:"+t),o._SB._onSocketData(e,t);}),n.on("error",function(a){t?e._logger.log("trace","lightify:"+e.ip+" error:"+a.message):e._logger.log("trace","lightify:"+e.ip+" connection error:"+a.message),o._SB._onSocketError(e,a);}),n.on("timeout",function(){t?e._logger.log("trace","hub:"+e.ip+" data timeout"):e._logger.log("trace","lightify:"+e.ip+" connection timeout"),o._SB._onSocketTimeout(e);}),n.on("close",function(){e._logger.log("trace","hub:"+e.ip+" close socket"),o._SB._onSocketClose(e);}),n._doConnect&&"function"==typeof n._doConnect&&n._doConnect();},o.prototype._send=function(e,t,a,o,r){var n=this._buildFrame(e,t,a,o);this._sendRaw(n,function(e){r&&r(e,a);});},o.prototype._sendRaw=function(e,t){this._logger.log("trace","send to lightify:"+this.ip+" data:"+a(e)),this._socket.write(new Buffer(e)),t&&t();},o.prototype._close=function(){this._logger.log("trace","close"),this._socket&&this._socket.end();},o.prototype._hex2frame=function(o){var r=function r(t){var o={};return o.id16=a(t.slice(0,2)),o.id64=a(t.slice(2,10)),o.type=a(t.slice(10,11)),o.majorVer=a(t.slice(11,12)),o.minorVer=a(t.slice(12,13)),o.patchVer=a(t.slice(13,14)),o.buildVer=a(t.slice(14,15)),o.online=a(t.slice(15,16)),o.groupMember=a(t.slice(16,18)),o.onoff=a(t.slice(18,19)),o.level=a(t.slice(19,20)),o.cct=a(t.slice(20,22)),o.red=a(t.slice(22,23)),o.green=a(t.slice(23,24)),o.blue=a(t.slice(24,25)),o.white=a(t.slice(25,26)),o.name=t.slice(26,42),o.name=e(o.name),o;},n=t(o);if((n[1]<<8)+n[0]<6)return null;var i,s={flag:n[2],cmd:n[3]};switch(s.reqId=n[4]+(n[5]<<8)+(n[6]<<16)+(n[7]<<24),s.payload=n.slice(8),s.valid=!1,s.cmd){case 19:if(s.payload.length>=3&&(s.valid=!0,s.status=s.payload[0],s.num=s.payload[1]+(s.payload[2]<<8),s.nodes=[],s.num>0))for(i=0;i<s.num&&!(s.payload.length<3+50*(i+1));i++){var c=r(s.payload.slice(3+50*i,3+50*(i+1)));s.nodes.push(c);}break;case 30:if(s.payload.length>=3&&(s.valid=!0,s.status=s.payload[0],s.num=s.payload[1]+(s.payload[2]<<8),s.zones=[],s.num>0))for(i=0;i<s.num&&!(s.payload.length<3+18*(i+1));i++){var u={};u.id=s.payload.slice(3+18*i,3+18*i+2),u.id=a(u.id),u.name=s.payload.slice(3+18*i+2,3+18*i+2+16),u.name=e(u.name),s.zones.push(u);}break;case 49:case 50:case 51:case 54:case 55:s.payload.length>=12&&(s.valid=!0,s.status=s.payload[0],s.result=s.payload.slice(3));break;case 98:s.payload.length>=13&&(s.valid=!0,s.status=s.payload[0],s.num=s.payload[1]+(s.payload[2]<<8),s.result=s.payload.slice(3,12),s.onoff=s.payload[12]);break;case 104:s.payload.length>=13&&(s.valid=!0,s.status=s.payload[0],s.num=s.payload[1]+(s.payload[2]<<8),s.result=s.payload.slice(3,12),s.online=s.payload[12],s.onoff=s.payload[13],s.level=s.payload[14],s.colorTemp=s.payload[15]+(s.payload[16]<<8),s.red=s.payload[17],s.green=s.payload[18],s.blue=s.payload[19],s.white=s.payload[20]);break;default:s.valid=!0;}return s;},o.prototype.toJSON=function(){return{sys:xnm.aio.osram.Lightify.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid};},o.prototype.equalsTo=function(e){return!!e&&e instanceof o&&this.ip==e.ip&&this.port==e.port;},o.parseJSON=function(e){return e.ip?new o(e.ip,e.port):null;},o.discoveryWithTimeout=function(e,t){var a=require("x.mdns.js");a.clearRecordBuffer(),a.discoverServiceWithTimeout("_http._tcp.local",e,function(e,a){if(e)t&&t(e);else{for(var r=[],n=0;n<a.length;n++){var i=a[n];if(i.target&&i.ip&&i.ip.length>0&&0==i.target.indexOf("Lightify")){var s=i.target.substr(9);s=s.replace(".local","");var c=new o(i.ip[0]);c.uuid=s,r.push(c);}}t&&t(e,r);}});},o;}(),xnm.aio.osram.Lightify.DM=function(){var e=xnm.aio.osram.DMError,t=xnm.aio.osram.DMError.ERROR_CODE,a=function a(_a,o,r){if(_a){if(_a.gateway){if(_a.type){if(null!=_a.data&&void 0!==_a.data){if(o.data&&o.data.gateways&&0!==o.data.gateways.length){var n,i,s=o.data.gateways;for(n=0;n<s.length;n++)if(s[n].index===_a.gateway){i=s[n];break;}i?r():r(new e(t.NOT_FOUND,"gateway with index "+_a.gateway+" not exists"));}else r(new e(t.NOT_FOUND,"gateway with index "+_a.gateway+" not exists"));}else r(new e(t.INVALID,"data is invalid"));}else r(new e(t.INVALID,"type is invalid"));}else r(new e(t.INVALID,"gateway is invalid"));}else r(new e(t.INVALID,"info is invalid"));};return{SYS:"lightify",MAP:{onoff:{command:[{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}}],status:[{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}}]},dimmable:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"int",name:"brightness",ref:{value:"bri",ext:"%d",extMeta:"0-100"}}],status:[{type:"int",name:"brightness",ref:{value:"bri",extMeta:"0-100"}}]},colortemp:{command:[{type:"int",name:"color temperature",ref:{value:"ct",ext:"%d",extMeta:"2700-6500",scale:"38"}}],status:[{type:"int",name:"color temperature",ref:{value:"ct",extMeta:"2700-6500",scale:"38"}}]},colorlight:{command:[{type:"string",name:"rgbw color",ref:{value:"rgbwS",ext:"%s"}},{type:"rgbw",name:"rgbw color",ref:{value:"rgbw",ext:"%s"}},{type:"enum",name:"effect",ref:{value:"effect",ext:"%e",extMeta:["none","colorloop"]}}],status:[{type:"rgbw",name:"rgbw color",ref:{value:"rgbw"}}]},extendcolor:{},group:{command:[{type:"int",name:"do scene",ref:{value:"doScene",ext:"%d"}}]}},registModule:function registModule(e){e.register(this.SYS,"osram");},getGatewayType:function getGatewayType(){return{sys:this.SYS,name:"OSRAM LIGHTIFY / LEDvance Gateway",port:4e3};},getGatewayDeviceType:function getGatewayDeviceType(){var e={sys:this.SYS,type:"light",name:"Light",subtypes:[]};return e.subtypes.push({id:"OnOff Light",data:1}),e.subtypes.push({id:"Color Dimmer Light",data:2}),e.subtypes.push({id:"Dimmer Light",data:4}),e.subtypes.push({id:"Color Light",data:8}),e.subtypes.push({id:"Extended Color Light",data:10}),[e,{sys:this.SYS,type:"group",name:"Group"}];},createGateway:function createGateway(a,o,r){a?a.ip?r(null,a):r(new e(t.INVALID,"ip is invalid")):r(new e(t.INVALID,"info is invalid"));},updateGateway:function updateGateway(a,o,r,n){o?o.ip?n(null,o):n(new e(t.INVALID,"ip is invalid")):n(new e(t.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,a){a();},createDevice:function createDevice(e,t,o){a(e,t,function(t){o(t,e);});},updateDevice:function updateDevice(e,t,o){a(e,t,function(t){o(t,e);});},deleteDevice:function deleteDevice(e,t,a){a(null,e);},getCommandStatusMap:function getCommandStatusMap(e){var t=function t(e){return JSON.parse(JSON.stringify(e));};if(!e)return null;var a={command:[],status:[]},o=0;switch("light"!=e.type&&"plug"!=e.type||(o=10,null!=e.data&&void 0!==e.data&&(o=parseInt(e.data,16))),o){case 0:a.command=a.command.concat(t(this.MAP.group.command)),a.command=a.command.concat(t(this.MAP.colorlight.command)),a.command=a.command.concat(t(this.MAP.colortemp.command)),a.command.push(t(this.MAP.dimmable.command[2])),a.command.push(t(this.MAP.onoff.command[1])),a.command.push(t(this.MAP.onoff.command[2]));break;case 10:case 8:a.command=a.command.concat(t(this.MAP.colorlight.command)),a.status=a.status.concat(t(this.MAP.colorlight.status));case 2:var r=t(this.MAP.colortemp.command),n=t(this.MAP.colortemp.status);if(10==o){for(var i=0;i<r.length;i++)r[i]&&r[i].ref&&"ct"==r[i].ref.value&&(r[i].ref.extMeta="2000-6500",r[i].ref.scale="15");for(i=0;i<n.length;i++)n[i]&&n[i].ref&&"ct"==n[i].ref.value&&(r[i].ref.extMeta="2000-6500",r[i].ref.scale="15");a.command=a.command.concat(r),a.status=a.status.concat(n);}else a.command=a.command.concat(r),a.status=a.status.concat(n);case 4:a.command=a.command.concat(t(this.MAP.dimmable.command)),a.status=a.status.concat(t(this.MAP.dimmable.status));case 1:case 16:a.command=a.command.concat(t(this.MAP.onoff.command)),a.status=a.status.concat(t(this.MAP.onoff.status));}return 0==o&&delete a.status,a;}};}(),xnm.aio.osram.DM=function(){var e=xnm.aio.osram.DMError,t=xnm.aio.osram.DMError.ERROR_CODE;return{getGatewayType:function getGatewayType(){var e=[];for(var t in xnm.aio.osram)if(xnm.aio.osram.hasOwnProperty(t)){var a=xnm.aio.osram[t];if(a&&a.DM&&a.DM.getGatewayType){var o=a.DM.getGatewayType();o&&e.push(o);}}return e;},getGatewayDeviceType:function getGatewayDeviceType(e){var t=[];for(var a in xnm.aio.osram)if(xnm.aio.osram.hasOwnProperty(a)){var o=xnm.aio.osram[a];if(o&&o.DM&&o.DM.getGatewayDeviceType){var r=o.DM.getGatewayDeviceType(e);r&&(Array.isArray(r)?t=t.concat(r):t.push(r));}}return t;},getIPDeviceType:function getIPDeviceType(e,t){var a=[];for(var o in xnm.aio.osram)if(xnm.aio.osram.hasOwnProperty(o)){var r=xnm.aio.osram[o];if(r&&r.DM&&r.DM.getIPDeviceType){var n=r.DM.getIPDeviceType(e,t);n&&a.push(n);}}return a;},_getSystem:function _getSystem(e){for(var t in xnm.aio.osram)if(xnm.aio.osram.hasOwnProperty(t)){var a=xnm.aio.osram[t];if(a&&a.DM&&a.DM.SYS&&a.DM.SYS==e)return a;}return null;},_checkSystemMethod:function _checkSystemMethod(a,o,r){if(a){if(a.sys){var n=this._getSystem(a.sys);n&&n.DM&&n.DM[o]?r&&r(null,n):r&&r(new e(t.INVALID,"no such sys:"+a.sys));}else r&&r(new e(t.INVALID,"sys is invalid"));}else r&&r(new e(t.INVALID,"info is invalid"));},createGateway:function createGateway(e,t,a){this._checkSystemMethod(e,"createGateway",function(o,r){o?a&&a(o):r.DM.createGateway(e,t,a);});},updateGateway:function updateGateway(e,t,a,o){this._checkSystemMethod(t,"updateGateway",function(r,n){r?o&&o(r):n.DM.updateGateway(e,t,a,o);});},deleteGateway:function deleteGateway(e,t,a){this._checkSystemMethod(e,"deleteGateway",function(o,r){o?a&&a(o):r.DM.deleteGateway(e,t,a);});},createDevice:function createDevice(e,t,a){this._checkSystemMethod(e,"createDevice",function(o,r){o?a&&a(o):r.DM.createDevice(e,t,a);});},updateDevice:function updateDevice(e,t,a){this._checkSystemMethod(e,"updateDevice",function(o,r){o?a&&a(o):r.DM.updateDevice(e,t,a);});},deleteDevice:function deleteDevice(e,t,a){this._checkSystemMethod(e,"deleteDevice",function(o,r){o?a&&a(o):r.DM.deleteDevice(e,t,a);});},applyUIFilter:function applyUIFilter(e,t){var a=function a(e,t){if("*"==e)return!0;for(var a=!1,o=0;o<e.length;o++)if(e[o]==t){a=!0;break;}return a;},o=function o(e,t){var o,r=[],n=null;if(e.sys){var i=this._getSystem(e.sys);i&&i.DM&&i.DM.getCommandStatusMap&&(o=i.DM.getCommandStatusMap(e));}return o&&(n=function(e,t,o){var r=[];switch(o.catagory){case"command":e.command&&e.command.forEach(function(e){if(a(o.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(a(o.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}});}return r;}(o,0,t),r=r.concat(n)),r;};if(!e.sys)return null;var r=JSON.parse(JSON.stringify(e)),n=null;switch(t.catagory){case"command":n=o.call(this,e,t),r.command=n;break;case"status":n=o.call(this,e,t),r.status=n;break;default:return null;}return n&&0!=n.length?r:null;}};}(),xnm.aio.osram.Handler=function(){var e=function e(){};return e.prototype.devicemanager=xnm.aio.osram.DM,e.prototype.Lightify=xnm.aio.osram.Lightify,e.prototype.registModule=function(e){for(var t in xnm.aio.osram)if(xnm.aio.osram.hasOwnProperty(t)){var a=xnm.aio.osram[t];a&&a.DM&&a.DM.registModule&&a.DM.registModule(e);}},e.prototype.getStateValues=function(e,t){return new xnm.aio.osram.Lightify().getStateValues(e,t);},e.prototype.resolveGateway=function(e){return e.sys===xnm.aio.osram.Lightify.DM.SYS?xnm.aio.osram.Lightify.parseJSON(e):null;},e.prototype.getDeviceCommands=function(e,t){var a=xnm.aio.osram.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),o=a?a.command:[];t&&t(null,o);},e.prototype.getDeviceCommandList=function(e,t){var a=[];if("color-light"!=e.data&&"ext-color-light"!=e.data&&"group"!=e.data||t||a.push({id:window.XC_Text.colorvalue,cmd:"colorvalue"}),a.push({id:window.XC_Text.on,cmd:"on"}),a.push({id:window.XC_Text.off,cmd:"off"}),("dimmer"==e.data||"color-temp-dimmer"==e.data||"color-light"==e.data||"ext-color-light"==e.data||"group"==e.data)&&!t)for(var o=0;o<=100;o+=5)a.push({id:window.XC_Text.dimTo+o+"%",cmd:""+o});if(("color-temp-dimmer"==e.data||"color-light"==e.data||"ext-color-light"==e.data||"group"==e.data)&&!t)for(var r=2700;r<=6500;r+=380)a.push({id:window.XC_Text.colortemp+r,cmd:""+r});return a;},e.prototype.getDeviceStatus=function(e,t){var a=xnm.aio.osram.DM.applyUIFilter(e,{catagory:"status",elems:"*"}),o=a?a.status:[];t&&t(null,o);},e.prototype.doCommand=function(e,t,a,o){var r=this.resolveGateway(e);r?r.executeCommandCreator(t,a,function(e){o&&o(e);}):o&&o(new Error("gateway json format invalid"));},e.prototype.doStatus=function(e,t,a,o,r){var n=this.resolveGateway(t);if(n){var i=[{id:e,device:a,status:o}];n.getStatesCreator(null,i,function(e,t){e?r&&r(e):r&&r(null,t[0]);});}else r&&r(new Error("gateway json format invalid"));},e.prototype.searchLightifyWithTimeout=function(e,t){xnm.aio.osram.Lightify.discoveryWithTimeout(e,t);},e.prototype.getDeviceList=function(e,t){var a=this.resolveGateway(e);a?a instanceof xnm.aio.osram.Lightify?a.listNodes(function(e,o){e?t&&t(e):a.listZones(function(e,a){e?t&&t(e):t&&t(null,{lights:o,groups:a});});}):t&&t(new Error("gateway do not support get device list")):t&&t(new Error("gateway json format invalid"));},e;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.osram.Handler());