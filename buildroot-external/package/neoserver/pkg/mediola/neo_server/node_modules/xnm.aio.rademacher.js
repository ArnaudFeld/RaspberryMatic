var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.rademacher=xnm.aio.rademacher||{};xnm.aio.rademacher.HomePilot=function(a,b,c,d,f){this._logger=require("x.logger.js").getLogger("xnm.aio.rademacher.HomePilot");this.ip=a;this.port=80;b&&(this.port=b);this._user=c;this._password=d;this._uid=f;this._inRemoteMode=!1;this.CommandHandler=null};xnm.aio.rademacher.HomePilot.prototype.enableRemoteMode=function(a){this._inRemoteMode=a};
xnm.aio.rademacher.HomePilot.prototype._doRequest=function(a,b){var c=this.ip,d=this.port,f="/rest2/Index?do="+a,e=require("http");this._inRemoteMode&&(e=require("https"),c="www.homepilot.de",d=443,f="/uid/"+this._uid+"/rest2/Index?do="+a);"undefined"!=typeof process&&process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");c={host:c,port:d,path:f,method:"GET",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Connection:"close",rejectUnauthorized:!1,requestCert:!0}};
this._inRemoteMode&&this._user&&this._password&&(c.headers.Authorization="Basic "+(new Buffer(this._user+":"+this._password)).toString("base64"));var g=this;this._logger.log("trace","send http req:"+JSON.stringify(c));var k=e.request(c,function(a){g._logger.log("trace","receive http rsp status code:"+a.statusCode);if(200==a.statusCode){a.setEncoding("utf-8");var c="";a.on("data",function(a){c+=a});a.on("end",function(){g._logger.log("trace","receive http rsp:"+c);var a=JSON.parse(c);b&&b(a)})}else 403==
a.statusCode?XC.debugf("UNAUTHORIZED"):XC.debugf("Failed to post request"),b&&b(null)});k.setTimeout(6E3,function(){g._logger.log("trace","send http req timeout");k.abort()});k.on("error",function(a){g._logger.log("trace","send http req err:"+a.message);b&&b(null)});k.end()};
xnm.aio.rademacher.HomePilot.prototype.getDevices=function(a){var b={};this._doRequest("/devices",function(c){if(c&&"ok"==c.status)for(var d=0;d<c.devices.length;d++){var f=c.devices[d],e={};e.name=f.name;e.type=f.deviceGroup;e.info=f.description;e.state=f.statusesMap;b[f.did]=e}else b=null;a(b)})};
xnm.aio.rademacher.HomePilot.prototype.getMeters=function(a){var b={},c=[],d=this;this._doRequest("/meters",function(f){if(f&&"ok"==f.status&&f.meters){for(var e=0;e<f.meters.length;e++){var g=f.meters[e];g&&g.did&&c.push(g.did)}0==c.length&&a&&a(null);var k=0;for(f=0;f<c.length;f++)d.getMeter(c[f],function(f){k+=1;if(f&&f.meter&&f.data){var e=d._resolveMeterType(f.data);f.meter.did&&e&&(b[f.meter.did]={name:f.meter.name,address:f.meter.did,type:e,data:f.data})}k==c.length&&a&&a(b)})}else a&&a(null)})};
xnm.aio.rademacher.HomePilot.prototype.getMeter=function(a,b){a?this._doRequest("/meters/"+a,function(a){a&&"ok"==a.status&&a.meter&&a.data?b&&b(a):b&&b(null)}):b&&b(null)};xnm.aio.rademacher.HomePilot.prototype._resolveMeterType=function(a){for(var b={},c=0;c<a.length;c++)for(var d=a[c],f=Object.keys(d),e=0;e<f.length;e++)b[f[e]]=d[f[e]];return b["Schlie\u00dfer"]?"contact":"sensor"};
xnm.aio.rademacher.HomePilot.prototype.getStates=function(a,b,c){if(b&&0!=b.length){var d=this;this.CommandHandler=a;this.getDevices(function(a){if(a&&d.CommandHandler)if(b&&d.CommandHandler.setState)for(var e=0;e<b.length;e++){var g=b[e],k;if(a[g.address]&&(k=a[g.address].state)){var h=d.getStateValues(a[g.address].type,k),l;for(l in h)"state"==l?d.CommandHandler.setState(g.id,h[l]):d.CommandHandler.setState(g.id+":"+l,h[l])}}else if(d.CommandHandler.receivedState)for(e in a)d.CommandHandler.receivedState("hp",
e,a[e].state);c&&c(null)})}else c&&c(null)};
xnm.aio.rademacher.HomePilot.prototype.executeCommand=function(a,b,c){var d=this;"on"==b?this._doRequest("/devices/"+a.address+"?do=use&cmd=10",c):"off"==b?this._doRequest("/devices/"+a.address+"?do=use&cmd=11",c):"up"==b?this._doRequest("/devices/"+a.address+"?do=use&cmd=1",c):"down"==b?this._doRequest("/devices/"+a.address+"?do=use&cmd=2",c):"stop"==b?this._doRequest("/devices/"+a.address+"?do=use&cmd=3",c):"dimUp"==b?this._doRequest("/devices/"+a.address+"?do=use&cmd=23",c):"dimDown"==b?this._doRequest("/devices/"+
a.address+"?do=use&cmd=24",c):"toggle"==b?this._doRequest("/devices/"+a.address,function(b){b&&"ok"==b.status&&b.device?0<b.device.statusesMap.Position?d._doRequest("/devices/"+a.address+"?do=use&cmd=11",c):d._doRequest("/devices/"+a.address+"?do=use&cmd=10",c):c&&c()}):("string"==typeof b&&0==b.indexOf("dimTo")&&(b=b.replace(/dimTo/g,"")),"string"==typeof b&&0==b.indexOf("moveTo")&&(b=b.replace(/moveTo/g,"")),"string"==typeof b&&(b=b.replace(/%/g,"")),this._doRequest("/devices/"+a.address+"?do=use&cmd=9&pos="+
b,c))};xnm.aio.rademacher.HomePilot.prototype.getStateValues=function(a,b){var c={};1==a?100==b.Position?c.state="on":0==b.Position&&(c.state="off"):c.state=b.Position;c.manu=b.Manuellbetrieb;return c};xnm.aio.rademacher.Kodi=function(a,b,c,d){this.ip=a;this.port=80;b&&(this.port=b);this._user=c;this._password=d;this._inRemoteMode=!1;this.CommandHandler=null};
xnm.aio.rademacher.Kodi.prototype._doRequest=function(a,b,c){var d={jsonrpc:"2.0",method:a,params:b,id:1};a="/jsonrpc?request="+encodeURI(JSON.stringify(d));a={host:this.ip,port:this.port,path:a,method:"GET",headers:{Connection:"close"}};this._inRemoteMode&&this._user&&this._password&&(a.headers.Authorization="Basic "+(new Buffer(this._user+":"+this._password)).toString("base64"));d=require("http").request(a,function(a){if(200==a.statusCode){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=
a});a.on("end",function(){var a=JSON.parse(b);c&&c(a)})}else 403==a.statusCode?XC.debugf("UNAUTHORIZED"):XC.debugf("Failed to post request"),c&&c(null)});d.setTimeout(6E3,function(){d.abort()});d.on("error",function(a){c&&c(null)});d.end()};
xnm.aio.rademacher.Kodi.prototype.executeCommand=function(a,b,c){a=null;var d={};"play"==b?(a="Player.PlayPause",d={playerid:0}):"stop"==b?(a="Player.Stop",d={playerid:0}):"previous"==b?(a="Player.GoTo",d={playerid:0,to:"previous"}):"next"==b?(a="Player.GoTo",d={playerid:0,to:"next"}):"left"==b?a="Input.Left":"right"==b?a="Input.Right":"up"==b?a="Input.Up":"down"==b?a="Input.Down":"home"==b?a="Input.Home":"enter"==b?a="Input.Select":"info"==b?a="Input.Info":"back"==b?a="Input.Back":"menu"==b?a="Input.ContextMenu":
"osd"==b?a="Input.ShowOSD":"mute"==b?(a="Application.SetMute",d={mute:"toggle"}):"volumeUp"==b?(a="Application.SetVolume",d={volume:"increment"}):"volumeDown"==b?(a="Application.SetVolume",d={volume:"decrement"}):"shutdown"==b?a="System.Shutdown":"reboot"==b?a="System.Reboot":"suspend"==b?a="System.Suspend":"hibernate"==b&&(a="System.Hibernate");a?this._doRequest(a,d,c):c&&c()};xnm.aio.rademacher.Handler=function(){};xnm.aio.rademacher.Handler.prototype.HomePilot=xnm.aio.rademacher.HomePilot;
xnm.aio.rademacher.Handler.prototype.Kodi=xnm.aio.rademacher.Kodi;xnm.aio.rademacher.Handler.prototype.getStateValues=function(a,b){return(new xnm.aio.rademacher.HomePilot).getStateValues(a.type,b)};
xnm.aio.rademacher.HomePilot.prototype.executeCommandCreator=function(a,b,c){if(a&&"kodi"==a.type)b&&b.value?(new xnm.aio.rademacher.Kodi(this.ip,a.port,a.username,a.password)).executeCommand(null,b.value,function(){c&&c()}):c&&c(Error("command invalid"));else if(a&&a.address)if(b){var d=b.value;switch(d){case "dimTo":case "moveTo":if(null==b.ext||"undefined"==typeof b.ext){c&&c(Error("command invalid"));return}if("number"==typeof b.ext)d=parseInt(b.ext);else if(b.ext.match(/^[-+]?[0-9]+$/))d=parseInt(b.ext);
else{c&&c(Error("command invalid"));return}break;case "tempTo":if(null==b.ext||"undefined"==typeof b.ext){c&&c(Error("command invalid"));return}d=parseFloat(b.ext);if(isNaN(d)){c&&c(Error("command invalid"));return}d=Math.round(10*d)}this.executeCommand(a,d,function(){c&&c()})}else c&&c(Error("command invalid"));else c&&c(Error("device invalid"))};
xnm.aio.rademacher.HomePilot.prototype.getStatesCreator=function(a,b,c){if(b){a=[];for(var d=[],f=0;f<b.length;f++){var e=b[f];e.device&&e.device.address&&("contact"==e.device.type||"env"==e.device.type||"smoke"==e.device.type||"sun"==e.device.type?d.push(e):a.push({id:e.id,address:e.device.address}))}var g=0,k=[];this._getMeterStates(d,function(a){g++;a&&(k=k.concat(a));2==g&&c&&(c(null,k),c=null)});this.getStates({setState:function(a,c){var d=a.lastIndexOf(":"),f="state";-1!=d&&d!=a.length-1&&(d=
a.substr(d+1))&&(f=d);for(var e,d=0;d<b.length;d++)if(b[d].id==a&&b[d].status&&b[d].device)switch(b[d].device.type){case "thermo":"state"==f&&(e=parseInt(c),isNaN(e)||(e={id:b[d].id,status:(e/10).toFixed(1)},k.push(e)));break;default:"state"==f&&(e={id:b[d].id,status:c},k.push(e))}}},a,function(){g++;2==g&&c&&(c(null,k),c=null)})}else c&&c(Error("deviceList is null"))};
xnm.aio.rademacher.HomePilot.prototype._getMeterStates=function(a,b){if(a&&0!=a.length){var c=0,d=this,f=[],e;for(e=0;e<a.length;e++)a[e].device&&a[e].device.address&&-1==f.indexOf(a[e].device.address)&&f.push(a[e].device.address);var g={};for(e=0;e<f.length;e++)f[e]&&this.getMeter(f[e],function(e){e&&e.meter&&e.meter.did&&e.data&&(g[e.meter.did]=e.data);c++;if(c==f.length){e=[];for(var h=0;h<a.length;h++)if(a[h].id){var l="?";if(a[h].device&&a[h].device.address&&a[h].device.type&&a[h].status&&a[h].status.value&&
g[a[h].device.address]){var m=d._resolveMeterDatapointState(a[h].device.type,a[h].status.value,g[a[h].device.address]);"undefined"!=typeof m&&null!=m&&(l=m)}e.push({id:a[h].id,status:l})}b&&b(e)}})}else b&&b(null)};xnm.aio.rademacher.HomePilot.prototype._resolveMeterDatapointState=function(a,b,c){return(a=this._resolveMeterStates(a,c))?a[b]:null};
xnm.aio.rademacher.HomePilot.prototype._resolveMeterStates=function(a,b){switch(a){case "contact":return this._resolveContactState(b);case "env":return this._resolveEnvState(b);case "smoke":return this._resolveSmokeState(b);case "sun":return this._resolveSunState(b)}return null};
xnm.aio.rademacher.HomePilot.prototype._resolveEnvState=function(a){var b=null,c=null;if(a)if(1==a.length)b={},a[0]&&(c=this._resolveKeyValue(a[0]))&&c.value&&(b.envUpdate=c.value);else if(7<=a.length){b={};a[0]&&(c=this._resolveKeyValue(a[0]))&&c.value&&(b.envLum=parseInt(c.value.replace("lx","").trim()));a[1]&&(c=this._resolveKeyValue(a[1]))&&c.value&&(b.envWindS=parseInt(c.value.replace("m/s","").trim()));a[2]&&(c=this._resolveKeyValue(a[2]))&&c.value&&(b.envTemp=parseFloat(c.value.replace("\u00b0C",
"").trim()));if(a[3]&&(c=this._resolveKeyValue(a[3]))&&c.value)switch(c.value){case "Not detected":case "Nicht erkannt":case "Non reconnu":case "Niet herkend":b.envRain="false";break;default:b.envRain="true"}a[4]&&(c=this._resolveKeyValue(a[4]))&&c.value&&(b.envSunH=parseInt(c.value.replace("\u00b0","").trim()));if(a[5]&&(c=this._resolveKeyValue(a[5]))&&c.value){var d=c.value.indexOf("("),f=c.value.indexOf(")");if(-1!=d&&f>d){var e=c.value.substr(0,d),c=c.value.substr(d+1,f-d-1);b.envSunD=parseInt(c.replace("\u00b0",
"").trim());b.envSunDS=e.trim()}}a[6]&&(c=this._resolveKeyValue(a[6]))&&c.value&&(b.envUpdate=c.value)}return b};
xnm.aio.rademacher.HomePilot.prototype._resolveContactState=function(a){var b=null,c=null;if(a&&3<=a.length){b={};if(a[0]&&(c=this._resolveKeyValue(a[0]))&&c.value)switch(c.value){case "Closed":case "Geschlossen":case "Ferm\u00e9":case "Gesloten":b.contactState="closed";break;default:b.contactState="open"}a[1]&&(c=this._resolveKeyValue(a[1]))&&c.value&&(b.contactBat=parseInt(c.value.replace("%","").trim()));a[2]&&(c=this._resolveKeyValue(a[2]))&&c.value&&(b.contactUpdate=c.value)}return b};
xnm.aio.rademacher.HomePilot.prototype._resolveSmokeState=function(a){var b=null,c=null;if(a&&3<=a.length){b={};if(a[0]&&(c=this._resolveKeyValue(a[0]))&&c.value)switch(c.value){case "Not detected":case "Nicht erkannt":case "Non d\u00e9tect\u00e9":case "Niet herkend":b.smokeState="ok";break;default:b.smokeState="alarm"}a[1]&&(c=this._resolveKeyValue(a[1]))&&c.value&&(b.smokeBat=parseInt(c.value.replace("%","").trim()));a[2]&&(c=this._resolveKeyValue(a[2]))&&c.value&&(b.smokeUpdate=c.value)}return b};
xnm.aio.rademacher.HomePilot.prototype._resolveSunState=function(a){var b=null,c=null;if(a&&2<=a.length){b={};if(a[0]&&(c=this._resolveKeyValue(a[0]))&&c.value)switch(c.value){case "Not detected":case "Nicht erkannt":case "Non reconnu":case "Niet herkend":b.sunState="no";break;default:b.sunState="yes"}a[1]&&(c=this._resolveKeyValue(a[1]))&&c.value&&(b.sunUpdate=c.value)}return b};
xnm.aio.rademacher.HomePilot.prototype._resolveKeyValue=function(a){for(var b in a)if(a.hasOwnProperty(b))return{key:b,value:a[b]};return null};
xnm.aio.rademacher.HomePilot.prototype.getSensorTypeFromData=function(a){var b=null;if(a&&a[0]&&(a=this._resolveKeyValue(a[0]))&&a.key&&a.value){switch(a.key){case "Closer":case "Schlie\u00dfer":case "Contact normalement ouvert":case "Sluitcontact":b="contact";break;case "Smoke":case "Rauch":case "Fum\u00e9e":case "roken":b="smoke";break;case "Sun":case "Sonne":case "Soleil":case "Zon":b="sun"}-1!=a.value.indexOf("lx")&&(b="env")}return b};
xnm.aio.rademacher.HomePilot.prototype.toJSON=function(){return{sys:"homepilot1",ip:this.ip,port:this.port,username:this._user,password:this._password,uid:this._uid}};xnm.aio.rademacher.HomePilot.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.rademacher.HomePilot?this.ip==a.ip&&this.port==a.port&&this._uid==a._uid:!1};xnm.aio.rademacher.HomePilot2=function(a,b,c,d,f){xnm.aio.rademacher.HomePilot.call(this,a,b,c,d,f)};xnm.aio.rademacher.HomePilot2.prototype=xnm.aio.rademacher.HomePilot.prototype;
xnm.aio.rademacher.HomePilot2.constructor=xnm.aio.rademacher.HomePilot2;xnm.aio.rademacher.HomePilot2.prototype.toJSON=function(){return{sys:"homepilot2",ip:this.ip,port:this.port,username:this._user,password:this._password,uid:this._uid}};xnm.aio.rademacher.HomePilot2.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.rademacher.HomePilot2?this.ip==a.ip&&this.port==a.port&&this._uid==a._uid:!1};xnm.aio.rademacher.Handler.prototype.devicemanager=null;
xnm.aio.rademacher.Handler.prototype.registModule=function(a){a.register("homepilot1","rademacher");a.register("homepilot2","rademacher")};xnm.aio.rademacher.Handler.prototype.resolveGateway=function(a){if(!a||!a.ip||!a.sys)return null;switch(a.sys){case "homepilot1":return new xnm.aio.rademacher.HomePilot(a.ip,a.port,a.username,a.password,a.uid);case "homepilot2":return new xnm.aio.rademacher.HomePilot2(a.ip,a.port,a.username,a.password,a.uid);default:return null}};
xnm.aio.rademacher.Handler.prototype.getDeviceCommands=function(a,b){var c=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}),c=c?c.command:[];b&&b(null,c)};xnm.aio.rademacher.Handler.prototype.getDeviceStatus=function(a,b){var c=this.devicemanager.applyUIFilter(a,{catagory:"status",elems:"*"}),c=c?c.status:[];b&&b(null,c)};xnm.aio.rademacher.Handler.prototype.doCommand=function(a,b,c,d){(a=this.resolveGateway(a))?a.executeCommandCreator(b,c,function(a){d&&d(a)}):d&&d(Error("gateway json format invalid"))};
xnm.aio.rademacher.Handler.prototype.doStatus=function(a,b,c,d,f){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:c,status:d}],function(a,b){a?f&&f(a):f&&f(null,b[0])}):f&&f(Error("gateway json format invalid"))};
xnm.aio.rademacher.Handler.prototype.discover=function(a,b,c){var d=require("x.mdns.js");d.clearRecordBuffer();d.discoverServiceWithTimeout("_workstation._tcp.local",b,function(b,d){if(b)c&&c(b);else{for(var g=[],k=0;k<d.length;k++){var h=d[k];h.target&&h.ip&&0<h.ip.length&&-1!=h.target.toLowerCase().indexOf("homepilot")&&(h="homepilot1"==a?new xnm.aio.rademacher.HomePilot(h.ip[0]):new xnm.aio.rademacher.HomePilot2(h.ip[0]),g.push(h))}c&&c(b,g)}})};
xnm.aio.rademacher.Handler.prototype.getDeviceList=function(a,b){var c=this.resolveGateway(a);if(c){var d=this,f=!1,e=!1,g=[];c.getDevices(function(a){f=!0;var h;if(a)for(var l in a)a.hasOwnProperty(l)&&(h=d._device2json(c,a[l],l))&&g.push(h);c instanceof xnm.aio.rademacher.HomePilot2&&g.push({sys:"homepilot2",type:"kodi",port:8080});f&&e&&b&&b(null,g)});c.getMeters(function(a){e=!0;var d="homepilot1";c instanceof xnm.aio.rademacher.HomePilot2&&(d="homepilot2");var l;if(a)for(var m in a)if(a.hasOwnProperty(m)&&
(l=a[m])){if(l.data){var n=c.getSensorTypeFromData(l.data);l.type=n?n:"";l.sys=d}g.push(l)}f&&e&&b&&b(null,g)})}else b&&b(Error("gateway json format invalid"))};
xnm.aio.rademacher.Handler.prototype._device2json=function(a,b,c){var d=b.type,f="homepilot1";a instanceof xnm.aio.rademacher.HomePilot2&&(f="homepilot2");switch(d){case 1:d="switch";break;case 3:d="sensor";break;case 2:d="blind";break;case 5:d="thermo";break;case 4:d="dimmer";break;case 8:d="gate";break;default:return null}b.sys=f;b.address=c;b.type=d;return b};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.rademacher.Handler);
