var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var a=0;return function(b){return $jscomp.SYMBOL_PREFIX+(b||"")+a++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.rademacher=xnm.aio.rademacher||{};
xnm.aio.rademacher.HomePilot=function(a,b,c,d,e){this._logger=require("x.logger.js").getLogger("xnm.aio.rademacher.HomePilot");this.ip=a;this.port=80;b&&(this.port=b);this._user=c;this._password=d;this._uid=e;this._inRemoteMode=!1;this.CommandHandler=null};xnm.aio.rademacher.HomePilot.prototype.enableRemoteMode=function(a){this._inRemoteMode=a};
xnm.aio.rademacher.HomePilot.prototype._doRequest=function(a,b){var c=this.ip,d=this.port,e="/rest2/Index?do="+a,f=require("http");this._inRemoteMode&&(f=require("https"),c="www.homepilot.de",d=443,e="/uid/"+this._uid+"/rest2/Index?do="+a);"undefined"!=typeof process&&process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");a={host:c,port:d,path:e,method:"GET",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Connection:"close",rejectUnauthorized:!1,requestCert:!0}};
this._inRemoteMode&&this._user&&this._password&&(a.headers.Authorization="Basic "+(new Buffer(this._user+":"+this._password)).toString("base64"));var h=this;this._logger.log("trace","send http req:"+JSON.stringify(a));var g=f.request(a,function(a){h._logger.log("trace","receive http rsp status code:"+a.statusCode);if(200==a.statusCode){a.setEncoding("utf-8");var c="";a.on("data",function(a){c+=a});a.on("end",function(){h._logger.log("trace","receive http rsp:"+c);var a=JSON.parse(c);b&&b(a)})}else 403==
a.statusCode?XC.debugf("UNAUTHORIZED"):XC.debugf("Failed to post request"),b&&b(null)});g.setTimeout(6E3,function(){h._logger.log("trace","send http req timeout");g.abort()});g.on("error",function(a){h._logger.log("trace","send http req err:"+a.message);b&&b(null)});g.end()};
xnm.aio.rademacher.HomePilot.prototype.getDevices=function(a){var b={};this._doRequest("/devices",function(c){if(c&&"ok"==c.status)for(var d=0;d<c.devices.length;d++){var e=c.devices[d],f={};f.name=e.name;f.type=e.deviceGroup;f.info=e.description;f.state=e.statusesMap;b[e.did]=f}else b=null;a(b)})};
xnm.aio.rademacher.HomePilot.prototype.getMeters=function(a){var b={},c=[],d=this;this._doRequest("/meters",function(e){if(e&&"ok"==e.status&&e.meters){for(var f=0;f<e.meters.length;f++){var h=e.meters[f];h&&h.did&&c.push(h.did)}0==c.length&&a&&a(null);var g=0;for(e=0;e<c.length;e++)d.getMeter(c[e],function(e){g+=1;if(e&&e.meter&&e.data){var f=d._resolveMeterType(e.data);e.meter.did&&f&&(b[e.meter.did]={name:e.meter.name,address:e.meter.did,type:f,data:e.data})}g==c.length&&a&&a(b)})}else a&&a(null)})};
xnm.aio.rademacher.HomePilot.prototype.getMeter=function(a,b){a?this._doRequest("/meters/"+a,function(a){a&&"ok"==a.status&&a.meter&&a.data?b&&b(a):b&&b(null)}):b&&b(null)};xnm.aio.rademacher.HomePilot.prototype._resolveMeterType=function(a){for(var b={},c=0;c<a.length;c++)for(var d=a[c],e=Object.keys(d),f=0;f<e.length;f++)b[e[f]]=d[e[f]];return b["Schlie\u00dfer"]?"contact":"sensor"};
xnm.aio.rademacher.HomePilot.prototype.getStates=function(a,b,c){if(b&&0!=b.length){var d=this;this.CommandHandler=a;this.getDevices(function(a){if(a&&d.CommandHandler)if(b&&d.CommandHandler.setState)for(var e=0;e<b.length;e++){var h=b[e],g;if(a[h.address]&&(g=a[h.address].state)){var k=d.getStateValues(a[h.address].type,g),m;for(m in k)"state"==m?d.CommandHandler.setState(h.id,k[m]):d.CommandHandler.setState(h.id+":"+m,k[m])}}else if(d.CommandHandler.receivedState)for(e in a)d.CommandHandler.receivedState("hp",
e,a[e].state);c&&c(null)})}else c&&c(null)};
xnm.aio.rademacher.HomePilot.prototype.executeCommand=function(a,b,c){var d=this;"on"==b?this._doRequest("/devices/"+a.address+"?do=use&cmd=10",c):"off"==b?this._doRequest("/devices/"+a.address+"?do=use&cmd=11",c):"up"==b?this._doRequest("/devices/"+a.address+"?do=use&cmd=1",c):"down"==b?this._doRequest("/devices/"+a.address+"?do=use&cmd=2",c):"stop"==b?this._doRequest("/devices/"+a.address+"?do=use&cmd=3",c):"dimUp"==b?this._doRequest("/devices/"+a.address+"?do=use&cmd=23",c):"dimDown"==b?this._doRequest("/devices/"+
a.address+"?do=use&cmd=24",c):"toggle"==b?this._doRequest("/devices/"+a.address,function(b){b&&"ok"==b.status&&b.device?0<b.device.statusesMap.Position?d._doRequest("/devices/"+a.address+"?do=use&cmd=11",c):d._doRequest("/devices/"+a.address+"?do=use&cmd=10",c):c&&c()}):("string"==typeof b&&0==b.indexOf("dimTo")&&(b=b.replace(/dimTo/g,"")),"string"==typeof b&&0==b.indexOf("moveTo")&&(b=b.replace(/moveTo/g,"")),"string"==typeof b&&(b=b.replace(/%/g,"")),this._doRequest("/devices/"+a.address+"?do=use&cmd=9&pos="+
b,c))};xnm.aio.rademacher.HomePilot.prototype.getStateValues=function(a,b){var c={};1==a?100==b.Position?c.state="on":0==b.Position&&(c.state="off"):c.state=b.Position;c.manu=b.Manuellbetrieb;return c};xnm.aio.rademacher.Kodi=function(a,b,c,d){this.ip=a;this.port=80;b&&(this.port=b);this._user=c;this._password=d;this._inRemoteMode=!1;this.CommandHandler=null};
xnm.aio.rademacher.Kodi.prototype._doRequest=function(a,b,c){var d={jsonrpc:"2.0",method:a,params:b,id:1};a="/jsonrpc?request="+encodeURI(JSON.stringify(d));a={host:this.ip,port:this.port,path:a,method:"GET",headers:{Connection:"close"}};this._inRemoteMode&&this._user&&this._password&&(a.headers.Authorization="Basic "+(new Buffer(this._user+":"+this._password)).toString("base64"));d=require("http").request(a,function(a){if(200==a.statusCode){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=
a});a.on("end",function(){var a=JSON.parse(b);c&&c(a)})}else 403==a.statusCode?XC.debugf("UNAUTHORIZED"):XC.debugf("Failed to post request"),c&&c(null)});d.setTimeout(6E3,function(){d.abort()});d.on("error",function(a){c&&c(null)});d.end()};
xnm.aio.rademacher.Kodi.prototype.executeCommand=function(a,b,c){a=null;var d={};"play"==b?(a="Player.PlayPause",d={playerid:0}):"stop"==b?(a="Player.Stop",d={playerid:0}):"previous"==b?(a="Player.GoTo",d={playerid:0,to:"previous"}):"next"==b?(a="Player.GoTo",d={playerid:0,to:"next"}):"left"==b?a="Input.Left":"right"==b?a="Input.Right":"up"==b?a="Input.Up":"down"==b?a="Input.Down":"home"==b?a="Input.Home":"enter"==b?a="Input.Select":"info"==b?a="Input.Info":"back"==b?a="Input.Back":"menu"==b?a="Input.ContextMenu":
"osd"==b?a="Input.ShowOSD":"mute"==b?(a="Application.SetMute",d={mute:"toggle"}):"volumeUp"==b?(a="Application.SetVolume",d={volume:"increment"}):"volumeDown"==b?(a="Application.SetVolume",d={volume:"decrement"}):"shutdown"==b?a="System.Shutdown":"reboot"==b?a="System.Reboot":"suspend"==b?a="System.Suspend":"hibernate"==b&&(a="System.Hibernate");a?this._doRequest(a,d,c):c&&c()};xnm.aio.rademacher.Handler=function(){};xnm.aio.rademacher.Handler.prototype.HomePilot=xnm.aio.rademacher.HomePilot;
xnm.aio.rademacher.Handler.prototype.Kodi=xnm.aio.rademacher.Kodi;xnm.aio.rademacher.Handler.prototype.getStateValues=function(a,b){return(new xnm.aio.rademacher.HomePilot).getStateValues(a.type,b)};
xnm.aio.rademacher.HomePilot.prototype.executeCommandCreator=function(a,b,c){if(a&&"kodi"==a.type)b&&b.value?(new xnm.aio.rademacher.Kodi(this.ip,a.port,a.username,a.password)).executeCommand(null,b.value,function(){c&&c()}):c&&c(Error("command invalid"));else if(a&&a.address)if(b){var d=b.value;switch(d){case "dimTo":case "moveTo":if(null==b.ext||"undefined"==typeof b.ext){c&&c(Error("command invalid"));return}if("number"==typeof b.ext)d=parseInt(b.ext);else if(b.ext.match(/^[-+]?[0-9]+$/))d=parseInt(b.ext);
else{c&&c(Error("command invalid"));return}break;case "tempTo":if(null==b.ext||"undefined"==typeof b.ext){c&&c(Error("command invalid"));return}d=parseFloat(b.ext);if(isNaN(d)){c&&c(Error("command invalid"));return}d=Math.round(10*d)}this.executeCommand(a,d,function(){c&&c()})}else c&&c(Error("command invalid"));else c&&c(Error("device invalid"))};
xnm.aio.rademacher.HomePilot.prototype.getStatesCreator=function(a,b,c){if(b){a=[];for(var d=[],e=0;e<b.length;e++){var f=b[e];f.device&&f.device.address&&("contact"==f.device.type||"env"==f.device.type||"smoke"==f.device.type||"sun"==f.device.type?d.push(f):a.push({id:f.id,address:f.device.address}))}var h=0,g=[];this._getMeterStates(d,function(a){h++;a&&(g=g.concat(a));2==h&&c&&(c(null,g),c=null)});this.getStates({setState:function(a,c){var d=a.lastIndexOf(":"),e="state";-1!=d&&d!=a.length-1&&(d=
a.substr(d+1))&&(e=d);for(d=0;d<b.length;d++)if(b[d].id==a&&b[d].status&&b[d].device)switch(b[d].device.type){case "thermo":if("state"==e){var f=parseInt(c);isNaN(f)||(f={id:b[d].id,status:(f/10).toFixed(1)},g.push(f))}break;default:"state"==e&&(f={id:b[d].id,status:c},g.push(f))}}},a,function(){h++;2==h&&c&&(c(null,g),c=null)})}else c&&c(Error("deviceList is null"))};
xnm.aio.rademacher.HomePilot.prototype._getMeterStates=function(a,b){if(a&&0!=a.length){var c=0,d=this,e=[],f;for(f=0;f<a.length;f++)a[f].device&&a[f].device.address&&-1==e.indexOf(a[f].device.address)&&e.push(a[f].device.address);var h={};for(f=0;f<e.length;f++)e[f]&&this.getMeter(e[f],function(f){f&&f.meter&&f.meter.did&&f.data&&(h[f.meter.did]=f.data);c++;if(c==e.length){f=[];for(var k=0;k<a.length;k++)if(a[k].id){var g="?";if(a[k].device&&a[k].device.address&&a[k].device.type&&a[k].status&&a[k].status.value&&
h[a[k].device.address]){var l=d._resolveMeterDatapointState(a[k].device.type,a[k].status.value,h[a[k].device.address]);"undefined"!=typeof l&&null!=l&&(g=l)}f.push({id:a[k].id,status:g})}b&&b(f)}})}else b&&b(null)};xnm.aio.rademacher.HomePilot.prototype._resolveMeterDatapointState=function(a,b,c){return(a=this._resolveMeterStates(a,c))?a[b]:null};
xnm.aio.rademacher.HomePilot.prototype._resolveMeterStates=function(a,b){switch(a){case "contact":return this._resolveContactState(b);case "env":return this._resolveEnvState(b);case "smoke":return this._resolveSmokeState(b);case "sun":return this._resolveSunState(b)}return null};
xnm.aio.rademacher.HomePilot.prototype._resolveEnvState=function(a){var b=null,c;if(a)if(1==a.length)b={},a[0]&&(c=this._resolveKeyValue(a[0]))&&c.value&&(b.envUpdate=c.value);else if(7<=a.length){b={};a[0]&&(c=this._resolveKeyValue(a[0]))&&c.value&&(b.envLum=parseInt(c.value.replace("lx","").trim()));a[1]&&(c=this._resolveKeyValue(a[1]))&&c.value&&(b.envWindS=parseInt(c.value.replace("m/s","").trim()));a[2]&&(c=this._resolveKeyValue(a[2]))&&c.value&&(b.envTemp=parseFloat(c.value.replace("\u00b0C",
"").trim()));if(a[3]&&(c=this._resolveKeyValue(a[3]))&&c.value)switch(c.value){case "Not detected":case "Nicht erkannt":case "Non reconnu":case "Niet herkend":b.envRain="false";break;default:b.envRain="true"}a[4]&&(c=this._resolveKeyValue(a[4]))&&c.value&&(b.envSunH=parseInt(c.value.replace("\u00b0","").trim()));if(a[5]&&(c=this._resolveKeyValue(a[5]))&&c.value){var d=c.value.indexOf("("),e=c.value.indexOf(")");if(-1!=d&&e>d){var f=c.value.substr(0,d);c=c.value.substr(d+1,e-d-1);b.envSunD=parseInt(c.replace("\u00b0",
"").trim());b.envSunDS=f.trim()}}a[6]&&(c=this._resolveKeyValue(a[6]))&&c.value&&(b.envUpdate=c.value)}return b};
xnm.aio.rademacher.HomePilot.prototype._resolveContactState=function(a){var b=null,c;if(a&&3<=a.length){b={};if(a[0]&&(c=this._resolveKeyValue(a[0]))&&c.value)switch(c.value){case "Closed":case "Geschlossen":case "Ferm\u00e9":case "Gesloten":b.contactState="closed";break;default:b.contactState="open"}a[1]&&(c=this._resolveKeyValue(a[1]))&&c.value&&(b.contactBat=parseInt(c.value.replace("%","").trim()));a[2]&&(c=this._resolveKeyValue(a[2]))&&c.value&&(b.contactUpdate=c.value)}return b};
xnm.aio.rademacher.HomePilot.prototype._resolveSmokeState=function(a){var b=null,c;if(a&&3<=a.length){b={};if(a[0]&&(c=this._resolveKeyValue(a[0]))&&c.value)switch(c.value){case "Not detected":case "Nicht erkannt":case "Non d\u00e9tect\u00e9":case "Niet herkend":b.smokeState="ok";break;default:b.smokeState="alarm"}a[1]&&(c=this._resolveKeyValue(a[1]))&&c.value&&(b.smokeBat=parseInt(c.value.replace("%","").trim()));a[2]&&(c=this._resolveKeyValue(a[2]))&&c.value&&(b.smokeUpdate=c.value)}return b};
xnm.aio.rademacher.HomePilot.prototype._resolveSunState=function(a){var b=null,c;if(a&&2<=a.length){b={};if(a[0]&&(c=this._resolveKeyValue(a[0]))&&c.value)switch(c.value){case "Not detected":case "Nicht erkannt":case "Non reconnu":case "Niet herkend":b.sunState="no";break;default:b.sunState="yes"}a[1]&&(c=this._resolveKeyValue(a[1]))&&c.value&&(b.sunUpdate=c.value)}return b};
xnm.aio.rademacher.HomePilot.prototype._resolveKeyValue=function(a){for(var b in a)if(a.hasOwnProperty(b))return{key:b,value:a[b]};return null};
xnm.aio.rademacher.HomePilot.prototype.getSensorTypeFromData=function(a){var b=null;if(a&&a[0]&&(a=this._resolveKeyValue(a[0]))&&a.key&&a.value){switch(a.key){case "Closer":case "Schlie\u00dfer":case "Contact normalement ouvert":case "Sluitcontact":b="contact";break;case "Smoke":case "Rauch":case "Fum\u00e9e":case "roken":b="smoke";break;case "Sun":case "Sonne":case "Soleil":case "Zon":b="sun"}-1!=a.value.indexOf("lx")&&(b="env")}return b};
xnm.aio.rademacher.HomePilot.prototype.toJSON=function(){return{sys:"homepilot1",ip:this.ip,port:this.port,username:this._user,password:this._password,uid:this._uid}};xnm.aio.rademacher.HomePilot.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.rademacher.HomePilot?this.ip==a.ip&&this.port==a.port&&this._uid==a._uid:!1};xnm.aio.rademacher.HomePilot2=function(a,b,c,d,e){xnm.aio.rademacher.HomePilot.call(this,a,b,c,d,e)};xnm.aio.rademacher.HomePilot2.prototype=xnm.aio.rademacher.HomePilot.prototype;
xnm.aio.rademacher.HomePilot2.constructor=xnm.aio.rademacher.HomePilot2;xnm.aio.rademacher.HomePilot2.prototype.toJSON=function(){return{sys:"homepilot2",ip:this.ip,port:this.port,username:this._user,password:this._password,uid:this._uid}};xnm.aio.rademacher.HomePilot2.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.rademacher.HomePilot2?this.ip==a.ip&&this.port==a.port&&this._uid==a._uid:!1};xnm.aio.rademacher.Handler.prototype.devicemanager=null;
xnm.aio.rademacher.Handler.prototype.registModule=function(a){a.register("homepilot1","rademacher");a.register("homepilot2","rademacher")};xnm.aio.rademacher.Handler.prototype.resolveGateway=function(a){if(!a||!a.ip||!a.sys)return null;switch(a.sys){case "homepilot1":return new xnm.aio.rademacher.HomePilot(a.ip,a.port,a.username,a.password,a.uid);case "homepilot2":return new xnm.aio.rademacher.HomePilot2(a.ip,a.port,a.username,a.password,a.uid);default:return null}};
xnm.aio.rademacher.Handler.prototype.getDeviceCommands=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};xnm.aio.rademacher.Handler.prototype.getDeviceStatus=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)};xnm.aio.rademacher.Handler.prototype.doCommand=function(a,b,c,d){(a=this.resolveGateway(a))?a.executeCommandCreator(b,c,function(a){d&&d(a)}):d&&d(Error("gateway json format invalid"))};
xnm.aio.rademacher.Handler.prototype.doStatus=function(a,b,c,d,e){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:c,status:d}],function(a,b){a?e&&e(a):e&&e(null,b[0])}):e&&e(Error("gateway json format invalid"))};
xnm.aio.rademacher.Handler.prototype.discover=function(a,b,c){var d=require("x.mdns.js");d.clearRecordBuffer();d.discoverServiceWithTimeout("_workstation._tcp.local",b,function(b,d){if(b)c&&c(b);else{for(var e=[],f=0;f<d.length;f++){var k=d[f];k.target&&k.ip&&0<k.ip.length&&-1!=k.target.toLowerCase().indexOf("homepilot")&&(k="homepilot1"==a?new xnm.aio.rademacher.HomePilot(k.ip[0]):new xnm.aio.rademacher.HomePilot2(k.ip[0]),e.push(k))}c&&c(b,e)}})};
xnm.aio.rademacher.Handler.prototype.getDeviceList=function(a,b){var c=this.resolveGateway(a);if(c){var d=this,e=!1,f=!1,h=[];c.getDevices(function(a){e=!0;var k;if(a)for(var g in a)a.hasOwnProperty(g)&&(k=d._device2json(c,a[g],g))&&h.push(k);c instanceof xnm.aio.rademacher.HomePilot2&&h.push({sys:"homepilot2",type:"kodi",port:8080});e&&f&&b&&b(null,h)});c.getMeters(function(a){f=!0;var d="homepilot1";c instanceof xnm.aio.rademacher.HomePilot2&&(d="homepilot2");var g;if(a)for(var l in a)if(a.hasOwnProperty(l)&&
(g=a[l])){if(g.data){var n=c.getSensorTypeFromData(g.data);g.type=n?n:"";g.sys=d}h.push(g)}e&&f&&b&&b(null,h)})}else b&&b(Error("gateway json format invalid"))};
xnm.aio.rademacher.Handler.prototype._device2json=function(a,b,c){var d=b.type,e="homepilot1";a instanceof xnm.aio.rademacher.HomePilot2&&(e="homepilot2");switch(d){case 1:d="switch";break;case 3:d="sensor";break;case 2:d="blind";break;case 5:d="thermo";break;case 4:d="dimmer";break;case 8:d="gate";break;default:return null}b.sys=e;b.address=c;b.type=d;return b};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.rademacher.Handler);
