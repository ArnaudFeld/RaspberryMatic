var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.sony=xnm.aio.sony||{},xnm.aio.sony.IRCC=function(){var e=function e(_e,o,t,r,n){this._logger=require("x.logger.js").getLogger("xnm.aio.sony.IRCC"),this.ip=_e,this.port=o,this.path=t,this.username=r,this.password=n,this._presharedkey=null;};return e.SOAP_PREFIX='<?xml version="1.0"?><s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"><s:Body><u:X_SendIRCC xmlns:u="urn:schemas-sony-com:service:IRCC:1"><IRCCCode>',e.SOAP_SUFFIX="</IRCCCode></u:X_SendIRCC></s:Body></s:Envelope>",e.prototype._executeCommand=function(e,o){var t=this,r=this._buildSoapReq(e);this._doRequest(r,function(e){e&&e._code&&t._logger.log("warn","sony access forbidden"),o&&o(e);});},e.prototype._register=function(e){var o=this,t="http://"+this.ip+":50002/?action=register&name=aioRemote&registrationType=initial&deviceId=aioRemote%3A00-00-00-00-00-00";this._logger.log("trace","register:"+t),$.ajax({url:t,method:"GET",timeout:3e3,cache:!1,headers:{"Content-Type":"text/xml; charset=UTF-8","X-CERS-DEVICE-ID":"aioRemote:00-00-00-00-00-00"},username:this.username,password:this.password,success:function success(){o._logger.log("trace","http request success"),e&&e();},error:function error(t,r){o._logger.log("trace","http request error:"+r),e&&e(new Error(r||"http error"));}});},e.prototype._doRequest=function(e,o){var t=this,r="http://"+this.ip+":"+this.port+this.path,n=o;this._logger.log("trace","send data:"+e+" to:"+r);var s={SOAPAction:'"urn:schemas-sony-com:service:IRCC:1#X_SendIRCC"',"Content-Type":"text/xml; charset=UTF-8","Content-Length":e.length,"X-CERS-DEVICE-ID":"aioRemote:00-00-00-00-00-00"};this._presharedkey&&(s["X-Auth-PSK"]=this._presharedkey),$.ajax({url:r,type:"POST",timeout:3e3,data:e,cache:!1,headers:s,username:this.username,password:this.password,statusCode:{401:function _(){if(n){var e=new Error("http response 401");e._errSource="xnm.aio.sony.IRCC",e._code=401,e._device=t,n(e),n=null;}},403:function _(){if(n){var e=new Error("http response 403");e._errSource="xnm.aio.sony.IRCC",e._code=403,e._device=t,n(e),n=null;}}},success:function success(){t._logger.log("trace","http request success"),n&&(n(),n=null);},error:function error(e,o){var r;return t._logger.log("trace","http request error:"+o),e&&401==e.status?((r=new Error("http response 401"))._errSource="xnm.aio.sony.IRCC",r._code=401,r._device=t,n(r),void(n=null)):e&&403==e.status?((r=new Error("http response 403"))._errSource="xnm.aio.sony.IRCC",r._code=403,r._device=t,n(r),void(n=null)):void(n&&(n(new Error(o||"http error")),n=null));}});},e.prototype._buildSoapReq=function(o){return e.SOAP_PREFIX+o+e.SOAP_SUFFIX;},e;}(),xnm.aio.sony.BDP=function(){var e=function e(_e2,o,t,r,n){(!o||o<0)&&(o=50001),t||(t="/upnp/control/IRCC"),xnm.aio.sony.IRCC.call(this,_e2,o,t,r,n);};return(e.prototype=Object.create(xnm.aio.sony.IRCC.prototype)).constructor=e,e;}(),xnm.aio.sony.TV=function(){var e=function e(_e3,o,t,r,n){(!o||o<0)&&(o=80),t||(t="/IRCC"),xnm.aio.sony.IRCC.call(this,_e3,o,t,r,n);};return(e.prototype=Object.create(xnm.aio.sony.IRCC.prototype)).constructor=e,e;}(),xnm.aio.sony.Handler=function(){var e=function e(){};return e.prototype.IRCC=xnm.aio.sony.IRCC,e.prototype.BDP=xnm.aio.sony.BDP,e;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.sony.Handler());