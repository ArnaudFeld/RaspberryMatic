var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.mirubee=xnm.aio.mirubee||{};
xnm.aio.mirubee.Mirubee=function(){var e={},b=function(a,c,d){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.mirubee.Mirubee");this._protocol="https";this._ip="v5dev.mediola.com";this._port=443;this.username=a;this.password=c;this.id=d;this._statesBuffer=e;this._getDeviceStatesCBs={}};b.prototype._putStatesBuffer=function(a,c){this._statesBuffer[a]={data:c,timestamp:(new Date).getTime()}};b.prototype._getStatesBuffer=function(a){var c=
this._statesBuffer[a];if(!c)return null;var d=(new Date).getTime();return!c.timestamp||6E4<d-c.timestamp?(delete this._statesBuffer[a],null):c.data};b.prototype.connect=function(a,c,d){this._doJsonRequest("GET","/eapi/v1/mirubee/connect",{account:a,password:c},null,function(a,c){d&&d(a,c)})};b.prototype.disconenct=function(a){this.id?this._doJsonRequest("GET","/eapi/v1/mirubee/disconnect",{id:this.id},null,function(c,d){a&&a(c,d)}):a&&a(Error("account not connected"))};b.prototype.getInfo=function(a){this._doJsonRequest("GET",
"/eapi/v1/mirubee/info",null,null,function(c,d){a&&a(c,d)})};b.prototype.getDevices=function(a){this.id?this._doJsonRequest("GET","/eapi/v1/mirubee/devices/"+this.id,null,null,function(c,d){if(c)a&&a(c);else{var b=[];if(d)for(var f in d){var e=d[f];e.sys="mirubee";b.push(e)}a&&a(c,b)}}):a&&a(Error("account not connected"))};b.prototype.executeCommandCreator=function(a,c,d){d&&d()};b.prototype.getStatesCreator=function(a,c,d){if(this.id)if(c)if(0==c.length)d&&d(null,[]);else{a=[];for(var b=0;b<c.length;b++){var f=
c[b];f&&f.device&&f.device.id&&-1==a.indexOf(f.device.id)&&a.push(f.device.id)}this.getStates(a,function(a,b){if(a)d&&d(a);else{for(var g=[],f=0;f<c.length;f++){var e=c[f];if(e&&e.id){var n=null;e.device&&e.device.id&&e.status&&e.status.value&&(n=b[e.device.id])&&(n=n[e.status.value]);if("undefined"==typeof n||null==n)n="?";g.push({id:e.id,status:n})}}d&&d(null,g)}})}else d&&d(Error("deviceList is null"));else d&&d(Error("account not connected"))};b.prototype.getStates=function(a,c){if(a&&0!=a.length)for(var b=
{},e=a.length,f=0;f<a.length;f++)this.getDeviceStates(a[f],function(a,f,p){!a&&f&&(b[p]=f);e--;0==e&&c&&c(null,b)});else c&&c(null,{})};b.prototype.getDeviceStates=function(a,c){var b=this._getStatesBuffer(a);if(b)c&&c(null,b,a);else{b=this._getDeviceStatesCBs[a];b||(this._getDeviceStatesCBs[a]=[],b=this._getDeviceStatesCBs[a]);var e=b.length;b.push(c);if(!(0<e)){var f=this;this._getDeviceStates(a,function(b,c){var d=f._getDeviceStatesCBs[a];f._getDeviceStatesCBs[a]=[];!b&&c&&(c=f._resolveStates(c),
f._putStatesBuffer(a,c));for(var e=0;e<d.length;e++)d[e]&&d[e](b,c,a)})}}};b.prototype._resolveStates=function(a){a&&a.measured&&(a.measuredStr=(new Date(a.measured)).toLocaleString());return a};b.prototype._getDeviceStates=function(a,c){this.id?this._doJsonRequest("GET","/eapi/v1/mirubee/states/"+this.id+"/"+a,null,null,function(a,b){c&&c(a,b)}):c&&c(Error("account not connected"))};b.prototype._doJsonRequest=function(a,b,d,e,f){this._doRequest(a,b,d,e,function(a,b){a?f&&f(a):b?b.XC_ERR?(a=Error("error response:"+
b.XC_ERR.msg),a.code=b.XC_ERR.code,f&&f(a)):b.XC_SUC?f&&f(null,b.XC_SUC):f&&f(Error("unknown response")):f&&f(Error("invalid response"))})};b.prototype._doRequest=function(a,b,d,e,f){b||(b="/");var l={};d&&(l=JSON.parse(JSON.stringify(d)));d="";for(var h in l)l.hasOwnProperty(h)&&(d&&(d+="&"),d+=h+"="+encodeURIComponent(l[h]));d&&(b+="?"+d);a={host:this._ip,port:this._port,path:b,method:a,headers:{Connection:"close","Content-Type":"application/json;  charset=UTF-8"}};if(this.username||this.password)a.auth=
(this.username?this.username:"")+":"+(this.password?this.password:""),a.headers.Authorization="Basic "+(new Buffer((this.username?this.username:"")+":"+(this.password?this.password:""))).toString("base64");e&&(a.headers["Content-Length"]=e.length);h=require(this._protocol);"https"==this._protocol&&"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");this._logger.log("trace","do request:"+JSON.stringify(a));var p=this,k=f,m=h.request(a,function(a){a.setEncoding("utf-8");
var b="";a.on("data",function(a){b+=a});a.on("end",function(){p._logger.log("trace","receive code:"+a.statusCode+" headers:"+JSON.stringify(a.headers)+" response:"+b);var c,d;if(200==a.statusCode)try{d=b?JSON.parse(b):null}catch(e){c=e}else c=Error("http reponse:"+a.statusCode);k&&(k(c,d,a.statusCode),k=null)})});if(m.on)m.on("error",function(a){p._logger.log("trace","do request error:"+a.message);k&&(k(a),k=null)});m.setTimeout&&m.setTimeout(2E4,function(){p._logger.log("trace","do request timeout");
m.abort();k&&(k(Error("timeout")),k=null)});e&&(this._logger.log("trace","do request send body:"+e),m.write(e));m.end()};b.prototype.toJSON=function(){return{sys:"mirubee",username:this.username,password:this.password,id:this.id}};b.prototype.equalsTo=function(a){return a&&a instanceof b?this.id==a.id&&this.username==a.username&&this.password==a.password:!1};b.parseJSON=function(a){return a.username?new b(a.username,a.password,a.id):null};return b}();
xnm.aio.mirubee.DM=function(){var e=function(b,a){this.code=b;this.message=a;this.stack=Error().stack};e.prototype=Error();e.prototype.name="mirubeeDMError";e.prototype.code=0;e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"mirubee",MAP:{meter:{channel:{status:[{type:"float",name:"power",ref:{value:"power",unit:"W"}},{type:"float",name:"voltage",ref:{value:"voltage",unit:"V"}},{type:"float",name:"current",ref:{value:"current",unit:"A"}},{type:"int",
name:"last measured time",ref:{value:"measured"}},{type:"string",name:"last measured time (text)",ref:{value:"measuredStr"}},{type:"statistic",name:"energy statistic",ref:{value:"energy"}}]}}},getGatewayType:function(){return[{sys:this.SYS,name:"mirubee (alfanar)"}]},createGateway:function(b,a,c){a=e.ERROR_CODE;b?b.username?b.password?b.id?c(null,b):c(new e(a.INVALID,"id is invalid")):c(new e(a.INVALID,"password is invalid")):c(new e(a.INVALID,"username is invalid")):c(new e(a.INVALID,"info is invalid"))},
updateGateway:function(b,a,c,d){b=e.ERROR_CODE;a?a.username?a.password?a.id?d(null,a):d(new e(b.INVALID,"id is invalid")):d(new e(b.INVALID,"password is invalid")):d(new e(b.INVALID,"username is invalid")):d(new e(b.INVALID,"update is invalid"))},deleteGateway:function(b,a,c){c()},createDevice:function(b,a,c){var d=e.ERROR_CODE;if(b)if(b.id)if(b.gateway){a=a.data.gateways;var g,f;for(g=0;g<a.length;g++)if(a[g].index===b.gateway){f=a[g];break}f?c&&c(null,b):c(new e(d.NOT_FOUND,"gateway with index "+
b.gateway+" not exists"))}else c(new e(d.INVALID,"gateway is invalid"));else c(new e(d.INVALID,"id is invalid"));else c(new e(d.INVALID,"info is invalid"))},updateDevice:function(b,a,c){var d=e.ERROR_CODE;if(b)if(b.id)if(b.gateway){a=a.data.gateways;var g,f;for(g=0;g<a.length;g++)if(a[g].index===b.gateway){f=a[g];break}f?c(null,b):c(new e(d.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else c(new e(d.INVALID,"gateway is invalid"));else c(new e(d.INVALID,"id is invalid"));else c(new e(d.INVALID,
"info is invalid"))},deleteDevice:function(b,a,c){c()},applyUIFilter:function(b,a,c){var d=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},e=function(a,b,c){var e=[];"command"==c.catagory?a.command&&a.command.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))}):"status"==c.catagory&&a.status&&a.status.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});return e},f=function(a,b){var d=
[],f=null;if(f=xnm.aio.mirubee.DM.getCommandStatusMap(a,c))f=e(f,a,b),d=d.concat(f);return d};if(!b.sys)return null;var l=JSON.parse(JSON.stringify(b)),h=null;if("command"==a.catagory)h=f(b,a),l.command=h;else if("status"==a.catagory)h=f(b,a),l.status=h;else return null;return h&&0!=h.length?l:null},getCommandStatusMap:function(b,a){if(!b||!b.id||3>b.id.split(":").length)return null;var c={status:[]};c.status=this.MAP.meter.channel.status;return c}}}();
xnm.aio.mirubee.Handler=function(){var e=function(){};e.prototype.devicemanager=xnm.aio.mirubee.DM;e.prototype.Mirubee=xnm.aio.mirubee.Mirubee;e.prototype.registModule=function(b){b.register("mirubee","mirubee")};e.prototype.resolveGateway=function(b){return b?this.Mirubee.parseJSON(b):null};e.prototype.getDeviceCommands=function(b,a){var c=this.devicemanager.applyUIFilter(b,{catagory:"command",elems:"*"}),c=c?c.command:[];a&&a(null,c)};e.prototype.getDeviceStatus=function(b,a){var c=this.devicemanager.applyUIFilter(b,
{catagory:"status",elems:"*"}),c=c?c.status:[];a&&a(null,c)};e.prototype.doCommand=function(b,a,c,d){(b=this.resolveGateway(b))?b.executeCommandCreator(a,c,function(a){d&&d(a)}):d&&d(Error("gateway json format invalid"))};e.prototype.doStatus=function(b,a,c,d,e){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:b,device:c,status:d}],function(a,b){a?e&&e(a):e&&e(null,b[0])}):e&&e(Error("gateway json format invalid"))};e.prototype.getDeviceList=function(b,a){var c=this.resolveGateway(b);c?c.getDevices(function(b,
c){a&&a(b,c)}):a&&a(Error("gateway json format invalid"))};e.prototype.connect=function(b,a,c,d){(b=this.resolveGateway(b))?b.connect(a,c,function(a,b){d&&d(a,b)}):d&&d(Error("gateway json format invalid"))};e.prototype.disconnect=function(b,a){var c=this.resolveGateway(b);c?c.disconenct(function(b,c){a&&a(b,c)}):a&&a(Error("gateway json format invalid"))};return e}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.mirubee.Handler);
