var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.mirubee=xnm.aio.mirubee||{},xnm.aio.mirubee.Mirubee=function(){var e={},t=function t(_t,n,i){"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.mirubee.Mirubee"),this._protocol="https",this._ip="v5dev.mediola.com",this._port=443,this.username=_t,this.password=n,this.id=i,this._statesBuffer=e,this._getDeviceStatesCBs={};};return t.prototype._putStatesBuffer=function(e,t){this._statesBuffer[e]={data:t,timestamp:new Date().getTime()};},t.prototype._getStatesBuffer=function(e){var t=this._statesBuffer[e];if(!t)return null;var n=new Date().getTime();return t.timestamp?n-t.timestamp>6e4?(delete this._statesBuffer[e],null):t.data:(delete this._statesBuffer[e],null);},t.prototype.connect=function(e,t,n){this._doJsonRequest("GET","/eapi/v1/mirubee/connect",{account:e,password:t},null,function(e,t){n&&n(e,t);});},t.prototype.disconenct=function(e){this.id?this._doJsonRequest("GET","/eapi/v1/mirubee/disconnect",{id:this.id},null,function(t,n){e&&e(t,n);}):e&&e(new Error("account not connected"));},t.prototype.getInfo=function(e){this._doJsonRequest("GET","/eapi/v1/mirubee/info",null,null,function(t,n){e&&e(t,n);});},t.prototype.getDevices=function(e){this.id?this._doJsonRequest("GET","/eapi/v1/mirubee/devices/"+this.id,null,null,function(t,n){if(t)e&&e(t);else{var i=[];if(n)for(var r in n){var s=n[r];s.sys="mirubee",i.push(s);}e&&e(t,i);}}):e&&e(new Error("account not connected"));},t.prototype.executeCommandCreator=function(e,t,n){n&&n();},t.prototype.getStatesCreator=function(e,t,n){if(this.id){if(t){if(0!=t.length){for(var i=[],r=0;r<t.length;r++){var s=t[r];s&&s.device&&s.device.id&&-1==i.indexOf(s.device.id)&&i.push(s.device.id);}this.getStates(i,function(e,i){if(e)n&&n(e);else{for(var r=[],s=0;s<t.length;s++){var a=t[s];if(a&&a.id){var o=null;a.device&&a.device.id&&a.status&&a.status.value&&(o=i[a.device.id])&&(o=o[a.status.value]),void 0!==o&&null!=o||(o="?"),r.push({id:a.id,status:o});}}n&&n(null,r);}});}else n&&n(null,[]);}else n&&n(new Error("deviceList is null"));}else n&&n(new Error("account not connected"));},t.prototype.getStates=function(e,t){if(e&&0!=e.length)for(var n={},i=e.length,r=0;r<e.length;r++)this.getDeviceStates(e[r],function(e,r,s){!e&&r&&(n[s]=r),0==--i&&t&&t(null,n);});else t&&t(null,{});},t.prototype.getDeviceStates=function(e,t){var n=this._getStatesBuffer(e);if(n)t&&t(null,n,e);else{var i=this._getDeviceStatesCBs[e];i||(this._getDeviceStatesCBs[e]=[],i=this._getDeviceStatesCBs[e]);var r=i.length;if(i.push(t),!(r>0)){var s=this;this._getDeviceStates(e,function(t,n){var i=s._getDeviceStatesCBs[e];s._getDeviceStatesCBs[e]=[],!t&&n&&(n=s._resolveStates(n),s._putStatesBuffer(e,n));for(var r=0;r<i.length;r++)i[r]&&i[r](t,n,e);});}}},t.prototype._resolveStates=function(e){return e&&e.measured&&(e.measuredStr=new Date(e.measured).toLocaleString()),e;},t.prototype._getDeviceStates=function(e,t){if(this.id){var n="/eapi/v1/mirubee/states/"+this.id+"/"+e;this._doJsonRequest("GET",n,null,null,function(e,n){t&&t(e,n);});}else t&&t(new Error("account not connected"));},t.prototype._doJsonRequest=function(e,t,n,i,r){this._doRequest(e,t,n,i,function(e,t){e?r&&r(e):t?t.XC_ERR?((e=new Error("error response:"+t.XC_ERR.msg)).code=t.XC_ERR.code,r&&r(e)):t.XC_SUC?r&&r(null,t.XC_SUC):r&&r(new Error("unknown response")):r&&r(new Error("invalid response"));});},t.prototype._doRequest=function(e,t,n,i,r){var s=t;s||(s="/");var a={};n&&(a=JSON.parse(JSON.stringify(n)));var o="";for(var u in a)a.hasOwnProperty(u)&&(o&&(o+="&"),o+=u+"="+encodeURIComponent(a[u]));o&&(s+="?"+o);var l={host:this._ip,port:this._port,path:s,method:e,headers:{Connection:"close","Content-Type":"application/json;  charset=UTF-8"}};this._logger.log("trace","do request:"+JSON.stringify(l)),(this.username||this.password)&&(l.auth=(this.username?this.username:"")+":"+(this.password?this.password:""),l.headers.Authorization="Basic "+new Buffer((this.username?this.username:"")+":"+(this.password?this.password:"")).toString("base64")),i&&(l.headers["Content-Length"]=i.length);var c=require(this._protocol);"https"==this._protocol&&"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var d=this,f=r,p=c.request(l,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){var n,i;if(d._logger.log("trace","receive code:"+e.statusCode+" headers:"+JSON.stringify(e.headers)+" response:"+t),200==e.statusCode)try{i=t?JSON.parse(t):null;}catch(e){n=e;}else n=new Error("http reponse:"+e.statusCode);f&&(f(n,i,e.statusCode),f=null);});});p.on&&p.on("error",function(e){d._logger.log("trace","do request error:"+e.message),f&&(f(e),f=null);}),p.setTimeout&&p.setTimeout(2e4,function(){d._logger.log("trace","do request timeout"),p.abort(),f&&(f(new Error("timeout")),f=null);}),i&&(this._logger.log("trace","do request send body:"+i),p.write(i)),p.end();},t.prototype.toJSON=function(){return{sys:"mirubee",username:this.username,password:this.password,id:this.id};},t.prototype.equalsTo=function(e){return!!e&&e instanceof t&&this.id==e.id&&this.username==e.username&&this.password==e.password;},t.parseJSON=function(e){return e.username?new t(e.username,e.password,e.id):null;},t;}(),xnm.aio.mirubee.DM=function(){var e=function e(_e,t){this.code=_e,this.message=t,this.stack=new Error().stack;};return(e.prototype=new Error()).name="mirubeeDMError",e.prototype.code=0,e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"mirubee",MAP:{meter:{channel:{status:[{type:"float",name:"power",ref:{value:"power",unit:"W"}},{type:"float",name:"voltage",ref:{value:"voltage",unit:"V"}},{type:"float",name:"current",ref:{value:"current",unit:"A"}},{type:"int",name:"last measured time",ref:{value:"measured"}},{type:"string",name:"last measured time (text)",ref:{value:"measuredStr"}},{type:"statistic",name:"energy statistic",ref:{value:"energy"}}]}}},getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"mirubee (alfanar)"}];},createGateway:function createGateway(t,n,i){var r=e,s=e.ERROR_CODE;t?t.username?t.password?t.id?i(null,t):i(new r(s.INVALID,"id is invalid")):i(new r(s.INVALID,"password is invalid")):i(new r(s.INVALID,"username is invalid")):i(new r(s.INVALID,"info is invalid"));},updateGateway:function updateGateway(t,n,i,r){var s=e,a=e.ERROR_CODE;n?n.username?n.password?n.id?r(null,n):r(new s(a.INVALID,"id is invalid")):r(new s(a.INVALID,"password is invalid")):r(new s(a.INVALID,"username is invalid")):r(new s(a.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,n){n();},createDevice:function createDevice(t,n,i){var r=e,s=e.ERROR_CODE;if(t){if(t.id){if(t.gateway){var a,o,u=n.data.gateways;for(a=0;a<u.length;a++)if(u[a].index===t.gateway){o=u[a];break;}o?i&&i(null,t):i(new r(s.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else i(new r(s.INVALID,"gateway is invalid"));}else i(new r(s.INVALID,"id is invalid"));}else i(new r(s.INVALID,"info is invalid"));},updateDevice:function updateDevice(t,n,i){var r=e,s=e.ERROR_CODE;if(t){if(t.id){if(t.gateway){var a,o,u=n.data.gateways;for(a=0;a<u.length;a++)if(u[a].index===t.gateway){o=u[a];break;}o?i(null,t):i(new r(s.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}else i(new r(s.INVALID,"gateway is invalid"));}else i(new r(s.INVALID,"id is invalid"));}else i(new r(s.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,n){n();},applyUIFilter:function applyUIFilter(e,t,n){var i=function i(e,t){if("*"==e)return!0;for(var n=!1,i=0;i<e.length;i++)if(e[i]==t){n=!0;break;}return n;},r=function r(e,t){var r=[],s=null,a=xnm.aio.mirubee.DM.getCommandStatusMap(e,n);return a&&(s=function(e,t,n){var r=[];return"command"==n.catagory?e.command&&e.command.forEach(function(e){if(i(n.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}}):"status"==n.catagory&&e.status&&e.status.forEach(function(e){if(i(n.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}}),r;}(a,0,t),r=r.concat(s)),r;};if(!e.sys)return null;var s=JSON.parse(JSON.stringify(e)),a=null;if("command"==t.catagory)a=r(e,t),s.command=a;else{if("status"!=t.catagory)return null;a=r(e,t),s.status=a;}return a&&0!=a.length?s:null;},getCommandStatusMap:function getCommandStatusMap(e,t){if(!e||!e.id)return null;if(e.id.split(":").length<3)return null;var n={status:[]};return n.status=this.MAP.meter.channel.status,n;}};}(),xnm.aio.mirubee.Handler=function(){var e=function e(){};return e.prototype.devicemanager=xnm.aio.mirubee.DM,e.prototype.Mirubee=xnm.aio.mirubee.Mirubee,e.prototype.registModule=function(e){e.register("mirubee","mirubee");},e.prototype.resolveGateway=function(e){return e?this.Mirubee.parseJSON(e):null;},e.prototype.getDeviceCommands=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),i=n?n.command:[];t&&t(null,i);},e.prototype.getDeviceStatus=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),i=n?n.status:[];t&&t(null,i);},e.prototype.doCommand=function(e,t,n,i){var r=this.resolveGateway(e);r?r.executeCommandCreator(t,n,function(e){i&&i(e);}):i&&i(new Error("gateway json format invalid"));},e.prototype.doStatus=function(e,t,n,i,r){var s=this.resolveGateway(t);if(s){var a=[{id:e,device:n,status:i}];s.getStatesCreator(null,a,function(e,t){e?r&&r(e):r&&r(null,t[0]);});}else r&&r(new Error("gateway json format invalid"));},e.prototype.getDeviceList=function(e,t){var n=this.resolveGateway(e);n?n.getDevices(function(e,n){t&&t(e,n);}):t&&t(new Error("gateway json format invalid"));},e.prototype.connect=function(e,t,n,i){var r=this.resolveGateway(e);r?r.connect(t,n,function(e,t){i&&i(e,t);}):i&&i(new Error("gateway json format invalid"));},e.prototype.disconnect=function(e,t){var n=this.resolveGateway(e);n?n.disconenct(function(e,n){t&&t(e,n);}):t&&t(new Error("gateway json format invalid"));},e;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.mirubee.Handler());