var m=m||{};m.aio=m.aio||{},m.aio.smartwidget=m.aio.smartwidget||{},m.aio.smartwidget.Handler=function(){this._supportedGeneralDeviceType=["switch","light","dimmer","blind","shutter","motion","smoke","door","contact","powermeter","temperature","weatherstation","powerswitch","heater","water","window","co2","rain","brightness","home"],this.supportSmartWidget=function(e,t){if(!e||!e.sys)return!1;var a=null,o=null;if("hm"==e.sys)return(o=(a=require("xnm.aio.hm.js")).devicemanager).supportSmartWidget(e);if("hue"==e.sys)return(o=(a=require("xnm.aio.hue.js")).devicemanager).supportSmartWidget(e);if(["bose","heos","raumfeld","sonos"].includes(e.sys))return!0;if(!(a=require("m.aio.modulemanager.js").getModule(e.sys)))return console.error("[m.aio.smartwidget.supportSmartWidget] Module not found for system: "+e.sys),!1;if(!(o=a.devicemanager))return!1;if(o.toGeneralDevice){var r=o.toGeneralDevice(e);if(r&&r.type&&-1!=this._supportedGeneralDeviceType.indexOf(r.type))return!0;}return!!o.supportSmartWidget&&o.supportSmartWidget(e,t);},this.applySmartWidgetFilter=function(e,t,a,o){if(!e||!e.sys)return!1;var r,s,n;if("hm"==e.sys)return(r=require("xnm.aio.hm.js").devicemanager).applySmartWidgetFilter(e,a,o);if("hue"==e.sys)return(r=require("xnm.aio.hue.js").devicemanager).applySmartWidgetFilter(e,a,o);if(!(r=require("m.aio.modulemanager.js").getModule(e.sys).devicemanager))return!1;if(r.toGeneralDevice){var i=r.toGeneralDevice(e,null,null,t);if(i){var m=this._getSupportWidgetTypes(i),c=this._getCommandMap(i),u=this._getStatusMap(i),l=this._getIconMap(i);s=this._injectToSmartWidgetTemplate(a,m,o,c,u,l);}}if(r.applySmartWidgetFilter&&(n=r.applySmartWidgetFilter(this,e,t,a,o)),!s)return n;if(!n)return s;for(var p=s,d=0,h=n.length;d<h;d++){for(var f=n[d],g=null,w=!1,v=0;v<s.length;v++)if(g=s[v],f.meta&&g.meta&&f.meta.id==g.meta.id){w=!0;break;}!w&&f&&p.push(f);}return p;},this._getSupportWidgetTypes=function(e){var t=[];switch(e.type){case"switch":case"light":t.push("switch"),e.states&&(e.states.power||e.states.consumption)&&t.push("powermeter");break;case"dimmer":t.push("switch"),t.push("dimmer"),e.commands&&(e.commands.color||e.commands.colorTemperature)&&t.push("rgb");break;case"blind":case"shutter":e.commands&&(e.commands.rotation||e.commands.lamellaUp||e.commands.lamellaDown)?(t.push("blind"),t.push("shutter")):t.push("shutter");break;case"motion":t.push("motion");break;case"smoke":t.push("smoke");break;case"door":case"contact":t.push("contact");break;case"powermeter":t.push("powermeter");break;case"temperature":t.push("climate");break;case"weatherstation":t.push("weather_station"),t.push("climate");break;case"powerswitch":t.push("switch"),t.push("powermeter");break;case"heater":t.push("thermostat");break;case"water":t.push("sensor_water");break;case"window":t.push("window");break;case"co2":t.push("sensor_co2");break;case"rain":t.push("rain");break;case"brightness":t.push("generic_state");}return t;},this._getCommandMap=function(e){var t={},a=e.details?e.details.commands:null;if(!a)return null;switch(e.type){case"switch":case"light":case"powerswitch":a.on&&(t["%on%"]=a.on),a.off&&(t["%off%"]=a.off),a.toggle&&(t["%toggle%"]=a.toggle);break;case"dimmer":a.on&&(t["%on%"]=a.on,t["%dimOn%"]=a.on),a.off&&(t["%dimOff%"]=a.off,t["%off%"]=a.off),a.toggle&&(t["%toggle%"]=a.toggle),a.up&&(t["%dimUp%"]=a.up),a.down&&(t["%dimDown%"]=a.down),a.brightness&&(t["%dimTo%"]=a.brightness),a.color&&(t["%rgb%"]=a.color),a.white?t["%white%"]=a.white:a.color&&a.color.ext&&e.commands.color&&"RGB"==e.commands.color.type&&(t["%white%"]=JSON.parse(JSON.stringify(a.color)),t["%white%"].ext="FFFFFF"),a.colorTemperature&&(t["%colorTemp%"]=a.colorTemperature);break;case"blind":case"shutter":a.up&&(t["%moveUp%"]=a.up),a.down&&(t["%moveDown%"]=a.down),a.stop&&(t["%stop%"]=a.stop),a.stepUp&&(t["%stepUp%"]=a.stepUp),a.stepDown&&(t["%stepDown%"]=a.stepDown),a.position&&(t["%moveTo%"]=a.position),a.lamellaUp&&(t["%lamellaUp%"]=a.lamellaUp),a.lamellaDown&&(t["%lamellaDown%"]=a.lamellaDown),a.rotation&&(t["%lamellaTo%"]=a.rotation);break;case"heater":a.auto&&(t["%thermoAuto%"]=a.auto),a.manu&&(t["%thermoManu%"]=a.manu),a.boost&&(t["%thermoBoost%"]=a.boost),a.up&&(t["%thermoTempUp%"]=a.up),a.down&&(t["%thermoTempDown%"]=a.down),a.temperature&&(t["%thermoTempTo%"]=a.temperature),a.tempTo&&(t["%thermoTempTo%"]=a.tempTo);}return t;},this._getStatusMap=function(e){var t=function t(e,_t){if(e&&!_t)return e;if(!e&&_t)return _t;if(!e&&!_t)return null;var a={};for(var o in e){var r=e[o];r&&_t[r]&&(a[o]=_t[r]);}return a;},a={},o=e.details?e.details.states:null;if(!o)return null;switch(e.type){case"switch":case"light":o.state&&(a["%switchState%"]=o.state,a["%switchState%"].conv_s=t(o.state.conv_s,null)),o.consumption&&(a["%meterEnergyCounter%"]=o.consumption),o.power&&(a["%meterPower%"]=o.power);break;case"dimmer":o.state&&(a["%switchState%"]=o.state,a["%switchState%"].conv_s=t(o.state.conv_s,null)),o.brightness&&(a["%dimmerState%"]=o.brightness,a["%dimmerState%"].conv_s=t(o.brightness.conv_s,null)),o.colorTemperature&&(a["%colorTempState%"]=o.colorTemperature,a["%colorTempState%"].conv_s=t(o.colorTemperature.conv_s,null));break;case"blind":case"shutter":o.position&&(a["%blindState%"]=o.position,a["%shutterState%"]=o.position),o.rotation&&(a["%lamellaState%"]=o.rotation);break;case"heater":o.state&&(a["%thermoSetTemp%"]=o.state),o.setpoint&&(a["%thermoSetTemp%"]=o.setpoint),o.temperature&&(a["%thermoCurrentTemp%"]=o.temperature),o.humidity&&(a["%thermoHum%"]=o.humidity),o.mode&&(a["%thermoMode%"]=o.mode,e.states&&e.states.mode&&e.states.mode.values&&-1!=e.states.mode.values.indexOf("boost")&&(a["%thermoBoostMode%"]=JSON.parse(JSON.stringify(o.mode)),a["%thermoBoostMode%"].conv_s=t(o.mode.conv_s,{auto:"off",manu:"off",boost:"on"}))),o.boostMode&&(a["%thermoBoostMode%"]=o.boostMode,a["%thermoBoostMode%"].conv_s=t(o.boostMode.conv_s,null));break;case"motion":o.motion&&(a["%motionState%"]=o.motion,a["%motionState%"].conv_s=t(o.motion.conv_s,{on:"true",off:"false"}));break;case"smoke":o.smoke&&(a["%smokeState%"]=o.smoke,a["%smokeState%"].conv_s=t(o.smoke.conv_s,{on:"true",off:"false"}));break;case"rain":o.rain&&(a["%rainState%"]=o.rain,a["%rainState%"].conv_s=t(o.rain.conv_s,{on:"true",off:"false"}));break;case"water":o.water&&(a["%waterState%"]=o.water,a["%waterState%"].conv_s=t(o.water.conv_s,{on:"water",off:"dry"}));break;case"contact":case"door":o.state&&(a["%contactState%"]=o.state,a["%contactState%"].conv_s=t(o.state.conv_s,null));break;case"powermeter":case"powerswitch":o.state&&(a["%switchState%"]=o.state,a["%switchState%"].conv_s=t(o.state.conv_s,null)),o.consumption&&(a["%meterEnergyCounter%"]=o.consumption,a["%meterEnergyCounter%"].conv_s=t(o.consumption.conv_s,null)),o.power&&(a["%meterPower%"]=o.power,a["%meterPower%"].conv_s=t(o.power.conv_s,null)),o.voltage&&(a["%meterVoltage%"]=o.voltage,a["%meterVoltage%"].conv_s=t(o.voltage.conv_s,null));break;case"temperature":o.temperature&&(a["%tempState%"]=o.temperature),o.humidity&&(a["%humState%"]=o.humidity);break;case"weatherstation":o.temperature&&(a["%tempState%"]=o.temperature),o.humidity&&(a["%humState%"]=o.humidity),o.brightness&&(a["%brightnessState%"]=o.brightness),o.windSpeed&&(a["%windspeedState%"]=o.windSpeed),o.windDirection&&(a["%windDirection%"]=o.windDirection,a["%windDirection%"].conv_i=o.windDirection.conv_i),o.rain&&(a["%rainingState%"]=o.rain,a["%rainingState%"].conv_s=t(o.rain.conv_s,null)),o.rainCount&&(a["%rainingCounterState%"]=o.rainCount),o.sunshine&&(a["%sunshineState%"]=o.sunshine);break;case"window":o.state&&(a["%windowState%"]=o.state,a["%windowState%"].conv_s=t(o.state.conv_s,null));break;case"co2":o.co2&&(a["%co2State%"]=o.co2,a["%co2State%"].conv_s=t(o.co2.conv_s,{normal:"normal",medium:"added",high:"added_strong"}));break;case"brightness":o.brightness&&(a["%state%"]=o.brightness);}return a;},this._getIconMap=function(e){var t={};return e.details&&e.details.states?("brightness"===e.type&&(t["%icon%"]="sun"),t):null;},this._injectToSmartWidgetTemplate=function(e,t,a,o,r,s){var n=[];if(!t)return n;e||(e={}),o||(o={}),r||(r={}),console.log("support widgets",t);for(var i=0;i<e.length;i++){var m=e[i];if(m.meta&&-1!=t.indexOf(m.meta.type)&&m.elements){var c=JSON.parse(JSON.stringify(m));console.log("check widget",c.meta.id,c.meta.type);var u=!1,l=!1;for(var p in c.elements){var d=c.elements[p];if(d&&Array.isArray(d))for(var h=0;h<d.length;h++){var f=d[h];if(f){if(f.action&&("command"==f.action.type||"camera"==f.action.type)&&f.action.ref&&f.action.ref.value){var g=f.action.ref.ext;if(o[f.action.ref.value]){if(f.action.ref=JSON.parse(JSON.stringify(o[f.action.ref.value])),void 0!==g&&null!=g&&(f.action.ref.ext=g),f.action.device=a,("sliders"==p||"roundsliders"==p)&&f.action.ref.extMeta){var w=f.action.ref.extMeta.indexOf("-",1);if(-1!=w){var v=f.action.ref.extMeta.substr(0,w);v=parseFloat(v);var S=f.action.ref.extMeta.substr(w+1);S=parseFloat(S),isNaN(v)||(f.min=v),isNaN(S)||(f.max=S);}}u=!0;}else console.log("no match action",f.action),l=!0,f.action=null;}f.status&&f.status.ref&&f.status.ref.value&&(r[f.status.ref.value]?(f.status.ref=JSON.parse(JSON.stringify(r[f.status.ref.value])),f.status.device=a,u=!0):(console.log("no match status",f.status),l=!0,f.status=null)),f.maxValFromStatus&&f.maxValFromStatus.ref&&f.maxValFromStatus.ref.value&&(r[f.maxValFromStatus.ref.value]?(f.maxValFromStatus.ref=JSON.parse(JSON.stringify(r[f.maxValFromStatus.ref.value])),f.maxValFromStatus.device=a,u=!0):(console.log("no match maxValFromStatus",f.maxValFromStatus),l=!0,f.maxValFromStatus=null)),f.widget&&"%icon%"==f.widget.key_img&&s&&(f.widget.key_img=s["%icon%"]);}}}u&&!l&&(console.log("find match widget",c.meta.id,c.meta.type),n.push(c));}}return n;};},"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.smartwidget.Handler());