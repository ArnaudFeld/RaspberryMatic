var m=m||{};m.aio=m.aio||{};m.aio.smartwidget=m.aio.smartwidget||{};
m.aio.smartwidget.Handler=function(){this.supportSmartWidget=function(d){if(!d||!d.sys)return!1;if("hm"==d.sys){var c=require("xnm.aio.hm.js");c=c.devicemanager;return c.supportSmartWidget(d)}return"hue"==d.sys?(c=require("xnm.aio.hue.js"),c=c.devicemanager,c.supportSmartWidget(d)):null};this.applySmartWidgetFilter=function(d,c,a){if(!d||!d.sys)return!1;if("hm"==d.sys){var b=require("xnm.aio.hm.js");b=b.devicemanager;return b.applySmartWidgetFilter(d,c,a)}if("hue"==d.sys)return b=require("xnm.aio.hue.js"),
b=b.devicemanager,b.applySmartWidgetFilter(d,c,a);b=require("m.aio.modulemanager.js").getModule(d.sys);b=b.devicemanager;if(!b||!b.toGeneralDevice)return!1;var f=b.toGeneralDevice(d);if(!f)return!1;d=this._getSupportWidgetTypes(f);b=this._getCommandMap(f);f=this._getStatusMap(f);return this._injectToSmartWidgetTemplate(c,d,a,b,f)};this._getSupportWidgetTypes=function(d){var c=[];switch(d.type){case "switch":case "light":c.push("switch");break;case "dimmer":c.push("switch");c.push("dimmer");d.commands&&
d.commands.color&&c.push("rgb");break;case "blind":d.commands&&(d.commands.rotation||d.commands.lamellaUp||d.commands.lamellaDown)&&c.push("blind");c.push("shutter");break;case "motion":c.push("motion");break;case "smoke":c.push("smoke");break;case "door":c.push("contact");break;case "powermeter":c.push("powermeter");break;case "temperature":c.push("climate");break;case "weatherstation":c.push("weather_station");c.push("climate");break;case "powerswitch":c.push("switch");c.push("powermeter");break;
case "heater":c.push("thermostat")}return c};this._getCommandMap=function(d){var c={},a=d.details?d.details.commands:null;if(!a)return null;switch(d.type){case "switch":case "light":case "powerswitch":a.on&&(c["%on%"]=a.on);a.off&&(c["%off%"]=a.off);a.toggle&&(c["%toggle%"]=a.toggle);break;case "dimmer":a.on&&(c["%dimOn%"]=a.on);a.off&&(c["%dimOff%"]=a.off,c["%off%"]=a.off);a.brightness&&(c["%dimTo%"]=a.brightness);a.color&&(c["%rgb%"]=a.color);a.white&&(c["%white%"]=a.white);break;case "blind":a.up&&
(c["%moveUp%"]=a.up);a.down&&(c["%moveDown%"]=a.down);a.stop&&(c["%stop%"]=a.stop);a.position&&(c["%moveTo%"]=a.position);a.lamellaUp&&(c["%lamellaUp%"]=a.lamellaUp);a.lamellaDown&&(c["%lamellaDown%"]=a.lamellaDown);a.rotation&&(c["%lamellaTo%"]=a.rotation);break;case "heater":a.auto&&(c["%thermoAuto%"]=a.auto),a.manu&&(c["%thermoManu%"]=a.manu),a.boost&&(c["%thermoBoost%"]=a.boost),a.up&&(c["%thermoTempUp%"]=a.up),a.down&&(c["%thermoTempDown%"]=a.down),a.tempTo&&(c["%thermoTempTo%"]=a.tempTo)}return c};
this._getStatusMap=function(d){var c=function(a,b){if(b&&!b)return a;if(!a&&b)return b;if(!a&&!b)return null;var c={},d;for(d in a){var f=a[d];f&&b[f]&&(c[d]=b[f])}return c},a={},b=d.details?d.details.states:null;if(!b)return null;switch(d.type){case "switch":case "light":b.state&&(a["%switchState%"]=b.state,a["%switchState%"].conv_s=c(b.state.conv_s,null));break;case "dimmer":b.brightness&&(a["%dimmerState%"]=b.brightness,a["%switchState%"].conv_s=c(b.brightness.conv_s,null));break;case "blind":b.position&&
(a["%blindState%"]=b.position);b.rotation&&(a["%lamellaState%"]=b.rotation);break;case "heater":b.setpoint&&(a["%thermoSetTemp%"]=b.setpoint);b.temperature&&(a["%thermoCurrentTemp%"]=b.temperature);b.humidity&&(a["%thermoHum%"]=b.humidity);b.mode&&(a["%thermoMode%"]=b.mode);break;case "motion":b.motion&&(a["%motionState%"]=b.motion,a["%motionState%"].conv_s=c(b.motion.conv_s,{on:"true",off:"false"}));break;case "smoke":b.smoke&&(a["%smokeState%"]=b.smoke,a["%smokeState%"].conv_s=c(b.smoke.conv_s,
{on:"true",off:"false"}));break;case "contact":b.state&&(a["%contactState%"]=b.state,a["%contactState%"].conv_s=c(b.state.conv_s,null));break;case "powermeter":case "powerswitch":b.consumption&&(a["%meterEnergyCounter%"]=b.consumption,a["%meterEnergyCounter%"].conv_s=c(b.consumption.conv_s,null));b.voltage&&(a["%meterVoltage%"]=b.voltage,a["%meterVoltage%"].conv_s=c(b.voltage.conv_s,null));break;case "temperature":b.temperature&&(a["%tempState%"]=b.temperature);b.humidity&&(a["%humState%"]=b.humidity);
break;case "weatherstation":b.temperature&&(a["%tempState%"]=b.temperature),b.humidity&&(a["%humState%"]=b.humidity),b.windSpeed&&(a["%windspeedState%"]=b.windSpeed),b.rainCount&&(a["%rainingCounterState%"]=b.rainCount)}return a};this._injectToSmartWidgetTemplate=function(d,c,a,b,f){var p=[];d||(b={});b||(b={});f||(f={});for(var k=0;k<d.length;k++){var g=d[k];if(g.meta&&-1!=c.indexOf(g.meta.type)&&g.elements){g=JSON.parse(JSON.stringify(g));var l=!1,q;for(q in g.elements){var h=g.elements[q];if(h&&
Array.isArray(h))for(var n=0;n<h.length;n++){var e=h[n];e&&(e.action&&"command"==e.action.type&&e.action.ref&&e.action.ref.value&&(b[e.action.ref.value]?(e.action.ref=b[e.action.ref.value],e.action.device=a,l=!0):e.action=null),e.status&&e.status.ref&&e.status.ref.value&&(f[e.status.ref.value]?(e.status.ref=f[e.status.ref.value],e.status.device=a,l=!0):e.status=null))}}l&&p.push(g)}}return p}};"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.smartwidget.Handler);
