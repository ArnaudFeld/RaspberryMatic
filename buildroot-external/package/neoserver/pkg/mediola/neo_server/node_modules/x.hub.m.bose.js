var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{},x.hub.m=x.hub.m||{},x.hub.m.bose=x.hub.m.bose||{},x.hub.m.bose.MODULE=require("xnm.aio.bose.js"),x.hub.m.bose.AudioPlayer=function(){var e=function e(){this._process={};};return e.prototype.playFile=function(e,t,r){if(t&&t.file){var o=require("x.hub.resource.js").getFileURL(t.file,e.ip);o?(t.url=o,this.playUrl(e,t,r)):r&&r(new Error("no such file"));}else r&&r(new Error("invalid file"));},e.prototype.playUrl=function(e,t,r){if(t&&t.url){var o=x.hub.m.bose.MODULE.resolveDevice(e);if(o){var n=t.url,i=this;this._cancelPlay(o,function(e){e?r&&r(e):i._setVolume(o,t.volume,function(e){e?r&&r(e):i._setRepeat(o,t.repeat,function(e){e?r&&r(e):i._unmute(o,function(e){e?r&&r(e):i._playUrl(o,n,function(e){e?r&&r(e):t.repeat&&-1!=t.repeat&&(i._process[o.getIP()]={url:n},i._process[o.getIP()].timeout=setTimeout(function(){var e=i._process[o.getIP()].url;i._process[o.getIP()]=null,i._stopPlay(o,e);},1e3*parseInt(t.repeat)));});});});});}),r&&r(null,1);}else r&&r(new Error("invalid device json"));}else r&&r(new Error("invalid url"));},e.prototype._cancelPlay=function(e,t){var r=e.getIP();if(r&&this._process[r]){this._process[r].timeout&&clearTimeout(this._process[r].timeout);var o=this._process[r].url;this._process[r]=null,o?this._stopPlay(e,o,t):t&&t();}else t&&t();},e.prototype._stopPlay=function(e,t,r){e._getNowPlaying(function(o,n){!o&&n&&n.currentURI&&n.currentURI!=t?r&&r():e._clickKey("STOP",r);});},e.prototype._setVolume=function(e,t,r){t?e._setVolume(t,r):r&&r();},e.prototype._setRepeat=function(e,t,r){t?e._clickKey("REPEAT_ONE",r):r&&r();},e.prototype._unmute=function(e,t){t&&t();},e.prototype._playUrl=function(e,t,r){t?e.playUrl(t,r):r&&r(new Error("invalid url"));},e;}(),x.hub.m.bose.Handler=function(){var e=function e(){this._audioPlayer=new x.hub.m.bose.AudioPlayer();};return util.inherits(e,EventEmitter),e.prototype.init=function(e){e&&e();},e.prototype.getSystems=function(){return["bose"];},e.prototype.executeCommand=function(e,t,r){t?"playFile"==t.value?this._audioPlayer.playFile(e,t,function(e){r&&r({error:e});}):"playUrl"==t.value&&(t.repeat||t.volume)?this._audioPlayer.playUrl(e,t,function(e){r&&r({error:e});}):x.hub.m.bose.MODULE.doCommand(e,t,r):r&&r({error:new Error("invalid command")});},e;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.bose.Handler());