var x=x||{};x.hub=x.hub||{};x.hub.fileman=x.hub.fileman||{};
x.hub.fileman._Util={inNodeWebkit:function(){return process.versions["node-webkit"]},getUserHome:function(){return process.env["win32"==process.platform?"USERPROFILE":"HOME"]},getUserDocumentFolder:function(b){var a=require("path"),e=this;switch(process.platform){case "win32":a=require("winreg");(new a({hive:a.HKCU,key:"\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders"})).values(function(c,d){if(c)console.error(c.message),e.getUserDocumentFolderNoWinReg(b);else{var a=null;if(!c&&
d)for(var g=0;g<d.length;g++)if("Personal"==d[g].name&&d[g].value){a=d[g].value;break}a||(c=Error("win32 do not have user document folder registry"));b&&b(c,a)}});break;case "darwin":var c=this.getUserHome();b(null,c+a.sep+"Documents");break;default:b(null,this.getUserHome())}},getUserDocumentFolderNoWinReg:function(b){var a=null;if("win32"!=process.platform)a=Error("[getUserDocumentFolderFallback] No fallback for "+process.platform),b&&b(a,null);else{var e=require("path"),c=require("os"),f=require("fs"),
c=c.homedir(),d=e.join(c,"Documents");f.existsSync(d)||(d=e.join(c,"My Documents"),f.existsSync(d)||(a=Error("Could not find documents folder."),d=null));b&&b(a,d)}},getUserDocumentFolderOld:function(b){var a=require("path");switch(process.platform){case "win32":require("regedit").list("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders",function(c,a){if(c)b(c);else{var d=a["HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders"];d?(d=d.values)?d.Personal&&
d.Personal.value?b(null,d.Personal.value):b(Error("win32 do not have user document folder registry")):b(Error('"HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders" has no records')):b(Error('"HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders" not found'))}});break;case "darwin":var e=this.getUserHome();b(null,e+a.sep+"Documents");break;default:b(null,this.getUserHome())}},getWindowsCommonAppDataFolder:function(b){var a=require("winreg");(new a({hive:a.HKLM,
key:"\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders"})).values(function(a,c){a&&console.error("read windows common app data registry error",a);var f=null;if(!a&&c)for(var d=0;d<c.length;d++)if("Common AppData"==c[d].name&&c[d].value){f=c[d].value;break}f||(f=require("os").release().split("."),f=6>parseInt(f[0])?"C:\\Documents and Settings\\All Users":"C:\\ProgramData");b&&b(null,f)})},getWindowsCommonAppDataFolderOld:function(b){require("regedit").list("HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders",
function(a,e){if(a)b(a);else{var c=e["HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders"];if(c)if(c=c.values){if(!c["Common AppData"]||!c["Common AppData"].value)try{var f=require("os").release().split(".");6>parseInt(f[0])?b(null,"C:\\Documents and Settings\\All Users"):b(null,"C:\\ProgramData");return}catch(d){b(Error("win32 do not have common appdata folder registry"));return}b(null,c["Common AppData"].value)}else b(Error('"HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders" has no records'));
else b(Error('"HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders" not found'))}})}};
x.hub.fileman._NativeFileManager={logger:null,_pkgName:null,_userDir:null,_userDoc:{},_winCommonAppData:null,init:function(b,a){this._logger||(this._logger=require("x.logger.js").getLogger("x.hub.fileman._NativeFileManager"));this._logger.log("trace","init");this._pkgName=b;var e=require("async"),c=this;try{this._userDir=require("../src/filemanager")._userDir,this._logger.log("trace","Using userDir set in filemanager.")}catch(f){}e.series([function(b){c._logger.log("trace","get user document folder");
if(this._userDir){var a=require("path");if(a.resolve(this._userDir)==a.normalize(this._userDir)){this._userDoc[process.platform]=a.normalize(this._userDir);b();return}}x.hub.fileman._Util.getUserDocumentFolder(function(a,e){a?(c._logger.log("trace","get user document folder error:"+a.message),b(a)):(c._logger.log("trace","user document folder: ("+process.platform+"):"+e),this._userDoc[process.platform]=e,b())}.bind(this))}.bind(this),function(a){"win32"==process.platform?(c._logger.log("trace","get windows common app data folder"),
x.hub.fileman._Util.getWindowsCommonAppDataFolder(function(b,e){b?(c._logger.log("trace","get windows common app data folder error:"+b.message),a(b)):(c._logger.log("trace","windows common app data folder:"+e),this._winCommonAppData=e,a())}.bind(this))):a()}.bind(this)],function(b){a&&a(b)})},getAppRootDataPath:function(){return x.hub.fileman._Util.inNodeWebkit()?this._getNodeWebkitRootDataPath():this._getNodeRootDataPath()},getUserRootDataPath:function(){var b=require("path");return this._userDoc[process.platform]+
b.sep+this._pkgName},getTmpDir:function(){return require("os").tmpdir()},_getNodeRootDataPath:function(){var b=require("path");switch(process.platform){case "darwin":return"/Library/Application Support/"+this._pkgName;case "win32":return this._winCommonAppData+b.sep+this._pkgName;default:return x.hub.fileman._Util.getUserHome()+b.sep+this._pkgName}},_getNodeWebkitRootDataPath:function(){var b=require("path");switch(process.platform){case "darwin":return x.hub.fileman._Util.getUserHome()+"/Library/Application Support/"+
this._pkgName;case "win32":return this._winCommonAppData+b.sep+this._pkgName;default:return x.hub.fileman._Util.getUserHome()+b.sep+this._pkgName}}};
x.hub.fileman.FileManager=function(){var b=function(){this._logger=require("x.logger.js").getLogger("x.hub.fileman.FileManager");this._packageName=null};b.prototype.init=function(a,b){this._logger.log("info","init filemanager");this._packageName=a;var c=this;x.hub.fileman._NativeFileManager.init(a,function(a){a?(c._logger.log("warn","init naive filemanager error:"+a.message),b&&b(a)):require("m.aio.filemanager.js").init(c,function(a){if(a)c._logger.log("warn","init filemanager module error:"+a.message),
b&&b(a);else{a=c.getUserRootDataPath();c._logger.log("info","user root folder:"+a);var f=require("fs-extra");f.ensureDir(a,function(a){a?b&&b(a):(a=c.getAppRootDataPath(),c._logger.log("info","app root folder:"+a),f.ensureDir(a,function(a){a?b&&b(a):(a=c.getLogFile(),c._logger.log("info","log file:"+a),f.ensureFile(a,function(a){b&&b(a)}))}))})}})})};b.prototype.getUserRootDataPath=function(){if(global&&global.DATA_FOLDER)return global.DATA_FOLDER;var a=require("path"),b=x.hub.fileman._NativeFileManager.getUserRootDataPath();
b||(b="userroot");return b+a.sep+"data"};b.prototype.getAppRootDataPath=function(){if(global&&global.APP_FOLDER)return global.APP_FOLDER;var a=x.hub.fileman._NativeFileManager.getAppRootDataPath();a||(a="approot");return a};b.prototype.getTmpDir=function(){return x.hub.fileman._NativeFileManager.getTmpDir()};b.prototype.getLogFile=function(){var a=require("path");return global&&global.LOG_ROOT?global.LOG_ROOT+a.sep+this._packageName+".log":global&&global.DATA_FOLDER?global.DATA_FOLDER+a.sep+"log"+
a.sep+this._packageName+".log":require("m.aio.filemanager.js").getUserLogPath()+a.sep+this._packageName+".log"};b.prototype.getUserLogPath=function(){var a=require("path");return global&&global.LOG_ROOT?global.LOG_ROOT:global&&global.DATA_FOLDER?global.DATA_FOLDER+a.sep+"log":require("m.aio.filemanager.js").getUserLogPath()};return b}();x.hub.fileman.Handler=function(){this.fileManager=new x.hub.fileman.FileManager};x.hub.fileman.Handler.prototype.FileManager=x.hub.fileman.FileManager;
x.hub.fileman.Handler.prototype.init=function(b,a){this.fileManager.init(b,a)};module.exports=new x.hub.fileman.Handler;
