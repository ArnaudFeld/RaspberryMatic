var util=require("util"),taskman=require("x.hub.taskman.js"),actman=require("x.hub.action.js"),commandman=require("x.hub.commandman.js"),eventbus=require("x.hub.eventbus.js"),moment=require("moment-timezone"),x=x||{};x.hub=x.hub||{};x.hub.rule=x.hub.rule||{};
x.hub.rule.RuleManager=function(){var t={getMomentNow:function(){var a=taskman.Util._getTimeZone(),c=(new Date).getTime();return moment.tz(c,a)}},l=function(a){this._logger=require("x.logger.js").getLogger("x.hub.rule.RuleManager.CronTimer");this._ruleManager=a;this._cronJob=null};l.prototype.start=function(){var a=taskman.Util._getTimeZone();this._logger.log("trace","start cron job:00 * * * * * tz:"+a);this._cronJob=new (require("cron").CronJob)("00 * * * * *",this.onTick.bind(this),null,!0,a)};
l.prototype.stop=function(){this._logger.log("debug","stop timer:"+JSON.stringify(this.timer));this._cronJob&&(this._cronJob.stop(),this._cronJob=null)};l.prototype.onTick=function(){this._logger.log("trace","timer tick");this._ruleManager.onTimerTick(t.getMomentNow())};l.prototype.onLocationChange=function(){this.stop();this.start()};l.prototype.onTimeChange=function(){this.stop();this.start()};var k=function(a){this._logger=require("x.logger.js").getLogger("x.hub.rule.RuleManager.Rule.#"+a);this._id=
a;this._ruleManager=this._json=null;this._state=0;this._activateCallbacks=[]};k.prototype.finalize=function(){};k.prototype.executeCommand=function(a,c){a&&a.command?"activate"==a.command?this.setActive(!0,function(a){c&&c(a)}):"deactivate"==a.command?this.setActive(!1,function(a){c&&c(a)}):"execute"==a.command?this.doActions(function(a){c&&c(a)}):c&&c(Error("invalid command")):c&&c(Error("invalid command"))};k.prototype.getStates=function(a){a&&a(null,{active:this.isActive()})};k.prototype.isActive=
function(){return this._json&&1==this._json.active};k.prototype.setActive=function(a,c){if(this._json){var b=this.isActive();if(b&&a||!b&&!a)c&&c();else if(1!=this._state||a)if(2==this._state&&a)c&&c(Error("deactivate process is rinning"));else{if(c&&-1==this._activateCallbacks.indexOf(c)&&this._activateCallbacks.push(c),0==this._state){var d=this;this._state=a?1:2;this[a?"_doActivate":"_doDeactivate"](function(a){d._state=0;var c=d._activateCallbacks;d._activateCallbacks=[];c.forEach(function(c){try{c&&
c(a)}catch(m){}})})}}else c&&c(Error("activate process is rinning"))}else c&&c(Error("invalid rule"))};k.prototype._doActivate=function(a){this._json.active=1;this._ruleManager.onRuleChanged(this._id,function(c){a&&a(c)})};k.prototype._doDeactivate=function(a){this._json.active=0;this._ruleManager.onRuleChanged(this._id,function(c){a&&a(c)})};k.prototype.matchTimeRequirement=function(a){if(!this._json)return!1;var c=this._json,b=taskman.Util._getTimeZone(),d=a.valueOf();if(c.start&&"0000-00-00"!=
c.start){var e=moment.tz(c.start,b);e.set({hour:0,minute:0,second:0,millisecond:0});if(e.valueOf()>d)return!1}return c.end&&"0000-00-00"!=c.end&&(b=moment.tz(c.end,b),b.set({hour:23,minute:59,second:59,millisecond:999}),b.valueOf()<d)||c.days&&(a=a.day(),0==a&&(a=7),"1"!=c.days.charAt(a-1))?!1:!0};k.prototype.getType=function(){return this._json?this._json.type:null};k.prototype.doActions=function(a){if(this._json)if(this._json.actions&&this._json.actions.length){this._logger.log("trace","do actions");
var c=this;actman.getActionManager().executeActionSingelton("rle:"+this._id,this._json.actions,function(b){c._logger.log("trace","finish do actions "+(b?"failed:"+b.message:"success"));a&&a(b)})}else a&&a();else a&&a(Error("invalid rule"))};k.prototype.onTriggered=function(a,c){this._logger.log("trace","triggered by trigger with index ["+a+"]");this.doActions()};k.prototype.onDeviceEvent=function(a,c,b){if(this._json){var d=this.isActive();b=this.matchTimeRequirement(b);this._logger.log("trace","active:"+
d+" | date match:"+b+" | check device "+a+":"+JSON.stringify(c));if(d&&b){var e=this._json;if(e.trigger&&e.trigger.length){var h=this,p=0,m=[],u=function(b,d){!b&&d&&m.push(p);p++;if(p<e.trigger.length)h._hitDeviceTrigger(p,e.trigger[p],a,c,u);else if(m.length)h.onTriggered(m[0],e.trigger[m[0]]);else h._logger.log("trace","no trigger hit")};this._hitDeviceTrigger(p,e.trigger[p],a,c,u)}}}};k.prototype.onTimerTick=function(a){if(this._json){var c=this.isActive(),b=this.matchTimeRequirement(a);if(c&&
b){var d=this._json;if(d.trigger&&d.trigger.length)for(var e=0;e<d.trigger.length;e++){var h=d.trigger[e];if(this._hitTimeTrigger(h,a)){this._logger.log("trace","active:"+c+" | date match:"+b+" | time trigger hit");this.onTriggered(e,h);break}}}}};k.prototype.toJSON=function(){return this._json};k.prototype._hitDeviceTrigger=function(a,c,b,d,e){a=function(a,c,b){if(!a)return!1;if("event"==c){if(!a.event)return!1;b.sys||(b.sys="mediola");return a.event.sys==b.sys&&"mediola"==b.sys&&a.event.data?a.event.data.type==
b.type&&a.event.data.data==b.data:!1}if("state"==c){if(!(a.state&&a.state.devices&&a.state.devices.length&&a.state.data&&a.state.data.length))return!1;for(c=0;c<a.state.devices.length;c++){var d=a.state.devices[c];if(d){var e=!1;d.id&&d.id==b.id?e=!0:d.device&&d.device.id&&d.device.id==b.sid&&(e=!0);if(e)for(d=0;d<a.state.data.length;d++){var m=a.state.data[d];if(m){var h=m.value;h||(h="state");e=!1;var p=b.changed?-1!=b.changed.indexOf(h):!1;m=m.states;h=b.state?b.state[h]:null;void 0!=h&&null!=
h&&m&&(e=-1!=m.indexOf(h));if(e&&p)return!0}}}}}return!1}(c,b,d);e(null,a)};k.prototype._hitTimeTrigger=function(a,c){if(!a||!a.time)return!1;var b=a.time.split(":");if(2>b.length)return!1;a=parseInt(b[0]);b=parseInt(b[1]);return a==c.hour()&&b==c.minute()};k.parseJSON=function(a,c){if(!a||!c)return null;switch(c.type){case "heatingschedule":a=new f(a);break;case "link":a=new r(a);break;case "alarm":a=new g(a);break;default:a=new k(a)}a._json=c;return a};var r=function(a){k.call(this,a);this._stateBuffer=
null};util.inherits(r,k);r.prototype.onDeviceEvent=function(a,c,b){if(this._json&&(this._logger.log("trace","check link device with "+a+":"+JSON.stringify(c)),this._json.link&&this._json.link.device)){b=this._json.link;var d=b.device;if("state"==a&&c.state&&(a=!1,d.device&&d.device.id&&d.device.id==c.sid&&(a=!0),a)){this._logger.log("trace","match link device");a=!1;d=[];if(b.value){var e=!0;c.changed&&-1==c.changed.indexOf(b.value)&&(e=!1);var h=c.state[b.value];void 0!=h&&null!=h&&e&&(a=!0,this._logger.log("trace",
"match link device state:"+b.value),b.command&&d.push({command:b.command,value:h}))}else if(b.values&&b.values.length)for(var p=0;p<b.values[p];p++){var m=b.values[p];if(!m)return;var f=m.value;f||(f="state");e=!0;c.changed&&-1==c.changed.indexOf(f)&&(e=!1);h=c.state[f];if(void 0!=h&&null!=h&&e){if(m.hyst)if(h=parseFloat(h),e=this._stateBuffer?this._stateBuffer[f]:null,void 0!=e&&null!=e){if(h-e>m.hyst||e-h>m.hyst)a=!0}else a=!0;else m.states?-1!=m.states.indexOf(h)&&(a=!0):a=!0;this._logger.log("trace",
"match link device values("+p+") state:"+f);if(m.ranges&&m.ranges.length)for(h=parseFloat(h),f=0;f<m.ranges.length;f++){var q=m.ranges[f];!q||void 0!=q.to&&null!=q.to&&h>q.to||void 0!=q.from&&null!=q.from&&h<q.from||(e=null,q.command?e=q.command:m.command&&(e=m.command),q=void 0!=q.value&&null!=q.value?q.value:h,void 0!=e&&null!=e&&d.push({command:e,value:q}))}else m.command?d.push({command:m.command,value:h}):d.push({command:h})}}this._stateBuffer=c.state;a&&d.length&&this._doAction(d)}}};r.prototype._doAction=
function(a){if(this._json)if(this._logger.log("trace","forward commands:"+JSON.stringify(a)),this._json.devices&&this._json.devices.length){for(var c=this._json.devices,b=[],d=0;d<c.length;d++){var e=c[d];if(e)for(var h=0;h<a.length;h++){var f=a[h];if(f){var m=JSON.parse(JSON.stringify(e)),g;for(g in f)m[g]=f[g];b.push(m)}}}if(b.length){this._logger.log("trace","do actions");var q=this;actman.getActionManager().executeActionSingelton("rle:"+this._id,b,function(a){q._logger.log("trace","finish do actions "+
(a?"failed:"+a.message:"success"));callback&&callback(a)})}else this._logger.log("trace","no devices")}else this._logger.log("trace","no devices")};var g=function(a){k.call(this,a);this._triggerDelayTimeout=null};util.inherits(g,k);g.prototype.finalize=function(){this._triggerDelayTimeout&&(clearTimeout(this._triggerDelayTimeout),this._triggerDelayTimeout=null)};g.prototype._doDeactivate=function(a){var c=this,b=this._json;this._logger.log("trace","do ondeactivation actions");(function(a){var d=function(a,
b,d){if(b&&b.state&&b.state.ondeactivate&&b.state.devices&&b.state.devices.length)try{var e=[];b.state.devices.forEach(function(a){a=JSON.parse(JSON.stringify(a));for(var c in b.state.ondeactivate)a[c]=b.state.ondeactivate[c];e.push(a)});e.length?actman.getActionManager().executeAction("rle:"+c._id+"@t"+a+"-ondeactivate",e,function(a){d(a)}):d()}catch(v){d(v)}else c._logger.log("trace","trigger("+a+") has no ondeactivate actions"),d()},h=function(a){if(b.trigger&&b.trigger.length){var e=0,h=[],f=
function(m){c._logger.log("trace","do trigger("+e+") ondeactivation actions "+(m?"fail:"+m.message:"success"));m&&h.push(e);e++;e<b.trigger.length?(c._logger.log("trace","do trigger("+e+") ondeactivation actions"),d(e,b.trigger[e],f)):a(h.length?Error("ondeactivation actions failed for triggers ["+h.join(",")+"]"):null)};c._logger.log("trace","do trigger("+e+") ondeactivation actions");d(e,b.trigger[e],f)}else a()};c._logger.log("trace","do main ondeactivation actions");(function(a){b.ondeactivation&&
b.ondeactivation.length?actman.getActionManager().executeAction("rle:"+c._id+"@ondeactivation",b.ondeactivation,function(c){a(c)}):a()})(function(b){c._logger.log("trace","finish main ondeactivation actions "+(b?"fail:"+b.message:"success"));c._logger.log("trace","do triggers ondeactivation actions");h(function(d){c._logger.log("trace","finish triggers ondeactivation actions "+(d?"fail:"+d.message:"success"));var e=null;if(b||d)e=b?"main ondeactivation failed":"",e=Error(e+((e?", ":"")+d?"triggers ondeactivation failed":
""));a(e)})})})(function(b){c._logger.log("trace","finish ondeactivation actions "+(b?"fail:"+b.message:"success"));c._json.active=0;c._logger.log("trace","save rule deactivated");c._ruleManager.onRuleChanged(c._id,function(b){c._logger.log("trace","finish save rule deactivated "+(b?"fail:"+b.message:"success"));a&&a(b?Error("save rule deactivated failed:"+b.message):null)})})};g.prototype._doActivate=function(a){var c=this,b=this._json,d=function(a){var d=function(a,b,d){if(b&&b.state&&b.state.onactivate&&
b.state.devices&&b.state.devices.length)try{var e=[];b.state.devices.forEach(function(a){a=JSON.parse(JSON.stringify(a));for(var c in b.state.onactivate)a[c]=b.state.onactivate[c];e.push(a)});e.length?actman.getActionManager().executeAction("rle:"+c._id+"@t"+a+"-onactivate",e,function(a){d(a)}):d()}catch(w){d(w)}else c._logger.log("trace","trigger("+a+") has no onactivate actions"),d()},e=function(a){if(b.trigger&&b.trigger.length){var e=0,h=[],f=function(g){c._logger.log("trace","do trigger("+e+
") onactivation actions "+(g?"fail:"+g.message:"success"));g&&h.push(e);e++;e<b.trigger.length?(c._logger.log("trace","do trigger("+e+") onactivation actions"),d(e,b.trigger[e],f)):a(h.length?Error("onactivation actions failed for triggers ["+h.join(",")+"]"):null)};c._logger.log("trace","do trigger("+e+") onactivation actions");d(e,b.trigger[e],f)}else a()};c._logger.log("trace","do main onactivation actions");(function(a){b.onactivation&&b.onactivation.length?actman.getActionManager().executeAction("rle:"+
c._id+"@onactivation",b.onactivation,function(c){a(c)}):a()})(function(b){c._logger.log("trace","finish main onactivation actions "+(b?"fail:"+b.message:"success"));c._logger.log("trace","do triggers onactivation actions");e(function(e){c._logger.log("trace","finish triggers onactivation actions "+(e?"fail:"+e.message:"success"));var d=null;if(b||e)d=b?"main onactivation failed":"",d=Error(d+((d?",":"")+e?"triggers onactivation failed":""));a(d)})})},e=function(a){b.onchecksuccess&&b.onchecksuccess.length?
actman.getActionManager().executeAction("rle:"+c._id+"@onchecksuccess",b.onchecksuccess,function(c){a(c)}):a()},h=function(a){b.oncheckfail&&b.oncheckfail.length?actman.getActionManager().executeAction("rle:"+c._id+"@oncheckfail",b.oncheckfail,function(c){a(c)}):a()},f=function(a,c){commandman.commandHandlerV6.getDeviceStatesWithStateInfo(a,c)},g=function(a,b,e,d,h){if(d){var g=b.state.check;b=b.state.data;var k=[],m=!0;g&&g.length?(g.forEach(function(a){a&&a.states&&a.states.length&&(a=JSON.parse(JSON.stringify(a)),
a.value||(a.value="state"),k.push(a))}),m=!0):b&&b.length&&(b.forEach(function(a){a&&a.states&&a.states.length&&(a=JSON.parse(JSON.stringify(a)),a.value||(a.value="state"),k.push(a))}),m=!1);k.length?f(d,function(b,d){if(b)c._logger.log("trace","get trigger("+a+") device("+e+") states fail:"+b.message),h(b);else if(d){for(b=0;b<k.length;b++){var f=d[k[b].value];if(void 0==f||null==f){c._logger.log("trace","check trigger("+a+") device("+e+") state "+k[b].value+" fail: value unknown");h(Error("state value unknown"));
return}c._logger.log("trace","check trigger("+a+") device("+e+") state "+k[b].value+"="+f);var g=!1;m&&-1!=k[b].states.indexOf(f)?g=!0:m||-1!=k[b].states.indexOf(f)||(g=!0);if(!g){h(null,g);return}}h(null,!0)}else c._logger.log("trace","check trigger("+a+") device("+e+") state fail: states response is null"),h(Error("states response is null"))}):(c._logger.log("trace","get trigger("+a+") device("+e+") has no states to check"),h(null,!0))}else c._logger.log("trace","get trigger("+a+") device("+e+") json is null"),
h(null,!0)},k=function(a,b,e){if(b&&b.state&&b.state.devices&&b.state.devices.length){var d=0,h=function(f,k){c._logger.log("trace","check trigger("+a+") device("+d+") "+(f?"fail:"+f.message:"success:match="+k));f||!k?e(f,k):(d++,d<b.state.devices.length?(c._logger.log("trace","check trigger("+a+") device("+d+")"),g(a,b,d,b.state.devices[d],h)):e(null,!0))};c._logger.log("trace","check trigger("+a+") device("+d+")");g(a,b,d,b.state.devices[d],h)}else c._logger.log("trace","trigger("+a+") has no checkable devices"),
e(null,!0)};this._logger.log("trace","check triggers (value="+b.checktriggers+")");(function(a){if(1!=b.checktriggers)a();else if(b.trigger&&b.trigger.length){var d=0,e=function(h,f){c._logger.log("trace","check trigger("+d+") "+(h?"fail:"+h.message:"success:match="+f));h||!f?a(h,f):(d++,d<b.trigger.length?(c._logger.log("trace","check trigger("+d+")"),k(d,b.trigger[d],e)):a(null,!0))};c._logger.log("trace","check trigger("+d+")");k(d,b.trigger[d],e)}else a()})(function(b,f){c._logger.log("trace",
"finish check triggers "+(b?"fail:"+b.message:"success:match="+f));b||!f?(c._logger.log("trace","do oncheckfail actions"),h(function(d){c._logger.log("trace","finish oncheckfail actions "+(d?"fail:"+d.message:"success"));var e="check triggers failed:"+(b?b.message:"device state not match");d&&(e+="; oncheckfail actions failed:"+d.message);a&&a(Error(e))})):(c._logger.log("trace","do onchecksuccess actions"),e(function(b){c._logger.log("trace","finish onchecksuccess actions "+(b?"fail:"+b.message:
"success"));b?a&&a(Error("onchecksuccess actions failed:"+b.message)):(c._logger.log("trace","do onactivation actions"),d(function(b){c._logger.log("trace","finish onactivation actions "+(b?"fail:"+b.message:"success"));c._json.active=1;c._logger.log("trace","save rule activated");c._ruleManager.onRuleChanged(c._id,function(b){c._logger.log("trace","finish save rule activated "+(b?"fail:"+b.message:"success"));a&&a(b?Error("save rule activated failed:"+b.message):null)})}))}))})};g.prototype.onTriggered=
function(a,c){this._triggerDelayTimeout&&(clearTimeout(this._triggerDelayTimeout),this._triggerDelayTimeout=null);var b=this;c.delay?(this._logger.log("trace","triggered by trigger("+a+") with delay "+c.delay),this._triggerDelayTimeout=setTimeout(function(){b._logger.log("trace","do delayed action by trigger("+a+")");b.doActions()},1E3*c.delay)):(this._logger.log("trace","triggered by trigger("+a+") and do actions"),this.doActions())};g.prototype._hitDeviceTrigger=function(a,c,b,d,e){var h=this;k.prototype._hitDeviceTrigger.call(this,
a,c,b,d,function(b,d){b||!d?e(b,d):(c.state&&c.state.ontrigger&&(h._logger.log("trace","do trigger("+a+") ontrigger actions"),actman.getActionManager().executeAction("rle:"+h._id+"@t"+a+"-ontrigger",c.state.ontrigger,function(b){h._logger.log("trace","do trigger("+a+") ontrigger actions "+(b?"fail:"+b.message:"success"))})),e(null,d))})};var f=function(a){k.call(this,a)};util.inherits(f,k);f.prototype.onTriggered=function(a,c){this._logger.log("trace","triggered by periods with index ["+a+"]");a=
JSON.parse(JSON.stringify(c));a.command||(a.command="temperature");if((c=this._json)&&c.devices&&0<c.devices.length){for(var b=[],d=0;d<c.devices.length;d++){var e=c.devices[d];e&&b.push({device:e,command:a})}this._logger.log("trace","do actions");actman.getActionManager().executeActionSingelton("rle:"+this._id,b,function(a){callback&&callback(a)})}};f.prototype.onTimerTick=function(a){if(this._json){var c=this.isActive(),b=this.matchTimeRequirement(a);if(c&&b){var d=this._json;if(d.periods&&0!=d.periods.length)for(var e=
0;e<d.periods.length;e++){var f=d.periods[e];if(this._hitPeriodTrigger(f,a)){this._logger.log("trace","active:"+c+" | date match:"+b+" | time trigger hit");this.onTriggered(e,f);break}}}}};f.prototype.onDeviceEvent=function(a,c,b){};f.prototype._hitPeriodTrigger=function(a,c){if(!a||!a.start)return!1;var b=a.start.split(":");if(2>b.length)return!1;a=parseInt(b[0]);b=parseInt(b[1]);return a==c.hour()&&b==c.minute()};var n=function(){this._logger=require("x.logger.js").getLogger("x.hub.rule.RuleManager");
this._cronTimer=this._rules=this._dataFolder=null;this._writing=!1;this._writeCallbacks=[]};n.FILE_NAME="rule.json";n.prototype.init=function(a,c){this._logger.log("info","init rule manager");this._dataFolder=a.getUserRootDataPath();this._cronTimer=new l(this);var b=this;this._loadRules(function(a){a?c&&c(a):b._initRules(function(){c&&c()})})};n.prototype.getRules=function(){return this._rules};n.prototype.getRule=function(a){return this._rules?this._rules[a]:null};n.prototype.setRule=function(a,
c,b){if(a){var d=this._rules[a];if(c){this._logger.log("trace","update rule "+a);var e=k.parseJSON(a,c);if(!e){b&&b(Error("invalid rule json"));return}e._ruleManager=this;this._rules[a]=e}else this._logger.log("trace","delete rule "+a),delete this._rules[a];d&&(this._logger.log("trace","call finialize of old rule "+a),d.finalize());this._writeRules(function(a){b&&b(a,c)})}else b&&b(Error("invalid rule id"))};n.prototype.onRuleChanged=function(a,c){this._writeRules(function(a){c&&c(a)})};n.prototype.onTimerTick=
function(a){if(this._rules)for(var c in this._rules){var b=this._rules[c];if(b)b.onTimerTick(a)}};n.prototype.onLocationChange=function(a){this._logger.log("trace","receive location change event:"+JSON.stringify(a));this._cronTimer.onLocationChange(a)};n.prototype.onTimeChange=function(a){this._logger.log("trace","receive time change event:"+JSON.stringify(a));this._cronTimer.onTimeChange(a)};n.prototype.onDeviceEvent=function(a,c){this._logger.log("trace","receive "+a+" event:"+JSON.stringify(c));
var b=t.getMomentNow(),d;for(d in this._rules){var e=this._rules[d];if(e)e.onDeviceEvent(a,c,b)}};n.prototype._initRules=function(a){this._cronTimer.start();a()};n.prototype._loadRules=function(a){var c=require("fs-extra"),b=this._getFile(),d=this;c.ensureFile(b,function(b){b?a(b):d._loadFile(function(b,c){if(b)a(b);else{d._rules={};if(c)for(var e in c)if(b=k.parseJSON(e,c[e]))b._ruleManager=d,d._rules[e]=b;a()}})})};n.prototype._writeRules=function(a){a&&-1==this._writeCallbacks.indexOf(a)&&this._writeCallbacks.push(a);
if(!this._writing&&this._writeCallbacks.length){this._writing=!0;var c=this._writeCallbacks;this._writeCallbacks=[];a={};for(var b in this._rules){var d=this._rules[b];d&&d.toJSON&&(a[b]=d.toJSON())}var e=this;this._writeFile(a,function(a){e._writing=!1;c.forEach(function(b){try{b&&b(a)}catch(m){}});e._writeRules()})}};n.prototype._getFile=function(){return require("path").resolve(this._dataFolder,n.FILE_NAME)};n.prototype._loadFile=function(a){var c=require("fs"),b=this._getFile();c.readFile(b,"utf8",
function(b,c){if(b)a(b);else if(c)try{var d=JSON.parse(c);a(null,d)}catch(p){a(null,{})}else a(null,{})})};n.prototype._writeFile=function(a,c){var b=require("fs"),d=this._getFile();b.writeFile(d,JSON.stringify(a,null,2),function(a){c&&c(a)})};return n}();
x.hub.rule.Handler=function(){var t=function(){this._logger=require("x.logger.js").getLogger("x.hub.rule.Handler");this._ruleManager=new x.hub.rule.RuleManager};t.prototype.init=function(l,k,r){var g=this;eventbus.on("locationchange",this._onLocationChange.bind(this));eventbus.on("timechange",this._onTimeChange.bind(this));eventbus.on("gatewayevent",function(f,k,a){g._onGatewayEvent(f,k,a)});"CA"==global.HARDWARE_VERSION?this._initHttpApiNew(l):this._initHttpApi(l);this._ruleManager.init(k,function(f){f&&
r(f)})};t.prototype.getRuleManager=function(){return this._ruleManager};t.prototype._onLocationChange=function(l){this._logger.log("trace","receive location change event:"+JSON.stringify(l));this._ruleManager.onLocationChange(l)};t.prototype._onTimeChange=function(l){this._logger.log("trace","receive time change event:"+JSON.stringify(l));this._ruleManager.onTimeChange(l)};t.prototype._onGatewayEvent=function(l,k,r){this._logger.log("trace","receive gateway "+r+" event:"+JSON.stringify(l)+" from:"+
JSON.stringify(k));if(k&&"ST"==k.address){var g="STA"==r?"state":"event";if(l){var f=this;process.nextTick(function(){f._ruleManager.onDeviceEvent(g,l)})}}};t.prototype._initHttpApiNew=function(l){var k=this;l=require("x.hub.js").getServer();l.addRoute("/api/rules",{method:"GET"},function(l,g,f){l=k._ruleManager.getRules();g.json({XC_SUC:l?l:{}})});l.addRoute("/data/rle/",{method:"GET"},function(l,g,f){l=l.path.substr(10);(l=k._ruleManager.getRule(l))?g.json({XC_SUC:l}):g.json({XC_ERR:{code:"000101",
msg:"failed to open file"}})});l.addRoute("/data/rle/",{method:"POST"},function(l,g){var f=l.path.substr(10);try{k._ruleManager.setRule(f,l.json,function(f,a){f?g.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+f.message}}):a?g.json({XC_SUC:{bytes:l.size}}):g.json({XC_SUC:{bytes:0}})})}catch(n){g.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+n.message}})}});l.addRoute("/api/trigger",{method:"POST"},function(l,g){try{var f=l.json;f&&"time"==f.type&&f.value?(g.json({XC_SUC:{}}),process.nextTick(function(){var g=
require("moment-timezone"),a=taskman.Util._getTimeZone(),c=parseInt(f.value.split(":")[0]),b=parseInt(f.value.split(":")[1]),d=new Date;d.setHours(c);d.setMinutes(b);d=g.tz(d.getTime(),a);k._ruleManager.onTimerTick(d)})):f&&"event"==f.type&&f.value?(g.json({XC_SUC:{}}),process.nextTick(function(){k._ruleManager.onDeviceEvent(f.type,f.value)})):g.json({XC_ERR:{code:"000101",msg:"unknown trigger type"}})}catch(n){g.json({XC_ERR:{code:"000101",msg:"failed to trigger:"+n.message}})}})};t.prototype._initHttpApi=
function(l){var k=this,r=require("x.hub.js").getServer();l.get("/api/rules",function(g,f,l){r.auth(g)?(g=k._ruleManager.getRules(),f.json({XC_SUC:g?g:{}})):f.json({XC_ERR:{code:"000007",msg:"access denied"}})});l.get("/data/rle/:id",function(g,f,l){r.auth(g)?(g=k._ruleManager.getRule(g.params.id))?f.json({XC_SUC:g}):f.json({XC_ERR:{code:"000101",msg:"failed to open file"}}):f.json({XC_ERR:{code:"000007",msg:"access denied"}})});l.post("/data/rle/:id",function(g,f){if(r.auth(g)){var l=new Buffer(0);
g.on("data",function(a){l=Buffer.concat([l,a])});g.on("end",function(){var a=g.params.id,c=l.toString("utf8");try{var b=null;c&&(b=JSON.parse(c));k._ruleManager.setRule(a,b,function(a,b){a?f.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+a.message}}):b?f.json({XC_SUC:{bytes:l.length}}):f.json({XC_SUC:{bytes:0}})})}catch(d){f.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+d.message}})}})}else f.json({XC_ERR:{code:"000007",msg:"access denied"}})});l.post("/api/trigger",function(g,f){if(r.auth(g)){var l=
new Buffer(0);g.on("data",function(a){l=Buffer.concat([l,a])});g.on("end",function(){var a=l.toString("utf8");try{var c=null;a&&(c=JSON.parse(a));if(c&&"time"==c.type&&c.value){var b=require("moment-timezone"),d=taskman.Util._getTimeZone(),e=parseInt(c.value.split(":")[0]),h=parseInt(c.value.split(":")[1]),g=new Date;g.setHours(e);g.setMinutes(h);g=b.tz(g.getTime(),d);k._ruleManager.onTimerTick(g);f.json({XC_SUC:{}})}else f.json({XC_ERR:{code:"000101",msg:"unknown trigger type"}})}catch(m){f.json({XC_ERR:{code:"000101",
msg:"failed to trigger:"+m.message}})}})}else f.json({XC_ERR:{code:"000007",msg:"access denied"}})})};return t}();module.exports=new x.hub.rule.Handler;
