var util=require("util"),taskman=require("x.hub.taskman.js"),commandman=require("x.hub.commandman.js"),x=x||{};x.hub=x.hub||{};x.hub.rule=x.hub.rule||{};
x.hub.rule.RuleManager=function(){var g=function(a){this._logger=require("x.logger.js").getLogger("x.hub.rule.RuleManager.CronTimer");this._ruleManager=a;this._cronJob=null};g.prototype.start=function(){var a=taskman.Util._getTimeZone();this._logger.log("trace","start cron job:00 * * * * * tz:"+a);this._cronJob=new (require("cron").CronJob)("00 * * * * *",this.onTick.bind(this),null,!0,a)};g.prototype.stop=function(){this._logger.log("debug","stop timer:"+JSON.stringify(this.timer));this._cronJob&&
(this._cronJob.stop(),this._cronJob=null)};g.prototype.onTick=function(){this._logger.log("trace","timer tick");var a=require("moment-timezone"),b=taskman.Util._getTimeZone(),c=(new Date).getTime();c=a.tz(c,b);this._ruleManager.onTimerTick(c)};g.prototype.onLocationChange=function(){this.stop();this.start()};g.prototype.onTimeChange=function(){this.stop();this.start()};var f=function(a,b){this._id=a;this._actionPool=b;this._state=0;this._actions=[]};f.prototype.run=function(){var a=0,b=this;this._state=
1;var c=function(){a++;1==b._state&&(a==b._actions.length?(b._state=3,b._actionPool._onActionFinish(b._id)):b._do(a,c))};this._do(a,c)};f.prototype.cancel=function(){1==this._state&&(this._state=2)};f.prototype._do=function(a,b){(a=this._actions[a])&&a.device&&a.command?commandman.commandHandlerV6.executeCommand(a.device,a.command,function(a){b(a)}):b()};var l=function(){this._pool={}};l.prototype.runAction=function(a,b){this._pool[a]&&this.cancelAction(a);var c=new f(a,this);c._actions=b;this._pool[a]=
c;c.run()};l.prototype.cancelAction=function(a){var b=this._pool[a];b&&(delete this._pool[a],b.cancel())};l.prototype._onActionFinish=function(a){delete this._pool[a]};var h=function(a){this._id=a;this._ruleManager=this._json=null};h.prototype.isActive=function(){return this._json&&1==this._json.active};h.prototype.getType=function(){return this._json?this._json.type:null};h.prototype.toJSON=function(){return this._json};h.parseJSON=function(a,b){if(!a||!b)return null;switch(b.type){case "heatingschedule":a=
new e(a);break;default:a=new h(a)}a._json=b;return a};var e=function(a){h.call(this,a)};util.inherits(e,h);e.prototype._doAction=function(a){a=JSON.parse(JSON.stringify(a));a.command||(a.command="temperature");var b=this._json;if(b&&b.devices&&0<b.devices.length){for(var c=[],d=0;d<b.devices.length;d++){var k=b.devices[d];k&&c.push({device:k,command:a})}this._ruleManager._actionPool.runAction(this._id,c)}};e.prototype.onTimerTick=function(a){var b=this._json;if(b.periods&&0!=b.periods.length){var c=
require("moment-timezone"),d=taskman.Util._getTimeZone(),k=a.valueOf();if(b.start&&"0000-00-00"!=b.start){var e=c.tz(b.start,d);e.set({hour:0,minute:0,second:0,millisecond:0});if(e.valueOf()>k)return}if(b.end&&"0000-00-00"!=b.end&&(c=c.tz(b.end,d),c.set({hour:23,minute:59,second:59,millisecond:999}),c.valueOf()<k)||b.days&&(k=a.day(),0==k&&(k=7),"1"!=b.days.charAt(k-1)))return;for(k=0;k<b.periods.length;k++)(c=b.periods[k])&&c.start&&(e=c.start.split(":"),2<=e.length&&(d=parseInt(e[0]),e=parseInt(e[1]),
d==a.hour()&&e==a.minute()&&this._doAction(c)))}};var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.rule.RuleManager");this._actionPool=this._cronTimer=this._rules=this._dataFolder=null};d.FILE_NAME="rule.json";d.prototype.init=function(a,b){this._logger.log("info","init rule manager");this._dataFolder=a.getUserRootDataPath();this._cronTimer=new g(this);this._actionPool=new l(this);var c=this;this._loadRules(function(a){a?b&&b(a):c._initRules(function(){b&&b()})})};d.prototype.getRules=
function(){return this._rules};d.prototype.getRule=function(a){return this._rules?this._rules[a]:null};d.prototype.setRule=function(a,b,c){if(a){if(b){var d=h.parseJSON(a,b);if(!d){c&&c(Error("invalid rule json"));return}d._ruleManager=this;this._rules[a]=d}else delete this._rules[a];this._writeRules(function(a){c&&c(a,b)})}else c&&c(Error("invalid rule id"))};d.prototype.onTimerTick=function(a){if(this._rules)for(var b in this._rules){var c=this._rules[b];if(c&&c.isActive()&&"heatingschedule"==c.getType())c.onTimerTick(a)}};
d.prototype.onLocationChange=function(a){this._logger.log("trace","receive location change event:"+JSON.stringify(a));this._cronTimer.onLocationChange(a)};d.prototype.onTimeChange=function(a){this._logger.log("trace","receive time change event:"+JSON.stringify(a));this._cronTimer.onTimeChange(a)};d.prototype._initRules=function(a){this._cronTimer.start();a()};d.prototype._loadRules=function(a){var b=require("fs-extra"),c=this._getFile(),d=this;b.ensureFile(c,function(b){b?a(b):d._loadFile(function(b,
c){if(b)a(b);else{d._rules={};if(c)for(var e in c)if(b=h.parseJSON(e,c[e]))b._ruleManager=d,d._rules[e]=b;a()}})})};d.prototype._writeRules=function(a){var b={},c;for(c in this._rules){var d=this._rules[c];d&&d.toJSON&&(b[c]=d.toJSON())}this._writeFile(b,function(b){a(b)})};d.prototype._getFile=function(){return require("path").resolve(this._dataFolder,d.FILE_NAME)};d.prototype._loadFile=function(a){var b=require("fs"),c=this._getFile();b.readFile(c,"utf8",function(b,c){if(b)a(b);else if(c)try{var d=
JSON.parse(c);a(null,d)}catch(p){a(null,{})}else a(null,{})})};d.prototype._writeFile=function(a,b){var c=require("fs"),d=this._getFile();c.writeFile(d,JSON.stringify(a,null,2),function(a){b&&b(a)})};return d}();
x.hub.rule.Handler=function(){var g=function(){this._logger=require("x.logger.js").getLogger("x.hub.rule.Handler");this._ruleManager=new x.hub.rule.RuleManager};g.prototype.init=function(f,g,h){var e=require("x.hub.eventbus.js");e.on("locationchange",this._onLocationChange.bind(this));e.on("timechange",this._onTimeChange.bind(this));this._initHttpApi(f);this._ruleManager.init(g,function(d){d&&h(d)})};g.prototype._onLocationChange=function(f){this._logger.log("trace","receive location change event:"+
JSON.stringify(f));this._ruleManager.onLocationChange(f)};g.prototype._onTimeChange=function(f){this._logger.log("trace","receive time change event:"+JSON.stringify(f));this._ruleManager.onTimeChange(f)};g.prototype._initHttpApi=function(f){var g=this,h=require("x.hub.js").getServer();f.get("/api/rules",function(e,d,a){h.auth(e)?(e=g._ruleManager.getRules(),d.json({XC_SUC:e?e:{}})):d.json({XC_ERR:{code:"000007",msg:"access denied"}})});f.get("/data/rle/:id",function(e,d,a){h.auth(e)?(e=g._ruleManager.getRule(e.params.id))?
d.json({XC_SUC:e}):d.json({XC_ERR:{code:"000101",msg:"failed to open file"}}):d.json({XC_ERR:{code:"000007",msg:"access denied"}})});f.post("/data/rle/:id",function(e,d){if(h.auth(e)){var a=new Buffer(0);e.on("data",function(b){a=Buffer.concat([a,b])});e.on("end",function(){var b=e.params.id,c=a.toString("utf8");try{var f=null;c&&(f=JSON.parse(c));g._ruleManager.setRule(b,f,function(b,c){b?d.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+b.message}}):c?d.json({XC_SUC:{bytes:a.length}}):d.json({XC_SUC:{bytes:0}})})}catch(k){d.json({XC_ERR:{code:"000101",
msg:"failed to set rule:"+k.message}})}})}else d.json({XC_ERR:{code:"000007",msg:"access denied"}})});f.post("/api/trigger",function(e,d){if(h.auth(e)){var a=new Buffer(0);e.on("data",function(b){a=Buffer.concat([a,b])});e.on("end",function(){var b=a.toString("utf8");try{var c=null;b&&(c=JSON.parse(b));if(c&&"time"==c.type&&c.value){var e=require("moment-timezone"),f=taskman.Util._getTimeZone(),h=parseInt(c.value.split(":")[0]),l=parseInt(c.value.split(":")[1]),m=new Date;m.setHours(h);m.setMinutes(l);
m=e.tz(m.getTime(),f);g._ruleManager.onTimerTick(m);d.json({XC_SUC:{}})}else d.json({XC_ERR:{code:"000101",msg:"unknown trigger type"}})}catch(n){d.json({XC_ERR:{code:"000101",msg:"failed to trigger:"+n.message}})}})}else d.json({XC_ERR:{code:"000007",msg:"access denied"}})})};return g}();module.exports=new x.hub.rule.Handler;
