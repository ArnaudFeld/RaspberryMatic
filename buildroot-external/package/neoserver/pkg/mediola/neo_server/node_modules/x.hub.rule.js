var util=require("util"),taskman=require("x.hub.taskman.js"),actman=require("x.hub.action.js"),commandman=require("x.hub.commandman.js"),eventbus=require("x.hub.eventbus.js"),moment=require("moment-timezone"),x=x||{};x.hub=x.hub||{};x.hub.rule=x.hub.rule||{};
x.hub.rule.RuleManager=function(){var D={getMomentNow:function(){var a=taskman.Util._getTimeZone(),b=(new Date).getTime();a=moment.tz(b,a);a.second(0);a.millisecond(0);return a},getAstro:function(a){var b=taskman.Util._getlatlong(),c=require("suncalc"),d=c.getTimes(a.toDate(),b.lat,b.long),e=taskman.Util._getTimeZone(),f=moment.tz(d.sunrise,e);d=moment.tz(d.sunset,e);if(f.date()!=a.date()||d.date()!=a.date())a.add(12,"h"),d=c.getTimes(a.toDate(),b.lat,b.long),f=moment.tz(d.sunrise,e),d=moment.tz(d.sunset,
e);f.second(0);f.millisecond(0);d.second(0);d.millisecond(0);return[f,d]},matchDate:function(a,b){if(!a)throw Error("invalid momentNow argument");if(!b)return!0;var c=a.tz(),d=a.valueOf();if(b.start&&"0000-00-00"!=b.start){var e=moment.tz(b.start,c);e.set({hour:0,minute:0,second:0,millisecond:0});if(e.valueOf()>d)return!1}return b.end&&"0000-00-00"!=b.end&&(c=moment.tz(b.end,c),c.set({hour:23,minute:59,second:59,millisecond:999}),c.valueOf()<d)||b.days&&(a=a.day(),0==a&&(a=7),"1"!=b.days.charAt(a-
1))?!1:!0},calculateAstroTarget:function(a,b,c,d){if(!(a&&b&&c&&d))return null;var e=null;if("sunrise"==d.substr(0,7)){if(e=b,"+"==d.charAt(7)||"-"==d.charAt(7))b=parseInt(d.substr(7)),e.add(b,"minutes")}else"sunset"==d.substr(0,6)&&(e=c,"+"==d.charAt(6)||"-"==d.charAt(6))&&(b=parseInt(d.substr(6)),e.add(b,"minutes"));if(!e)return null;b=moment(a);b.hour(0);b.minute(0);b.second(0);b.millisecond(0);a=moment(a);a.hour(23);a.minute(59);a.second(59);a.millisecond(999);e.isBefore(b)?e=b:e.isAfter(a)&&
(e=a);return e},calculateTimeTarget:function(a,b){if(!a||!b)return null;var c=b.split(":");if(2!=c.length)return null;b=parseInt(c[0]);c=parseInt(c[1]);if(isNaN(b)||isNaN(c)||0>b||23<b||0>c||59<c)return null;a=moment(a);a.hour(b);a.minute(c);a.second(0);a.millisecond(0);return a}},w=function(a){this._logger=require("x.logger.js").getLogger("x.hub.rule.RuleManager.CronTimer");this._ruleManager=a;this._cronJob=null};w.prototype.start=function(){var a=taskman.Util._getTimeZone();this._logger.log("trace",
"start cron job:00 * * * * * tz:"+a);this._cronJob=new (require("cron").CronJob)("00 * * * * *",this.onTick.bind(this),null,!0,a)};w.prototype.stop=function(){this._logger.log("debug","stop timer:"+JSON.stringify(this.timer));this._cronJob&&(this._cronJob.stop(),this._cronJob=null)};w.prototype.onTick=function(){this._logger.log("trace","timer tick");var a=D.getMomentNow(),b=D.getAstro(a);this._ruleManager.onTimerTick(a,b[0],b[1])};w.prototype.onLocationChange=function(){this.stop();this.start()};
w.prototype.onTimeChange=function(){this.stop();this.start()};var p=function(a){this._logger=require("x.logger.js").getLogger("x.hub.rule.RuleManager.Rule.#"+a);this._id=a;this._ruleManager=this._json=null;this._state=0;this._activateCallbacks=[];this._pendingTriggers={};this._delayedTriggers=[]};p.prototype.finalize=function(){for(var a in this._pendingTriggers){var b=this._pendingTriggers[a];b&&clearTimeout(b)}for(a=0;a<this._delayedTriggers.length;a++)(b=this._delayedTriggers[a])&&b.timeout&&clearTimeout(b.timeout);
this._pendingTriggers={};this._delayedTriggers=[]};p.prototype.executeCommand=function(a,b){a&&a.command?"activate"==a.command?this.setActive(!0,function(c){b&&b(c)}):"deactivate"==a.command?this.setActive(!1,function(c){b&&b(c)}):"execute"==a.command?this.doActions(function(c){b&&b(c)}):b&&b(Error("invalid command")):b&&b(Error("invalid command"))};p.prototype.getStates=function(a){a&&a(null,{active:this.isActive()})};p.prototype.isActive=function(){return this._json&&1==this._json.active};p.prototype.setActive=
function(a,b){if(this._json){var c=this.isActive();if(c&&a||!c&&!a)b&&b();else if(1!=this._state||a)if(2==this._state&&a)b&&b(Error("deactivate process is rinning"));else{if(b&&-1==this._activateCallbacks.indexOf(b)&&this._activateCallbacks.push(b),0==this._state){var d=this;this._state=a?1:2;this[a?"_doActivate":"_doDeactivate"](function(e){d._state=0;var f=d._activateCallbacks;d._activateCallbacks=[];f.forEach(function(h){try{h&&h(e)}catch(g){}})})}}else b&&b(Error("activate process is rinning"))}else b&&
b(Error("invalid rule"))};p.prototype._doActivate=function(a){this._json.active=1;this._ruleManager.onRuleChanged(this._id,function(b){a&&a(b)})};p.prototype._doDeactivate=function(a){this._json.active=0;this._ruleManager.onRuleChanged(this._id,function(b){a&&a(b)})};p.prototype.matchTimeRequirement=function(a){return this._json?D.matchDate(a,this._json):!1};p.prototype.getType=function(){return this._json?this._json.type:null};p.prototype.doActions=function(a){if(this._json)if(this._json.actions&&
this._json.actions.length){this._logger.log("trace","do actions");var b=this,c=actman.getActionManager(),d="executeAction";1==this._json.restart&&(d="executeActionSingelton");c[d]("rle:"+this._id,this._json.actions,function(e){b._logger.log("trace","finish do actions "+(e?"failed:"+e.message:"success"));a&&a(e)})}else a&&a();else a&&a(Error("invalid rule"))};p.prototype.onTriggered=function(a,b){this._logger.log("trace","triggered by trigger with index ["+a+"]");this.doActions()};p.prototype.onDeviceEvent=
function(a,b){if(this._json){var c=this.isActive();b=this.matchTimeRequirement(b);this._logger.log("trace","active:"+c+" | date match:"+b+" | check device event:"+JSON.stringify(a));if(c&&b){var d=this._json;if(d.trigger&&d.trigger.length){var e=this,f=0,h=[],g=function(n,k,l){!n&&k?d.trigger[f].delay?e._addDelayedTrigger(f):d.trigger[f].dur?e._addPendingTrigger(f):h.push(f):n||k||!l||d.trigger[f].dur&&e._removePendingTrigger(f);f++;if(f<d.trigger.length)e._hitDeviceTrigger(f,d.trigger[f],a,g);else if(h.length)e.onTriggered(h[0],
d.trigger[h[0]]);else e._logger.log("trace","no trigger hit")};this._hitDeviceTrigger(f,d.trigger[f],a,g)}}}};p.prototype._addDelayedTrigger=function(a){var b=this._json.trigger[a],c=this,d={triggerIdx:a,timeout:setTimeout(function(){var e=c._delayedTriggers.indexOf(d);-1!=e&&c._delayedTriggers.splice(e,1);c.onTriggered(d.triggerIdx,b)},1E3*parseFloat(b.delay))};this._delayedTriggers.push(d)};p.prototype._addPendingTrigger=function(a){var b=this._json.trigger[a];if(!this._pendingTriggers[a]){var c=
this;this._pendingTriggers[a]=setTimeout(function(){delete c._pendingTriggers[a];c.onTriggered(a,b)},1E3*parseFloat(b.dur))}};p.prototype._removePendingTrigger=function(a){if(this._pendingTriggers[a]){var b=this._pendingTriggers[a];b&&clearTimeout(b);delete this._pendingTriggers[a]}};p.prototype.onTimerTick=function(a,b,c){if(this._json){var d=this.isActive(),e=this.matchTimeRequirement(a);if(d&&e){var f=this._json;if(f.trigger&&f.trigger.length)for(var h=0;h<f.trigger.length;h++){var g=f.trigger[h];
if(this._hitTimeTrigger(g,a,b,c)){this._logger.log("trace","active:"+d+" | date match:"+e+" | time trigger hit");this.onTriggered(h,g);break}}}}};p.prototype.toJSON=function(){return this._json};p.prototype._hitDeviceTrigger=function(a,b,c,d){var e=!1;a=function(f,h){if(!f)return!1;var g=h.type,n=h.value;if("event"==g){if(!f.event)return!1;n.sys||(n.sys="mediola");return f.event.sys==n.sys&&"mediola"==n.sys&&f.event.data?f.event.data.type==n.type&&f.event.data.data==n.data:!1}if("state"==g){if(!(f.state&&
f.state.devices&&f.state.devices.length&&f.state.data&&f.state.data.length))return!1;g={};for(var k in n.state)n.changed&&-1!=n.changed.indexOf(k)&&(g[k]=n.state[k]);for(n=0;n<f.state.devices.length;n++)if(g=f.state.devices[n])if(g=commandman.commandHandlerV6.resolveDeviceStates(g,h))for(e=!0,k=0;k<f.state.data.length;k++){var l=f.state.data[k];if(l&&commandman.commandHandlerV6.matchDeviceState(g,l))return!0}}return!1}(b,c);d(null,a,e)};p.prototype._hitTimeTrigger=function(a,b,c,d){if(!a)return!1;
if(a.time){if(!b)return!1;var e=a.time.split(":");if(2>e.length)return!1;c=parseInt(e[0]);e=parseInt(e[1]);return c==b.hour()&&e==b.minute()}if(a.astro){if(!c||!d)return!1;d=D.calculateAstroTarget(b,c,d,a.astro);if(!d)return!1;var f=null,h=null;a.earliest&&(e=a.earliest.split(":"),2<=e.length&&(c=parseInt(e[0]),e=parseInt(e[1]),f=moment(b),f.hour(parseInt(c)),f.minute(parseInt(e)),f.second(0),f.millisecond(0)));a.latest&&(e=a.latest.split(":"),2<=e.length&&(c=parseInt(e[0]),e=parseInt(e[1]),h=moment(b),
h.hour(parseInt(c)),h.minute(parseInt(e)),h.second(0),h.millisecond(0)));if(f&&h&&f.isAfter(h))return!1;f&&d.isBefore(f)&&(d=f);h&&d.isAfter(h)&&(d=h);return d.hour()==b.hour()&&d.minute()==b.minute()}return!1};p.parseJSON=function(a,b){if(!a||!b)return null;switch(b.type){case "heatingschedule":a=new m(a);break;case "link":a=new y(a);break;case "alarm":a=new q(a);break;default:a=new p(a)}a._json=b;return a};var y=function(a){p.call(this,a);this._stateBuffer=null};util.inherits(y,p);y.prototype.onDeviceEvent=
function(a,b){if(this._json){var c=a.type;a=a.value;this._logger.log("trace","check link device with "+c+":"+JSON.stringify(a));if(this._json.link&&this._json.link.device){b=this._json.link;var d=b.device;if("state"==c&&a.state&&(c=!1,d.device&&d.device.id&&d.device.id==a.sid&&(c=!0),c)){this._logger.log("trace","match link device");c=!1;d=[];if(b.value){var e=!0;a.changed&&-1==a.changed.indexOf(b.value)&&(e=!1);var f=a.state[b.value];void 0!=f&&null!=f&&e&&(c=!0,this._logger.log("trace","match link device state:"+
b.value),b.command&&d.push({command:b.command,value:f}))}else if(b.values&&b.values.length)for(var h=0;h<b.values.length;h++){var g=b.values[h];if(!g)return;var n=g.value;n||(n="state");e=!0;a.changed&&-1==a.changed.indexOf(n)&&(e=!1);f=a.state[n];if(void 0!=f&&null!=f&&e){if(g.hyst)if(f=parseFloat(f),e=this._stateBuffer?this._stateBuffer[n]:null,void 0!=e&&null!=e){if(f-e>g.hyst||e-f>g.hyst)c=!0}else c=!0;else g.states?(1==f||"true"==f?c=-1!=g.states.indexOf(!0)||-1!=g.states.indexOf("true"):0==
f||"false"==f?c=-1!=g.states.indexOf(!1)||-1!=g.states.indexOf("false"):-1!=g.states.indexOf(f)&&(c=!0),f=null):c=!0;this._logger.log("trace","match link device values("+h+") state:"+n);if(g.ranges&&g.ranges.length)for(f=parseFloat(f),e=0;e<g.ranges.length;e++){var k=g.ranges[e];if(k&&!(void 0!=k.to&&null!=k.to&&f>k.to||void 0!=k.from&&null!=k.from&&f<k.from)){var l=null;k.command?l=k.command:g.command&&(l=g.command);k=void 0!=k.value&&null!=k.value?k.value:f;void 0!=l&&null!=l&&d.push({command:l,
value:k,source:n})}}else g.command?d.push({command:g.command,value:f,source:n}):d.push({command:f,source:n})}}this._stateBuffer=a.state;c&&d.length&&this._doAction(d)}}}};y.prototype._doAction=function(a){if(this._json)if(this._logger.log("trace","forward commands:"+JSON.stringify(a)),this._json.devices&&this._json.devices.length){for(var b=this._json.devices,c=[],d=0;d<b.length;d++){var e=b[d];if(e)for(var f=0;f<a.length;f++){var h=a[f];if(h){var g=JSON.parse(JSON.stringify(e)),n;for(n in h)g[n]=
h[n];c.push(g)}}}if(c.length){this._logger.log("trace","do actions");var k=this;actman.getActionManager().executeActionSingelton("rle:"+this._id,c,function(l){k._logger.log("trace","finish do actions "+(l?"failed:"+l.message:"success"));callback&&callback(l)})}else this._logger.log("trace","no devices")}else this._logger.log("trace","no devices")};var q=function(a){p.call(this,a);this._triggerDelayTimeout=null};util.inherits(q,p);q.prototype.finalize=function(){this._triggerDelayTimeout&&(clearTimeout(this._triggerDelayTimeout),
this._triggerDelayTimeout=null)};q.prototype._doDeactivate=function(a){var b=this,c=this._json;this._logger.log("trace","do ondeactivation actions");(function(d){var e=function(h,g,n){if(g&&g.state&&g.state.ondeactivate&&g.state.devices&&g.state.devices.length)try{var k=[];g.state.devices.forEach(function(l){l=JSON.parse(JSON.stringify(l));for(var z in g.state.ondeactivate)l[z]=g.state.ondeactivate[z];k.push(l)});k.length?actman.getActionManager().executeAction("rle:"+b._id+"@t"+h+"-ondeactivate",
k,function(l){n(l)}):n()}catch(l){n(l)}else b._logger.log("trace","trigger("+h+") has no ondeactivate actions"),n()},f=function(h){if(c.trigger&&c.trigger.length){var g=0,n=[],k=function(l){b._logger.log("trace","do trigger("+g+") ondeactivation actions "+(l?"fail:"+l.message:"success"));l&&n.push(g);g++;g<c.trigger.length?(b._logger.log("trace","do trigger("+g+") ondeactivation actions"),e(g,c.trigger[g],k)):h(n.length?Error("ondeactivation actions failed for triggers ["+n.join(",")+"]"):null)};
b._logger.log("trace","do trigger("+g+") ondeactivation actions");e(g,c.trigger[g],k)}else h()};b._logger.log("trace","do main ondeactivation actions");(function(h){c.ondeactivation&&c.ondeactivation.length?actman.getActionManager().executeAction("rle:"+b._id+"@ondeactivation",c.ondeactivation,function(g){h(g)}):h()})(function(h){b._logger.log("trace","finish main ondeactivation actions "+(h?"fail:"+h.message:"success"));b._logger.log("trace","do triggers ondeactivation actions");f(function(g){b._logger.log("trace",
"finish triggers ondeactivation actions "+(g?"fail:"+g.message:"success"));var n=null;if(h||g)n=h?"main ondeactivation failed":"",n=Error(n+((n?", ":"")+g?"triggers ondeactivation failed":""));d(n)})})})(function(d){b._logger.log("trace","finish ondeactivation actions "+(d?"fail:"+d.message:"success"));b._json.active=0;b._logger.log("trace","save rule deactivated");b._ruleManager.onRuleChanged(b._id,function(e){b._logger.log("trace","finish save rule deactivated "+(e?"fail:"+e.message:"success"));
a&&a(e?Error("save rule deactivated failed:"+e.message):null)})})};q.prototype._doActivate=function(a){var b=this,c=this._json,d=function(k){var l=function(u,r,A){if(r&&r.state&&r.state.onactivate&&r.state.devices&&r.state.devices.length)try{var B=[];r.state.devices.forEach(function(C){C=JSON.parse(JSON.stringify(C));for(var v in r.state.onactivate)C[v]=r.state.onactivate[v];B.push(C)});B.length?actman.getActionManager().executeAction("rle:"+b._id+"@t"+u+"-onactivate",B,function(C){A(C)}):A()}catch(C){A(C)}else b._logger.log("trace",
"trigger("+u+") has no onactivate actions"),A()},z=function(u){if(c.trigger&&c.trigger.length){var r=0,A=[],B=function(C){b._logger.log("trace","do trigger("+r+") onactivation actions "+(C?"fail:"+C.message:"success"));C&&A.push(r);r++;r<c.trigger.length?(b._logger.log("trace","do trigger("+r+") onactivation actions"),l(r,c.trigger[r],B)):u(A.length?Error("onactivation actions failed for triggers ["+A.join(",")+"]"):null)};b._logger.log("trace","do trigger("+r+") onactivation actions");l(r,c.trigger[r],
B)}else u()};b._logger.log("trace","do main onactivation actions");(function(u){c.onactivation&&c.onactivation.length?actman.getActionManager().executeAction("rle:"+b._id+"@onactivation",c.onactivation,function(r){u(r)}):u()})(function(u){b._logger.log("trace","finish main onactivation actions "+(u?"fail:"+u.message:"success"));b._logger.log("trace","do triggers onactivation actions");z(function(r){b._logger.log("trace","finish triggers onactivation actions "+(r?"fail:"+r.message:"success"));var A=
null;if(u||r)A=u?"main onactivation failed":"",A=Error(A+((A?",":"")+r?"triggers onactivation failed":""));k(A)})})},e=function(k){c.onchecksuccess&&c.onchecksuccess.length?actman.getActionManager().executeAction("rle:"+b._id+"@onchecksuccess",c.onchecksuccess,function(l){k(l)}):k()},f=function(k){c.oncheckfail&&c.oncheckfail.length?actman.getActionManager().executeAction("rle:"+b._id+"@oncheckfail",c.oncheckfail,function(l){k(l)}):k()},h=function(k,l){commandman.commandHandlerV6.getDeviceStatesWithStateInfo(k,
l)},g=function(k,l,z,u,r){if(u){var A=l.state.check;l=l.state.data;var B=[],C=!0;A&&A.length?(A.forEach(function(v){v&&v.states&&v.states.length&&(v=JSON.parse(JSON.stringify(v)),v.value||(v.value="state"),B.push(v))}),C=!0):l&&l.length&&(l.forEach(function(v){v&&v.states&&v.states.length&&(v=JSON.parse(JSON.stringify(v)),v.value||(v.value="state"),B.push(v))}),C=!1);B.length?h(u,function(v,G){if(v)b._logger.log("trace","get trigger("+k+") device("+z+") states fail:"+v.message),r(v);else if(G){for(v=
0;v<B.length;v++){var E=G[B[v].value];if(void 0==E||null==E){b._logger.log("trace","check trigger("+k+") device("+z+") state "+B[v].value+" fail: value unknown");r(Error("state value unknown"));return}b._logger.log("trace","check trigger("+k+") device("+z+") state "+B[v].value+"="+E);var F=!1;C&&-1!=B[v].states.indexOf(E)?F=!0:C||-1!=B[v].states.indexOf(E)||(F=!0);if(!F){r(null,F);return}}r(null,!0)}else b._logger.log("trace","check trigger("+k+") device("+z+") state fail: states response is null"),
r(Error("states response is null"))}):(b._logger.log("trace","get trigger("+k+") device("+z+") has no states to check"),r(null,!0))}else b._logger.log("trace","get trigger("+k+") device("+z+") json is null"),r(null,!0)},n=function(k,l,z){if(l&&l.state&&l.state.devices&&l.state.devices.length){var u=0,r=function(A,B){b._logger.log("trace","check trigger("+k+") device("+u+") "+(A?"fail:"+A.message:"success:match="+B));A||!B?z(A,B):(u++,u<l.state.devices.length?(b._logger.log("trace","check trigger("+
k+") device("+u+")"),g(k,l,u,l.state.devices[u],r)):z(null,!0))};b._logger.log("trace","check trigger("+k+") device("+u+")");g(k,l,u,l.state.devices[u],r)}else b._logger.log("trace","trigger("+k+") has no checkable devices"),z(null,!0)};this._logger.log("trace","check triggers (value="+c.checktriggers+")");(function(k){if(1!=c.checktriggers)k(null,!0);else if(c.trigger&&c.trigger.length){var l=0,z=function(u,r){b._logger.log("trace","check trigger("+l+") "+(u?"fail:"+u.message:"success:match="+r));
u||!r?k(u,r):(l++,l<c.trigger.length?(b._logger.log("trace","check trigger("+l+")"),n(l,c.trigger[l],z)):k(null,!0))};b._logger.log("trace","check trigger("+l+")");n(l,c.trigger[l],z)}else k(null,!0)})(function(k,l){b._logger.log("trace","finish check triggers "+(k?"fail:"+k.message:"success:match="+l));k||!l?(b._logger.log("trace","do oncheckfail actions"),f(function(z){b._logger.log("trace","finish oncheckfail actions "+(z?"fail:"+z.message:"success"));var u="check triggers failed:"+(k?k.message:
"device state not match");z&&(u+="; oncheckfail actions failed:"+z.message);a&&a(Error(u))})):(b._logger.log("trace","do onchecksuccess actions"),e(function(z){b._logger.log("trace","finish onchecksuccess actions "+(z?"fail:"+z.message:"success"));z?a&&a(Error("onchecksuccess actions failed:"+z.message)):(b._logger.log("trace","do onactivation actions"),d(function(u){b._logger.log("trace","finish onactivation actions "+(u?"fail:"+u.message:"success"));b._json.active=1;b._logger.log("trace","save rule activated");
b._ruleManager.onRuleChanged(b._id,function(r){b._logger.log("trace","finish save rule activated "+(r?"fail:"+r.message:"success"));a&&a(r?Error("save rule activated failed:"+r.message):null)})}))}))})};q.prototype.onTriggered=function(a,b){this._triggerDelayTimeout&&(clearTimeout(this._triggerDelayTimeout),this._triggerDelayTimeout=null);var c=this;b.delay?(this._logger.log("trace","triggered by trigger("+a+") with delay "+b.delay),this._triggerDelayTimeout=setTimeout(function(){c._logger.log("trace",
"do delayed action by trigger("+a+")");c.doActions()},1E3*b.delay)):(this._logger.log("trace","triggered by trigger("+a+") and do actions"),this.doActions())};q.prototype._hitDeviceTrigger=function(a,b,c,d){var e=this;p.prototype._hitDeviceTrigger.call(this,a,b,c,function(f,h){f||!h?d(f,h):(b.state&&b.state.ontrigger&&(e._logger.log("trace","do trigger("+a+") ontrigger actions"),actman.getActionManager().executeAction("rle:"+e._id+"@t"+a+"-ontrigger",b.state.ontrigger,function(g){e._logger.log("trace",
"do trigger("+a+") ontrigger actions "+(g?"fail:"+g.message:"success"))})),d(null,h))})};var m=function(a){p.call(this,a)};util.inherits(m,p);m.prototype.onTriggered=function(a,b){this._logger.log("trace","triggered by periods with index ["+a+"]");a=JSON.parse(JSON.stringify(b));a.command||(a.command="temperature");if((b=this._json)&&b.devices&&0<b.devices.length){for(var c=[],d=0;d<b.devices.length;d++){var e=b.devices[d];if(e)try{var f=JSON.parse(JSON.stringify(e)),h;for(h in a)f[h]=a[h];c.push(f)}catch(g){}}this._logger.log("trace",
"do actions");actman.getActionManager().executeAction("rle:"+this._id,c,function(g){callback&&callback(g)})}};m.prototype.onTimerTick=function(a){if(this._json){var b=this.isActive(),c=this.matchTimeRequirement(a);if(b&&c){var d=this._json;if(d.periods&&0!=d.periods.length)for(var e=0;e<d.periods.length;e++){var f=d.periods[e];if(this._hitPeriodTrigger(f,a)){this._logger.log("trace","active:"+b+" | date match:"+c+" | time trigger hit");this.onTriggered(e,f);break}}}}};m.prototype.onDeviceEvent=function(a,
b){};m.prototype._hitPeriodTrigger=function(a,b){if(!a||!a.start)return!1;var c=a.start.split(":");if(2>c.length)return!1;a=parseInt(c[0]);c=parseInt(c[1]);return a==b.hour()&&c==b.minute()};var t=function(){this._logger=require("x.logger.js").getLogger("x.hub.rule.RuleManager");this._cronTimer=this._rules=this._dataFolder=null;this._writing=!1;this._writeCallbacks=[]};t.FILE_NAME="rule.json";t.prototype.init=function(a,b){this._logger.log("info","init rule manager");this._dataFolder=a.getUserRootDataPath();
this._cronTimer=new w(this);var c=this;this._loadRules(function(d){d?b&&b(d):c._initRules(function(){b&&b()})})};t.prototype.getRules=function(){return this._rules};t.prototype.getRule=function(a){return this._rules?this._rules[a]:null};t.prototype.setRule=function(a,b,c){if(a){var d=this._rules[a];if(b){this._logger.log("trace","update rule "+a);var e=p.parseJSON(a,b);if(!e){c&&c(Error("invalid rule json"));return}e._ruleManager=this;this._rules[a]=e}else this._logger.log("trace","delete rule "+
a),delete this._rules[a];d&&(this._logger.log("trace","call finialize of old rule "+a),d.finalize());this._writeRules(function(f){c&&c(f,b)})}else c&&c(Error("invalid rule id"))};t.prototype.onRuleChanged=function(a,b){this._writeRules(function(c){b&&b(c)})};t.prototype.onTimerTick=function(a,b,c){if(this._rules)for(var d in this._rules){var e=this._rules[d];if(e)e.onTimerTick(a,b,c)}};t.prototype.onLocationChange=function(a){this._logger.log("trace","receive location change event:"+JSON.stringify(a));
this._cronTimer.onLocationChange(a)};t.prototype.onTimeChange=function(a){this._logger.log("trace","receive time change event:"+JSON.stringify(a));this._cronTimer.onTimeChange(a)};t.prototype.onDeviceEvent=function(a){this._logger.log("trace","receive "+a.type+" event from "+a.source+":"+JSON.stringify(a.value));var b=D.getMomentNow(),c;for(c in this._rules){var d=this._rules[c];if(d)d.onDeviceEvent(a,b)}};t.prototype._initRules=function(a){this._cronTimer.start();a()};t.prototype._loadRules=function(a){var b=
require("fs-extra"),c=this._getFile(),d=this;b.ensureFile(c,function(e){e?a(e):d._loadFile(function(f,h){if(f)a(f);else{d._rules={};if(h)for(var g in h)if(f=p.parseJSON(g,h[g]))f._ruleManager=d,d._rules[g]=f;a()}})})};t.prototype._writeRules=function(a){a&&-1==this._writeCallbacks.indexOf(a)&&this._writeCallbacks.push(a);if(!this._writing&&this._writeCallbacks.length){this._writing=!0;var b=this._writeCallbacks;this._writeCallbacks=[];a={};for(var c in this._rules){var d=this._rules[c];d&&d.toJSON&&
(a[c]=d.toJSON())}var e=this;this._writeFile(a,function(f){e._writing=!1;b.forEach(function(h){try{h&&h(f)}catch(g){}});e._writeRules()})}};t.prototype._getFile=function(){return require("path").resolve(this._dataFolder,t.FILE_NAME)};t.prototype._loadFile=function(a){var b=require("fs"),c=this._getFile();b.readFile(c,"utf8",function(d,e){if(d)a(d);else if(e)try{var f=JSON.parse(e);a(null,f)}catch(h){a(null,{})}else a(null,{})})};t.prototype._writeFile=function(a,b){var c=require("fs"),d=this._getFile();
c.writeFile(d,JSON.stringify(a,null,2),function(e){b&&b(e)})};t.Util=D;t.Rule=p;return t}();
x.hub.rule.Handler=function(){var D=function(){this._logger=require("x.logger.js").getLogger("x.hub.rule.Handler");this._ruleManager=new x.hub.rule.RuleManager};D.prototype.RuleManager=x.hub.rule.RuleManager;D.prototype.init=function(w,p,y){var q=this;eventbus.on("locationchange",this._onLocationChange.bind(this));eventbus.on("timechange",this._onTimeChange.bind(this));eventbus.on("gatewayevent",function(m,t,a){q._onGatewayEvent(m,t,a)});"CA"==global.HARDWARE_VERSION?this._initHttpApiNew(w):this._initHttpApi(w);
this._ruleManager.init(p,function(m){m&&y(m)})};D.prototype.getRuleManager=function(){return this._ruleManager};D.prototype._onLocationChange=function(w){this._logger.log("trace","receive location change event:"+JSON.stringify(w));this._ruleManager.onLocationChange(w)};D.prototype._onTimeChange=function(w){this._logger.log("trace","receive time change event:"+JSON.stringify(w));this._ruleManager.onTimeChange(w)};D.prototype._onGatewayEvent=function(w,p,y){this._logger.log("trace","receive gateway "+
y+" event:"+JSON.stringify(w)+" from:"+JSON.stringify(p));if(w){var q=this,m={source:p.address,type:"STA"==y?"state":"event",value:w};process.nextTick(function(){q._ruleManager.onDeviceEvent(m)})}};D.prototype._initHttpApiNew=function(w){var p=this;w=require("x.hub.js").getServer();w.addRoute("/api/rules",{method:"GET"},function(y,q,m){y=p._ruleManager.getRules();q.json({XC_SUC:y?y:{}})});w.addRoute("/data/rle/",{method:"GET"},function(y,q,m){y=y.path.substr(10);(y=p._ruleManager.getRule(y))?q.json({XC_SUC:y}):
q.json({XC_ERR:{code:"000101",msg:"failed to open file"}})});w.addRoute("/data/rle/",{method:"POST",lock:1},function(y,q){var m=y.path.substr(10);try{p._ruleManager.setRule(m,y.json,function(t,a){t?q.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+t.message}}):a?q.json({XC_SUC:{bytes:y.size}}):q.json({XC_SUC:{bytes:0}})})}catch(t){q.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+t.message}})}});w.addRoute("/api/trigger",{method:"POST"},function(y,q){try{var m=y.json;m&&"time"==m.type&&
m.value?(q.json({XC_SUC:{}}),process.nextTick(function(){var t=require("moment-timezone"),a=taskman.Util._getTimeZone(),b=parseInt(m.value.split(":")[0]),c=parseInt(m.value.split(":")[1]),d=new Date;d.setHours(b);d.setMinutes(c);d=t.tz(d.getTime(),a);p._ruleManager.onTimerTick(d)})):m&&"event"==m.type&&m.value?(q.json({XC_SUC:{}}),process.nextTick(function(){p._ruleManager.onDeviceEvent({source:m.source?m.source:"ST",type:m.type,value:m.value})})):m&&"state"==m.type&&m.value?(q.json({XC_SUC:{}}),
process.nextTick(function(){p._ruleManager.onDeviceEvent({source:m.source?m.source:"ST",type:m.type,value:m.value})})):q.json({XC_ERR:{code:"000101",msg:"unknown trigger type"}})}catch(t){q.json({XC_ERR:{code:"000101",msg:"failed to trigger:"+t.message}})}})};D.prototype._initHttpApi=function(w){var p=this,y=require("x.hub.js").getServer();w.get("/api/rules",function(q,m,t){y.auth(q)?(q=p._ruleManager.getRules(),m.json({XC_SUC:q?q:{}})):m.json({XC_ERR:{code:"000007",msg:"access denied"}})});w.get("/data/rle/:id",
function(q,m,t){y.auth(q)?(q=p._ruleManager.getRule(q.params.id))?m.json({XC_SUC:q}):m.json({XC_ERR:{code:"000101",msg:"failed to open file"}}):m.json({XC_ERR:{code:"000007",msg:"access denied"}})});w.post("/data/rle/:id",function(q,m){if(y.auth(q)){var t=new Buffer(0);q.on("data",function(a){t=Buffer.concat([t,a])});q.on("end",function(){var a=q.params.id,b=t.toString("utf8");try{var c=null;b&&(c=JSON.parse(b));p._ruleManager.setRule(a,c,function(d,e){d?m.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+
d.message}}):e?m.json({XC_SUC:{bytes:t.length}}):m.json({XC_SUC:{bytes:0}})})}catch(d){m.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+d.message}})}})}else m.json({XC_ERR:{code:"000007",msg:"access denied"}})});w.post("/api/trigger",function(q,m){if(y.auth(q)){var t=new Buffer(0);q.on("data",function(a){t=Buffer.concat([t,a])});q.on("end",function(){var a=t.toString("utf8");try{var b=null;a&&(b=JSON.parse(a));if(b&&"time"==b.type&&b.value){var c=require("moment-timezone"),d=taskman.Util._getTimeZone(),
e=parseInt(b.value.split(":")[0]),f=parseInt(b.value.split(":")[1]),h=new Date;h.setHours(e);h.setMinutes(f);h=c.tz(h.getTime(),d);var g=x.hub.rule.RuleManager.Util.getAstro(h);p._ruleManager.onTimerTick(h,g[0],g[1]);m.json({XC_SUC:{}})}else m.json({XC_ERR:{code:"000101",msg:"unknown trigger type"}})}catch(n){m.json({XC_ERR:{code:"000101",msg:"failed to trigger:"+n.message}})}})}else m.json({XC_ERR:{code:"000007",msg:"access denied"}})})};return D}();module.exports=new x.hub.rule.Handler;
