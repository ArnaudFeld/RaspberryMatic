var util=require("util"),taskman=require("x.hub.taskman.js"),actman=require("x.hub.action.js"),commandman=require("x.hub.commandman.js"),eventbus=require("x.hub.eventbus.js"),moment=require("moment-timezone"),x=x||{};x.hub=x.hub||{},x.hub.rule=x.hub.rule||{},x.hub.rule.RuleManager=function(){var e={getMomentNow:function getMomentNow(){var e=taskman.Util._getTimeZone(),t=new Date().getTime(),i=moment.tz(t,e);return i.second(0),i.millisecond(0),i;},getAstro:function getAstro(e){var t=taskman.Util._getlatlong(),i=require("suncalc"),r=i.getTimes(e.toDate(),t.lat,t["long"]),n=taskman.Util._getTimeZone(),a=moment.tz(r.sunrise,n),o=moment.tz(r.sunset,n);return a.date()==e.date()&&o.date()==e.date()||(e.add(12,"h"),r=i.getTimes(e.toDate(),t.lat,t["long"]),a=moment.tz(r.sunrise,n),o=moment.tz(r.sunset,n)),a.second(0),a.millisecond(0),o.second(0),o.millisecond(0),[a,o];},matchDate:function matchDate(e,t){if(!e)throw new Error("invalid momentNow argument");if(!t)return!0;var i=e.tz(),r=e.valueOf();if(t.start&&"0000-00-00"!=t.start){var n=moment.tz(t.start,i);if(n.set({hour:0,minute:0,second:0,millisecond:0}),n.valueOf()>r)return!1;}if(t.end&&"0000-00-00"!=t.end){var a=moment.tz(t.end,i);if(a.set({hour:23,minute:59,second:59,millisecond:999}),a.valueOf()<r)return!1;}if(t.days){var o=e.day();if(0==o&&(o=7),"1"!=t.days.charAt(o-1))return!1;}return!0;},calculateAstroTarget:function calculateAstroTarget(e,t,i,r){if(!(e&&t&&i&&r))return null;var n=r,a=null,o=null;if("sunrise"==n.substr(0,7)?(a=t.clone(),"+"!=n.charAt(7)&&"-"!=n.charAt(7)||(o=parseInt(n.substr(7)),a.add(o,"minutes"))):"sunset"==n.substr(0,6)&&(a=i.clone(),"+"!=n.charAt(6)&&"-"!=n.charAt(6)||(o=parseInt(n.substr(6)),a.add(o,"minutes"))),!a)return null;var s=moment(e);s.hour(0),s.minute(0),s.second(0),s.millisecond(0);var c=moment(e);return c.hour(23),c.minute(59),c.second(59),c.millisecond(999),a.isBefore(s)?a=s:a.isAfter(c)&&(a=c),a;},calculateTimeTarget:function calculateTimeTarget(e,t){if(!e||!t)return null;var i=t.split(":");if(2!=i.length)return null;var r=parseInt(i[0]),n=parseInt(i[1]);if(isNaN(r)||isNaN(n))return null;if(r<0||r>23)return null;if(n<0||n>59)return null;var a=moment(e);return a.hour(r),a.minute(n),a.second(0),a.millisecond(0),a;}},t=function t(e){this._logger=require("x.logger.js").getLogger("x.hub.rule.RuleManager.CronTimer"),this._ruleManager=e,this._cronJob=null;};t.prototype.start=function(){var e="00 * * * * *",t=taskman.Util._getTimeZone();this._logger.log("trace","start cron job:"+e+" tz:"+t);var i=require("cron").CronJob;this._cronJob=new i(e,this.onTick.bind(this),null,!0,t);},t.prototype.stop=function(){this._logger.log("debug","stop timer:"+JSON.stringify(this.timer)),this._cronJob&&(this._cronJob.stop(),this._cronJob=null);},t.prototype.onTick=function(){this._logger.log("trace","timer tick");var t=e.getMomentNow(),i=e.getAstro(t);this._ruleManager.onTimerTick(t,i[0],i[1]);},t.prototype.onLocationChange=function(){this.stop(),this.start();},t.prototype.onTimeChange=function(){this.stop(),this.start();};var i=function i(e){this._logger=require("x.logger.js").getLogger("x.hub.rule.RuleManager.Rule.#"+e),this._id=e,this._json=null,this._ruleManager=null,this._state=0,this._activateCallbacks=[],this._pendingTriggers={},this._delayedTriggers=[];};i.prototype.finalize=function(){for(var e in this._pendingTriggers){var t=this._pendingTriggers[e];t&&clearTimeout(t);}for(var i=0;i<this._delayedTriggers.length;i++){var r=this._delayedTriggers[i];r&&r.timeout&&clearTimeout(r.timeout);}this._pendingTriggers={},this._delayedTriggers=[];},i.prototype.executeCommand=function(e,t){e&&e.command?"activate"==e.command?this.setActive(!0,function(e){t&&t(e);}):"deactivate"==e.command?this.setActive(!1,function(e){t&&t(e);}):"execute"==e.command?this.doActions(function(e){t&&t(e);}):t&&t(new Error("invalid command")):t&&t(new Error("invalid command"));},i.prototype.getStates=function(e){e&&e(null,{active:this.isActive()});},i.prototype.isActive=function(){return this._json&&1==this._json.active;},i.prototype.setActive=function(e,t){if(this._json){var i=this.isActive();if(i&&e||!i&&!e)t&&t();else if(1!=this._state||e){if(2==this._state&&e)t&&t(new Error("deactivate process is rinning"));else if(t&&-1==this._activateCallbacks.indexOf(t)&&this._activateCallbacks.push(t),0==this._state){var r=this;this._state=e?1:2,this[e?"_doActivate":"_doDeactivate"](function(e){r._state=0;var t=r._activateCallbacks;r._activateCallbacks=[],t.forEach(function(t){try{t&&t(e);}catch(e){}});});}}else t&&t(new Error("activate process is rinning"));}else t&&t(new Error("invalid rule"));},i.prototype._doActivate=function(e){this._json.active=1,this._ruleManager.onRuleChanged(this._id,function(t){e&&e(t);});},i.prototype._doDeactivate=function(e){this._json.active=0,this._ruleManager.onRuleChanged(this._id,function(t){e&&e(t);});},i.prototype.matchTimeRequirement=function(t){if(!this._json)return!1;var i=this._json;return e.matchDate(t,i);},i.prototype.getType=function(){return this._json?this._json.type:null;},i.prototype.doActions=function(e){if(this._json){if(this._json.actions&&this._json.actions.length){this._logger.log("trace","do actions");var t=this,i=actman.getActionManager(),r="executeAction";1==this._json.restart&&(r="executeActionSingelton"),i[r]("rle:"+this._id,this._json.actions,function(i){t._logger.log("trace","finish do actions "+(i?"failed:"+i.message:"success")),e&&e(i);});}else e&&e();}else e&&e(new Error("invalid rule"));},i.prototype.onTriggered=function(e,t){this._logger.log("trace","triggered by trigger with index ["+e+"]"),this.doActions();},i.prototype.onDeviceEvent=function(e,t){if(this._json){var i=this.isActive(),r=this.matchTimeRequirement(t);if(this._logger.log("trace","active:"+i+" | date match:"+r+" | check device event:"+JSON.stringify(e)),i&&r){var n=this._json;if(n.trigger&&n.trigger.length){var a=this,o=0,s=[],c=function c(t,i,r){!t&&i?n.trigger[o].delay?a._addDelayedTrigger(o):n.trigger[o].dur?a._addPendingTrigger(o):s.push(o):t||i||!r||n.trigger[o].dur&&a._removePendingTrigger(o),++o<n.trigger.length?a._hitDeviceTrigger(o,n.trigger[o],e,c):s.length?a.onTriggered(s[0],n.trigger[s[0]]):a._logger.log("trace","no trigger hit");};this._hitDeviceTrigger(o,n.trigger[o],e,c);}}}},i.prototype._addDelayedTrigger=function(e){var t=this._json.trigger[e],i=this,r={triggerIdx:e,timeout:setTimeout(function(){var e=i._delayedTriggers.indexOf(r);-1!=e&&i._delayedTriggers.splice(e,1),i.onTriggered(r.triggerIdx,t);},1e3*parseFloat(t.delay))};this._delayedTriggers.push(r);},i.prototype._addPendingTrigger=function(e){var t=this._json.trigger[e];if(!this._pendingTriggers[e]){var i=this;this._pendingTriggers[e]=setTimeout(function(){delete i._pendingTriggers[e],i.onTriggered(e,t);},1e3*parseFloat(t.dur));}},i.prototype._removePendingTrigger=function(e){if(this._pendingTriggers[e]){var t=this._pendingTriggers[e];t&&clearTimeout(t),delete this._pendingTriggers[e];}},i.prototype.onTimerTick=function(e,t,i){if(this._json){var r=this.isActive(),n=this.matchTimeRequirement(e);if(r&&n){var a=this._json;if(a.trigger&&a.trigger.length)for(var o=0;o<a.trigger.length;o++){var s=a.trigger[o];if(this._hitTimeTrigger(s,e,t,i))return this._logger.log("trace","active:"+r+" | date match:"+n+" | time trigger hit"),void this.onTriggered(o,s);}}}},i.prototype.toJSON=function(){return this._json;},i.prototype._hitDeviceTrigger=function(e,t,i,r){var n=this,a=!1,o=function o(e){var t=e;return e.length>18&&(t=e.substr(4,2),t=e.substr(18+8*parseInt(e.substr(16,2),16))),t;},s=function(e,t){if(!e)return!1;var i=t.type,r=t.value;if("event"==i){if(!e.event)return!1;if(r.sys||(r.sys="mediola"),e.event.sys!=r.sys)return!1;if("mediola"!=r.sys)return!1;if(!e.event.data)return!1;if("IR"==e.event.data.type&&"IR"==r.type){var s=o(e.event.data.data),c=o(r.data);return n._logger.log("debug","comparing => triggerData : "+s+"  dataValue : "+c),e.event.data.type==r.type&&s==c;}return e.event.data.type==r.type&&e.event.data.data==r.data;}if("state"==i){if(!(e.state&&e.state.devices&&e.state.devices.length&&e.state.data&&e.state.data.length))return!1;var g={};for(var l in r.state)r.changed&&-1!=r.changed.indexOf(l)&&(g[l]=r.state[l]);for(var u=0;u<e.state.devices.length;u++){var h=e.state.devices[u];if(h&&(g=commandman.commandHandlerV6.resolveDeviceStates(h,t))){a=!0;for(var d=0;d<e.state.data.length;d++){var f=e.state.data[d];if(f&&commandman.commandHandlerV6.matchDeviceState(g,f))return!0;}}}return!1;}return!1;}(t,i);r(null,s,a);},i.prototype._hitTimeTrigger=function(t,i,r,n){if(!t)return!1;if(t.time){if(!i)return!1;if((g=t.time.split(":")).length<2)return!1;var a=parseInt(g[0]),o=parseInt(g[1]);return a==i.hour()&&o==i.minute();}if(t.astro){if(!r||!n)return!1;var s=t.astro,c=e.calculateAstroTarget(i,r,n,s);if(!c)return!1;var g,l=null,u=null;return t.earliest&&(g=t.earliest.split(":")).length>=2&&(a=parseInt(g[0]),o=parseInt(g[1]),(l=moment(i)).hour(parseInt(a)),l.minute(parseInt(o)),l.second(0),l.millisecond(0)),t.latest&&(g=t.latest.split(":")).length>=2&&(a=parseInt(g[0]),o=parseInt(g[1]),(u=moment(i)).hour(parseInt(a)),u.minute(parseInt(o)),u.second(0),u.millisecond(0)),!(l&&u&&l.isAfter(u))&&(l&&c.isBefore(l)&&(c=l),u&&c.isAfter(u)&&(c=u),this._logger.log("debug","now : ".concat(i.format("HH:mm:ss").toString()," - target : ").concat(c.format("HH:mm:ss").toString())),c.hour()==i.hour()&&c.minute()==i.minute());}return!1;},i.parseJSON=function(e,t){if(!e||!t)return null;var o=null;switch(t.type){case"heatingschedule":o=new a(e);break;case"link":o=new r(e);break;case"alarm":o=new n(e);break;default:o=new i(e);}return o._json=t,o;};var r=function r(e){i.call(this,e),this._stateBuffer=null;};util.inherits(r,i),r.prototype.onDeviceEvent=function(e,t){if(this._json){var i=e.type,r=e.value;if(this._logger.log("trace","check link device with "+i+":"+JSON.stringify(r)),this._json.link&&this._json.link.device){var n=this._json.link,a=n.device;if("state"==i&&r.state){var o=!1;if(a.device&&a.device.id&&a.device.id==r.sid&&(o=!0),o){this._logger.log("trace","match link device");var s,c,g=!1,l=[];if(n.value)s=!0,r.changed&&-1==r.changed.indexOf(n.value)&&(s=!1),null!=(c=r.state[n.value])&&null!=c&&s&&(g=!0,this._logger.log("trace","match link device state:"+n.value),n.command&&l.push({command:n.command,value:c}));else if(n.values&&n.values.length)for(var u=0;u<n.values.length;u++){var h=n.values[u];if(!h)return;var d=h.value;if(d||(d="state"),s=!0,r.changed&&-1==r.changed.indexOf(d)&&(s=!1),null!=(c=r.state[d])&&null!=c&&s){if(h.hyst){c=parseFloat(c);var f=this._stateBuffer?this._stateBuffer[d]:null;null!=f&&null!=f?(c-f>h.hyst||f-c>h.hyst)&&(g=!0):g=!0;}else h.states?(1==c||"true"==c?g=-1!=h.states.indexOf(!0)||-1!=h.states.indexOf("true"):0==c||"false"==c?g=-1!=h.states.indexOf(!1)||-1!=h.states.indexOf("false"):-1!=h.states.indexOf(c)&&(g=!0),c=null):g=!0;if(this._logger.log("trace","match link device values("+u+") state:"+d),h.ranges&&h.ranges.length){c=parseFloat(c);for(var v=0;v<h.ranges.length;v++){var _=h.ranges[v];if(_&&!(null!=_.to&&null!=_.to&&c>_.to||null!=_.from&&null!=_.from&&c<_.from)){var m,p=null;_.command?p=_.command:h.command&&(p=h.command),m=null!=_.value&&null!=_.value?_.value:c,null!=p&&null!=p&&l.push({command:p,value:m,source:d});}}}else h.command?l.push({command:h.command,value:c,source:d}):l.push({command:c,source:d});}}this._stateBuffer=r.state,g&&l.length&&this._doAction(l);}}}}},r.prototype._doAction=function(e){if(this._json)if(this._logger.log("trace","forward commands:"+JSON.stringify(e)),this._json.devices&&this._json.devices.length){for(var t=this._json.devices,i=[],r=0;r<t.length;r++){var n=t[r];if(n)for(var a=0;a<e.length;a++){var o=e[a];if(o){var s=JSON.parse(JSON.stringify(n));for(var c in o)s[c]=o[c];i.push(s);}}}if(i.length){this._logger.log("trace","do actions");var g=this;actman.getActionManager().executeActionSingelton("rle:"+this._id,i,function(e){g._logger.log("trace","finish do actions "+(e?"failed:"+e.message:"success")),callback&&callback(e);});}else this._logger.log("trace","no devices");}else this._logger.log("trace","no devices");};var n=function n(e){i.call(this,e),this._triggerDelayTimeout=null;};util.inherits(n,i),n.prototype.finalize=function(){this._triggerDelayTimeout&&(clearTimeout(this._triggerDelayTimeout),this._triggerDelayTimeout=null);},n.prototype._doDeactivate=function(e){var t=this,i=this._json;this._logger.log("trace","do ondeactivation actions"),function(e){var r=function r(e,i,_r){if(!(i&&i.state&&i.state.ondeactivate&&i.state.devices&&i.state.devices.length))return t._logger.log("trace","trigger("+e+") has no ondeactivate actions"),void _r();try{var n=[];if(i.state.devices.forEach(function(e){var t=JSON.parse(JSON.stringify(e));for(var r in i.state.ondeactivate)t[r]=i.state.ondeactivate[r];n.push(t);}),!n.length)return void _r();actman.getActionManager().executeAction("rle:"+t._id+"@t"+e+"-ondeactivate",n,function(e){_r(e);});}catch(e){_r(e);}};t._logger.log("trace","do main ondeactivation actions"),function(e){i.ondeactivation&&i.ondeactivation.length?actman.getActionManager().executeAction("rle:"+t._id+"@ondeactivation",i.ondeactivation,function(t){e(t);}):e();}(function(n){t._logger.log("trace","finish main ondeactivation actions "+(n?"fail:"+n.message:"success")),t._logger.log("trace","do triggers ondeactivation actions"),function(e){if(i.trigger&&i.trigger.length){var n=0,a=[],o=function o(s){t._logger.log("trace","do trigger("+n+") ondeactivation actions "+(s?"fail:"+s.message:"success")),s&&a.push(n),++n<i.trigger.length?(t._logger.log("trace","do trigger("+n+") ondeactivation actions"),r(n,i.trigger[n],o)):e(a.length?new Error("ondeactivation actions failed for triggers ["+a.join(",")+"]"):null);};t._logger.log("trace","do trigger("+n+") ondeactivation actions"),r(n,i.trigger[n],o);}else e();}(function(i){t._logger.log("trace","finish triggers ondeactivation actions "+(i?"fail:"+i.message:"success"));var r=null;if(n||i){var a=n?"main ondeactivation failed":"";a+=(a?", ":"")+i?"triggers ondeactivation failed":"",r=new Error(a);}e(r);});});}(function(i){t._logger.log("trace","finish ondeactivation actions "+(i?"fail:"+i.message:"success")),t._json.active=0,t._logger.log("trace","save rule deactivated"),function(e){t._ruleManager.onRuleChanged(t._id,e);}(function(i){t._logger.log("trace","finish save rule deactivated "+(i?"fail:"+i.message:"success")),e&&e(i?new Error("save rule deactivated failed:"+i.message):null);});});},n.prototype._doActivate=function(e){var t=this,i=this._json,r=function r(e){var r=function r(e,i,_r2){if(!(i&&i.state&&i.state.onactivate&&i.state.devices&&i.state.devices.length))return t._logger.log("trace","trigger("+e+") has no onactivate actions"),void _r2();try{var n=[];if(i.state.devices.forEach(function(e){var t=JSON.parse(JSON.stringify(e));for(var r in i.state.onactivate)t[r]=i.state.onactivate[r];n.push(t);}),!n.length)return void _r2();actman.getActionManager().executeAction("rle:"+t._id+"@t"+e+"-onactivate",n,function(e){_r2(e);});}catch(e){_r2(e);}};t._logger.log("trace","do main onactivation actions"),function(e){i.onactivation&&i.onactivation.length?actman.getActionManager().executeAction("rle:"+t._id+"@onactivation",i.onactivation,function(t){e(t);}):e();}(function(n){t._logger.log("trace","finish main onactivation actions "+(n?"fail:"+n.message:"success")),t._logger.log("trace","do triggers onactivation actions"),function(e){if(i.trigger&&i.trigger.length){var n=0,a=[],o=function o(s){t._logger.log("trace","do trigger("+n+") onactivation actions "+(s?"fail:"+s.message:"success")),s&&a.push(n),++n<i.trigger.length?(t._logger.log("trace","do trigger("+n+") onactivation actions"),r(n,i.trigger[n],o)):e(a.length?new Error("onactivation actions failed for triggers ["+a.join(",")+"]"):null);};t._logger.log("trace","do trigger("+n+") onactivation actions"),r(n,i.trigger[n],o);}else e();}(function(i){t._logger.log("trace","finish triggers onactivation actions "+(i?"fail:"+i.message:"success"));var r=null;if(n||i){var a=n?"main onactivation failed":"";a+=(a?",":"")+i?"triggers onactivation failed":"",r=new Error(a);}e(r);});});},n=function n(e,i,r,_n,a){if(!_n)return t._logger.log("trace","get trigger("+e+") device("+r+") json is null"),void a(null,!0);var o=i.state.check,s=i.state.data,c=[],g=!0;if(o&&o.length?(o.forEach(function(e){if(e&&e.states&&e.states.length){var t=JSON.parse(JSON.stringify(e));t.value||(t.value="state"),c.push(t);}}),g=!0):s&&s.length&&(s.forEach(function(e){if(e&&e.states&&e.states.length){var t=JSON.parse(JSON.stringify(e));t.value||(t.value="state"),c.push(t);}}),g=!1),!c.length)return t._logger.log("trace","get trigger("+e+") device("+r+") has no states to check"),void a(null,!0);!function(e,t){commandman.commandHandlerV6.getDeviceStatesWithStateInfo(e,t);}(_n,function(i,n){if(i)return t._logger.log("trace","get trigger("+e+") device("+r+") states fail:"+i.message),void a(i);if(!n)return t._logger.log("trace","check trigger("+e+") device("+r+") state fail: states response is null"),void a(new Error("states response is null"));for(var o=0;o<c.length;o++){var s=n[c[o].value];if(null==s||null==s)return t._logger.log("trace","check trigger("+e+") device("+r+") state "+c[o].value+" fail: value unknown"),void a(new Error("state value unknown"));t._logger.log("trace","check trigger("+e+") device("+r+") state "+c[o].value+"="+s);var l=!1;if(g&&-1!=c[o].states.indexOf(s)?l=!0:g||-1!=c[o].states.indexOf(s)||(l=!0),!l)return void a(null,l);}a(null,!0);});},a=function a(e,i,r){if(!(i&&i.state&&i.state.devices&&i.state.devices.length))return t._logger.log("trace","trigger("+e+") has no checkable devices"),void r(null,!0);var a=0,o=function o(s,c){t._logger.log("trace","check trigger("+e+") device("+a+") "+(s?"fail:"+s.message:"success:match="+c)),!s&&c?++a<i.state.devices.length?(t._logger.log("trace","check trigger("+e+") device("+a+")"),n(e,i,a,i.state.devices[a],o)):r(null,!0):r(s,c);};t._logger.log("trace","check trigger("+e+") device("+a+")"),n(e,i,a,i.state.devices[a],o);};this._logger.log("trace","check triggers (value="+i.checktriggers+")"),function(e){if(1==i.checktriggers){if(i.trigger&&i.trigger.length){var r=0,n=function n(o,s){t._logger.log("trace","check trigger("+r+") "+(o?"fail:"+o.message:"success:match="+s)),!o&&s?++r<i.trigger.length?(t._logger.log("trace","check trigger("+r+")"),a(r,i.trigger[r],n)):e(null,!0):e(o,s);};t._logger.log("trace","check trigger("+r+")"),a(r,i.trigger[r],n);}else e(null,!0);}else e(null,!0);}(function(n,a){if(t._logger.log("trace","finish check triggers "+(n?"fail:"+n.message:"success:match="+a)),n||!a)return t._logger.log("trace","do oncheckfail actions"),void function(e){i.oncheckfail&&i.oncheckfail.length?actman.getActionManager().executeAction("rle:"+t._id+"@oncheckfail",i.oncheckfail,function(t){e(t);}):e();}(function(i){t._logger.log("trace","finish oncheckfail actions "+(i?"fail:"+i.message:"success"));var r="check triggers failed:"+(n?n.message:"device state not match");i&&(r+="; oncheckfail actions failed:"+i.message),e&&e(new Error(r));});t._logger.log("trace","do onchecksuccess actions"),function(e){i.onchecksuccess&&i.onchecksuccess.length?actman.getActionManager().executeAction("rle:"+t._id+"@onchecksuccess",i.onchecksuccess,function(t){e(t);}):e();}(function(i){t._logger.log("trace","finish onchecksuccess actions "+(i?"fail:"+i.message:"success")),i?e&&e(new Error("onchecksuccess actions failed:"+i.message)):(t._logger.log("trace","do onactivation actions"),r(function(i){t._logger.log("trace","finish onactivation actions "+(i?"fail:"+i.message:"success")),t._json.active=1,t._logger.log("trace","save rule activated"),function(e){t._ruleManager.onRuleChanged(t._id,e);}(function(i){t._logger.log("trace","finish save rule activated "+(i?"fail:"+i.message:"success")),e&&e(i?new Error("save rule activated failed:"+i.message):null);});}));});});},n.prototype.onTriggered=function(e,t){this._triggerDelayTimeout&&(clearTimeout(this._triggerDelayTimeout),this._triggerDelayTimeout=null);var i=this;t.delay?(this._logger.log("trace","triggered by trigger("+e+") with delay "+t.delay),this._triggerDelayTimeout=setTimeout(function(){i._logger.log("trace","do delayed action by trigger("+e+")"),i.doActions();},1e3*t.delay)):(this._logger.log("trace","triggered by trigger("+e+") and do actions"),this.doActions());},n.prototype._hitDeviceTrigger=function(e,t,r,n){var a=this;i.prototype._hitDeviceTrigger.call(this,e,t,r,function(i,r){!i&&r?(t.state&&t.state.ontrigger&&(a._logger.log("trace","do trigger("+e+") ontrigger actions"),actman.getActionManager().executeAction("rle:"+a._id+"@t"+e+"-ontrigger",t.state.ontrigger,function(t){a._logger.log("trace","do trigger("+e+") ontrigger actions "+(t?"fail:"+t.message:"success"));})),n(null,r)):n(i,r);});};var a=function a(e){i.call(this,e);};util.inherits(a,i),a.prototype.onTriggered=function(e,t){this._logger.log("trace","triggered by periods with index ["+e+"]");var i=JSON.parse(JSON.stringify(t));i.command||(i.command="temperature");var r=this._json;if(r&&r.devices&&r.devices.length>0){for(var n=[],a=0;a<r.devices.length;a++){var o=r.devices[a];if(o)try{var s=JSON.parse(JSON.stringify(o));for(var c in i)s[c]=i[c];n.push(s);}catch(e){}}this._logger.log("trace","do actions"),actman.getActionManager().executeAction("rle:"+this._id,n,function(e){callback&&callback(e);});}},a.prototype.onTimerTick=function(e){if(this._json){var t=this.isActive(),i=this.matchTimeRequirement(e);if(t&&i){var r=this._json;if(r.periods&&0!=r.periods.length)for(var n=0;n<r.periods.length;n++){var a=r.periods[n];if(this._hitPeriodTrigger(a,e))return this._logger.log("trace","active:"+t+" | date match:"+i+" | time trigger hit"),void this.onTriggered(n,a);}}}},a.prototype.onDeviceEvent=function(e,t){},a.prototype._hitPeriodTrigger=function(e,t){if(!e||!e.start)return!1;var i=e.start.split(":");if(i.length<2)return!1;var r=parseInt(i[0]),n=parseInt(i[1]);return r==t.hour()&&n==t.minute();};var o=function o(){this._logger=require("x.logger.js").getLogger("x.hub.rule.RuleManager"),this._dataFolder=null,this._rules=null,this._cronTimer=null,this._writing=!1,this._writeCallbacks=[];};return o.FILE_NAME="rule.json",o.prototype.init=function(e,i){this._logger.log("info","init rule manager"),this._dataFolder=e.getUserRootDataPath(),this._cronTimer=new t(this);var r=this;this._loadRules(function(e){e?i&&i(e):r._initRules(function(){i&&i();});});},o.prototype.getRules=function(){return this._rules;},o.prototype.getRule=function(e){return this._rules?this._rules[e]:null;},o.prototype.setRule=function(e,t,r){if(e){var n=this._rules[e];if(t){this._logger.log("trace","update rule "+e);var a=i.parseJSON(e,t);if(!a)return void(r&&r(new Error("invalid rule json")));a._ruleManager=this,this._rules[e]=a;}else this._logger.log("trace","delete rule "+e),delete this._rules[e];n&&(this._logger.log("trace","call finialize of old rule "+e),n.finalize()),this._writeRules(function(e){r&&r(e,t);});}else r&&r(new Error("invalid rule id"));},o.prototype.onRuleChanged=function(e,t){this._writeRules(function(e){t&&t(e);});},o.prototype.onTimerTick=function(e,t,i){if(this._rules)for(var r in this._rules){var n=this._rules[r];n&&n.onTimerTick(e,t,i);}},o.prototype.onLocationChange=function(e){this._logger.log("trace","receive location change event:"+JSON.stringify(e)),this._cronTimer.onLocationChange(e);},o.prototype.onTimeChange=function(e){this._logger.log("trace","receive time change event:"+JSON.stringify(e)),this._cronTimer.onTimeChange(e);},o.prototype.onDeviceEvent=function(t){this._logger.log("trace","receive "+t.type+" event from "+t.source+":"+JSON.stringify(t.value));var i=e.getMomentNow();for(var r in this._rules){var n=this._rules[r];n&&n.onDeviceEvent(t,i);}},o.prototype._initRules=function(e){this._cronTimer.start(),e();},o.prototype._loadRules=function(e){var t=require("fs-extra"),r=this._getFile(),n=this;t.ensureFile(r,function(t){t?e(t):n._loadFile(function(t,r){if(t)e(t);else{if(n._rules={},r)for(var a in r){var o=i.parseJSON(a,r[a]);o&&(o._ruleManager=n,n._rules[a]=o);}e();}});});},o.prototype._writeRules=function(e){if(e&&-1==this._writeCallbacks.indexOf(e)&&this._writeCallbacks.push(e),!this._writing&&this._writeCallbacks.length){this._writing=!0;var t=this._writeCallbacks;this._writeCallbacks=[];var i={};for(var r in this._rules){var n=this._rules[r];n&&n.toJSON&&(i[r]=n.toJSON());}var a=this;this._writeFile(i,function(e){a._writing=!1,t.forEach(function(t){try{t&&t(e);}catch(e){}}),a._writeRules();});}},o.prototype._getFile=function(){return require("path").resolve(this._dataFolder,o.FILE_NAME);},o.prototype._loadFile=function(e){var t=require("fs"),i=this._getFile();t.readFile(i,"utf8",function(t,i){if(t)e(t);else if(i)try{var r=JSON.parse(i);e(null,r);}catch(t){e(null,{});}else e(null,{});});},o.prototype._writeFile=function(e,t){var i=require("fs"),r=this._getFile();i.writeFile(r,JSON.stringify(e,null,2),function(e){t&&t(e);});},o.Util=e,o.Rule=i,o;}(),x.hub.rule.Handler=function(){var e=function e(){this._logger=require("x.logger.js").getLogger("x.hub.rule.Handler"),this._ruleManager=new x.hub.rule.RuleManager();};return e.prototype.RuleManager=x.hub.rule.RuleManager,e.prototype.init=function(e,t,i){var r=this;eventbus.on("locationchange",this._onLocationChange.bind(this)),eventbus.on("timechange",this._onTimeChange.bind(this)),eventbus.on("gatewayevent",function(e,t,i){r._onGatewayEvent(e,t,i);}),"CA"==global.HARDWARE_VERSION?this._initHttpApiNew(e):this._initHttpApi(e),this._ruleManager.init(t,function(e){e&&i(e);});},e.prototype.getRuleManager=function(){return this._ruleManager;},e.prototype._onLocationChange=function(e){this._logger.log("trace","receive location change event:"+JSON.stringify(e)),this._ruleManager.onLocationChange(e);},e.prototype._onTimeChange=function(e){this._logger.log("trace","receive time change event:"+JSON.stringify(e)),this._ruleManager.onTimeChange(e);},e.prototype._onGatewayEvent=function(e,t,i){this._logger.log("trace","receive gateway "+i+" event:"+JSON.stringify(e)+" from:"+JSON.stringify(t));var r="STA"==i?"state":"event",n=e;if(n){var a=this,o={source:t.address,type:r,value:n};process.nextTick(function(){a._ruleManager.onDeviceEvent(o);});}},e.prototype._initHttpApiNew=function(e){var t=this,i=require("x.hub.js").getServer();i.addRoute("/api/rules",{method:"GET",lock:function lock(e,t,i){return i._auth.checkLockWithRCS(e,t,i);}},function(e,i,r){var n=t._ruleManager.getRules();i.json({XC_SUC:n||{}});}),i.addRoute("/data/rle/",{method:"GET",lock:function lock(e,t,i){return i._auth.checkLockWithRCS(e,t,i);}},function(e,i,r){var n=e.path.substr(10),a=t._ruleManager.getRule(n);a?i.json({XC_SUC:a}):i.json({XC_ERR:{code:"000101",msg:"failed to open file"}});}),i.addRoute("/data/rle/",{method:"POST",lock:function lock(e,t,i){return i._auth.checkLockWithRCS(e,t,i);}},function(e,i){var r=e.path.substr(10);try{if("cloud"==e.source&&!e.rcs)return void i.json({XC_ERR:{code:"000008",msg:"only accessible when rcs set"}});var n=e.json;t._ruleManager.setRule(r,n,function(t,r){t?i.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+t.message}}):r?i.json({XC_SUC:{bytes:e.size}}):i.json({XC_SUC:{bytes:0}});});}catch(e){i.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+e.message}});}}),i.addRoute("/api/trigger",{method:"POST",lock:function lock(e,t,i){return i._auth.checkLockWithRCS(e,t,i);}},function(e,i){try{if("cloud"==e.source&&!e.rcs)return void i.json({XC_ERR:{code:"000008",msg:"only accessible when rcs set"}});var r=e.json;r&&"time"==r.type&&r.value?(i.json({XC_SUC:{}}),process.nextTick(function(){var e=require("moment-timezone"),i=taskman.Util._getTimeZone(),n=parseInt(r.value.split(":")[0]),a=parseInt(r.value.split(":")[1]),o=new Date();o.setHours(n),o.setMinutes(a),o=e.tz(o.getTime(),i);var s=x.hub.rule.RuleManager.Util.getAstro(o);t._ruleManager.onTimerTick(o,s[0],s[1]);})):r&&"event"==r.type&&r.value||r&&"state"==r.type&&r.value?(i.json({XC_SUC:{}}),process.nextTick(function(){t._ruleManager.onDeviceEvent({source:r.source?r.source:"ST",type:r.type,value:r.value});})):i.json({XC_ERR:{code:"000101",msg:"unknown trigger type"}});}catch(e){i.json({XC_ERR:{code:"000101",msg:"failed to trigger:"+e.message}});}});},e.prototype._initHttpApi=function(e){var t=this,i=require("x.hub.js").getServer();e.get("/api/rules",function(e,r,n){if(i.auth(e)){var a=t._ruleManager.getRules();r.json({XC_SUC:a||{}});}else r.json({XC_ERR:{code:"000007",msg:"access denied"}});}),e.get("/data/rle/:id",function(e,r,n){if(i.auth(e)){var a=e.params.id,o=t._ruleManager.getRule(a);o?r.json({XC_SUC:o}):r.json({XC_ERR:{code:"000101",msg:"failed to open file"}});}else r.json({XC_ERR:{code:"000007",msg:"access denied"}});}),e.post("/data/rle/:id",function(e,r){if(i.auth(e)){var n=new Buffer(0);e.on("data",function(e){n=Buffer.concat([n,e]);}),e.on("end",function(){var i=e.params.id,a=n.toString("utf8");try{var o=null;a&&(o=JSON.parse(a)),t._ruleManager.setRule(i,o,function(e,t){e?r.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+e.message}}):t?r.json({XC_SUC:{bytes:n.length}}):r.json({XC_SUC:{bytes:0}});});}catch(e){r.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+e.message}});}});}else r.json({XC_ERR:{code:"000007",msg:"access denied"}});}),e.post("/api/trigger",function(e,r){if(i.auth(e)){var n=new Buffer(0);e.on("data",function(e){n=Buffer.concat([n,e]);}),e.on("end",function(){var e=n.toString("utf8");try{var i=null;if(e&&(i=JSON.parse(e)),i&&"time"==i.type&&i.value){var a=require("moment-timezone"),o=taskman.Util._getTimeZone(),s=parseInt(i.value.split(":")[0]),c=parseInt(i.value.split(":")[1]),g=new Date();g.setHours(s),g.setMinutes(c),g=a.tz(g.getTime(),o);var l=x.hub.rule.RuleManager.Util.getAstro(g);t._ruleManager.onTimerTick(g,l[0],l[1]),r.json({XC_SUC:{}});}else r.json({XC_ERR:{code:"000101",msg:"unknown trigger type"}});}catch(e){r.json({XC_ERR:{code:"000101",msg:"failed to trigger:"+e.message}});}});}else r.json({XC_ERR:{code:"000007",msg:"access denied"}});});},e;}(),module.exports=new x.hub.rule.Handler();