var util=require("util"),taskman=require("x.hub.taskman.js"),actman=require("x.hub.action.js"),commandman=require("x.hub.commandman.js"),eventbus=require("x.hub.eventbus.js"),moment=require("moment-timezone"),x=x||{};x.hub=x.hub||{};x.hub.rule=x.hub.rule||{};
x.hub.rule.RuleManager=function(){var q={getMomentNow:function(){var a=taskman.Util._getTimeZone(),b=(new Date).getTime();a=moment.tz(b,a);a.second(0);a.millisecond(0);return a},getAstro:function(a){var b=taskman.Util._getlatlong(),c=require("suncalc"),d=c.getTimes(a.toDate(),b.lat,b.long),e=taskman.Util._getTimeZone(),f=moment.tz(d.sunrise,e);d=moment.tz(d.sunset,e);if(f.date()!=a.date()||d.date()!=a.date())a.add(12,"h"),d=c.getTimes(a.toDate(),b.lat,b.long),f=moment.tz(d.sunrise,e),d=moment.tz(d.sunset,
e);f.second(0);f.millisecond(0);d.second(0);d.millisecond(0);return[f,d]},matchDate:function(a,b){if(!a)throw Error("invalid momentNow argument");if(!b)return!0;var c=a.tz(),d=a.valueOf();if(b.start&&"0000-00-00"!=b.start){var e=moment.tz(b.start,c);e.set({hour:0,minute:0,second:0,millisecond:0});if(e.valueOf()>d)return!1}return b.end&&"0000-00-00"!=b.end&&(c=moment.tz(b.end,c),c.set({hour:23,minute:59,second:59,millisecond:999}),c.valueOf()<d)||b.days&&(a=a.day(),0==a&&(a=7),"1"!=b.days.charAt(a-
1))?!1:!0},calculateAstroTarget:function(a,b,c,d){if(!(a&&b&&c&&d))return null;var e=null;if("sunrise"==d.substr(0,7)){if(e=b,"+"==d.charAt(7)||"-"==d.charAt(7))b=parseInt(d.substr(7)),e.add(b,"minutes")}else"sunset"==d.substr(0,6)&&(e=c,"+"==d.charAt(6)||"-"==d.charAt(6))&&(b=parseInt(d.substr(6)),e.add(b,"minutes"));if(!e)return null;b=moment(a);b.hour(0);b.minute(0);b.second(0);b.millisecond(0);a=moment(a);a.hour(23);a.minute(59);a.second(59);a.millisecond(999);e.isBefore(b)?e=b:e.isAfter(a)&&
(e=a);return e},calculateTimeTarget:function(a,b){if(!a||!b)return null;var c=b.split(":");if(2!=c.length)return null;b=parseInt(c[0]);c=parseInt(c[1]);if(isNaN(b)||isNaN(c)||0>b||23<b||0>c||59<c)return null;a=moment(a);a.hour(b);a.minute(c);a.second(0);a.millisecond(0);return a}},m=function(a){this._logger=require("x.logger.js").getLogger("x.hub.rule.RuleManager.CronTimer");this._ruleManager=a;this._cronJob=null};m.prototype.start=function(){var a=taskman.Util._getTimeZone();this._logger.log("trace",
"start cron job:00 * * * * * tz:"+a);this._cronJob=new (require("cron").CronJob)("00 * * * * *",this.onTick.bind(this),null,!0,a)};m.prototype.stop=function(){this._logger.log("debug","stop timer:"+JSON.stringify(this.timer));this._cronJob&&(this._cronJob.stop(),this._cronJob=null)};m.prototype.onTick=function(){this._logger.log("trace","timer tick");var a=q.getMomentNow(),b=q.getAstro(a);this._ruleManager.onTimerTick(a,b[0],b[1])};m.prototype.onLocationChange=function(){this.stop();this.start()};
m.prototype.onTimeChange=function(){this.stop();this.start()};var h=function(a){this._logger=require("x.logger.js").getLogger("x.hub.rule.RuleManager.Rule.#"+a);this._id=a;this._ruleManager=this._json=null;this._state=0;this._activateCallbacks=[];this._pendingTriggers={};this._delayedTriggers=[]};h.prototype.finalize=function(){for(var a in this._pendingTriggers){var b=this._pendingTriggers[a];b&&clearTimeout(b)}for(a=0;a<this._delayedTriggers.length;a++)(b=this._delayedTriggers[a])&&b.timeout&&clearTimeout(b.timeout);
this._pendingTriggers={};this._delayedTriggers=[]};h.prototype.executeCommand=function(a,b){a&&a.command?"activate"==a.command?this.setActive(!0,function(a){b&&b(a)}):"deactivate"==a.command?this.setActive(!1,function(a){b&&b(a)}):"execute"==a.command?this.doActions(function(a){b&&b(a)}):b&&b(Error("invalid command")):b&&b(Error("invalid command"))};h.prototype.getStates=function(a){a&&a(null,{active:this.isActive()})};h.prototype.isActive=function(){return this._json&&1==this._json.active};h.prototype.setActive=
function(a,b){if(this._json){var c=this.isActive();if(c&&a||!c&&!a)b&&b();else if(1!=this._state||a)if(2==this._state&&a)b&&b(Error("deactivate process is rinning"));else{if(b&&-1==this._activateCallbacks.indexOf(b)&&this._activateCallbacks.push(b),0==this._state){var d=this;this._state=a?1:2;this[a?"_doActivate":"_doDeactivate"](function(a){d._state=0;var b=d._activateCallbacks;d._activateCallbacks=[];b.forEach(function(b){try{b&&b(a)}catch(n){}})})}}else b&&b(Error("activate process is rinning"))}else b&&
b(Error("invalid rule"))};h.prototype._doActivate=function(a){this._json.active=1;this._ruleManager.onRuleChanged(this._id,function(b){a&&a(b)})};h.prototype._doDeactivate=function(a){this._json.active=0;this._ruleManager.onRuleChanged(this._id,function(b){a&&a(b)})};h.prototype.matchTimeRequirement=function(a){return this._json?q.matchDate(a,this._json):!1};h.prototype.getType=function(){return this._json?this._json.type:null};h.prototype.doActions=function(a){if(this._json)if(this._json.actions&&
this._json.actions.length){this._logger.log("trace","do actions");var b=this,c=actman.getActionManager(),d="executeAction";1==this._json.restart&&(d="executeActionSingelton");c[d]("rle:"+this._id,this._json.actions,function(c){b._logger.log("trace","finish do actions "+(c?"failed:"+c.message:"success"));a&&a(c)})}else a&&a();else a&&a(Error("invalid rule"))};h.prototype.onTriggered=function(a,b){this._logger.log("trace","triggered by trigger with index ["+a+"]");this.doActions()};h.prototype.onDeviceEvent=
function(a,b){if(this._json){var c=this.isActive();b=this.matchTimeRequirement(b);this._logger.log("trace","active:"+c+" | date match:"+b+" | check device event:"+JSON.stringify(a));if(c&&b){var d=this._json;if(d.trigger&&d.trigger.length){var e=this,f=0,k=[],n=function(b,c,t){!b&&c?d.trigger[f].delay?e._addDelayedTrigger(f):d.trigger[f].dur?e._addPendingTrigger(f):k.push(f):b||c||!t||d.trigger[f].dur&&e._removePendingTrigger(f);f++;if(f<d.trigger.length)e._hitDeviceTrigger(f,d.trigger[f],a,n);else if(k.length)e.onTriggered(k[0],
d.trigger[k[0]]);else e._logger.log("trace","no trigger hit")};this._hitDeviceTrigger(f,d.trigger[f],a,n)}}}};h.prototype._addDelayedTrigger=function(a){var b=this._json.trigger[a],c=this,d={triggerIdx:a,timeout:setTimeout(function(){var a=c._delayedTriggers.indexOf(d);-1!=a&&c._delayedTriggers.splice(a,1);c.onTriggered(d.triggerIdx,b)},1E3*parseFloat(b.delay))};this._delayedTriggers.push(d)};h.prototype._addPendingTrigger=function(a){var b=this._json.trigger[a];if(!this._pendingTriggers[a]){var c=
this;this._pendingTriggers[a]=setTimeout(function(){delete c._pendingTriggers[a];c.onTriggered(a,b)},1E3*parseFloat(b.dur))}};h.prototype._removePendingTrigger=function(a){if(this._pendingTriggers[a]){var b=this._pendingTriggers[a];b&&clearTimeout(b);delete this._pendingTriggers[a]}};h.prototype.onTimerTick=function(a,b,c){if(this._json){var d=this.isActive(),e=this.matchTimeRequirement(a);if(d&&e){var f=this._json;if(f.trigger&&f.trigger.length)for(var k=0;k<f.trigger.length;k++){var n=f.trigger[k];
if(this._hitTimeTrigger(n,a,b,c)){this._logger.log("trace","active:"+d+" | date match:"+e+" | time trigger hit");this.onTriggered(k,n);break}}}}};h.prototype.toJSON=function(){return this._json};h.prototype._hitDeviceTrigger=function(a,b,c,d){var e=!1;a=function(a,b){if(!a)return!1;var c=b.type,d=b.value;if("event"==c){if(!a.event)return!1;d.sys||(d.sys="mediola");return a.event.sys==d.sys&&"mediola"==d.sys&&a.event.data?a.event.data.type==d.type&&a.event.data.data==d.data:!1}if("state"==c){if(!(a.state&&
a.state.devices&&a.state.devices.length&&a.state.data&&a.state.data.length))return!1;c={};for(var f in d.state)d.changed&&-1!=d.changed.indexOf(f)&&(c[f]=d.state[f]);for(d=0;d<a.state.devices.length;d++)if(c=a.state.devices[d])if(c=commandman.commandHandlerV6.resolveDeviceStates(c,b))for(e=!0,f=0;f<a.state.data.length;f++){var k=a.state.data[f];if(k&&commandman.commandHandlerV6.matchDeviceState(c,k))return!0}}return!1}(b,c);d(null,a,e)};h.prototype._hitTimeTrigger=function(a,b,c,d){if(!a)return!1;
if(a.time){if(!b)return!1;var e=a.time.split(":");if(2>e.length)return!1;c=parseInt(e[0]);e=parseInt(e[1]);return c==b.hour()&&e==b.minute()}if(a.astro){if(!c||!d)return!1;d=q.calculateAstroTarget(b,c,d,a.astro);if(!d)return!1;var f=null,k=null;a.earliest&&(e=a.earliest.split(":"),2<=e.length&&(c=parseInt(e[0]),e=parseInt(e[1]),f=moment(b),f.hour(parseInt(c)),f.minute(parseInt(e)),f.second(0),f.millisecond(0)));a.latest&&(e=a.latest.split(":"),2<=e.length&&(c=parseInt(e[0]),e=parseInt(e[1]),k=moment(b),
k.hour(parseInt(c)),k.minute(parseInt(e)),k.second(0),k.millisecond(0)));if(f&&k&&f.isAfter(k))return!1;f&&d.isBefore(f)&&(d=f);k&&d.isAfter(k)&&(d=k);return d.hour()==b.hour()&&d.minute()==b.minute()}return!1};h.parseJSON=function(a,b){if(!a||!b)return null;switch(b.type){case "heatingschedule":a=new g(a);break;case "link":a=new u(a);break;case "alarm":a=new l(a);break;default:a=new h(a)}a._json=b;return a};var u=function(a){h.call(this,a);this._stateBuffer=null};util.inherits(u,h);u.prototype.onDeviceEvent=
function(a,b){if(this._json){var c=a.type;a=a.value;this._logger.log("trace","check link device with "+c+":"+JSON.stringify(a));if(this._json.link&&this._json.link.device){b=this._json.link;var d=b.device;if("state"==c&&a.state&&(c=!1,d.device&&d.device.id&&d.device.id==a.sid&&(c=!0),c)){this._logger.log("trace","match link device");c=!1;d=[];if(b.value){var e=!0;a.changed&&-1==a.changed.indexOf(b.value)&&(e=!1);var f=a.state[b.value];void 0!=f&&null!=f&&e&&(c=!0,this._logger.log("trace","match link device state:"+
b.value),b.command&&d.push({command:b.command,value:f}))}else if(b.values&&b.values.length)for(var k=0;k<b.values.length;k++){var n=b.values[k];if(!n)return;var g=n.value;g||(g="state");e=!0;a.changed&&-1==a.changed.indexOf(g)&&(e=!1);f=a.state[g];if(void 0!=f&&null!=f&&e){if(n.hyst)if(f=parseFloat(f),e=this._stateBuffer?this._stateBuffer[g]:null,void 0!=e&&null!=e){if(f-e>n.hyst||e-f>n.hyst)c=!0}else c=!0;else n.states?(1==f||"true"==f?c=-1!=n.states.indexOf(!0)||-1!=n.states.indexOf("true"):0==
f||"false"==f?c=-1!=n.states.indexOf(!1)||-1!=n.states.indexOf("false"):-1!=n.states.indexOf(f)&&(c=!0),f=null):c=!0;this._logger.log("trace","match link device values("+k+") state:"+g);if(n.ranges&&n.ranges.length)for(f=parseFloat(f),e=0;e<n.ranges.length;e++){var r=n.ranges[e];if(r&&!(void 0!=r.to&&null!=r.to&&f>r.to||void 0!=r.from&&null!=r.from&&f<r.from)){var t=null;r.command?t=r.command:n.command&&(t=n.command);r=void 0!=r.value&&null!=r.value?r.value:f;void 0!=t&&null!=t&&d.push({command:t,
value:r,source:g})}}else n.command?d.push({command:n.command,value:f,source:g}):d.push({command:f,source:g})}}this._stateBuffer=a.state;c&&d.length&&this._doAction(d)}}}};u.prototype._doAction=function(a){if(this._json)if(this._logger.log("trace","forward commands:"+JSON.stringify(a)),this._json.devices&&this._json.devices.length){for(var b=this._json.devices,c=[],d=0;d<b.length;d++){var e=b[d];if(e)for(var f=0;f<a.length;f++){var k=a[f];if(k){var n=JSON.parse(JSON.stringify(e)),g;for(g in k)n[g]=
k[g];c.push(n)}}}if(c.length){this._logger.log("trace","do actions");var r=this;actman.getActionManager().executeActionSingelton("rle:"+this._id,c,function(a){r._logger.log("trace","finish do actions "+(a?"failed:"+a.message:"success"));callback&&callback(a)})}else this._logger.log("trace","no devices")}else this._logger.log("trace","no devices")};var l=function(a){h.call(this,a);this._triggerDelayTimeout=null};util.inherits(l,h);l.prototype.finalize=function(){this._triggerDelayTimeout&&(clearTimeout(this._triggerDelayTimeout),
this._triggerDelayTimeout=null)};l.prototype._doDeactivate=function(a){var b=this,c=this._json;this._logger.log("trace","do ondeactivation actions");(function(a){var d=function(a,c,d){if(c&&c.state&&c.state.ondeactivate&&c.state.devices&&c.state.devices.length)try{var e=[];c.state.devices.forEach(function(a){a=JSON.parse(JSON.stringify(a));for(var b in c.state.ondeactivate)a[b]=c.state.ondeactivate[b];e.push(a)});e.length?actman.getActionManager().executeAction("rle:"+b._id+"@t"+a+"-ondeactivate",
e,function(a){d(a)}):d()}catch(t){d(t)}else b._logger.log("trace","trigger("+a+") has no ondeactivate actions"),d()},f=function(a){if(c.trigger&&c.trigger.length){var e=0,f=[],g=function(k){b._logger.log("trace","do trigger("+e+") ondeactivation actions "+(k?"fail:"+k.message:"success"));k&&f.push(e);e++;e<c.trigger.length?(b._logger.log("trace","do trigger("+e+") ondeactivation actions"),d(e,c.trigger[e],g)):a(f.length?Error("ondeactivation actions failed for triggers ["+f.join(",")+"]"):null)};
b._logger.log("trace","do trigger("+e+") ondeactivation actions");d(e,c.trigger[e],g)}else a()};b._logger.log("trace","do main ondeactivation actions");(function(a){c.ondeactivation&&c.ondeactivation.length?actman.getActionManager().executeAction("rle:"+b._id+"@ondeactivation",c.ondeactivation,function(b){a(b)}):a()})(function(c){b._logger.log("trace","finish main ondeactivation actions "+(c?"fail:"+c.message:"success"));b._logger.log("trace","do triggers ondeactivation actions");f(function(d){b._logger.log("trace",
"finish triggers ondeactivation actions "+(d?"fail:"+d.message:"success"));var e=null;if(c||d)e=c?"main ondeactivation failed":"",e=Error(e+((e?", ":"")+d?"triggers ondeactivation failed":""));a(e)})})})(function(c){b._logger.log("trace","finish ondeactivation actions "+(c?"fail:"+c.message:"success"));b._json.active=0;b._logger.log("trace","save rule deactivated");b._ruleManager.onRuleChanged(b._id,function(c){b._logger.log("trace","finish save rule deactivated "+(c?"fail:"+c.message:"success"));
a&&a(c?Error("save rule deactivated failed:"+c.message):null)})})};l.prototype._doActivate=function(a){var b=this,c=this._json,d=function(a){var d=function(a,c,d){if(c&&c.state&&c.state.onactivate&&c.state.devices&&c.state.devices.length)try{var e=[];c.state.devices.forEach(function(a){a=JSON.parse(JSON.stringify(a));for(var b in c.state.onactivate)a[b]=c.state.onactivate[b];e.push(a)});e.length?actman.getActionManager().executeAction("rle:"+b._id+"@t"+a+"-onactivate",e,function(a){d(a)}):d()}catch(w){d(w)}else b._logger.log("trace",
"trigger("+a+") has no onactivate actions"),d()},e=function(a){if(c.trigger&&c.trigger.length){var e=0,f=[],g=function(k){b._logger.log("trace","do trigger("+e+") onactivation actions "+(k?"fail:"+k.message:"success"));k&&f.push(e);e++;e<c.trigger.length?(b._logger.log("trace","do trigger("+e+") onactivation actions"),d(e,c.trigger[e],g)):a(f.length?Error("onactivation actions failed for triggers ["+f.join(",")+"]"):null)};b._logger.log("trace","do trigger("+e+") onactivation actions");d(e,c.trigger[e],
g)}else a()};b._logger.log("trace","do main onactivation actions");(function(a){c.onactivation&&c.onactivation.length?actman.getActionManager().executeAction("rle:"+b._id+"@onactivation",c.onactivation,function(b){a(b)}):a()})(function(c){b._logger.log("trace","finish main onactivation actions "+(c?"fail:"+c.message:"success"));b._logger.log("trace","do triggers onactivation actions");e(function(d){b._logger.log("trace","finish triggers onactivation actions "+(d?"fail:"+d.message:"success"));var e=
null;if(c||d)e=c?"main onactivation failed":"",e=Error(e+((e?",":"")+d?"triggers onactivation failed":""));a(e)})})},e=function(a){c.onchecksuccess&&c.onchecksuccess.length?actman.getActionManager().executeAction("rle:"+b._id+"@onchecksuccess",c.onchecksuccess,function(b){a(b)}):a()},f=function(a){c.oncheckfail&&c.oncheckfail.length?actman.getActionManager().executeAction("rle:"+b._id+"@oncheckfail",c.oncheckfail,function(b){a(b)}):a()},g=function(a,b){commandman.commandHandlerV6.getDeviceStatesWithStateInfo(a,
b)},h=function(a,c,d,e,f){if(e){var k=c.state.check;c=c.state.data;var h=[],l=!0;k&&k.length?(k.forEach(function(a){a&&a.states&&a.states.length&&(a=JSON.parse(JSON.stringify(a)),a.value||(a.value="state"),h.push(a))}),l=!0):c&&c.length&&(c.forEach(function(a){a&&a.states&&a.states.length&&(a=JSON.parse(JSON.stringify(a)),a.value||(a.value="state"),h.push(a))}),l=!1);h.length?g(e,function(c,e){if(c)b._logger.log("trace","get trigger("+a+") device("+d+") states fail:"+c.message),f(c);else if(e){for(c=
0;c<h.length;c++){var g=e[h[c].value];if(void 0==g||null==g){b._logger.log("trace","check trigger("+a+") device("+d+") state "+h[c].value+" fail: value unknown");f(Error("state value unknown"));return}b._logger.log("trace","check trigger("+a+") device("+d+") state "+h[c].value+"="+g);var k=!1;l&&-1!=h[c].states.indexOf(g)?k=!0:l||-1!=h[c].states.indexOf(g)||(k=!0);if(!k){f(null,k);return}}f(null,!0)}else b._logger.log("trace","check trigger("+a+") device("+d+") state fail: states response is null"),
f(Error("states response is null"))}):(b._logger.log("trace","get trigger("+a+") device("+d+") has no states to check"),f(null,!0))}else b._logger.log("trace","get trigger("+a+") device("+d+") json is null"),f(null,!0)},l=function(a,c,d){if(c&&c.state&&c.state.devices&&c.state.devices.length){var e=0,f=function(g,k){b._logger.log("trace","check trigger("+a+") device("+e+") "+(g?"fail:"+g.message:"success:match="+k));g||!k?d(g,k):(e++,e<c.state.devices.length?(b._logger.log("trace","check trigger("+
a+") device("+e+")"),h(a,c,e,c.state.devices[e],f)):d(null,!0))};b._logger.log("trace","check trigger("+a+") device("+e+")");h(a,c,e,c.state.devices[e],f)}else b._logger.log("trace","trigger("+a+") has no checkable devices"),d(null,!0)};this._logger.log("trace","check triggers (value="+c.checktriggers+")");(function(a){if(1!=c.checktriggers)a(null,!0);else if(c.trigger&&c.trigger.length){var d=0,e=function(f,g){b._logger.log("trace","check trigger("+d+") "+(f?"fail:"+f.message:"success:match="+g));
f||!g?a(f,g):(d++,d<c.trigger.length?(b._logger.log("trace","check trigger("+d+")"),l(d,c.trigger[d],e)):a(null,!0))};b._logger.log("trace","check trigger("+d+")");l(d,c.trigger[d],e)}else a()})(function(c,g){b._logger.log("trace","finish check triggers "+(c?"fail:"+c.message:"success:match="+g));c||!g?(b._logger.log("trace","do oncheckfail actions"),f(function(d){b._logger.log("trace","finish oncheckfail actions "+(d?"fail:"+d.message:"success"));var e="check triggers failed:"+(c?c.message:"device state not match");
d&&(e+="; oncheckfail actions failed:"+d.message);a&&a(Error(e))})):(b._logger.log("trace","do onchecksuccess actions"),e(function(c){b._logger.log("trace","finish onchecksuccess actions "+(c?"fail:"+c.message:"success"));c?a&&a(Error("onchecksuccess actions failed:"+c.message)):(b._logger.log("trace","do onactivation actions"),d(function(c){b._logger.log("trace","finish onactivation actions "+(c?"fail:"+c.message:"success"));b._json.active=1;b._logger.log("trace","save rule activated");b._ruleManager.onRuleChanged(b._id,
function(c){b._logger.log("trace","finish save rule activated "+(c?"fail:"+c.message:"success"));a&&a(c?Error("save rule activated failed:"+c.message):null)})}))}))})};l.prototype.onTriggered=function(a,b){this._triggerDelayTimeout&&(clearTimeout(this._triggerDelayTimeout),this._triggerDelayTimeout=null);var c=this;b.delay?(this._logger.log("trace","triggered by trigger("+a+") with delay "+b.delay),this._triggerDelayTimeout=setTimeout(function(){c._logger.log("trace","do delayed action by trigger("+
a+")");c.doActions()},1E3*b.delay)):(this._logger.log("trace","triggered by trigger("+a+") and do actions"),this.doActions())};l.prototype._hitDeviceTrigger=function(a,b,c,d){var e=this;h.prototype._hitDeviceTrigger.call(this,a,b,c,function(c,g){c||!g?d(c,g):(b.state&&b.state.ontrigger&&(e._logger.log("trace","do trigger("+a+") ontrigger actions"),actman.getActionManager().executeAction("rle:"+e._id+"@t"+a+"-ontrigger",b.state.ontrigger,function(b){e._logger.log("trace","do trigger("+a+") ontrigger actions "+
(b?"fail:"+b.message:"success"))})),d(null,g))})};var g=function(a){h.call(this,a)};util.inherits(g,h);g.prototype.onTriggered=function(a,b){this._logger.log("trace","triggered by periods with index ["+a+"]");a=JSON.parse(JSON.stringify(b));a.command||(a.command="temperature");if((b=this._json)&&b.devices&&0<b.devices.length){for(var c=[],d=0;d<b.devices.length;d++){var e=b.devices[d];if(e)try{var f=JSON.parse(JSON.stringify(e)),g;for(g in a)f[g]=a[g];c.push(f)}catch(n){}}this._logger.log("trace",
"do actions");actman.getActionManager().executeAction("rle:"+this._id,c,function(a){callback&&callback(a)})}};g.prototype.onTimerTick=function(a){if(this._json){var b=this.isActive(),c=this.matchTimeRequirement(a);if(b&&c){var d=this._json;if(d.periods&&0!=d.periods.length)for(var e=0;e<d.periods.length;e++){var f=d.periods[e];if(this._hitPeriodTrigger(f,a)){this._logger.log("trace","active:"+b+" | date match:"+c+" | time trigger hit");this.onTriggered(e,f);break}}}}};g.prototype.onDeviceEvent=function(a,
b){};g.prototype._hitPeriodTrigger=function(a,b){if(!a||!a.start)return!1;var c=a.start.split(":");if(2>c.length)return!1;a=parseInt(c[0]);c=parseInt(c[1]);return a==b.hour()&&c==b.minute()};var p=function(){this._logger=require("x.logger.js").getLogger("x.hub.rule.RuleManager");this._cronTimer=this._rules=this._dataFolder=null;this._writing=!1;this._writeCallbacks=[]};p.FILE_NAME="rule.json";p.prototype.init=function(a,b){this._logger.log("info","init rule manager");this._dataFolder=a.getUserRootDataPath();
this._cronTimer=new m(this);var c=this;this._loadRules(function(a){a?b&&b(a):c._initRules(function(){b&&b()})})};p.prototype.getRules=function(){return this._rules};p.prototype.getRule=function(a){return this._rules?this._rules[a]:null};p.prototype.setRule=function(a,b,c){if(a){var d=this._rules[a];if(b){this._logger.log("trace","update rule "+a);var e=h.parseJSON(a,b);if(!e){c&&c(Error("invalid rule json"));return}e._ruleManager=this;this._rules[a]=e}else this._logger.log("trace","delete rule "+
a),delete this._rules[a];d&&(this._logger.log("trace","call finialize of old rule "+a),d.finalize());this._writeRules(function(a){c&&c(a,b)})}else c&&c(Error("invalid rule id"))};p.prototype.onRuleChanged=function(a,b){this._writeRules(function(a){b&&b(a)})};p.prototype.onTimerTick=function(a,b,c){if(this._rules)for(var d in this._rules){var e=this._rules[d];if(e)e.onTimerTick(a,b,c)}};p.prototype.onLocationChange=function(a){this._logger.log("trace","receive location change event:"+JSON.stringify(a));
this._cronTimer.onLocationChange(a)};p.prototype.onTimeChange=function(a){this._logger.log("trace","receive time change event:"+JSON.stringify(a));this._cronTimer.onTimeChange(a)};p.prototype.onDeviceEvent=function(a){this._logger.log("trace","receive "+a.type+" event from "+a.source+":"+JSON.stringify(a.value));var b=q.getMomentNow(),c;for(c in this._rules){var d=this._rules[c];if(d)d.onDeviceEvent(a,b)}};p.prototype._initRules=function(a){this._cronTimer.start();a()};p.prototype._loadRules=function(a){var b=
require("fs-extra"),c=this._getFile(),d=this;b.ensureFile(c,function(b){b?a(b):d._loadFile(function(b,c){if(b)a(b);else{d._rules={};if(c)for(var e in c)if(b=h.parseJSON(e,c[e]))b._ruleManager=d,d._rules[e]=b;a()}})})};p.prototype._writeRules=function(a){a&&-1==this._writeCallbacks.indexOf(a)&&this._writeCallbacks.push(a);if(!this._writing&&this._writeCallbacks.length){this._writing=!0;var b=this._writeCallbacks;this._writeCallbacks=[];a={};for(var c in this._rules){var d=this._rules[c];d&&d.toJSON&&
(a[c]=d.toJSON())}var e=this;this._writeFile(a,function(a){e._writing=!1;b.forEach(function(b){try{b&&b(a)}catch(n){}});e._writeRules()})}};p.prototype._getFile=function(){return require("path").resolve(this._dataFolder,p.FILE_NAME)};p.prototype._loadFile=function(a){var b=require("fs"),c=this._getFile();b.readFile(c,"utf8",function(b,c){if(b)a(b);else if(c)try{var d=JSON.parse(c);a(null,d)}catch(k){a(null,{})}else a(null,{})})};p.prototype._writeFile=function(a,b){var c=require("fs"),d=this._getFile();
c.writeFile(d,JSON.stringify(a,null,2),function(a){b&&b(a)})};p.Util=q;p.Rule=h;return p}();
x.hub.rule.Handler=function(){var q=function(){this._logger=require("x.logger.js").getLogger("x.hub.rule.Handler");this._ruleManager=new x.hub.rule.RuleManager};q.prototype.RuleManager=x.hub.rule.RuleManager;q.prototype.init=function(m,h,u){var l=this;eventbus.on("locationchange",this._onLocationChange.bind(this));eventbus.on("timechange",this._onTimeChange.bind(this));eventbus.on("gatewayevent",function(g,h,a){l._onGatewayEvent(g,h,a)});"CA"==global.HARDWARE_VERSION?this._initHttpApiNew(m):this._initHttpApi(m);
this._ruleManager.init(h,function(g){g&&u(g)})};q.prototype.getRuleManager=function(){return this._ruleManager};q.prototype._onLocationChange=function(m){this._logger.log("trace","receive location change event:"+JSON.stringify(m));this._ruleManager.onLocationChange(m)};q.prototype._onTimeChange=function(m){this._logger.log("trace","receive time change event:"+JSON.stringify(m));this._ruleManager.onTimeChange(m)};q.prototype._onGatewayEvent=function(m,h,u){this._logger.log("trace","receive gateway "+
u+" event:"+JSON.stringify(m)+" from:"+JSON.stringify(h));if(m){var l=this,g={source:h.address,type:"STA"==u?"state":"event",value:m};process.nextTick(function(){l._ruleManager.onDeviceEvent(g)})}};q.prototype._initHttpApiNew=function(m){var h=this;m=require("x.hub.js").getServer();m.addRoute("/api/rules",{method:"GET"},function(m,l,g){m=h._ruleManager.getRules();l.json({XC_SUC:m?m:{}})});m.addRoute("/data/rle/",{method:"GET"},function(m,l,g){m=m.path.substr(10);(m=h._ruleManager.getRule(m))?l.json({XC_SUC:m}):
l.json({XC_ERR:{code:"000101",msg:"failed to open file"}})});m.addRoute("/data/rle/",{method:"POST",lock:1},function(m,l){var g=m.path.substr(10);try{h._ruleManager.setRule(g,m.json,function(g,a){g?l.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+g.message}}):a?l.json({XC_SUC:{bytes:m.size}}):l.json({XC_SUC:{bytes:0}})})}catch(p){l.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+p.message}})}});m.addRoute("/api/trigger",{method:"POST"},function(m,l){try{var g=m.json;g&&"time"==g.type&&
g.value?(l.json({XC_SUC:{}}),process.nextTick(function(){var l=require("moment-timezone"),a=taskman.Util._getTimeZone(),b=parseInt(g.value.split(":")[0]),c=parseInt(g.value.split(":")[1]),d=new Date;d.setHours(b);d.setMinutes(c);d=l.tz(d.getTime(),a);h._ruleManager.onTimerTick(d)})):g&&"event"==g.type&&g.value?(l.json({XC_SUC:{}}),process.nextTick(function(){h._ruleManager.onDeviceEvent({source:g.source?g.source:"ST",type:g.type,value:g.value})})):g&&"state"==g.type&&g.value?(l.json({XC_SUC:{}}),
process.nextTick(function(){h._ruleManager.onDeviceEvent({source:g.source?g.source:"ST",type:g.type,value:g.value})})):l.json({XC_ERR:{code:"000101",msg:"unknown trigger type"}})}catch(p){l.json({XC_ERR:{code:"000101",msg:"failed to trigger:"+p.message}})}})};q.prototype._initHttpApi=function(m){var h=this,q=require("x.hub.js").getServer();m.get("/api/rules",function(l,g,m){q.auth(l)?(l=h._ruleManager.getRules(),g.json({XC_SUC:l?l:{}})):g.json({XC_ERR:{code:"000007",msg:"access denied"}})});m.get("/data/rle/:id",
function(l,g,m){q.auth(l)?(l=h._ruleManager.getRule(l.params.id))?g.json({XC_SUC:l}):g.json({XC_ERR:{code:"000101",msg:"failed to open file"}}):g.json({XC_ERR:{code:"000007",msg:"access denied"}})});m.post("/data/rle/:id",function(l,g){if(q.auth(l)){var m=new Buffer(0);l.on("data",function(a){m=Buffer.concat([m,a])});l.on("end",function(){var a=l.params.id,b=m.toString("utf8");try{var c=null;b&&(c=JSON.parse(b));h._ruleManager.setRule(a,c,function(a,b){a?g.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+
a.message}}):b?g.json({XC_SUC:{bytes:m.length}}):g.json({XC_SUC:{bytes:0}})})}catch(d){g.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+d.message}})}})}else g.json({XC_ERR:{code:"000007",msg:"access denied"}})});m.post("/api/trigger",function(l,g){if(q.auth(l)){var m=new Buffer(0);l.on("data",function(a){m=Buffer.concat([m,a])});l.on("end",function(){var a=m.toString("utf8");try{var b=null;a&&(b=JSON.parse(a));if(b&&"time"==b.type&&b.value){var c=require("moment-timezone"),d=taskman.Util._getTimeZone(),
e=parseInt(b.value.split(":")[0]),f=parseInt(b.value.split(":")[1]),k=new Date;k.setHours(e);k.setMinutes(f);k=c.tz(k.getTime(),d);var l=x.hub.rule.RuleManager.Util.getAstro(k);h._ruleManager.onTimerTick(k,l[0],l[1]);g.json({XC_SUC:{}})}else g.json({XC_ERR:{code:"000101",msg:"unknown trigger type"}})}catch(v){g.json({XC_ERR:{code:"000101",msg:"failed to trigger:"+v.message}})}})}else g.json({XC_ERR:{code:"000007",msg:"access denied"}})})};return q}();module.exports=new x.hub.rule.Handler;
