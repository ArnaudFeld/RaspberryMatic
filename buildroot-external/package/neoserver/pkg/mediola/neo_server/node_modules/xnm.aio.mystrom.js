var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.mystrom=xnm.aio.mystrom||{};
xnm.aio.mystrom.WifiDevice=function(){var f=function(b,l,a){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.mystrom.WifiDevice");this.ip=b;this.port=l;this.uuid=a;this.port||(this.port=80);this.timeout=2E3};f.prototype.executeCommandCreator=function(b,l,a){l&&l.value?this.executeCommand(l,function(b){a&&a(b)}):a&&a(Error("command value is empty"))};f.prototype.getStatesCreator=function(b,l,a){this.getStates(function(b,c){for(var d=
[],e=0;e<l.length;e++)if(l[e]&&l[e].id){var g="?";c&&l[e].status&&l[e].status.value&&(g=c[l[e].status.value],"undefined"!=typeof g&&null!=g&&d.push({id:l[e].id,status:g}))}a&&a(null,d)})};f.prototype._doRequest=function(b,a,c,d,e){var f=a,p,g;a="http://"+this.ip+":"+this.port+a;if(c){var h=[];for(p in c)if(c.hasOwnProperty(p)){g=p+"=";var v=c[p];"undefined"!=typeof v&&null!=v&&(g+=encodeURIComponent(v));h.push(g)}a+="?"+h.join("&");f+="?"+h.join("&")}c="";if(d){g=[];for(p in d)d.hasOwnProperty(p)&&
g.push(p+"="+d[p]);c=g.join("&")}this._logger.log("trace","send "+b+" to url:"+a+" with data:"+c);b={host:this.ip,port:this.port,path:f,method:b,headers:{"Content-Type":'application/x-www-form-urlencoded; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}};c&&(b.headers["Content-Length"]=c.length);var m=this,k=e,q=require("http").request(b,function(b){var a="";b.setEncoding("utf-8");b.on("data",function(b){a+=b});b.on("end",function(){m._logger.log("trace","recevice "+b.statusCode+" response:"+
a);if(a)try{var c=JSON.parse(a);k&&(k(null,b.statusCode,c),k=null)}catch(l){k&&(k(l,b.statusCode),k=null)}else k&&(k(null,b.statusCode,""),k=null)})});q.setTimeout(this.timeout,function(){m._logger.log("trace","http request timeout");q.abort();k&&(k(Error("timeout")),k=null)});q.on("error",function(b){m._logger.log("trace","http request error:"+b.message);k&&(k(b),k=null)});c&&q.write(c);q.end()};f.prototype.toJSON=function(){return{ip:this.ip,port:this.port,uuid:this.uuid}};f.build=function(b){if(!b||
!b.type||!b.ip)return null;switch(b.type){case "switch":return new a(b.ip,b.port,b.uuid);case "bulb":return new c(b.ip,b.port,b.uuid);case "strip":return new d(b.ip,b.port,b.uuid);case "button":return new e(b.ip,b.port,b.uuid)}};var a=function(b,a,c){this._logger=require("x.logger.js").getLogger("xnm.aio.mystrom.WifiSwitch");f.call(this,b,a,c)};a.prototype=new f;a.prototype.constructor=a;a.prototype.executeCommand=function(b,a){if(b){var c,d;switch(b.value){case "on":c="/relay";d={state:1};break;
case "off":c="/relay";d={state:0};break;case "toggle":c="/toggle";break;default:a&&a(Error("unknown command"));return}this._doRequest("GET",c,d,null,a)}else a&&a(Error("command object is null"))};a.prototype.getStates=function(b){this._doRequest("GET","/report",null,null,function(a,c,d){a?b&&b(a):d?(d.state=d.relay?"on":"off",b&&b(null,d)):b&&b(Error("get states result invalid"))})};a.prototype.toJSON=function(){var b=f.prototype.toJSON.call(this);b.type="switch";return b};a.prototype.equalsTo=function(b){return b&&
b instanceof a?this.ip==b.ip&&this.port==b.port&&this.uuid==b.uuid:!1};var c=function(b,a,c){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.mystrom.WifiBulb");f.call(this,b,a,c);this._stateBufferTS=this._stateBuffer=null};c.prototype=new f;c.prototype.constructor=c;c.prototype.executeCommand=function(b,a){if(b)if(this.uuid){var c=this,d="/api/v1/device/"+this.uuid.toUpperCase(),e=null;switch(b.value){case "on":e={action:"on"};break;
case "off":e={action:"off"};break;case "toggle":e={action:"toggle"};break;case "white":this.getStatesIncludBuffer(function(b,e){if(b)a&&a(b);else{var g=100;e&&e.color&&(g=e.color.split(";"),g=3>g.length?g[1]:g[2]);c._doRequest("POST",d,void 0,{mode:"mono",color:"18;"+g},a)}});return;case "dimTo":case "dimUp":case "dimDown":if("undefined"==typeof b.ext||null==b.ext){a&&a(Error("command ext is null"));return}this.getStatesIncludBuffer(function(e,f){if(e)a&&a(e);else if(f&&f.color){var g=f.color.split(";"),
h=0,h=2==g.length?g[1]:g[2];switch(b.value){case "dimTo":h=parseInt(b.ext);break;case "dimUp":h=parseInt(h)+parseInt(b.ext);break;case "dimDown":h=parseInt(h)-parseInt(b.ext)}0>h&&(h=0);100<h&&(h=100);2==g.length?g[1]=h:g[2]=h;c._doRequest("POST",d,void 0,{action:"on",ramp:f.ramp,color:g.join(";")},a)}else a&&a(Error("can not get color state"))});return;case "setCT":if("undefined"==typeof b.ext||null==b.ext){a&&a(Error("command ext is null"));return}this.getStatesIncludBuffer(function(e,f){if(e)a&&
a(e);else{var g=parseInt(b.ext),h=100;1>g&&(g=1);18<g&&(g=18);f&&f.color&&(h=f.color.split(";"),h=3>h.length?h[1]:h[2]);c._doRequest("POST",d,void 0,{mode:"mono",color:g+";"+h},a)}});return;case "setRGB":if("undefined"==typeof b.ext||null==b.ext){a&&a(Error("command ext is null"));return}this.getStatesIncludBuffer(function(e,f){if(e)a&&a(e);else{var g=parseInt(b.ext.substr(0,2),16),h=parseInt(b.ext.substr(2,2),16),n=parseInt(b.ext.substr(4,2),16),m,g=g/255,h=h/255,n=n/255,k=Math.max(g,h,n),q=Math.min(g,
h,n),u=k-q;if(k==q)m=0;else{switch(k){case g:m=(h-n)/u+(h<n?6:0);break;case h:m=(n-g)/u+2;break;case n:m=(g-h)/u+4}m/=6}m=[m,0==k?0:u/k,k];g=[];f&&f.color&&(g=f.color.split(";"),3>g.length&&(g[2]=g[1]));g[0]=Math.round(360*m[0]);g[1]=Math.round(100*m[1]);g[2]||(g[2]=Math.round(100*m[2]));c._doRequest("POST",d,void 0,{color:g.join(";")},a)}});return;default:a&&a(Error("unknown command"));return}this._doRequest("POST",d,void 0,e,a)}else a&&a(Error("mac address is null"));else a&&a(Error("command object is null"))};
c.prototype.getStates=function(b){if(this.uuid){var a=this;this._doRequest("GET","/api/v1/device/"+this.uuid.toUpperCase(),null,null,function(c,d,e){if(c)b&&b(c);else if(e)if(c=e[a.uuid.toUpperCase()]){c.state=c.on?"on":"off";if(d=c.color)d=d.split(";"),2==d.length?(c.ct=parseInt(d[0]),c.level=parseInt(d[1])):c.level=parseInt(d[2]);a._stateBuffer=c;a._stateBufferTS=(new Date).getTime();b&&b(null,c)}else b&&b(Error("get states result do not contain this device"));else b&&b(Error("get states result invalid"))})}else b&&
b(Error("mac address in null"))};c.prototype.getStatesIncludBuffer=function(b){var a=(new Date).getTime();this._stateBuffer&&this._stateBufferTS&&3E4>a-this._stateBufferTS?b&&b(null,this._stateBuffer):(this._stateBufferTS=this._stateBuffer=null,this.getStates(b))};c.prototype.toJSON=function(){var b=f.prototype.toJSON.call(this);b.type="bulb";return b};c.prototype.equalsTo=function(b){return b&&b instanceof c?this.ip==b.ip&&this.port==b.port&&this.uuid==b.uuid:!1};var d=function(b,a,c){this._logger=
require("x.logger.js").getLogger("xnm.aio.mystrom.WifiBulb");f.call(this,b,a,c);this._stateBufferTS=this._stateBuffer=null};d.prototype=new c;d.prototype.constructor=d;d.prototype.toJSON=function(){var b=c.prototype.toJSON.call(this);b.type="strip";return b};d.prototype.equalsTo=function(b){return b&&b instanceof d?this.ip==b.ip&&this.port==b.port&&this.uuid==b.uuid:!1};var e=function(b,a,c){this._logger=require("x.logger.js").getLogger("xnm.aio.mystrom.WifiButton");f.call(this,b,a,c)};e.prototype=
new f;e.prototype.constructor=e;e.prototype.getInfo=function(b){this.uuid?this._doRequest("GET","/api/v1/device/"+this.uuid.toUpperCase(),null,null,function(a,c,d){a?b&&b(a):d?b&&b(null,d):b&&b(Error("get info result invalid"))}):b&&b(Error("mac address in null"))};e.prototype.toJSON=function(){var a=f.prototype.toJSON.call(this);a.type="button";return a};e.prototype.equalsTo=function(a){return a&&a instanceof e?this.ip==a.ip&&this.port==a.port&&this.uuid==a.uuid:!1};f.Switch=a;f.Bulb=c;f.Strip=d;
f.Button=e;return f}();
xnm.aio.mystrom.Discovery=function(){var f=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.mystrom.Discovery");this._devices={};this._callbacks=[];this._searchTimeout=null;this._sockets=[]};f.prototype.start=function(a,c){c||(c=function(){});if(!a||0>a)a=1E4;var d=this._callbacks.length;-1==this._callbacks.indexOf(c)&&this._callbacks.push(c);if(!d){var e=this;this._searchTimeout=setTimeout(function(){e._searchFinish()},a);this._searchStart()}};f.prototype._searchStart=function(){this._logger.log("debug",
"start search for devices");var a=require("os");require("dgram");if(a&&a.networkInterfaces){var a=a.networkInterfaces(),c;for(c in a){for(var d=a[c],e=0;e<d.length;e++)this._addDiscoverSocket(7979,d[e]);this._addDiscoverSocket(7979,null)}}else this._addDiscoverSocket(7979,null);var b=this;(c=require("x.upnp.js"))&&c.discoverDevices(function(a){if(0==a.name.indexOf("myStrom")){b._logger.log("debug","upnp find switch:"+a.uuid+" ip:"+a.ip);var c=a.ip;a=a.uuid.substr(a.uuid.length-12,12);b._devices[c]=
new xnm.aio.mystrom.WifiDevice.Switch(c,null,a)}})};f.prototype._searchFinish=function(){this._searchTimeout=null;var a=this._sockets;this._sockets=[];for(var c=a.length;c--;){var d=a[c];d&&d.close()}a=this._callbacks;this._callbacks=[];var c=a.length,d=[],e;for(e in this._devices)if(this._devices.hasOwnProperty(e)){var b=this._devices[e];b&&d.push(b)}for(this._devices={};c--;)(e=a[c])&&e(null,d)};f.prototype._receivedData=function(a,c){c=c.toString("hex");this._logger.log("debug","received data from "+
a+" ("+c+")");if(!(14>c.length)){var d=c.substr(0,12),e=c.substr(12,2),e=parseInt(e,16);switch(e){case 101:case 106:case 107:this._devices[a]=new xnm.aio.mystrom.WifiDevice.Switch(a,null,d);break;case 102:this._devices[a]=new xnm.aio.mystrom.WifiDevice.Bulb(a,null,d);break;case 105:this._devices[a]=new xnm.aio.mystrom.WifiDevice.Strip(a,null,d);break;case 103:case 104:this._devices[a]=new xnm.aio.mystrom.WifiDevice.Button(a,null,d)}}};f.prototype._addDiscoverSocket=function(a,c){var d=require("dgram"),
e,b=this;if(!c){try{e=d.createSocket({reuseAddr:!0,type:"udp4"})}catch(f){e=d.createSocket("udp4")}e.on("message",function(a,c){b._receivedData(c.address,a)});e.on("error",function(a){});e.bind(a);this._sockets.push(e)}else if("IPv4"==c.family&&0==c.internal){try{e=d.createSocket({reuseAddr:!0,type:"udp4"})}catch(t){e=d.createSocket("udp4")}e.on("listening",function(){e.setBroadcast(!0)});e.on("message",function(a,c){b._receivedData(c.address,a)});e.on("error",function(a){});e.bind(a,c.address);this._sockets.push(e)}};
return f}();
xnm.aio.mystrom.DM=function(){var f=function(a,c){this.code=a;this.message=c;this.stack=Error().stack};f.prototype=Error();f.prototype.name="MystromDMError";f.prototype.code=0;f.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"mystrom",MAP:{"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on",
"off"]}},{type:"float",name:"power",ref:{value:"power"}}]},bulb:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"dim up",ref:{value:"dimUp",ext:"%d",extMeta:"1-10",unit:"%"}},{type:"int",name:"dim down",ref:{value:"dimDown",ext:"%d",extMeta:"1-10",unit:"%"}},{type:"enum",name:"white",ref:{value:"white"}},{type:"rgb",
name:"set color",ref:{value:"setRGB",ext:"%rgb"}},{type:"int",name:"set color temperature",ref:{value:"setCT",ext:"%d",extMeta:"1-18"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"float",name:"power",ref:{value:"power"}},{type:"int",name:"color temperature",ref:{value:"ct",ext:"%d",extMeta:"1-18"}},{type:"int",name:"level",ref:{value:"level",ext:"%d"}}]},strip:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",
name:"toggle",ref:{value:"toggle"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"dim up",ref:{value:"dimUp",ext:"%d",extMeta:"1-10",unit:"%"}},{type:"int",name:"dim down",ref:{value:"dimDown",ext:"%d",extMeta:"1-10",unit:"%"}},{type:"enum",name:"white",ref:{value:"white"}},{type:"rgb",name:"set color",ref:{value:"setRGB",ext:"%rgb"}},{type:"int",name:"set color temperature",ref:{value:"setCT",ext:"%d",extMeta:"1-18"}}],status:[{type:"enum",name:"state",
ref:{value:"state",options:["on","off"]}},{type:"float",name:"power",ref:{value:"power"}},{type:"int",name:"color temperature",ref:{value:"ct",ext:"%d",extMeta:"1-18"}},{type:"int",name:"level",ref:{value:"level",ext:"%d"}}]}},getIPDeviceType:function(){return[{sys:this.SYS,name:"myStrom"}]},createDevice:function(a,c,d){c=f.ERROR_CODE;a?a.ip?a.type?d(null,a):d(new f(c.INVALID,"type is invalid")):d(new f(c.INVALID,"ip is invalid")):d(new f(c.INVALID,"info is invalid"))},updateDevice:function(a,c,d){c=
f.ERROR_CODE;a?a.ip?a.type?d(null,a):d(new f(c.INVALID,"type is invalid")):d(new f(c.INVALID,"ip is invalid")):d(new f(c.INVALID,"info is invalid"))},deleteDevice:function(a,c,d){d()},applyUIFilter:function(a,c){var d=this,e=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},b=function(a,b,c){var d=[];switch(c.catagory){case "command":a.command&&a.command.forEach(function(a){e(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))});break;case "status":a.status&&
a.status.forEach(function(a){e(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))})}return d},f=function(a,c){var e=[],f=null;if(f=d.getCommandStatusMap(a))f=b(f,a,c),e=e.concat(f);return e};if(!a||null==a.type||"undefined"==typeof a.type)return null;var t=JSON.parse(JSON.stringify(a)),r=null;switch(c.catagory){case "command":r=f(a,c);t.command=r;break;case "status":r=f(a,c);t.status=r;break;default:return null}return r&&0!=r.length?t:null},getCommandStatusMap:function(a){return this.MAP[a.type]}}}();
xnm.aio.mystrom.Handler=function(){var f=function(){this._discovery=new xnm.aio.mystrom.Discovery};f.prototype.devicemanager=xnm.aio.mystrom.DM;f.prototype.Device=xnm.aio.mystrom.WifiDevice;f.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"mystrom")};f.prototype.resolveDevice=function(a){return a&&a.type&&a.ip?this.Device.build(a):null};f.prototype.getDeviceCommands=function(a,c){var d=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}),d=d?d.command:[];c&&c(null,
d)};f.prototype.getDeviceStatus=function(a,c){var d=this.devicemanager.applyUIFilter(a,{catagory:"status",elems:"*"}),d=d?d.status:[];c&&c(null,d)};f.prototype.doCommand=function(a,c,d){var e=this.resolveDevice(a);e?e.executeCommandCreator(a,c,function(a){d&&d(a)}):d&&d(Error("gateway json format invalid"))};f.prototype.doStatus=function(a,c,d,e){var b=this.resolveDevice(c);b?b.getStatesCreator(null,[{id:a,device:c,status:d}],function(a,b){a?e&&e(a):e&&e(null,b[0])}):e&&e(Error("gateway json format invalid"))};
f.prototype.discovery=function(a){this._discovery.start(1E4,a)};return f}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.mystrom.Handler);
