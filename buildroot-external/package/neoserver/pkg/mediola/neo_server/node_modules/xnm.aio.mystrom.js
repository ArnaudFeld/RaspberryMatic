var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.mystrom=xnm.aio.mystrom||{};
xnm.aio.mystrom.WifiDevice=function(){var e=function(a,d,b,c){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.mystrom.WifiDevice");this.ip=a;this.port=d;this.uuid=b;this.port||(this.port=80);this.token=c;this.timeout=2E3};e.prototype.executeCommandCreator=function(a,d,b){d&&d.value?this.executeCommand(d,function(a){b&&b(a)}):b&&b(Error("command value is empty"))};e.prototype.getStatesCreator=function(a,d,b){this.getStates(function(a,
c){a=[];for(var r=0;r<d.length;r++)if(d[r]&&d[r].id&&c&&d[r].status&&d[r].status.value){var g=c[d[r].status.value];"undefined"!=typeof g&&null!=g&&a.push({id:d[r].id,status:g})}b&&b(null,a)})};e.prototype._doRequest=function(a,b,c,e,f){var d=b,g;b="http://"+this.ip+":"+this.port+b;if(c){var n=[];for(g in c)if(c.hasOwnProperty(g)){var h=g+"=";var m=c[g];"undefined"!=typeof m&&null!=m&&(h+=encodeURIComponent(m));n.push(h)}b+="?"+n.join("&");d+="?"+n.join("&")}c="";if(e){h=[];for(g in e)e.hasOwnProperty(g)&&
h.push(g+"="+e[g]);c=h.join("&")}this._logger.log("trace","send "+a+" to url:"+b+" with data:"+c);a={host:this.ip,port:this.port,path:d,method:a,headers:{"Content-Type":'application/x-www-form-urlencoded; charset="UTF-8"',"User-Agent":"mediola",Connection:"close",Referer:"http://"+this.ip}};c&&(a.headers["Content-Length"]=c.length);this.token&&(a.headers.TOKEN=this.token);var q=this,l=f,k=require("http").request(a,function(a){var b="";a.setEncoding("utf-8");a.on("data",function(a){b+=a});a.on("end",
function(){q._logger.log("trace","recevice "+a.statusCode+" response:"+b);if(b)try{var d=JSON.parse(b);l&&(l(null,a.statusCode,d),l=null)}catch(v){l&&(l(v,a.statusCode),l=null)}else l&&(l(null,a.statusCode,""),l=null)})});k.setTimeout(this.timeout,function(){q._logger.log("trace","http request timeout");k.abort();l&&(l(Error("timeout")),l=null)});k.on("error",function(a){q._logger.log("trace","http request error:"+a.message);l&&(l(a),l=null)});c&&k.write(c);k.end()};e.prototype._doRequestWithSocket=
function(a,b,c,e,f){var d;if(c){var g=[];for(d in c)if(c.hasOwnProperty(d)){var h=d+"=";var n=c[d];"undefined"!=typeof n&&null!=n&&(h+=encodeURIComponent(n));g.push(h)}b+="?"+g.join("&")}var m=a+" "+b+" HTTP/1.1\r\n";m+="Host: "+this.ip+(80!=this.port?":"+this.port:"")+"\r\n";m+='Content-Type: application/x-www-form-urlencoded; charset="UTF-8"\r\n';m+="User-Agent: mediola\r\n";this.token&&(m+="Token: "+this.token+"\r\n");e&&(m+="Content-Length: "+e.length+"\r\n");m+="Connection: close\r\n\r\n";e&&
(m+=e);var q=this,l=null,k=f,u="connect",t="",p=require("net").connect({port:this.port,host:this.ip});p.setTimeout(this.timeout);p.setEncoding("utf8");this._logger.log("trace","start connect to "+this.ip+":"+this.port);p.on("connect",function(){q._logger.log("trace","success to connect "+q.ip+":"+q.port);u="connected";l=setTimeout(function(){p.destroy();k&&(q._logger.log("trace","http timeout"),k(Error("http timeout")),k=null)},q.timeout);q._logger.log("trace","send req "+m);p.write(m)});p.on("data",
function(a){q._logger.log("trace","receive data: "+a.toString());t+=a.toString();l&&(clearTimeout(l),l=null);12<=t.length?(a=t.substr(0,12).split(" "),a=parseInt(a[1]),p.destroy(),k&&k(null,a)):l=setTimeout(function(){p.destroy();k&&(q._logger.log("trace","http timeout"),k(Error("http timeout")),k=null)},q.timeout)});p.on("error",function(a){q._logger.log("trace","socket error: "+a.message);p.destroy();k&&(k(a),k=null)});p.on("timeout",function(){"connect"==u&&(q._logger.log("trace","connection timeout"),
p.destroy(),k&&(k(Error("connection timeout")),k=null))});p.on("close",function(){q._logger.log("trace","socket closed");p.destroy()});p._doConnect&&"function"==typeof p._doConnect&&p._doConnect()};e.prototype.toJSON=function(){return{ip:this.ip,port:this.port,uuid:this.uuid,token:this.token}};e.build=function(a){if(!a||!a.type||!a.ip)return null;switch(a.type){case "switch":return new b(a.ip,a.port,a.uuid,a.token);case "bulb":return new c(a.ip,a.port,a.uuid,a.token);case "strip":return new f(a.ip,
a.port,a.uuid,a.token);case "button":return new h(a.ip,a.port,a.uuid,a.token)}};var b=function(a,b,c,f){this._logger=require("x.logger.js").getLogger("xnm.aio.mystrom.WifiSwitch");e.call(this,a,b,c,f)};b.prototype=new e;b.prototype.constructor=b;b.prototype.executeCommand=function(a,b){if(a){switch(a.value){case "on":a="/relay";var c={state:1};break;case "off":a="/relay";c={state:0};break;case "toggle":a="/toggle";break;default:b&&b(Error("unknown command"));return}this._doRequestWithSocket("GET",
a,c,null,b)}else b&&b(Error("command object is null"))};b.prototype.getStates=function(a){this._doRequest("GET","/report",null,null,function(b,c,e){b?a&&a(b):e?(e.state=e.relay?"on":"off",a&&a(null,e)):a&&a(Error("get states result invalid"))})};b.prototype.toJSON=function(){var a=e.prototype.toJSON.call(this);a.type="switch";return a};b.prototype.equalsTo=function(a){return a&&a instanceof b?this.ip==a.ip&&this.port==a.port&&this.uuid==a.uuid:!1};var c=function(a,b,c,f){this._logger="undefined"==
typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.mystrom.WifiBulb");e.call(this,a,b,c,f);this._stateBufferTS=this._stateBuffer=null};c.prototype=new e;c.prototype.constructor=c;c.prototype.executeCommand=function(a,b){if(a)if(this.uuid){var c=this,e="/api/v1/device/"+this.uuid.toUpperCase(),d=null;switch(a.value){case "on":d={action:"on"};break;case "off":d={action:"off"};break;case "toggle":d={action:"toggle"};break;case "white":this.getStatesIncludBuffer(function(a,
d){a?b&&b(a):(a=100,d&&d.color&&(d=d.color.split(";"),a=3>d.length?d[1]:d[2]),c._doRequest("POST",e,void 0,{mode:"mono",color:"18;"+a},b))});return;case "dimTo":case "dimUp":case "dimDown":if("undefined"==typeof a.ext||null==a.ext){b&&b(Error("command ext is null"));return}this.getStatesIncludBuffer(function(d,f){if(d)b&&b(d);else if(f&&f.color){d=f.color.split(";");var g=2==d.length?d[1]:d[2];switch(a.value){case "dimTo":g=parseInt(a.ext);break;case "dimUp":g=parseInt(g)+parseInt(a.ext);break;case "dimDown":g=
parseInt(g)-parseInt(a.ext)}0>g&&(g=0);100<g&&(g=100);2==d.length?d[1]=g:d[2]=g;c._doRequest("POST",e,void 0,{action:"on",ramp:f.ramp,color:d.join(";")},b)}else b&&b(Error("can not get color state"))});return;case "setCT":if("undefined"==typeof a.ext||null==a.ext){b&&b(Error("command ext is null"));return}this.getStatesIncludBuffer(function(d,f){if(d)b&&b(d);else{d=parseInt(a.ext);var g=100;1>d&&(d=1);18<d&&(d=18);f&&f.color&&(f=f.color.split(";"),g=3>f.length?f[1]:f[2]);c._doRequest("POST",e,void 0,
{mode:"mono",color:d+";"+g},b)}});return;case "setRGB":if("undefined"==typeof a.ext||null==a.ext){b&&b(Error("command ext is null"));return}this.getStatesIncludBuffer(function(d,f){if(d)b&&b(d);else{d=parseInt(a.ext.substr(0,2),16);var g=parseInt(a.ext.substr(2,2),16),h=parseInt(a.ext.substr(4,2),16);d/=255;g/=255;h/=255;var m=Math.max(d,g,h),n=Math.min(d,g,h),l=m-n;if(m==n)var k=0;else{switch(m){case d:k=(g-h)/l+(g<h?6:0);break;case g:k=(h-d)/l+2;break;case h:k=(d-g)/l+4}k/=6}k=[k,0==m?0:l/m,m];
d=[];f&&f.color&&(d=f.color.split(";"),3>d.length&&(d[2]=d[1]));d[0]=Math.round(360*k[0]);d[1]=Math.round(100*k[1]);d[2]||(d[2]=Math.round(100*k[2]));c._doRequest("POST",e,void 0,{color:d.join(";")},b)}});return;default:b&&b(Error("unknown command"));return}this._doRequest("POST",e,void 0,d,b)}else b&&b(Error("mac address is null"));else b&&b(Error("command object is null"))};c.prototype.getStates=function(a){if(this.uuid){var b=this;this._doRequest("GET","/api/v1/device/"+this.uuid.toUpperCase(),
null,null,function(d,c,f){if(d)a&&a(d);else if(f)if(d=f[b.uuid.toUpperCase()]){d.state=d.on?"on":"off";if(c=d.color)c=c.split(";"),2==c.length?(d.ct=parseInt(c[0]),d.level=parseInt(c[1])):d.level=parseInt(c[2]);b._stateBuffer=d;b._stateBufferTS=(new Date).getTime();a&&a(null,d)}else a&&a(Error("get states result do not contain this device"));else a&&a(Error("get states result invalid"))})}else a&&a(Error("mac address in null"))};c.prototype.getStatesIncludBuffer=function(a){var b=(new Date).getTime();
this._stateBuffer&&this._stateBufferTS&&3E4>b-this._stateBufferTS?a&&a(null,this._stateBuffer):(this._stateBufferTS=this._stateBuffer=null,this.getStates(a))};c.prototype.toJSON=function(){var a=e.prototype.toJSON.call(this);a.type="bulb";return a};c.prototype.equalsTo=function(a){return a&&a instanceof c?this.ip==a.ip&&this.port==a.port&&this.uuid==a.uuid:!1};var f=function(a,b,c,f){this._logger=require("x.logger.js").getLogger("xnm.aio.mystrom.WifiBulb");e.call(this,a,b,c,f);this._stateBufferTS=
this._stateBuffer=null};f.prototype=new c;f.prototype.constructor=f;f.prototype.toJSON=function(){var a=c.prototype.toJSON.call(this);a.type="strip";return a};f.prototype.equalsTo=function(a){return a&&a instanceof f?this.ip==a.ip&&this.port==a.port&&this.uuid==a.uuid:!1};var h=function(a,b,c,f){this._logger=require("x.logger.js").getLogger("xnm.aio.mystrom.WifiButton");e.call(this,a,b,c,f)};h.prototype=new e;h.prototype.constructor=h;h.prototype.getInfo=function(a){this.uuid?this._doRequest("GET",
"/api/v1/device/"+this.uuid.toUpperCase(),null,null,function(b,c,f){b?a&&a(b):f?a&&a(null,f):a&&a(Error("get info result invalid"))}):a&&a(Error("mac address in null"))};h.prototype.toJSON=function(){var a=e.prototype.toJSON.call(this);a.type="button";return a};h.prototype.equalsTo=function(a){return a&&a instanceof h?this.ip==a.ip&&this.port==a.port&&this.uuid==a.uuid:!1};e.Switch=b;e.Bulb=c;e.Strip=f;e.Button=h;return e}();
xnm.aio.mystrom.Discovery=function(){var e=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.mystrom.Discovery");this._devices={};this._callbacks=[];this._searchTimeout=null;this._sockets=[]};e.prototype.start=function(b,c){c||(c=function(){});if(!b||0>b)b=1E4;var f=this._callbacks.length;-1==this._callbacks.indexOf(c)&&this._callbacks.push(c);if(!f){var e=this;this._searchTimeout=setTimeout(function(){e._searchFinish()},b);this._searchStart()}};e.prototype._searchStart=function(){this._logger.log("debug",
"start search for devices");var b=require("os");require("dgram");if(b&&b.networkInterfaces){b=b.networkInterfaces();for(var c in b){for(var f=b[c],e=0;e<f.length;e++)this._addDiscoverSocket(7979,f[e]);this._addDiscoverSocket(7979,null)}}else this._addDiscoverSocket(7979,null);var a=this;(c=require("x.upnp.js"))&&c.discoverDevices(function(b){if(0==b.name.indexOf("myStrom")){a._logger.log("debug","upnp find switch:"+b.uuid+" ip:"+b.ip);var c=b.ip;b=b.uuid.substr(b.uuid.length-12,12);a._devices[c]=
new xnm.aio.mystrom.WifiDevice.Switch(c,null,b)}})};e.prototype._searchFinish=function(){this._searchTimeout=null;var b=this._sockets;this._sockets=[];for(var c=b.length;c--;){var f=b[c];f&&f.close()}b=this._callbacks;this._callbacks=[];c=b.length;f=[];for(var e in this._devices)if(this._devices.hasOwnProperty(e)){var a=this._devices[e];a&&f.push(a)}for(this._devices={};c--;)(e=b[c])&&e(null,f)};e.prototype._receivedData=function(b,c){c=c.toString("hex");this._logger.log("debug","received data from "+
b+" ("+c+")");if(!(14>c.length)){var f=c.substr(0,12);c=c.substr(12,2);c=parseInt(c,16);switch(c){case 101:case 106:case 107:this._devices[b]=new xnm.aio.mystrom.WifiDevice.Switch(b,null,f);break;case 102:this._devices[b]=new xnm.aio.mystrom.WifiDevice.Bulb(b,null,f);break;case 105:this._devices[b]=new xnm.aio.mystrom.WifiDevice.Strip(b,null,f);break;case 103:case 104:this._devices[b]=new xnm.aio.mystrom.WifiDevice.Button(b,null,f)}}};e.prototype._addDiscoverSocket=function(b,c){var f=require("dgram"),
e=this;if(!c){try{var a=f.createSocket({reuseAddr:!0,type:"udp4"})}catch(d){a=f.createSocket("udp4")}a.on("message",function(a,b){e._receivedData(b.address,a)});a.on("error",function(a){});a.bind(b);this._sockets.push(a)}else if("IPv4"==c.family&&0==c.internal){try{a=f.createSocket({reuseAddr:!0,type:"udp4"})}catch(d){a=f.createSocket("udp4")}a.on("listening",function(){a.setBroadcast(!0)});a.on("message",function(a,b){e._receivedData(b.address,a)});a.on("error",function(a){});a.bind(b,c.address);
this._sockets.push(a)}};return e}();
xnm.aio.mystrom.DM=function(){var e=function(b,c){this.code=b;this.message=c;this.stack=Error().stack};e.prototype=Error();e.prototype.name="MystromDMError";e.prototype.code=0;e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"mystrom",MAP:{"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",
options:["on","off"]}},{type:"float",name:"power",ref:{value:"power"}}]},bulb:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"dim up",ref:{value:"dimUp",ext:"%d",extMeta:"1-10",unit:"%"}},{type:"int",name:"dim down",ref:{value:"dimDown",ext:"%d",extMeta:"1-10",unit:"%"}},{type:"enum",name:"white",ref:{value:"white"}},
{type:"rgb",name:"set color",ref:{value:"setRGB",ext:"%rgb"}},{type:"int",name:"set color temperature",ref:{value:"setCT",ext:"%d",extMeta:"1-18"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"float",name:"power",ref:{value:"power"}},{type:"int",name:"color temperature",ref:{value:"ct",ext:"%d",extMeta:"1-18"}},{type:"int",name:"level",ref:{value:"level",ext:"%d"}}]},strip:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},
{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"dim up",ref:{value:"dimUp",ext:"%d",extMeta:"1-10",unit:"%"}},{type:"int",name:"dim down",ref:{value:"dimDown",ext:"%d",extMeta:"1-10",unit:"%"}},{type:"enum",name:"white",ref:{value:"white"}},{type:"rgb",name:"set color",ref:{value:"setRGB",ext:"%rgb"}},{type:"int",name:"set color temperature",ref:{value:"setCT",ext:"%d",extMeta:"1-18"}}],status:[{type:"enum",
name:"state",ref:{value:"state",options:["on","off"]}},{type:"float",name:"power",ref:{value:"power"}},{type:"int",name:"color temperature",ref:{value:"ct",ext:"%d",extMeta:"1-18"}},{type:"int",name:"level",ref:{value:"level",ext:"%d"}}]}},getIPDeviceType:function(){return[{sys:this.SYS,name:"myStrom"}]},createDevice:function(b,c,f){c=e.ERROR_CODE;b?b.ip?b.type?f(null,b):f(new e(c.INVALID,"type is invalid")):f(new e(c.INVALID,"ip is invalid")):f(new e(c.INVALID,"info is invalid"))},updateDevice:function(b,
c,f){c=e.ERROR_CODE;b?b.ip?b.type?f(null,b):f(new e(c.INVALID,"type is invalid")):f(new e(c.INVALID,"ip is invalid")):f(new e(c.INVALID,"info is invalid"))},deleteDevice:function(b,c,e){e()},applyUIFilter:function(b,c){var e=this,h=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},a=function(a,b,c){var d=[];switch(c.catagory){case "command":a.command&&a.command.forEach(function(a){h(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))});break;
case "status":a.status&&a.status.forEach(function(a){h(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))})}return d},d=function(b,c){var d=[],f=e.getCommandStatusMap(b);f&&(b=a(f,b,c),d=d.concat(b));return d};if(!b||null==b.type||"undefined"==typeof b.type)return null;var g=JSON.parse(JSON.stringify(b)),n=null;switch(c.catagory){case "command":n=d(b,c);g.command=n;break;case "status":n=d(b,c);g.status=n;break;default:return null}return n&&0!=n.length?g:null},getCommandStatusMap:function(b){return this.MAP[b.type]}}}();
xnm.aio.mystrom.Handler=function(){var e=function(){this._discovery=new xnm.aio.mystrom.Discovery};e.prototype.devicemanager=xnm.aio.mystrom.DM;e.prototype.Device=xnm.aio.mystrom.WifiDevice;e.prototype.registModule=function(b){b.register(this.devicemanager.SYS,"mystrom")};e.prototype.resolveDevice=function(b){return b&&b.type&&b.ip?this.Device.build(b):null};e.prototype.getDeviceCommands=function(b,c){b=(b=this.devicemanager.applyUIFilter(b,{catagory:"command",elems:"*"}))?b.command:[];c&&c(null,
b)};e.prototype.getDeviceStatus=function(b,c){b=(b=this.devicemanager.applyUIFilter(b,{catagory:"status",elems:"*"}))?b.status:[];c&&c(null,b)};e.prototype.doCommand=function(b,c,e){var f=this.resolveDevice(b);f?f.executeCommandCreator(b,c,function(a){e&&e(a)}):e&&e(Error("gateway json format invalid"))};e.prototype.doStatus=function(b,c,e,h){var a=this.resolveDevice(c);a?a.getStatesCreator(null,[{id:b,device:c,status:e}],function(a,b){a?h&&h(a):h&&h(null,b[0])}):h&&h(Error("gateway json format invalid"))};
e.prototype.discovery=function(b){this._discovery.start(1E4,b)};return e}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.mystrom.Handler);
