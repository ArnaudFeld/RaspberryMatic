var x=x||{};x.hub=x.hub||{};x.hub.deviceman=x.hub.deviceman||{};
x.hub.deviceman.DeviceManager=function(){var c=function(b,a){this._logger=require("x.logger.js").getLogger("x.hub.deviceman.DeviceManager");this._tenant=null;this._folder=b;this._folder||(this._folder="db");this._tenantIdx=a;this._tenantIdx||(this._tenantIdx=1)};c.prototype.init=function(b,a){this._logger.log("info","init device managaer:"+this._folder);var d=require("m.aio.configmanager.js"),c=this._generateTenantParent(b);this._tenant=new d.Tenant(c);this._tenant.index=this._tenantIdx;this._tenant.license=
"dummy";this._tenant.folder=this._folder;var e=this;require("fs-extra").ensureDir(this._tenant.getFolderPath(),function(){e._load(a)})};c.prototype.reload=function(b){var a=this;require("m.aio.devicemanager.js").reloadTenant(this._tenant,function(d){d&&a._logger.log("warn","reload device error:"+d.message);b&&b(d)})};c.prototype.execute=function(b,a,d,c,e){try{require("m.aio.devicemanager.js").execute(b,this._tenant.index,d,c,e)}catch(g){console.error(g.stack)}};c.prototype.getDeviceInfo=function(){var b=
require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return b?b.getDeviceInfo():null};c.prototype.findDevice=function(b,a){var d=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return d?d.findDeviceIgnoreLicense(b,a):null};c.prototype.findGateway=function(b){var a=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return a?a.findGatewayIgnoreLicense(b):null};c.prototype.findGatewayWithIndex=function(b){var a=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);
return a?a.findGatewayWithIndexIngnoreLicense(b):null};c.prototype.findDeviceWithIndex=function(b){var a=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return a?a.findDeviceWithIndexIngnoreLicense(b):null};c.prototype._load=function(b){var a=this;require("m.aio.devicemanager.js")._loadTenant(this._tenant,function(d){d&&a._logger.log("warn","init device error:"+d.message);b&&b(d)})};c.prototype._generateTenantParent=function(b){return{fileManager:b,getFolderPath:function(){return this.fileManager.getUserRootDataPath()},
getFolder:function(){return""}}};return c}();x.hub.deviceman.Handler=function(){this.deviceManager=new x.hub.deviceman.DeviceManager("db",1);this.deviceManager2=new x.hub.deviceman.DeviceManager("db2",2)};x.hub.deviceman.Handler.prototype.DeviceManager=x.hub.deviceman.DeviceManager;x.hub.deviceman.Handler.prototype.init=function(c,b,a){this._config(c);var d=0;this.deviceManager.init(b,function(b){d++;2==d&&a&&a(b)});this.deviceManager2.init(b,function(b){d++;2==d&&a&&a(b)})};
x.hub.deviceman.Handler.prototype._config=function(c){var b=this;c.use("/xhub/devicemanager/:id/:type",function(a,b,c){if(a._body)return c();a.body=a.body||{};if("GET"==a.method||"HEAD"==a.method||!a.is("text/xml"))return c();a._body=!0;var e="";a.setEncoding("utf8");a.on("data",function(a){e+=a});a.on("end",function(){a.body=e;c()})});c.use("/xhub/devicemanager/:id/:type",function(a,d){var c=a.method.toLowerCase(),e=a.params.id,g=a.params.type,h=null,f=null;switch(c){case "get":f="readWithoutLicense";
h=a.query;break;case "post":f="create";h=a.body;break;case "put":f="update";h=a.body;break;case "delete":f="delete",h=a.query.index}f?b.deviceManager.execute(f,e,g,h,function(a,b){a?d.send(this.error2json(a)):b.toJSON&&"function"==typeof b.toJSON?d.send(b.toJSON()):(g&&"deviceinfo"==g&&d.set("Content-Type","text/xml"),d.send(b))}.bind(this)):(c=Error("invalid http method"),c.code=500,d.send(this.error2json(c)))}.bind(this))};module.exports=new x.hub.deviceman.Handler;
