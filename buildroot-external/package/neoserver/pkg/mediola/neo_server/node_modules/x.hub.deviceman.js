var x=x||{};x.hub=x.hub||{};x.hub.deviceman=x.hub.deviceman||{};
x.hub.deviceman.DeviceManager=function(){var c=function(a,b){this._logger=require("x.logger.js").getLogger("x.hub.deviceman.DeviceManager");this._tenant=null;this._folder=a;this._folder||(this._folder="db");this._tenantIdx=b;this._tenantIdx||(this._tenantIdx=1)};c.prototype.init=function(a,b){this._logger.log("info","init device managaer:"+this._folder);var d=require("m.aio.configmanager.js");a=this._generateTenantParent(a);this._tenant=new d.Tenant(a);this._tenant.index=this._tenantIdx;this._tenant.license=
"dummy";this._tenant.folder=this._folder;var e=this;require("fs-extra").ensureDir(this._tenant.getFolderPath(),function(){e._load(b)})};c.prototype.reload=function(a){var b=this;require("m.aio.devicemanager.js").reloadTenant(this._tenant,function(d){d&&b._logger.log("warn","reload device error:"+d.message);a&&a(d)})};c.prototype.execute=function(a,b,d,e,g){try{require("m.aio.devicemanager.js").execute(a,this._tenant.index,d,e,g)}catch(f){console.error(f.stack)}};c.prototype.getDeviceInfo=function(){var a=
require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return a?a.getDeviceInfo():null};c.prototype.findDevice=function(a,b){var d=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return d?d.findDeviceIgnoreLicense(a,b):null};c.prototype.findGateway=function(a){var b=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return b?b.findGatewayIgnoreLicense(a):null};c.prototype.findGatewayWithIndex=function(a){var b=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);
return b?b.findGatewayWithIndexIngnoreLicense(a):null};c.prototype.findDeviceWithIndex=function(a){var b=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return b?b.findDeviceWithIndexIngnoreLicense(a):null};c.prototype.getAllGeneralDevice=function(a){var b=this;require("m.aio.devicemanager.js").execute("readWithoutLicense",this._tenant.index,"device",{filter:"prop","cloud.enabled":!0},function(d,e){if(d)a&&a(d);else{var g=[];if(e&&0!=e.length){var c=0,h=function(d,f){!d&&f&&(f._origin=
e[c],g.push(f));c++;c<e.length?b.toGeneralDevice(e[c].index,h):a&&a(null,g)};b.toGeneralDevice(e[c].index,h)}else a&&a(null,g)}})};c.prototype.toGeneralDevice=function(a,b){require("m.aio.devicemanager.js").toGeneralDevice(this._tenant.index,a,!0,function(a,e){b&&b(a,e)})};c.prototype.getOwnIdx=function(){return localStorage?localStorage.getItem("x.hub.m.gateway.DB"+this._tenantIdx+"NeoIdx"):-1};c.prototype._load=function(a){var b=this;require("m.aio.devicemanager.js")._loadTenant(this._tenant,function(d){d&&
b._logger.log("warn","init device error:"+d.message);a&&a(d)})};c.prototype._generateTenantParent=function(a){return{fileManager:a,getFolderPath:function(){return this.fileManager.getUserRootDataPath()},getFolder:function(){return""}}};return c}();
x.hub.deviceman.DeviceManagerV6=function(){var c=function(){this._logger=require("x.logger.js").getLogger("x.hub.deviceman.DeviceManagerV6");this._devices=this._dataFolder=null;this._statesBuffer={}};c.FILE_NAME="db_v6.enc";c.prototype.getGateways=function(){return this._devices&&this._devices.gateways?this._devices.gateways:{}};c.prototype.getGateway=function(a){return this._devices&&this._devices.gateways&&this._devices.gateways[a]?this._devices.gateways[a]:null};c.prototype.setGateway=function(a,
b,d){a?(b?this._devices.gateways[a]=b:delete this._devices.gateways[a],this._writeDB(function(a){d&&d(a,b)})):d&&d(Error("invalid gateway id"))};c.prototype.getDevices=function(){return this._devices&&this._devices.devices?this._devices.devices:{}};c.prototype.getDevice=function(a){return this._devices&&this._devices.devices&&this._devices.devices[a]?this._devices.devices[a]:null};c.prototype.setDevice=function(a,b,d){a?(b?this._devices.devices[a]=b:(delete this._devices.devices[a],delete this._statesBuffer[a]),
this._writeDB(function(a){d&&d(a,b)})):d&&d(Error("invalid device id"))};c.prototype.setBufferedStates=function(a,b){a&&(b?this._statesBuffer[a]=b:delete this._statesBuffer[a])};c.prototype.getAllBufferedStates=function(){return this._statesBuffer};c.prototype.init=function(a,b,d){this._logger.log("info","init device manager v6");var e=require("path");b=b.getUserRootDataPath();this._dataFolder=e.resolve(b,"db_v6");this._initHttpApi(a);this._loadDB(function(a){d&&d(a)})};c.prototype._initHttpApi=function(a){var b=
this,d=require("x.hub.js").getServer();a.get("/api/gateways",function(a,c,f){d.auth(a)?(a=b.getGateways(),c.json({XC_SUC:a?a:{}})):c.json({XC_ERR:{code:"000007",msg:"access denied"}})});a.get("/data/gtw/:id",function(a,c,f){d.auth(a)?(a=b.getGateway(a.params.id))?c.json({XC_SUC:a}):c.json({XC_ERR:{code:"000101",msg:"failed to open file"}}):c.json({XC_ERR:{code:"000007",msg:"access denied"}})});a.post("/data/gtw/:id",function(a,c){if(d.auth(a)){var e=new Buffer(0);a.on("data",function(a){e=Buffer.concat([e,
a])});a.on("end",function(){var d=a.params.id,g=e.toString("utf8");try{var f=null;g&&(f=JSON.parse(g));b.setGateway(d,f,function(a,b){a?c.json({XC_ERR:{code:"000101",msg:"failed to set gateway:"+a.message}}):b?c.json({XC_SUC:{bytes:e.length}}):c.json({XC_SUC:{bytes:0}})})}catch(l){c.json({XC_ERR:{code:"000101",msg:"failed to set gateway:"+l.message}})}})}else c.json({XC_ERR:{code:"000007",msg:"access denied"}})});a.get("/api/devices",function(a,c,f){d.auth(a)?(a=b.getDevices(),c.json({XC_SUC:a?a:
{}})):c.json({XC_ERR:{code:"000007",msg:"access denied"}})});a.get("/data/dev/:id",function(a,c,f){d.auth(a)?(a=b.getDevice(a.params.id))?c.json({XC_SUC:a}):c.json({XC_ERR:{code:"000101",msg:"failed to open file"}}):c.json({XC_ERR:{code:"000007",msg:"access denied"}})});a.post("/data/dev/:id",function(a,c){if(d.auth(a)){var e=new Buffer(0);a.on("data",function(a){e=Buffer.concat([e,a])});a.on("end",function(){var d=a.params.id,f=e.toString("utf8");try{var g=null;f&&(g=JSON.parse(f));b.setDevice(d,
g,function(a,b){a?c.json({XC_ERR:{code:"000101",msg:"failed to set device:"+a.message}}):b?c.json({XC_SUC:{bytes:e.length}}):c.json({XC_SUC:{bytes:0}})})}catch(l){c.json({XC_ERR:{code:"000101",msg:"failed to set device:"+l.message}})}})}else c.json({XC_ERR:{code:"000007",msg:"access denied"}})})};c.prototype._loadDB=function(a){var b=require("fs-extra"),c=this._getFile(),e=this;b.ensureFile(c,function(b){b?a(b):e._loadFile(function(b,c){b?(e._devices={gateways:{},devices:{}},a(b)):(e._devices=c?c:
{gateways:{},devices:{}},a())})})};c.prototype._writeDB=function(a){this._writeFile(this._devices,function(b){a(b)})};c.prototype._getFile=function(){return require("path").resolve(this._dataFolder,c.FILE_NAME)};c.prototype._loadFile=function(a){var b=require("fs"),c=this._getFile(),e=this;b.readFile(c,"utf8",function(b,c){if(b)a(b);else if(c)try{c=require("x.crypt").AES.decodeString(c,e._ml_v1_info());var d=JSON.parse(c);a(null,d)}catch(k){a(null,{})}else a(null,"")})};c.prototype._writeFile=function(a,
b){var c=require("fs"),e=require("x.crypt.js"),g=this._getFile();try{var f=e.AES.encodeString(JSON.stringify(a),this._ml_v1_info());c.writeFile(g,f,function(a){b&&b(a)})}catch(h){b&&b(h)}};c.prototype._ml_v1_info=function(){return require("x.crypt").SHA1("0cc6c6df12537fc79522a1ac15f1f592e93fdeb3")};return c}();x.hub.deviceman.Handler=function(){this.deviceManager=new x.hub.deviceman.DeviceManager("db",1);this.deviceManager2=new x.hub.deviceman.DeviceManager("db2",2);this.deviceManagerV6=new x.hub.deviceman.DeviceManagerV6};
x.hub.deviceman.Handler.prototype.DeviceManager=x.hub.deviceman.DeviceManager;x.hub.deviceman.Handler.prototype.init=function(c,a,b){this._config(c);var d=0;this.deviceManager.init(a,function(a){d++;3==d&&b&&b(a)});this.deviceManager2.init(a,function(a){d++;3==d&&b&&b(a)});this.deviceManagerV6.init(c,a,function(a){d++;3==d&&b&&b(a)})};
x.hub.deviceman.Handler.prototype._config=function(c){var a=this;c.use("/xhub/devicemanager/:id/:type",function(a,c,e){if(a._body)return e();a.body=a.body||{};if("GET"==a.method||"HEAD"==a.method||!a.is("text/xml"))return e();a._body=!0;var b="";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){a.body=b;e()})});c.use("/xhub/devicemanager/:id/:type",function(b,c){var d=b.method.toLowerCase(),g=b.params.id,f=b.params.type,h=null,k=null;switch(d){case "get":k="readWithoutLicense";
h=b.query;break;case "post":k="create";h=b.body;break;case "put":k="update";h=b.body;break;case "delete":k="delete",h=b.query.index}k?a.deviceManager.execute(k,g,f,h,function(a,b){a?c.send(this.error2json(a)):b.toJSON&&"function"==typeof b.toJSON?c.send(b.toJSON()):(f&&"deviceinfo"==f&&c.set("Content-Type","text/xml"),c.send(b))}.bind(this)):(b=Error("invalid http method"),b.code=500,c.send(this.error2json(b)))}.bind(this))};module.exports=new x.hub.deviceman.Handler;
