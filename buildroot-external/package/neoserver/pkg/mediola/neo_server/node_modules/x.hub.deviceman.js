var x=x||{};x.hub=x.hub||{};x.hub.deviceman=x.hub.deviceman||{};
x.hub.deviceman.DeviceManager=function(){var d=function(b,a){this._logger=require("x.logger.js").getLogger("x.hub.deviceman.DeviceManager");this._tenant=null;this._folder=b;this._folder||(this._folder="db");this._tenantIdx=a;this._tenantIdx||(this._tenantIdx=1)};d.prototype.init=function(b,a){this._logger.log("info","init device managaer:"+this._folder);var c=require("m.aio.configmanager.js");b=this._generateTenantParent(b);this._tenant=new c.Tenant(b);this._tenant.index=this._tenantIdx;this._tenant.license=
"dummy";this._tenant.folder=this._folder;var d=this;require("fs-extra").ensureDir(this._tenant.getFolderPath(),function(){d._load(a)})};d.prototype.reload=function(b){var a=this;require("m.aio.devicemanager.js").reloadTenant(this._tenant,function(c){c&&a._logger.log("warn","reload device error:"+c.message);b&&b(c)})};d.prototype.execute=function(b,a,c,d,h){try{require("m.aio.devicemanager.js").execute(b,this._tenant.index,c,d,h)}catch(f){console.error(f.stack)}};d.prototype.getDeviceInfo=function(){var b=
require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return b?b.getDeviceInfo():null};d.prototype.findDevice=function(b,a){var c=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return c?c.findDeviceIgnoreLicense(b,a):null};d.prototype.findGateway=function(b){var a=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return a?a.findGatewayIgnoreLicense(b):null};d.prototype.findGatewayWithIndex=function(b){var a=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);
return a?a.findGatewayWithIndexIngnoreLicense(b):null};d.prototype.findDeviceWithIndex=function(b){var a=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return a?a.findDeviceWithIndexIngnoreLicense(b):null};d.prototype._load=function(b){var a=this;require("m.aio.devicemanager.js")._loadTenant(this._tenant,function(c){c&&a._logger.log("warn","init device error:"+c.message);b&&b(c)})};d.prototype._generateTenantParent=function(b){return{fileManager:b,getFolderPath:function(){return this.fileManager.getUserRootDataPath()},
getFolder:function(){return""}}};return d}();x.hub.deviceman.Handler=function(){this.deviceManager=new x.hub.deviceman.DeviceManager("db",1);this.deviceManager2=new x.hub.deviceman.DeviceManager("db2",2)};x.hub.deviceman.Handler.prototype.DeviceManager=x.hub.deviceman.DeviceManager;x.hub.deviceman.Handler.prototype.init=function(d,b,a){this._config(d);var c=0;this.deviceManager.init(b,function(b){c++;2==c&&a&&a(b)});this.deviceManager2.init(b,function(b){c++;2==c&&a&&a(b)})};
x.hub.deviceman.Handler.prototype._config=function(d){var b=this;d.use("/xhub/devicemanager/:id/:type",function(a,b,d){if(a._body)return d();a.body=a.body||{};if("GET"==a.method||"HEAD"==a.method||!a.is("text/xml"))return d();a._body=!0;var c="";a.setEncoding("utf8");a.on("data",function(a){c+=a});a.on("end",function(){a.body=c;d()})});d.use("/xhub/devicemanager/:id/:type",function(a,c){var d=a.method.toLowerCase(),h=a.params.id,f=a.params.type,g=null,e=null;switch(d){case "get":e="readWithoutLicense";
g=a.query;break;case "post":e="create";g=a.body;break;case "put":e="update";g=a.body;break;case "delete":e="delete",g=a.query.index}e?b.deviceManager.execute(e,h,f,g,function(a,b){a?c.send(this.error2json(a)):b.toJSON&&"function"==typeof b.toJSON?c.send(b.toJSON()):(f&&"deviceinfo"==f&&c.set("Content-Type","text/xml"),c.send(b))}.bind(this)):(a=Error("invalid http method"),a.code=500,c.send(this.error2json(a)))}.bind(this))};module.exports=new x.hub.deviceman.Handler;
