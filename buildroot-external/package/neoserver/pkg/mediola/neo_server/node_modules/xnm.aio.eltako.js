var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.eltako=xnm.aio.eltako||{};xnm.aio.eltako.Gateway=function(){var d=function(b){this._ip=b.ip;this._port=b.port;this._username=b.username;this._password=b.password;this._uuid=b.uuid;this._port||(this._port=35689)};d.parseJSON=function(b){return b&&b.ip?new d(b):null};return d}();
xnm.aio.eltako._Session=function(){var d=[135,168,230,29,180,182,102,60,255,187,209,156,101,25,89,153,140,238,246,8,102,13,208,242,93,44,238,212,67,94,59,0,224,13,248,241,214,25,87,212,250,247,223,69,97,178,170,48,22,195,217,17,52,9,111,170,59,244,41,109,131,14,154,124,32,158,12,100,151,81,122,189,90,138,157,48,107,207,103,237,145,249,230,114,91,71,88,192,34,224,177,239,66,117,191,123,108,91,252,17,212,95,144,136,185,65,245,78,177,229,155,184,188,57,160,191,18,48,127,92,79,219,112,197,129,178,63,
118,182,58,202,225,202,166,183,144,45,82,82,103,53,72,138,14,241,60,109,154,81,191,164,171,58,216,52,119,150,82,77,142,246,161,103,181,164,24,37,217,103,225,68,229,20,5,100,37,28,202,203,131,230,180,134,246,179,202,63,121,113,80,96,38,192,184,87,246,137,150,40,86,222,212,1,10,189,11,230,33,195,163,150,10,84,231,16,195,117,242,99,117,215,1,65,3,164,181,67,48,193,152,175,18,97,22,210,39,110,17,113,95,105,56,119,250,215,239,9,202,219,9,74,233,30,26,21,151],b=[63,179,44,155,115,19,77,11,46,119,80,102,
96,237,189,72,76,167,177,143,33,239,32,84,7,244,121,58,26,11,161,37,16,219,193,80,119,190,70,63,255,79,237,74,172,11,181,85,190,58,108,27,12,107,71,177,188,55,115,191,126,140,111,98,144,18,40,248,194,140,187,24,165,90,227,19,65,0,10,101,1,150,249,49,199,122,87,242,221,244,99,229,233,236,20,75,119,125,230,42,170,184,168,98,138,195,118,210,130,214,237,56,100,230,121,130,66,142,188,131,29,20,52,143,111,47,145,147,181,4,90,242,118,113,100,225,223,201,103,193,251,63,46,85,164,189,27,255,232,59,156,128,
208,82,185,133,209,130,234,10,219,42,59,115,19,211,254,20,200,72,75,30,5,37,136,185,183,210,187,210,223,1,97,153,236,208,110,21,87,205,9,21,179,53,59,187,100,224,236,55,127,208,40,55,13,249,43,82,199,137,20,40,205,198,126,182,24,75,82,61,29,178,70,195,47,99,7,132,144,240,14,248,214,71,209,72,212,121,84,81,94,35,39,207,239,152,197,130,102,75,76,15,108,196,22,89],a=function(c){if(!c)throw Error("options is null");if(!c.ip)throw Error("no ip");this._timeout=3E3;this._ip=c.ip;this._port=c.port;this._port||
(this._port=35689);this._username=c.username;this._password=c.password;this._logger=require("x.logger.js").getLogger("xnm.aio.eltako._Session.{"+this._ip+":"+this._port+"}");this._state="IDLE";this._listeners={};this._socket=null;this._sequenceID=0;this._buffer={};this._auth=this._settings=null};a.prototype.on=function(c,a){c&&a&&(this._listeners[c]||(this._listeners[c]=[]),-1==this._listeners[c].indexOf(a)&&this._listeners[c].push(a))};a.prototype.off=function(c,a){c&&a&&this._listeners[c]&&(a=this._listeners[c].indexOf(a),
-1!=a&&this._listeners[c].splice(a,1))};a.prototype.open=function(){if(!this._socket&&"IDLE"==this._state){var c=this;this._state="CONNECT";var a=new xnm.aio.eltako._Socket({ip:this._ip,port:this._port});this._logger.log("trace","start session to "+this._ip+":"+this._port);a.on("open",function(){c._logger.log("trace","_socket success connect to "+c._ip+":"+c._port);c._init()});a.on("data",function(a){c._onData(a)});a.on("error",function(a){c._logger.log("trace","_socket error: "+a.message);c._emitEvent("error",
a)});a.on("close",function(){c._logger.log("trace","_socket closed");c._onClose()});a.open();this._socket=a}};a.prototype.close=function(){this._socket&&(this._state="CLOSED",this._socket.close(),this._onClose())};a.prototype.sendObject=function(c,a){"CONNECTED"!=this._state?a&&a(Error("session not connected")):this._sendObject(c,a)};a.prototype._sendObject=function(c,a){var e=this;this._sequenceID++;var b={classType:"bsc.api.transport.TransmissionObject",object:c};b.id=(new Date).getTime()+"";b.sequenceID=
this._sequenceID;this._buffer[b.id]={callback:a,timeout:setTimeout(function(){e._onTimeout(b.id)},this._timeout)};this._logger.log("trace","send object:"+JSON.stringify(b));c=this._buildData(JSON.stringify(b));this._socket.sendData(c)};a.prototype._emitEvent=function(c,a){if(c){var e=this._listeners[c];if(e&&0<e.length)for(var b=0;b<e.length;b++){var d=e[b];try{d(a)}catch(f){this._logger.log("trace","call "+c+" listener failed, error:"+f.message)}}}};a.prototype._buildData=function(c){return require("x.crypt.js").stringToUtf8ByteArray(c)};
a.prototype._parseObject=function(c){c=require("x.crypt.js").utf8ByteArrayToString(c);try{return JSON.parse(c)}catch(e){return null}};a.prototype._init=function(){var c=this;this._doConnectRequest(function(a,b){a?(c._emitEvent("error",a),c.close()):c._sendCaps(null,null,null,b.apiVersions?b.apiVersions[0]:null,b.apiExtensions,function(a,e){a?(c._emitEvent("error",a),c.close()):(c._settings=e,a=c._genKeySig(c._username,c._password),c._sendAuth(c._username,a.key,a.signature,function(a,e){a?(c._emitEvent("error",
a),c.close()):(c._auth=e,c._emitEvent("open",c._settings,c._auth))}))})})};a.prototype._genKeySig=function(a,e){var c=this._genDHKey(),b=(new Buffer(c,"hex")).toString("base64");a=this._genSignature(a,e,c);a=(new Buffer(a,"hex")).toString("base64");return{key:b,signature:a}};a.prototype._genDHKey=function(){var a=require("x.crypt.js"),e=a.bigInt(a.byteArrayToHex(d),16);a=a.bigInt.randBetween(a.bigInt("730750818665451459101842416358141509827966271488"),e.minus(2));e=require("crypto").createDiffieHellman(new Buffer(d),
null,new Buffer(b),null);e.setPrivateKey(a.toString(16),"hex");return e.generateKeys("hex")};a.prototype._genSignature=function(a,e,b){var c=require("crypto"),d=c.createHash("sha256");d.update(e);d=d.digest("hex");a+=d;d=c.createHash("sha256");d.update(b,"hex");b=d.digest("hex");d=c.createHash("sha256");d.update(a,"utf8");d=d.digest("hex");c=c.createCipher("aes-128-cbc",new Buffer(d,"hex"));b=c.update(new Buffer(b,"hex"),null,"hex");return b+=c.final("hex")};a.prototype._doConnectRequest=function(a){this._sendObject({classType:"bsc.api.transport.commands.ConnectionRequest",
metaInformation:{classType:"Map",keyType:"String",valueType:"String",data:[["M2M->VID","0#2#0010F3601410"]]}},function(c,b){c?a&&a(c):b.object&&"bsc.api.transport.result.ObjectResult"==b.classType?(c=b.object)&&"bsc.api.transport.model.Caps"==c.classType?(b={protocols:[],encryptions:[],compressions:[],apiVersions:[],apiExtension:[]},c.protocols&&c.protocols.data&&(b.protocols=c.protocols.data),c.encryptions&&c.encryptions.data&&(b.encryptions=c.encryptions.data),c.compressions&&c.compressions.data&&
(b.compressions=c.compressions.data),c.apiVersions&&c.apiVersions.data&&(b.apiVersions=c.apiVersions.data),c.apiExtensions&&c.apiExtensions.data&&(b.apiExtensions=c.apiExtensions.data),a&&a(null,b)):a&&a(Error("do ConnectionRequest failed:"+JSON.stringify(reponse.object))):a&&a(Error("do ConnectionRequest failed:"+JSON.stringify(reponse)))})};a.prototype._sendCaps=function(a,b,d,g,h,f){a||(a={classType:"Enum",enumType:"bsc.api.Enumerations$ProtocolType",name:"JSON"});b||(b={classType:"Enum",enumType:"bsc.api.Enumerations$EncryptionType",
name:"NONE"});d||(d={classType:"Enum",enumType:"bsc.api.Enumerations$CompressionType",name:"NONE"});g||(g={classType:"Enum",enumType:"bsc.api.Enumerations$ApiVersion",name:"Ver_2_1_0"});h||(h="CORE VOICECONTROL TEACHIN TIMER M2M CAMERA CONNECTIONS USERMANAGEMENT OBJECT_TAG MESSAGE BSC ALEXA QoS HEATER USERCONFIG PARAMETER HISTORY".split(" "));this._sendObject({classType:"bsc.api.transport.model.Caps",protocols:{classType:"List",valueType:"bsc.api.Enumerations$ProtocolType",data:[a]},encryptions:{classType:"List",
valueType:"bsc.api.Enumerations$EncryptionType",data:[b]},compressions:{classType:"List",valueType:"bsc.api.Enumerations$CompressionType",data:[d]},apiVersions:{classType:"List",valueType:"bsc.api.Enumerations$ApiVersion",data:[g]},apiExtensions:{classType:"List",valueType:"String",data:h},metaInformation:{classType:"Map",keyType:"String",valueType:"String",data:[["BSC->PRODUCT","10004"]]}},function(a,c){a?f&&f(a):c.object&&"bsc.api.transport.result.ObjectResult"==c.classType?(a=c.object)&&"bsc.api.transport.model.Settings"==
a.classType?(a={protocol:a.protocol,encryption:a.encryption,compression:a.compression,apiVersion:a.apiVersion,apiExtensions:a.apiExtensions},f&&f(null,a)):f&&f(Error("send Caps failed:"+JSON.stringify(reponse.object))):f&&f(Error("send Caps failed:"+JSON.stringify(reponse)))})};a.prototype._sendAuth=function(a,b,d,g){this._sendObject({classType:"bsc.api.transport.model.Auth",key:b,signature:d,user:a},function(a,c){a?g&&g(a):c.object&&"bsc.api.transport.result.ObjectResult"==c.classType?(a=c.object)&&
"bsc.api.transport.model.Auth"==a.classType?(a={user:a.user,signature:a.signature,sessionID:a.sessionID},g&&g(null,a)):g&&g(Error("send Auth failed:"+JSON.stringify(reponse.object))):g&&g(Error("send Auth failed:"+JSON.stringify(reponse)))})};a.prototype._onTimeout=function(a){var c=this._buffer[a];c&&(delete this._buffer[a],c.timeout&&clearTimeout(c.timeout),c.callback&&c.callback(Error("response timeout")))};a.prototype._onData=function(a){a=this._parseObject(a);this._logger.log("trace","receive object:"+
JSON.stringify(a));if(a&&a.id&&a.object)if(a.sequenceID&&(this._sequenceID=a.sequenceID),a.object.resultType){var c=this._buffer[a.id];c&&a.object.resultType&&"bsc.api.transport.result.Result$ResultType"==a.object.resultType.enumType?(delete this._buffer[a.id],c.timeout&&clearTimeout(c.timeout),c.callback&&c.callback(null,a.object)):this._emitEvent("object",a.object,function(a){})}else this._emitEvent("object",a.object,function(a){})};a.prototype._onClose=function(){this._state="CLOSED";this._socket=
null;this._emitEvent("close");this._listeners={};var a=this._buffer;this._buffer={};this._sequenceID=0;this._settings=null;for(var b in a){var d=a[b];d&&(d.timeout&&clearTimeout(d.timeout),d.callback&&d.callback(Error("session closed")))}};return a}();
xnm.aio.eltako._Socket=function(){var d=function(b){if(!b)throw Error("options is null");if(!b.ip)throw Error("no ip");this._ip=b.ip;this._port=b.port;this._port||(this._port=35689);this._logger=require("x.logger.js").getLogger("xnm.aio.eltako._Socket.{"+this._ip+":"+this._port+"}");this._timeout=2E3;this._listeners={};this._state="IDLE";this._encrypt=this._compress=this._buf=this._socket=null};d.prototype.on=function(b,a){b&&a&&(this._listeners[b]||(this._listeners[b]=[]),-1==this._listeners[b].indexOf(a)&&
this._listeners[b].push(a))};d.prototype.off=function(b,a){b&&a&&this._listeners[b]&&(a=this._listeners[b].indexOf(a),-1!=a&&this._listeners[b].splice(a,1))};d.prototype.setCompress=function(b){this._compress=b};d.prototype.setEncrpty=function(b){this._encrypt=b};d.prototype.open=function(){if(!this._socket&&"IDLE"==this._state){var b=this;this._state="CONNECT";this._buf="";var a=require("net").connect({port:this._port,host:this._ip});a.setTimeout(this._timeout);this._logger.log("trace","start connect to "+
this._ip+":"+this._port);a.on("connect",function(){b._logger.log("trace","success to connect "+b._ip+":"+b._port);b._state="CONNECTED";b._emitEvent("open")});a.on("data",function(a){a.readUInt8&&(a=b._bufferToArray(a));var c=require("x.crypt.js");b._logger.log("trace","receive data: "+c.byteArrayToHex(a));b._onData(a)});a.on("error",function(a){b._logger.log("trace","socket error: "+a.message);b._emitEvent("error",a)});a.on("timeout",function(){"CONNECT"==b._state&&(b._logger.log("trace","connect timeout"),
b._emitEvent("error",Error("connect timeout")),b.close())});a.on("close",function(){b._logger.log("trace","socket closed");b._onClose()});a._doConnect&&"function"==typeof a._doConnect&&a._doConnect();this._socket=a}};d.prototype.close=function(){this._socket&&(this._state="CLOSED",this._socket.destroy(),this._onClose())};d.prototype.sendData=function(b,a){var c=require("x.crypt.js");this._logger.log("trace","send data:"+c.byteArrayToHex(b));"CONNECTED"!=this._state?a&&a(Error("socket not connected")):
(b=this._buildPacket(b),this._logger.log("trace","send packet:"+c.byteArrayToHex(b)),this._socket.write(new Buffer(b),"binary",function(c){a&&a(c)}))};d.prototype._buildPacket=function(b){var a=b.length;a=this._int32ToArray(2).concat(this._int32ToArray(a));var c=require("x.crypt.js"),e=c.CRC32(a);c=c.CRC32(b);e=this._int32ToArray(e).concat(this._int32ToArray(c));return[85].concat(a).concat(e).concat(b)};d.prototype._emitEvent=function(b,a){if(b){var c=this._listeners[b];if(c&&0<c.length)for(var e=
0;e<c.length;e++){var d=c[e];try{d(a)}catch(g){this._logger.log("trace","call "+b+" listener failed, error:"+g.message)}}}};d.prototype._arrayToInt32=function(b){b=((b[0]&255)<<24)+((b[1]&255)<<16)+((b[2]&255)<<8)+(b[3]&255);return 0>b?4294967296+b:b};d.prototype._int32ToArray=function(b){return[b>>24&255,b>>16&255,b>>8&255,b&255]};d.prototype._bufferToArray=function(b){for(var a=[],c=0;c<b.length;c++)a.push(b[c]);return a};d.prototype._onData=function(b){this._buf=this._buf?this._buf.concat(b):b;
b=this._buf.length;for(var a=0;a<b;){if(85==this._buf[a]){if(b<=a+17)break;var c=this._buf.slice(a+5,a+9);c=this._arrayToInt32(c);if(b<a+17+c)break;var e=this._buf.slice(a,a+17+c);(e=this._parsePacket(e))&&this._emitEvent("data",e);a+=17+c-1}a++}this._buf=a==b?null:this._buf.slice(a)};d.prototype._parsePacket=function(b){var a=require("x.crypt.js");this._logger.log("trace","receive packet:"+a.byteArrayToHex(b));var c=b.slice(1,9),e=b.slice(9,17);b=b.slice(17);var d=this._arrayToInt32(c.slice(0,4)),
g=this._arrayToInt32(c.slice(4)),h=this._arrayToInt32(e.slice(0,4));e=this._arrayToInt32(e.slice(4));c=a.CRC32(c);a=a.CRC32(b);this._logger.log("trace","parse packet t:"+d+" l:"+g+" crc_h:<"+h+","+c+"> crc_d:<"+e+","+a+">");return b};d.prototype._onClose=function(){this._state="CLOSED";this._socket=null;this._emitEvent("close");this._listeners={};this._buf=null};return d}();
xnm.aio.eltako.BR64=function(){var d=function(a,c,b){this._logger=require("x.logger.js").getLogger("xnm.aio.eltako.BR64");this._ip=a;this._port=c;this._port||(this._port=4443);this._mac=b;this._timeout=1E4;this._httpReqBuffer=[];"undefined"!=typeof process&&null!=process&&process.env&&(this._keepAliveAgent=new (require("https").Agent)({keepAlive:!0,maxSockets:1}))};d.prototype._getSystem=function(a){this._doRequest("GET","/system",null,function(c,b){if(c)a&&a(c);else if(b)try{var e=JSON.parse(b);
a&&a(null,e)}catch(g){a&&a(Error("invalid response"))}else a&&a(Error("invalid response"))})};d.prototype._getDevices=function(a){this._doRequest("GET","/devices",null,function(c,b){if(c)a&&a(c);else if(b)try{var e=JSON.parse(b);a&&a(null,e)}catch(g){a&&a(Error("invalid response"))}else a&&a(Error("invalid response"))})};d.prototype._getDevice=function(a,c){this._doRequest("GET","/device("+a+")",null,function(a,b){if(a)c&&c(a);else if(b)try{var e=JSON.parse(b);c&&c(null,e)}catch(h){c&&c(Error("invalid response"))}else c&&
c(Error("invalid response"))})};d.prototype._setDeviceState=function(a,c,b){this._doRequest("PATCH","/devices("+a+")",JSON.stringify(c),function(a,c){if(a)b&&b(a);else if(c)try{var e=JSON.parse(c);b&&b(null,e)}catch(f){b&&b(Error("invalid response"))}else b&&b(Error("invalid response"))})};d.prototype._doRequest=function(a,c,b,d){var e=this._httpReqBuffer.length;this._httpReqBuffer.push({method:a,path:c,data:b,callback:d});0==e&&this._doNextHttpReq()};d.prototype._doNextHttpReq=function(){if(0!=this._httpReqBuffer.length){var a=
this._httpReqBuffer[0],c=this;this._doRequestHttp(a.method,a.path,a.data,function(b,d){a.callback&&a.callback(b,d);c._httpReqBuffer.splice(0,1);c._doNextHttpReq()})}};d.prototype._doRequestHttp=function(a,c,b,d){var e="https://"+this._ip+":"+this._port+c;this._logger.log("trace","send "+a+" to url: "+e+" data:"+b);a={host:this._ip,port:this._port,path:c,method:a,headers:{}};b&&(a.headers["Content-Length"]=b.length);var h=this,f=d;d=require("https");"undefined"!=typeof process&&null!=process&&process.env&&
(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0",a.agent=this._keepAliveAgent);var l=d.request(a,function(a){a.setEncoding("utf-8");var c="";a.on("data",function(a){c+=a});a.on("end",function(){h._logger.log("trace",e+" response "+a.statusCode+": "+c);if(200==a.statusCode)f&&f(null,c);else{var b=Error("http response "+a.statusCode);f&&f(b)}f=null})});l.setTimeout(this._timeout,function(){h._logger.log("trace","http request "+e+" timeout");f&&(f(Error("http request timeout")),f=null);l.abort()});l.on("error",
function(a){h._logger.log("trace","http request "+e+" error:"+a.message);f&&(f(a),f=null)});b&&l.write(b);l.end()};d.prototype.toJSON=function(){return{sys:"eltako_br64",ip:this._ip,port:this._port,mac:this._mac}};d.parseJSON=function(a){if(!a||!a.ip||!a.type)return null;switch(a.type){case "fsr64":return new b(a.ip,a.port,a.mac);default:return null}};var b=function(a,c,b){d.call(this,a,c,b);this._logger=require("x.logger.js").getLogger("xnm.aio.eltako.FSR")};b.prototype=new d;b.prototype.constructor=
b;b.prototype.executeCommandCreator=function(a,c,b){if(c&&c.value)switch(c.value){case "on":this.on(b);break;case "off":this.off(b);break;case "toggle":this.toggle(b);break;default:b&&b(Error("unknown command"))}else b&&b(Error("command value is empty"))};b.prototype.getStatesCreator=function(a,c,b){this.getStates(function(a,d){if(a)b&&b(a);else{a=[];for(var e=0;e<c.length;e++){var f=c[e];if(f&&f.id&&f.status&&f.status.value)switch(f.status.value){case "state":a.push({id:f.id,status:d?d[f.status.value]:
"?"})}}b&&b(null,a)}})};b.prototype.on=function(a){this._setDeviceState(0,{State:{relay_state:[!0]}},function(c){a&&a(c)})};b.prototype.off=function(a){this._setDeviceState(0,{State:{relay_state:[!1]}},function(c){a&&a(c)})};b.prototype.toggle=function(a){var c=this;this.getStates(function(b,d){if(b)a&&a(b);else if("on"==d.state)c.off(a);else c.on(a)})};b.prototype.getStates=function(a){this._getDevices(function(c,b){c?a&&a(c):b&&b.devices&&b.devices[0]?(c=b.devices[0],c.State&&c.State.relay_state&&
c.State.relay_state.length?(c=c.State.relay_state[0],a&&a(null,{state:1==c?"on":"off"})):a&&a(Error("invalid response"))):a&&a(Error("invalid response"))})};b.prototype.equalsTo=function(a){return a&&a instanceof b?this._ip==a._ip&&this._port==a._port:!1};b.prototype.toJSON=function(){var a=d.prototype.toJSON.call(this);a.type="fsr64";return a};d.FSR=b;return d}();
xnm.aio.eltako.DM=function(){var d=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};d.prototype=Error();d.prototype.name="EltakoDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var b={fsr64:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}}]}};
return{SYS:"eltako_br64",getIPDeviceType:function(){return[{sys:this.SYS,name:"eltako BR64"}]},createDevice:function(a,b,e){b=d.ERROR_CODE;a?a.type?a.ip?e(null,a):e(new d(b.INVALID,"ip is invalid")):e(new d(b.INVALID,"type is invalid")):e(new d(b.INVALID,"info is invalid"))},updateDevice:function(a,b,e){b=d.ERROR_CODE;a?a.type?a.ip?e(null,a):e(new d(b.INVALID,"ip is invalid")):e(new d(b.INVALID,"type is invalid")):e(new d(b.INVALID,"info is invalid"))},deleteDevice:function(a,b,d){d()},applyUIFilter:function(a,
b,d){var c=this,e=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},h=function(a,b,c){var d=[];switch(c.catagory){case "command":a.command&&a.command.forEach(function(a){e(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))});break;case "status":a.status&&a.status.forEach(function(a){e(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))})}return d},f=function(a,b){var e=[],f=c.getCommandStatusMap(a,d);f&&(a=h(f,a,b),e=e.concat(a));
return e};if(!a.sys)return null;var m=JSON.parse(JSON.stringify(a)),k=null;switch(b.catagory){case "command":k=f(a,b);m.command=k;break;case "status":k=f(a,b);m.status=k;break;default:return null}return k&&0!=k.length?m:null},getCommandStatusMap:function(a){return a&&a.type?b[a.type]:null}}}();
xnm.aio.eltako.Handler=function(){var d=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.eltako.Handler ");this._getDeviceListTo=this._controller=null};d.prototype.Socket=xnm.aio.eltako._Socket;d.prototype.Session=xnm.aio.eltako._Session;d.prototype.Gateway=xnm.aio.eltako.Gateway;d.prototype.BR64=xnm.aio.eltako.BR64;d.prototype.devicemanager=xnm.aio.eltako.DM;d.prototype.registModule=function(b){b.register(this.devicemanager.SYS,"eltako")};d.prototype.resolveDevice=function(b){return this.BR64.parseJSON(b)};
d.prototype.getDeviceCommands=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,{catagory:"command",elems:"*"}))?b.command:[];a&&a(null,b)};d.prototype.getDeviceStatus=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,{catagory:"status",elems:"*"}))?b.status:[];a&&a(null,b)};d.prototype.doCommand=function(b,a,c){var d=this.resolveDevice(b);d?d.executeCommandCreator(b,a,function(a){c&&c(a)}):c&&c(Error("device json format invalid"))};d.prototype.doStatus=function(b,a,c,d){var e=this.resolveDevice(a);
e?e.getStatesCreator(null,[{id:b,device:a,status:c}],function(a,b){a?d&&d(a):d&&d(null,b[0])}):d&&d(Error("device json format invalid"))};d.prototype.discoverDevices=function(b,a){var c=require("x.mdns.js"),d=this;c.clearRecordBuffer();c.discoverServiceWithTimeout("_hap._tcp.local",b,function(b,c){if(b)a&&a(b);else{d._logger.log("trace","find _hap._tcp.local: "+JSON.stringify(c));b=[];for(var e=0;e<c.length;e++){var f=c[e];f&&f.info&&f.info.md&&"FSR64"==f.info.md&&(f={sys:"eltako_br64",ip:f.ip[0],
port:4443,mac:f.info.id,type:f.info.md.toLowerCase(),name:f.domain.substr(0,f.domain.indexOf("."))},b.push(f))}a&&a(null,b)}})};return d}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.eltako.Handler);
