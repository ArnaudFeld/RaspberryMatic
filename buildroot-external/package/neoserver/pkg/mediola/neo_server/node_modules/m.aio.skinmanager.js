var m=m||{};m.aio=m.aio||{};m.aio.skinmanager=m.aio.skinmanager||{};m.aio.skinmanager.Resource=function(){this.mtime=this.size=this.sha1=this.file=this.name=this.widget=null};m.aio.skinmanager.Resource.load=function(a,b,e,d){var c=require("unorm"),f=new m.aio.skinmanager.Resource;f.widget=e;f.name=c.nfc(b);f.file=a;d&&d(null,f)};m.aio.skinmanager.Resource.loadSync=function(a,b,e){var d=require("unorm"),c=new m.aio.skinmanager.Resource;c.widget=e;c.name=d.nfc(b);c.file=a;return c};
m.aio.skinmanager.Resource.prototype={copy:function(a,b,e){this._copy(this.file,a,b,e)},copySync:function(a,b){this._copySync(this.file,a,b)},_copy:function(a,b,e,d){var c=require("fs-extra"),f=require("path");b?e?this.widget&&this.widget.type&&this.widget.name?this.file?(b=b+f.sep+e+f.sep+this.widget.type+f.sep+this.widget.name+f.sep+this.name,b==this.file?d&&d():c.copy(a,b,{clobber:!0},function(a){d&&d(a)})):d&&d(Error("resource file invalid")):d&&d(Error("resource widget invalid")):d&&d(Error("skinId invalid")):
d&&d(Error("skinFolder invalid"))},_copySync:function(a,b,e){var d=require("fs-extra"),c=require("path");if(!b)throw Error("skinFolder invalid");if(!e)throw Error("skinId invalid");if(!this.widget||!this.widget.type||!this.widget.name)throw Error("resource widget invalid");if(!this.file)throw Error("resource file invalid");b=b+c.sep+e+c.sep+this.widget.type+c.sep+this.widget.name+c.sep+this.name;b!=this.file&&d.copySync(a,b,{clobber:!0})},del:function(a){this.file?require("fs").unlink(this.file,function(b){a&&
a(b)}.bind(this)):a&&a(Error("resource file invalid"))},getRef:function(){if(!this.widget||!this.widget.skin)return null;var a="";if(this.widget.skin instanceof m.aio.skinmanager.DummySkin||this.widget.skin instanceof m.aio.skinmanager.LocalCustomWidgetDummySkin)a=m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER+"/";return a+this.widget.type+"/"+this.widget.name+"/"+this.name},getURL:function(){if(!this.widget||!this.widget.skin)return null;var a=this.widget.skin.getURL();a.widgetType=
this.widget.type;a.widgetName=this.widget.name;a.resourcePath=this.name;return a.toString()},toJSON:function(){return{name:this.name,ref:this.getRef(),url:this.getURL()}}};m.aio.skinmanager.Widget=function(){this.name=this.type=this.skin=null;this.resources=[]};m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_TYPE="misc";m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_NAME="default";
m.aio.skinmanager.Widget.loadType=function(a,b,e,d){var c=require("fs"),f=require("async"),g=require("path");c.readdir(a,function(c,n){if(c)d&&d(c);else{var k=[];f.eachLimit(n,100,function(c,d){m.aio.skinmanager.Widget.load(a+g.sep+c,b,c,e,function(a,b){!a&&b&&k.push(b);d()})},function(a){d&&d(a,k)})}})};
m.aio.skinmanager.Widget.load=function(a,b,e,d,c){var f=require("fs"),g=require("path");require("async");f.readdir(a,function(f,n){if(f)c&&c(f);else{f=require("unorm");var k=new m.aio.skinmanager.Widget;k.skin=d;k.type=f.nfc(b);k.name=f.nfc(e);var h=[];n.forEach(function(b){".DS_Store"!==b&&(b=new m.aio.skinmanager.Resource.loadSync(a+g.sep+b,b,k),h.push(b))});h&&0!=h.length?(k.resources=h,c&&c(null,k)):c&&c(Error("widget has no resources"))}})};
m.aio.skinmanager.Widget.prototype={getLocation:function(){var a=null;this.skin&&(a=this.skin instanceof m.aio.skinmanager.DummySkin?"in_remote_custom":this.skin instanceof m.aio.skinmanager.LocalCustomWidgetDummySkin?"local_custom":this.skin instanceof m.aio.skinmanager.RemoteSkin?"in_remote_skin":this.skin instanceof m.aio.skinmanager.CustomSkin?"local_custom_skin":"local_skin");return a},copy:function(a,b,e){this._copy(this.skin.path,a,b,e)},copySync:function(a,b){this._copySync(this.skin.path,
a,b)},_copy:function(a,b,e,d){var c=require("fs-extra"),f=require("path");a?b?e?this.type&&this.name?c.copy(a+f.sep+this.type+f.sep+this.name,b+f.sep+e+f.sep+this.type+f.sep+this.name,{clobber:!0},function(a){d&&d(a)}):d&&d(Error("widget type or name invalid")):d&&d(Error("skinId invalid")):d&&d(Error("dstSkinFolder invalid")):d&&d(Error("srcSkinFolder invalid"))},_copySync:function(a,b,e){var d=require("fs-extra"),c=require("path");if(!a)throw Error("srcSkinFolder invalid");if(!b)throw Error("dstSkinFolder invalid");
if(!e)throw Error("skinId invalid");if(!this.type||!this.name)throw Error("widget type or name invalid");d.copySync(a+c.sep+this.type+c.sep+this.name,b+c.sep+e+c.sep+this.type+c.sep+this.name,{clobber:!0})},del:function(a){if(this.skin)if(this.type)if(this.name){var b=this.skin.path;if(b){var e=require("path");require("fs-extra").remove(b+e.sep+this.type+e.sep+this.name,function(b){a&&a(b)})}else a&&a(Error("skin path is null"))}else a&&a(Error("widgetName is null"));else a&&a(Error("widgetType is null"));
else a&&a(Error("skin is null"))},hasSameRef:function(a){return this.type==a.type&&this.name==a.name},merge:function(a){if(a.resources&&0!=a.resources.length)if(this.resources&&0!=this.resources.length){for(var b=[],e=0;e<a.resources.length;e++){for(var d=!1,c=0;c<this.resources.length;c++)if(this.resources[c].name==a.resources[e].name){d=!0;this.resources[c]=a.resources[e];break}d||b.push(a.resources[e])}this.resources=this.resources.concat(b)}else this.resources=a.resources},toJSON:function(){var a=
{type:this.type,name:this.name,resources:[]};a._loc=this.getLocation();this.resources.forEach(function(b){a.resources.push(b.toJSON())});return a}};m.aio.skinmanager.Skin=function(a){this.type=a;this.path=this.info=this.schema=this.base=this.system=this.version=this.name=this.id=null};m.aio.skinmanager.Skin.SETTINGS_FILE="settings";m.aio.skinmanager.Skin.TYPE={SYSTEM:1,CUSTOM:2,REMOTE:3,DUMMY:4};
m.aio.skinmanager.Skin.load=function(a,b,e,d){if(a){var c=require("fs"),f=require("path"),g=a+f.sep+m.aio.skinmanager.Skin.SETTINGS_FILE;c.readFile(g,{encoding:"utf8"},function(c,f){if(c)d&&d(c);else if(f&&0!=f.length){c=null;try{c=JSON.parse(f)}catch(l){d&&d(Error("settings file of "+g+" is not in json"));return}if(c.name){switch(e.skinType){case m.aio.skinmanager.Skin.TYPE.SYSTEM:f=new m.aio.skinmanager.SystemSkin;break;case m.aio.skinmanager.Skin.TYPE.CUSTOM:f=new m.aio.skinmanager.CustomSkin;
break;case m.aio.skinmanager.Skin.TYPE.REMOTE:if(!e.tenantId||!e.remoteId){d&&d(Error("skinType info invalid"));return}f=new m.aio.skinmanager.RemoteSkin(e.tenantId,e.remoteId);break;case m.aio.skinmanager.Skin.TYPE.DUMMY:if(!e.tenantId||!e.remoteId){d&&d(Error("skinType info invalid"));return}f=new m.aio.skinmanager.DummySkin(e.tenantId,e.remoteId);break;default:d&&d(Error("skin type invalid"));return}f.id=b;f.name=c.name;f.version=c.version?c.version:0;f.system=c.system?c.system:1;f.base=c.base;
f.schema=c.schema?c.schema:0;f.info=c.info||null;f.path=a;d&&d(null,f)}else d&&d(Error("skin has no name"))}else d&&d(Error("settings file of "+g+" is empty"))})}else d&&d(Error("invalid skin path"))};
m.aio.skinmanager.Skin.prototype={updateVersion:function(a,b){var e=this,d=require("fs"),c=require("path"),f=this.path+c.sep+m.aio.skinmanager.Skin.SETTINGS_FILE;d.readFile(f,{encoding:"utf8"},function(c,k){if(c)b&&b(c);else if(k&&0!=k.length){c=null;try{c=JSON.parse(k)}catch(n){b&&b(Error("settings file of "+f+" is not in json"));return}parseInt(c.version)==parseInt(a)?b&&b(null):(c.version=parseInt(a),d.writeFile(f,JSON.stringify(c),{encoding:"utf8"},function(c){c||(e.version=parseInt(a));b&&b(c)}))}else b&&
b(Error("settings file of "+f+" is empty"))})},loadWidgets:function(a){var b=require("fs"),e=require("path"),d=require("async");b.readdir(this.path,function(b,f){if(b)a&&a(b);else{var c=[];d.eachLimit(f,100,function(a,b){m.aio.skinmanager.Widget.loadType(this.path+e.sep+a,a,this,function(a,d){!a&&d&&(c=c.concat(d));b()})}.bind(this),function(b){a&&a(b,c)}.bind(this))}}.bind(this))},toJSON:function(){return{type:this.type,id:this.id,name:this.name,version:this.version,system:this.system,base:this.base,
schema:this.schema,folder:this.path,info:this.info}}};m.aio.skinmanager.SystemSkin=function(){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.SYSTEM)};m.aio.skinmanager.SystemSkin.prototype=new m.aio.skinmanager.Skin;m.aio.skinmanager.SystemSkin.prototype.constructor=m.aio.skinmanager.SystemSkin;m.aio.skinmanager.SystemSkin.prototype.getURL=function(){var a=new m.aio.skinmanager.LocalUrl;a.skinId=this.id;return a};
m.aio.skinmanager.CustomSkin=function(){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.CUSTOM)};m.aio.skinmanager.CustomSkin.prototype=new m.aio.skinmanager.Skin;m.aio.skinmanager.CustomSkin.prototype.constructor=m.aio.skinmanager.CustomSkin;m.aio.skinmanager.CustomSkin.prototype.getURL=function(){var a=new m.aio.skinmanager.LocalUrl;a.skinId=this.id;return a};
m.aio.skinmanager.RemoteSkin=function(a,b){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.REMOTE);this.tenantId=a;this.remoteId=b};m.aio.skinmanager.RemoteSkin.URL_PREFIX="REMOTE";m.aio.skinmanager.RemoteSkin.prototype=new m.aio.skinmanager.Skin;m.aio.skinmanager.RemoteSkin.prototype.constructor=m.aio.skinmanager.RemoteSkin;
m.aio.skinmanager.RemoteSkin.prototype.getURL=function(){var a=new m.aio.skinmanager.InRemoteUrl;a.tenantId=this.tenantId;a.remoteId=this.remoteId;a.skinId=this.id;return a};m.aio.skinmanager.DummySkin=function(a,b){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.DUMMY);this.id=m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER;this.tenantId=a;this.remoteId=b};m.aio.skinmanager.DummySkin.prototype=new m.aio.skinmanager.Skin;
m.aio.skinmanager.DummySkin.prototype.constructor=m.aio.skinmanager.DummySkin;m.aio.skinmanager.DummySkin.prototype.getURL=function(){var a=new m.aio.skinmanager.InRemoteCustomWidgetUrl;a.tenantId=this.tenantId;a.remoteId=this.remoteId;return a};m.aio.skinmanager.LocalCustomWidgetDummySkin=function(){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.DUMMY)};m.aio.skinmanager.LocalCustomWidgetDummySkin.prototype=new m.aio.skinmanager.Skin;
m.aio.skinmanager.LocalCustomWidgetDummySkin.prototype.constructor=m.aio.skinmanager.LocalCustomWidgetDummySkin;m.aio.skinmanager.LocalCustomWidgetDummySkin.prototype.getURL=function(){return new m.aio.skinmanager.LocalCustomWidgetUrl};m.aio.skinmanager.Url=function(a){this.prefix=a};m.aio.skinmanager.Url.PREFIX={LOCAL:"LOCAL",INREMOTE:"INREMOTE"};
m.aio.skinmanager.Url.resolve=function(a){a=a.split("/");switch(a[0]){case m.aio.skinmanager.Url.PREFIX.LOCAL:if(2>a.length)return null;switch(a[1]){case "skins":if(6>a.length)return null;var b=new m.aio.skinmanager.LocalUrl;b.skinId=a[2];b.widgetType=a[3];b.widgetName=a[4];var e=a.slice(5);b.resourcePath=e.join("/");break;case "custom":if(5>a.length)return null;b=new m.aio.skinmanager.LocalCustomWidgetUrl;b.widgetType=a[2];b.widgetName=a[3];e=a.slice(4);b.resourcePath=e.join("/");break;default:return null}break;
case m.aio.skinmanager.Url.PREFIX.INREMOTE:if(6>a.length||"tenant"!=a[1]||"remote"!=a[3])return null;switch(a[5]){case m.aio.skinmanager.SkinManager.SKIN_FLODER:b=new m.aio.skinmanager.InRemoteUrl;if(10>a.length)return null;b.skinId=a[6];b.widgetType=a[7];b.widgetName=a[8];e=a.slice(9);b.resourcePath=e.join("/");break;case m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER:b=new m.aio.skinmanager.InRemoteCustomWidgetUrl;if(9>a.length)return null;b.widgetType=a[6];b.widgetName=a[7];e=a.slice(8);
b.resourcePath=e.join("/");break;default:return null}b.tenantId=a[2];b.remoteId=a[4];break;default:return null}return b};m.aio.skinmanager.LocalUrl=function(){m.aio.skinmanager.Url.call(this,m.aio.skinmanager.Url.PREFIX.LOCAL);this.resourcePath=this.widgetName=this.widgetType=this.skinId=null};m.aio.skinmanager.LocalUrl.prototype=new m.aio.skinmanager.Url;m.aio.skinmanager.LocalUrl.prototype.constructor=m.aio.skinmanager.LocalUrl;
m.aio.skinmanager.LocalUrl.prototype.toString=function(){return this.skinId&&this.widgetType&&this.widgetName&&this.resourcePath?this.prefix+"/"+m.aio.skinmanager.SkinManager.SKIN_FLODER+"/"+this.skinId+"/"+this.widgetType+"/"+this.widgetName+"/"+this.resourcePath:null};m.aio.skinmanager.LocalCustomWidgetUrl=function(){m.aio.skinmanager.Url.call(this,m.aio.skinmanager.Url.PREFIX.LOCAL);this.resourcePath=this.widgetName=this.widgetType=null};m.aio.skinmanager.LocalCustomWidgetUrl.prototype=new m.aio.skinmanager.Url;
m.aio.skinmanager.LocalCustomWidgetUrl.prototype.constructor=m.aio.skinmanager.LocalCustomWidgetUrl;m.aio.skinmanager.LocalCustomWidgetUrl.prototype.toString=function(){return this.widgetType&&this.widgetName&&this.resourcePath?this.prefix+"/"+m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER+"/"+this.widgetType+"/"+this.widgetName+"/"+this.resourcePath:null};
m.aio.skinmanager.InRemoteUrl=function(){m.aio.skinmanager.Url.call(this,m.aio.skinmanager.Url.PREFIX.INREMOTE);this.resourcePath=this.widgetName=this.widgetType=this.skinId=this.remoteId=this.tenantId=null};m.aio.skinmanager.InRemoteUrl.prototype=new m.aio.skinmanager.Url;m.aio.skinmanager.InRemoteUrl.prototype.constructor=m.aio.skinmanager.InRemoteUrl;
m.aio.skinmanager.InRemoteUrl.prototype.toString=function(){return this.tenantId&&this.remoteId&&this.skinId&&this.widgetType&&this.widgetName&&this.resourcePath?this.prefix+"/tenant/"+this.tenantId+"/remote/"+this.remoteId+"/"+m.aio.skinmanager.SkinManager.SKIN_FLODER+"/"+this.skinId+"/"+this.widgetType+"/"+this.widgetName+"/"+this.resourcePath:null};
m.aio.skinmanager.InRemoteCustomWidgetUrl=function(){m.aio.skinmanager.Url.call(this,m.aio.skinmanager.Url.PREFIX.INREMOTE);this.resourcePath=this.widgetName=this.widgetType=this.remoteId=this.tenantId=null};m.aio.skinmanager.InRemoteCustomWidgetUrl.prototype=new m.aio.skinmanager.Url;m.aio.skinmanager.InRemoteCustomWidgetUrl.prototype.constructor=m.aio.skinmanager.InRemoteCustomWidgetUrl;
m.aio.skinmanager.InRemoteCustomWidgetUrl.prototype.toString=function(){return this.tenantId&&this.remoteId&&this.widgetType&&this.widgetName&&this.resourcePath?this.prefix+"/tenant/"+this.tenantId+"/remote/"+this.remoteId+"/"+m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER+"/"+this.widgetType+"/"+this.widgetName+"/"+this.resourcePath:null};
m.aio.skinmanager.SkinManager={SKIN_FLODER:"skins",CUSTOM_IN_REMOTE_WIDGET_FOLDER:"custom",RESOURCE_FOLDER:"resources",sysSkinsPath:null,customSkinsPath:null,customWidgetPath:null,_configmanager:null,skins:[],_logger:null,init:function(a,b,e){var d=function(a){var b=require("async"),c=require("fs");b.parallel([function(a){c.mkdir(this.sysSkinsPath,function(){a()})}.bind(this),function(a){c.mkdir(this.customSkinsPath,function(){a()})}.bind(this),function(a){c.mkdir(this.customWidgetPath,function(){a()})}.bind(this)],
function(){a&&a()})}.bind(this);this._logger=require("x.logger.js").getLogger("m.aio.skinmanager.SkinManager");var c=require("path"),f=a.getAppResourcePath();f?(a=a.getUserResourcePath())?(this.sysSkinsPath=f+c.sep+this.SKIN_FLODER,this.customSkinsPath=a+c.sep+this.SKIN_FLODER,this.customWidgetPath=a+c.sep+this.CUSTOM_IN_REMOTE_WIDGET_FOLDER,this._configmanager=b,require("async").series([function(a){d(a)}.bind(this),function(a){this._loadAllSkins(function(b,c){!b&&c&&(this.skins=c);a()}.bind(this))}.bind(this)],
function(){e&&e()}.bind(this))):e&&e(Error("user resource path invalid")):e&&e(Error("app resource path invalid"))},_loadAllSkins:function(a){var b=[];require("async").parallel([function(a){this._loadSkins(this.sysSkinsPath,{skinType:m.aio.skinmanager.Skin.TYPE.SYSTEM},function(d,c){!d&&c&&(b=b.concat(c));a()})}.bind(this),function(a){this._loadSkins(this.customSkinsPath,{skinType:m.aio.skinmanager.Skin.TYPE.CUSTOM},function(d,c){!d&&c&&(b=b.concat(c));a()})}.bind(this)],function(e){a&&a(e,b)})},
_loadSkins:function(a,b,e){var d=require("fs"),c=require("path"),f=require("async"),g=[];d.readdir(a,function(d,n){!d&&n?f.each(n,function(d,e){m.aio.skinmanager.Skin.load(a+c.sep+d,d,b,function(a,b){!a&&b&&g.push(b);e()})}.bind(this),function(a){e(a,g)}):e(null,g)}.bind(this))},_getPermittedSkins:function(a,b,e){this._configmanager.trace("config/tenants/"+a,function(a,c){if(a)e&&e(a);else{a=c.license;c=[];for(var d=require("m.aio.infomanager"),g=0;g<b.length;g++)b[g]&&b[g].id&&(2==b[g].type?c.push(b[g]):
d.permitSkin(b[g].id,a)&&c.push(b[g]));e&&e(null,c)}}.bind(this))},_isSkinPermitted:function(a,b,e){for(var d=0;d<this.skins.length;d++)if(this.skins[d]&&this.skins[d].id&&this.skins[d]&&this.skins[d].id==b&&2==this.skins[d].type){e&&e(null,!0);return}d=this._configmanager;var c=require("m.aio.infomanager");d.trace("config/tenants/"+a,function(a,d){a?e&&e(a):e&&e(null,c.permitSkin(b,d.license))}.bind(this))},getResourceByURL:function(a,b){var e=function(a,b,c){var e=this._getSkin(a,b.skinId);e?d(e,
b,function(f,g){!f&&g?c&&c(null,g):e.base?(e=this._getSkin(a,e.base))?d(e,b,function(a,b){a?c&&c(a):c&&c(null,b)}):c&&c(Error("invalid resource path")):c&&c(Error("invalid resource path"))}.bind(this)):c&&c(Error("no such skin"))},d=function(a,c,b){var d=require("path"),e=require("fs"),f=d.join(a.path,c.widgetType,c.widgetName,c.resourcePath);e.exists(f,function(a){a?b&&b(null,f):b&&b(Error("no such resource"))})},c=require("path"),f=require("fs"),g=m.aio.skinmanager.Url.resolve(a);if(g instanceof
m.aio.skinmanager.LocalUrl)e.call(this,this.skins,g,b);else if(g instanceof m.aio.skinmanager.LocalCustomWidgetUrl){var k=this.customWidgetPath+c.sep+g.widgetType+c.sep+g.widgetName+c.sep+g.resourcePath;f.exists(k,function(a){a?b&&b(null,k):b&&b(Error("no such resource"))})}else g instanceof m.aio.skinmanager.InRemoteUrl?this._getInRemoteSkins(g.tenantId,g.remoteId,function(a,c){a?b&&b(a):e.call(this,c,g,b)}.bind(this)):g instanceof m.aio.skinmanager.InRemoteCustomWidgetUrl?this._getRemoteFolder(g.tenantId,
g.remoteId,function(a,d){if(a)b&&b(a);else{var e=c.join(d+c.sep+m.aio.skinmanager.SkinManager.RESOURCE_FOLDER+c.sep+m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER,g.widgetType,g.widgetName,g.resourcePath);f.exists(e,function(a){a?b&&b(null,e):b&&b(Error("no such resource"))})}}.bind(this)):b&&b(Error("no such resource"))},deleteResourceByURL:function(a,b){var e=require("path"),d=require("fs");a=m.aio.skinmanager.Url.resolve(a);if(a instanceof m.aio.skinmanager.LocalCustomWidgetUrl){var c=
this.customWidgetPath+e.sep+a.widgetType+e.sep+a.widgetName+e.sep+a.resourcePath;d.exists(c,function(a){a?d.unlink(c,function(a){b&&b(a)}):b&&b()})}else b&&b(Error("can not delete this type of resource"))},getSkinList:function(a,b,e){var d=[];a&&b?this._getInRemoteSkins(a,b,function(c,b){if(!c&&b)if(1==b.length)d.push(b[0]);else for(c=0;c<b.length;c++)if(b[c].base){d.push(b[c]);break}this._getPermittedSkins(a,this.skins,function(a,b){!a&&b&&(d=d.concat(b));e&&e(null,d)})}.bind(this)):this._getPermittedSkins(a,
this.skins,function(a,b){!a&&b&&(d=d.concat(b));e&&e(null,d)})},uploadResource:function(a,b,e,d,c,f){if(a&&b){e||(e=m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_TYPE);d||(d=m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_NAME);c||(c=a);a=require("path");var g=require("async"),k=require("fs-extra"),n=require("fs-extra"),l=this.customWidgetPath+a.sep+e+a.sep+d,h=l+a.sep+c;g.series([function(a){k.ensureDir(l,a)},function(a){k.exists(h,function(b){b?n.move(h,h+"_del",function(b){b?a(b):k.unlink(h+"_del",
function(b){a(b)})}):a()})},function(a){n.move(b,h,function(b){a(b)})}],function(a){a?f&&f(a):(a=new m.aio.skinmanager.LocalCustomWidgetUrl,a.widgetType=e,a.widgetName=d,a.resourcePath=c,f&&f(null,a.toString()))})}else f&&f(Error("invalid paramters"))},_uploadResource:function(a,b,e,d,c){if(a&&b&&e&&d){var f=require("path");this._getRemoteFolder(a,b,function(g,k){if(g)c&&c(g);else{g=require("async");var n=require("fs"),l=k+f.sep+m.aio.skinmanager.SkinManager.RESOURCE_FOLDER;g.series([function(a){n.mkdir(l,
function(){a()})},function(a){l=l+f.sep+m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER;n.mkdir(l,function(){a()})},function(a){l=l+f.sep+m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_TYPE;n.mkdir(l,function(){a()})},function(a){l=l+f.sep+m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_NAME;n.mkdir(l,function(){a()})}],function(g){g?c&&c(g):n.rename(d,l+f.sep+e,function(d){d?c&&c(d):(d=new m.aio.skinmanager.InRemoteCustomWidgetUrl,d.tenantId=a,d.remoteId=b,d.widgetType=m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_TYPE,
d.widgetName=m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_NAME,d.resourcePath=e,c&&c(null,d.toString()))})})}})}else c&&c(Error("invalid paramters"))},getRemoteWidgets:function(a,b,e,d,c){if(a)if(b){"string"==typeof d&&(d="true"==d);var f=[];require("async").parallel([function(c){this._getInRemoteCustomWidgets(a,b,function(a,b){!a&&b&&(f=f.concat(b));c()})}.bind(this),function(a){this._getLocalCustomWidgets(function(b,c){!b&&c&&(f=f.concat(c));a()}.bind(this))}.bind(this),function(c){e?d?this._getInRemoteSkinWidgets(a,
b,e,function(a,b){!a&&b&&(f=f.concat(b));c()}):this._isSkinPermitted(a,e,function(a,b){a||!b?c():this._getLocalSkinWidgets(e,function(a,b){!a&&b&&(f=f.concat(b));c()})}.bind(this)):c()}.bind(this)],function(a){c&&c(a,f)})}else c&&c(Error("remote id invalid"));else c&&c(Error("tenant id invalid"))},_getLocalSkinWidgets:function(a,b){a?this._getSkinWidgets(this.skins,a,function(a,d){b&&b(a,d)}):b&&b(Error("skin id invalid"))},_getLocalCustomWidgets:function(a){var b=new m.aio.skinmanager.LocalCustomWidgetDummySkin;
b.path=this.customWidgetPath;b.loadWidgets(function(b,d){a&&a(b,d)})},_getInRemoteSkinWidgets:function(a,b,e,d){this._getInRemoteSkins(a,b,function(a,b){a?d&&d(a):this._getSkinWidgets(b,e,function(a,b){d&&d(a,b)})}.bind(this))},_getInRemoteSkins:function(a,b,e){var d=require("path");this._getRemoteFolder(a,b,function(c,f){c?e&&e(c):this._loadSkins(f+d.sep+this.RESOURCE_FOLDER+d.sep+this.SKIN_FLODER,{skinType:m.aio.skinmanager.Skin.TYPE.REMOTE,tenantId:a,remoteId:b},function(a,b){e&&e(a,b)}.bind(this))}.bind(this))},
_getInRemoteCustomWidgets:function(a,b,e){var d=require("path");this._getRemoteFolder(a,b,function(c,f){c?e&&e(c):(c=f+d.sep+this.RESOURCE_FOLDER+d.sep+this.CUSTOM_IN_REMOTE_WIDGET_FOLDER,f=new m.aio.skinmanager.DummySkin(a,b),f.path=c,f.loadWidgets(function(a,b){e&&e(a,b)}))}.bind(this))},_getRemoteFolder:function(a,b,e){require("fs");require("path");this._configmanager.trace("config/tenants/"+a+"/remotes/"+b,function(a,b){a?e&&e(a):(a=b.getFolderPath())?e&&e(null,a):e&&e(Error("remote folder path invalid"))}.bind(this))},
_getSkin:function(a,b){for(var e=0;e<a.length;e++)if(a[e].id==b)return a[e];return null},_getSkinWidgets:function(a,b,e){var d=this._getSkin(a,b);if(d){b=d;if(d.base)for(var c=0;c<a.length;c++)if(a[c].id==d.base){b=a[c];break}b.loadWidgets(function(a,b){a?e&&e(a):d.base?d.loadWidgets(function(a,c){if(a)e&&e(a);else{a=[];for(var d=0;d<c.length;d++){for(var f=!1,g=0;g<b.length;g++)if(c[d].hasSameRef(b[g])){f=!0;b[g].merge(c[d]);break}f||a.push(c[d])}b=b.concat(a);e&&e(null,b)}}):e&&e(null,b)})}else e&&
e(Error("no skin has id "+b))},_getInRemoteResourceFolder:function(a){return require("path").join(a,this.RESOURCE_FOLDER)},_getInRemoteSkinsFolder:function(a){return require("path").join(this._getInRemoteResourceFolder(a),this.SKIN_FLODER)},_getInRemoteCustomWidgetFolder:function(a){return require("path").join(this._getInRemoteResourceFolder(a),this.CUSTOM_IN_REMOTE_WIDGET_FOLDER)},_getLocalSkinResourcePath:function(a,b){var e=require("path"),d=require("fs");a=this._getSkin(this.skins,a);if(!a||!a.path)return null;
e=e.join(a.path,b);return d.existsSync(e)?e:a.base?this._getLocalSkinResourcePath(a.base,b):null},_getLocalSkinWidgetPath:function(a,b,e){var d=require("path"),c=require("fs");a=this._getSkin(this.skins,a);if(!a||!a.path)return null;d=d.join(a.path,b,e);return c.existsSync(d)?d:a.base?this._getLocalSkinResourcePath(a.base,b,e):null},saveRemote2:function(a,b,e){var d=require("fs-extra"),c=require("path"),f=require("async"),g=a.getFolderPath();if(g){var k=a.index,n=a.parent.parent.index,l=b&&b.skin&&
b.skin.id?b.skin.id:null,h=!(!a||!a.skin||!a.skin.id),v=b&&b.skin&&b.skin.inRemote,y=(new Date).getTime(),u=this._getInRemoteSkinsFolder(g),w=this._getInRemoteCustomWidgetFolder(g),x=g+c.sep+this.RESOURCE_FOLDER,A=g+c.sep+this.RESOURCE_FOLDER+"_"+y,B=g+c.sep+this.RESOURCE_FOLDER+"_"+y+c.sep+this.SKIN_FLODER,z=u+c.sep+b.skin.id,D=function(a){a=a.split("/");if("custom"!=a[0])return!1;if(2<a.length&&"custom"==a[0]){if(a[1].match(/^.+__\d+$/))return!1;a=a[a.length-1].split(".");if(3<=a.length&&a[a.length-
2].match(/^\d+$/))return!1}return!0},E=function(a,b){a=a.toString();b=b.split(".");2==b.length?b.splice(1,0,a):3<=b.length&&(b[b.length-2].match(/^\d+$/)?parseInt(b[b.length-2])<parseInt(a)&&(b[b.length-2]=a):b.splice([b.length-2],0,a));return b.join(".")},t=function(a,b,c){var d=require("fs-extra"),e=require("path"),f=require("crypto"),q=function(a){a=d.readFileSync(a);var b=f.createHash("md5");b.update(a);return b.digest("hex")},g=0;b=E(g,b);for(var r=a+e.sep+b;d.existsSync(r);){if(d.statSync(r).size==
d.statSync(c).size&&q(r)==q(r))return b;g++;b=E(g,b);r=a+e.sep+b}d.copySync(c,r,{clobber:!0});return b},C=function(a,b){var e,f=b.length;a:{var g=a.split("/");if(2<g.length&&"custom"==g[0]){if(g[1].match(/^.+__\d+$/)){var F=!0;break a}g=g[g.length-1].split(".");if(3<=g.length&&g[g.length-2].match(/^\d+$/)){F=!0;break a}}F=!1}for(var q=D(a);f--;){var p=b[f].getLocation();switch(p){case "local_custom":if(q)for(g=b[f].resources.length;g--;)if(b[f].resources[g].getRef()==a)return p=x+c.sep+"custom"+c.sep+
b[f].type+c.sep+b[f].name,(e=t(p,b[f].resources[g].name,b[f].resources[g].file))?"custom/"+b[f].type+"/"+b[f].name+"/"+e:null;break;case "in_remote_custom":if(q)for(g=b[f].resources.length;g--;){if(b[f].resources[g].getRef()==a){var h=b[f];e=b[f].resources[g];break}}else if(F)for(g=b[f].resources.length;g--;)if(b[f].resources[g].getRef()==a)return a=b[f].skin.path,"\\"==c.sep&&(a=a.replace(/\\/g,"/")),a=a.split("/"),2<a.length&&(a[a.length-2]=a[a.length-2]+"_"+y),a=a.join(c.sep),a=a+c.sep+b[f].type+
c.sep+b[f].name+c.sep+b[f].resources[g].name,h=b[f].type,e=h.indexOf("__"),0<e&&(h=h.substr(0,e)),p=w+c.sep+h+c.sep+b[f].name,(e=t(p,b[f].resources[g].name,a))?"custom/"+h+"/"+b[f].name+"/"+e:null;break;default:if(0==a.indexOf(b[f].type+"/"+b[f].name))for(g=b[f].resources.length;g--;)if(b[f].resources[g].getRef()==a){"in_remote_skin"==p?(a=B,a=a+c.sep+b[f].type+c.sep+b[f].name+c.sep+b[f].resources[g].name,p=u+c.sep+l+c.sep+b[f].type+c.sep+b[f].name+c.sep+b[f].resources[g].name,d.copySync(a,p,{clobber:!0})):
b[f].resources[g].copySync(u,l);return}}}if(h&&e)return a=h.skin.path,"\\"==c.sep&&(a=a.replace(/\\/g,"/")),a=a.split("/"),2<a.length&&(a[a.length-2]=a[a.length-2]+"_"+y),a=a.join(c.sep),a=a+c.sep+h.type+c.sep+h.name+c.sep+e.name,p=w+c.sep+h.type+c.sep+h.name,(e=t(p,e.name,a))?"custom/"+h.type+"/"+h.name+"/"+e:null};f.waterfall([function(a){v?a():d.remove(u,function(b){a(b)})},function(a){this.getRemoteWidgets(n,k,h?l:null,v,function(b,c){b?a(b):d.exists(x,function(b){b?d.move(x,A,function(b){a(b,
c)}):a(null,c)})}.bind(this))}.bind(this),function(b,d){a.processResourceList({resourceBuf:[],widgetBuf:[],processResourceSync:function(a){for(var c=0;c<this.resourceBuf.length;c++)if(this.resourceBuf[c]&&this.resourceBuf[c].ref==a)return this.resourceBuf[c].newRef;try{var d=C(a,b);this.resourceBuf.push({ref:a,newRef:d});return d}catch(F){return null}},processWidgetSync:function(a){for(var d=0;d<this.widgetBuf.length;d++){var f=this.widgetBuf[d];if(f&&f.widgetType==a.widgetType&&f.widgetName==a.widgetName)return}try{for(d=
0;d<b.length;d++)if(a.widgetType==b[d].type&&a.widgetName==b[d].name){var g=b[d];break}if(g)switch(g.getLocation()){case "in_remote_skin":case "in_remote_custom":var q=g.skin.path;"\\"==c.sep&&(q=q.replace(/\\/g,"/"));var p=q.split("/");3<p.length&&(p[p.length-3]=p[p.length-3]+"_"+y);q=p.join(c.sep);g._copySync(q,u,l);break;default:g.copySync(u,l,e)}this.widgetBuf.push(a)}catch(K){}}},function(a){d(a)})},function(a){d.remove(A,a)},function(a){d.ensureDir(z,function(e){e?a(e):d.writeFile(z+c.sep+m.aio.skinmanager.Skin.SETTINGS_FILE,
JSON.stringify({name:"in-remote"}),function(c){c||(b.skin.inRemote=!0);a(c)})})}],function(a){e&&e(a,b)})}else e&&e(Error("remote folder path invalid"))},saveRemote:function(a,b,e){var d=require("fs-extra"),c=require("path"),f=require("async"),g=require("m.aio.skinmanager.js"),k=a.getFolderPath();if(k){var n=b&&b.skin&&b.skin.id?b.skin.id:null,l=b&&b.skin&&b.skin.inRemote,h=this._getInRemoteResourceFolder(k),v=this._getInRemoteSkinsFolder(k),y=this.customWidgetPath.replace(this.CUSTOM_IN_REMOTE_WIDGET_FOLDER,
""),u=v+c.sep+b.skin.id,w=function(a){return"custom"==a.split("/")[0]},x=function(a){if(!w(a))return!1;a=a.split("/");if(2<a.length){if(a[1].match(/^.+__\d+$/))return!0;a=a[a.length-1].split(".");if(3<=a.length&&a[a.length-2].match(/^\d+$/))return!0}return!1},A=function(a){return w(a)?!x(a):!1},B=function(a){return w(a)?!1:!(w(a)?0:l)},z=function(a,b){if(x(a)||A(a))return c.join(h,a);B(a);return c.join(v,b||n,a)},D=function(a,b){b=b.split("/");var c=b[b.length-1].split(".");c.splice(c.length-1,0,
""+a);b[b.length-1]=c.join(".");return b.join("/")},E=function(a,b){var c=require("fs-extra"),d=require("crypto"),e=function(a){a=c.readFileSync(a);var b=d.createHash("md5");b.update(a);return b.digest("hex")};if(c.existsSync(b))return c.statSync(b).size==c.statSync(a).size&&e(b)==e(a)?b:null;c.copySync(a,b,{clobber:!0});return b},t=[],C=[],r={},G={},H=function(a,b,e){var f=b+":"+(e||a);if(r[f])return r[f];var q=x(a)?c.join(h,a):A(a)?c.join(y,a):B(a)?g._getLocalSkinResourcePath(b||n,a):c.join(v,a);
b=z(e||a,b);if(x(a)||(w(a)?0:l))return r[f]=e||a,t.push(b),a;if(A(a)){var p=D(0,e||a);b=z(p);for(var u=0;!E(q,b);)p=D(++u,e||a),b=z(p);r[f]=p;t.push(b);return p}d.copySync(q,b,{clobber:!0});r[f]=e||a;t.push(b)},I=function(a){for(var b=d.readdirSync(a),e=0,f,g=0;g<b.length;g++)f=c.join(a,b[g]),(f=d.statSync(f).isDirectory()?I(f):L(f))&&e++;return e==b.length?(d.removeSync(a),!0):!1},L=function(a){if(-1!=t.indexOf(a))return!1;var b=require("unorm").nfc(a);if(-1!=t.indexOf(b))return!1;for(b=0;b<C.length;b++){var c=
C[b];if(a.substr(0,c.length)==c)return!1}d.removeSync(a);return!0};f.waterfall([function(a){l?a():d.remove(v,function(b){a(b)})},function(b){a.processResourceList({resourceBuf:[],widgetBuf:[],processResourceSync:function(a,b){try{var c=H(a,b);this.resourceBuf.push({ref:a,newRef:c});return c}catch(M){return null}},processWidgetSync:function(a){try{var b=a.widgetType+"/"+a.widgetName;a.widgetSkin&&(b=a.widgetSkin+"/"+b);if(!G[b]){var e=l?c.join(v,a.widgetSkin||n,a.widgetType,a.widgetName):g._getLocalSkinWidgetPath(a.widgetSkin||
n,a.widgetType,a.widgetName);var f=c.join(v,a.widgetSkin||n,a.widgetType,a.widgetName);l||d.copySync(e,f,{clobber:!0});G[b]=!0;C.push(f)}this.widgetBuf.push(a)}catch(J){}},processDefaultImageSync:function(a){try{var b=a._default,c=b.split("/");c.splice(c.length-1,1,"default.png");var d=c.join("/");d=H(b,a.img_skin,d);this.resourceBuf.push({ref:b,newRef:d});return d}catch(J){return console.error(J),null}}},function(a){b(a)})},function(a){try{for(var b=require("unorm"),c=0;c<t.length;c++)t[c]=b.nfc(t[c]);
d.existsSync(h)&&I(h);a(null)}catch(K){a(K)}},function(a){d.ensureDir(u,function(e){e?a(e):d.writeFile(u+c.sep+m.aio.skinmanager.Skin.SETTINGS_FILE,JSON.stringify({name:"in-remote"}),function(c){c||(b.skin.inRemote=!0);a(c)})})}],function(a){a&&(console.error(a),this._logger.log("error",a));e&&e(a,b)}.bind(this))}else e&&e(Error("remote folder path invalid"))},downloadSystemSkin:function(a,b,e,d){var c="webservice.mediola.com",f=443,g="";switch(process.env.CLOUD){case "local":c=process.env.CLOUD_HOST?
process.env.CLOUD_HOST:"localhost";f=8080;g="/webservice";break;case "dev":c=process.env.CLOUD_HOST?process.env.CLOUD_HOST:"mediola-dev.elasticbeanstalk.com";f=80;break;default:c=process.env.CLOUD_HOST?process.env.CLOUD_HOST:"webservice.mediola.com",f=443}var k=function(a,b,d){var e=d;d=443===f?require("https"):require("http");a={host:c,port:f,path:g+"/creatorneo/skin/getSkinUrl?license="+a+"&skinName="+encodeURIComponent(b),method:"GET",timeout:2E4,headers:{"User-Agent":"mediola",Connection:"close"}};
var h="";a=d.request(a,function(a){a.setEncoding("utf8");a.on("data",function(a){h+=a});a.on("end",function(){if(e)if(200==a.statusCode){try{var b=JSON.parse(h)}catch(z){e(Error("request response invalid:"+h))}b&&b.url?e(null,b.url,b.version):e(Error("request response invalid:"+h))}else e(Error("request failed:"+h));e=null})});if(a.on&&"function"==typeof a.on)a.on("error",function(a){e&&e(a);e=null});a.setTimeout&&a.setTimeout(2E4);a.end()},n=this,l=this._logger,h=this._configmanager;a="config/tenants/"+
a;l.log("debug","start to download system skin "+b);e&&e(0,"start");h.trace(a,function(a,c){if(a)d&&d(a);else{var f=c.license;e&&e(1,"get skin info from server");l.log("debug","try to get skin "+b+" info from server");k(f.licenseTxt,b,function(a,c,g){a?d&&d(a):n._checkSystemSkinExists(b,g,function(a,h){a?d&&d(a):h?(l.log("debug","find system skin "+b),n._updateInfomanager(f,b,function(){d&&d()})):n._downloadAndSaveSkin(f,c,b,g,e,function(a){a?d&&d(a):n._updateInfomanager(f,b,function(){d&&d()})})})})}})},
_checkSystemSkinExists:function(a,b,e){for(var d=!1,c=0;c<this.skins.length;c++)if(this.skins[c]&&1==this.skins[c].type&&this.skins[c].id==a){var f=this.skins[c].version?parseInt(this.skins[c].version):0,g=b?parseInt(b):0;if(f>=g){d=!0;break}}e&&e(null,d)},_downloadAndSaveSkin:function(a,b,e,d,c,f){var g=this,k=this._logger,n=function(a,b,c){var d=require("adm-zip"),e=require("m.aio.filemanager.js").getTmpDir(),f=require("path"),g=require("fs-extra");a=new d(a);b=f.join(e,b);try{g.existsSync(b)&&
g.removeSync(b),g.ensureDirSync(b),a.extractAllTo(b,!0),c&&c(null,b)}catch(B){c&&c(B)}},l=function(a,b,c,d){var e=require("path"),f=require("fs-extra"),g=e.join(a,c);f.existsSync(g)&&f.removeSync(g);f.move(b,g,{limit:100},function(a){f.chmod(g,511,function(a){d&&d(a,g)})})};c&&c(1,"get skin info from server");k.log("debug","start download skin "+e+" zip from server");c&&c(2,"download skin");(function(a,b,c){var d=c;a=require("url").parse(a);c=require("http");-1!=a.protocol.indexOf("https")&&(c=require("https"));
a.method="GET";a.timeout=2E4;var e=require("m.aio.filemanager.js").getTmpDir(),f=require("path"),g=require("fs"),h=0,l=f.join(e,(new Date).getTime()+".zip"),n=g.createWriteStream(l);n.on("error",function(a){d&&d(a);d=null});a=c.request(a,function(a){var c=a.headers["content-length"];k.log("trace","http skin zip length:"+c);var e=!1,f=!1;a.pipe(n);n.on("finish",function(){n.close(function(){f=!0;e&&f&&d&&(200!=a.statusCode?d(Error("http response code:"+a.statusCode)):d(null,l),d=null)})});a.on("data",
function(a){h+=a.length;k.log("trace","receive chunk:"+a.length+" total:"+h+"/"+c);b&&b(parseFloat("2."+h),"download chunk "+h,{count:h,total:parseInt(c)})});a.on("end",function(){(e=!0,f)&&d&&(200!=a.statusCode?d(Error("http response code:"+a.statusCode)):d(null,l),d=null)})});if(a.on&&"function"==typeof a.on)a.on("error",function(a){d&&d(a);d=null});a.setTimeout&&a.setTimeout(2E4);a.end()})(b,c,function(a,b){a?f&&f(a):(c&&c(3,"unpack skin"),k.log("debug","start unpack skin from file:"+b),n(b,e,
function(a,b){a?f&&f(a):(k.log("debug","move skin from:"+b+" to:"+g.sysSkinsPath),l(g.sysSkinsPath,b,e,function(a,b){a?f&&f(a):(c&&c(4,"load skin"),k.log("debug","load skin "+e+" from:"+b),m.aio.skinmanager.Skin.load(b,e,{skinType:1},function(a,b){if(a)f&&f(a);else{a=-1;for(var c=0;c<g.skins.length;c++)if(g.skins[c]&&g.skins[c].type==b.type&&g.skins[c].id==b.id){a=c;break}-1!=a&&g.skins.splice(a,1);g.skins.push(b);b.updateVersion(d,function(a){f&&f(a)})}}))}))}))})},_updateInfomanager:function(a,
b,e){require("m.aio.infomanager").updateDownloadSkin(a,b,function(){e&&e()})}};"undefined"!=typeof module&&null!=module&&(module.exports=m.aio.skinmanager.SkinManager);
