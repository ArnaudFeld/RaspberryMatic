var m=m||{};m.aio=m.aio||{};m.aio.skinmanager=m.aio.skinmanager||{};m.aio.skinmanager.Resource=function(){this.mtime=this.size=this.sha1=this.file=this.name=this.widget=null};m.aio.skinmanager.Resource.load=function(a,b,e,d){var c=require("unorm"),f=new m.aio.skinmanager.Resource;f.widget=e;f.name=c.nfc(b);f.file=a;d&&d(null,f)};m.aio.skinmanager.Resource.loadSync=function(a,b,e){var d=require("unorm"),c=new m.aio.skinmanager.Resource;c.widget=e;c.name=d.nfc(b);c.file=a;return c};
m.aio.skinmanager.Resource.prototype={copy:function(a,b,e){this._copy(this.file,a,b,e)},copySync:function(a,b){this._copySync(this.file,a,b)},_copy:function(a,b,e,d){var c=require("fs-extra"),f=require("path");b?e?this.widget&&this.widget.type&&this.widget.name?this.file?(b=b+f.sep+e+f.sep+this.widget.type+f.sep+this.widget.name+f.sep+this.name,b==this.file?d&&d():c.copy(a,b,{clobber:!0},function(a){d&&d(a)})):d&&d(Error("resource file invalid")):d&&d(Error("resource widget invalid")):d&&d(Error("skinId invalid")):
d&&d(Error("skinFolder invalid"))},_copySync:function(a,b,e){var d=require("fs-extra"),c=require("path");if(!b)throw Error("skinFolder invalid");if(!e)throw Error("skinId invalid");if(!this.widget||!this.widget.type||!this.widget.name)throw Error("resource widget invalid");if(!this.file)throw Error("resource file invalid");b=b+c.sep+e+c.sep+this.widget.type+c.sep+this.widget.name+c.sep+this.name;b!=this.file&&d.copySync(a,b,{clobber:!0})},del:function(a){this.file?require("fs").unlink(this.file,function(b){a&&
a(b)}.bind(this)):a&&a(Error("resource file invalid"))},getRef:function(){if(!this.widget||!this.widget.skin)return null;var a="";if(this.widget.skin instanceof m.aio.skinmanager.DummySkin||this.widget.skin instanceof m.aio.skinmanager.LocalCustomWidgetDummySkin)a=m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER+"/";return a+this.widget.type+"/"+this.widget.name+"/"+this.name},getURL:function(){if(!this.widget||!this.widget.skin)return null;var a=this.widget.skin.getURL();a.widgetType=
this.widget.type;a.widgetName=this.widget.name;a.resourcePath=this.name;return a.toString()},toJSON:function(){return{name:this.name,ref:this.getRef(),url:this.getURL()}}};m.aio.skinmanager.Widget=function(){this.name=this.type=this.skin=null;this.resources=[]};m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_TYPE="misc";m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_NAME="default";
m.aio.skinmanager.Widget.loadType=function(a,b,e,d){var c=require("fs"),f=require("async"),g=require("path");c.readdir(a,function(c,n){if(c)d&&d(c);else{var k=[];f.eachLimit(n,100,function(c,d){m.aio.skinmanager.Widget.load(a+g.sep+c,b,c,e,function(a,b){!a&&b&&k.push(b);d()})},function(a){d&&d(a,k)})}})};
m.aio.skinmanager.Widget.load=function(a,b,e,d,c){var f=require("fs"),g=require("path");require("async");f.readdir(a,function(f,n){if(f)c&&c(f);else{var k=require("unorm"),h=new m.aio.skinmanager.Widget;h.skin=d;h.type=k.nfc(b);h.name=k.nfc(e);var l=[];n.forEach(function(b){".DS_Store"!==b&&(b=new m.aio.skinmanager.Resource.loadSync(a+g.sep+b,b,h))&&l.push(b)});l&&0!=l.length?(h.resources=l,c&&c(null,h)):c&&c(Error("widget has no resources"))}})};
m.aio.skinmanager.Widget.prototype={getLocation:function(){var a=null;this.skin&&(a=this.skin instanceof m.aio.skinmanager.DummySkin?"in_remote_custom":this.skin instanceof m.aio.skinmanager.LocalCustomWidgetDummySkin?"local_custom":this.skin instanceof m.aio.skinmanager.RemoteSkin?"in_remote_skin":this.skin instanceof m.aio.skinmanager.CustomSkin?"local_custom_skin":"local_skin");return a},copy:function(a,b,e){this._copy(this.skin.path,a,b,e)},copySync:function(a,b){this._copySync(this.skin.path,
a,b)},_copy:function(a,b,e,d){var c=require("fs-extra"),f=require("path");a?b?e?this.type&&this.name?c.copy(a+f.sep+this.type+f.sep+this.name,b+f.sep+e+f.sep+this.type+f.sep+this.name,{clobber:!0},function(a){d&&d(a)}):d&&d(Error("widget type or name invalid")):d&&d(Error("skinId invalid")):d&&d(Error("dstSkinFolder invalid")):d&&d(Error("srcSkinFolder invalid"))},_copySync:function(a,b,e){var d=require("fs-extra"),c=require("path");if(!a)throw Error("srcSkinFolder invalid");if(!b)throw Error("dstSkinFolder invalid");
if(!e)throw Error("skinId invalid");if(!this.type||!this.name)throw Error("widget type or name invalid");d.copySync(a+c.sep+this.type+c.sep+this.name,b+c.sep+e+c.sep+this.type+c.sep+this.name,{clobber:!0})},del:function(a){if(this.skin)if(this.type)if(this.name){var b=this.skin.path;if(b){var e=require("path");require("fs-extra").remove(b+e.sep+this.type+e.sep+this.name,function(b){a&&a(b)})}else a&&a(Error("skin path is null"))}else a&&a(Error("widgetName is null"));else a&&a(Error("widgetType is null"));
else a&&a(Error("skin is null"))},hasSameRef:function(a){return this.type==a.type&&this.name==a.name},merge:function(a){if(a.resources&&0!=a.resources.length)if(this.resources&&0!=this.resources.length){for(var b=[],e=0;e<a.resources.length;e++){for(var d=!1,c=0;c<this.resources.length;c++)if(this.resources[c].name==a.resources[e].name){d=!0;this.resources[c]=a.resources[e];break}d||b.push(a.resources[e])}this.resources=this.resources.concat(b)}else this.resources=a.resources},toJSON:function(){var a=
{type:this.type,name:this.name,resources:[]};a._loc=this.getLocation();this.resources.forEach(function(b){a.resources.push(b.toJSON())});return a}};m.aio.skinmanager.Skin=function(a){this.type=a;this.path=this.info=this.schema=this.base=this.system=this.version=this.name=this.id=null};m.aio.skinmanager.Skin.SETTINGS_FILE="settings";m.aio.skinmanager.Skin.TYPE={SYSTEM:1,CUSTOM:2,REMOTE:3,DUMMY:4};
m.aio.skinmanager.Skin.load=function(a,b,e,d){if(a){var c=require("fs"),f=require("path"),g=a+f.sep+m.aio.skinmanager.Skin.SETTINGS_FILE;c.readFile(g,{encoding:"utf8"},function(c,f){if(c)d&&d(c);else if(f&&0!=f.length){var k=null;try{k=JSON.parse(f)}catch(h){d&&d(Error("settings file of "+g+" is not in json"));return}if(k.name){var l=null;switch(e.skinType){case m.aio.skinmanager.Skin.TYPE.SYSTEM:l=new m.aio.skinmanager.SystemSkin;break;case m.aio.skinmanager.Skin.TYPE.CUSTOM:l=new m.aio.skinmanager.CustomSkin;
break;case m.aio.skinmanager.Skin.TYPE.REMOTE:if(!e.tenantId||!e.remoteId){d&&d(Error("skinType info invalid"));return}l=new m.aio.skinmanager.RemoteSkin(e.tenantId,e.remoteId);break;case m.aio.skinmanager.Skin.TYPE.DUMMY:if(!e.tenantId||!e.remoteId){d&&d(Error("skinType info invalid"));return}l=new m.aio.skinmanager.DummySkin(e.tenantId,e.remoteId);break;default:d&&d(Error("skin type invalid"));return}l.id=b;l.name=k.name;l.version=k.version?k.version:0;l.system=k.system?k.system:1;l.base=k.base;
l.schema=k.schema?k.schema:0;l.info=k.info||null;l.path=a;d&&d(null,l)}else d&&d(Error("skin has no name"))}else d&&d(Error("settings file of "+g+" is empty"))})}else d&&d(Error("invalid skin path"))};
m.aio.skinmanager.Skin.prototype={updateVersion:function(a,b){var e=this,d=require("fs"),c=require("path"),f=this.path+c.sep+m.aio.skinmanager.Skin.SETTINGS_FILE;d.readFile(f,{encoding:"utf8"},function(c,q){if(c)b&&b(c);else if(q&&0!=q.length){var n=null;try{n=JSON.parse(q)}catch(k){b&&b(Error("settings file of "+f+" is not in json"));return}parseInt(n.version)==parseInt(a)?b&&b(null):(n.version=parseInt(a),d.writeFile(f,JSON.stringify(n),{encoding:"utf8"},function(c){c||(e.version=parseInt(a));b&&
b(c)}))}else b&&b(Error("settings file of "+f+" is empty"))})},loadWidgets:function(a){var b=require("fs"),e=require("path"),d=require("async");b.readdir(this.path,function(b,f){if(b)a&&a(b);else{var g=[];d.eachLimit(f,100,function(a,b){m.aio.skinmanager.Widget.loadType(this.path+e.sep+a,a,this,function(a,c){!a&&c&&(g=g.concat(c));b()})}.bind(this),function(b){a&&a(b,g)}.bind(this))}}.bind(this))},toJSON:function(){return{type:this.type,id:this.id,name:this.name,version:this.version,system:this.system,
base:this.base,schema:this.schema,folder:this.path,info:this.info}}};m.aio.skinmanager.SystemSkin=function(){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.SYSTEM)};m.aio.skinmanager.SystemSkin.prototype=new m.aio.skinmanager.Skin;m.aio.skinmanager.SystemSkin.prototype.constructor=m.aio.skinmanager.SystemSkin;m.aio.skinmanager.SystemSkin.prototype.getURL=function(){var a=new m.aio.skinmanager.LocalUrl;a.skinId=this.id;return a};
m.aio.skinmanager.CustomSkin=function(){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.CUSTOM)};m.aio.skinmanager.CustomSkin.prototype=new m.aio.skinmanager.Skin;m.aio.skinmanager.CustomSkin.prototype.constructor=m.aio.skinmanager.CustomSkin;m.aio.skinmanager.CustomSkin.prototype.getURL=function(){var a=new m.aio.skinmanager.LocalUrl;a.skinId=this.id;return a};
m.aio.skinmanager.RemoteSkin=function(a,b){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.REMOTE);this.tenantId=a;this.remoteId=b};m.aio.skinmanager.RemoteSkin.URL_PREFIX="REMOTE";m.aio.skinmanager.RemoteSkin.prototype=new m.aio.skinmanager.Skin;m.aio.skinmanager.RemoteSkin.prototype.constructor=m.aio.skinmanager.RemoteSkin;
m.aio.skinmanager.RemoteSkin.prototype.getURL=function(){var a=new m.aio.skinmanager.InRemoteUrl;a.tenantId=this.tenantId;a.remoteId=this.remoteId;a.skinId=this.id;return a};m.aio.skinmanager.DummySkin=function(a,b){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.DUMMY);this.id=m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER;this.tenantId=a;this.remoteId=b};m.aio.skinmanager.DummySkin.prototype=new m.aio.skinmanager.Skin;
m.aio.skinmanager.DummySkin.prototype.constructor=m.aio.skinmanager.DummySkin;m.aio.skinmanager.DummySkin.prototype.getURL=function(){var a=new m.aio.skinmanager.InRemoteCustomWidgetUrl;a.tenantId=this.tenantId;a.remoteId=this.remoteId;return a};m.aio.skinmanager.LocalCustomWidgetDummySkin=function(){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.DUMMY)};m.aio.skinmanager.LocalCustomWidgetDummySkin.prototype=new m.aio.skinmanager.Skin;
m.aio.skinmanager.LocalCustomWidgetDummySkin.prototype.constructor=m.aio.skinmanager.LocalCustomWidgetDummySkin;m.aio.skinmanager.LocalCustomWidgetDummySkin.prototype.getURL=function(){return new m.aio.skinmanager.LocalCustomWidgetUrl};m.aio.skinmanager.Url=function(a){this.prefix=a};m.aio.skinmanager.Url.PREFIX={LOCAL:"LOCAL",INREMOTE:"INREMOTE"};
m.aio.skinmanager.Url.resolve=function(a){a=a.split("/");var b=null,e=null;switch(a[0]){case m.aio.skinmanager.Url.PREFIX.LOCAL:if(2>a.length)return null;switch(a[1]){case "skins":if(6>a.length)return null;b=new m.aio.skinmanager.LocalUrl;b.skinId=a[2];b.widgetType=a[3];b.widgetName=a[4];e=a.slice(5);b.resourcePath=e.join("/");break;case "custom":if(5>a.length)return null;b=new m.aio.skinmanager.LocalCustomWidgetUrl;b.widgetType=a[2];b.widgetName=a[3];e=a.slice(4);b.resourcePath=e.join("/");break;
default:return null}break;case m.aio.skinmanager.Url.PREFIX.INREMOTE:if(6>a.length||"tenant"!=a[1]||"remote"!=a[3])return null;switch(a[5]){case m.aio.skinmanager.SkinManager.SKIN_FLODER:b=new m.aio.skinmanager.InRemoteUrl;if(10>a.length)return null;b.skinId=a[6];b.widgetType=a[7];b.widgetName=a[8];e=a.slice(9);b.resourcePath=e.join("/");break;case m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER:b=new m.aio.skinmanager.InRemoteCustomWidgetUrl;if(9>a.length)return null;b.widgetType=a[6];
b.widgetName=a[7];e=a.slice(8);b.resourcePath=e.join("/");break;default:return null}b.tenantId=a[2];b.remoteId=a[4];break;default:return null}return b};m.aio.skinmanager.LocalUrl=function(){m.aio.skinmanager.Url.call(this,m.aio.skinmanager.Url.PREFIX.LOCAL);this.resourcePath=this.widgetName=this.widgetType=this.skinId=null};m.aio.skinmanager.LocalUrl.prototype=new m.aio.skinmanager.Url;m.aio.skinmanager.LocalUrl.prototype.constructor=m.aio.skinmanager.LocalUrl;
m.aio.skinmanager.LocalUrl.prototype.toString=function(){return this.skinId&&this.widgetType&&this.widgetName&&this.resourcePath?this.prefix+"/"+m.aio.skinmanager.SkinManager.SKIN_FLODER+"/"+this.skinId+"/"+this.widgetType+"/"+this.widgetName+"/"+this.resourcePath:null};m.aio.skinmanager.LocalCustomWidgetUrl=function(){m.aio.skinmanager.Url.call(this,m.aio.skinmanager.Url.PREFIX.LOCAL);this.resourcePath=this.widgetName=this.widgetType=null};m.aio.skinmanager.LocalCustomWidgetUrl.prototype=new m.aio.skinmanager.Url;
m.aio.skinmanager.LocalCustomWidgetUrl.prototype.constructor=m.aio.skinmanager.LocalCustomWidgetUrl;m.aio.skinmanager.LocalCustomWidgetUrl.prototype.toString=function(){return this.widgetType&&this.widgetName&&this.resourcePath?this.prefix+"/"+m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER+"/"+this.widgetType+"/"+this.widgetName+"/"+this.resourcePath:null};
m.aio.skinmanager.InRemoteUrl=function(){m.aio.skinmanager.Url.call(this,m.aio.skinmanager.Url.PREFIX.INREMOTE);this.resourcePath=this.widgetName=this.widgetType=this.skinId=this.remoteId=this.tenantId=null};m.aio.skinmanager.InRemoteUrl.prototype=new m.aio.skinmanager.Url;m.aio.skinmanager.InRemoteUrl.prototype.constructor=m.aio.skinmanager.InRemoteUrl;
m.aio.skinmanager.InRemoteUrl.prototype.toString=function(){return this.tenantId&&this.remoteId&&this.skinId&&this.widgetType&&this.widgetName&&this.resourcePath?this.prefix+"/tenant/"+this.tenantId+"/remote/"+this.remoteId+"/"+m.aio.skinmanager.SkinManager.SKIN_FLODER+"/"+this.skinId+"/"+this.widgetType+"/"+this.widgetName+"/"+this.resourcePath:null};
m.aio.skinmanager.InRemoteCustomWidgetUrl=function(){m.aio.skinmanager.Url.call(this,m.aio.skinmanager.Url.PREFIX.INREMOTE);this.resourcePath=this.widgetName=this.widgetType=this.remoteId=this.tenantId=null};m.aio.skinmanager.InRemoteCustomWidgetUrl.prototype=new m.aio.skinmanager.Url;m.aio.skinmanager.InRemoteCustomWidgetUrl.prototype.constructor=m.aio.skinmanager.InRemoteCustomWidgetUrl;
m.aio.skinmanager.InRemoteCustomWidgetUrl.prototype.toString=function(){return this.tenantId&&this.remoteId&&this.widgetType&&this.widgetName&&this.resourcePath?this.prefix+"/tenant/"+this.tenantId+"/remote/"+this.remoteId+"/"+m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER+"/"+this.widgetType+"/"+this.widgetName+"/"+this.resourcePath:null};
m.aio.skinmanager.SkinManager={SKIN_FLODER:"skins",CUSTOM_IN_REMOTE_WIDGET_FOLDER:"custom",RESOURCE_FOLDER:"resources",sysSkinsPath:null,customSkinsPath:null,customWidgetPath:null,_configmanager:null,skins:[],_logger:null,init:function(a,b,e){var d=function(a){var b=require("async"),c=require("fs");b.parallel([function(a){c.mkdir(this.sysSkinsPath,function(){a()})}.bind(this),function(a){c.mkdir(this.customSkinsPath,function(){a()})}.bind(this),function(a){c.mkdir(this.customWidgetPath,function(){a()})}.bind(this)],
function(){a&&a()})}.bind(this);this._logger=require("x.logger.js").getLogger("m.aio.skinmanager.SkinManager");var c=require("path"),f=a.getAppResourcePath();f?(a=a.getUserResourcePath())?(this.sysSkinsPath=f+c.sep+this.SKIN_FLODER,this.customSkinsPath=a+c.sep+this.SKIN_FLODER,this.customWidgetPath=a+c.sep+this.CUSTOM_IN_REMOTE_WIDGET_FOLDER,this._configmanager=b,require("async").series([function(a){d(a)}.bind(this),function(a){this._loadAllSkins(function(b,c){!b&&c&&(this.skins=c);a()}.bind(this))}.bind(this)],
function(){e&&e()}.bind(this))):e&&e(Error("user resource path invalid")):e&&e(Error("app resource path invalid"))},_loadAllSkins:function(a){var b=[];require("async").parallel([function(a){this._loadSkins(this.sysSkinsPath,{skinType:m.aio.skinmanager.Skin.TYPE.SYSTEM},function(d,c){!d&&c&&(b=b.concat(c));a()})}.bind(this),function(a){this._loadSkins(this.customSkinsPath,{skinType:m.aio.skinmanager.Skin.TYPE.CUSTOM},function(d,c){!d&&c&&(b=b.concat(c));a()})}.bind(this)],function(e){a&&a(e,b)})},
_loadSkins:function(a,b,e){var d=require("fs"),c=require("path"),f=require("async"),g=[];d.readdir(a,function(d,n){!d&&n?f.each(n,function(d,e){m.aio.skinmanager.Skin.load(a+c.sep+d,d,b,function(a,b){!a&&b&&g.push(b);e()})}.bind(this),function(a){e(a,g)}):e(null,g)}.bind(this))},_getPermittedSkins:function(a,b,e){this._configmanager.trace("config/tenants/"+a,function(a,c){if(a)e&&e(a);else{for(var f=c.license,g=[],q=require("m.aio.infomanager"),n=0;n<b.length;n++)b[n]&&b[n].id&&(2==b[n].type?g.push(b[n]):
q.permitSkin(b[n].id,f)&&g.push(b[n]));e&&e(null,g)}}.bind(this))},_isSkinPermitted:function(a,b,e){for(var d=0;d<this.skins.length;d++)if(this.skins[d]&&this.skins[d].id&&this.skins[d]&&this.skins[d].id==b&&2==this.skins[d].type){e&&e(null,!0);return}var d=this._configmanager,c=require("m.aio.infomanager");d.trace("config/tenants/"+a,function(a,d){a?e&&e(a):e&&e(null,c.permitSkin(b,d.license))}.bind(this))},getResourceByURL:function(a,b){var e=function(a,b,c){var e=this._getSkin(a,b.skinId);e?d(e,
b,function(f,g){!f&&g?c&&c(null,g):e.base?(e=this._getSkin(a,e.base))?d(e,b,function(a,b){a?c&&c(a):c&&c(null,b)}):c&&c(Error("invalid resource path")):c&&c(Error("invalid resource path"))}.bind(this)):c&&c(Error("no such skin"))},d=function(a,b,c){var e=require("path"),d=require("fs"),f=e.join(a.path,b.widgetType,b.widgetName,b.resourcePath);d.exists(f,function(a){a?c&&c(null,f):c&&c(Error("no such resource"))})},c=require("path"),f=require("fs"),g=m.aio.skinmanager.Url.resolve(a);if(g instanceof
m.aio.skinmanager.LocalUrl)e.call(this,this.skins,g,b);else if(g instanceof m.aio.skinmanager.LocalCustomWidgetUrl){var q=this.customWidgetPath+c.sep+g.widgetType+c.sep+g.widgetName+c.sep+g.resourcePath;f.exists(q,function(a){a?b&&b(null,q):b&&b(Error("no such resource"))})}else g instanceof m.aio.skinmanager.InRemoteUrl?this._getInRemoteSkins(g.tenantId,g.remoteId,function(a,c){a?b&&b(a):e.call(this,c,g,b)}.bind(this)):g instanceof m.aio.skinmanager.InRemoteCustomWidgetUrl?this._getRemoteFolder(g.tenantId,
g.remoteId,function(a,e){if(a)b&&b(a);else{var d=c.join(e+c.sep+m.aio.skinmanager.SkinManager.RESOURCE_FOLDER+c.sep+m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER,g.widgetType,g.widgetName,g.resourcePath);f.exists(d,function(a){a?b&&b(null,d):b&&b(Error("no such resource"))})}}.bind(this)):b&&b(Error("no such resource"))},deleteResourceByURL:function(a,b){var e=require("path"),d=require("fs"),c=m.aio.skinmanager.Url.resolve(a);if(c instanceof m.aio.skinmanager.LocalCustomWidgetUrl){var f=
this.customWidgetPath+e.sep+c.widgetType+e.sep+c.widgetName+e.sep+c.resourcePath;d.exists(f,function(a){a?d.unlink(f,function(a){b&&b(a)}):b&&b()})}else b&&b(Error("can not delete this type of resource"))},getSkinList:function(a,b,e){var d=[];a&&b?this._getInRemoteSkins(a,b,function(b,f){if(!b&&f)if(1==f.length)d.push(f[0]);else for(var g=0;g<f.length;g++)if(f[g].base){d.push(f[g]);break}this._getPermittedSkins(a,this.skins,function(a,b){!a&&b&&(d=d.concat(b));e&&e(null,d)})}.bind(this)):this._getPermittedSkins(a,
this.skins,function(a,b){!a&&b&&(d=d.concat(b));e&&e(null,d)})},uploadResource:function(a,b,e,d,c,f){if(a&&b){e||(e=m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_TYPE);d||(d=m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_NAME);c||(c=a);a=require("path");var g=require("async"),q=require("fs-extra"),n=require("fs-extra"),k=this.customWidgetPath+a.sep+e+a.sep+d,h=k+a.sep+c;g.series([function(a){q.ensureDir(k,a)},function(a){q.exists(h,function(b){b?n.move(h,h+"_del",function(b){b?a(b):q.unlink(h+"_del",
function(b){a(b)})}):a()})},function(a){n.move(b,h,function(b){a(b)})}],function(a){a?f&&f(a):(a=new m.aio.skinmanager.LocalCustomWidgetUrl,a.widgetType=e,a.widgetName=d,a.resourcePath=c,f&&f(null,a.toString()))})}else f&&f(Error("invalid paramters"))},_uploadResource:function(a,b,e,d,c){if(a&&b&&e&&d){var f=require("path");this._getRemoteFolder(a,b,function(g,q){if(g)c&&c(g);else{var n=require("async"),k=require("fs"),h=q+f.sep+m.aio.skinmanager.SkinManager.RESOURCE_FOLDER;n.series([function(a){k.mkdir(h,
function(){a()})},function(a){h=h+f.sep+m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER;k.mkdir(h,function(){a()})},function(a){h=h+f.sep+m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_TYPE;k.mkdir(h,function(){a()})},function(a){h=h+f.sep+m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_NAME;k.mkdir(h,function(){a()})}],function(g){g?c&&c(g):k.rename(d,h+f.sep+e,function(d){d?c&&c(d):(d=new m.aio.skinmanager.InRemoteCustomWidgetUrl,d.tenantId=a,d.remoteId=b,d.widgetType=m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_TYPE,
d.widgetName=m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_NAME,d.resourcePath=e,c&&c(null,d.toString()))})})}})}else c&&c(Error("invalid paramters"))},getRemoteWidgets:function(a,b,e,d,c){if(a)if(b){"string"==typeof d&&(d="true"==d);var f=[];require("async").parallel([function(c){this._getInRemoteCustomWidgets(a,b,function(a,b){!a&&b&&(f=f.concat(b));c()})}.bind(this),function(a){this._getLocalCustomWidgets(function(b,c){!b&&c&&(f=f.concat(c));a()}.bind(this))}.bind(this),function(c){e?d?this._getInRemoteSkinWidgets(a,
b,e,function(a,b){!a&&b&&(f=f.concat(b));c()}):this._isSkinPermitted(a,e,function(a,b){a||!b?c():this._getLocalSkinWidgets(e,function(a,b){!a&&b&&(f=f.concat(b));c()})}.bind(this)):c()}.bind(this)],function(a){c&&c(a,f)})}else c&&c(Error("remote id invalid"));else c&&c(Error("tenant id invalid"))},_getLocalSkinWidgets:function(a,b){a?this._getSkinWidgets(this.skins,a,function(a,d){b&&b(a,d)}):b&&b(Error("skin id invalid"))},_getLocalCustomWidgets:function(a){var b=new m.aio.skinmanager.LocalCustomWidgetDummySkin;
b.path=this.customWidgetPath;b.loadWidgets(function(b,d){a&&a(b,d)})},_getInRemoteSkinWidgets:function(a,b,e,d){this._getInRemoteSkins(a,b,function(a,b){a?d&&d(a):this._getSkinWidgets(b,e,function(a,b){d&&d(a,b)})}.bind(this))},_getInRemoteSkins:function(a,b,e){var d=require("path");this._getRemoteFolder(a,b,function(c,f){c?e&&e(c):this._loadSkins(f+d.sep+this.RESOURCE_FOLDER+d.sep+this.SKIN_FLODER,{skinType:m.aio.skinmanager.Skin.TYPE.REMOTE,tenantId:a,remoteId:b},function(a,b){e&&e(a,b)}.bind(this))}.bind(this))},
_getInRemoteCustomWidgets:function(a,b,e){var d=require("path");this._getRemoteFolder(a,b,function(c,f){if(c)e&&e(c);else{var g=f+d.sep+this.RESOURCE_FOLDER+d.sep+this.CUSTOM_IN_REMOTE_WIDGET_FOLDER,q=new m.aio.skinmanager.DummySkin(a,b);q.path=g;q.loadWidgets(function(a,b){e&&e(a,b)})}}.bind(this))},_getRemoteFolder:function(a,b,e){require("fs");require("path");this._configmanager.trace("config/tenants/"+a+"/remotes/"+b,function(a,b){if(a)e&&e(a);else{var f=b.getFolderPath();f?e&&e(null,f):e&&e(Error("remote folder path invalid"))}}.bind(this))},
_getSkin:function(a,b){for(var e=0;e<a.length;e++)if(a[e].id==b)return a[e];return null},_getSkinWidgets:function(a,b,e){var d=this._getSkin(a,b);if(d){b=d;if(d.base)for(var c=0;c<a.length;c++)if(a[c].id==d.base){b=a[c];break}b.loadWidgets(function(a,b){a?e&&e(a):d.base?d.loadWidgets(function(a,c){if(a)e&&e(a);else{for(var d=[],f=0;f<c.length;f++){for(var l=!1,u=0;u<b.length;u++)if(c[f].hasSameRef(b[u])){l=!0;b[u].merge(c[f]);break}l||d.push(c[f])}b=b.concat(d);e&&e(null,b)}}):e&&e(null,b)})}else e&&
e(Error("no skin has id "+b))},_getInRemoteResourceFolder:function(a){return require("path").join(a,this.RESOURCE_FOLDER)},_getInRemoteSkinsFolder:function(a){return require("path").join(this._getInRemoteResourceFolder(a),this.SKIN_FLODER)},_getInRemoteCustomWidgetFolder:function(a){return require("path").join(this._getInRemoteResourceFolder(a),this.CUSTOM_IN_REMOTE_WIDGET_FOLDER)},_getLocalSkinResourcePath:function(a,b){var e=require("path"),d=require("fs"),c=this._getSkin(this.skins,a);if(!c||!c.path)return null;
e=e.join(c.path,b);return d.existsSync(e)?e:c.base?this._getLocalSkinResourcePath(c.base,b):null},_getLocalSkinWidgetPath:function(a,b,e){var d=require("path"),c=require("fs");a=this._getSkin(this.skins,a);if(!a||!a.path)return null;d=d.join(a.path,b,e);return c.existsSync(d)?d:a.base?this._getLocalSkinResourcePath(a.base,b,e):null},saveRemote2:function(a,b,e){var d=require("fs-extra"),c=require("path"),f=require("async"),g=a.getFolderPath();if(g){var q=a.index,n=a.parent.parent.index,k=b&&b.skin&&
b.skin.id?b.skin.id:null,h=!(!a||!a.skin||!a.skin.id),l=b&&b.skin&&b.skin.inRemote,u=(new Date).getTime(),t=this._getInRemoteSkinsFolder(g),x=this._getInRemoteCustomWidgetFolder(g),y=g+c.sep+this.RESOURCE_FOLDER,A=g+c.sep+this.RESOURCE_FOLDER+"_"+u,D=g+c.sep+this.RESOURCE_FOLDER+"_"+u+c.sep+this.SKIN_FLODER,B=t+c.sep+b.skin.id,w=function(a){a=a.split("/");if("custom"!=a[0])return!1;if(2<a.length&&"custom"==a[0]){if(a[1].match(/^.+__\d+$/))return!1;a=a[a.length-1].split(".");if(3<=a.length&&a[a.length-
2].match(/^\d+$/))return!1}return!0},E=function(a,b){a=a.toString();var c=b.split(".");2==c.length?c.splice(1,0,a):3<=c.length&&(c[c.length-2].match(/^\d+$/)?parseInt(c[c.length-2])<parseInt(a)&&(c[c.length-2]=a):c.splice([c.length-2],0,a));return c.join(".")},v=function(a,b,c){var d=require("fs-extra"),e=require("path"),f=require("crypto"),g=function(a){a=d.readFileSync(a);var b=f.createHash("md5");b.update(a);return b.digest("hex")},l=0;b=E(l,b);for(var h=a+e.sep+b;d.existsSync(h);){if(d.statSync(h).size==
d.statSync(c).size&&g(h)==g(h))return b;l++;b=E(l,b);h=a+e.sep+b}d.copySync(c,h,{clobber:!0});return b},z=function(a,b){var e,f,p,r=b.length,g,l;a:{g=a.split("/");if(2<g.length&&"custom"==g[0]){if(g[1].match(/^.+__\d+$/)){l=!0;break a}g=g[g.length-1].split(".");if(3<=g.length&&g[g.length-2].match(/^\d+$/)){l=!0;break a}}l=!1}for(var h=w(a);r--;)switch(p=b[r].getLocation(),p){case "local_custom":if(h)for(g=b[r].resources.length;g--;)if(b[r].resources[g].getRef()==a)return l=y+c.sep+"custom"+c.sep+
b[r].type+c.sep+b[r].name,(f=v(l,b[r].resources[g].name,b[r].resources[g].file))?"custom/"+b[r].type+"/"+b[r].name+"/"+f:null;break;case "in_remote_custom":if(h)for(g=b[r].resources.length;g--;){if(b[r].resources[g].getRef()==a){e=b[r];f=b[r].resources[g];break}}else if(l)for(g=b[r].resources.length;g--;)if(b[r].resources[g].getRef()==a)return p=b[r].skin.path,"\\"==c.sep&&(p=p.replace(/\\/g,"/")),p=p.split("/"),2<p.length&&(p[p.length-2]=p[p.length-2]+"_"+u),p=p.join(c.sep),p=p+c.sep+b[r].type+c.sep+
b[r].name+c.sep+b[r].resources[g].name,e=b[r].type,f=e.indexOf("__"),0<f&&(e=e.substr(0,f)),l=x+c.sep+e+c.sep+b[r].name,(f=v(l,b[r].resources[g].name,p))?"custom/"+e+"/"+b[r].name+"/"+f:null;break;default:if(0==a.indexOf(b[r].type+"/"+b[r].name))for(g=b[r].resources.length;g--;)if(b[r].resources[g].getRef()==a){"in_remote_skin"==p?(p=D,p=p+c.sep+b[r].type+c.sep+b[r].name+c.sep+b[r].resources[g].name,l=t+c.sep+k+c.sep+b[r].type+c.sep+b[r].name+c.sep+b[r].resources[g].name,d.copySync(p,l,{clobber:!0})):
b[r].resources[g].copySync(t,k);return}}if(e&&f)return p=e.skin.path,"\\"==c.sep&&(p=p.replace(/\\/g,"/")),p=p.split("/"),2<p.length&&(p[p.length-2]=p[p.length-2]+"_"+u),p=p.join(c.sep),p=p+c.sep+e.type+c.sep+e.name+c.sep+f.name,l=x+c.sep+e.type+c.sep+e.name,(f=v(l,f.name,p))?"custom/"+e.type+"/"+e.name+"/"+f:null};f.waterfall([function(a){l?a():d.remove(t,function(b){a(b)})},function(a){this.getRemoteWidgets(n,q,h?k:null,l,function(b,c){b?a(b):d.exists(y,function(b){b?d.move(y,A,function(b){a(b,
c)}):a(null,c)})}.bind(this))}.bind(this),function(b,d){a.processResourceList({resourceBuf:[],widgetBuf:[],processResourceSync:function(a){for(var c=0;c<this.resourceBuf.length;c++)if(this.resourceBuf[c]&&this.resourceBuf[c].ref==a)return this.resourceBuf[c].newRef;try{var d=z(a,b);this.resourceBuf.push({ref:a,newRef:d});return d}catch(e){return null}},processWidgetSync:function(a){for(var d=0;d<this.widgetBuf.length;d++){var f=this.widgetBuf[d];if(f&&f.widgetType==a.widgetType&&f.widgetName==a.widgetName)return}try{for(var g,
d=0;d<b.length;d++)if(a.widgetType==b[d].type&&a.widgetName==b[d].name){g=b[d];break}if(g)switch(g.getLocation()){case "in_remote_skin":case "in_remote_custom":var l=g.skin.path;"\\"==c.sep&&(l=l.replace(/\\/g,"/"));var h=l.split("/");3<h.length&&(h[h.length-3]=h[h.length-3]+"_"+u);l=h.join(c.sep);g._copySync(l,t,k);break;default:g.copySync(t,k,e)}this.widgetBuf.push(a)}catch(n){}}},function(a){d(a)})},function(a){d.remove(A,a)},function(a){d.ensureDir(B,function(e){e?a(e):d.writeFile(B+c.sep+m.aio.skinmanager.Skin.SETTINGS_FILE,
JSON.stringify({name:"in-remote"}),function(c){c||(b.skin.inRemote=!0);a(c)})})}],function(a){e&&e(a,b)})}else e&&e(Error("remote folder path invalid"))},saveRemote:function(a,b,e){var d=require("fs-extra"),c=require("path"),f=require("async"),g=require("m.aio.skinmanager.js"),q=a.getFolderPath();if(q){var n=b&&b.skin&&b.skin.id?b.skin.id:null,k=b&&b.skin&&b.skin.inRemote,h=this._getInRemoteResourceFolder(q),l=this._getInRemoteSkinsFolder(q),u=this.customWidgetPath.replace(this.CUSTOM_IN_REMOTE_WIDGET_FOLDER,
""),t=l+c.sep+b.skin.id,x=function(a){return"custom"==a.split("/")[0]},y=function(a){if(!x(a))return!1;a=a.split("/");if(2<a.length){if(a[1].match(/^.+__\d+$/))return!0;a=a[a.length-1].split(".");if(3<=a.length&&a[a.length-2].match(/^\d+$/))return!0}return!1},A=function(a){return x(a)?!y(a):!1},D=function(a){return x(a)?!1:!(x(a)?0:k)},B=function(a,b){if(y(a)||A(a))return c.join(h,a);D(a);return c.join(l,b||n,a)},w=function(a,b){var c=b.split("/"),d=c[c.length-1].split(".");d.splice(d.length-1,0,
""+a);c[c.length-1]=d.join(".");return c.join("/")},E=function(a,b){var c=require("fs-extra"),d=require("crypto"),e=function(a){a=c.readFileSync(a);var b=d.createHash("md5");b.update(a);return b.digest("hex")};if(c.existsSync(b))return c.statSync(b).size==c.statSync(a).size&&e(b)==e(a)?b:null;c.copySync(a,b,{clobber:!0});return b},v=[],z=[],C={},F={},G=function(a){for(var b=d.readdirSync(a),e=0,f=!1,g=0;g<b.length;g++)f=c.join(a,b[g]),(f=d.statSync(f).isDirectory()?G(f):H(f))&&e++;return e==b.length?
(d.removeSync(a),!0):!1},H=function(a){if(-1!=v.indexOf(a))return!1;var b=require("unorm").nfc(a);if(-1!=v.indexOf(b))return!1;for(b=0;b<z.length;b++){var c=z[b];if(a.substr(0,c.length)==c)return!1}d.removeSync(a);return!0};f.waterfall([function(a){k?a():d.remove(l,function(b){a(b)})},function(b){a.processResourceList({resourceBuf:[],widgetBuf:[],processResourceSync:function(a,b){try{var e;var f=b+":"+a;if(C[f])e=C[f];else{var p;p=y(a)?c.join(h,a):A(a)?c.join(u,a):D(a)?g._getLocalSkinResourcePath(b||
n,a):c.join(l,a);var t=B(a,b);if(y(a)||(x(a)?0:k))C[f]=a,v.push(t),e=a;else if(A(a)){for(var q=w(0,a),t=B(q),z=0;!E(p,t);)q=w(++z,a),t=B(q);C[f]=q;v.push(t);e=q}else d.copySync(p,t,{clobber:!0}),C[f]=a,v.push(t),e=void 0}this.resourceBuf.push({ref:a,newRef:e});return e}catch(F){return null}},processWidgetSync:function(a){try{var b=a.widgetType+"/"+a.widgetName;a.widgetSkin&&(b=a.widgetSkin+"/"+b);if(!F[b]){var e;e=k?c.join(l,a.widgetSkin||n,a.widgetType,a.widgetName):g._getLocalSkinWidgetPath(a.widgetSkin||
n,a.widgetType,a.widgetName);var f=c.join(l,a.widgetSkin||n,a.widgetType,a.widgetName);k||d.copySync(e,f,{clobber:!0});F[b]=!0;z.push(f)}this.widgetBuf.push(a)}catch(h){}}},function(a){b(a)})},function(a){try{for(var b=require("unorm"),c=0;c<v.length;c++)v[c]=b.nfc(v[c]);d.existsSync(h)&&G(h);a(null)}catch(e){a(e)}},function(a){d.ensureDir(t,function(e){e?a(e):d.writeFile(t+c.sep+m.aio.skinmanager.Skin.SETTINGS_FILE,JSON.stringify({name:"in-remote"}),function(c){c||(b.skin.inRemote=!0);a(c)})})}],
function(a){a&&(console.error(a),this._logger.log("error",a));e&&e(a,b)}.bind(this))}else e&&e(Error("remote folder path invalid"))},downloadSystemSkin:function(a,b,e,d){var c="webservice.mediola.com",f=443,g="";switch(process.env.CLOUD){case "local":c=process.env.CLOUD_HOST?process.env.CLOUD_HOST:"localhost";f=8080;g="/webservice";break;case "dev":c=process.env.CLOUD_HOST?process.env.CLOUD_HOST:"mediola-dev.elasticbeanstalk.com";f=80;break;default:c=process.env.CLOUD_HOST?process.env.CLOUD_HOST:
"webservice.mediola.com",f=443}var q=function(a,b,e){var d=e;e=443===f?require("https"):require("http");a={host:c,port:f,path:g+"/creatorneo/skin/getSkinUrl?license="+a+"&skinName="+encodeURIComponent(b),method:"GET",timeout:2E4,headers:{"User-Agent":"mediola",Connection:"close"}};var h="";a=e.request(a,function(a){a.setEncoding("utf8");a.on("data",function(a){h+=a});a.on("end",function(){if(d)if(200==a.statusCode){var b;try{b=JSON.parse(h)}catch(c){d(Error("request response invalid:"+h))}b&&b.url?
d(null,b.url,b.version):d(Error("request response invalid:"+h))}else d(Error("request failed:"+h));d=null})});if(a.on&&"function"==typeof a.on)a.on("error",function(a){d&&d(a);d=null});a.setTimeout&&a.setTimeout(2E4);a.end()},n=this,k=this._logger,h=this._configmanager;a="config/tenants/"+a;k.log("debug","start to download system skin "+b);e&&e(0,"start");h.trace(a,function(a,c){if(a)d&&d(a);else{var f=c.license;e&&e(1,"get skin info from server");k.log("debug","try to get skin "+b+" info from server");
q(f.licenseTxt,b,function(a,c,g){a?d&&d(a):n._checkSystemSkinExists(b,g,function(a,h){a?d&&d(a):h?(k.log("debug","find system skin "+b),n._updateInfomanager(f,b,function(){d&&d()})):n._downloadAndSaveSkin(f,c,b,g,e,function(a){a?d&&d(a):n._updateInfomanager(f,b,function(){d&&d()})})})})}})},_checkSystemSkinExists:function(a,b,e){for(var d=!1,c=0;c<this.skins.length;c++)if(this.skins[c]&&1==this.skins[c].type&&this.skins[c].id==a){var f=this.skins[c].version?parseInt(this.skins[c].version):0,g=b?parseInt(b):
0;if(f>=g){d=!0;break}}e&&e(null,d)},_downloadAndSaveSkin:function(a,b,e,d,c,f){var g=this,q=this._logger,n=function(a,b,c){var d=require("adm-zip"),e=require("m.aio.filemanager.js").getTmpDir(),f=require("path"),g=require("fs-extra");a=new d(a);b=f.join(e,b);try{g.existsSync(b)&&g.removeSync(b),g.ensureDirSync(b),a.extractAllTo(b,!0),c&&c(null,b)}catch(k){c&&c(k)}},k=function(a,b,c,d){var e=require("path"),f=require("fs-extra"),g=e.join(a,c);f.existsSync(g)&&f.removeSync(g);f.move(b,g,{limit:100},
function(a){f.chmod(g,511,function(a){d&&d(a,g)})})};c&&c(1,"get skin info from server");q.log("debug","start download skin "+e+" zip from server");c&&c(2,"download skin");(function(a,b,c){var d=c;a=require("url").parse(a);c=require("http");-1!=a.protocol.indexOf("https")&&(c=require("https"));a.method="GET";a.timeout=2E4;var e=require("m.aio.filemanager.js").getTmpDir(),f=require("path"),g=require("fs"),k=0,n=f.join(e,(new Date).getTime()+".zip"),w=g.createWriteStream(n);w.on("error",function(a){d&&
d(a);d=null});a=c.request(a,function(a){var c=a.headers["content-length"];q.log("trace","http skin zip length:"+c);var e=!1,f=!1;a.pipe(w);w.on("finish",function(){w.close(function(){f=!0;e&&f&&d&&(200!=a.statusCode?d(Error("http response code:"+a.statusCode)):d(null,n),d=null)})});a.on("data",function(a){k+=a.length;q.log("trace","receive chunk:"+a.length+" total:"+k+"/"+c);b&&b(parseFloat("2."+k),"download chunk "+k,{count:k,total:parseInt(c)})});a.on("end",function(){(e=!0,f)&&d&&(200!=a.statusCode?
d(Error("http response code:"+a.statusCode)):d(null,n),d=null)})});if(a.on&&"function"==typeof a.on)a.on("error",function(a){d&&d(a);d=null});a.setTimeout&&a.setTimeout(2E4);a.end()})(b,c,function(a,b){a?f&&f(a):(c&&c(3,"unpack skin"),q.log("debug","start unpack skin from file:"+b),n(b,e,function(a,b){a?f&&f(a):(q.log("debug","move skin from:"+b+" to:"+g.sysSkinsPath),k(g.sysSkinsPath,b,e,function(a,b){a?f&&f(a):(c&&c(4,"load skin"),q.log("debug","load skin "+e+" from:"+b),m.aio.skinmanager.Skin.load(b,
e,{skinType:1},function(a,b){if(a)f&&f(a);else{for(var c=-1,e=0;e<g.skins.length;e++)if(g.skins[e]&&g.skins[e].type==b.type&&g.skins[e].id==b.id){c=e;break}-1!=c&&g.skins.splice(c,1);g.skins.push(b);b.updateVersion(d,function(a){f&&f(a)})}}))}))}))})},_updateInfomanager:function(a,b,e){require("m.aio.infomanager").updateDownloadSkin(a,b,function(){e&&e()})}};"undefined"!=typeof module&&null!=module&&(module.exports=m.aio.skinmanager.SkinManager);
