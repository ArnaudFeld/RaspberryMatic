var util=require("util"),EventEmitter=require("events");require("x.logger.js").setLevel("trace","x.hub.hubsyncman");var x=x||{};x.hub=x.hub||{};x.hub.hubsyncman=x.hub.hubsyncman||{};x.hub.hubsyncman.Error=function(g,c){Error.call(this,g);this.code=c};util.inherits(x.hub.hubsyncman.Error,Error);
x.hub.hubsyncman.SyncManager=function(){var g=function(){this._logger=require("x.logger.js").getLogger("x.hub.hubsyncman.SyncManager");this._tenant2=this._tenant=null};g.prototype.init=function(c,e){this._logger.log("info","init hub sync managaer");var d=require("m.aio.configmanager.js");c=this._generateTenantParent(c);this._tenant=new d.Tenant(c);this._tenant.license="dummy";this._tenant.folder="db";this._tenant2=new d.Tenant(c);this._tenant2.license="dummy";this._tenant2.folder="db2";e&&e()};g.prototype.deploy=
function(c,e,d,b,k){var f=this;require("async").waterfall([function(a){f._writeZip(c,a)},function(a,b){f._unzip(a,b)},function(a){f._encryptDeviceDB(a)},function(a){require("x.hub.taskman.js").taskManager.clear();a()},function(a){require("x.hub.deviceman.js").deviceManager.reload(a)},function(a){require("x.hub.macroman.js").macroManager.reload(a)},function(a){require("x.hub.taskman.js").taskManager.reload(a)},function(a){require("x.hub.scriptman.js").scriptManager.reload(a)},function(a){localStorage.setItem("x.hub.hubsyncman.SyncManager.TIMESTAMP",
(new Date).getTime());localStorage.setItem("x.hub.hubsyncman.SyncManager.USERID",e);localStorage.setItem("x.hub.hubsyncman.SyncManager.APPID",d);b&&(localStorage.setItem("x.hub.m.gateway.DB1NeoIdx",b),require("x.hub.m.gateway.js").updateGatewayNeoIndex());a()}],function(a){k&&k(a)})};g.prototype._encryptDeviceDB=function(c){var e=require("path"),d=require("fs"),b=require("x.hub.fileman.js"),k=require("m.aio.devicemanager"),f=require("x.crypt"),a=b.fileManager.getUserRootDataPath();b=e.join(a,"db",
"device_db");e=e.join(a,"db2","device_db");var h=this;a=function(a){try{if(d.existsSync(a)){h._logger.log("trace","[_encryptDeviceDB] Encrypting "+a);var b=d.readFileSync(a,"utf8");b&&(b=f.AES.encodeString(b,k.ml_v1_info()),d.writeFileSync(a+".enc",b),d.unlinkSync(a))}}catch(l){console.error(l),h._logger.log("error","[_encryptDeviceDB] "+l.message)}};a(b);a(e);c&&c()};g.prototype.deploy2=function(c,e,d,b,k){var f=this;require("async").waterfall([function(a){f._writeZip(c,a)},function(a,b){f._unzip(a,
b)},function(a){f._encryptDeviceDB(a)},function(a){require("x.hub.deviceman.js").deviceManager2.reload(a)},function(a){require("x.hub.macroman.js").macroManager2.reload(a)},function(a){localStorage.setItem("x.hub.hubsyncman.SyncManager2.TIMESTAMP",(new Date).getTime());localStorage.setItem("x.hub.hubsyncman.SyncManager2.USERID",e);localStorage.setItem("x.hub.hubsyncman.SyncManager2.APPID",d);b&&(localStorage.setItem("x.hub.m.gateway.DB2NeoIdx",b),require("x.hub.m.gateway.js").updateGatewayNeoIndex());
a()}],function(a){k&&k(a)})};g.prototype._writeZip=function(c,e){var d=require("os"),b=require("fs"),k=require("path"),f="nam_"+Math.round((new Date).getTime()/1E3)+".zip",a=k.join(d.tmpdir(),f);this._logger.log("trace","create temp deploy zip:"+a);d=b.createWriteStream(a);c.pipe(d);var h=e;d.on("error",function(a){h&&h(a);h=null});d.on("close",function(){h&&h(null,a);h=null})};g.prototype._unzip=function(c,e){var d=require("adm-zip"),b=require("x.hub.fileman.js").fileManager.getUserRootDataPath();
require("path");var k=require("fs-extra");try{(new d(c)).extractAllTo(b,!0),e&&e()}catch(f){e&&e(f)}k.remove(c)};g.prototype.writeFile=function(c,e,d){var b=this._tenant.getFolderPath(),k=require("path"),f=require("fs-extra"),a=b+k.sep+c,h=this;f.writeFile(a,e,function(b){b?(h._logger.log("warn","write file:"+a+" error:"+b.message),d&&d(b)):require("x.hub.deviceman.js").deviceManager.reload(function(a){a?(h._logger.log("warn","reload device error:"+a.message),d&&d(a)):require("x.hub.macroman.js").macroManager.reload(function(a){a&&
h._logger.log("warn","reload macro error:"+a.message);d&&d(a)})})})};g.prototype.writeFile2=function(c,e,d){var b=this._tenant.getFolderPath(),k=require("path"),f=require("fs-extra"),a=b+k.sep+c,h=this;f.writeFile(a,e,function(b){b?(h._logger.log("warn","write file:"+a+" error:"+b.message),d&&d(b)):require("x.hub.deviceman.js").deviceManager2.reload(function(a){a?(h._logger.log("warn","reload device error:"+a.message),d&&d(a)):require("x.hub.macroman.js").macroManager2.reload(function(a){a&&h._logger.log("warn",
"reload macro error:"+a.message);d&&d(a)})})})};g.prototype._generateTenantParent=function(c){return{fileManager:c,getFolderPath:function(){return this.fileManager.getUserRootDataPath()},getFolder:function(){return""}}};return g}();
x.hub.hubsyncman.Handler=function(){var g=function(){this._logger=require("x.logger.js").getLogger("x.hub.hubsyncman.Handler");this.syncManager=new x.hub.hubsyncman.SyncManager};g.prototype.SyncManager=x.hub.hubsyncman.SyncManager;g.prototype.init=function(c,e,d){this._config(c);this.syncManager.init(e,d)};g.prototype._config=function(c){var e=this,d=require("body-parser");c.use("/xhub/xhubsync/",function(b,c,d){var a=require("x.hub.js").server,e=!0;if(a._pwd&&0<a._pwd.length){e=!1;if(!b.query.at&&
b.query.auth){var f=require("x.crypt.js");b.query.at=f.MD5(unescape(encodeURI(b.query.auth+"_SALT!")))}b.query.at&&b.query.at==a._pwd&&(e=!0)}e?d():c.send('{"XC_ERR":{"code":"000007", "msg":"access denied"}}')});c.use("/xhub/xhubsync/upload",d.text({limit:"50mb"}));c.post("/xhub/xhubsync/upload",function(b,c){var d=b.query.fileName;d?e.syncManager.writeFile(d,b.body,function(a){c.send(e._toRestfulResponse(a,"ok"))}):c.send(e._toRestfulResponse(new x.hub.hubsyncman.Error("no file name")))}.bind(this));
c.post("/xhub/xhubsync/deploy",function(b,c){var d=b.query.userid;d?this.syncManager.deploy(b,d,b.query.appid,b.query.gatewayid,function(a){c.send(e._toRestfulResponse(a,"ok"))}):c.send(e._toRestfulResponse(new x.hub.hubsyncman.Error("no userid")))}.bind(this));c.use("/xhub/xhubsync/upload2",d.text({limit:"50mb"}));c.post("/xhub/xhubsync/upload2",function(b,c){var d=b.query.fileName;d?e.syncManager.writeFile2(d,b.body,function(a){c.send(e._toRestfulResponse(a,"ok"))}):c.send(e._toRestfulResponse(new x.hub.hubsyncman.Error("no file name")))}.bind(this));
c.post("/xhub/xhubsync/deploy2",function(b,c){var d=b.query.userid;d?this.syncManager.deploy2(b,d,b.query.appid,b.query.gatewayid,function(a){c.send(e._toRestfulResponse(a,"ok"))}):c.send(e._toRestfulResponse(new x.hub.hubsyncman.Error("no userid")))}.bind(this))};g.prototype._toRestfulResponse=function(c,e){return c?{status:"fail",message:c.message,code:c.code?c.code:0}:{status:"success",data:e}};return g}();module.exports=new x.hub.hubsyncman.Handler;
