var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.hubsyncman=x.hub.hubsyncman||{};x.hub.hubsyncman.Error=function(c,a){Error.call(this,c);this.code=a};util.inherits(x.hub.hubsyncman.Error,Error);
x.hub.hubsyncman.SyncManager=function(){var c=function(){this._logger=require("x.logger.js").getLogger("x.hub.hubsyncman.SyncManager");this._tenant2=this._tenant=null};c.prototype.init=function(a,d){this._logger.log("info","init hub sync managaer");var f=require("m.aio.configmanager.js");a=this._generateTenantParent(a);this._tenant=new f.Tenant(a);this._tenant.license="dummy";this._tenant.folder="db";this._tenant2=new f.Tenant(a);this._tenant2.license="dummy";this._tenant2.folder="db2";d&&d()};c.prototype.deploy=
function(a,d,f,e,g){var h=this;require("async").waterfall([function(b){h._writeZip(a,b)},function(b,a){h._unzip(b,a)},function(b){h._encryptDeviceDB(b)},function(b){require("x.hub.taskman.js").taskManager.clear();b()},function(b){require("x.hub.deviceman.js").deviceManager.reload(b)},function(b){require("x.hub.macroman.js").macroManager.reload(b)},function(b){require("x.hub.taskman.js").taskManager.reload(b)},function(b){require("x.hub.scriptman.js").scriptManager.reload(b)},function(b){localStorage.setItem("x.hub.hubsyncman.SyncManager.TIMESTAMP",
(new Date).getTime());localStorage.setItem("x.hub.hubsyncman.SyncManager.USERID",d);localStorage.setItem("x.hub.hubsyncman.SyncManager.APPID",f);e&&(localStorage.setItem("x.hub.m.gateway.DB1NeoIdx",e),require("x.hub.m.gateway.js").updateGatewayNeoIndex());b()}],function(b){g&&g(b)})};c.prototype._encryptDeviceDB=function(a){var d=require("path"),f=require("x.hub.fileman.js").fileManager.getUserRootDataPath(),e=d.join(f,"db","device_db");d=d.join(f,"db2","device_db");this._encryptDeviceDBFileSync(e);
this._encryptDeviceDBFileSync(d);a&&a()};c.prototype._encryptDeviceDBFileSync=function(a){var d=require("fs"),f=require("x.crypt"),e=require("m.aio.devicemanager");try{if(d.existsSync(a)){this._logger.log("trace","[_encryptDeviceDB] Encrypting "+a);var g=d.readFileSync(a,"utf8");g&&(g=f.AES.encodeString(g,e.ml_v1_info()),d.writeFileSync(a+".enc",g),d.unlinkSync(a))}}catch(h){console.error(h),this._logger.log("error","[_encryptDeviceDB] "+h.message)}};c.prototype.deploy2=function(a,d,f,e,g){var h=
this;require("async").waterfall([function(b){h._writeZip(a,b)},function(b,a){h._unzip(b,a)},function(b){h._encryptDeviceDB(b)},function(b){require("x.hub.deviceman.js").deviceManager2.reload(b)},function(b){require("x.hub.macroman.js").macroManager2.reload(b)},function(b){localStorage.setItem("x.hub.hubsyncman.SyncManager2.TIMESTAMP",(new Date).getTime());localStorage.setItem("x.hub.hubsyncman.SyncManager2.USERID",d);localStorage.setItem("x.hub.hubsyncman.SyncManager2.APPID",f);e&&(localStorage.setItem("x.hub.m.gateway.DB2NeoIdx",
e),require("x.hub.m.gateway.js").updateGatewayNeoIndex());b()}],function(b){g&&g(b)})};c.prototype._writeZip=function(a,d){var f=require("os"),e=require("fs"),g=require("path"),h="nam_"+Math.round((new Date).getTime()/1E3)+".zip",b=g.join(f.tmpdir(),h);this._logger.log("trace","create temp deploy zip:"+b);f=e.createWriteStream(b);a.pipe(f);var c=d;f.on("error",function(b){c&&c(b);c=null});f.on("close",function(){c&&c(null,b);c=null})};c.prototype._unzip=function(a,d){var f=require("adm-zip"),e=require("x.hub.fileman.js").fileManager.getUserRootDataPath();
require("path");var g=require("fs-extra");try{(new f(a)).extractAllTo(e,!0),d&&d()}catch(h){d&&d(h)}g.remove(a)};c.prototype.writeFile=function(a,d,f){var e=this._tenant.getFolderPath(),g=require("path"),h=require("fs-extra"),b=e+g.sep+a,c=this;h.writeFile(b,d,function(a){a?(c._logger.log("warn","write file:"+b+" error:"+a.message),f&&f(a)):require("x.hub.deviceman.js").deviceManager.reload(function(b){b?(c._logger.log("warn","reload device error:"+b.message),f&&f(b)):require("x.hub.macroman.js").macroManager.reload(function(b){b&&
c._logger.log("warn","reload macro error:"+b.message);f&&f(b)})})})};c.prototype.writeFile2=function(a,d,f,e){var g=this._tenant2.getFolderPath(),h=require("path"),b=require("fs-extra"),c=g+h.sep+a,k=this;b.writeFile(c,d,function(b){b?(k._logger.log("warn","write file:"+c+" error:"+b.message),e&&e(b)):("device_db"==a&&k._encryptDeviceDBFileSync(c),require("x.hub.deviceman.js").deviceManager2.reload(function(b){b?(k._logger.log("warn","reload device error:"+b.message),e&&e(b)):require("x.hub.macroman.js").macroManager2.reload(function(b){b&&
k._logger.log("warn","reload macro error:"+b.message);f&&"device_db"==a&&(localStorage.setItem("x.hub.m.gateway.DB2NeoIdx",f),require("x.hub.m.gateway.js").updateGatewayNeoIndex());e&&e(b)})}))})};c.prototype._generateTenantParent=function(a){return{fileManager:a,getFolderPath:function(){return this.fileManager.getUserRootDataPath()},getFolder:function(){return""}}};return c}();
x.hub.hubsyncman.Handler=function(){var c=function(){this._logger=require("x.logger.js").getLogger("x.hub.hubsyncman.Handler");this.syncManager=new x.hub.hubsyncman.SyncManager};c.prototype.SyncManager=x.hub.hubsyncman.SyncManager;c.prototype.init=function(a,d,c){this._config(a);this.syncManager.init(d,c)};c.prototype._config=function(a){var d=this,c=require("body-parser");a.use("/xhub/xhubsync/",function(a,d,c){var b=require("x.hub.js").server,e=!0;if(b._pwd&&0<b._pwd.length){e=!1;if(!a.query.at&&
a.query.auth){var g=require("x.crypt.js");a.query.at=g.MD5(unescape(encodeURI(a.query.auth+"_SALT!")))}a.query.at&&a.query.at==b._pwd&&(e=!0)}e?c():d.send('{"XC_ERR":{"code":"000007", "msg":"access denied"}}')});a.use("/xhub/xhubsync/upload",c.text({limit:"50mb"}));a.post("/xhub/xhubsync/upload",function(a,c){var e=a.query.fileName;e?d.syncManager.writeFile(e,a.body,function(b){c.send(d._toRestfulResponse(b,"ok"))}):c.send(d._toRestfulResponse(new x.hub.hubsyncman.Error("no file name")))}.bind(this));
a.post("/xhub/xhubsync/deploy",function(a,c){var e=a.query.userid;e?this.syncManager.deploy(a,e,a.query.appid,a.query.gatewayid,function(b){c.send(d._toRestfulResponse(b,"ok"))}):c.send(d._toRestfulResponse(new x.hub.hubsyncman.Error("no userid")))}.bind(this));a.use("/xhub/xhubsync/upload2",c.text({limit:"50mb"}));a.post("/xhub/xhubsync/upload2",function(a,c){var e=a.query.fileName;e?d.syncManager.writeFile2(e,a.body,a.query.gatewayid,function(b){c.send(d._toRestfulResponse(b,"ok"))}):c.send(d._toRestfulResponse(new x.hub.hubsyncman.Error("no file name")))}.bind(this));
a.post("/xhub/xhubsync/deploy2",function(a,c){var e=a.query.userid;e?this.syncManager.deploy2(a,e,a.query.appid,a.query.gatewayid,function(a){c.send(d._toRestfulResponse(a,"ok"))}):c.send(d._toRestfulResponse(new x.hub.hubsyncman.Error("no userid")))}.bind(this))};c.prototype._toRestfulResponse=function(a,c){return a?{status:"fail",message:a.message,code:a.code?a.code:0}:{status:"success",data:c}};return c}();module.exports=new x.hub.hubsyncman.Handler;
