#!/bin/sh
#
# start script to check if there are any update jobs
# waiting which we can perform during bootup automatically.
#

start() {
  echo -n "Checking for Auto-Update Jobs: "

  if [[ -L /usr/local/.firmwareUpdate ]]; then
    echo "performing auto-update... "

    # stop lighttpd so that nobody interferes
    /etc/init.d/S50lighttpd stop

    # run unattended firmware update
    /bin/fwinstall.sh >/tmp/fwinstall.log 2>&1
    if [[ $? -ne 0 ]]; then
      # firmware update failed, lets change to
      # interactive mode
      echo "ERROR!"

      /etc/init.d/S50lighttpd start
    else
      # firmware update succeeded, lets reboot!
      mount -o rw,remount /userfs
      rm -f /usr/local/.firmwareUpdate
      mount -o ro,remount /userfs

      echo "OK, rebooting"

      /sbin/reboot
      exit 1
    fi

  else
    echo "not found, OK"
  fi

  # remount userfs in rw mode so that lighttpd
  # can upload data
  mount -o rw,remount /userfs
}

restart() {
  start
}

case "$1" in
  start)
    start
  ;;
  stop)
    # nothing
  ;;
  restart|reload)
    restart
  ;;
  *)
    echo "Usage: $0 {start|stop|restart}"
    exit 1
esac

exit $?
