#!/bin/sh
# shellcheck shell=dash source=/dev/null
#
# Starts tailscaled
#

EXEC="/usr/sbin/tailscaled"
ARGS="-state /etc/config/tailscaled.state -socket /var/run/tailscale/tailscaled.sock"
PID="/var/run/tailscale/tailscaled.pid"
PORT=41641

# only continue if tailscale is enabled
[[ ! -e /etc/config/tailscaleEnabled ]] && exit 0
[[ -r /etc/config/tailscaleEnabled ]] && . /etc/config/tailscaleEnabled

case "${1}" in
  start)
    echo -n "Starting tailscaled: "

    # create necessary directories
    mkdir -p /var/run/tailscale /var/lib/tailscale

    # shellcheck disable=SC2086
    if ! start-stop-daemon -b -S -q -m -p "${PID}" -x ${EXEC} -- ${ARGS} -port ${PORT}; then
      echo "FAILED"
      exit 1
    else
      echo "OK"
    fi
  ;;
  stop)
    echo -n "Stopping tailscaled: "
    start-stop-daemon -K -q -p ${PID}
    echo "OK"
  ;;
  restart|reload)
    ${0} stop
    ${0} start
  ;;
  *)
    echo "Usage: ${0} {start|stop|restart}"
    exit 1
esac

exit 0
