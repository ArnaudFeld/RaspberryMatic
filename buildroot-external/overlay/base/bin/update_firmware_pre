#!/bin/sh

log() {
  logger -t homematic -p user.notice $1
}

echo Entering firmware update mode
log "Entering firmware update mode"

if [ ! -f /usr/local/tmp/new_firmware.tar.gz ]; then
        log "Firmware image archive does not exist. Rebooting"
        echo "Firmware image archive does not exist. Rebooting"
        # echo x > /dev/watchdog
        # /sbin/reboot
        # while true ; do true ;  done
	exit
fi

echo Extract firmware update file ...

FWDIR=$(mktemp -d -p /usr/local/tmp)
mkdir -p /var/update
mount --rbind ${FWDIR} /var/update
cd /var/update

tar -xf /usr/local/tmp/new_firmware.tar.gz

if [ ! -x update_script ]; then
        log "Error unzipping firmware image archive. Rebooting"
        echo "Error unzipping firmware image archive. Rebooting"
        # echo x > /dev/watchdog
        #/sbin/reboot
        #while true ; do true ;  done
        exit
fi

rm /usr/local/tmp/new_firmware.tar.gz

echo Copy files...

cp -a /bin /var/update/
cp -a /lib /var/update/
cp -a /sbin /var/update/
cp -a /etc /var/update/
mkdir -p /var/update/usr/local
find /usr -maxdepth 1 -not -name local -not -name usr -exec cp -a {} /var/update/usr/ \;
cp -a /dev /var/update/
mkdir -p /var/update/proc
mkdir -p /var/update/sys

mkdir -p /var/update/oldroot

/sbin/pivot_root . oldroot
